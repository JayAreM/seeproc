

<?php
	session_start();
	$year = 2023;
	$dt = time();
	$dateEncoded = date('Y-m-d h:i A', $dt);
	

	$dbaseEmployees = 'citydoc';
	$dbasePPMPItems = 'citydoc2023';
	
	$db = 'citydoc2023.';
	$bac = 'bacdb2017.';
	$forumDatabase = 'citydoc2023.';


	
	$dt = time();
	$today = date('Y-m-d H:i:s', $dt);
	
	require_once("../includes/database.php");
	require_once("../interface/sheets.php");
	require_once("../includes/vstr.php");
	
	//$dt = strtotime("+7 hours");
	//date_default_timezone_set('Asia/Manila');	
	/*
	10 - gso
	11 - gso
	30 - ling
	31 - cbo
	32 - PPMP
	33 - light/water
	34 - ling hr
	35 - bac
	36 - cancel
	37 - cto check management
	38 - BAC Secretariat
	39 - BAC Chairman
	40 - CEO PDD
	41 - CEO Construction
	42 - CEO Admin
	43 - CAO trust fund controller
	44 - CBO gen fund fund controller
	45 - Inventory Assets Module viewer
	46 - REMI Account for all access program and account codes
	47 - Disaster Account
	*/
	
	if(isset($_GET['showPerfectPerformance'])){

		$sheet0 = '';
		$totAvg = 0;

		$temp1 = $sheet->createPerfectProcessTime('PR');
		$temp1 = explode('*j*', $temp1);
		$sheet1 = $temp1[0];
		$totAvg += $temp1[1];

		$temp2 = $sheet->createPerfectProcessTime('PO');
		$temp2 = explode('*j*', $temp2);
		$sheet2 = $temp2[0];
		$totAvg += $temp2[1];

		$temp3 = $sheet->createPerfectProcessTime('PX');
		$temp3 = explode('*j*', $temp3);
		$sheet3 = $temp3[0];
		$totAvg += $temp3[1];

		unset($temp1);
		unset($temp2);
		unset($temp3);

		$sheet0 .= '<table border="0" cellpadding="0" style="border-spacing:0px; margin:0px auto;">
						<tr>
							<td style="font-family:anton; font-size:22px; color:rgb(44, 46, 47); padding:10px 0px;">Procurement Processing Time Metrics</td>
						</tr>
						<tr>
							<td style="padding-bottom:10px;">'.$sheet1.'</td>
						</tr>
						<tr>
							<td style="padding-bottom:10px;">'.$sheet2.'</td>
						</tr>
						<tr>
							<td style="padding-bottom:10px;">'.$sheet3.'</td>
						</tr>
						<tr>
							<td style="text-align:right; font-size:42px; font-family:anton; padding-right:40px;">
								<span style ="font-size:18px; font-family:oswald;">Average Procurement Processing Time</span>
								<span style ="color:rgb(44, 46, 47);">' . $totAvg . '</span><span  style ="font-size:18px;font-family:oswald;"> Days</span>
							</td>
						</tr>
					</table>';

		echo $sheet0;
	}
	
	if(isset($_GET['showPerformance'])){
		//echo $sheet->createProcessTime('PR','Purchase Request','For P.O');
		$total = 0;
		$totalPending = 0;
		$arr = $sheet->createProcessTime('PR','Purchase Request','For P.O');
		$pr =  $arr['sheet'];
		$total += $arr['total'];
		$totalPending += $arr['totalPending'];
		
		$arr =  $sheet->createProcessTime('PO','Purchase Order','Waiting for Delivery');
		$po =   $arr['sheet'];
		$total += $arr['total'];
		$totalPending += $arr['totalPending'];
		
		$arr =  $sheet->createProcessTime('PX','Payment','Check Released');
		$px =   $arr['sheet'];
		$total += $arr['total'];
		$totalPending += $arr['totalPending'];
		
		echo '<table style ="margin:0 auto;" border ="0">
				<tr><td style ="font-family:anton;font-size:22px;color:rgb(44, 46, 47);padding:10px 0px; ">Procurement Processing Time Metrics</td></tr>
				<tr><td>' . $pr . '</td></tr>
				<tr><td>' . $po . '</td></tr>
				<tr><td>' . $px . '</td></tr>
				<tr><td style ="text-align:right; font-size:42px; padding-right:40px; font-family:anton;">
					<span style ="font-size:18px;font-family:oswald;">Average Procurement Processing Time</span>
					<span style ="color:rgb(44, 46, 47);">' . $total . '</span><span  style ="font-size:18px;font-family:oswald;"> Days</span></td></tr>
				
			</table>';
	}
	if(isset($_GET['showPemerankALL'])){
		$quarter = $database->charEncoder($_GET['qtr']);
		$type = stripslashes($database->charEncoder($_GET['trans']));
		$arr  = explode("~!~",$type);
		$type = $arr[0];
		$labelType = $arr[1];
		echo $sheet->createTopPemeRank($type,$quarter,$labelType);
	}
	if(isset($_GET['showPendingOfficeList'])){
		$quarter = $database->charEncoder($_GET['qtr']);
		$type = stripslashes($database->charEncoder($_GET['trans']));
		$stat = $database->charEncoder($_GET['stat']);
		$office = ucwords(strtolower(stripslashes($database->charEncoder($_GET['of']))));
		
		$type = stripslashes($database->charEncoder($_GET['trans']));
		$arr  = explode("~!~",$type);
		$type = $arr[0];
		$labelType = $arr[1];
		
		echo $sheet->createToppendingOfficeList($type,$quarter,$stat,$labelType,$office);
	}
	if(isset($_GET['showTopPending'])) {
		$quarter = 1;
		$type = '("For P.O")';	
		$labelType = "(Purchase Request)";	
		echo $sheet->createTopPending($quarter,$type,$labelType);
	}
	if(isset($_GET['showTopPendingClick'])) {
		$quarter = $database->charEncoder($_GET['qtr']);
		$type = stripslashes($database->charEncoder($_GET['trans']));
		$arr  = explode("~!~",$type);
		$type = $arr[0];
		$labelType = $arr[1];
		echo $sheet->createTopPendingEfficiencyClick($quarter,$type,$labelType);
	}
	if(isset($_GET['showTopClick'])) {
		$quarter = $database->charEncoder($_GET['qtr']);
		$type = stripslashes($database->charEncoder($_GET['trans']));
		$account = $database->charEncoder($_GET['type']);
		
		$arr  = explode("~!~",$type);
		$type = $arr[0];
		$labelType = $arr[1];
		echo $sheet->createTopEfficiencyClick($quarter,$type,$labelType,$account);
	}
	if(isset($_GET['showTop'])) {
		$quarter = 1;
		$type = '("For P.O")';	
		$labelType = "(Purchase Request)";	
		$account =1;
		echo $sheet->createTopEfficiency($quarter,$type,$labelType,$account);
	}
	if(isset($_GET['fetchByDayCalendarUsers'])){
		$arr =  explode('*',$database->charEncoder($_GET['par']));
		$status = $arr[0];
		$document = $arr[1];
		$date = $arr[2];
		if($document == "Purchase Request"){
			$sql = "
					select a.*,b.Name as OfficeName,c.Description from(select * from vouchercurrent where trackingtype = 'PR' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' group by trackingnumber) a
					left join office b on a.Office = b.Code
					left join ppmpcategories c on a.PR_CategoryCode = c.code
					order by OfficeName asc
					";
		}else if($document == "Purchase Order"){
			$sql = "select a.*,b.Name as OfficeName,c.Description from(select * from vouchercurrent where trackingtype = 'PO' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' group by trackingnumber) a
					left join office b on a.Office = b.Code
					left join ppmpcategories c on a.PR_CategoryCode = c.code
					order by OfficeName asc
					";
		}else {
			$sql = "select a.*,b.Name as OfficeName from(select * from vouchercurrent where documenttype = '" . $document . "' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' group by trackingnumber) a
					left join office b on a.Office = b.Code
					order by OfficeName asc";
		}
		$record = $database->query($sql);
		echo $sheet->createCalendarDetails($record);
	}
	if(isset($_GET['showCalendarDataUsers'])) {
		
		$month = $database->charEncoder($_GET['m']);
		
		$regulatoryOffice = stripslashes($database->charEncoder($_GET['rO']));
		echo $sheet->createCalendarUsers($year,$month,$regulatoryOffice);
	}
	if(isset($_GET['showCalendarUsers'])) {
		$year = 2023;
		$month = date('m');
		//$month = "10";
		$regulatoryOffice = stripslashes($database->charEncoder($_GET['rO']));
		$regulatoryOffice = '-';
		echo $sheet->createCalendarUsers($year,$month,$regulatoryOffice);
	}
	if(isset($_GET['fetchByDayCalendarLogs'])){
		$arr =  explode('*',$database->charEncoder($_GET['par']));
		$status = $arr[0];
		$document = $arr[1];
		$date = $arr[2];
		if($document == "Purchase Request"){
			$sql = "
					select a.*,b.Name as OfficeName,c.Description from(select * from vouchercurrent where trackingtype = 'PR' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' group by trackingnumber) a
					left join office b on a.Office = b.Code
					left join ppmpcategories c on a.PR_CategoryCode = c.code
					order by OfficeName asc
					";
			$sql = "select a.*,b.Name as OfficeName,c.Description from(
						select a.*,b.Office,b.PR_CategoryCode,Claimant,b.DocumentType,b.Year,b.TrackingType,b.Amount,b.PO_Amount,b.TotalAmountMultiple,b.PR_Month,
						            case
										when b.TrackingType = 'PR' Then 'Purchase Request'
						                when b.TrackingType = 'PO' Then 'Purchase Order'
						                else b.DocumentType
									End as Document from(SELECT TrackingNumber,Status,DateModified FROM voucherhistory where Status = '" . $status . "' and  substr(DateModified,1,10) = '" . $date . "') a
						left join vouchercurrent b on a.TrackingNumber = b.TrackingNumber where TrackingType = 'PR' group by TrackingNumber,DateModified) a
						left join office b on a.Office = b.Code
						left join  ppmpcategories c on  c.Code = a.PR_CategoryCode";
						
			
		}else if($document == "Purchase Order"){
			$sql = "select a.*,b.Name as OfficeName,c.Description from(
						select a.*,b.Office,b.PR_CategoryCode,Claimant,b.DocumentType,b.Year,b.TrackingType,b.Amount,b.PO_Amount,b.TotalAmountMultiple,b.PR_Month,
						            case
										when b.TrackingType = 'PR' Then 'Purchase Request'
						                when b.TrackingType = 'PO' Then 'Purchase Order'
						                else b.DocumentType
									End as Document from(SELECT TrackingNumber,Status,DateModified FROM voucherhistory where Status = '" . $status . "' and  substr(DateModified,1,10) = '" . $date . "') a
						left join vouchercurrent b on a.TrackingNumber = b.TrackingNumber where TrackingType = 'PO' group by TrackingNumber,DateModified) a
						left join office b on a.Office = b.Code
						left join  ppmpcategories c on  c.Code = a.PR_CategoryCode";
		}else {
			$sql = "select a.*,b.Name as OfficeName,c.Description from(
						select a.*,b.Office,b.PR_CategoryCode,Claimant,b.DocumentType,b.Year,b.TrackingType,b.Amount,b.PO_Amount,b.TotalAmountMultiple,b.PR_Month,
						            case
										when b.TrackingType = 'PR' Then 'Purchase Request'
						                when b.TrackingType = 'PO' Then 'Purchase Order'
						                else b.DocumentType
									End as Document from(SELECT TrackingNumber,Status,DateModified FROM voucherhistory where Status = '" . $status . "' and  substr(DateModified,1,10) = '" . $date . "') a
						left join vouchercurrent b on a.TrackingNumber = b.TrackingNumber where DocumentType = '" . $document . "' group by TrackingNumber,DateModified) a
						left join office b on a.Office = b.Code
						left join  ppmpcategories c on  c.Code = a.PR_CategoryCode";
		}
		$record = $database->query($sql);
		echo $sheet->createCalendarDetails($record);
	}
	if(isset($_GET['fetchByDayCalendar'])){
		$arr =  explode('*',$database->charEncoder($_GET['par']));
		
		$status = $arr[0];
		$document = $arr[1];
		$date = $arr[2];
		if($document == "Purchase Request"){
			$sql = "
					select a.*,b.Name as OfficeName,c.Description from(select * from vouchercurrent where trackingtype = 'PR' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' group by trackingnumber) a
					left join office b on a.Office = b.Code
					left join ppmpcategories c on a.PR_CategoryCode = c.code
					order by OfficeName asc
					";
		}else if($document == "Purchase Order"){
			$sql = "select a.*,b.Name as OfficeName,c.Description from(select * from vouchercurrent where trackingtype = 'PO' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' group by trackingnumber) a
					left join office b on a.Office = b.Code
					left join ppmpcategories c on a.PR_CategoryCode = c.code
					order by OfficeName asc
					";
		}else {
			$sql = "select a.*,b.Name as OfficeName from(select * from vouchercurrent where documenttype = '" . $document . "' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' group by trackingnumber) a
					left join office b on a.Office = b.Code
					order by OfficeName asc";
		}
		$record = $database->query($sql);
		echo $sheet->createCalendarDetails($record);
	}
	if(isset($_GET['showCalendarDataLogs'])) {
		
		$month = $database->charEncoder($_GET['m']);
		$regulatoryOffice = stripslashes($database->charEncoder($_GET['rO']));
		echo $sheet->createCalendarLogs($year,$month,$regulatoryOffice);
	}
	if(isset($_GET['showCalendarData'])) {
		
		$month = $database->charEncoder($_GET['m']);
		
		$regulatoryOffice = stripslashes($database->charEncoder($_GET['rO']));
		echo $sheet->createCalendar($year,$month,$regulatoryOffice);
	}
	if(isset($_GET['showCalendarLogs'])) {
		
		$month = date('m');
		//$month = "10";
		$regulatoryOffice = stripslashes($database->charEncoder($_GET['rO']));
	
		$regulatoryOffice = '-';
		echo $sheet->createCalendarLogs($year,$month,$regulatoryOffice);
	}
	if(isset($_GET['showCalendar'])) {
		
		//$month = date('m');
		$month = "08";
		$regulatoryOffice = stripslashes($database->charEncoder($_GET['rO']));
	
		echo $sheet->createCalendar($year,$month,$regulatoryOffice);
	}
	if(isset($_GET['goSeeProc'])) {	
	
		$office = $database->charEncoder($_GET['office']);
		$officeName = stripslashes($database->charEncoder($_GET['officeName']));
		$regulatoryOffice = stripslashes($database->charEncoder($_GET['rO']));
		$toolsType = stripslashes($database->charEncoder($_GET['ty']));
		$toolsQuarter = stripslashes($database->charEncoder($_GET['qt']));
		
		$toolsField = stripslashes($database->charEncoder($_GET['fd']));
		$toolsOrder = stripslashes($database->charEncoder($_GET['or']));
		
		$toolsProcessFrom = stripslashes($database->charEncoder($_GET['fr']));
		$toolsProcessTo = stripslashes($database->charEncoder($_GET['to']));
		
		$toolsCountUpdated = stripslashes($database->charEncoder($_GET['sU']));
		$toolsCountCreated = stripslashes($database->charEncoder($_GET['sC']));
		
		$conditionDuration = '1 = 1';
		if($toolsCountUpdated != '-'){
			if($toolsType == "PR"){
				$conditionUpdated = ' PR_CalendarDaysFromUpdated >= ' . $toolsCountUpdated . ' and PR_Status != "For P.O"';
			}else if($toolsType == "PO"){
				$conditionUpdated = ' PO_CalendarDaysFromUpdated >= ' . $toolsCountUpdated . ' and PO_Status != "Waiting for Delivery"';
			}else{
				$conditionUpdated = ' PX_CalendarDaysFromUpdated >= ' . $toolsCountUpdated . ' and PX_Status != "Check Released"';
			}
			$conditionDuration = $conditionUpdated;
		}
		
		
		$conditionCreation = '1 = 1';
		if($toolsCountCreated != '-'){
			if($toolsType == "PR"){
				$conditionCreation = ' PR_CalendarDaysFromCreation >= ' . $toolsCountCreated . ' and PR_Status != "For P.O"';
			}else if($toolsType == "PO"){
				$conditionCreation = ' PO_CalendarDaysFromCreation >= ' . $toolsCountCreated . ' and PO_Status != "Waiting for Delivery"';
			}else{
				$conditionCreation = ' PX_CalendarDaysFromCreation >= ' . $toolsCountCreated . ' and PX_Status != "Check Released"';
			}
			$conditionDuration = $conditionCreation;
		}
		
		if($toolsType == "PR"){
			$conditionType = ' and x.PR_TrackingNumber is not null ';
			$sortBy = " order by x." . $toolsField . " " . $toolsOrder;
			
		}else if($toolsType == "PO"){
			$conditionType = ' and y.PO_TrackingNumber is not null ';
			$sortBy = " order by y." . $toolsField . " " . $toolsOrder;
		}else if($toolsType == "PX"){
			$conditionType = ' and z.PX_TrackingNumber is not null ';
			$sortBy = " order by z." . $toolsField . " " . $toolsOrder;
		}else{
			$sortBy = " order by x.PR_TrackingNumber asc ";
			$conditionType = ' ';
		}
		$sortCompletion = '';
		if($toolsField == "CalendarDaysCompleted"){
			$sortBy = '';
			$sortCompletion = ' order by ' .  $toolsField . ' ' . $toolsOrder;
		}
		$conditionQuarter = '';
		if($toolsQuarter != "-"){
			if($toolsQuarter == 1){
				$conditionQuarter = ' and (x.PR_Month >= 1 and x.PR_Month <= 3) ';
			}elseif($toolsQuarter == 2){
				$conditionQuarter = ' and (x.PR_Month >= 4 and x.PR_Month <= 6) ';
			}else if($toolsQuarter == 3){
				$conditionQuarter = ' and (x.PR_Month >= 7 and x.PR_Month <= 9) ';
			}else{
				$conditionQuarter = ' and x.PR_Month >= 9 ';
			}
		}
		//order by PR_CalendarDaysFromCreation asc
		$sql = "select *,PR_CalendarDaysFromCreation,PO_CalendarDaysFromCreation,Px_CalendarDaysFromCreation,(PR_CalendarDaysFromCreation + ifnull(PO_CalendarDaysFromCreation,0) + ifnull(PX_CalendarDaysFromCreation,0)) as CalendarDaysCompleted,
						(PR_WorkingDaysFromCreation + ifnull(PO_WorkingDaysFromCreation,0) + ifnull(PX_WorkingDaysFromCreation,0)) as WorkingDaysCompleted	
		
							
						 from( select x.*,DATEDIFF(substr(CURDATE(),1,10),substr(x.PR_DateModified,1,10)) as PR_CalendarDaysFromUpdated,
						DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(x.PR_DateModified, 1, 10)) -  (FLOOR((DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(x.PR_DateModified, 1, 10)) + 1) / 7) * 2) AS PR_WorkingDaysFromUpdated,
						if(PR_Status ='For P.O',DATEDIFF(substr(x.PR_DateModified,1,10),substr(x.PR_DateEncoded,1,10)),DATEDIFF(substr(CURDATE(),1,10),substr(x.PR_DateEncoded,1,10))) as PR_CalendarDaysFromCreation,
						if(PR_Status ='For P.O',
						DATEDIFF(SUBSTR(x.PR_DateModified, 1, 10), SUBSTR(x.PR_DateEncoded, 1, 10)) -  (FLOOR((DATEDIFF(SUBSTR(x.PR_DateModified, 1, 10), SUBSTR(x.PR_DateEncoded, 1, 10)) + 1) / 7) * 2) ,
						DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(x.PR_DateEncoded, 1, 10)) -  (FLOOR((DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(x.PR_DateEncoded, 1, 10)) + 1) / 7) * 2) ) as PR_WorkingDaysFromCreation,    


						DATEDIFF(substr(CURDATE(),1,10),substr(y.PO_DateModified,1,10)) as PO_CalendarDaysFromUpdated,   
						DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(y.PO_DateModified, 1, 10)) -  (FLOOR((DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(y.PO_DateModified, 1, 10)) + 1) / 7) * 2) AS PO_WorkingDaysFromUpdated,
						if(PO_Status ='Waiting for Delivery',DATEDIFF(substr(y.PO_DateModified,1,10),substr(y.PO_DateEncoded,1,10)),DATEDIFF(substr(CURDATE(),1,10),substr(y.PO_DateEncoded,1,10))) as PO_CalendarDaysFromCreation,
						if(PO_Status ='Waiting for Delivery',
						DATEDIFF(SUBSTR(y.PO_DateModified, 1, 10), SUBSTR(y.PO_DateEncoded, 1, 10)) -  (FLOOR((DATEDIFF(SUBSTR(y.PO_DateModified, 1, 10), SUBSTR(y.PO_DateEncoded, 1, 10)) + 1) / 7) * 2) ,
						DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(y.PO_DateEncoded, 1, 10)) -  (FLOOR((DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(y.PO_DateEncoded, 1, 10)) + 1) / 7) * 2) ) as PO_WorkingDaysFromCreation,    

						DATEDIFF(substr(CURDATE(),1,10),substr(z.PX_DateModified,1,10)) as PX_CalendarDaysFromUpdated,
						DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(z.PX_DateModified, 1, 10)) -  (FLOOR((DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(z.PX_DateModified, 1, 10)) + 1) / 7) * 2) AS PX_WorkingDaysFromUpdated,   
						if(PX_Status ='Check Released',DATEDIFF(substr(z.PX_DateModified,1,10),substr(z.PX_DateEncoded,1,10)),DATEDIFF(substr(CURDATE(),1,10),substr(z.PX_DateEncoded,1,10))) as PX_CalendarDaysFromCreation,
						if(PX_Status ='Check Released',
						DATEDIFF(SUBSTR(z.PX_DateModified, 1, 10), SUBSTR(z.PX_DateEncoded, 1, 10)) -  (FLOOR((DATEDIFF(SUBSTR(z.PX_DateModified, 1, 10), SUBSTR(z.PX_DateEncoded, 1, 10)) + 1) / 7) * 2) ,
						DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(z.PX_DateEncoded, 1, 10)) -  (FLOOR((DATEDIFF(SUBSTR(CURDATE(), 1, 10), SUBSTR(z.PX_DateEncoded, 1, 10)) + 1) / 7) * 2) ) as PX_WorkingDaysFromCreation,   

						 
						y.PO_TrackingNumber,y.Claimant, 
						y.PO_Amount,y.PO_DateEncoded,y.PO_DateModified,y.PO_Status , y.PO_Remarks ,y.PO_Id,

						z.PX_TrackingNumber ,z.PX_Amount,z.PX_DateEncoded,z.PX_DateModified,z.PX_Status, z.PX_Remarks, z.PX_Id
						from(
						select a.PR_Id, b.Name as OfficeName,a.PR_TrackingNumber, c.Description,a.Remarks as PR_Remarks, a.Office,a.PR_Amount,a.PR_CategoryCode,a.Fund, a.PR_Month,a.PR_Status,a.PR_DateEncoded,a.PR_DateModified,a.PR_EncodedBy from(
						SELECT distinct TrackingNumber as PR_TrackingNumber, Office,Fund,Id as PR_Id,
						if(TotalAmountMultiple > 0,TotalAmountMultiple, Amount) as PR_Amount,
						PR_CategoryCode, Status as PR_Status,Remarks,DateEncoded as PR_DateEncoded, DateModified as  PR_DateModified,EncodedBy as PR_EncodedBy, PR_Month
						from vouchercurrent where TrackingType = 'PR' and length(Office) > 1 and status != 'Cancelled' group by TrackingNumber) a
						left join office b on a.Office = b.Code
						left join ppmpcategories c on a.PR_CategoryCode = c.Code
						) x 

						left join (select Id as PO_Id,TrackingNumber as PO_TrackingNumber, PR_TrackingNumber,if(TotalAmountMultiple > 0,TotalAmountMultiple, PO_Amount) as PO_Amount,
						DateEncoded as PO_DateEncoded, DateModified as PO_DateModified, status as PO_Status, Claimant,Remarks as PO_Remarks
						from vouchercurrent where TrackingType = 'PO' and length(Office) > 1 and status != 'Cancelled'  group by TrackingNumber) y
						on x.PR_TrackingNumber = y.PR_TrackingNumber

						 left join (select Id as PX_Id,TrackingNumber as PX_TrackingNumber,TrackingPartner as PX_TrackingPartner,NetAmount as PX_Amount, Remarks as PX_Remarks,
						DateEncoded as PX_DateEncoded, DateModified as PX_DateModified,
						status as PX_Status
						from vouchercurrent where TrackingType = 'PX' and length(Office) > 1 and status != 'Cancelled' group by TrackingNumber) z
						on z.PX_TrackingPartner  = y.PO_TrackingNumber where x.Office ='" . $office . "' " . $conditionType . $conditionQuarter . " " . $sortBy . " ) v where " .  $conditionDuration . $sortCompletion ;
		
		$record = $database->query($sql);
		
		//echo  $sheet->createSupplierStatus($office);
		echo $sheet->createSeeProc($record,$office,$officeName,$regulatoryOffice,$toolsType,$toolsProcessFrom,$toolsProcessTo);
	}

	if(isset($_GET['showCalendarOffice'])) {
		$year = 2023;
		$month = date('m');
		//$month = "10";
		$regulatoryOffice = stripslashes($database->charEncoder($_GET['rO']));
		$regulatoryOffice = '-';
		$userOffice = $database->charEncoder($_GET['rC']);
		echo $sheet->createCalendarOffice($year,$month,$regulatoryOffice, $userOffice);
	}

	// if (isset($_GET['showCalendarOfficeJay'])) {
	// 	$year = 2023;
	// 	$month = date('m');

	// 	echo $sheet->createSimpleCalendar($year, $month);
	// }

	// if (isset($_GET['showCalendarOfficeJay'])) {
	// 	$yearMonth = '2023-11'; // Example date, this can be dynamic based on your needs
	// 	echo $sheet->createTrackingDataCalendar($yearMonth);
	// }
	

	if(isset($_GET['fetchByDayCalendarOffice'])){
		$arr =  explode('*',$database->charEncoder($_GET['par']));
		$status = $arr[0];
		$document = $arr[1];
		$date = $arr[2];
		$userOffice = $database->charEncoder($_GET['rC']);
		if($document == "Purchase Request"){
			$sql = "
					select a.*,b.Name as OfficeName,c.Description from(select * from vouchercurrent where trackingtype = 'PR' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' and Office = '".$userOffice."' group by trackingnumber) a
					left join office b on a.Office = b.Code
					left join ppmpcategories c on a.PR_CategoryCode = c.code
					order by OfficeName asc
					";
		}else if($document == "Purchase Order"){
			$sql = "select a.*,b.Name as OfficeName,c.Description from(select * from vouchercurrent where trackingtype = 'PO' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' and Office = '".$userOffice."' group by trackingnumber) a
					left join office b on a.Office = b.Code
					left join ppmpcategories c on a.PR_CategoryCode = c.code
					order by OfficeName asc
					";
		}else {
			$sql = "select a.*,b.Name as OfficeName from(select * from vouchercurrent where documenttype = '" . $document . "' and status  = '" . $status . "' and substr(DateModified,1,10) = '" . $date . "' and Office = '".$userOffice."' group by trackingnumber) a
					left join office b on a.Office = b.Code
					order by OfficeName asc";
		}

		$record = $database->query($sql);
		echo $sheet->createCalendarDetails($record);
	}


	
	if (isset($_GET['fetchByDayCalendarJay'])) {

		$arr = explode('*', $database->charEncoder($_GET['par']));
		$trackingnumber = $arr[0];
		$date = $arr[1];
		$trackingtype = $arr[2];
		$status = $arr[3];
		$condition = stripslashes(str_replace('"', '', $database->charEncoder($_GET['condition'])));
		$userOffice = $database->charEncoder($_GET['rC']);
	
		if ($trackingtype == 'PR'){
			$sql = "SELECT 
						a.*,
						b.DateModified, 
						o.Name AS OfficeName, 
						c.Description AS Description
					FROM (
						SELECT * 
						FROM citydoc2024.vouchercurrent 
						WHERE trackingtype IN ('PR') 
						GROUP BY trackingnumber
					) a
					LEFT JOIN (
						SELECT 
							TrackingNumber, 
							MIN(DateModified) AS DateModified
						FROM citydoc2024.voucherhistory 
						WHERE status LIKE '%$condition%' 
						GROUP BY TrackingNumber
					) b 
					ON a.TrackingNumber = b.TrackingNumber
					LEFT JOIN citydoc2024.office o 
					ON LOWER(SUBSTRING_INDEX(SUBSTRING_INDEX(a.TrackingNumber, '-', -2), '-', 1)) = LOWER(o.Code)
					LEFT JOIN citydoc2024.ppmpcategories c 
					ON a.PR_CategoryCode = c.Code
					WHERE a.PR_Number != '' 
					AND b.DateModified != '' 
					AND SUBSTRING(b.DateModified, 1, 10) LIKE '%$date%'
					ORDER BY a.TrackingNumber;";

		}else if ($trackingtype == 'PO'){
			$sql = "SELECT 
						a.*,
						b.DateModified, 
						o.Name AS OfficeName, 
						c.Description AS Description
					FROM (
						SELECT * 
						FROM citydoc2024.vouchercurrent 
						WHERE trackingtype IN ('PO') 
						GROUP BY trackingnumber
					) a
					LEFT JOIN (
						SELECT 
							TrackingNumber, 
							MIN(DateModified) AS DateModified
						FROM citydoc2024.voucherhistory 
						WHERE status LIKE '%$condition%' 
						GROUP BY TrackingNumber
					) b 
					ON a.TrackingNumber = b.TrackingNumber
					LEFT JOIN citydoc2024.office o 
					ON LOWER(SUBSTRING_INDEX(SUBSTRING_INDEX(a.TrackingNumber, '-', -2), '-', 1)) = LOWER(o.Code)
					LEFT JOIN citydoc2024.ppmpcategories c 
					ON a.PR_CategoryCode = c.Code
					WHERE a.PO_Number != '' 
					AND b.DateModified != '' 
					AND SUBSTRING(b.DateModified, 1, 10) LIKE '%$date%'
					ORDER BY a.TrackingNumber;";

		}else if ($trackingtype == 'PX'){
			$sql = "SELECT 
						a.*,
						b.DateModified, 
						o.Name AS OfficeName, 
						c.Description AS Description
					FROM (
						SELECT * 
						FROM citydoc2024.vouchercurrent 
						WHERE trackingtype IN ('PX') 
						GROUP BY trackingnumber
					) a
					LEFT JOIN (
						SELECT 
							TrackingNumber, 
							MIN(DateModified) AS DateModified
						FROM citydoc2024.voucherhistory 
						WHERE status LIKE '%$condition%' 
						GROUP BY TrackingNumber
					) b 
					ON a.TrackingNumber = b.TrackingNumber
					LEFT JOIN citydoc2024.office o 
					ON LOWER(SUBSTRING_INDEX(SUBSTRING_INDEX(a.TrackingNumber, '-', -2), '-', 1)) = LOWER(o.Code)
					LEFT JOIN citydoc2024.ppmpcategories c 
					ON a.PR_CategoryCode = c.Code
					WHERE 
					b.DateModified != '' 
					AND SUBSTRING(b.DateModified, 1, 10) LIKE '%$date%'
					ORDER BY a.TrackingNumber;";
		}else if ($trackingtype == 'NF'){
			$sql = "SELECT 
						a.*,
						b.DateModified, 
						o.Name AS OfficeName, 
						c.Description AS Description
					FROM (
						SELECT * 
						FROM citydoc2024.vouchercurrent 
						WHERE trackingtype IN ('NF') 
						GROUP BY trackingnumber
					) a
					LEFT JOIN (
						SELECT 
							TrackingNumber, 
							MIN(DateModified) AS DateModified
						FROM citydoc2024.voucherhistory 
						WHERE status LIKE '%$condition%' 
						GROUP BY TrackingNumber
					) b 
					ON a.TrackingNumber = b.TrackingNumber
					LEFT JOIN citydoc2024.office o 
					ON LOWER(SUBSTRING_INDEX(SUBSTRING_INDEX(a.TrackingNumber, '-', -2), '-', 1)) = LOWER(o.Code)
					LEFT JOIN citydoc2024.ppmpcategories c 
					ON a.PR_CategoryCode = c.Code
					WHERE 
					b.DateModified != '' 
					AND SUBSTRING(b.DateModified, 1, 10) LIKE '%$date%'
					ORDER BY a.TrackingNumber;";
		}else if ($trackingtype == 'IP'){
			$sql = "SELECT 
						a.*,
						b.DateModified, 
						o.Name AS OfficeName, 
						c.Description AS Description
					FROM (
						SELECT * 
						FROM citydoc2024.vouchercurrent 
						WHERE trackingtype IN ('IP') 
						GROUP BY trackingnumber
					) a
					LEFT JOIN (
						SELECT 
							TrackingNumber, 
							MIN(DateModified) AS DateModified
						FROM citydoc2024.voucherhistory 
						WHERE status LIKE '%$condition%' 
						GROUP BY TrackingNumber
					) b 
					ON a.TrackingNumber = b.TrackingNumber
					LEFT JOIN citydoc2024.office o 
					ON LOWER(SUBSTRING_INDEX(SUBSTRING_INDEX(a.TrackingNumber, '-', -2), '-', 1)) = LOWER(o.Code)
					LEFT JOIN citydoc2024.ppmpcategories c 
					ON a.PR_CategoryCode = c.Code
					WHERE 
					b.DateModified != '' 
					AND SUBSTRING(b.DateModified, 1, 10) LIKE '%$date%'
					ORDER BY a.TrackingNumber;";
		}else if ($trackingtype == 'PY'){
			$documenttype = $arr[4];
			$sql = "SELECT 
						a.*,
						b.DateModified, 
						o.Name AS OfficeName, 
						c.Description AS Description
					FROM (
						SELECT * 
						FROM citydoc2024.vouchercurrent 
						WHERE trackingtype IN ('PY') 
						GROUP BY trackingnumber
					) a
					LEFT JOIN (
						SELECT 
							TrackingNumber, 
							MIN(DateModified) AS DateModified
						FROM citydoc2024.voucherhistory 
						WHERE status LIKE '%$condition%' 
						GROUP BY TrackingNumber
					) b 
					ON a.TrackingNumber = b.TrackingNumber
					LEFT JOIN citydoc2024.office o 
					ON LOWER(SUBSTRING_INDEX(SUBSTRING_INDEX(a.TrackingNumber, '-', -2), '-', 1)) = LOWER(o.Code)
					LEFT JOIN citydoc2024.ppmpcategories c 
					ON a.PR_CategoryCode = c.Code
					WHERE 
					b.DateModified != '' 
					AND SUBSTRING(b.DateModified, 1, 10) LIKE '%$date%'
					and a.documenttype like  '%$documenttype%'
					ORDER BY a.TrackingNumber;";
		}

		// Execute the query
		$record = $database->query($sql);
		
		// // Output the result
		// echo $condition;
		// echo $trackingtype;
		echo $sheet->createCalendarDetailsJay($record);
	}
	



	if(isset($_GET['showCalendarDataOffice'])) {
		$month = $database->charEncoder($_GET['m']);
		
		$regulatoryOffice = stripslashes($database->charEncoder($_GET['rO']));
		$userOffice = $database->charEncoder($_GET['rC']);
		echo $sheet->createCalendarOffice($year,$month,$regulatoryOffice, $userOffice);
	}

	if (isset($_GET['showCalendarOfficeJay'])) {
		$year = 2024;
		$month = isset($_GET['m']) ? $database->charEncoder($_GET['m']) : date('m'); // Default to current month if 'm' is not set
		$regulatoryOffice = isset($_GET['rO']) ? stripslashes($database->charEncoder($_GET['rO'])) : 'CBO RECEIVED'; 
		$userOffice = isset($_GET['rC']) ? $database->charEncoder($_GET['rC']) : ''; // Default to empty string if 'rC' is not set
	
		echo $sheet->createSimpleCalendar($year, $month, $regulatoryOffice, $userOffice);
	}
	
	


	if(!isset($_SESSION['employeeNumber'])) {
			
		$referer = explode('/', $_SERVER['HTTP_REFERER']);
		$location = strtoupper($referer[sizeof($referer) - 1]);
	
		if($location == 'DOCTRACKPUBLICSEARCH.PHP' || $location == 'LOGIN.PHP') {
		}else {
			// echo "<iframe style='display:none' onload='logout()' src=''></iframe>";
			die();
		}
		
	}
	
	

	if(isset($_SESSION['officeCode'])){
		//$office = $_SESSION['officeCode'];
		$office = $_SESSION['cbo'];
		
		$employeeNumber = $_SESSION['employeeNumber'];
		$accountType = $_SESSION['accountType'];
		/*$smsControl = 0;
		if(isset($_SESSION['smsControl'])){
			$smsControl = $_SESSION['smsControl'];
		}*/
	}
	
	
	$message3 = '';
	//$message3 ="test";
	//default
	$record1 = $database->GetDefault();
	$data =  $database->fetch_array($record1);
	//$defaultYear = $data['YearFundEncoded'];
	$defaultYear = 2023;
	if(isset($_GET['fuJxy1za'])){
		$crypt = $database->charEncoder($_GET['xaYvsfTs']);
		$arr = explode('@#$', $database->vArrange($crypt));
		
		$employeeNumber = $arr[0];
		$surname = $arr[1];
		$passText = $arr[2];
		
		$password = md5($passText);
		
		$record = $database->FindEmployee($employeeNumber,$surname);
		$count =  $database->num_rows($record);
		if($count >= 1){
			$record = $database->FindRegistration($employeeNumber);
			$count =  $database->num_rows($record);
			if($count >= 1){
				$data  = $database->fetch_array($record);
				$resetState = $data['ResetState'];
				if($resetState == '1'){
					$database->UpdatePassword($employeeNumber,$password);
					echo 1;
				}else{
					$registrationState = $data['RegistrationState'];
					if($registrationState == 0){
						echo 2;
					}else{
						echo 3;
					}
				}
			}else{
				$database->InsertRegistration($employeeNumber,$password,$dateEncoded);
				echo 4;
			}
		}else{
			echo 5;
		}
	}

	if(isset($_GET['fujxyza'])){
		
		$crypt = $database->charEncoder($_GET['xaXvsfTs']);
		
		$arr = explode('~!~', $database->vArrange($crypt));
		
		$employeeNumber = substr($arr[0],0,6);
		$mt = substr($arr[0],6);
		
		$passText = $arr[1];

		$password = md5($passText);

		$record = $database->LoginUser($employeeNumber,$password);		
		$count = $database->num_rows($record);

		//echo $mt;
		//echo $ip;

		if($count >= 1){
			$data = $database->fetch_array($record);
			$registrationState = $data['RegistrationState'];
			if($registrationState == 1){
				
				$id = $data['UserId'];
				$print = $data['Prints'];
				
				if($mt <= $print){
					$sql = "Update  citydoc.users set Logcker = '" . $dateEncoded . "' where Id  = '" . $id . "' limit 1";
					$database->query($sql);
					echo 4;
				}else{
					$sql = "Update  citydoc.users set LoginState = 1, DateLog = '" . $dateEncoded . "',Prints = '" . $mt . "', IpMan = '" . $ip . "' where Id  = '" . $id . "' limit 1";
					$database->query($sql);
					
					$_SESSION['employeeNumber'] =  $data['EmployeeNumber'];
					
					$fullName = $data['FirstName']. ' ' . $data['MiddleName'] . ' ' . $data['LastName'];
					$office = trim($data['OfficeCode']);
					$accountType = $data['AccountType'];
					$officeName = $data['Name'];
					
					$_SESSION['officeCode'] = $data['OfficeCode'];
					$_SESSION['gso'] = $data['OfficeCode'];
					$_SESSION['cbo'] = $data['OfficeCode'];
					$_SESSION['fullName'] =  $database->charEncoder(utf8_encode($fullName));
					$_SESSION['officeName'] = $officeName;
					$_SESSION['accountType'] = $accountType;
					$_SESSION['FkyhaXs'] = $id;
					$_SESSION['perm'] = $data['Permission'];
					$_SESSION['privy'] = $data['Privilege'];
					//$_COOKIE['nakaLogin'] = 1;
					
					if($accountType == 1){
						$_SESSION['position'] = "Officer";
					}else if($accountType == 2){
						$_SESSION['position'] = "DTS  Officer";
					}elseif($accountType == 3){
						$_SESSION['position'] = "Doctrack Administrator";
					}elseif($accountType == 4){
						$_SESSION['position'] = "Master Receiver";
					}elseif($accountType == 5){
						$_SESSION['position'] = "Master Releaser";
					}elseif($accountType == 6){
						$_SESSION['position'] = "Pending Master";
					}elseif($accountType == 7){
						$_SESSION['position'] = "Programmer";
					}elseif($accountType == 8){
						$_SESSION['position'] = "SLP Master";
					}elseif($accountType == 9){
						$_SESSION['position'] = "Master Adviser";
					}elseif($accountType == 10){
						$_SESSION['position'] = "BAC Officer";
					}
					
					/*$smsControl = 0;
					$sql = "select * from citydoc.sms where office = '" . $office . "' and employeenumber = '" . $employeeNumber . "' limit 1";
					$record = $database->query($sql);
					$count = $database->num_rows($record);
					if($count > 0){
						$data = $database->fetch_array($record);
						$_SESSION['smsControl'] = $data['Control'];
						$_SESSION['smsStatuses'] = $data['Statuses'];
						$_SESSION['smsNumbers'] = $data['Numbers'];
					}*/
					
					echo 1;
				}
			}else{
				echo 2;
			}
		}else{
			echo 3;
		}
	}

	if(isset($_GET['logout'])){
		
		$sql = "Update  citydoc.users set LoginState = 0 where Id  = " . $_SESSION['FkyhaXs'] . " limit 1";
		$database->query($sql);
		
		//$_COOKIE['nakaLogin'] = 2;
		unset($_SESSION['fullName']);
		unset($_SESSION['officeName']);
		unset($_SESSION['officeCode']);
		unset($_SESSION['position']);
		unset($_SESSION['poster']);
		unset($_SESSION['employeeNumber']);
		unset($_SESSION['accountType']);
		unset($_SESSION['asdf']);

		session_destroy();
		
		$database->close_connection();
	}
	//------------------------------------------------------------------------------------------ fund encode
	if(isset($_GET['loadOffice'])){
		$record =  $database->GetOffice();	
		echo $sheet->CreateOfficeSelect($record);
	}
	if(isset($_GET['loadPrograms'])){
		$record =  $database->GetPrograms();	
		echo $sheet->CreateSelectPrograms($record);
	}
	if(isset($_GET['loadProgramsApp'])){
		$record =  $database->GetPrograms();	
		echo $sheet->CreateProgramSelectOfficial($record,"selectProgramApp"," loadAppPerProgram");
	}
	if(isset($_GET['laodEncodedFund'])){
		$record1 =  $database->GetEncodedFund($defaultYear,$office);
		$record2 = $database->GetTotalFund($defaultYear,$office);
		$sheet  = $sheet->CreateEncodedFundTable($record1) . '*' . $sheet->CreateFundSummary($record2);
		echo $sheet;
	}
	if(isset($_GET['saveFund'])){
		
		$office = $database->charEncoder($_GET['office']);
		$code = $database->charEncoder($_GET['code']);
		$amount = $database->charEncoder($_GET['amount']);
		$programCode = $database->charEncoder($_GET['programCode']);
		
		$isCode = $database->num_rows($database->SearchAccountCode($code));
		if($isCode == 1){
			
			$record = $database->FindEncodedCode($defaultYear,$office,$programCode, $code);
			$count = $database->num_rows($record);

			if($count == 0){
				$database->SaveEncodedFund($defaultYear,$office,$programCode,$code,$amount,$dateEncoded,$employeeNumber);
			}else{
				if($amount == 'del'){
					$database->DeleteEncodedFund($year,$office,$programCode,$code);
				}else{
					$database->UpdateEncodedFund($defaultYear,$office,$programCode,$code,$amount,$dateEncoded,$employeeNumber);
				}
			}
			//$record1 =  $database->GetEncodedFund($year,$office);
			$record1 = $database->GetEncodedByProgramCode($year,$office,$programCode);
			$record2 = $database->GetTotalFund($year,$office);
			//$sheet  = $sheet->CreateEncodedFundTable($record1) . '*' . $sheet->CreateFundSummary($record2);
			$sheet  = $sheet->CreateEncodedFundTable($record1);
			echo $sheet;
			
		}else{
			$sheet->CreateObrMessages("Acount code <span style = 'font-weight:bold;color:red;'>"  . $code . "</span> does not exist.");
		}
	}	
	if(isset($_GET['getEncodedByProgramCode'])){
		$programCode = $database->charEncoder($_GET['programCode']);
		$record = $database->GetEncodedByProgramCode($year,$office,$programCode);
		echo $sheet->CreateEncodedFundTable($record);
		
	}
	//-----------------------------------------------------------------fund view
	if(isset($_GET['loadOfficeInBudgetStatus'])){
		if($_SESSION['accountType'] >= 2){
			$record =  $database->GetOffice();	
			echo $sheet->CreateOfficeSelectInStatus($record);
		}
		
	
	}	
	if(isset($_GET['getEncodedFund'])){
		$office = $database->charEncoder($_GET['office']);
		$record = $database->GetEncodedFund($year,$office);
		$sheet->CreateEncodedFundTable($record);
	}	
	if(isset($_GET['getEncodedByFund'])){
		
		$fund = $database->charEncoder($_GET['fund']);
		$programCode = $database->charEncoder($_GET['programCode']);
		
		if($fund != 'Total'){
			$record = $database->GetEncodedByFund($year,$office,$programCode,$fund);
		}else{
			$record = $database->GetEncodedFund($year,$office);
		}
		echo $sheet->CreateEncodedFundTable($record);
	}
	if(isset($_GET['selectProgramCodeByOffice'])){
		$officeCode = $database->charEncoder($_GET['officeCode']);
		$record = $database->GetProgramCodesByOffice($year,$officeCode);
		$count = $database->num_rows($record);
		if($count == 1){ //IF ISA LNG ANG PCODE
		
			$record = $database->GetEncodedByOffice($year,$officeCode);
			$count1 = $database->num_rows($record);
			if($count1 >= 0){
				echo 1 . '(*' . $sheet->CreateEncodedFundTableBudget($record);
			}else{
				echo 3 . 'wala';
			}
			
		}else if($count > 1){
			
			echo 2 . '(*' . $sheet->CreateProgramSelect($record);
		}else{
			echo 3 . '(*' . 'wala';
		}
	}
	if(isset($_GET['selectFundsByProgramCode'])){
		$officeCode = str_replace(" ",'',$_GET['officeCode']);
		$programCode = $database->charEncoder($_GET['programCode']);
		
		if($programCode == 'All'){
			$record = $database->GetEncodedByOffice($year,$officeCode);
		}else{
			$record = $database->GetEncodedByProgramCode($year,$officeCode,$programCode);
		}
		
		
		
		echo $sheet->CreateEncodedFundTableBudget($record);
		
	}
	if(isset($_GET['updateApproval'])){
		$fundId = $database->charEncoder($_GET['fundId']);
		$value = $database->charEncoder($_GET['value']);
		if($value == "true"){
			$approval = 1;
		}
		if($value == "false"){
			$approval = 0;
		}
		$record = $database->UpdateFundId($fundId,$approval);
	}
	if(isset($_GET['getEncodedByFund2'])){
		$fund =  $database->charEncoder($_GET['fund']);
		
		$officeCode = $database->charEncoder($_GET['officeCode']);
		$programCode = $database->charEncoder($_GET['programCode']);
		if($programCode == 1){
			if($fund == '-'){
				$record = $database->GetEncodedByOffice($year,$officeCode);
				$condition = " where a.Year = '" . $year . "' and a.OfficeCode = '" . $officeCode . "' ";
				$record = $database->GetEncodedByCondition($condition);
				if($database->num_rows($record) == 0){
					echo 0;
				}else{
					echo $sheet->CreateEncodedFundTableBudget($record);
				}
			}else if($fund == 'UNCHECK'){
				$condition = " where a.Year = '" . $year . "' and a.OfficeCode = '" . $officeCode . "' and Approval != 1 ";
				$record = $database->GetEncodedByCondition($condition);
				if($database->num_rows($record) == 0){
					echo 0;
				}else{
					echo $sheet->CreateEncodedFundTableBudget($record);
				}
			}else{
				$condition = "where a.Year = '" . $year . "' and a.FundType = '" . $fund ."' and a.OfficeCode = '" . $officeCode . "' ";
				$record = $database->GetEncodedByCondition($condition);
				if($database->num_rows($record) == 0){
					echo 0;
				}else{
					echo $sheet->CreateEncodedFundTableBudget($record);
				}
			}	
		}else{
			if($fund == '-'){
				$record = $database->GetEncodedByOffice($year,$officeCode);
				$condition = " where a.Year = '" . $year . "' and a.OfficeCode = '" . $officeCode . "' ";
				$record = $database->GetEncodedByCondition($condition);
				if($database->num_rows($record) == 0){
					echo 0;
				}else{
					echo $sheet->CreateEncodedFundTableBudget($record);
				}
			}else if($fund == 'UNCHECK'){
				$condition = " where a.Year = '" . $year . "' and a.OfficeCode = '" . $officeCode . "' and Approval != 1 ";
				$record = $database->GetEncodedByCondition($condition);
				if($database->num_rows($record) == 0){
					echo 0;
				}else{
					echo $sheet->CreateEncodedFundTableBudget($record);
				}
			}else{
			
				if($programCode == 'All'){
					$condition = "where a.Year = '" . $year . "' and a.FundType = '" . $fund ."' and a.OfficeCode = '" . $officeCode . "' ";
				}else{
					$condition = "where a.Year = '" . $year . "' and a.FundType = '" . $fund ."' and a.OfficeCode = '" . $officeCode . "' and a.ProgramCode = '" . $programCode . "' ";
				}
				$record = $database->GetEncodedByCondition($condition);
				if($database->num_rows($record) == 0){
					echo 0;
				}else{
					echo $sheet->CreateEncodedFundTableBudget($record);
				}
			}	
		}
	}
	if(isset($_GET['viewBalanceByOffice'])){
		$officeCode = $database->charEncoder($_GET['officeCode']);
		
		$record = $database->LoadAppropriationStatus($defaultYear,$officeCode);
		echo $sheet->CreateAppropriationStatus($record);
	}
	//--------------------------------------------------------------------------------------------------------------------doctrack Add new 
	
	if(isset($_GET['selectAppropriationByFund'])){
		$fundType = $database->charEncoder($_GET['fundType']);
		$record = $database->GetEncodedByFundOrderCode($year,$office,$fundType);
		echo $sheet->CreateSelectAppropriation($record);
	}
	
	if(isset($_GET['selectNewDoctrack'])){
		$type = $database->charEncoder($_GET['type']);
		if($type == "optPR"){ // pag pr ang gi pili
		
			$condition = " where Code = '" . $office . "'";
			$field = "PR";		
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			$count = $data['PR'] + 1;
			$id  = "PR-" . $office . "-" . $count;

			echo $type . '*' .  $id;
		}else if($type == "optPO"){ // pag po og py ang gi pili
	
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
			
			// $case = "Select TrackingNumber,TotalAmountMultiple,ChargeType,Amount from vouchercurrent 
			// 		where 
			// 		office = '" . $office . "' and Trackingtype = 'PR' and  Status = 'CBO Released' or
			// 		office = '" . $office . "' and Trackingtype = 'PR' and  Status = 'GSO Released' 
					
			// 		group by trackingNumber order by Id desc ";
			/*$case = "Select TrackingNumber,TotalAmountMultiple,ChargeType,Amount from vouchercurrent 
					where 
					office = '" . $office . "' and Trackingtype = 'PR' and  Status = 'For P.O' or
					office = '" . $office . "' and Trackingtype = 'PR' and  Status = 'GSO Released' or
					office = '" . $office . "' and Trackingtype = 'PR' and  Status = 'CTO Received'
					
					group by trackingNumber order by Id desc ";*/
					
			$case = "Select TrackingNumber,TotalAmountMultiple,ChargeType,Amount from vouchercurrent 
					where 
					office = '" . $office . "' and Trackingtype = 'PR' and  Status = 'For P.O'
					group by trackingNumber order by Id desc ";
			$record = $database->FetchThis($case);
			//$record = $database->FetchApprovePR($defaultYear,$office);
			//$record = $database->FetchManualApprovePR($defaultYear,$office);
			echo $type . '*' . $id . '*' .  $sheet->CreateSelectApprovePR($record);

		}else if($type == "optPY"){
	
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
			//$record = $database->LoadProgramFundsByOffice($defaultYear,$_SESSION['officeCode']);	
			
			if($office == "LUMP" || $office == "REMI"){
				$sql = "Select a.ProgramCode as Code, b.Name, b.SubCode  from funds a inner join  programcode b on a.ProgramCode = b.Code
				
					 group by a.ProgramCode";
			}else{
				$sql = "Select a.ProgramCode as Code,b.Name, b.SubCode from funds a inner join  programcode b on a.ProgramCode = b.Code
					where a.OfficeCode = '" . $office . "'
					or
					a.OfficeCode = 'LUMP'
					 group by a.ProgramCode";
			}
			
			$record = $database->query($sql);	
			
			$record1 = $database->GetClaimType();
			echo $type . '*' . $id . '*' .  $sheet->CreateSelectProgramsPY($record) . '*' . $sheet->CreateSelectClaimTypePY($record1);
	
		}else if($type == "optLQ"){
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
			
			/*$sql = "Select TrackingNumber,Claimant,PeriodMonth,if (TotalAmountMultiple > 0, TotalAmountMultiple,Amount) as Gross from vouchercurrent 
					where 
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Petty Cash' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Foreign)' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Local)' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Special' and Checknumber > 0  
					group by trackingnumber order by dateencoded  desc ";*/
			
			$sql = "Select TrackingNumber,Claimant,PeriodMonth,NetAmount as Gross from vouchercurrent 
					where 
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Petty Cash' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Foreign)' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Local)' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Special' and Checknumber > 0  
					group by trackingnumber order by dateencoded  desc ";		
			$record = $database->query($sql);	
			echo $type . '*' . $id . '*' . $sheet->CreateSelectLiquidation($record);
		}else if($type == "optRET"){
	
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;

			$sql = "SELECT Claimant FROM vouchercurrent 
					WHERE TrackingType = 'PX' AND checkdate IS NOT NULL AND Office = '".$office."' GROUP BY Claimant ORDER BY Claimant ASC;";
			$record = $database->query($sql);
			$suppliers = "<option></option>";
			while ($data = $database->fetch_array($record)) {
				// $supplierName = $database->charEncoder($data['Claimant']);
				$supplierName = utf8_encode($data['Claimant']);
				$suppliers .= "<option>". $supplierName."</option>";
			}
			
			echo $type . '*j*' . $id . '*j*' . $suppliers;
		}else if($type == "optWGS"){
	
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
			
			echo $type . '*' . $id;
		}else if($type == "optPAY"){
	
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
			
			echo $type . '*' . $id;
		}else if($type == "optMLQ"){
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
			
			$sql = "Select TrackingNumber,Claimant,PeriodMonth,NetAmount as Gross from vouchercurrent 
					where 
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Petty Cash' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Foreign)' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Local)' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Special' and Checknumber > 0  
					group by trackingnumber order by dateencoded  desc ";		
			$record = $database->query($sql);	
			echo $type . '*' . $id . '*' . $sheet->CreateSelectLiquidationMLQ($record, 1);
		}else if($type == "optINP"){
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;

			$sql = "SELECT TrackingNumber, Claimant, Amount, Fund FROM vouchercurrent 
					WHERE 
					Office = '".$_SESSION['officeCode']."' AND DocumentType = 'Infrastructure' AND Status = 'NTP Forwarded to Construction Division'";
			$record = $database->query($sql);
			echo $type . '*' . $id . '*' . $sheet->CreateSelectInfraFinal($record);
		}else if($type == "optNLIQ"){
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
			
			$sql = "Select TrackingNumber,Claimant,PeriodMonth,NetAmount as Gross, OBR_Number, ADV1 from vouchercurrent 
					where 
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Petty Cash' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Foreign)' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Local)' and Checknumber > 0  or
					office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Special' and Checknumber > 0  
					group by trackingnumber order by dateencoded  desc ";		
			$record = $database->query($sql);	
			echo $type . '*' . $id . '*' . $sheet->CreateSelectLiquidationNLIQ($record, 1);
		}else if($type == "optPONew"){ // pag po og py ang gi pili
	
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
					
			$case = "Select TrackingNumber,TotalAmountMultiple,ChargeType,Amount from vouchercurrent 
					where 
					office = '" . $office . "' and Trackingtype = 'PR' and  Status = 'For P.O'
					group by trackingNumber order by Id desc ";
			$record = $database->FetchThis($case);
			echo $type . '*' . $id . '*' .  $sheet->CreateSelectApprovePRNew($record);

		}else if($type == "optPX"){ // pag po og py ang gi pili
	
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
					
			// $sql = "SELECT TrackingNumber, Claimant, PO_Amount, TotalAmountMultiple FROM vouchercurrent WHERE Office = '".$office."' AND TrackingType = 'PO' AND Status = 'For Payment' GROUP BY TrackingNumber ORDER BY DateModified DESC";
			$sql = "SELECT TrackingNumber, Claimant, PO_Amount, TotalAmountMultiple FROM vouchercurrent WHERE Office = '".$office."' AND TrackingType = 'PO' AND (Status = 'For Payment' OR Status = 'Waiting for Delivery' OR Status = 'Inspected' OR Status = 'Inventory') GROUP BY TrackingNumber ORDER BY DateModified DESC";
			$record = $database->query($sql);
			echo $type.'*j*'.$id.'*j*'.$sheet->goodsSelectApprovedPOforPX($record);
		}

	}
	if(isset($_GET['getSubCode'])){
		$programCode = $database->charEncoder($_GET['subCode']);
		$sql = "select * from subprogramcode where maincode = '" . $programCode . "' order by description asc";
		$record = $database->query($sql);
		
		$sheet = '<option></option>';
		while($data = $database->fetch_array($record)){
			$code = $data['SubCode'];
			$desc = $data['Description'];
			$sheet .= '<option value = "' . $code . '">' . $desc . '</option>';
		}
		echo $sheet;

	}

	if(isset($_GET['selectByCategoryPPMP'])){
		if(isset($_GET['searchType'])){ // diri ni sa update, kung mag search og details sa ppmp
				
			$year  = $database->charEncoder($_GET['year']);
			$officeCode = $database->charEncoder($_GET['officeCode']);
			$categoryCode = $database->charEncoder($_GET['categoryCode']);
			$month = $database->charEncoder($_GET['prMonth']);
			$docType = $database->charEncoder($_GET['docType']);
			
			$programCode = $database->charEncoder($_GET['programCode']);
			
			if($docType == "PR"){
				$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
				$record = $database->FetchonPRrecord($year,$trackingNumber);

				if($database->num_rows($record) > 0){
					echo $sheet->CreateViewListPRPO($record);
				}else{
					echo 0;
				}
			}else{        
				$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
				$record = $database->FetchCategoryItemsPPMPonPO($year,$trackingNumber);
				
				$record = $database->FetchCategoryItemsPPMPonPO($year,$trackingNumber);//------------detalye ni sa po 
				if($database->num_rows($record) > 0){
					echo $sheet->CreateViewListPRPO($record);
				}else{
					echo 0;
				}
			}
			
		}else{							// diri ni sa add new kung mag search og details sa ppmp
							
			$category = $database->charEncoder($_GET['category']);
			$month = $database->charEncoder($_GET['month']);
			$selectType = $database->charEncoder($_GET['selectType']);
			$programCode = $database->charEncoder($_GET['programCode']);
			
			
			if(strlen($category) != 0){
				
				$record = $database->FetchCategoryItemsPPMPallFunds($defaultYear,$office,$category,$month);
				
				
				if($database->num_rows($record) > 0){
					
					if($selectType == "selectSchedPPMP"){ //wala pani ka save select palang sa ppmp na category before save
						echo $sheet->CreateTableItemsPPMPselection($record,$month);
						
					}else if($selectType == "selectTrackingPR"){ 
						$trackingNumber = $_GET['trackingNumber'];
						$record = $database->FetchonPRrecord($year,$trackingNumber);
						echo $sheet->CreatePOBreakdown($record);	
					}
					
				}else{
					
					echo 0;
				}
			}else{
				echo 0;
			}
			
		}
	}
	
	if(isset($_POST['saveTrackingPost'])){
		$trackType = $database->charEncoder($_POST['trackType']);
		$prMonth = $database->charEncoder($_POST['prMonth']);
		
		$prData =  $_POST['prData'];
		
		$grp =  $database->charEncoder($_POST['grp']);
		$oTotal =  $database->charEncoder($_POST['oTotal']);
		if($oTotal > 50000){
			$mode = 1;
		}else{
			$mode = 2;
		}
		$status = 'Encoded';
	    	$updateCase = "PR = PR + 1";
		//update id
		$database->IncrementTrackingSeries($updateCase,$office);
		
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("PR",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = "PR-" . $office . '-' . $data['PR'];
		$newTrackingNumber = "PR-" . $office . '-' . ($data['PR']+1); 
	
		
		$catX = 0;
		$cat = '';
		
		$progX = 0;
		$pro = '';
		
		$codeX = 0;
		$cod = '';
		
		$insertThis = '';
		$splitPRdata =  explode("~#~",$prData);
		for($i = 0; $i < sizeof($splitPRdata)-1;$i++ ){
			$prData = explode("~!~", $splitPRdata[$i]);
			$category = $prData[0];
			$program = $database->charEncoder(urldecode($prData[1]));
			$code = $database->charEncoder(urldecode($prData[2]));
			
			$desc = $database->charEncoder($prData[3]);
			//$desc = $prData[3];
			
			$qty = $prData[4];
			$unit =$database->charEncoder(urldecode($prData[5]));
			$cost = $prData[6];
			$item = $database->charEncoder(urldecode($prData[7]));
			$total = $qty * $cost;	
			// identify  charge type 1-5
			if($cat != $category){
				$catX++;
				$cat = $category;
			}
			if($pro != $program){
				$progX++;
				$pro = $program;
			}
			if($cod != $code){
				$codeX++;
				$cod = $code;
			}
			$insertThis .= ",('" . $trackingNumber . "','" . $category . "','" . $program . "','" . $code . "','" . $desc ."'," . $qty . ",'" .  ucfirst($unit) . "','" . $cost . "','" . $total . "','" . $item . "')";		
		}
		$chargeType = 0;
		if($catX == 1){
			if($progX == 1){
				if($codeX == 1){
					$chargeType = 1;
					$oTotal = 0;
				}else{
					$chargeType = 2;
				}
				
			}else if ($progX > 1){
				$chargeType = 3;
			}
		}else if ($catX == 2){
			$chargeType = 4;
		}
	
		$insertPRdetails =  substr($insertThis,1,strlen($insertThis));
			
		
		$case = "Insert into prrecord(TrackingNumber,Category,ProgramCode,Code,Description,Qty,Unit,Amount,Total,Item)values " . $insertPRdetails ; 
		//insert to prrecord
		$affected = $database->UpdateInsertSpecial($case);
		//insert to particulars
		$sql = "Insert into particulars (trackingnumber)values ('" . $trackingNumber  . "')";
		$database->query($sql);
		
		$insertThis = '';
		$fund = $_POST['fund'];
		/*if($office == "LSBD"){
			$fund = "SEF";
		}else{
			$fund = "GENERAL FUND";
		}*/
		
		$splitGRPdata =  explode("~#~",$grp);
		for($i = 0; $i < sizeof($splitGRPdata)-1;$i++ ){
			$grpData = explode("~!~", $splitGRPdata[$i]);
			$category = urldecode($grpData[0]);
			$program = urldecode($grpData[1]);
			$code = urldecode($grpData[2]);
			$total = urldecode($grpData[3]);
			
			$insertThis .= ",('" . $defaultYear . "','" . $office . "','" . $fund ."' ,'" . $trackType . "','" .  $prMonth . "','" .
				                       $trackingNumber . "','" . $category . "','" . $program . "','" .  $code  . "'," . $total . "," .  $oTotal . ",'" .  
						 	 $employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "'," . $chargeType . ",'" . $dateEncoded . "', " . $mode . ")";		
		}
		$insertGRPdetails =  substr($insertThis,1,strlen($insertThis));
		$case = "Insert into vouchercurrent(Year,Office,Fund,TrackingType,PR_Month,TrackingNumber,PR_CategoryCode,PR_ProgramCode,PR_AccountCode,Amount,TotalAmountMultiple,EncodedBy,DateEncoded,Status,ChargeType,DateModified,ModeOfProcurement)values " . $insertGRPdetails ; 
		//insert to current
		$affected = $database->UpdateInsertSpecial($case);
		$case = "Insert into voucherhistory(TrackingNumber,ModifiedBy,DateModified,Status)values ('" . $trackingNumber . "'," . $employeeNumber . ",'" . $dateEncoded . "','" . $status . "')"; 
		//insert to history
		$affected = $database->UpdateInsertSpecial($case);
		echo $newTrackingNumber . '~' . $trackingNumber;
	}
	if(isset($_POST['saveTrackingPostPO'])){
		
		$trackType = $database->charEncoder($_POST['trackType']);
		$prTrackingNumber = $database->charEncoder($_POST['prTrackingNumber']);
		$prNumber =  $database->charEncoder($_POST['prNumber']);
		$obrNumber =  $database->charEncoder($_POST['obrNumber']);
		$supplier = $database->charEncoder(urldecode($_POST['supplier']));
		$fund =  $database->charEncoder($_POST['fund']);
		$prMonth = $database->charEncoder($_POST['prMonth']);
		
		$prData =  $_POST['prData'];
		$grp =  $database->charEncoder($_POST['grp']);
		$oTotal =  $database->charEncoder($_POST['oTotal']);
		
		$status = 'Encoded';
		$claimType = "Check";
	    	$docType = "Payment";	
		$updateCase = "Doctrack = Doctrack + 1";
		
	    	
		//update id
		$case= "Update office set " . $updateCase .  "  where code = '" . $office . "'";
		$database->UpdateInsertSpecial($case);
		
		$case ="Select Doctrack from office where code = '" . $office . "' limit 1";
		$record = $database->FetchThis($case);
		$data = $database->fetch_array($record);
		$trackingNumber =  $office . '-' . $data['Doctrack'];
		$newTrackingNumber =  $office . '-' . ($data['Doctrack']+1); 
	
		$catX = 0;
		$cat = '';
		
		$progX = 0;
		$pro = '';
		
		$codeX = 0;
		$cod = '';
		
		$insertThis = '';
		$splitPRdata =  explode("~#~",$prData);
		for($i = 0; $i < sizeof($splitPRdata)-1;$i++ ){
			$prData = explode("~!~", $splitPRdata[$i]);
			$category = $prData[0];
			$program = $database->charEncoder(urldecode($prData[1]));
			$code = $database->charEncoder(urldecode($prData[2]));
			//$desc = $database->charEncoder(urldecode($prData[3]));
			$desc = $database->charEncoder($prData[3]);
			$qty = $prData[4];
			// $unit = urldecode($prData[5]);
			$unit = $database->charEncoder( urldecode($prData[5]) );
			$cost = $prData[6];
			$itemDes = $database->charEncoder(urldecode($prData[7]));
			$total = $qty * $cost;	
			// identify  charge type 1-5
			if($cat != $category){
				$catX++;
				$cat = $category;
			}
			if($pro != $program){
				$progX++;
				$pro = $program;
			}
			
			if($cod != $code){
				$codeX++;
				$cod = $code;
			}
			$insertThis .= ",('" . $trackingNumber . "','" . $category . "','" . $program . "','" . $code . "','" . $desc ."'," . $qty . ",'" . $unit . "','" . $cost . "','" . $total . "','" . $itemDes . "')";		
		}
		$chargeType = 0;
		if($catX == 1){
			if($progX == 1){
				if($codeX == 1){
					$chargeType = 1;
					$oTotal = 0;
				}else{
					$chargeType = 2;
				}
				
			}else if ($progX > 1){
				$chargeType = 3;
			}
		}else if ($catX == 2){
			$chargeType = 4;
		}
		$insertPRdetails =  substr($insertThis,1,strlen($insertThis));
		$case = "Insert into porecord(TrackingNumber,Category,ProgramCode,Code,Description,Qty,Unit,Amount,Total,Item)values " . $insertPRdetails ; 
		//insert to prrecord
		$affected = $database->UpdateInsertSpecial($case);







		$insertThis = '';
	
		//$fund = "GENERAL FUND";
		$splitGRPdata =  explode("~#~",$grp);
		for($i = 0; $i < sizeof($splitGRPdata)-1;$i++ ){
			$grpData = explode("~!~", $splitGRPdata[$i]);
			$category = urldecode($grpData[0]);
			$program = urldecode($grpData[1]);
			$code = urldecode($grpData[2]);
			$total = urldecode($grpData[3]);
			
			$insertThis .= ",('" . $defaultYear . "','" . $office . "','" . $fund ."' ,'" . $trackType . "','" .  $prMonth . "','" .
				                       $trackingNumber . "','" . $category . "','" . $program . "','" .  $code  . "'," . $total . "," .  $oTotal . ",'" .  
						 	  $employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "'," . $chargeType . ",'" . $dateEncoded . "','" . $docType  ."','" .$prNumber . "','" . $obrNumber . "','" . $prTrackingNumber . "','" . $supplier . "','" . $claimType . "')";		
	


		}
		$insertGRPdetails =  substr($insertThis,1,strlen($insertThis));
		$case = "Insert into vouchercurrent(Year,Office,Fund,TrackingType,PR_Month,TrackingNumber,
									PR_CategoryCode,PR_ProgramCode,PR_AccountCode,
									PO_Amount,TotalAmountMultiple,EncodedBy,
									DateEncoded,Status,ChargeType,DateModified,DocumentType,PR_Number,OBR_Number,PR_TrackingNumber,Claimant, ClaimType)
									values " . $insertGRPdetails ; 
		//insert to current
		$affected = $database->UpdateInsertSpecial($case);





		$sql = "Insert into particulars (trackingnumber)values ('" . $trackingNumber  . "')";
		$database->query($sql);
		
		$case = "Insert into voucherhistory(TrackingNumber,ModifiedBy,DateModified,Status)values ('" . $trackingNumber . "'," . $employeeNumber . ",'" . $dateEncoded . "','" . $status . "')"; 
		//insert to history
		$affected = $database->UpdateInsertSpecial($case);
		
		echo $newTrackingNumber . '~' . $trackingNumber;
		
	}
	if(isset($_POST['saveTrackingPost1'])){
		//---------------------------------PR
		$trackType = $database->charEncoder($_POST['trackType']);
		$status = "PR Encoded";
		
		
		$prMonth = $database->charEncoder($_POST['prMonth']);
		
		$itemCategory = $database->charEncoder($_POST['itemCategory']);
		$prProgramCode = $database->charEncoder($_POST['prProgramCode']);
		$prAccountCode = $database->charEncoder($_POST['prAccountCode']);
		$prTotal = $database->charEncoder($_POST['prTotal']);
		
		//$prHidden = $_GET['prArray'];
		
		//pagupdate sa new seq
		$updateCase = "PR = PR + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("PR",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = "PR-" . $office . '-' . $data['PR'];
		$newTrackingNumber = "PR-" . $office . '-' . ($data['PR']+1); 
		
		$totals = $database->charEncoder($_POST['prArrayTotals']);
		$programs = $database->charEncoder($_POST['prArrayFunds']);
		$prData = $database->charEncoder($_POST['prData']);
		
		$splitPrograms = explode("~",$programs);
		$splitTotals = explode("~",$totals);
		
		if(sizeof($splitPrograms) <= 2){
			$chargeType = 0;
			$database->SaveTrackingPR($defaultYear,$office,$trackType,$trackingNumber,$splitPrograms[0],$prAccountCode,$prTotal,$itemCategory,$prMonth,$employeeNumber,$dateEncoded,$status);
		
		}else{
			$chargeType = 3;
			$insertCase ='';
			$gTotal = 0;
			
			$claimant = '';
			$claimType = '';
			$transtype = '';
			$periodType = '';
			$periodValue = '';
			$fund = 'General Fund';
			for($i = 0; $i < sizeof($splitTotals)-1;$i++ ){
				
				$program = $splitPrograms[$i];
				$amount = $splitTotals[$i];
				
				$insertCase .= ",('" . $defaultYear . "','" . $office . "','" . $trackType . "','" . 
				                       $claimType . "','" . $claimant . "','" . $fund . "','" . 
									   $transtype . "','" .  $trackingNumber . "','" . $program . "','" . 
									   $prAccountCode . "'," .  $amount . ",'" . $periodType . "','" .  $periodValue . "','" .  
									   $employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "','" . 
									   $dateEncoded . "'," . $chargeType . "," . $prTotal . ",'" . $itemCategory . "','" . $prMonth  . "')";
			}
			$database->SaveTrackingPRMultiple(substr($insertCase,1,strlen($insertCase)));	
		}
		
		$insertThis = '';
		$splitPRdata = 	explode("balangueval",$prData);
		for($i = 0; $i < sizeof($splitPRdata)-1;$i++ ){
			$prData = explode("valbalangue", $splitPRdata[$i]);
			
			$program = $prData[0];
			$qty = $prData[1];
			$unit = $prData[2];
			$desc = urldecode($prData[3]);
			$cost = $prData[4];
			$totalCost = $prData[5];
			
			$insertThis .= ",('" . $trackingNumber . "','" . $qty . "','" . $unit . "','" . $desc . "'," . $cost ."," . $totalCost . ",'" . $program . "')";	
			
		}
		$database->InsertToPRrecord(substr($insertThis,1,strlen($insertThis)));
		
		
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);

		echo $newTrackingNumber . '~'. $trackingNumber;
	}
	
	if(isset($_GET['saveTrackingPO'])){
		
		$trackType = $database->charEncoder($_GET['trackType']);
		
		$prTrackingNumber = $database->charEncoder($_GET['prTrackingNumber']);
		
		$prMonth = $database->charEncoder($_GET['prMonth']);
		$itemCategory = $database->charEncoder($_GET['itemCategory']);
		$prProgramCode = $database->charEncoder($_GET['prProgramCode']);
		
		$prAccountCode = $database->charEncoder($_GET['prAccountCode']);
		
		$prNumber = $database->charEncoder($_GET['prPRnumber']);
		$obrNumber = $database->charEncoder($_GET['prOBRnumber']);
		$prFund = $database->charEncoder($_GET['prFund']);
		
		
		$supplier = $database->charEncoder($_GET['supplier']);
		$poData = $database->charEncoder($_GET['poData']);
		
		$poTotal = $database->charEncoder($_GET['poTotal']);
		$prTotals = $database->charEncoder($_GET['prTotals']);
		$poTotals = $database->charEncoder($_GET['poTotals']);
		$programs = $database->charEncoder($_GET['programs']);
		
		$chargeType = 0;
		$totalAmountMultiple  = 0;
		
		$status = "PO Encoded";
		$claimType = "Payments";
		
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 
		
		$a = explode("*",$poData);
		$insertThis = '';
		for($i = 0 ; $i < sizeof($a) - 1; $i++){
			$b = explode("~",$a[$i]);
			$program = $b[0];
			$qty = $b[1];
			$unit = urldecode($b[2]);
			$desc = urldecode($b[3]);
			$cost = $b[4];
			$tCost = $b[5];
			$insertThis .= ",('" . $trackingNumber . "'," . $qty . ",'" . $unit . "','" . $desc . "'," . $cost ."," . $tCost . ",'" . $program . "')";	
		}
		$database->InsertToPOrecord(substr($insertThis,1,strlen($insertThis)));
		
		
		
		$f = explode("~",$programs);
		$pr = explode("~",$prTotals);
		$po = explode("~",$poTotals);
		
		$size = sizeof($f);
		
		if(($size-1) > 1){
			$chargeType = 3;
			$totalAmountMultiple = $poTotal;
		}
		
		$insertThis1 = '';
		for($i = 0; $i < $size - 1; $i++){
			$program = $f[$i];
			$obrX = $pr[$i];
			$poX = $po[$i];
			
			$insertThis1 .= ",(" . $defaultYear . ",'" . $office . "','" . $trackType . "','" . $trackingNumber  . "',
				                 '" .  $supplier . "','" .  $prTrackingNumber . "','" . $program . "','" . $prAccountCode . "',
								 '" . $poX . "','" . $obrX . "',
								 '" . $itemCategory . "','" . $prMonth . "','" . $prNumber . "','" . $obrNumber . "',
								 '" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "',
								 '" . $dateEncoded . "',1," . $chargeType . "," . $totalAmountMultiple . ",'" . $prFund . "','" . $claimType . "')";
		}
		$database->SaveTrackingMultiplePO(substr($insertThis1,1,strlen($insertThis1)));
		
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~' . $trackingNumber ;
	}
	
	if(isset($_POST['saveTrackingPOPost'])){
		$trackType = $database->charEncoder($_POST['trackType']);
		
		$prTrackingNumber = $database->charEncoder($_POST['prTrackingNumber']);
		
		$prMonth = $database->charEncoder($_POST['prMonth']);
		$itemCategory = $database->charEncoder($_POST['itemCategory']);
		$prProgramCode = $database->charEncoder($_POST['prProgramCode']);
		
		$prAccountCode = $database->charEncoder($_POST['prAccountCode']);
		
		$prNumber = $database->charEncoder($_POST['prPRnumber']);
		$obrNumber = $database->charEncoder($_POST['prOBRnumber']);
		$prFund = $database->charEncoder($_POST['prFund']);
		
		
		$supplier = $database->charEncoder($_POST['supplier']);
		$poData = $database->charEncoder($_POST['poData']);
		$poTotal = $database->charEncoder($_POST['poTotal']);
		$prTotals = $database->charEncoder($_POST['prTotals']);
		$poTotals = $database->charEncoder($_POST['poTotals']);
		$programs = $database->charEncoder($_POST['programs']);
		
		$chargeType = 0;
		$totalAmountMultiple  = 0;
		
		$status = "PO Encoded";
		$claimType = "Payments";
		
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 
		
		$a = explode("balangueval",$poData);
		$insertThis = '';
		for($i = 0 ; $i < sizeof($a) - 1; $i++){
			$b = explode("valbalangue",$a[$i]);
			$program = $b[0];
			$qty = $b[1];
			$unit = urldecode($b[2]);
			$desc = urldecode($b[3]);
			$cost = $b[4];
			$tCost = $b[5];
			$insertThis .= ",('" . $trackingNumber . "'," . $qty . ",'" . $unit . "','" . $desc . "'," . $cost ."," . $tCost . ",'" . $program . "')";	
		}
		$database->InsertToPOrecord(substr($insertThis,1,strlen($insertThis)));
		
		
		
		$f = explode("~",$programs);
		$pr = explode("~",$prTotals);
		$po = explode("~",$poTotals);
		
		$size = sizeof($f);
		
		if(($size-1) > 1){
			$chargeType = 3;
			$totalAmountMultiple = $poTotal;
		}
		
		$insertThis1 = '';
		for($i = 0; $i < $size - 1; $i++){
			$program = $f[$i];
			$obrX = $pr[$i];
			$poX = $po[$i];
			
			$insertThis1 .= ",(" . $defaultYear . ",'" . $office . "','" . $trackType . "','" . $trackingNumber  . "',
				                 '" .  $supplier . "','" .  $prTrackingNumber . "','" . $program . "','" . $prAccountCode . "',
								 '" . $poX . "','" . $obrX . "',
								 '" . $itemCategory . "','" . $prMonth . "','" . $prNumber . "','" . $obrNumber . "',
								 '" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "',
								 '" . $dateEncoded . "',1," . $chargeType . "," . $totalAmountMultiple . ",'" . $prFund . "','" . $claimType . "','Voucher')";
		}
		$database->SaveTrackingMultiplePO(substr($insertThis1,1,strlen($insertThis1)));
		
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~' . $trackingNumber ;
	}
	if(isset($_GET['loadProgramPPMP'])){
		$record = $database->LoadProgramPPMP($defaultYear,$_SESSION['officeCode']);
		echo $sheet->CreateSelectProgramPPMP($record);
	}
	if(isset($_GET['loadProgramFundsByOffice'])){
		$record = $database->LoadProgramFundsByOffice($defaultYear,$_SESSION['officeCode']);
		echo $sheet->CreateSelectProgramFundsByOffice($record);
	}
	if(isset($_GET['saveTrackingPY'])){
		
		$chargeType = $database->charEncoder($_GET['chargeType']);
		$fund = $database->charEncoder($_GET['fund']);
		$subCode = $database->charEncoder($_GET['subCode']);
		$peorOfc = $database->charEncoder($_GET['peorOfc']);
		$docType = $database->charEncoder($_GET['docType']);
		
		$claimType = $database->charEncoder($_GET['claimType']);
		$amount = $database->charEncoder($_GET['amount']);
		$totalAmount = $database->charEncoder($_GET['totalAmount']);
		
		$grp = $database->charEncoder($_GET['group']);
		
		if($docType == "WAGES - SALARY J.O (1st half)"){
			$periodType = "4";
			//$docType = "WAGES - SALARY J.O";
		}else if($docType == "WAGES - SALARY J.O (2nd half)"){
			$periodType = "5";
			//$docType = "WAGES - SALARY J.O";
		}else{
			$periodType = "Monthly";
		}
		
		
		$periodValue = $database->charEncoder($_GET['period']);
		$trackType = "PY";
		$claimant = $database->charEncoder($_GET['claimant']);
		$status = "Encoded";
		
		
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 

		//pagsave sa record
		if($chargeType == 0){
			$net = 0.00;
			// if(substr($docType, 0, 5) != 'BILLS' && $docType != 'PAYMENT - EXTRAORDINARY EXPENSE' && $docType != 'PAYMENT - OTHER OPERATING EXPENSE' && $docType != 'PAYMENT - RENTAL' && $docType != 'REPLENISHMENT') {
			if(substr($docType, 0, 5) != 'BILLS' && $docType != 'PAYMENT - EXTRAORDINARY EXPENSE' && $docType != 'PAYMENT - OTHER OPERATING EXPENSE' && $docType != 'PAYMENT - RENTAL') { // 2023-07-14 - removed replenishment filter by request of CAO Janice.
				$net = $amount;
				if(floatval($totalAmount) > 0) {
					$net = $totalAmount;
				}
			}

			$insertCase = "Insert into vouchercurrent (Year,Office,TrackingNumber,TrackingType,Fund,DocumentType,ClaimType,Claimant,Amount,ChargeType,PeriodType,PeriodMonth,EncodedBy,DateEncoded,Status,DateModified,SubCode,PeaceOfficeId,NetAmount)VALUES 
						(" . $defaultYear . ",'" . $office . "','" . $trackingNumber . "','" . $trackType . "','" . $fund . "','" . $docType . "','" . $claimType . "','" . $claimant . "'," . $amount 
							. "," . $chargeType . ",'"  .   $periodType . "','" . $periodValue . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "'," . $subCode . "," . $peorOfc . ",'" . $net . "')";
			$database->UpdateInsertSpecial($insertCase);
			
		}else{
			$arr = explode('*',$grp);
			$size = sizeof($arr);
			
			$insertCaseA = "Insert into vouchercurrent (Year,Office,TrackingNumber,TrackingType,Fund,DocumentType,ClaimType,Claimant,PR_ProgramCode,PR_AccountCode,Amount,TotalAmountMultiple,ChargeType,PeriodType,PeriodMonth,EncodedBy,DateEncoded,Status,DateModified,SubCode,PeaceOfficeId,NetAmount)VALUES " ;
			$insertCaseB = '';
			for($i = 0; $i < $size-1; $i++){
				$data =  explode('~',$arr[$i]);
				
				$program = $data[0];
				$code = $data[1];
				$amount = $data[2];

				$net = 0.00;
				// if(substr($docType, 0, 5) != 'BILLS' && $docType != 'PAYMENT - EXTRAORDINARY EXPENSE' && $docType != 'PAYMENT - OTHER OPERATING EXPENSE' && $docType != 'PAYMENT - RENTAL' && $docType != 'REPLENISHMENT') {
				if(substr($docType, 0, 5) != 'BILLS' && $docType != 'PAYMENT - EXTRAORDINARY EXPENSE' && $docType != 'PAYMENT - OTHER OPERATING EXPENSE' && $docType != 'PAYMENT - RENTAL') { // 2023-07-14 - removed replenishment filter by request of CAO Janice.
					$net = $amount;
					if(floatval($totalAmount) > 0) {
						$net = $totalAmount;
					}
				}

				$insertCaseB .= ",(" . $defaultYear . ",'" . $office . "','" . $trackingNumber . "','" . $trackType . "','" . $fund . "','" .
								  $docType . "','" . $claimType . "','" . $claimant . "','" . $program . "','" . $code . "',"  . $amount . "," . 
								  $totalAmount .  "," . $chargeType . ",'" . $periodType . "','" . $periodValue . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "'," . $subCode . "," . $peorOfc . ",'" . $net . "')";
				
			}
			$insertCaseB = substr($insertCaseB,1,strlen($insertCaseB));
			$insertCase = $insertCaseA . $insertCaseB;
			$database->UpdateInsertSpecial($insertCase);
			
		}

		$sql = "Insert into particulars (trackingnumber)values ('" . $trackingNumber  . "')";
		$database->query($sql);
		
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~'. $trackingNumber;
		
	}
	if(isset($_GET['saveTrackingPY1'])){
		$chargeType = $database->charEncoder($_GET['chargeType']);
		
		$accountCode = $database->charEncoder($_GET['accountCode']);
		$amount = $database->charEncoder($_GET['amount']);
		$trackType = $database->charEncoder($_GET['trackType']);
		$fund = $database->charEncoder($_GET['fund']);
		$program = $database->charEncoder($_GET['program']);
		
		$transtype = $database->charEncoder($_GET['transType']);
		
		$periodType = $database->charEncoder($_GET['period']);
		$periodValue = $database->charEncoder($_GET['periodValue']);
		$claimType = $database->charEncoder($_GET['claimType']);
		$claimant = $database->charEncoder($_GET['claimant']);
		
		$status = "Encoded";
		
		
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 
		
		//pagsave sa record
		if($chargeType == 1){
			
			$database->SaveTrackingPY($defaultYear,$office,$trackType,$claimType,$claimant,$fund,$transtype,$trackingNumber,$program,$accountCode,$amount,$periodType,$periodValue,$employeeNumber,$dateEncoded,$status);
			
		}else if($chargeType == 2){
			
			
			
			$codes = explode('~', $accountCode);
			$amountValues = explode('~', $amount);
			
			$insertCase ='';
			$gTotal = 0;
			for($i = 0; $i < sizeof($codes)-1;$i++ ){
				$gTotal = array_sum($amountValues);
				
				
				$code  = $codes[$i];
				$amount = $amountValues[$i];
				
				$insertCase .= ",('" . $defaultYear . "','" . $office . "','" . $trackType . "','" . 
				                       $claimType . "','" . $claimant . "','" . $fund . "','" . 
									   $transtype . "','" .  $trackingNumber . "','" . $program . "','" . 
									   $code . "'," .  $amount . ",'" . $periodType . "','" .  $periodValue . "','" .  
									   $employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "','" . 
									   $dateEncoded . "'," . $chargeType . "," . $gTotal . ")";
			}
			
			$database->SaveTrackingPYMultiple(substr($insertCase,1,strlen($insertCase)));
		
		}else if($chargeType == 3){
			
			
			$programs = explode('~', $program);
			$codes = explode('~', $accountCode);
			$amountValues = explode('~', $amount);
			
			$insertCase ='';
			$gTotal = 0;
			for($i = 0; $i < sizeof($codes)-1;$i++ ){
				$gTotal = array_sum($amountValues);
				
				$program  = $programs[$i];
				$code  = $codes[$i];
				$amount = $amountValues[$i];
				
				$insertCase .= ",('" . $defaultYear . "','" . $office . "','" . $trackType . "','" . 
				                       $claimType . "','" . $claimant . "','" . $fund . "','" . 
									   $transtype . "','" .  $trackingNumber . "','" . $program . "','" . 
									   $code . "'," .  $amount . ",'" . $periodType . "','" .  $periodValue . "','" .  
									   $employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "','" . 
									   $dateEncoded . "'," . $chargeType . "," . $gTotal . ")";
			}
			
			$database->SaveTrackingPYMultiple(substr($insertCase,1,strlen($insertCase)));
		
		}
		
		
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		
		echo $newTrackingNumber . '~'. $trackingNumber;
		
	}
	if(isset($_GET['fetchAccountCodesPY'])){
		$programCode = $database->charEncoder($_GET['programCode']);
		//$record = $database->GetEncodedByProgramCode($defaultYear,$office,$programCode);
		if($office == "LUMP" || $office == "REMI"){
			$sql = "SELECT a.Id,Year, OfficeCode,ProgramCode,a.Amount,a.Fund,
				
				AccountCode as Code,Title
				FROM  
				funds  a left join fundtitles b on a.AccountCode = b.Code
				
				where
				a.ProgramCode = '" . $programCode . "' 
				
				group by a.AccountCode
				
				order by b.Title asc";
		}else{
			$sql = "SELECT a.Id,Year, OfficeCode,ProgramCode,a.Amount,a.Fund,
				
				AccountCode as Code,Title
				FROM  
				funds  a left join fundtitles b on a.AccountCode = b.Code
				
				where
				 a.OfficeCode = '" . $office . "' and a.ProgramCode = '" . $programCode . "' 
				OR
				 a.OfficeCode = 'LUMP' and a.ProgramCode = '" . $programCode . "' 
				order by b.Title asc";
		}
		
				
		$record = $database->query($sql);
		
				
		echo $sheet->CreateSelectAccountCodes($record);
		/*$count = $database->num_rows($record);
		if($count == 0){
			echo 0 . '~' . $programCode;
		}else{
			echo $sheet->CreateSelectAccountCodes($record);
		}*/
	}
	if(isset($_GET['fetchAccountCodesMultipleSource'])){
		$programCode = $database->charEncoder($_GET['programCode']);
		$record = $database->GetEncodedByProgramCode($defaultYear,$office,$programCode);
		$count = $database->num_rows($record);
		echo $sheet->CreateSelectAccountCodesMultiple($record);
	}
	
	//-------------------------------------------------------------------------------------------------------- update doctrack
	
	// if(isset($_GET['searchTrackingNumber'])){
	
	// 	$key = $database->charEncoder($_GET['trackingNumber']);
	// 	if($_SESSION['accountType'] == 1){
	// 		$condition1 = "where trackingnumber  = '" . $key . "' and Office = '"  .  $office .  "'";
	// 		$condition2 = "where claimant  like  '%" . $key . "%' and Office = '"  .  $office .  "'";	
	// 	}
	// 	if($_SESSION['accountType'] == 2  || $_SESSION['officeCode'] == '1081' ){
	// 		$condition1 = "where trackingnumber  = '" . $key . "'";
	// 		$condition2 = "where claimant  like  '%" . $key . "%'";
	// 	}
		
		
	// 	if(substr($key,4,1) == '-' || substr($key,0,3) == 'PR-'){
			
	// 		$sql = "SELECT * FROM vouchercurrent ".$condition1;
	// 		$record = $database->query($sql);
	// 		$numRows = $database->num_rows($record);

	// 		if ($numRows > 0) {
	// 			$grp = '';
	// 			$logOffice = $_SESSION['gso'];
	// 			$acct = $_SESSION['accountType'];
	// 			if($_SESSION['accountType'] >= 2){
	// 				$className = 'label19';
	// 			}else{
	// 				$className = 'hide';	
	// 			}

	// 			$newRecord = [];
	// 			$codes = [];
	// 			$prgCodes = '';
	// 			$accCodes = '';
	// 			$cnt = 0;
	// 			while($data = $database->fetch_array($record)) {
	// 				if($cnt == 0) {
	// 					$newRecord['TrackingNumber'] = $data['TrackingNumber'];
	// 					$newRecord['TrackingType'] = $data['TrackingType'];
	// 					$newRecord['Status'] = $data['Status'];
	// 					$newRecord['Year'] = $data['Year'];
	// 					$newRecord['Office'] = $data['Office'];
	// 					$newRecord['TrackingPartner'] = $data['TrackingPartner'];
	// 					$newRecord['PR_TrackingNumber'] = $data['PR_TrackingNumber'];
	// 					$newRecord['PR_Number'] = $data['PR_Number'];
	// 					$newRecord['PO_Number'] = $data['PO_Number'];
	// 					$newRecord['OBR_Number'] = $data['OBR_Number'];
	// 					$newRecord['PR_Month'] = $data['PR_Month'];
	// 					$newRecord['ControlNo'] = $data['ControlNo'];
	// 					$newRecord['PeriodType'] = $data['PeriodType'];

	// 					$netAmount = $data['NetAmount'];
	// 					if($data['PeriodType'] == 2){
	// 						$netAmount = $data['Amount'];
	// 					}
	// 					$newRecord['NetAmount'] = $netAmount;

	// 					$newRecord['PayeeNumber'] = $data['PayeeNumber'];
	// 					$newRecord['Fund'] = $data['Fund'];

	// 					$amount = $data['PO_Amount'];
	// 					$total = $data['TotalAmountMultiple'];
	// 					if($data['TrackingType'] == "PO"){
	// 						if($total > 0){
	// 							$poAmount = $total;
	// 						}else{
	// 							$poAmount = $amount;
	// 						}
	// 					}else{
	// 						$amount = $data['Amount'];
	// 						$poAmount = $amount;
	// 					}

	// 					$newRecord['TotalAmountMultiple'] = $total;
	// 					$newRecord['PO_Amount'] = $poAmount;
	// 					$newRecord['Amount'] = $amount;
	// 					$newRecord['Remarks'] = $data['Remarks'];
	// 					$newRecord['Claimant'] = $data['Claimant'];
	// 					$newRecord['ClaimType'] = $data['ClaimType'];
	// 					$newRecord['CheckNumber'] = $data['checknumber'];
	// 					$newRecord['CheckDate'] = $data['checkdate'];
	// 					$newRecord['DocumentType'] = $data['DocumentType'];

	// 					$adv =  $data['ADV1'];
	// 					$adv2 =  $data['ADV2'];
	// 					if($adv < 1  ){
	// 						$adv = '';
	// 						if($acct == '2' ){
	// 							if($newRecord['Status'] == "CBO Released"){
	// 								$adv = '';
	// 							}
								
	// 						}
	// 						if($acct == 4 ){
	// 							$adv = '';
	// 						}
	// 						if($acct == 5 ){
	// 							$adv = 99999;
	// 							if($newRecord['Status'] == "CBO Received" || $newRecord['Status'] == "Encoded"){
	// 									$adv = '0';
	// 							}
	// 						}
	// 						if($acct == 9 ){
	// 							if($newRecord['DocumentType'] == 'LTO COMPUTER FEE'){
	// 								$adv = $data['ADV2'] . 'a' ;
	// 							}
	// 						}	
	// 					}
	// 					$newRecord['ADV'] = $adv;

	// 					$newRecord['SubCode'] = $data['SubCode'];
	// 					$newRecord['PeaceOfficeId'] = $data['PeaceOfficeId'];
	// 					$newRecord['PeriodType'] = $data['PeriodType'];
	// 					$newRecord['PeriodMonth'] = $data['PeriodMonth'];
	// 					$newRecord['PR_CategoryCode'] = $data['PR_CategoryCode'];
	// 					$newRecord['ChargeType'] = $data['ChargeType'];
	// 					$newRecord['Complex'] = $data['Complex'];
	// 					$newRecord['DateEncoded'] = $data['DateEncoded'];
	// 					$newRecord['DateModified'] = $data['DateModified'];
	// 					$newRecord['Completion'] = $data['Completion'];
	// 					$newRecord['ModeOfProcurement'] = $data['ModeOfProcurement'];
	// 					$newRecord['BatchTracking'] = $data['BatchTracking'];
	// 					$newRecord['EmployeeNumber'] = $data['EncodedBy'];
	// 					$newRecord['CategoryName'] = '';
	// 					$newRecord['PR_ProgramCode'] = $data['PR_ProgramCode'];	
	// 					$newRecord['ConformDate'] = $data['ConformDate'];
	// 					$newRecord['NatureOfPayment'] = $data['NatureOfPayment'];	
	// 					$newRecord['PaymentTerm'] = $data['NatureOfPayment'];	

	// 					$newRecord['Specifics'] = $data['Specifics'];
	// 					if($newRecord['Specifics'] == 'Combi') {
	// 						$newRecord['Specifics'] = 'Agricultural products & other Goods/Items';
	// 					}	
	// 				}

	// 				$cnt++;

	// 				$prg = $data['PR_ProgramCode'];
	// 				$acc = $data['PR_AccountCode'];
	// 				$amount = $data['PO_Amount'];
	// 				$total = $data['TotalAmountMultiple'];
	// 				if($newRecord['TrackingType'] == "PO"){
	// 					if($total > 0){
	// 						$poAmount = $total;
	// 					}else{
	// 						$poAmount = $amount;
	// 					}
	// 				}else{
	// 					$amount = $data['Amount'];
	// 					$poAmount = $amount;
	// 				}

	// 				if($prg != "") {
	// 					$codes[$prg][$acc] = $prg . '~' . $acc . '~' . $amount . '~' . $total;
	// 					$prgCodes .= ",'".$prg."'";
	// 					$accCodes .= ",'".$acc."'";
	// 				}
	// 			}

	// 			unset($data);

	// 			$sql = "SELECT * FROM office WHERE Code = '".$newRecord['Office']."' LIMIT 1";
	// 			$record = $database->query($sql);
	// 			$data = $database->fetch_array($record);
	// 			$newRecord['OfficeName'] = $data['Name'];

	// 			unset($data);

	// 			$sql = "SELECT LastName, FirstName, MiddleName FROM citydoc.employees WHERE EmployeeNumber = '".$newRecord['EmployeeNumber']."' LIMIT 1";
	// 			$record = $database->query($sql);
	// 			$data = $database->fetch_array($record);
	// 			$newRecord['EncodedBy'] = utf8_encode($data['FirstName'] . ' ' . $data['MiddleName'] . ' ' . $data['LastName']);

	// 			unset($data);
	// 			$grp = '';

	// 			if($prgCodes != "") {
	// 				$prgNames = [];
	// 				$sql = "SELECT Code, Name FROM programcode WHERE Code IN (".substr($prgCodes, 1).")";
	// 				$record = $database->query($sql);
	// 				while($data = $database->fetch_array($record)) {
	// 					$code = $data['Code'];
	// 					$name = $data['Name'];

	// 					$prgNames[$code] = $name;
	// 				}

	// 				unset($data);

	// 				$accNames = [];
	// 				$sql = "SELECT Code, Title FROM fundtitles WHERE Code IN (".substr($accCodes, 1).")";
	// 				$record = $database->query($sql);
	// 				while($data = $database->fetch_array($record)) {
	// 					$code = $data['Code'];
	// 					$title = $data['Title'];

	// 					$accNames[$code] = $title;
	// 				}

	// 				unset($data);

	// 				foreach ($codes as $progCode => $waccCodes) {
	// 					foreach ($waccCodes as $accCode => $grpPart1) {
	// 						$prgName1 = '';
	// 						if(isset($prgNames[$progCode])) {
	// 							$prgName1 = $prgNames[$progCode];
	// 						}
	// 						$grp .= $grpPart1.'~'.$prgName1.'~'.$accNames[$accCode].'*';
	// 					}
	// 				}

	// 				unset($codes);
	// 				unset($prgNames);
	// 				unset($accNames);	
	// 			}

	// 			$newRecord['GRP'] = $grp;
				

	// 			if($newRecord['TrackingType'] == "PO"){
	// 				$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] . '~' . $newRecord['CategoryName'] . '~' . $newRecord['PR_TrackingNumber']);	
	// 				echo $sheet->CreateDoctrackInfoPR($newRecord);
				
	// 			}elseif($newRecord['TrackingType'] == "PX") {
	// 				$sql = "SELECT * FROM supplier.supplierinfo WHERE Name = \"". utf8_encode($newRecord['Claimant']) ."\" LIMIT 1";
	// 				$record = $database->query($sql);
	// 				$data = $database->fetch_array($record);
	// 				$newRecord['SuppClassification'] = $data['Classification'];
	// 				$newRecord['SuppType'] = $data['Type'];
	// 				$newRecord['SuppTIN'] = $data['TIN'];
	// 				$newRecord['SuppCode'] = $data['Code'];
		
	// 				if($newRecord['SuppType'] == 'NV') {
	// 					$newRecord['SuppType'] = "NON-VAT";
	// 				}else {
	// 					$newRecord['SuppType'] = "VAT";
	// 				}
		
	// 				$sql = "SELECT * FROM vouchercurrent WHERE TrackingNumber = '".$newRecord['TrackingPartner']."' LIMIT 1";
	// 				$record = $database->query($sql);
	// 				$data = $database->fetch_array($record);
	// 				$newRecord['PO_Nature'] = $data['NatureOfPayment'];
	// 				$newRecord['PO_Specifics'] = $data['Specifics'];
	// 				$newRecord['PO_ModeOfProc'] = $data['ModeOfProcurement'];
	// 				$newRecord['PO_PYTerm'] = $data['PaymentTerm'];

	// 				$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] . '~' . $newRecord['CategoryName'] . '~' . $newRecord['TrackingNumber']);
	// 				echo $sheet->NewCreateDoctrackInfoPX($newRecord);
				
	// 			}else{
	// 				$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] . '~' . $newRecord['CategoryName'] . '~' . $newRecord['TrackingNumber']);	
	// 				echo $sheet->CreateDoctrackInfoPR($newRecord);
				
	// 			}

	// 		}else {
	// 			echo "<div class = 'norecord' > No record found.</div>" . "*v*";
	// 		}

	// 	}else{
	// 		$sql = "SELECT 	Id, TrackingType, Status, Claimant, checknumber, DocumentType, PR_CategoryCode, ClaimType, Amount, PO_Amount, TotalAmountMultiple, 
	// 						TrackingNumber, OBR_Number, PO_Number, PR_Number, ADV1, ADV2, DateEncoded, DateModified, Completion, PeriodType, PeriodMonth, PR_Month, 
	// 						'' as Name, '' as Fund
	// 						FROM vouchercurrent " . $condition2 . " group by TrackingNumber order by id desc limit 40";		
	// 		$record = $database->query($sql);
	// 		$countMany = $database->num_rows($record);
	// 		if($countMany == 1){
	// 			$data = $database->fetch_array($record);
	// 			$trackingNumber = $data['TrackingNumber'];

	// 			if(strlen($trackingNumber) > 4) {
	// 				$sql = "SELECT * FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."'";
	// 				$record = $database->query($sql);
	
	// 				$grp = '';
	// 				$logOffice = $_SESSION['gso'];
	// 				$acct = $_SESSION['accountType'];
	// 				if($_SESSION['accountType'] >= 2){
	// 					$className = 'label19';
	// 				}else{
	// 					$className = 'hide';	
	// 				}
	
	// 				$newRecord = [];
	// 				$codes = [];
	// 				$prgCodes = '';
	// 				$accCodes = '';
	// 				$cnt = 0;
	// 				while($data = $database->fetch_array($record)) {
	// 					if($cnt == 0) {
	// 						$newRecord['TrackingNumber'] = $data['TrackingNumber'];
	// 						$newRecord['TrackingType'] = $data['TrackingType'];
	// 						$newRecord['Status'] = $data['Status'];
	// 						$newRecord['Year'] = $data['Year'];
	// 						$newRecord['Office'] = $data['Office'];
	// 						$newRecord['TrackingPartner'] = $data['TrackingPartner'];
	// 						$newRecord['PR_TrackingNumber'] = $data['PR_TrackingNumber'];
	// 						$newRecord['PR_Number'] = $data['PR_Number'];
	// 						$newRecord['PO_Number'] = $data['PO_Number'];
	// 						$newRecord['OBR_Number'] = $data['OBR_Number'];
	// 						$newRecord['PR_Month'] = $data['PR_Month'];
	// 						$newRecord['ControlNo'] = $data['ControlNo'];
	// 						$newRecord['PeriodType'] = $data['PeriodType'];
	
	// 						$netAmount = $data['NetAmount'];
	// 						if($data['PeriodType'] == 2){
	// 							$netAmount = $data['Amount'];
	// 						}
	// 						$newRecord['NetAmount'] = $netAmount;
	
	// 						$newRecord['PayeeNumber'] = $data['PayeeNumber'];
	// 						$newRecord['Fund'] = $data['Fund'];
	
	// 						$amount = $data['PO_Amount'];
	// 						$total = $data['TotalAmountMultiple'];
	// 						if($data['TrackingType'] == "PO"){
	// 							if($total > 0){
	// 								$poAmount = $total;
	// 							}else{
	// 								$poAmount = $amount;
	// 							}
	// 						}else{
	// 							$amount = $data['Amount'];
	// 							$poAmount = $amount;
	// 						}
	
	// 						$newRecord['TotalAmountMultiple'] = $total;
	// 						$newRecord['PO_Amount'] = $poAmount;
	// 						$newRecord['Amount'] = $amount;
	// 						$newRecord['Remarks'] = $data['Remarks'];
	// 						$newRecord['Claimant'] = $data['Claimant'];
	// 						$newRecord['ClaimType'] = $data['ClaimType'];
	// 						$newRecord['CheckNumber'] = $data['checknumber'];
	// 						$newRecord['CheckDate'] = $data['checkdate'];
	// 						$newRecord['DocumentType'] = $data['DocumentType'];
	
	// 						$adv =  $data['ADV1'];
	// 						$adv2 =  $data['ADV2'];
	// 						if($adv < 1  ){
	// 							$adv = '';
	// 							if($acct == '2' ){
	// 								if($newRecord['Status'] == "CBO Released"){
	// 									$adv = '';
	// 								}
									
	// 							}
	// 							if($acct == 4 ){
	// 								$adv = '';
	// 							}
	// 							if($acct == 5 ){
	// 								$adv = 99999;
	// 								if($newRecord['Status'] == "CBO Received" || $newRecord['Status'] == "Encoded"){
	// 										$adv = '0';
	// 								}
	// 							}
	// 							if($acct == 9 ){
	// 								if($newRecord['DocumentType'] == 'LTO COMPUTER FEE'){
	// 									$adv = $data['ADV2'] . 'a' ;
	// 								}
	// 							}	
	// 						}
	// 						$newRecord['ADV'] = $adv;
	
	// 						$newRecord['SubCode'] = $data['SubCode'];
	// 						$newRecord['PeaceOfficeId'] = $data['PeaceOfficeId'];
	// 						$newRecord['PeriodType'] = $data['PeriodType'];
	// 						$newRecord['PeriodMonth'] = $data['PeriodMonth'];
	// 						$newRecord['PR_CategoryCode'] = $data['PR_CategoryCode'];
	// 						$newRecord['ChargeType'] = $data['ChargeType'];
	// 						$newRecord['Complex'] = $data['Complex'];
	// 						$newRecord['DateEncoded'] = $data['DateEncoded'];
	// 						$newRecord['DateModified'] = $data['DateModified'];
	// 						$newRecord['Completion'] = $data['Completion'];
	// 						$newRecord['ModeOfProcurement'] = $data['ModeOfProcurement'];
	// 						$newRecord['BatchTracking'] = $data['BatchTracking'];
	// 						$newRecord['EmployeeNumber'] = $data['EncodedBy'];
	// 						$newRecord['CategoryName'] = '';
	// 						$newRecord['PR_ProgramCode'] = $data['PR_ProgramCode'];	
	// 						$newRecord['ConformDate'] = $data['ConformDate'];	
	// 						$newRecord['NatureOfPayment'] = $data['NatureOfPayment'];	

	// 						$newRecord['Specifics'] = $data['Specifics'];
	// 						if($newRecord['Specifics'] == 'Combi') {
	// 							$newRecord['Specifics'] = 'Agricultural products & other Goods/Items';
	// 						}	
							
	// 					}
	
	// 					$cnt++;
	
	// 					$prg = $data['PR_ProgramCode'];
	// 					$acc = $data['PR_AccountCode'];
	// 					$amount = $data['PO_Amount'];
	// 					$total = $data['TotalAmountMultiple'];
	// 					if($newRecord['TrackingType'] == "PO"){
	// 						if($total > 0){
	// 							$poAmount = $total;
	// 						}else{
	// 							$poAmount = $amount;
	// 						}
	// 					}else{
	// 						$amount = $data['Amount'];
	// 						$poAmount = $amount;
	// 					}
						
	// 					if($prg != "") {
	// 						$codes[$prg][$acc] = $prg . '~' . $acc . '~' . $amount . '~' . $total;
	// 						$prgCodes .= ",'".$prg."'";
	// 						$accCodes .= ",'".$acc."'";
	// 					}
	// 				}
	
	// 				unset($data);
	
	// 				$sql = "SELECT * FROM office WHERE Code = '".$newRecord['Office']."' LIMIT 1";
	// 				$record = $database->query($sql);
	// 				$data = $database->fetch_array($record);
	// 				$newRecord['OfficeName'] = $data['Name'];
	
	// 				unset($data);
	
	// 				$sql = "SELECT LastName, FirstName, MiddleName FROM citydoc.employees WHERE EmployeeNumber = '".$newRecord['EmployeeNumber']."' LIMIT 1";
	// 				$record = $database->query($sql);
	// 				$data = $database->fetch_array($record);
	// 				$newRecord['EncodedBy'] = utf8_encode($data['FirstName'] . ' ' . $data['MiddleName'] . ' ' . $data['LastName']);
	
	// 				unset($data);

	// 				$grp = '';
	// 				if($prgCodes != "") {
	// 					$prgNames = [];
	// 					$sql = "SELECT Code, Name FROM programcode WHERE Code IN (".substr($prgCodes, 1).")";
	// 					$record = $database->query($sql);
	// 					while($data = $database->fetch_array($record)) {
	// 						$code = $data['Code'];
	// 						$name = $data['Name'];
		
	// 						$prgNames[$code] = $name;
	// 					}
		
	// 					unset($data);
		
	// 					$accNames = [];
	// 					$sql = "SELECT Code, Title FROM fundtitles WHERE Code IN (".substr($accCodes, 1).")";
	// 					$record = $database->query($sql);
	// 					while($data = $database->fetch_array($record)) {
	// 						$code = $data['Code'];
	// 						$title = $data['Title'];
		
	// 						$accNames[$code] = $title;
	// 					}
		
	// 					unset($data);
		
	// 					foreach ($codes as $progCode => $waccCodes) {
	// 						foreach ($waccCodes as $accCode => $grpPart1) {
	// 							// $grp .= $grpPart1.'~'.$prgNames[$progCode].'~'.$accNames[$accCode].'*';
	// 							$prgName1 = '';
	// 							if(isset($prgNames[$progCode])) {
	// 								$prgName1 = $prgNames[$progCode];
	// 							}
	// 							$grp .= $grpPart1.'~'.$prgName1.'~'.$accNames[$accCode].'*';
	// 						}
	// 					}
	
	// 					unset($codes);
	// 					unset($prgNames);
	// 					unset($accNames);
	// 				}
	// 				$newRecord['GRP'] = $grp;
		

	// 				// if($newRecord['TrackingType'] == "PO"){
	// 				// 	$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] 
	// 				// 										. '~' . $newRecord['CategoryName'] . '~' . $newRecord['PR_TrackingNumber']);	
	// 				// }else{
	// 				// 	$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] 
	// 				// 										. '~' . $newRecord['CategoryName'] . '~' . $newRecord['TrackingNumber']);	
	// 				// }

	// 				if($newRecord['TrackingType'] == "PO"){
	// 					$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] . '~' . $newRecord['CategoryName'] . '~' . $newRecord['PR_TrackingNumber']);	
	// 					echo $sheet->CreateDoctrackInfoPR($newRecord);
					
	// 				}elseif($newRecord['TrackingType'] == "PX") {
	// 					$sql = "SELECT * FROM supplier.supplierinfo WHERE Name = \"". utf8_encode($newRecord['Claimant']) ."\" LIMIT 1";
	// 					$record = $database->query($sql);
	// 					$data = $database->fetch_array($record);
	// 					$newRecord['SuppClassification'] = $data['Classification'];
	// 					$newRecord['SuppType'] = $data['Type'];
	// 					$newRecord['SuppTIN'] = $data['TIN'];
	// 					$newRecord['SuppCode'] = $data['Code'];
			
	// 					if($newRecord['SuppType'] == 'NV') {
	// 						$newRecord['SuppType'] = "NON-VAT";
	// 					}else {
	// 						$newRecord['SuppType'] = "VAT";
	// 					}
			
	// 					$sql = "SELECT * FROM vouchercurrent WHERE TrackingNumber = '".$newRecord['TrackingPartner']."' LIMIT 1";
	// 					$record = $database->query($sql);
	// 					$data = $database->fetch_array($record);
	// 					$newRecord['PO_Nature'] = $data['NatureOfPayment'];
	// 					$newRecord['PO_Specifics'] = $data['Specifics'];
	// 					$newRecord['PO_ModeOfProc'] = $data['ModeOfProcurement'];
	// 					$newRecord['PO_PYTerm'] = $data['PaymentTerm'];
	
	// 					$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] . '~' . $newRecord['CategoryName'] . '~' . $newRecord['TrackingNumber']);
						
						
	// 					echo $sheet->NewCreateDoctrackInfoPX($newRecord);
					
	// 				}else{
	// 					$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] . '~' . $newRecord['CategoryName'] . '~' . $newRecord['TrackingNumber']);	
	// 					echo $sheet->CreateDoctrackInfoPR($newRecord);
					
	// 				}
					
	// 				echo $sheet->CreateDoctrackInfoPR($newRecord);
	// 			}else{
	// 				echo "<div class = 'norecord' > No record found.</div>" . "*v*";
	// 			}
				
	// 		}else if($countMany > 1){
	// 			$ctr =1;
	// 			$prime = 0;
	// 			$id = 1;
	// 			// echo $sheet->CreateListResultPrivate($record,0,0,$key,$countMany,$ctr,$id,$prime);	
	// 			$newRecord = [];
	// 			while ($data = $database->fetch_array($record)) {
	// 				$color = '';
	// 				$period = '';
	// 				$thisId  = $data['Id'];
	// 				// $office = $data['Name'];
	// 				$office = '';
	// 				$type = $data['TrackingType'];
	// 				$status = $data['Status'];
	// 				$claimant = strtoupper($data['Claimant']);
	// 				$check = $data['checknumber'];
					
	// 				$docType = $data['DocumentType'];
	// 				$doc = explode("-",$docType);
	// 				if(sizeof($doc) == 1 ){
	// 					$doc[1] = $docType;
	// 				}
	// 				$category = $data['PR_CategoryCode'];
	// 				if($type == 'PR'){
	// 					$docType = 'Purchase Request';
	// 					$doc[1] = $category;
	// 				}

	// 				$fund = $data['Fund'];
	// 				$claimType = $data['ClaimType'];
					
	// 				$amount  = $data['Amount'];
	// 				if($data['PO_Amount']> 0){
	// 					$amount = $data['PO_Amount'];
	// 				}
	// 				if($data['TotalAmountMultiple'] > 0){
	// 					$amount = $data['TotalAmountMultiple'];
	// 				}
					
					
	// 				$tn = $data['TrackingNumber'];
	// 				$obr = $data['OBR_Number'];
	// 				$po = $data['PO_Number'];
	// 				$pr = $data['PR_Number'];
	// 				$adv = $data['ADV1'];
	// 				if($adv == 0){
	// 					$adv = $data['ADV2'];
	// 					if($adv == 0){
	// 						$adv = '';
	// 						}
	// 				}
					
					
	// 				$dateEncoded = $data['DateEncoded'];
	// 				$dateModified = $data['DateModified'];
	// 				$completion = $data['Completion'];
	// 				$periodType = $data['PeriodType']; 
	// 				$periodMonth= $data['PeriodMonth'];
	// 				$encodedBy = '';
	// 				if($type == 'PY'){
						
	// 					if($periodType == 1){
	// 						$period =  '(1 -15)';
	// 					}else if ($periodType == 2){
	// 						if(strtoupper($periodMonth) == "FEBRUARY"){
	// 							$period =  ' (16 - 28)';
	// 						}else{
	// 							$period =  ' (16 - 31)';
	// 						}
	// 					}else if($periodType == 4){
	// 						$period =  '(1 -15)';
	// 					}else if ($periodType == 5){
	// 						if(strtoupper($periodMonth) == "FEBRUARY"){
	// 							$period =  ' (16 - 28)';
	// 						}else{
	// 							$period =  ' (16 - 31)';
	// 						}
	// 					}else{
	// 						$period = "";
	// 					}
	// 				}else {
	// 					$period =  $database->numberToQuarter($data['PR_Month']);
	// 					$period  =  "";
	// 				}

	// 				$newRecord[$tn]['Id'] = $thisId;
	// 				$newRecord[$tn]['OfficeName'] = $office;
	// 				$newRecord[$tn]['TrackingType'] = $type;
	// 				$newRecord[$tn]['Status'] = $status;
	// 				$newRecord[$tn]['Claimant'] = $claimant;
	// 				$newRecord[$tn]['checknumber'] = $check;
	// 				$newRecord[$tn]['DocumentType'] = $doc[1];
	// 				$newRecord[$tn]['Fund'] = $fund;
	// 				$newRecord[$tn]['ClaimType'] = $claimType;
	// 				$newRecord[$tn]['Amount'] = $amount;
	// 				$newRecord[$tn]['TrackingNumber'] = $tn;
	// 				$newRecord[$tn]['OBR_Number'] = $obr;
	// 				$newRecord[$tn]['PO_Number'] = $po;
	// 				$newRecord[$tn]['PR_Number'] = $pr;
	// 				$newRecord[$tn]['ADV'] = $adv;
	// 				$newRecord[$tn]['DateEncoded'] = $dateEncoded;
	// 				$newRecord[$tn]['DateModified'] = $dateModified;
	// 				$newRecord[$tn]['Completion'] = $completion;
	// 				$newRecord[$tn]['EncodedBy'] = $encodedBy;
	// 				$newRecord[$tn]['Period'] = $period;
	// 				$newRecord[$tn]['PeriodMonth'] = $periodMonth;
	// 			}
				
	// 			echo $sheet->CreateListResultPrivate2022($newRecord,0,$countMany,$ctr,$id,$prime);
	// 		}else{
	// 			echo "<div class = 'norecord' > No record found.</div>" . "*v*";
	// 		}
	// 	}
	// }

	if(isset($_GET['searchTrackingNumber'])) {
		$key = $database->charEncoder($_GET['trackingNumber']);

		if($_SESSION['accountType'] == 1){
			$condition1 = "where trackingnumber  = '" . $key . "' and Office = '"  .  $office .  "'";
			$condition2 = "where claimant  like  '%" . $key . "%' and Office = '"  .  $office .  "'";	
		}
		if($_SESSION['accountType'] == 2  || $_SESSION['officeCode'] == '1081' ){
			$condition1 = "where trackingnumber  = '" . $key . "'";
			$condition2 = "where claimant  like  '%" . $key . "%'";
		}


		if(substr($key,4,1) == '-' || substr($key,0,3) == 'PR-'){
			$newRecord = $database->searchTrackingNumber2022($key);

			if(sizeof($newRecord) > 0) {

				if($newRecord['TrackingType'] == "PO"){
					echo $sheet->NewCreateDoctrackInfoPO($newRecord);
					// echo $sheet->CreateDoctrackInfoPR($newRecord);
				}elseif($newRecord['TrackingType'] == "PX") {
					echo $sheet->NewCreateDoctrackInfoPX($newRecord);
				}else{
					echo $sheet->CreateDoctrackInfoPR($newRecord);
				}

			}else {
				echo "<div class = 'norecord' > No record found.</div>" . "*v*";
			}

		}else{
			$sql = "SELECT 	Id, TrackingType, Status, Claimant, checknumber, DocumentType, PR_CategoryCode, ClaimType, Amount, PO_Amount, TotalAmountMultiple, 
			TrackingNumber, OBR_Number, PO_Number, PR_Number, ADV1, ADV2, DateEncoded, DateModified, Completion, PeriodType, PeriodMonth, PR_Month, 
			'' as Name, '' as Fund
			FROM vouchercurrent " . $condition2 . " group by TrackingNumber order by id desc limit 40";		
			$record = $database->query($sql);
			$countMany = $database->num_rows($record);

			if($countMany == 1){
				$data = $database->fetch_array($record);
				$trackingNumber = $data['TrackingNumber'];
   
				if(strlen($trackingNumber) > 4) {
					$newRecord = $database->searchTrackingNumber2022($trackingNumber);

					if(sizeof($newRecord) > 0) {

						if($newRecord['TrackingType'] == "PO"){
							echo $sheet->NewCreateDoctrackInfoPO($newRecord);
						}elseif($newRecord['TrackingType'] == "PX") {
							echo $sheet->NewCreateDoctrackInfoPX($newRecord);
						}else{
							echo $sheet->CreateDoctrackInfoPR($newRecord);
						}
		
					}else {
						echo "<div class = 'norecord' > No record found.</div>" . "*v*";
					}

				}
			}else if($countMany > 1){
				$ctr =1;
				$prime = 0;
				$id = 1;
				// echo $sheet->CreateListResultPrivate($record,0,0,$key,$countMany,$ctr,$id,$prime);	
				$newRecord = [];
				while ($data = $database->fetch_array($record)) {
					$color = '';
					$period = '';
					$thisId  = $data['Id'];
					$office = $data['Name'];
					$office = '';
					$type = $data['TrackingType'];
					$status = $data['Status'];
					$claimant = strtoupper($data['Claimant']);
					$check = $data['checknumber'];
						
					$docType = $data['DocumentType'];
					$doc = explode("-",$docType);
					if(sizeof($doc) == 1 ){
						$doc[1] = $docType;
					}
					$category = $data['PR_CategoryCode'];
					if($type == 'PR'){
						$docType = 'Purchase Request';
						$doc[1] = $category;
					}

					$fund = $data['Fund'];
					$claimType = $data['ClaimType'];
						
					$amount  = $data['Amount'];
					if($data['PO_Amount']> 0){
						$amount = $data['PO_Amount'];
					}
					if($data['TotalAmountMultiple'] > 0){
						$amount = $data['TotalAmountMultiple'];
					}
						
						
					$tn = $data['TrackingNumber'];
					$obr = $data['OBR_Number'];
					$po = $data['PO_Number'];
					$pr = $data['PR_Number'];
					$adv = $data['ADV1'];
					if($adv == 0){
						$adv = $data['ADV2'];
						if($adv == 0){
							$adv = '';
							}
					}
						
						
					$dateEncoded = $data['DateEncoded'];
					$dateModified = $data['DateModified'];
					$completion = $data['Completion'];
					$periodType = $data['PeriodType']; 
					$periodMonth= $data['PeriodMonth'];
					$encodedBy = '';
					if($type == 'PY'){
							
						if($periodType == 1){
							$period =  '(1 -15)';
						}else if ($periodType == 2){
							if(strtoupper($periodMonth) == "FEBRUARY"){
								$period =  ' (16 - 28)';
							}else{
								$period =  ' (16 - 31)';
							}
						}else if($periodType == 4){
							$period =  '(1 -15)';
						}else if ($periodType == 5){
							if(strtoupper($periodMonth) == "FEBRUARY"){
								$period =  ' (16 - 28)';
							}else{
								$period =  ' (16 - 31)';
							}
						}else{
							$period = "";
						}
					}else {
						$period =  $database->numberToQuarter($data['PR_Month']);
						$period  =  "";
					}

					$newRecord[$tn]['Id'] = $thisId;
					$newRecord[$tn]['OfficeName'] = $office;
					$newRecord[$tn]['TrackingType'] = $type;
					$newRecord[$tn]['Status'] = $status;
					$newRecord[$tn]['Claimant'] = $claimant;
					$newRecord[$tn]['checknumber'] = $check;
					$newRecord[$tn]['DocumentType'] = $doc[1];
					$newRecord[$tn]['Fund'] = $fund;
					$newRecord[$tn]['ClaimType'] = $claimType;
					$newRecord[$tn]['Amount'] = $amount;
					$newRecord[$tn]['TrackingNumber'] = $tn;
					$newRecord[$tn]['OBR_Number'] = $obr;
					$newRecord[$tn]['PO_Number'] = $po;
					$newRecord[$tn]['PR_Number'] = $pr;
					$newRecord[$tn]['ADV'] = $adv;
					$newRecord[$tn]['DateEncoded'] = $dateEncoded;
					$newRecord[$tn]['DateModified'] = $dateModified;
					$newRecord[$tn]['Completion'] = $completion;
					$newRecord[$tn]['EncodedBy'] = $encodedBy;
					$newRecord[$tn]['Period'] = $period;
					$newRecord[$tn]['PeriodMonth'] = $periodMonth;
				}
					
				echo $sheet->CreateListResultPrivate2022($newRecord,0,$countMany,$ctr,$id,$prime);
			}else{
				echo "<div class = 'norecord' > No record found.</div>" . "*v*";
			}
		}
	}

	if(isset($_GET['cancelTrackingNumber'])){
		$tn = $database->charEncoder($_GET['trackingNumber']);	
		$remark =  $database->charEncoder($_GET['remark']);
		
		$office = $_SESSION['cbo'];
		$accountType = $_SESSION['accountType'];
		$employeeNumber = $_SESSION['employeeNumber'];
		$fullName = $_SESSION['fullName'];
		$perm = $_SESSION['perm'];
		
		if($office == '1081' and $accountType == '7'  or $office == '1071' and $accountType == '2'  or $perm == 36 or $employeeNumber == '210468' ){
			$sql = "select id, TrackingPartner, DocumentType from vouchercurrent where trackingnumber = '" . $tn . "' limit 1";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			if($count > 0){
				$data = $database->fetch_array($record);
				$docType = $data['DocumentType'];
				$tnPartner = $data['TrackingPartner'];

				$lnote = "";
				if($docType == "Liquidation"){
					$sql = "UPDATE vouchercurrent SET TrackingPartner = null, Remarks = CONCAT('Previous Liquidation TN : " . $tn . "<br/>',if (Remarks is null,'',Remarks)) WHERE TrackingNumber = '".$tnPartner."'";
					$database->query($sql);
				}
				if($docType == "CASH ADVANCE TO PAYMASTER"){
					$sql = "UPDATE vouchercurrent SET TrackingPartner = null, Remarks = CONCAT('Previous Paymaster TN : " . $tn . "<br/>',if (Remarks is null,'',Remarks)) WHERE TrackingPartner = '".$tn."'";
					$database->query($sql);
				}
				$r = '<font = "silver">Cancel Note : </font>';
				$sql = "update vouchercurrent set Status = 'Cancelled', Remarks = CONCAT('Cancel Note : " . $remark . "<br/>',if (Remarks is null,'',Remarks)), DateModified = '" . $dateEncoded . "'  where trackingnumber = '" .  $tn . "'";
				$database->query($sql);
				$database->EditLogs($tn,'Status','Cancelled','',$office,$fullName ,$dateEncoded);	
				
				$database->InsertToVoucherHistory($tn,$employeeNumber,$dateEncoded,'Cancelled',''); 
				
				// $sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.Description as  CategoryName
				// 					FROM vouchercurrent a 
				// 					left join office b on a.office = b.code  
				// 					left join citydoc.employees c on a.encodedby = c.employeenumber
				// 					left join programcode d on a.PR_ProgramCode = d.code
				// 					left join fundtitles e on a.PR_AccountCode = e.Code
				// 					left join ppmpcategories f on a.PR_CategoryCode = f.Code where trackingnumber  = '" . $tn . "' order by pr_programcode,pr_accountcode";						
										
				// $record =  $database->query($sql);
				$sql = "SELECT * FROM vouchercurrent WHERE TrackingNumber = '".$tn."'";
				$record = $database->query($sql);

				$grp = '';
				$logOffice = $_SESSION['gso'];
				$acct = $_SESSION['accountType'];
				if($_SESSION['accountType'] >= 2){
					$className = 'label19';
				}else{
					$className = 'hide';	
				}

				$newRecord = [];
				$codes = [];
				$prgCodes = '';
				$accCodes = '';
				$cnt = 0;
				while($data = $database->fetch_array($record)) {
					if($cnt == 0) {
						$newRecord['TrackingNumber'] = $data['TrackingNumber'];
						$newRecord['TrackingType'] = $data['TrackingType'];
						$newRecord['Status'] = $data['Status'];
						$newRecord['Year'] = $data['Year'];
						$newRecord['Office'] = $data['Office'];
						$newRecord['TrackingPartner'] = $data['TrackingPartner'];
						$newRecord['PR_TrackingNumber'] = $data['PR_TrackingNumber'];
						$newRecord['PR_Number'] = $data['PR_Number'];
						$newRecord['PO_Number'] = $data['PO_Number'];
						$newRecord['OBR_Number'] = $data['OBR_Number'];
						$newRecord['PR_Month'] = $data['PR_Month'];
						$newRecord['ControlNo'] = $data['ControlNo'];
						$newRecord['PeriodType'] = $data['PeriodType'];

						$netAmount = $data['NetAmount'];
						if($data['PeriodType'] == 2){
							$netAmount = $data['Amount'];
						}
						$newRecord['NetAmount'] = $netAmount;

						$newRecord['PayeeNumber'] = $data['PayeeNumber'];
						$newRecord['Fund'] = $data['Fund'];

						$amount = $data['PO_Amount'];
						$total = $data['TotalAmountMultiple'];
						if($data['TrackingType'] == "PO"){
							if($total > 0){
								$poAmount = $total;
							}else{
								$poAmount = $amount;
							}
						}else{
							$amount = $data['Amount'];
							$poAmount = $amount;
						}

						$newRecord['TotalAmountMultiple'] = $total;
						$newRecord['PO_Amount'] = $poAmount;
						$newRecord['Amount'] = $amount;
						$newRecord['Remarks'] = $data['Remarks'];
						$newRecord['Claimant'] = $data['Claimant'];
						$newRecord['ClaimType'] = $data['ClaimType'];
						$newRecord['CheckNumber'] = $data['checknumber'];
						$newRecord['CheckDate'] = $data['checkdate'];
						$newRecord['DocumentType'] = $data['DocumentType'];

						$adv =  $data['ADV1'];
						$adv2 =  $data['ADV2'];
						if($adv < 1  ){
							$adv = '';
							if($acct == '2' ){
								if($status == "CBO Released"){
									$adv = '';
								}
								
							}
							if($acct == 4 ){
								$adv = '';
							}
							if($acct == 5 ){
								$adv = 99999;
								if($status == "CBO Received" || $status == "Encoded"){
										$adv = '0';
								}
							}
							if($acct == 9 ){
								if($docType == 'LTO COMPUTER FEE'){
									$adv = $data['ADV2'] . 'a' ;
								}
							}	
						}
						$newRecord['ADV'] = $adv;

						$newRecord['SubCode'] = $data['SubCode'];
						$newRecord['PeaceOfficeId'] = $data['PeaceOfficeId'];
						$newRecord['PeriodType'] = $data['PeriodType'];
						$newRecord['PeriodMonth'] = $data['PeriodMonth'];
						$newRecord['PR_CategoryCode'] = $data['PR_CategoryCode'];
						$newRecord['ChargeType'] = $data['ChargeType'];
						$newRecord['Complex'] = $data['Complex'];
						$newRecord['DateEncoded'] = $data['DateEncoded'];
						$newRecord['DateModified'] = $data['DateModified'];
						$newRecord['Completion'] = $data['Completion'];
						$newRecord['ModeOfProcurement'] = $data['ModeOfProcurement'];
						$newRecord['BatchTracking'] = $data['BatchTracking'];
						$newRecord['EmployeeNumber'] = $data['EncodedBy'];
						$newRecord['CategoryName'] = '';
						$newRecord['PR_ProgramCode'] = $data['PR_ProgramCode'];	
						$newRecord['ConformDate'] = $data['ConformDate'];	
						$newRecord['NatureOfPayment'] = $data['NatureOfPayment'];	

						$newRecord['Specifics'] = $data['Specifics'];
						if($newRecord['Specifics'] == 'Combi') {
							$newRecord['Specifics'] = 'Agricultural products & other Goods/Items';
						}	
					}

					$cnt++;

					$prg = $data['PR_ProgramCode'];
					$acc = $data['PR_AccountCode'];
					$amount = $data['PO_Amount'];
					$total = $data['TotalAmountMultiple'];
					if($newRecord['TrackingType'] == "PO"){
						if($total > 0){
							$poAmount = $total;
						}else{
							$poAmount = $amount;
						}
					}else{
						$amount = $data['Amount'];
						$poAmount = $amount;
					}
					
					if($prg != "") {
						$codes[$prg][$acc] = $prg . '~' . $acc . '~' . $amount . '~' . $total;
						$prgCodes .= ",'".$prg."'";
						$accCodes .= ",'".$acc."'";
					}
				}

				unset($data);

				$sql = "SELECT * FROM office WHERE Code = '".$newRecord['Office']."' LIMIT 1";
				$record = $database->query($sql);
				$data = $database->fetch_array($record);
				$newRecord['OfficeName'] = $data['Name'];

				unset($data);

				$sql = "SELECT LastName, FirstName, MiddleName FROM citydoc.employees WHERE EmployeeNumber = '".$newRecord['EmployeeNumber']."' LIMIT 1";
				$record = $database->query($sql);
				$data = $database->fetch_array($record);
				$newRecord['EncodedBy'] = utf8_encode($data['FirstName'] . ' ' . $data['MiddleName'] . ' ' . $data['LastName']);

				unset($data);

				$grp = '';
				if($prgCodes != "") {
					$prgNames = [];
					$sql = "SELECT Code, Name FROM programcode WHERE Code IN (".substr($prgCodes, 1).")";
					$record = $database->query($sql);
					while($data = $database->fetch_array($record)) {
						$code = $data['Code'];
						$name = $data['Name'];
	
						$prgNames[$code] = $name;
					}
	
					unset($data);
	
					$accNames = [];
					$sql = "SELECT Code, Title FROM fundtitles WHERE Code IN (".substr($accCodes, 1).")";
					$record = $database->query($sql);
					while($data = $database->fetch_array($record)) {
						$code = $data['Code'];
						$title = $data['Title'];
	
						$accNames[$code] = $title;
					}
	
					unset($data);
	
					foreach ($codes as $progCode => $waccCodes) {
						foreach ($waccCodes as $accCode => $grpPart1) {
							$grp .= $grpPart1.'~'.$prgNames[$progCode].'~'.$accNames[$accCode].'*';
						}
					}

					unset($codes);
					unset($prgNames);
					unset($accNames);
				}
				$newRecord['GRP'] = $grp;
	

				if($newRecord['TrackingType'] == "PO"){
					$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] 
														. '~' . $newRecord['CategoryName'] . '~' . $newRecord['PR_TrackingNumber']);	
				}else{
					$newRecord['PR_Data'] = urlencode($newRecord['Year'] . '~' . $newRecord['Office'] . '~' . $newRecord['OfficeName'] . '~' . $newRecord['PR_CategoryCode'] .'~' . $newRecord['PR_Month'] 
														. '~' . $newRecord['CategoryName'] . '~' . $newRecord['TrackingNumber']);	
				}

				echo $sheet->CreateDoctrackInfoPR($newRecord);

			}else{
				echo "<div class = 'norecord'>No record found.</div>*v*";
			}				
		}else{
			echo "<div class = 'norecord'>You are not allowed to cancel transaction. Refer to budget office.</div>*v*";
		}
		
			
	}
	if(isset($_GET['searchTrackingNumberPartner'])){
		// $key = $database->charEncoder($_GET['trackingNumber']);	
		// $condition1 = "where trackingnumber  = '" . $key . "'";
		
		// $sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.Description as  CategoryName
		// 						FROM vouchercurrent a 
		// 						left join office b on a.office = b.code  
		// 						left join citydoc.employees c on a.encodedby = c.employeenumber
		// 						left join programcode d on a.PR_ProgramCode = d.code
		// 						left join fundtitles e on a.PR_AccountCode = e.Code
		// 						left join ppmpcategories f on a.PR_CategoryCode = f.Code " . $condition1 .  " order by pr_programcode,pr_accountcode";
								
		// $record = $database->query($sql);
		// echo $sheet->CreateDoctrackInfoPR($record);

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);	
		
		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$newRecord = $database->searchTrackingNumber2022($trackingNumber);

		if(sizeof($newRecord) > 0) {

			if($newRecord['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($newRecord);
				echo $sheet->NewCreateDoctrackInfoPO($newRecord);
			}elseif($newRecord['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($newRecord);
			}else{
				echo $sheet->CreateDoctrackInfoPR($newRecord);
			}

		}else {
			echo "<div class = 'norecord' > No record found.</div>" . "*v*";
		}
	}






// -----------------------  Inventory - Search Tracker

/*

	if(isset($_GET['searchPOARNumber'])) { 								
			$key = $database->charEncoder($_GET['POARNumber']);
			
			if($_SESSION['accountType'] == 1){
				$condition 	= " where a.TrackingNumber = '" . $key . "' or a.PO_Number  = '" . $key . "' and a.Office = '"  .  $office .  "'";
				$ARNumber 	= " where ARNumber = '".$key."'";
				$condition2 = " where g.ARNUMBER = '".$key."'";

			} else if ($_SESSION['accountType'] == 2 || $_SESSION['officeCode'] == '1081') {
				$condition 	= " where a.PO_Number  = '" . $key . "' or a.TrackingNumber = '" . $key . "'";
				$ARNumber 	= " where ARNumber = '".$key."'";
				$condition2 = " where g.ARNUMBER = '".$key."'";
			}

			$queryString1 = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,g.ARNumber,f.Description as  CategoryName
							FROM vouchercurrent a 
							left join office b on a.office = b.code  
							left join citydoc.employees c on a.encodedby = c.employeenumber
							left join programcode d on a.PR_ProgramCode = d.code
							left join fundtitles e on a.PR_AccountCode = e.Code
							left join ppmpcategories f on a.PR_CategoryCode = f.Code
							left join amis.invoicerecord g on a.PO_Number = g.PO_Number";
			$queryString2 = "order by a.pr_programcode,a.pr_accountcode";					

			$sql = $queryString1 . $condition . $queryString2;
			$record = $database->query($sql);
			$countRow = $database->num_rows($record);
			if($countRow  >= 1) {
				echo $sheet->CreateAIRTrackerInfo($record);
			} else {

				$queryThis = "SELECT ARNumber from amis.invoicerecord " . $ARNumber;
				$record1 = $database->query($queryThis);
				$countRow1 = $database->num_rows($record1);
				if($countRow1  >= 1) {

					$sql2 = $queryString1 . $condition2 . $queryString2;	
					$record2 = $database->query($sql2);
					echo $sheet->CreateAIRTrackerInfo($record2);

				} else {
					echo "<div class = 'norecord' > No record found.</div>" . "*v*";
				}
			}
	}






	if(isset($_GET['viewHistoryPOAR'])) { // Inventory - Voucher History
		$POARNumber = $database->charEncoder($_GET['POARNumber']);
		$sql = "Select * from voucherhistory where trackingnumber = '" . $POARNumber . "'";
		$record = $database->SelectQuery($sql);
		echo $sheet->CreateHistory($record);
	}

*/
	if(isset($_GET['updateTrackingStatusInfra'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
	
		$inputNumber = $database->charEncoder($_GET['inputNumber']);
		$curStatus = $database->charEncoder($_GET['status']);
		$trackingAmount = $database->charEncoder($_GET['trackingAmount']);
		$trackType = $database->charEncoder($_GET['trackType']);
		$dateTrackingEncoded = $database->charEncoder($_GET['dateEncoded']);
		$dateTrackingModified = $database->charEncoder($_GET['dateModified']);
		$btnTxt = $database->charEncoder($_GET['btnTxt']); // 01-20-2022 Added para "For Adjustment", "For Pick-up"
		$fund = $database->charEncoder($_GET['fund']);
		$batchNumber = $database->charEncoder($_GET['batchNumber']);
		
		
		$trackingNumberInsertCase = '';
		$trackingNumberUpdateCase = '';
		if(strlen($batchNumber) >= 8){
			$sql = "Select TrackingNumber from infra where BatchNumber = '" . $batchNumber . "'";
			$record = $database->query($sql);
			
			$count = $database->num_rows($record);
			
			if($count > 1){
				
				while($data = $database->fetch_array($record)){
					$trackingNumberUpdateCase .= ",'" . $data['TrackingNumber'] . "'";
					$trackingNumberInsertCase .= "," . $data['TrackingNumber'];
				}
				$trackingNumberUpdateCase = substr($trackingNumberUpdateCase,1);
			}else{
				$trackingNumberUpdateCase = "'" . $trackingNumber . "'";
				$trackingNumberInsertCase = "," . $trackingNumber;
			}
			
		}else{
			$trackingNumberUpdateCase = "'" . $trackingNumber . "'";
			$trackingNumberInsertCase = "," . $trackingNumber;
		}
		$skipSearch = 0;
		
		
		
		/*if($curStatus == "Project Encoded"){
			
			$sql = "select * from citydoc.signatories where role = 'Infra Requestor' limit 1";	
			$record = $database->query($sql);
			
			$data = $database->fetch_array($record);
			$name = $data['Name'];
			
			$title = $data['Title'];
			$prefix = '';
			if(strlen($data['Prefix']) > 0  ){
				$prefix =  $data['Prefix'] . ' ';
			}
			$suffix = '';
			if(strlen($data['Suffix']) > 0  ){
				$suffix =  ', ' . $data['Suffix'];
			}
			$name = $prefix  . $name . $suffix;
			$sql = "UPDATE infra SET Requestor = '".$name."', RequestorTitle = '".$title."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$status = 'Requesting for Fund Certification';
			
			$completion = '';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			$database->sendererByStatusAndFund($trackingNumber); // notify controller only
		}
		if($curStatus == "Requesting for Fund Certification"){
			$completion = '';
			$status = 'Acknowledge Certification Request';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Acknowledge Certification Request"){
			$completion = '';
			$status = 'Fund Certification Signed';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Fund Certification Signed"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Acknowledge Certification Request";
			}else{
				$status = "Schedule for Inspection";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Schedule for Inspection"){
			$completion = '';
			$status = 'For Inspection';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "For Inspection"){
			$completion = '';
			if($btnTxt == "Not Feasible"){
				$status = "Inspected - Not Feasible";
			}else{
				$status = "Preparation of Plans, PoW, and Detailed Estimates";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Inspected - Not Feasible"){
			$completion = '';
			$status = 'For Inspection';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Preparation of Plans, PoW, and Detailed Estimates"){
			$completion = '';
			$status = 'Plans, PoW, and Detailed Estimates for Approval';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Plans, PoW, and Detailed Estimates for Approval"){
			$completion = '';
			$status = 'Plans, PoW, and Detailed Estimates Signed';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Plans, PoW, and Detailed Estimates Signed"){
			$completion = '';
			$status = 'For BAC Procedures';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "For BAC Procedures"){
			$completion = '';
			$status = 'Drafting Invitation to Bid';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Drafting Invitation to Bid"){
			$completion = '';
			$status = 'Checking Invitation to Bid';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Checking Invitation to Bid"){
			$completion = '';
			if($btnTxt == "For Adjustment"){
				$status = "Invitation to Bid for Adjustment";
			}else{
				$status = "Invitation to Bid for Pick-up";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Invitation to Bid for Adjustment"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Checking Invitation to Bid";
			}else{
				$status = "Drafting Invitation to Bid";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Invitation to Bid for Pick-up"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Checking Invitation to Bid";
			}else{
				$status = "Invitation to Bid for Transmit";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Invitation to Bid for Transmit"){
			$completion = '';
			$status = "Invitation to Bid for Signature";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Invitation to Bid for Signature"){
			$completion = '';
			$status = "Invitation to Bid Signed";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Invitation to Bid Signed"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Invitation to Bid for Signature";
			}else{
				$status = "Posting";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Posting"){
			$completion = '';
			$status = "Bidding Schedule";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Bidding Schedule"){
			$completion = '';
			$sql = "UPDATE vouchercurrent SET Claimant = 'TBA', NetAmount = '0.00' WHERE TrackingNumber = '".$trackingNumber."' AND Claimant IS NULL";
			$database->query($sql);
			$status = "Post Qualification";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Post Qualification"){	
			$completion = '';
			$status = "Letters for Signature";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Letters for Signature"){
			$completion = '';
			$status = "Letters Signed";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Letters Signed"){
			$completion = '';
			$status = "Notice of Award for Transmit";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Notice of Award for Transmit"){
			$completion = '';
			$status = "Notice of Award for Admin Signature";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Notice of Award for Admin Signature"){
			$completion = '';
			$status = "Notice of Award Admin Signed";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Notice of Award Admin Signed"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Notice of Award for Admin Signature";
			}else{
				$status = "NoA and Contract for Contractor\'s Signature";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "NoA and Contract for Contractor\'s Signature"){
			$completion = '';
			$status = "NoA and Contract Released to Contractor";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "NoA and Contract Released to Contractor"){
			$completion = '';
			$status = "NoA and Contract Contractor Signed";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "NoA and Contract Contractor Signed"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "NoA and Contract Released to Contractor";
			}else{
				$sql = "SELECT Fund FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
				$record = $database->query($sql);
				$data = $database->fetch_array($record);
				$fund = $data['Fund'];

				if($fund == "Trust Fund"){
					$status = "Contract and NTP for City Engineer\'s Signature";
				}else{
					$status = "Obligation Request Preparation";
				}
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Obligation Request Preparation"){
			$completion = '';
			$status = "OBR for Implementing Office Signature";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "OBR for Implementing Office Signature"){
			$completion = '';
			$status = "OBR for Implementing Office Signed";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "OBR for Implementing Office Signed"){
			if($btnTxt == "Revert"){
				$status = "OBR for Implementing Office Signature";
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
				$completion = '';
				$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}else{
				$completion = '';	
				$record =  $database->FindOBR($inputNumber,$defaultYear);
				$count = $database->num_rows($record);
				$status = "CBO Received";
				if($count == 0){
					$obrApprove = '1';
					$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
					$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}else{
					$data = $database->fetch_array($record);
					if($trackingNumber == $data['TrackingNumber']){
						$obrApprove = '1';
						$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
						$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
						$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}else{
						$skipSearch = 1;
						echo '*' . $data['TrackingNumber'];	
					}
				}
			}
		}
		if($curStatus == "CBO Received"){
			$completion = '';
			$status = "Obligation request for Pick-up";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Pending Released - CBO"){
			$completion = '';
			$status = 'CBO Received';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);             
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Obligation request for Pick-up"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "CBO Received";
			}else{
				$status = "Obligation Request Signed";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Obligation Request Signed"){
			$completion = '';
			$status = "Contract and NTP for City Engineer\'s Signature";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Contract and NTP for City Engineer\'s Signature"){
			$completion = '';
			$status = "Contract and NTP Signed";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Contract and NTP Signed"){
			$completion = '';
			$status = "Document Filing";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Document Filing"){
			$completion = '';
			$status = 'CAO Received';
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "CAO Received"){
			$completion = '';
			$status = "Document for Pick-up - CAO";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Pending Released - CAO"){
			$completion = '';
			$status = 'CAO Received';
			$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Pending Released - Admin"){
			$completion = '';
			$status = 'Contract and NTP for Admin Signature';
			$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Document for Pick-up - Admin"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Contract and NTP for Admin Signature";
			}else{
				$status = "Contract for Notarization";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Contract for Notarization"){
			$completion = '';
			$status = "Released to Contractor for Notarization";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Released to Contractor for Notarization"){
			$completion = '';
			$status = "Contract Notarized";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Contract Notarized"){
			$completion = '';
			$status = "Prepare Letter for Pick-up NTP";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Prepare Letter for Pick-up NTP"){
			$completion = '';
			$status = "Forwarded Letter for Pick-up NTP";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Forwarded Letter for Pick-up NTP"){
			$completion = '';
			$status = "NTP Released to Contractor";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "NTP Released to Contractor"){
			$completion = '';
			$status = "NTP Received from Contractor";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "NTP Received from Contractor"){
			$completion = '';
			$status = "NTP Forwarded to Construction Division";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Document for Pick-up - CAO"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "CAO Received";
			}else{
				$status = "Contract and NTP Transmit to Admin";
			}
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Contract and NTP Transmit to Admin"){
			$completion = '';
			$status = "Contract and NTP for Admin Signature";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		if($curStatus == "Contract and NTP for Admin Signature"){
			$completion = '';
			$status = "Document for Pick-up - Admin";
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatusIn($updateCase,$trackingNumber);
			$database->UpdateVoucherHistoryIn($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistoryIn($trackingNumbers,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
	*/
		if($curStatus == "Project Encoded"){
			
			$sql = "select * from citydoc.signatories where role = 'Infra Requestor' limit 1";	
			$record = $database->query($sql);
			
			$data = $database->fetch_array($record);
			$name = $data['Name'];
			
			$title = $data['Title'];
			$prefix = '';
			if(strlen($data['Prefix']) > 0  ){
				$prefix =  $data['Prefix'] . ' ';
			}
			$suffix = '';
			if(strlen($data['Suffix']) > 0  ){
				$suffix =  ', ' . $data['Suffix'];
			}
			$name = $prefix  . $name . $suffix;
			$sql = "UPDATE infra SET Requestor = '".$name."', RequestorTitle = '".$title."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$status = 'Requesting for Fund Certification';
			
			$completion = '';
			$database->sendererByStatusAndFund($trackingNumber); // notify controller only
		}
		if($curStatus == "Requesting for Fund Certification"){
			$completion = '';
			$status = 'Acknowledge Certification Request';
		}
		if($curStatus == "Acknowledge Certification Request"){
			$completion = '';
			$status = 'Fund Certification Signed';
		}
		if($curStatus == "Fund Certification Signed"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Acknowledge Certification Request";
			}else{
				$status = "Schedule for Inspection";
			}
		}
		if($curStatus == "Schedule for Inspection"){
			$completion = '';
			$status = 'For Inspection';
		}
		if($curStatus == "For Inspection"){
			$completion = '';
			if($btnTxt == "Not Feasible"){
				$status = "Inspected - Not Feasible";
			}else{
				$status = "Preparation of Plans, PoW, and Detailed Estimates";
			}
		}
		if($curStatus == "Inspected - Not Feasible"){
			$completion = '';
			$status = 'For Inspection';
		}
		if($curStatus == "Preparation of Plans, PoW, and Detailed Estimates"){
			$completion = '';
			$status = 'Plans, PoW, and Detailed Estimates for Approval';
		}
		if($curStatus == "Plans, PoW, and Detailed Estimates for Approval"){
			$completion = '';
			$status = 'Plans, PoW, and Detailed Estimates Signed';
		}
		if($curStatus == "Plans, PoW, and Detailed Estimates Signed"){
			$completion = '';
			$status = 'For BAC Procedures';
		}
		if($curStatus == "For BAC Procedures"){
			$completion = '';
			$status = 'Drafting Invitation to Bid';
		}
		if($curStatus == "Drafting Invitation to Bid"){
			$completion = '';
			$status = 'Checking Invitation to Bid';
		}
		if($curStatus == "Checking Invitation to Bid"){
			$completion = '';
			if($btnTxt == "For Adjustment"){
				$status = "Invitation to Bid for Adjustment";
			}else{
				$status = "Invitation to Bid for Pick-up";
			}
		}
		if($curStatus == "Invitation to Bid for Adjustment"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Checking Invitation to Bid";
			}else{
				$status = "Drafting Invitation to Bid";
			}
		}
		if($curStatus == "Invitation to Bid for Pick-up"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Checking Invitation to Bid";
			}else{
				$status = "Invitation to Bid for Transmit";
			}
		}
		if($curStatus == "Invitation to Bid for Transmit"){
			$completion = '';
			$status = "Invitation to Bid for Signature";
		}
		if($curStatus == "Invitation to Bid for Signature"){
			$completion = '';
			$status = "Invitation to Bid Signed";
		}
		if($curStatus == "Invitation to Bid Signed"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Invitation to Bid for Signature";
			}else{
				$status = "Posting";
			}
		}
		if($curStatus == "Posting"){
			$completion = '';
			$status = "Bidding Schedule";
		}
		if($curStatus == "Bidding Schedule"){
			$completion = '';
			$sql = "UPDATE vouchercurrent SET Claimant = 'TBA', NetAmount = '0.00' WHERE TrackingNumber = '".$trackingNumber."' AND Claimant IS NULL";
			$database->query($sql);
			$status = "Post Qualification";
		}
		if($curStatus == "Post Qualification"){	
			$completion = '';
			$status = "Letters for Signature";
		}
		if($curStatus == "Letters for Signature"){
			$completion = '';
			$status = "Letters Signed";
		}
		if($curStatus == "Letters Signed"){
			$completion = '';
			$status = "Notice of Award for Transmit";
		}
		if($curStatus == "Notice of Award for Transmit"){
			$completion = '';
			$status = "Notice of Award for Admin Signature";
		}
		if($curStatus == "Notice of Award for Admin Signature"){
			$completion = '';
			$status = "Notice of Award Admin Signed";
		}
		if($curStatus == "Notice of Award Admin Signed"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Notice of Award for Admin Signature";
			}else{
				$status = "NoA and Contract for Contractor\'s Signature";
			}
		}
		if($curStatus == "NoA and Contract for Contractor\'s Signature"){
			$completion = '';
			$status = "NoA and Contract Released to Contractor";
		}
		if($curStatus == "NoA and Contract Released to Contractor"){
			$completion = '';
			$status = "NoA and Contract Contractor Signed";
		}
		if($curStatus == "NoA and Contract Contractor Signed"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "NoA and Contract Released to Contractor";
			}else{
				$sql = "SELECT Fund FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
				$record = $database->query($sql);
				$data = $database->fetch_array($record);
				$fund = $data['Fund'];
				if($fund == "Trust Fund"){
					$status = "Contract and NTP for City Engineer\'s Signature";
				}else{
					$status = "Obligation Request Preparation";
				}
			}
		}
		if($curStatus == "Obligation Request Preparation"){
			$completion = '';
			$status = "OBR for Implementing Office Signature";
		}
		if($curStatus == "OBR for Implementing Office Signature"){
			$completion = '';
			$status = "OBR Implementing Office Signed";
		}
		if($curStatus == "OBR Implementing Office Signed"){
			if($btnTxt == "Revert"){
				$completion = '';
				$status = "OBR for Implementing Office Signature";
			}else{
				$completion = '';
				if(strlen($inputNumber) == 0){
					$obrApprove = '1';
					$status = "CBO Received";
					$updateCase = " OBR_Approve = '" . $obrApprove . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatusIn($updateCase,$trackingNumberUpdateCase);
					$database->UpdateVoucherHistoryIn($trackingNumberUpdateCase);            //   update para sa completion
					$database->InsertToVoucherHistoryIn($trackingNumberInsertCase,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					$skipSearch = 2;
				}else{
					$record =  $database->FindOBR($inputNumber,$defaultYear);
					$count = $database->num_rows($record);
					$status = "CBO Received";
					if($count == 0){
						$obrApprove = '1';
						$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatusIn($updateCase,$trackingNumberUpdateCase);
						$database->UpdateVoucherHistoryIn($trackingNumberUpdateCase);            //   update para sa completion
						$database->InsertToVoucherHistoryIn($trackingNumberInsertCase,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
						$skipSearch = 2;
					}else{
						$data = $database->fetch_array($record);
						if($trackingNumber == $data['TrackingNumber']){
							$obrApprove = '1';
							$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
							$database->UpdateTrackingStatusIn($updateCase,$trackingNumberUpdateCase);
							$database->UpdateVoucherHistoryIn($trackingNumberUpdateCase);               //update para sa completion
							$database->InsertToVoucherHistoryIn($trackingNumberInsertCase,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
							$skipSearch = 2;
						}else{
							$skipSearch = 1;
							echo '*' . $data['TrackingNumber'];	
						}
					}
				}	
				
			}
		}
		if($curStatus == "CBO Received"){
			$completion = '';
			$status = "Obligation Request for Pick-up";
		}
		if($curStatus == "Pending Released - CBO"){
			$completion = '';
			$status = 'CBO Received';
		}
		if($curStatus == "Obligation Request for Pick-up"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "CBO Received";
			}else{
				$status = "Obligation Request Signed";
			}
		}
		if($curStatus == "Obligation Request Signed"){
			$completion = '';
			$status = "Contract and NTP for City Engineer\'s Signature";
		}
		if($curStatus == "Contract and NTP for City Engineer\'s Signature"){
			$completion = '';
			$status = "Contract and NTP Signed";
		}
		if($curStatus == "Contract and NTP Signed"){
			$completion = '';
			$status = "Document Filing";
		}
		if($curStatus == "Document Filing"){
			$completion = '';
			$status = 'CAO Received';
		}
		if($curStatus == "CAO Received"){
			$completion = '';
			$status = "Document for Pick-up - CAO";
		}
		if($curStatus == "Pending Released - CAO"){
			$completion = '';
			$status = 'CAO Received';
		}
		if($curStatus == "Pending Released - Admin"){
			$completion = '';
			$status = 'Contract and NTP for Admin Signature';
		}
		if($curStatus == "Document for Pick-up - Admin"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "Contract and NTP for Admin Signature";
			}else{
				$status = "Contract for Notarization";
			}
		}
		if($curStatus == "Contract for Notarization"){
			$completion = '';
			$status = "Released to Contractor for Notarization";
		}
		if($curStatus == "Released to Contractor for Notarization"){
			$completion = '';
			$status = "Contract Notarized";
		}
		if($curStatus == "Contract Notarized"){
			$completion = '';
			$status = "Prepare Letter for Pick-up NTP";	
		}
		if($curStatus == "Prepare Letter for Pick-up NTP"){
			$completion = '';
			$status = "Forwarded Letter for Pick-up NTP";
		}
		if($curStatus == "Forwarded Letter for Pick-up NTP"){
			$completion = '';
			$status = "NTP Released to Contractor";
		}
		if($curStatus == "NTP Released to Contractor"){
			$completion = '';
			$status = "NTP Received from Contractor";
		}
		if($curStatus == "NTP Received from Contractor"){
			$completion = '';
			$status = "NTP Forwarded to Construction Division";
		}
		if($curStatus == "Document for Pick-up - CAO"){
			$completion = '';
			if($btnTxt == "Revert"){
				$status = "CAO Received";
			}else{
				$status = "Contract and NTP Transmit to Admin";
			}	
		}
		if($curStatus == "Contract and NTP Transmit to Admin"){
			$completion = '';
			$status = "Contract and NTP for Admin Signature";	
		}
		if($curStatus == "Contract and NTP for Admin Signature"){
			$completion = '';
			$status = "Document for Pick-up - Admin";
		}
		
		
		
		
		
		if($skipSearch != 1){
			if($skipSearch != 2){
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatusIn($updateCase,$trackingNumberUpdateCase);
				$database->UpdateVoucherHistoryIn($trackingNumberUpdateCase);               //update para sa completion
				$database->InsertToVoucherHistoryIn($trackingNumberInsertCase,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}

			// $record = $database->SearchTracking($trackingNumber);
			// $count =  $database->num_rows($record);
			// if($count > 0){
			// 	echo $sheet->CreateDoctrackInfoPR($record);
			// }else{
			// 	echo "<span class = 'remark1'>No record found.</span>";
			// }
			$record = $database->searchTrackingNumber2022($trackingNumber);
			if(sizeof($record) > 0) {
				echo $sheet->CreateDoctrackInfoPR($record);
			}else{
				echo "<span class = 'remark1'>No record found.</span>";
			}
		}
	}
	
	
	if(isset($_GET['updateTrackingStatus'])){
		$skipSearch = 0;
		$trackingNumber =  $database->charEncoder($_GET['trackingNumber']);
		$inputNumber = $database->charEncoder($_GET['inputNumber']);
		$status = $database->charEncoder($_GET['status']);
		$trackingAmount = $database->charEncoder($_GET['trackingAmount']);
		$trackType = $database->charEncoder($_GET['trackType']);
		$dateTrackingEncoded = $database->charEncoder($_GET['dateEncoded']);
		$dateTrackingModified = $database->charEncoder($_GET['dateModified']);
		$btnTxt = $database->charEncoder($_GET['btnTxt']); // 01-20-2022 Added para "For Adjustment", "For Pick-up", "For Payment"

		if($status == "EncodedPayment"){
			$completion = '';
			$status = 'Inspected';
			//$status = 'For Inspection';
			$updateCase = " PO_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}	
		if($status == "Draft"){
			if($trackType == "PY"){
				if($_SESSION['accountType'] == 2 and $_SESSION['gso'] == '1091' or $_SESSION['accountType'] == 7){
					$status = 'Encoded';
					$completion = '';
					$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status

					$database->sendUpdateForPaymasterBatch($year, $trackingNumber);
				}
			}
		}
		if($status == "Encoded"){
			$completion = '';
			if($trackType == "PR"){
				/*$status = 'GSO Received';
				$updateCase = " PR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);    */           //update para sa completion
				$status = 'CBO Received';
				$updateCase = "Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "', OBR_Number = '" . $inputNumber . "'  ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);    
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}else if($trackType == "PO"){
				$status = 'GSO Received';
				$updateCase = " PO_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}else if($trackType == "PY"){
				if($_SESSION['accountType'] == 2 and $_SESSION['gso'] == '1071' or $_SESSION['accountType'] == 7){
							$record =  $database->FindOBR($inputNumber,$defaultYear);
							$count = $database->num_rows($record);
							$status = 'CBO Received';
							if($count == 0){
								$obrApprove = '1';
								$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
								$database->UpdateTrackingStatus($updateCase,$trackingNumber);
								$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
								$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
							}else{
								$data = $database->fetch_array($record);
								if($trackingNumber == $data['TrackingNumber']){
									$obrApprove = '1';
									$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
									$database->UpdateTrackingStatus($updateCase,$trackingNumber);
									$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
									$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
								}else{
									$skipSearch = 1;
									echo '*' . $data['TrackingNumber'];	
								}
							}
				}
				if($_SESSION['accountType'] == 2 and $_SESSION['gso'] == '1061' or $_SESSION['accountType'] == 7){
					$status = 'GSO Received';
					$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
				}
				if($_SESSION['accountType'] == 4 and $_SESSION['cbo'] == '1081' or $_SESSION['accountType'] == 7){
					$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
					$record = $database->FetchThis($sql);
					$data = $database->fetch_array($record);
					$fund = $data['Fund'];
					$year = $data['Year'];
					$docType = $data['DocumentType'];
					
					if($inputNumber == "TBA"){
						$completion = '';
						$status = 'CAO Received';
						$updateCase = " ADV1 = '99999',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);            
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
						
						if($docType == 'CASH ADVANCE TO PAYMASTER') {
							$database->sendUpdateForPaymasterBatch($year, $trackingNumber);
						}
					}else{
						
						$record = $database->FetchByAdv($inputNumber,$fund,$year); 
						$count = $database->num_rows($record);
						if($count > 0){
							$skipSearch = 1;
							$data = $database->fetch_array($record);
							echo '~' . $data['TrackingNumber'];
						}else{
							$completion = '';
							$status = 'CAO Received';
							$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
							$database->UpdateTrackingStatus($updateCase,$trackingNumber);
							$database->UpdateVoucherHistory($trackingNumber);            
							$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

							if($docType == 'CASH ADVANCE TO PAYMASTER') {
								$database->sendUpdateForPaymasterBatch($year, $trackingNumber);
							}
						}
					}
				}
			}else if($trackType == "IP"){
				if($_SESSION['accountType'] == 4 and $_SESSION['cbo'] == '1081' or $_SESSION['accountType'] == 7){
					$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
					$record = $database->FetchThis($sql);
					$data = $database->fetch_array($record);
					$fund = $data['Fund'];
					$year = $data['Year'];
					
					if($inputNumber == "TBA"){
						$completion = '';
						$status = 'CAO Received';
						$updateCase = " ADV1 = '99999',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);            
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}else{
						
						$record = $database->FetchByAdv($inputNumber,$fund,$year); 
						$count = $database->num_rows($record);
						if($count > 0){
							$skipSearch = 1;
							$data = $database->fetch_array($record);
							echo '~' . $data['TrackingNumber'];
						}else{
							$completion = '';
							$status = 'CAO Received';
							$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
							$database->UpdateTrackingStatus($updateCase,$trackingNumber);
							$database->UpdateVoucherHistory($trackingNumber);            
							$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
						}
					}
				}
			}else if($trackType == "PX"){

				// if($_SESSION['accountType'] == 4 and $_SESSION['cbo'] == '1081' or $_SESSION['accountType'] == 7){
				// 	$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
				// 	$record = $database->FetchThis($sql);
				// 	$data = $database->fetch_array($record);
				// 	$fund = $data['Fund'];
				// 	$year = $data['Year'];
					
				// 	if($inputNumber == "TBA"){
				// 		$completion = '';
				// 		$status = 'CAO Received';
				// 		$updateCase = " ADV1 = '99999',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				// 		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				// 		$database->UpdateVoucherHistory($trackingNumber);            
				// 		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				// 	}else{
						
				// 		$record = $database->FetchByAdv($inputNumber,$fund,$year); 
				// 		$count = $database->num_rows($record);
				// 		if($count > 0){
				// 			$skipSearch = 1;
				// 			$data = $database->fetch_array($record);
				// 			echo '~' . $data['TrackingNumber'];
				// 		}else{
				// 			$completion = '';
				// 			$status = 'CAO Received';
				// 			$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				// 			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				// 			$database->UpdateVoucherHistory($trackingNumber);            
				// 			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				// 		}
				// 	}
				// }

				if($_SESSION['accountType'] == 2 and $_SESSION['gso'] == '1061' or $_SESSION['accountType'] == 7){

					if($_SESSION['perm'] == 10) {
						$status = 'For Inspection';
						// $updateCase = " PO_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}

				}

			}	
		}else if($status == "Pending Released - GSO"){
			$completion = '';
			if($trackType == "PO"){
				$status = 'GSO Received';        
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			}else{
				$status = 'GSO Received';        
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			}
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if($status == "Pending Released - Adminx" || $status == "Pending Released - CTOx"){
			// $completion = '';
			
			// $status = 'GSO Received';        
			// $updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			
			// $database->UpdateTrackingStatus($updateCase,$trackingNumber);
			// $database->UpdateVoucherHistory($trackingNumber);              
			// $database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if ($status == "Pending Released - Inspection" || $status == "Pending Released - GSO Voucher(Inspection)") {  
			$completion = '';
			if($trackType == "PO"){
				$status = 'For Inspection';        
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			} else {
				$status = 'For Inspection';        
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			}

			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
		}else if ($status == "Pending Released - Inventory" || $status == "Pending Released - GSO Voucher(Inventory)") { 
			$completion = '';	
			if($trackType == "PO"){
				$status = 'Inventory';   
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			} else {
				$status = 'Inventory';
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			}
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status			
		}else if ($status == "Forwarded to CMO") { 			
			$completion = '';	
			if($trackType == "PO"){
				$status = 'CMO Approved';   
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			} else {
				$status = 'CMO Approved';
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			}
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if ($status == "CMO Approved") { 	
			$completion = '';	
			if($trackType == "PO"){
				$status = 'Served to Supplier';   
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			} else {
				$status = 'Served to Supplier';
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			}
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if ($status == "Serve to Supplier") { 		
			$completion = '';	
			$status = 'Supplier Conformed';   
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',ConformDate = '" . $inputNumber . "' ";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if ($status == "Served to Supplier") { 		
			$completion = '';	
			if($trackType == "PO"){
				$status = 'Supplier Conformed';   
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',ConformDate = '" . $inputNumber . "' ";
			} else {
				$status = 'Supplier Conformed';
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',ConformDate = '" . $inputNumber . "' ";
			}
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if ($status == "Supplier Conformed" || $status == "GSO Conformed") { 	
			$completion = '';	
			$record =  $database->FindOBR($inputNumber,$defaultYear);
			$count = $database->num_rows($record);
			$status = 'Fund Control';
			if($count == 0){
				$obrApprove = '1';
				$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}else{
				$data = $database->fetch_array($record);
				if($trackingNumber == $data['TrackingNumber']){
					$obrApprove = '1';
					$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}else{
					$skipSearch = 1;
					echo '*' . $data['TrackingNumber'];	
				}
			}
		}else if($status == "Fund Control"){
			$completion = '';	
			
			$status = 'Waiting for Delivery';   
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		}else if ($status == "Waiting for Delivery") { 	 		
			$completion = '';	
			if($trackType == "PO"){
				$status = 'For Inspection';   
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			} else {
				$status = 'For Inspection';
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			}
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
		}/*else if ($status == "For Inspection") {  	 		
			$completion = '';	
			if($trackType == "PO"){
				$status = 'Inspected';   
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			} else {
				$status = 'Inspected';
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			}

			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

		}*/else if ($status == "For Inspection") { 	
			$completion = '';	
			// if($trackType == "PO"){
			// 	$status = 'Inspected';   
			// 	$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			// }
			if($trackType == "PX"){
				$status = 'Inspected';   
				$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			}
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if ($status == "Inspected") { 	
			// $completion = '';	
			// if($trackType == "PO"){
			// 	$status = 'Inventory';   
			// 	$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			// }
			// $database->UpdateTrackingStatus($updateCase,$trackingNumber);
			// $database->UpdateVoucherHistory($trackingNumber);              
			// $database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

			if($_SESSION['accountType'] == 4 and $_SESSION['cbo'] == '1081' or $_SESSION['accountType'] == 7){
				$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
				$record = $database->FetchThis($sql);
				$data = $database->fetch_array($record);
				$fund = $data['Fund'];
				$year = $data['Year'];
				
				if($inputNumber == "TBA"){
					$completion = '';
					$status = 'CAO Received';
					$updateCase = " ADV1 = '99999',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);            
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}else{
					
					$record = $database->FetchByAdv($inputNumber,$fund,$year); 
					$count = $database->num_rows($record);
					if($count > 0){
						$skipSearch = 1;
						$data = $database->fetch_array($record);
						echo '~' . $data['TrackingNumber'];
					}else{
						$completion = '';
						$status = 'CAO Received';
						$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);            
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}
				}
			}else {

				$completion = '';	
				// if($trackType == "PO"){
				// 	if($btnTxt == 'For Payment') {
				// 		$status = 'For Payment';   
				// 	}else {
				// 		$status = 'Inventory';   
				// 	}
				// 	$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				// }

				if($trackType == "PX"){
					$status = 'Inventory';   
					$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				}

				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);              
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

			}

		}else if($status == "Pending Released - CBO"){
			if($trackType != "PO"){
				$completion = '';
				$status = 'CBO Received';
				//$updateCase = " PR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$updateCase = "Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);             
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}else{
				$completion = '';
				$status = 'Fund Control';
				//$updateCase = " PR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$updateCase = "Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);             
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}
		}else if($status == "Pending Released - CAO"){
			$completion = '';
			
			if($trackType == "PO"){
				$completion = '';
				$status = 'CAO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}
			if($trackType == "PY"){
				$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
				$record = $database->FetchThis($sql);
				$data = $database->fetch_array($record);
				$claimType = $data['ClaimType'];
				$docType = $data['DocumentType'];

				$error = $database->compareGrossWithTNandPTRS($db, $year, $trackingNumber, $trackType, $claimType, $docType);
				if($error == ""){
					$completion = '';
					$status = 'CAO Received';
					$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}else{
					$skipSearch = 1;
					echo "<div class = 'norecord' style='text-align:left;'>".$error."</div>*v*";
				}
			}
			if($trackType == "IP"){
				$completion = '';
				$status = 'CAO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}
			if($trackType == "PX"){
				$completion = '';
				$status = 'CAO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}	
		}else if($status == "Inventory") {
			// if($trackType == "PO"){
			// 	$completion = '';
			// 	$status = 'For Payment';
			// 	//$updateCase = " PR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			// 	$updateCase = "Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			// 	$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			// 	$database->UpdateVoucherHistory($trackingNumber);             
			// 	$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			// }

			if($_SESSION['accountType'] == 4 and $_SESSION['cbo'] == '1081' or $_SESSION['accountType'] == 7){
				$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
				$record = $database->FetchThis($sql);
				$data = $database->fetch_array($record);
				$fund = $data['Fund'];
				$year = $data['Year'];
				
				if($inputNumber == "TBA"){
					$completion = '';
					$status = 'CAO Received';
					$updateCase = " ADV1 = '99999',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);            
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}else{
					
					$record = $database->FetchByAdv($inputNumber,$fund,$year); 
					$count = $database->num_rows($record);
					if($count > 0){
						$skipSearch = 1;
						$data = $database->fetch_array($record);
						echo '~' . $data['TrackingNumber'];
					}else{
						$completion = '';
						$status = 'CAO Received';
						$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);            
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}
				}
			}

		}else if($status == "GSO Received" || $status == "GSO Received - Voucher(Inventory)" || $status == "GSO Received - Voucher(Inspection)"){
			$completion = '';	
			if($trackType == "PO"){
				// if($_SESSION['accountType'] == 4 and $_SESSION['cbo'] == '1081' or $_SESSION['accountType'] == 7){
				// 	$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
				// 	$record = $database->FetchThis($sql);
				// 	$data = $database->fetch_array($record);
				// 	$fund = $data['Fund'];
				// 	$year = $data['Year'];
					
				// 	if($inputNumber == "TBA"){
				// 		$completion = '';
				// 		$status = 'CAO Received';
				// 		$updateCase = "ADV1 = '99999', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				// 		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				// 		$database->UpdateVoucherHistory($trackingNumber);            
				// 		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				// 	}else{
				// 		$record = $database->FetchByAdv($inputNumber,$fund,$year); 
				// 		$count = $database->num_rows($record);
				// 		if($count > 0){
				// 			$skipSearch = 1;
				// 			$data = $database->fetch_array($record);
				// 			echo '~' . $data['TrackingNumber'];
				// 		}else{
				// 			$completion = '';
				// 			$status = 'CAO Received';
				// 			$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				// 			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				// 			$database->UpdateVoucherHistory($trackingNumber);            
				// 			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				// 		}
				// 	}
				// }	

				// if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1061' ){
				// 	$status = 'Forwarded to CMO';   
				// 	$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				// 	$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				// 	$database->UpdateVoucherHistory($trackingNumber);            
				// 	$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
				// }

				if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1031'){
					$completion = '';
					$status = 'Admin Received';
					$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}
					
			}else{ 
				if($_SESSION['accountType'] == 4 and $_SESSION['cbo'] == '1081' or $_SESSION['accountType'] == 7){
					$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
					$record = $database->FetchThis($sql);
					$data = $database->fetch_array($record);
					$fund = $data['Fund'];
					$year = $data['Year'];
					
					if($inputNumber == "TBA"){
						$completion = '';
						$status = 'CAO Received';
						$updateCase = "ADV1 = '99999', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);            
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}else{
						$record = $database->FetchByAdv($inputNumber,$fund,$year); 
						$count = $database->num_rows($record);
						if($count > 0){
							$skipSearch = 1;
							$data = $database->fetch_array($record);
							echo '~' . $data['TrackingNumber'];
						}else{
							$completion = '';
							$status = 'CAO Received';
							$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
							$database->UpdateTrackingStatus($updateCase,$trackingNumber);
							$database->UpdateVoucherHistory($trackingNumber);            
							$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
						}
					}	
				}else if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1061' or $_SESSION['accountType'] == 7){
					$completion = '';
					$status = 'GSO Released';
					
					$updateCase = " Status = '" . $status . 
								  "',ModifiedBy = '" . $employeeNumber . 
								  "',DateModified = '" . $dateEncoded . 
								  "',Completion = '" . $completion . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);
					$completion =  str_replace(" ago","",$database->ezDate1($dateTrackingModified));    
					$completion = '';          
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
					
				}else{//sa budget n
					
					$record =  $database->FindOBR($inputNumber,$defaultYear);
					$count = $database->num_rows($record);
					$status = 'CBO Received';
					if($trackType == "PY"){
						if($count == 0){
							$obrApprove = '1';
							$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
							$database->UpdateTrackingStatus($updateCase,$trackingNumber);
							$database->UpdateVoucherHistory($trackingNumber);              
							$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); 
						}else{
							$data = $database->fetch_array($record);
							if($trackingNumber == $data['TrackingNumber']){
								$obrApprove = '1';
								$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
								$database->UpdateTrackingStatus($updateCase,$trackingNumber);
								$database->UpdateVoucherHistory($trackingNumber);              
								$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); 
							}else{
								$skipSearch = 1;
								echo '*' . $data['TrackingNumber'];	
							}
						}
					}else{
						$obrApprove = '1';
						$updateCase = " OBR_Approve = '" . $obrApprove . "', OBR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);              
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); 
					}
				}
			}
			
		}else if($status == "CBO Received"){
			if($trackType == "PR"){
				
				if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1071'){
					//$completion =  str_replace(" ago","",$database->ezDate1($dateTrackingEncoded));
					$completion = '';
					$status = 'CBO Released';
					
					$updateCase = " Status = '" . $status . 
								  "',ModifiedBy = '" . $employeeNumber . 
								  "',DateModified = '" . $dateEncoded . 
								  "',Completion = '" . $completion . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);
					$completion =  str_replace(" ago","",$database->ezDate1($dateTrackingModified));    
					$completion = '';          
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
				}
				if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1061'){
					
					$status = 'GSO Received';
					$updateCase = " PR_Number = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);    
					
					// 2023-10-19
					$completion = '';
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
					
					/*$completion = '';
					$status = 'GSO Received';
					
					$updateCase = " Status = '" . $status . 
								  "',ModifiedBy = '" . $employeeNumber . 
								  "',DateModified = '" . $dateEncoded . 
								  "',Completion = '" . $completion . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);
					$completion =  str_replace(" ago","",$database->ezDate1($dateTrackingModified));    
					$completion = '';          
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);*/
				}
						
				if($_SESSION['accountType'] == 2 and $_SESSION['gso'] == '1091' or $_SESSION['accountType'] == 7){
					$completion = '';
					$status = 'CTO Received';
					$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}
				 
			
			}else if($trackType == "PY"){
				if($_SESSION['accountType'] == 2 and $_SESSION['gso'] == '1061' or $_SESSION['accountType'] == 7){
					 if ($trackType == "PY"){
						$completion = '';
						$status = 'GSO Received';
						$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}
				}else{
					$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
					$record = $database->FetchThis($sql);
					$data = $database->fetch_array($record);
					$fund = $data['Fund'];
					$year = $data['Year'];
					$claimType = $data['ClaimType'];
					$docType = $data['DocumentType'];

					if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1071'){
						$completion = '';
						$inputNumber = 0;
						$status = 'CBO Released';
						$updateCase = "ADV1 = '" . $inputNumber . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);            
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
						$inputNumber = "TBA";
					}else{
						$error = $database->compareGrossWithTNandPTRS($db, $year, $trackingNumber, $trackType, $claimType, $docType);
						if($error == ""){
							if($inputNumber == "TBA"){
								$completion = '';
								$inputNumber = "99999";
								$status = 'CAO Received';
								$updateCase = "ADV1 = '" . $inputNumber . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
								$database->UpdateTrackingStatus($updateCase,$trackingNumber);
								$database->UpdateVoucherHistory($trackingNumber);            
								$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
							}else{
								$record = $database->FetchByAdv($inputNumber,$fund,$year); 
								$count = $database->num_rows($record);
								if($count > 0){
									$skipSearch = 1;
									$data = $database->fetch_array($record);
									echo '~' . $data['TrackingNumber'];
								}else{
									$completion = '';
									$status = 'CAO Received';
									$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
									$database->UpdateTrackingStatus($updateCase,$trackingNumber);
									$database->UpdateVoucherHistory($trackingNumber);            
									$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
								}
							}
						}else{
							$skipSearch = 1;
							echo "<div class = 'norecord' style='text-align:left;'>".$error."</div>*v*";
						}
					}
				}	
			}
		}else if($status == "CBO Released" ){
			if($_SESSION['accountType'] == 2 and $_SESSION['gso'] == '1061' or $_SESSION['accountType'] == 7){
				if ($trackType == "PY"){
					$completion = '';
					$status = 'GSO Received';
					$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}
			}else if($_SESSION['accountType'] == 2 and $_SESSION['gso'] == '1091' or $_SESSION['accountType'] == 7){
				if ($trackType == "PR"){
					$completion = '';
					$status = 'CTO Received';
					$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}
			}else{
				$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
				$record = $database->FetchThis($sql);
				$data = $database->fetch_array($record);
				$fund = $data['Fund'];
				$year = $data['Year'];
				$claimType = $data['ClaimType'];
				$docType = $data['DocumentType'];
				
				if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1071'){
					//$inputNumber = "TBA";	
					 if ($trackType == "PY"){
						$completion = '';
						$status = 'CBO Received';
						$updateCase = "Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$status = 'CBO Received - Reverted';
						$database->UpdateVoucherHistory($trackingNumber);            
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}else{
						$completion = '';
						$status = 'CBO Received';
						$updateCase = "Status = '" . $status . "',Completion ='',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$status = 'CBO Received - Reverted';
						$database->UpdateVoucherHistory($trackingNumber);            
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}
				}else{
					$error = $database->compareGrossWithTNandPTRS($db, $year, $trackingNumber, $trackType, $claimType, $docType);
					if($error == ""){
						if($inputNumber == "TBA"){
							$completion = '';
							if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1071'){
								$status = 'CBO Released';
							}else{
								$status = 'CAO Received';
							}
							
							$updateCase = "ADV1 = '99999', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
							$database->UpdateTrackingStatus($updateCase,$trackingNumber);
							$database->UpdateVoucherHistory($trackingNumber);            
							$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
						}else{
							
							$record = $database->FetchByAdv($inputNumber,$fund,$year); 
							$count = $database->num_rows($record);
							if($count > 0){
								$skipSearch = 1;
								$data = $database->fetch_array($record);
								echo '~' . $data['TrackingNumber'];
							}else{
								$completion = '';
								$status = 'CAO Received';
								$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
								$database->UpdateTrackingStatus($updateCase,$trackingNumber);
								$database->UpdateVoucherHistory($trackingNumber);            
								$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
							}
						}
					}else{
						$skipSearch = 1;
						echo "<div class = 'norecord' style='text-align:left;'>".$error."</div>*v*";
					}
				}
			}	
		}else if($status == "GSO Released" ){
			if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1061'){
				$completion = '';
				$status = 'GSO Received';
				$updateCase = "Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber); 
				$status = 'GSO Received - Reverted';
				$database->UpdateVoucherHistory($trackingNumber);            
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}
		}else if($status == "CTO Received"){
			// if ($trackType == "PR"){
			// 	$completion = '';
			// 	$status = 'Admin Received';
			// 	$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			// 	$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			// 	$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			// 	$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			// }
			if($_SESSION['accountType'] == 2 and $_SESSION['cbo'] == '1031'){
				$completion = '';
				$status = 'Admin Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}
		}else if($status == "Pending Released - Admin"){
			// if ($trackType == "PR"){
			// 	$completion = '';
			// 	$status = 'Admin Received';
			// 	$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			// 	$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			// 	$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			// 	$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			// } 

			if ($trackType == "PR" && $_SESSION['cbo'] == '1061'){
				$completion = '';
				$status = 'GSO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			} 

			if ($trackType == "PR" && $_SESSION['cbo'] == '1071'){
				$completion = '';
				$status = 'CBO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			} 

			if ($trackType == "PR" && $_SESSION['cbo'] == '1031'){
				$completion = '';
				$status = 'Admin Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			} 

			if ($trackType == "PO" && $_SESSION['cbo'] == '1061'){
				$completion = '';
				$status = 'GSO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}

			if ($trackType == "PO" && $_SESSION['cbo'] == '1031'){
				$completion = '';
				$status = 'Admin Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}

		}else if($status == "Admin Received" || $status == "Forwarded to SP Admin - PR" || $status == "Forwarding to BAC"){
			if ($trackType == "PR"){
				$completion = '';
				$status = 'BAC Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}

			if ($trackType == "PO"){
				$completion = '';
				// $status = 'Serve to Supplier';
				$status = 'PO Signed';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}

		}
		// else if($status == "BAC Received"){
		// 	if ($trackType == "PR"){
		// 		$completion = '';
		// 		$status = 'BAC Deliberation';
		// 		$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
		// 		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		// 		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		// 		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		// 	}
		// }
		else if($status == "BAC Received"){
			$completion =  str_replace(' ago','',$database->ezDate1($dateTrackingEncoded));
		
			$status = 'For P.O';
			$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if($status == "For P.O"){
			
			$completion = '';
			
			$status = 'BAC Received';
			$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			
		}else if(strtoupper($status) == "FORWARDING TRANSMITTAL"){
			$completion = '';
			$status = 'Check Preparation - CTO';
			
			$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status

			$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
			$record = $database->FetchThis($sql);
			$data = $database->fetch_array($record);
			$docType = $data['DocumentType'];

			if($docType == 'CASH ADVANCE TO PAYMASTER') {
				$database->sendUpdateForPaymasterBatch($year, $trackingNumber);
			}

			// 11-02-2021 Update for Batch Tracking Children
			$database->updateBatchTrackingChildren($trackingNumber, $db, $status, $employeeNumber, $dateEncoded);
		}else if($status == "CAO Received"){

			$completion = '';
			
			$status = 'On Evaluation - Accounting';
			$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "', CAOOfficer = '".$employeeNumber."' ";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

		}else if($status == "On Evaluation - Accounting"){

			$completion = '';
			
			$status = 'Evaluated - Accounting';
			$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

			if($trackType == 'PX') {
				$database->TransferToTaxifier($defaultYear, $trackingNumber, $dateEncoded);
			}else if($trackType == 'IP') {
				$database->TransferToTaxifierInfraPayment($defaultYear, $trackingNumber, $dateEncoded);
			}

		}else if($status == "BAC Released"){
			$completion = '';
			
			$status = 'BAC Received';
			$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if($status == "CEO Received"){
			if($trackType == "IP"){
				$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
				$record = $database->FetchThis($sql);
				$data = $database->fetch_array($record);
				$fund = $data['Fund'];
				$year = $data['Year'];
				
				if($inputNumber == "TBA"){
					$completion = '';
					$status = 'CAO Received';
					$updateCase = "ADV1 = '99999', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);            
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}else{
					$record = $database->FetchByAdv($inputNumber,$fund,$year); 
					$count = $database->num_rows($record);
					if($count > 0){
						$skipSearch = 1;
						$data = $database->fetch_array($record);
						echo '~' . $data['TrackingNumber'];
					}else{
						$completion = '';
						$status = 'CAO Received';
						$updateCase = " ADV1 = '" . $inputNumber . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
						$database->UpdateTrackingStatus($updateCase,$trackingNumber);
						$database->UpdateVoucherHistory($trackingNumber);            
						$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
					}
				}
			}
		}else if($status == "Pending Released - CEO"){
			if($trackType == "IP"){
				$completion = '';
				$status = 'CEO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
			}
		}else if ($status == "PO Signed") { 		
			$completion = '';	
			$status = 'Serve to Supplier';   
			$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);              
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if($status == "Pending Released - CTO") {
			if ($trackType == "PR" && $_SESSION['cbo'] == '1061'){
				$completion = '';
				$status = 'GSO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			} 

			if ($trackType == "PR" && $_SESSION['cbo'] == '1071'){
				$completion = '';
				$status = 'CBO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			} 
		}else if($status == "Pending Released - BAC") {
			if ($trackType == "PR" && $_SESSION['cbo'] == '1061'){
				$completion = '';
				$status = 'GSO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			} 

			if ($trackType == "PR" && $_SESSION['cbo'] == '1071'){
				$completion = '';
				$status = 'CBO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			} 
		}else if($status == "Fund Correction"){
			$completion = '';
			
			if($trackType == "PY"){
				$completion = '';
				$status = 'CAO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}
			// if($trackType == "IP"){
			// 	$completion = '';
			// 	$status = 'CAO Received';
			// 	$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
			// 	$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			// 	$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			// 	$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			// }
			if($trackType == "PX"){
				$completion = '';
				$status = 'CAO Received';
				$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}	
		}

		


		//header("Location: https://accounts.davaocity.gov.ph/api/gsm?numbers=09109002069&msg=123");
		
		if($skipSearch != 1){
			// $record = $database->SearchTracking($trackingNumber);
			// $count =  $database->num_rows($record);
			// if($count > 0){
			// 	echo $sheet->CreateDoctrackInfoPR($record);
			// }else{
			// 	echo "<span class = 'remark1'>No record found.</span>";
			// }

			// $record = $database->searchTrackingNumber2022($trackingNumber);
			// if(sizeof($record) > 0) {
			// 	echo $sheet->CreateDoctrackInfoPR($record);
			// }else{
			// 	echo "<span class = 'remark1'>No record found.</span>";
			// }

			
			$record = $database->searchTrackingNumber2022($trackingNumber);
			if(sizeof($record) > 0) {

				if($record['TrackingType'] == "PO"){
					// echo $sheet->CreateDoctrackInfoPR($record);
					echo $sheet->NewCreateDoctrackInfoPO($record);
				}elseif($record['TrackingType'] == "PX") {
					echo $sheet->NewCreateDoctrackInfoPX($record);
				}else{
					echo $sheet->CreateDoctrackInfoPR($record);
				}

			}else{
				echo "<span class = 'remark1'>No record found.</span>";
			}
		}
		
	}
	if(isset($_GET['forwardCTO'])){
		$type = $database->charEncoder($_GET['type']);
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		if($type == 'a'){
			$status = 'Forwarded to Admin - Operation';
		}else if($type == 'b'){
			$status = 'Forwarded to Admin - Administration';
		}else if($type == 'c'){
			$status = 'Forwarded to SP - Admin';
		}else{
			$status = 'Check Preparation - CTO';
		}
		$completion = '';
		
		$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		
		// $record = $database->SearchTracking($trackingNumber);

		// 11-02-2021 Update for Batch Tracking Children
		$database->updateBatchTrackingChildren($trackingNumber, $db, $status, $employeeNumber, $dateEncoded);

		$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
		$record1 = $database->FetchThis($sql);
		$data = $database->fetch_array($record1);
		$docType = $data['DocumentType'];

		if($docType == 'CASH ADVANCE TO PAYMASTER') {
			$database->sendUpdateForPaymasterBatch($year, $trackingNumber);
		}


		// echo $sheet->CreateDoctrackInfoPR($record);
		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	if(isset($_GET['forwardAdmin'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$completion = '';
		$status  = 'Forwarding to BAC';
		$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		
		// $record = $database->SearchTracking($trackingNumber);
		// echo $sheet->CreateDoctrackInfoPR($record);
		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {
			echo $sheet->CreateDoctrackInfoPR($record);
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	if(isset($_GET['revertAdmin'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$completion = '';
		$status  = 'Admin Received';
		$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status . " - Reverted",$completion); //insert sa new status	
		
		// $record = $database->SearchTracking($trackingNumber);
		// echo $sheet->CreateDoctrackInfoPR($record);
		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {
			echo $sheet->CreateDoctrackInfoPR($record);
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	// if(isset($_GET['ctoClaim'])){
		
	// 	$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
	// 	$encoded = $database->charEncoder($_GET['dateEncoded']);
		
	// 	$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 	$status = "Check Released";
		
	// 	$updateCase = "Completion = '" . $completion . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
	// 	$database->UpdateTrackingStatus($updateCase,$trackingNumber);
	// 	$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
	// 	$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		
	// 	$record = $database->SearchTracking($trackingNumber);

	// 	// 11-02-2021 Update for Batch Tracking Children
	// 	$database->updateBatchTrackingChildren($trackingNumber, $db, $status, $employeeNumber, $dateEncoded);

	// 	echo $sheet->CreateDoctrackInfoPR($record);
	// }

	if(isset($_GET['ctoClaim'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$encoded = $database->charEncoder($_GET['dateEncoded']);
		
		$completion =  str_replace(" ago","",$database->ezDate1($encoded));
		$status = "Check Released";
		
		$updateCase = "Completion = '" . $completion . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		
		// $record = $database->SearchTracking($trackingNumber);

		// 11-02-2021 Update for Batch Tracking Children
		$database->updateBatchTrackingChildren($trackingNumber, $db, $status, $employeeNumber, $dateEncoded);
		$database->paymasterClaim($year, $trackingNumber, $employeeNumber, $dateEncoded);

		$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
		$record1 = $database->FetchThis($sql);
		$data = $database->fetch_array($record1);
		$docType = $data['DocumentType'];

		if($docType == 'CASH ADVANCE TO PAYMASTER') {
			$database->sendUpdateForPaymasterBatch($year, $trackingNumber);
		}

		// echo $sheet->CreateDoctrackInfoPR($record);
		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
		
	}
	
	if(isset($_GET['prCTOforward'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		//$encoded = $database->charEncoder($_GET['dateEncoded']);
		
		$completion =  '';
		$status = "Forwarded to SP Admin - PR";
		
		$updateCase = "Completion = '" . $completion . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		
		// $record = $database->SearchTracking($trackingNumber);
		// echo $sheet->CreateDoctrackInfoPR($record);
		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {
			echo $sheet->CreateDoctrackInfoPR($record);
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	
	
	if(isset($_GET['ctoClaimRevert'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$completion = '';
		$status = "Check Advised";
		
		$updateCase = "Completion = '" . $completion ."', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = ': Reverted. Please see history for details.' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		//$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		$sql = "Insert into voucherhistory (TrackingNumber,ModifiedBy,DateModified,Status,Completion) values ('" . $trackingNumber . "','" . $employeeNumber . "','" . $dateEncoded . "','Reverted to " . $status . "','" . $completion . "')";
		$database->query($sql);
		
		
		// $record = $database->SearchTracking($trackingNumber);

		// 11-02-2021 Update for Batch Tracking Children
		$database->updateBatchTrackingChildren($trackingNumber, $db, $status, $employeeNumber, $dateEncoded);

		$database->paymasterUnclaim($year, $trackingNumber, $dateEncoded);

		$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
		$record1 = $database->FetchThis($sql);
		$data = $database->fetch_array($record1);
		$docType = $data['DocumentType'];

		if($docType == 'CASH ADVANCE TO PAYMASTER') {
			$database->sendUpdateForPaymasterBatch($year, $trackingNumber);
		}

		// echo $sheet->CreateDoctrackInfoPR($record);
		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}

		
	}
	if(isset($_GET['ctoClaimReProcess'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$completion = '';
		$status = "Check Preparation - CTO";
		
		$updateCase = "Completion = '" . $completion ."', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = ': Reprocess. Please see history for details.' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		//$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		$sql = "Insert into voucherhistory (TrackingNumber,ModifiedBy,DateModified,Status,Completion) values ('" . $trackingNumber . "','" . $employeeNumber . "','" . $dateEncoded . "','Reverted to " . $status . "','" . $completion . "')";
		$database->query($sql);
		
		
		// $record = $database->SearchTracking($trackingNumber);

		// 11-02-2021 Update for Batch Tracking Children
		$database->updateBatchTrackingChildren($trackingNumber, $db, $status, $employeeNumber, $dateEncoded);

		$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
		$record1 = $database->FetchThis($sql);
		$data = $database->fetch_array($record1);
		$docType = $data['DocumentType'];

		if($docType == 'CASH ADVANCE TO PAYMASTER') {
			$database->sendUpdateForPaymasterBatch($year, $trackingNumber);
		}

		// echo $sheet->CreateDoctrackInfoPR($record);
		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	
	if(isset($_GET['prCTOreceive'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		$completion = '';
		$status = "CTO Received";
		
		$updateCase = "Completion = '" . $completion ."', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		//$sql = "Insert into voucherhistory (TrackingNumber,ModifiedBy,DateModified,Status,Completion) values ('" . $trackingNumber . "','" . $employeeNumber . "','" . $dateEncoded . "','Reverted to " . $status . "','" . $completion . "')";
		//$database->query($sql);
		
		
		// $record = $database->SearchTracking($trackingNumber);
		// echo $sheet->CreateDoctrackInfoPR($record);

		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	
	if(isset($_GET['savePending'])){
		
		$value = $database->charEncoder($_GET['value']);
	
		$completion = '';
		$pendingNote = $database->charEncoder(urldecode($_GET['pendingNote']));
		$oldNote = $database->charEncoder(urldecode($_GET['oldNote']));
		
		if(substr($value,0,3) == "cbo"){
			$trackingNumber = str_replace("cboPending",'',$value);
			$status = "Pending at CBO";
			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CBO</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CBO</b></span>';
			}
			
			$sql = "Select BatchNumber from infra where trackingNumber = '" . $trackingNumber . "'";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			$updateCase = " Remarks = '" . $pendingNote . "',OBR_Approve = 0, Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			if($count == 0){
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}else{
				$data = $database->fetch_array($record);
				$batchNumber = $data['BatchNumber'];
				if(strlen($batchNumber) < 8){
					
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}else{
					$trackingNumberInsertCase = '';
					$trackingNumberUpdateCase = '';
					$sql = "Select TrackingNumber from infra where BatchNumber = '" . $batchNumber . "'";
					$record = $database->query($sql);
					while($data = $database->fetch_array($record)){
						$trackingNumberUpdateCase .= ",'" . $data['TrackingNumber'] . "'";
						$trackingNumberInsertCase .= "," . $data['TrackingNumber'];
					}
					$trackingNumberUpdateCase = substr($trackingNumberUpdateCase,1);
					
					$database->UpdateTrackingStatusIn($updateCase,$trackingNumberUpdateCase);
					$database->UpdateVoucherHistoryIn($trackingNumberUpdateCase);               //update para sa completion
					$database->InsertToVoucherHistoryIn($trackingNumberInsertCase,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}
			}
			
		}
		if(substr($value,0,3) == "cao"){
			$trackingNumber = str_replace("caoPending",'',$value);
			$status = "Pending at CAO";
			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CAO</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CAO</b></span>';
			}
			$updateCase = " Remarks = '" . $pendingNote . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			
			$sql = "Select BatchNumber from infra where trackingNumber = '" . $trackingNumber . "'";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			
			if($count == 0){
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}else{
				$data = $database->fetch_array($record);
				$batchNumber = $data['BatchNumber'];
				if(strlen($batchNumber) < 8){
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}else{
					$trackingNumberInsertCase = '';
					$trackingNumberUpdateCase = '';
					$sql = "Select TrackingNumber from infra where BatchNumber = '" . $batchNumber . "'";
					$record = $database->query($sql);
					while($data = $database->fetch_array($record)){
						$trackingNumberUpdateCase .= ",'" . $data['TrackingNumber'] . "'";
						$trackingNumberInsertCase .= "," . $data['TrackingNumber'];
					}
					$trackingNumberUpdateCase = substr($trackingNumberUpdateCase,1);
					$database->UpdateTrackingStatusIn($updateCase,$trackingNumberUpdateCase);
					$database->UpdateVoucherHistoryIn($trackingNumberUpdateCase);               //update para sa completion
					$database->InsertToVoucherHistoryIn($trackingNumberInsertCase,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}
			}
		}else if(substr($value,0,3) == "gso"){
			$trackingNumber = str_replace("gsoPending",'',$value);
			$status = "Pending at GSO";
			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>GSO</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>GSO</b></span>';
			}
			$updateCase = " Remarks = '" . $pendingNote . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if(substr($value,0,3) == "cto"){
			$trackingNumber = str_replace("ctoPending",'',$value);
			$status = "Pending at CTO";
			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CTO</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CTO</b></span>';
			}
			$updateCase = " Remarks = '" . $pendingNote . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if(substr($value,0,3) == "adm"){
			$trackingNumber = str_replace("admPending",'',$value);
			$status = "Pending at Admin";
			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' . $dateEncoded . ' - <b>Admin</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' . $dateEncoded . ' - <b>Admin</b></span>';
			}
			$updateCase = " Remarks = '" . $pendingNote . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			
			$sql = "Select BatchNumber from infra where trackingNumber = '" . $trackingNumber . "'";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			
			if($count == 0){
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}else{
				$data = $database->fetch_array($record);
				$batchNumber = $data['BatchNumber'];
				if(strlen($batchNumber) < 8){
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);
					$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
					$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}else{
					$trackingNumberInsertCase = '';
					$trackingNumberUpdateCase = '';
					$sql = "Select TrackingNumber from infra where BatchNumber = '" . $batchNumber . "'";
					$record = $database->query($sql);
					while($data = $database->fetch_array($record)){
						$trackingNumberUpdateCase .= ",'" . $data['TrackingNumber'] . "'";
						$trackingNumberInsertCase .= "," . $data['TrackingNumber'];
					}
					$trackingNumberUpdateCase = substr($trackingNumberUpdateCase,1);
					$database->UpdateTrackingStatusIn($updateCase,$trackingNumberUpdateCase);
					$database->UpdateVoucherHistoryIn($trackingNumberUpdateCase);               //update para sa completion
					$database->InsertToVoucherHistoryIn($trackingNumberInsertCase,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
				}
			}
		}else if(substr($value,0,3) == "bac"){
			$trackingNumber = str_replace("bacPending",'',$value);
			$status = "Pending at BAC";
			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' . $dateEncoded . ' - <b>BAC</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' . $dateEncoded . ' - <b>BAC</b></span>';
			}
			$updateCase = " Remarks = '" . $pendingNote . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if(substr($value,0,3) == "del"){
			$trackingNumber = str_replace("delPending",'',$value);
			$status = "Pending at Deliberation";
			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' . $dateEncoded . ' - <b>BAC</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' . $dateEncoded . ' - <b>BAC</b></span>';
			}
			$updateCase = " Remarks = '" . $pendingNote . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else if (substr($value,0,10) == "inspection") { // Inventory - Doctrack Status Flow

			$trackingNumber = str_replace("inspectionPending", '', $value);
			$status = "Pending at GSO - Inspection"; // Changes

			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - GSO</span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - GSO</span>';
			}
			$updateCase = " Remarks = '" . $pendingNote . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status

		}else if (substr($value,0,9) == "inventory") { // Inventory - Doctrack Status Flow

			$trackingNumber = str_replace("inventoryPending", '', $value);
			$completion	= '';				
			$status = "Pending at GSO - Inventory";
			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - GSO</span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - GSO</span>';
			}
			$updateCase = " Remarks = '" . $pendingNote . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "', Completion ='" . $completion . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
		}else if(substr($value,0,3) == "ceo"){
			$trackingNumber = str_replace("ceoPending",'',$value);
			$status = "Pending at CEO";
			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CAO</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CAO</b></span>';
			}
			$updateCase = " Remarks = '" . $pendingNote . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}
		
		
		// $record = $database->SearchTracking($trackingNumber);
		// $count =  $database->num_rows($record);
		// if($count > 0){
			
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }
			
		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}

	}
	if(isset($_GET['updateTracking1'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$status =  $database->charEncoder($_GET['status']);
		$trackType =  $database->charEncoder($_GET['tracktype']);

		if($status == "Pending at CBO"){
			$pr = substr($trackingNumber,0,2);
			$status = 'Pending Released - CBO';
			$completion =  '';
			$updateCase = " Status = '" . $status . 
						  "',ModifiedBy = '" . $employeeNumber . 
						  "',DateModified = '" . $dateEncoded . 
						  "',Completion = '" . $completion . "'";
			
		}else if($status == "Pending at CAO"){
			$completion =  '';
			$status = 'Pending Released - CAO';
			$updateCase = " Status = '" . $status . 
						  "',ModifiedBy = '" . $employeeNumber . 
						  "',DateModified = '" . $dateEncoded . 
						  "',Completion = '" . $completion . "' ";
			
		}else if($status == "Pending at GSO"){
			$completion =  '';
			$status = 'Pending Released - GSO';
			$updateCase = " Status = '" . $status . 
						  "',ModifiedBy = '" . $employeeNumber . 
						  "',DateModified = '" . $dateEncoded . 
						  "',Completion = '" . $completion . "' ";
			
		}else if($status == "Pending at CTO"){
			$completion =  '';
			$status = 'Pending Released - CTO';
			$updateCase = " Status = '" . $status . 
						  "',ModifiedBy = '" . $employeeNumber . 
						  "',DateModified = '" . $dateEncoded . 
						  "',Completion = '" . $completion . "' ";
			
		}else if($status == "Pending at Admin"){

			$completion =  '';
			$status = 'Pending Released - Admin';
			$updateCase = " Status = '" . $status . 
							"',ModifiedBy = '" . $employeeNumber . 
							"',DateModified = '" . $dateEncoded . 
							"',Completion = '" . $completion . "' ";
			
		}else if($status == "Pending at BAC"){
			$completion =  '';
			$status = 'Pending Released - BAC';
			$updateCase = " Status = '" . $status . 
						  "',ModifiedBy = '" . $employeeNumber . 
						  "',DateModified = '" . $dateEncoded . 
						  "',Completion = '" . $completion . "' ";
			
		}else if($status == "Pending at Deliberation"){
			$completion =  '';
			$status = 'Pending Released - Deliberation';
			$updateCase = " Status = '" . $status . 
						  "',ModifiedBy = '" . $employeeNumber . 
						  "',DateModified = '" . $dateEncoded . 
						  "',Completion = '" . $completion . "' ";
		}else if ($status == "Pending at GSO - Inspection" || $status == "Pending at GSO - Voucher(Inspection)") { // Inventory - Doctrack Status Flow
			$completion =  '';
			$status = 'Pending Released - Inspection';
			$updateCase = " Status = '" . $status . 
						  "',ModifiedBy = '" . $employeeNumber . 
						  "',DateModified = '" . $dateEncoded . 
						  "',Completion = '" . $completion . "' ";

		}else if ($status == "Pending at GSO - Inventory" || $status == "Pending at GSO - Voucher(Inventory)") { // Inventory - Doctrack Status Flow
			$completion =  '';
			$status = 'Pending Released - Inventory';
			$updateCase = " Status = '" . $status . 
						  "',ModifiedBy = '" . $employeeNumber . 
						  "',DateModified = '" . $dateEncoded . 
						  "',Completion = '" . $completion . "' ";
		}else if($status == "Pending at CEO"){
			$completion =  '';
			$status = 'Pending Released - CEO';
			$updateCase = " Status = '" . $status . 
						  "',ModifiedBy = '" . $employeeNumber . 
						  "',DateModified = '" . $dateEncoded . 
						  "',Completion = '" . $completion . "' ";	
		}
		
		$sql = "Select BatchNumber from infra where trackingNumber = '" . $trackingNumber . "'";
		$record = $database->query($sql);
		$count = $database->num_rows($record);
		if($count == 0){
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		}else{
			$data = $database->fetch_array($record);
			$batchNumber = $data['BatchNumber'];
			if(strlen($batchNumber) < 8){
				
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}else{
				$trackingNumberInsertCase = '';
				$trackingNumberUpdateCase = '';
				$sql = "Select TrackingNumber from infra where BatchNumber = '" . $batchNumber . "'";
				$record = $database->query($sql);
				while($data = $database->fetch_array($record)){
					$trackingNumberUpdateCase .= ",'" . $data['TrackingNumber'] . "'";
					$trackingNumberInsertCase .= "," . $data['TrackingNumber'];
				}
				$trackingNumberUpdateCase = substr($trackingNumberUpdateCase,1);
				
				$database->UpdateTrackingStatusIn($updateCase,$trackingNumberUpdateCase);
				$database->UpdateVoucherHistoryIn($trackingNumberUpdateCase);               //update para sa completion
				$database->InsertToVoucherHistoryIn($trackingNumberInsertCase,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
			}
		}
		
		/*$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); */
		
		
		
		
		
		
		// $record = $database->SearchTracking($trackingNumber);
		// $count =  $database->num_rows($record);
		// if($count > 0){
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	if(isset($_GET['countControlNumber'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		//$record = $database->SearchByTrackingNumber($trackingNumber);
		$sql = "Select Year,Fund,ClaimType from vouchercurrent where trackingnumber = '" . $trackingNumber . "'";
		$record = $database->FetchThis($sql);
		$data = $database->fetch_array($record);
		$fund = strtoupper($data['Fund']);
		$year = $data['Year'];
		$claimType = $data['ClaimType'];
		//$dt = strtotime("+8 hours");
		//$date = date('Y-m-d', $dt);
		$dt = time();
		$today = date('Y-m-d', $dt);
		
		$data  =  $database->fetch_array($database->CountControl($fund,$claimType,$today));
		echo $data['ctrl'] + 1;
		
		
	}
	if(isset($_GET['saveControl'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$ctrlNo = $database->charEncoder($_GET['ctrlNo']);
		$encoded = $database->charEncoder($_GET['encoded']);
		
		$status = 'CAO Released';
		$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	
		$updateCase = " ControlNo = '" . $ctrlNo . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',Completion = '" . $completion . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);              
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		
		/*$record = $database->SearchByTrackingNumber($trackingNumber);
		echo $sheet->CreateDoctrackInfo($record);	*/	
		
		$record = $database->SearchTracking($trackingNumber);
		$count =  $database->num_rows($record);
		if($count > 0){
			echo $sheet->CreateDoctrackInfoPR($record);
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	if(isset($_GET['skipAndSave'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$encoded = $database->charEncoder($_GET['encoded']);
		$ctrlNo =  $database->charEncoder($_GET['ctrlNo']);
		if($ctrlNo == 0){
			$ctrlNo = 0;
		}else if($ctrlNo == 1){
			$ctrlNo = 1;
		}else{
			$ctrlNo =  $_GET['ctrlNo'] - 1;
		}
		$status = 'CAO Released';
		$completion =  str_replace(" ago","",$database->ezDate1($encoded));
		$updateCase = " ControlNo = '" . $ctrlNo . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',Completion = '" . $completion . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);              
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		
		/*$record = $database->SearchByTrackingNumber($trackingNumber);
		echo $sheet->CreateDoctrackInfo($record);	*/

		// $record = $database->SearchTracking($trackingNumber);
		// $count =  $database->num_rows($record);
		// if($count > 0){
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {
			echo $sheet->CreateDoctrackInfoPR($record);
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	
	if(isset($_GET['editField'])){
		
		$trackingNumber =  $database->charEncoder($_GET['trackingNumber']);
		$field = $database->charEncoder($_GET['field']);
		$value = $database->charEncoder(urldecode($_GET['value']));
		$oldValue = $database->charEncoder($_GET['oldValue']);
		$state = 1;
		if($field == "OBR_Number"){
			
			$sql = "Select BatchNumber from infra where trackingNumber = '" . $trackingNumber . "'";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			
			if($count == 0){
				$case = "Update vouchercurrent set  OBR_Number ='" . $value . "' where trackingNumber  = '" . $trackingNumber . "'";
				$database->UpdateInsertTransfer($case);
				$state = 1;
			}else{
				$data = $database->fetch_array($record);
				$batchNumber = $data['BatchNumber'];
				if(strlen($batchNumber) < 8){
					
					
					$case = "Update vouchercurrent set  OBR_Number ='" . $value . "' where trackingNumber  = '" . $trackingNumber . "'";
					$database->UpdateInsertTransfer($case);
					$state = 1;
				}else{
					$trackingNumberInsertCase = '';
					$trackingNumberUpdateCase = '';
					$sql = "Select TrackingNumber from infra where BatchNumber = '" . $batchNumber . "'";
					$record = $database->query($sql);
					while($data = $database->fetch_array($record)){
						$trackingNumberUpdateCase .= ",'" . $data['TrackingNumber'] . "'";
						$trackingNumberInsertCase .= "," . $data['TrackingNumber'];
					}
					$trackingNumberUpdateCase = substr($trackingNumberUpdateCase,1);
					$sql = "Update vouchercurrent set  OBR_Number ='" . $value . "' where trackingNumber  in (" . $trackingNumberUpdateCase . ")";
					$database->query($sql);
				}
			}
			$database->EditLogs($batchNumber,$field,$oldValue,$value,$_SESSION['officeCode'], $_SESSION['fullName'],$dateEncoded);	
			
			
		}if($field == "NetAmount"){
			
			$sql = "Select TrackingType,PeriodType  from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$trackType = $data['TrackingType'];
			$periodType = $data['PeriodType'];
			
			$value = preg_replace('/[,]/', '', $value);
			
			if($trackType == 'PY'){
				if($periodType == 1){
					$updateCase = " " . $field  . " = '" . $value . "',PayrollAmountFirst=" . $value  . "";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);	
					$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
				}else if($periodType == 2){
					$updateCase = " " . $field  . " = '" . $value . "',Amount=" . $value  . "";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);	
					$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
				
				}else{
					$updateCase = " " . $field  . " = '" . $value . "'";
					$database->UpdateTrackingStatus($updateCase,$trackingNumber);	
					$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
				}
			}else if($trackType == 'PO'){
				$updateCase = " " . $field  . " = '" . $value . "'";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);	
				$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
			}else if($trackType == 'NF'){
				$updateCase = " " . $field  . " = '" . $value . "'";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);	
				$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
			}	
			
		}else if($field == "Adv1"){
			$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
			$record = $database->FetchThis($sql);
			$data = $database->fetch_array($record);
			
			$fund = $data['Fund'];
			$year = $data['Year'];
			$record = $database->FetchByAdv($value,$fund,$year); 
			$count = $database->num_rows($record);
			if($count > 0){
				$state = 0;
				$data = $database->fetch_array($record);
				echo '*' . $data['TrackingNumber'];
				
			}else{
				$updateCase = " " . $field  . " = '" . $value . "'";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$state = 1;
				$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
			}
		}else if($field == "LTO"){
			
			$updateCase = "Doctrack = Doctrack + 1";
			$database->IncrementTrackingSeries($updateCase,$office);
			
			//pagkuha sa new seq
			$condition = "where code = '" . $office . "' limit 1";
			$record = $database->FetchDoctrackID("Doctrack",$condition);
			$data = $database->fetch_array($record);
			$newTrackingNumber = $office . '-' . $data['Doctrack'];
			
			
			$sql = "Select *  from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$year = $data['Year'];
			
			$trackType = $data['TrackingType'];
			$fund = $data['Fund'];
			$adv = $data['ADV1'];
			$claimType = $data['ClaimType'];
			$periodType = $data['PeriodType'];
			$periodMonth = $data['PeriodMonth'];
			
			$claimant = "LAND TRANSPORTATION OFFICE";
			$docType ="LTO COMPUTER FEE";
			
			$periodType = $data['PeriodType'];
			$amount = $data['Amount'] - $value;
			
			$chargeType = 1;
			
			
			$status = "CAO Released";
			$insertCase = "(" . $year . ",'" . $office . "', 'PY','" . $claimType . "','" . $claimant . "','" . $fund . "','" . $docType . "','" . $newTrackingNumber . "','" . $amount . "','" . $periodType . "','" . $periodMonth . "','" .  
							$employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "','" . $dateEncoded . "'," . $chargeType . ",'"  . $trackingNumber . "', " . $adv . ",'" . $amount . "')";
			
				

			$sql = "Insert into vouchercurrent (Year,Office,TrackingType,ClaimType,Claimant,Fund,DocumentType,TrackingNumber,Amount,PeriodType,PeriodMonth,EncodedBy,DateEncoded,Status,DateModified,ChargeType,TrackingPartner,ADV2,NetAmount) VALUES " . $insertCase; 
			
			$database->query($sql);
			
			$database->InsertToVoucherHistory($newTrackingNumber,$employeeNumber,$dateEncoded,$status,"LTO Partner");
			$docType ="LTO REGISTRATION";
			$updateCase = "NetAmount = " . $value . ", TrackingPartner= '" . $newTrackingNumber . "',DocumentType = '" . $docType . "',Claimant = 'LAND TRANSPORTATION OFFICE' ";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);	
			$state = 1;
			
			$sql = "Insert into particulars (trackingnumber)values ('" . $newTrackingNumber  . "')";
			$database->query($sql);
			
		}else if($field == "ComputerFee"){
			$arrayAmount =  explode("~", $oldValue);
			$oldValue = $arrayAmount[0];
			$obrTotal = $arrayAmount[1];
			$net2 = $obrTotal - $value;
			
			$arrayTracking =  explode("~", $trackingNumber);
			$trackingNumber =  $arrayTracking[0];
			$trackingPartner =  $arrayTracking[1];
			
			$updateCase = "NetAmount = " . $value . "";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);	
			$database->EditLogs($trackingNumber,"NetAmount",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);	
			
			$updateCase = "NetAmount = " . $net2 . ",Amount =" . $net2 .  "";
			$database->UpdateTrackingStatus($updateCase,$trackingPartner);	
		
		}else if($field == "BatchNumber"){
			
			$sql = "Update infra set BatchNumber = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"BatchNumber",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);	
			
		}else if($field == "Location"){
			
			$sql = "Update infra set Location = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Location",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);	
			
		}else if($field == "Duration"){
			
			$sql = "Update infra set Duration = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Duration",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);	
			
		}else if($field == "Remarks"){
			$sql = "Update infra set Remarks = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Remarks",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "Mode"){
			$sql = "Update infra set Mode = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Mode",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "OfficeAssigned"){
			$sql = "UPDATE particulars SET OfficeAssigned = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"OfficeAssigned",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "CashRelease"){
			$sql = "UPDATE particulars SET CashRelease = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"OfficeAssigned",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "Window") {
			$sql = "UPDATE particulars SET `Window` = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);

			$sql = "UPDATE chequerist.paymaster SET PMWindow = '".$value."' WHERE PMTrackYear = '".$year."' AND PMTrackingNumber = '".$trackingNumber."'";
			$database->query($sql);

			$database->EditLogs($trackingNumber,"Window",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "Started") {
			$sql = "UPDATE infra SET Started = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Window",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "Completed") {
			$sql = "UPDATE infra SET Completed = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Window",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "Programmer") {
			$sql = "UPDATE infra SET Programmer = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Window",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "Inspector") {
			$sql = "UPDATE infra SET Inspector = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Window",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "Extension") {
			$sql = "UPDATE infra SET Extension = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Window",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "Barangay") {
			$sql = "UPDATE infra SET Barangay = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Window",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "Claimant"){
			$sql = "Select DocumentType from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$docType = $data['DocumentType'];
			if($docType == 'CASH ADVANCE TO PAYMASTER') {
				$sql = "UPDATE chequerist.paymaster SET PMClaimant = '".$value."' WHERE PMTrackYear = '".$year."' AND PMTrackingNumber = '".$trackingNumber."'";
				$database->query($sql);
			}

			$updateCase = " " . $field  . " = '" . $value . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
			
		}else if($field == "VariationOBR") {
			$sql = "UPDATE infra SET variationOBR = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Window",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "DocumentType") {

			$updateCase = " " . $field  . " = '" . $value . "'";
			if($value == 'BENEFITS - TERMINAL LEAVE') {
				$updateCase .= ", Complex = '2'";
			}

			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			
			$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
		}else if($field == "PoDate") {
			$sql = "UPDATE particulars SET PoDate = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else if($field == "InvoiceNumber") {

			$sql = "UPDATE particulars SET InvoiceNumber = '".$value."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);

		}else if($field == "InvoiceDate") {

			$sql = "UPDATE particulars SET InvoiceDate = '".$value."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);

		}else if($field == "ModeOfProcurement") {

			$perm = $_SESSION['perm'];

			if($value == 5 || $value == 12 || $value == 18) {
				$sql = "UPDATE vouchercurrent SET ModeOfProcurement = '".$value."', PaymentTerm = '3' WHERE TrackingNumber = '".$trackingNumber."'";
			}else {
				if($oldValue == 'Agency to Agency' || $oldValue == 'Postal Office' || $oldValue == 'Agency to Agency (DBM)') {
					$sql = "UPDATE vouchercurrent SET ModeOfProcurement = '".$value."', PaymentTerm = NULL WHERE TrackingNumber = '".$trackingNumber."'";
				}else {
					$sql = "UPDATE vouchercurrent SET ModeOfProcurement = '".$value."' WHERE TrackingNumber = '".$trackingNumber."'";
				}
			}

			$database->query($sql);
			$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
			
		}else if($field == "AccountNumber") {

			$sql = "UPDATE particulars SET AccountNumber = '".$value."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);

		}else if($field == "GasPeriod") {

			$sql = "UPDATE vouchercurrent SET PeriodMonth = '".trim($value)."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);

		}else if($field == "VariationOBR2") {
			$sql = "UPDATE infra SET variationOBR2 = '" . $value . "'  where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"VariationOBR2",$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);		
		}else{
			if($field == "Amount"){
				$value = preg_replace('/[,]/', '', $value);
			}

			$updateCase = " " . $field  . " = '" . $value . "'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			
			$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
		}
		
		
		if($state == 1){
			// $record = $database->SearchTracking($trackingNumber);
			// $count =  $database->num_rows($record);
			// if($count > 0){
			// 	echo $sheet->CreateDoctrackInfoPR($record);
			// }else{
			// 	echo "<span class = 'remark1'>No record found.</span>";
			// }

			// $record = $database->searchTrackingNumber2022($trackingNumber);
			// if(sizeof($record) > 0) {
			// 	echo $sheet->CreateDoctrackInfoPR($record);
			// }else{
			// 	echo "<span class = 'remark1'>No record found.</span>";
			// }

			$record = $database->searchTrackingNumber2022($trackingNumber);
			if(sizeof($record) > 0) {

				if($record['TrackingType'] == "PO"){
					// echo $sheet->CreateDoctrackInfoPR($record);
					echo $sheet->NewCreateDoctrackInfoPO($record);
				}elseif($record['TrackingType'] == "PX") {
					echo $sheet->NewCreateDoctrackInfoPX($record);
				}else{
					echo $sheet->CreateDoctrackInfoPR($record);
				}

			}else{
				echo "<span class = 'remark1'>No record found.</span>";
			}
		}
		
	}
	if(isset($_GET['editFieldAmount'])){
		$trackingNumber =  $database->charEncoder($_GET['trackingNumber']);
		$record = $database->SearchByTrackingNumber($trackingNumber);
		//echo $sheet->CreateDoctrackInfo($record);	
		echo $sheet->CreateEditorOBR($record);
		
	}
	if(isset($_GET['saveEditorAmounts'])){
		$ids = explode('~',$_GET['ids']);
		$amounts = explode('~',$_GET['amounts']);
		$codes = explode('~',$_GET['codes']);
		$total = $_GET['total'];
		$trackingNumber = $_GET['trackingNumber'];
		
		if(sizeof($ids)-1 == 1){
			$total = 0;
		}
		for($i = 0; $i <  sizeof($ids)-1; $i++){
			$database->UpdateEditOBRs($codes[$i],$amounts[$i],$total,$ids[$i]);
		}
		$record = $database->SearchByTrackingNumber($trackingNumber);
		echo $sheet->CreateDoctrackInfo($record);	
	}
	
	
	
	//----------------------------------------------------------------------slp
	if(isset($_GET['saveSLP'])){
		$skipSearch = 0;
		$slpType = $database->charEncoder($_GET['slpType']);

			$completion = '';
			if($slpType == 1){
				$netAmount = $_GET['netAmount'];
				$trackingNumber = $_GET['trackingNumber'];
				$payeeNumber = $_GET['payeeNumber'];	
			
				$updateCase = " PayeeNumber = '" . $payeeNumber . "',PayrollAmountFirst = '" . $netAmount . "',PeriodType = 3, ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',NetAmount= '" . $netAmount . "'";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);              
				
				$status = 'CAO - SLP';  
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
					
			}else{
				$trackingNumber = $_GET['trackingNumber'];
				$netAmount1 = $_GET['netAmount1'];
				$netAmount2 = $_GET['netAmount2'];
				$payeeNumber = $_GET['payeeNumber'];	
				
				$record = $database->SearchTracking($trackingNumber);
				$data = $database->fetch_array($record);
				
				$claimant =  $database->charEncoder($data['Claimant']);
				$docType = $data['DocumentType'];
				$claimType = $data['ClaimType'];
				$periodMonth = $data['PeriodMonth'];
				$fund = $data['Fund'];
				$adv =$data['ADV1'];
				$chargeType = $data['ChargeType'];
				if($chargeType >= 2){
					$tAmount =   $data['TotalAmountMultiple']; 
				}else{
					$tAmount =   $data['Amount']; 
				}
				$updateCase = "Doctrack = Doctrack + 1";
				$officeSaGiSLP = substr($trackingNumber,0,4);
				$database->IncrementTrackingSeries($updateCase,$officeSaGiSLP); //i update ang doctrack sequence
				
				//pagkuha sa new seq
				$condition = "where code = '" . $officeSaGiSLP . "' limit 1";
				$record = $database->FetchDoctrackID("Doctrack",$condition);
				$data = $database->fetch_array($record);
				//$trackingNumber = $office . '-' . $data['Doctrack'];
				$newTrackingNumber = $officeSaGiSLP . '-' . $data['Doctrack']; 
				
				
				
				//pagsave sa record sa update slp 1
				$status = 'CAO - SLP 1';  
				$updateCase = " PayrollAmountFirst = '" . $netAmount1  . "',PayrollAmountSecond = '" . $netAmount2  .
							  "',TrackingPartner = '" . $newTrackingNumber  .
							  "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',PayeeNumber ='" . $payeeNumber  . "', PeriodType = 1,NetAmount= '" . $netAmount1 . "'";
				
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
				
				
				$status = "Encoded";
				$insertCase = "('" . $year . "','" . $officeSaGiSLP . "','PY','" . $claimType . "','" . $claimant . "','" . $fund . "','" . 
								$docType . "','" .  $newTrackingNumber . "'," .  $netAmount2 . ",'2','" .  $periodMonth . "','" .  
								$employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "','" . 
								$dateEncoded . "'," . $chargeType . ",'"  . $trackingNumber . "','"  . $payeeNumber . "',0,'" . $netAmount2 . "')";
					
				$database->SaveTrackingPYSLP2($insertCase);
				$database->InsertToVoucherHistory($newTrackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
				
				$sql = "Insert into particulars (trackingnumber)values ('" . $newTrackingNumber  . "')";
				$database->query($sql);
				
			}	
			
			$record = $database->SearchTracking($trackingNumber);
			$count =  $database->num_rows($record);
			if($count > 0){
				echo $sheet->CreateDoctrackInfoPR($record);
			}else{
				echo "<span class = 'remark1'>No record found.</span>";
			}
	}
	if(isset($_GET['saveSLP1'])){
		$skipSearch = 0;
		$slpType = $database->charEncoder($_GET['slpType']);
		$advNumber = $database->charEncoder($_GET['advNumber']);
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$halfAmount = $database->charEncoder($_GET['halfAmount']);
		
		$record = $database->SearchByTrackingNumber($trackingNumber);
		$data = $database->fetch_array($record);
		
		$fund = $data['Fund'];
		$year = $data['Year'];
		$transType = 'Voucher';
		
		
		$completion ='';
		$count = $database->num_rows($database->FetchByAdv($advNumber,$fund,$year));
		if($count > 0){
			$skipSearch = 1;
			echo '~' . $advNumber;
		}else{
			if($slpType == 1){
				$status = 'CAO On Process'; 
				$updateCase = " ADV2 = '" . $advNumber . "',claimant = concat(claimant,' - SLP'),transactionType = '" . $transType . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);               
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
			}else{
			
				$claimType =  $data['ClaimType']; 
				$periodType = $data['PeriodType'];
				$periodValue = $data['PeriodMonth'];
				$trackType = 'PY';
				$program = $data['PR_ProgramCode'];
				$chargeType = $data['ChargeType'];
				
				$amountMultiple = $data['TotalAmountMultiple']; 
				if($amountMultiple == 0){
					$amountMultiple = 0;
				}
				
				if($chargeType == 2){
					$accountCode = 'multiple';
					$tAmount =   $data['TotalAmountMultiple']; 
				}else{
					$tAmount =   $data['Amount']; 
					$accountCode = $data['PR_AccountCode'];
				}
				$claimant =   $data['Claimant'] . ' - SLP 2';
				
				
				$secondAmount = ($tAmount - $halfAmount);
				$office = $data['Office'];
				$encodedBy = $data['EncodedBy'];
				
				$dateEncodedOld = $data['DateEncoded'];
				
				$year = $data['Year'];
				
				
				$updateCase = "Doctrack = Doctrack + 1";
				$database->IncrementTrackingSeries($updateCase,$office);
				
				//pagkuha sa new seq
				$condition = "where code = '" . $office . "' limit 1";
				$record = $database->FetchDoctrackID("Doctrack",$condition);
				$data = $database->fetch_array($record);
				//$trackingNumber = $office . '-' . $data['Doctrack'];
				$newTrackingNumber = $office . '-' . $data['Doctrack']; 
				
				//pagsave sa record
				$status = 'CAO on Process'; 
				$updateCase = " ADV2 = '" . $advNumber . "',claimant = concat(claimant,' - SLP 1'),PayrollAmountFirst = '" . $halfAmount  . 
				              "',PayrollAmountSecond = '" . $secondAmount  . "' ,transactionType = '" . $transType .
							  
							  "',TrackingPartner = '" . $newTrackingNumber  .
							   "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
				
				$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateVoucherHistory($trackingNumber);
				$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
				
				
				$status = "CAO Received";
				$insertCase = "('" . $year . "','" . $office . "','" . $trackType . "','" . 
				                       $claimType . "','" . $claimant . "','" . $fund . "','" . 
									   $transType . "','" .  $newTrackingNumber . "','" . $program . "','" . 
									   $accountCode . "'," .  $secondAmount . ",'" . $periodType . "','" .  $periodValue . "','" .  
									   $encodedBy . "','" .  $dateEncoded . "','" .  $status .  "','" . $employeeNumber . "','" .  
									   $dateEncoded . "'," . $chargeType . "," . $tAmount . ",'" . $trackingNumber . "'," . $amountMultiple . ")";
					
				$database->SaveTrackingPYSLP2($insertCase);
				$database->InsertToVoucherHistory($newTrackingNumber,$employeeNumber,$dateEncoded,$status,$completion);

			}
			
			
		}	
		if($skipSearch != 1){
			$record = $database->SearchByTrackingNumber($trackingNumber);
			echo $sheet->CreateDoctrackInfo($record);
		}
		
	}
	//-------------------------------------------------------------------------------------------- appropriation status
	
	if(isset($_GET['loadApproriationStatus'])){
		if($_SESSION['accountType'] == 1){
			$record = $database->LoadAppropriationStatus($defaultYear,$office);
			echo $sheet->CreateAppropriationStatus($record);
		}else{
			echo "<div style ='padding:30px;'>Select or type office.</div>";
		}
		
	}
	if(isset($_GET['fundBreakdown'])){
		$officeCode = $database->charEncoder($_GET['officeCode']);
		$program = $database->charEncoder($_GET['program']);
		$fundName = $database->charEncoder($_GET['fundName']);
	
		$record = $database->FetchAppropriationStatusByFund($defaultYear,$officeCode,$program,$fundName);
		echo $sheet->CreateAppropriationStatusbyFund($record);
	}
	//-------------------------------------------------------------------------------------------- tracker
	if(isset($_GET['loadTracker'])){
		$record = $database->LoadTracker();
		echo $sheet->CreateTrackerData($record);
	}
	if(isset($_GET['loadTrackerOffice'])){
		$record =  $database->GetOffice();	
		echo $sheet->CreateOfficeSelectTracker($record);
		
	}
	
	if(isset($_GET['fetchVoucherBy'])){
		$searchType = $database->charEncoder($_GET['searchType']);
		if($searchType == 'selectOffice'){
			$officeCode = $database->charEncoder($_GET['officeCode']);	
			if($officeCode == 'all'){
				$condition = " where Office != '" . $officeCode . "'";
				$record = $database->FethVoucherByCondition($condition);
			}else{
				$condition = " where Office = '" . $officeCode . "'";				
				$record = $database->FethVoucherByCondition($condition);
			}
		}else if($searchType == 'ClaimOffice'){
			$value = strtoupper($database->charEncoder($_GET['value']));	
			if(substr($value,4,1) == '-' ){
				$condition = " where TrackingNumber = '" . $value . "'";
			}else if(substr($value,0,3) == "PR-"){
				$condition = " where TrackingNumber = '" . $value . "'";
			}else{
				$condition = " where Claimant like '%" . $value . "%'";
			}
			$record = $database->FethVoucherByCondition($condition);	
		}else if($searchType == 'Status'){
			$officeCode = $database->charEncoder($_GET['officeCode']);
			$value = strtoupper($_GET['value']);	
			echo $officeCode;
			if($officeCode == 'all' || $officeCode == ''){
				$condition = " where Status = '" . $value . "'";
				$record = $database->FethVoucherByCondition($condition);
			}else{
				$condition = " where Office = '" . $officeCode . "' and Status = '" . $value . "'";
				$record = $database->FethVoucherByCondition($condition);
				
			}	
		}else if($searchType == 'ClaimType'){
			$officeCode = $database->charEncoder($_GET['officeCode']);
			$value = strtoupper($_GET['value']);
			if($officeCode == 'all' || $officeCode == ''){
				$condition = " where ClaimType = '" . $value . "'";
				$record = $database->FethVoucherByCondition($condition);
			}else{
				$condition = " where Office = '" . $officeCode . "' and ClaimType = '" . $value . "'";
				$record = $database->FethVoucherByCondition($condition);
				
			}	
		}
		$count = $database->num_rows($record);
		if($count > 0){
			echo $sheet->CreateTrackerData($record);
		}else{
			echo "<div class = 'label3' style ='text-align:center;padding:20px;'>No record found.</div>";
		}
	}
	if(isset($_GET['fetchVoucherFromMain'])){
		$accountType = $_SESSION['accountType'];
		if($accountType > 1){
			$officeCode = 'all';
			if($_SESSION['cbo'] == 'LING'){
				$officeCode = 'LING';
			}
		}else{
			$officeCode = $_SESSION['cbo'];
		}
		$value = $database->charEncoder($_GET['value']);
		
		if($officeCode == 'all' || $officeCode == ''){
			$condition = " WHERE Status = '" . $value . "'";
		}else{
			$condition = " WHERE Office = '" . $officeCode . "' and  Status = '" . $value . "'";
		}

			 
		// $sql = "SELECT a.Id,
		// 					a.TrackingType,
		// 					a.Status,
		// 					a.Claimant,
		// 					a.checknumber,
		// 					a.DocumentType,
		// 					a.PR_CategoryCode,
		// 					a.ClaimType,
		// 					a.Amount,
		// 					a.PO_Amount,
		// 					a.TotalAmountMultiple,
		// 					a.TrackingNumber,
		// 					a.OBR_Number,
		// 					a.PO_Number,
		// 					a.PR_Number,
		// 					a.ADV1,
		// 					a.ADV2,
		// 					a.DateEncoded,
		// 					a.DateModified,
		// 					a.Completion,
		// 					a.PeriodType,
		// 					a.PeriodMonth,
		// 					a.PR_Month,
		// 					'' as Name ,
		// 					'' as Fund
		// 					FROM vouchercurrent a  " . $condition . " group by TrackingNumber order by id desc limit 40";	
		$sql = "SELECT * FROM vouchercurrent ".$condition." GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 40";
		$record = $database->query($sql);
		$countOne = $database->num_rows($record);
		if($countOne  == 1){
			$data = $database->fetch_array($record);
			$trackingNumber = $data['TrackingNumber'];
			$record = $database->searchTrackingNumber2022($trackingNumber);
			if(sizeof($record) > 0) {
				echo $sheet->CreateDoctrackInfoPR($record);
			}else{
				echo "<span class = 'remark1'>No record found.</span>";
			}
		}else{ // updated code - 06-10-2022
			$ctr = 1;
			$prime = 0;
			$id = 0;
			// echo $sheet->CreateListResultPrivate($record,$officeCode,$value,0,$countOne,$ctr,$id,$prime);	
			$newRecord = [];
			while ($data = $database->fetch_array($record)) {
				$color = '';
				$period = '';
				$thisId  = $data['Id'];
				// $office = $data['Name'];
				$office = '';
				$type = $data['TrackingType'];
				$status = $data['Status'];
				$claimant = strtoupper($data['Claimant']);
				$check = $data['checknumber'];
				
				$docType = $data['DocumentType'];
				$doc = explode("-",$docType);
				if(sizeof($doc) == 1 ){
					$doc[1] = $docType;
				}
				$category = $data['PR_CategoryCode'];
				if($type == 'PR'){
					$docType = 'Purchase Request';
					$doc[1] = $category;
				}

				$fund = $data['Fund'];
				$claimType = $data['ClaimType'];
				
				$amount  = $data['Amount'];
				if($data['PO_Amount']> 0){
					$amount = $data['PO_Amount'];
				}
				if($data['TotalAmountMultiple'] > 0){
					$amount = $data['TotalAmountMultiple'];
				}
				
				
				$tn = $data['TrackingNumber'];
				$obr = $data['OBR_Number'];
				$po = $data['PO_Number'];
				$pr = $data['PR_Number'];
				$adv = $data['ADV1'];
				if($adv == 0){
					$adv = $data['ADV2'];
					if($adv == 0){
						$adv = '';
						}
				}
				
				
				$dateEncoded = $data['DateEncoded'];
				$dateModified = $data['DateModified'];
				$completion = $data['Completion'];
				$periodType = $data['PeriodType']; 
				$periodMonth= $data['PeriodMonth'];
				$encodedBy = '';
				if($type == 'PY'){
					
					if($periodType == 1){
						$period =  '(1 -15)';
					}else if ($periodType == 2){
						if(strtoupper($periodMonth) == "FEBRUARY"){
							$period =  ' (16 - 28)';
						}else{
							$period =  ' (16 - 31)';
						}
					}else if($periodType == 4){
						$period =  '(1 -15)';
					}else if ($periodType == 5){
						if(strtoupper($periodMonth) == "FEBRUARY"){
							$period =  ' (16 - 28)';
						}else{
							$period =  ' (16 - 31)';
						}
					}else{
						$period = "";
					}
				}else {
					$period =  $database->numberToQuarter($data['PR_Month']);
					$period  =  "";
				}

				$newRecord[$tn]['Id'] = $thisId;
				$newRecord[$tn]['OfficeName'] = $office;
				$newRecord[$tn]['TrackingType'] = $type;
				$newRecord[$tn]['Status'] = $status;
				$newRecord[$tn]['Claimant'] = $claimant;
				$newRecord[$tn]['checknumber'] = $check;
				$newRecord[$tn]['DocumentType'] = $doc[1];
				$newRecord[$tn]['Fund'] = $fund;
				$newRecord[$tn]['ClaimType'] = $claimType;
				$newRecord[$tn]['Amount'] = $amount;
				$newRecord[$tn]['TrackingNumber'] = $tn;
				$newRecord[$tn]['OBR_Number'] = $obr;
				$newRecord[$tn]['PO_Number'] = $po;
				$newRecord[$tn]['PR_Number'] = $pr;
				$newRecord[$tn]['ADV'] = $adv;
				$newRecord[$tn]['DateEncoded'] = $dateEncoded;
				$newRecord[$tn]['DateModified'] = $dateModified;
				$newRecord[$tn]['Completion'] = $completion;
				$newRecord[$tn]['EncodedBy'] = $encodedBy;
				$newRecord[$tn]['Period'] = $period;
				$newRecord[$tn]['PeriodMonth'] = $periodMonth;
			}
			
			echo $sheet->CreateListResultPrivate2022($newRecord,$value,$countOne,$ctr,$id,$prime);
		}

		

		
	}
	if(isset($_GET['loadClaimType'])){
		$record =  $database->FetchClaimType();	
		echo  $sheet->CreateClaimTypeOptions($record);
	}
	if(isset($_GET['receiveDocument'])){
		if($_SESSION['accountType'] == 2 &&  $_SESSION['officeCode'] == '1071'){
			$status = 'CBO Received';
		}else if($_SESSION['accountType'] == 4 &&  $_SESSION['officeCode'] == '1081'){
			$status = 'CAO Received';
		}
		
		$updateCase = $database->charEncoder($_GET['updateCase']);
		$updateHistory  = $database->charEncoder($_GET['updateHistory']);
		
		
		//update sa status
		$database->UpdateToReceive($defaultYear,$employeeNumber,$dateEncoded,$status,$updateCase);
		
		//update sa history
		$database->UpdateHistory($updateHistory);
		
		//insert to history
		$trackings = $database->charEncoder($_GET['trackings']);
		$tracks = explode("~", $trackings);
		$insertCase ='';
		for($i = 0; $i < sizeof($tracks); $i++){
			$insertCase .=  ",('" . $tracks[$i]  . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "')";
		}
		$insertCase = substr($insertCase,1, strlen($insertCase));
		$database->InsertToVoucherHistoryMultiple($insertCase);
		
		
		$updateCase = preg_replace('/Id/', 'a.Id', $updateCase);
		$condition = " where  " . $updateCase;
		$record = $database->FethVoucherByCondition($condition);
		echo $sheet->CreateTrackerData($record);
	}
	
	if(isset($_GET['loadMoreResult'])){
		
		
		$queryField = $database->charEncoder($_GET['queryField']);
		$querySearch = $database->charEncoder($_GET['querySearch']);
		$idStart = $database->charEncoder($_GET['idStart']);
		$officeCode = $database->charEncoder($_GET['office']);
		
		if($querySearch == ''){
			$condition = " where Office = '" . $officeCode . "' and a.Id < '" . $idStart . "'";
			
		}else{
			if($officeCode == ''){
				$condition = " where  " . $queryField .  " = '" . $querySearch . "' and a.Id < '" . $idStart . "'";
			}else{
				$condition = " where Office = '" . $officeCode . "' and " . $queryField .  " = '" . $querySearch . "' and a.Id < '" . $idStart . "'";
			}
			
		}
		
		
		$record = $database->FethVoucherByCondition($condition);
		
		$count = $database->num_rows($record);
		if($count > 0){
			echo $sheet->CreateTrackerData($record);
		}else{
			echo "<div class = 'label3' style ='text-align:center;padding:20px;'>No record found.</div>";
		}
		
	}
	
	//---------------------------------------------------------------------------------doctrack transmittal
	if(isset($_GET['generateReport'])){
		
		$claimType = $database->charEncoder($_GET['claimType']);
		$fundType = $database->charEncoder($_GET['fundType']);
		$status =  $database->charEncoder($_GET['status']);
		$sDate =  $database->charEncoder($_GET['sDate']);
		$from = $database->charEncoder($_GET['from']);
		$until = $database->charEncoder($_GET['until']);
		$dbYear = $database->charEncoder($_GET['dbYear']);
		$field = "ClaimType";
		if($dbYear == "2018"){
			$db = "citydoc2018.";
		}else if($dbYear == "2017"){
			$db = "citydoc2017.";
		}else if($dbYear == "2016"){
			$db = "citydoc.";
			$field = "TransactionType";
		}else if($dbYear == "2019"){
			$db = "citydoc2019.";
		}else if($dbYear == "2020"){
			$db = "citydoc2020.";
		}else if($dbYear == "2021"){
			$db = "citydoc2021.";
		}else if($dbYear == "2022"){
			$db = "citydoc2022.";
		}else if($dbYear == "2023"){
			$db = "citydoc2023.";
		}
		
		if($claimType == ""){
			$sign1 = " != ";
		}else{
			$sign1 = " = ";
		}
		if($fundType == ""){
			$sign2 = " != ";
		}else{
			$sign2 = "=";
		}
		if($status == ""){
			$sign3 = " != ";
		}else{
			$sign3 = " = ";
		}
		
		if($_SESSION['accountType'] == 5){
			if($sDate != 2){
				if($status == "CAO Released"){
							
					$sql = "select * from " . $db . "vouchercurrent where   " . $field  . $sign1 . "'". $claimType ."' 
					and Fund " . $sign2 . "'" . $fundType . "'
				
					and substr(DateReleased,1,10) = '" . $sDate . "'
					and ControlNo >= '" . $from . "' and ControlNo <= '" . $until . "' group by TrackingNumber
					order by ControlNo asc,DateReleased asc";
					
				
				}else{
					$sql = "select * from " . $db . "vouchercurrent where  " . $field   . $sign1 . "'". $claimType ."' 
					and Fund " . $sign2 . "'" . $fundType . "'
					and Status " . $sign3 . "'" . $status . "'
					and substr(DateModified,1,10) = '" . $sDate . "' group by TrackingNumber
					order by ControlNo asc";			
				}
			}else{
				$sql = "select * from " . $db . "vouchercurrent where  " . $field   . $sign1 . "'". $claimType ."' 
					and Fund " . $sign2 . "'" . $fundType . "'
					and Status " . $sign3 . "'" . $status . "' group by TrackingNumber
					
					order by ControlNo asc";			
					
			}
			
			$rec =  $database->query($sql);
			
		}else{
			if($status == "CAO Released"){
				
				if($db == 2018){
					$sql = "select * from " . $db . "vouchercurrent where   " . $field   . $sign1 . "'". $claimType ."' 
						and Fund " . $sign2 . "'" . $fundType . "'
						and Status " . $sign3 . "'" . $status . "'
						and substr(DateReleased,1,10) like '%" . $sDate . "%' group by TrackingNumber
						order by claimant asc";	
				}else{
					$sql = "select * from " . $db . "vouchercurrent where   " . $field   . $sign1 . "'". $claimType ."' 
						and Fund " . $sign2 . "'" . $fundType . "'
						and Status " . $sign3 . "'" . $status . "'
						and substr(DateModified,1,10) like '%" . $sDate . "%' group by TrackingNumber
						order by claimant asc";		
				}

			}else{
				
		
				$sql = "select * from " . $db . "vouchercurrent where   " . $field   . $sign1 . "'". $claimType ."' 
						and Fund " . $sign2 . "'" . $fundType . "'
						and Status " . $sign3 . "'" . $status . "'
						and substr(DateModified,1,10) like '%" . $sDate . "%' group by TrackingNumber
						order by claimant asc";		
			}
			$rec =  $database->query($sql);	
			
		}
		$count = $database->num_rows($rec);
		
		if($count != 0){
			if($_SESSION['accountType'] == 5){
				$sheet->createViewSheetReport($rec,$fundType,$status,$claimType,$sDate,$count,$dbYear);
			}else{
				$sheet->createViewSheetReportAll($rec,$fundType,$status,$claimType,$sDate,$count,$dbYear);
			}
		}else{
			echo "<br/><br/><br/><br/><br/><br/><br/><span class = 'norecord'>No record found.</span>";
		}
	}
	if(isset($_GET['searchByTransmitalValue'])){
		$field = $database->charEncoder($_GET['field']);
		
		$searchValue = $database->charEncoder($_GET['searchValueReleaser']);
		
		$firstChar =  0;
		if(substr($searchValue,0,1) == "-"){
			$firstChar = 1;
		}
		if(substr($searchValue,4,1) == "-" || substr($searchValue,2,1) == "-"){
			$firstChar = 2;
		}
		if(substr($searchValue,0,1) == "*"){
			$firstChar = 3;
		}
		if(substr($searchValue,0,1) == "/"){
			$firstChar = 4;
		}
		if(substr($searchValue,0,1) == "@"){
			$firstChar = 5;
		}
		if(substr($searchValue,0,1) == "#"){
			$firstChar = 6;
		}
		
		
		$dbYear = $database->charEncoder($_GET['dbYear']);
		if($dbYear == "2018"){
			$db = "citydoc2018.";
		}else if($dbYear == "2017"){
			$db = "citydoc2017.";
		}else if($dbYear == "2016"){
			$db = "citydoc.";
		}else if($dbYear == "2019"){
			$db = "citydoc2019.";
		}else if($dbYear == "2020"){
			$db = "citydoc2020.";
		}else if($dbYear == "2021"){
			$db = "citydoc2021.";
		}else if($dbYear == "2022"){
			$db = "citydoc2022.";
		}else if($dbYear == "2023"){
			$db = "citydoc2023.";
		}
		
		if($firstChar == 1){
			$searchValue = str_replace('-','',$searchValue);
			$sql = "select * from " . $db . "vouchercurrent where office = '" . $searchValue . "' order by DateModified desc";
			$record =  $database->query($sql);
			
			$count =  $database->num_rows($record);
			if($count != 0){
				echo $sheet->CreateViewSheetSearch($record,'','specified search','',$count,$dbYear);
			}else{
				echo "<br/><br/><br/><br/><br/><br/><span class = 'norecord'>No record found.</span>";
			}
		}else if($firstChar == 2){
			
			$sql = "select * from " . $db . "vouchercurrent where trackingnumber = '" . $searchValue . "' group by trackingnumber";
			$record =  $database->query($sql);
			
			$count =  $database->num_rows($record);
			if($count != 0){
				echo $sheet->CreateViewSheetSearch($record,'','specified search','',$count,$dbYear);
			}else{
				echo "<br/><br/><br/><br/><br/><br/><span class = 'norecord'>No record found.</span>";
			}
		}else if($firstChar == 3){
			$searchValue = str_replace('*','',$searchValue);
			
			$sql = "select * from " . $db . "vouchercurrent where checknumber = '" . $searchValue . "' group by trackingnumber";
			$record =  $database->query($sql);
			
			$count =  $database->num_rows($record);
			if($count != 0){
				echo $sheet->CreateViewSheetSearch($record,'','specified search','',$count,$dbYear);
			}else{
				echo "<br/><br/><br/><br/><br/><br/><span class = 'norecord'>No record found.</span>";
			}
		}else if($firstChar == 4){
			$searchValue = str_replace('/','',$searchValue);
			
			$sql = "select * from " . $db . "vouchercurrent where obr_number = '" . $searchValue . "' group by trackingnumber";
			$record =  $database->query($sql);
			
			$count =  $database->num_rows($record);
			if($count != 0){
				echo $sheet->CreateViewSheetSearch($record,'','specified search','',$count,$dbYear);
			}else{
				echo "<br/><br/><br/><br/><br/><br/><span class = 'norecord'>No record found.</span>";
			}
		}else if($firstChar == 5){
			$searchValue = str_replace('@','',$searchValue);
			
			$sql = "select * from " . $db . "vouchercurrent where PR_Number LIKE '%" . $searchValue . "%' group by trackingnumber";
			$record =  $database->query($sql);
			
			$count =  $database->num_rows($record);
			if($count != 0){
				echo $sheet->CreateViewSheetSearch($record,'','specified search','',$count,$dbYear);
			}else{
				echo "<br/><br/><br/><br/><br/><br/><span class = 'norecord'>No record found.</span>";
			}
		}else if($firstChar == 6){
			$searchValue = str_replace('#','',$searchValue);
			
			$sql = "select * from " . $db . "vouchercurrent where PO_Number = '" . $searchValue . "' group by trackingnumber";
			$record =  $database->query($sql);
			
			$count =  $database->num_rows($record);
			if($count != 0){
				echo $sheet->CreateViewSheetSearch($record,'','specified search','',$count,$dbYear);
			}else{
				echo "<br/><br/><br/><br/><br/><br/><span class = 'norecord'>No record found.</span>";
			}
		}else{
			
			if($field == "ADV"){
				//$sql = "select * from " . $db . "vouchercurrent where ADV1 like '" . $searchValue . "%' or ADV2 like '" . $searchValue . "%' group by trackingnumber order by DateModified desc";	
				$sql = "select * from " . $db . "vouchercurrent where ADV1 = '" . $searchValue . "' or ADV2 = '" . $searchValue . "' group by trackingnumber order by DateModified desc";	
			}else{
				$sql = "select * from " . $db . "vouchercurrent where " . $field . " like '%" . $searchValue . "%' group by trackingnumber  order by DateModified  desc";	
			}
			$record =  $database->query($sql);
			$count =  $database->num_rows($record);
			if($count != 0){
				if($count == 1){
					$row = " row";
				}else{
					$row = " rows";
				}
				echo $sheet->CreateViewSheetSearch($record,'','specified search','',$count, $dbYear);
			}else{
				echo "<br/><br/><br/><br/><br/><br/><span class = 'norecord'>No record found.</span>";
			}
		}

	}
	//---------------------------------------------------------------------------------------------------------------forum
	if(isset($_GET['uKxRbAUuSf'])){
		$officeCode= $_SESSION['cbo'];
		$accountType = $_SESSION['accountType'] ;
		$officeName = $database->charEncoder($_SESSION['officeName']);
		$sender = $_SESSION['employeeNumber'];
		$senderName = $_SESSION['fullName'];
		$senderOffice =  $database->charEncoder($_SESSION['officeName']);
		$crypt = $_GET['jhufYruX']; 
		$cipher = $database->vArrange($crypt);
		$crypt =  $database->charEncoder($cipher);
		$arr = explode("^(*",$crypt);
		$receiver = $arr[0];
		$message =  $arr[1];
				
		if($receiver == "Announcement"){
			//$database->InsertToAnnouncement($sender,$senderName,$dateEncoded,$message,$_SESSION['cbo']);
			$sql = "INSERT INTO " . $forumDatabase  . "poster (PostedBy,Name,DatePosted,Message,Office)
			VALUES ('" . $sender . "', '" . $senderName . "', '" . $dateEncoded . "', '" . $message . "','" . $_SESSION['cbo'] . "')";
			$database->query($sql);
			
			//$record = $database->GetAnnouncement();
			$sql ="select a.* from (SELECT * FROM " . $forumDatabase  . "poster order by id desc) a group by a.office order by a.id desc ";
			$record = $database->query($sql);
			echo $sheet->DisplayAnnouncement($record);
		}else{
			$messageType = $_SESSION['accountType'];
			
			//$database->InsertForumMessage($sender,$receiver,$message,$messageType,$dateEncoded,$senderOffice,$senderName);
			$sql = "INSERT INTO " . $forumDatabase  . "forum (Sender,Receiver,Message,MessageType,Date,SenderOffice,SenderName)
			VALUES ('" . $sender . "', '" . $receiver . "', '" . $message . "', '" . $messageType . "', '" . $dateEncoded . "','" . $senderOffice . "','" . $senderName . "')";
			$database->query($sql);
			
			//$database->InsertForumLogs(0,"forum",$senderName,$receiver,$dateEncoded);
			$sql = "INSERT INTO " . $forumDatabase  . "forumlogs (MessageId,MessageType,Sender,Receiver,Date)
			VALUES ('0', 'forum', '" . $senderName . "', '"  . $receiver . "', '"  . $dateEncoded . "')";
			$database->query($sql);
			
			if($accountType > 1){
				$sql = "select * from " . $forumDatabase  . "forum where receiver = '" . $officeName . "' or senderoffice  =  '" .  $officeName . "' or  receiver = 'allthree' or  receiver = 'all'  order by id desc limit 10";			
				$record = $database->query($sql);
			}else{
				$sql = "select * from " . $forumDatabase  . "forum where receiver = '" . $officeName . "' or senderoffice  =  '" .  $officeName . "' or  receiver = 'all' order by id desc limit 10";			
				$record = $database->query($sql);
			}
			$sheet->CreateForumView($record);
			$count = $database->num_rows($record);
			
			if($count >= 10){
				$sheet = '<div id = "loadMore" onclick = "clickLoadMore(this)"> Load more messages &#9660;<br/></div>';
				echo $sheet;
			}
		}
	}
	if(isset($_GET['jKlTikSzx'])){
		//$record = $database->GetAnnouncement();
		//$sql ="select a.* from (SELECT * FROM " . $forumDatabase  . "poster order by id desc) a order by a.id desc ";
		
		$sql = "select b.* from (SELECT  max(id) as id ,office  FROM  " . $forumDatabase  . "poster group by office )  as a left join  " . $forumDatabase  . "poster b on a.id = b.id";
		$record = $database->query($sql);
		echo $sheet->DisplayAnnouncement($record);
	}	
	if(isset($_GET['dfdXsassdErf'])){
		$accountType = $_SESSION['accountType'];
		
		$officeName = $database->charEncoder($_SESSION['officeName']);
		if($accountType > 1){
			$sql = "select * from " . $forumDatabase  . "forum where receiver = '" . $officeName . "' or senderoffice  =  '" .  $officeName . "' or  receiver = 'allthree' or  receiver = 'all'  order by id desc limit 10";			
			$record = $database->query($sql);
		}else{
			$sql = "select * from " . $forumDatabase  . "forum where receiver = '" . $officeName . "' or senderoffice  =  '" .  $officeName . "' or  receiver = 'all' order by id desc limit 10";			
			$record = $database->query($sql);
		}
		$sheet->CreateForumView($record);
		$count = $database->num_rows($record);
		if($count >= 10){
			$sheet = '<div id = "loadMore" onclick = "clickLoadMore(this)"> Load more messages &#9660;<br/></div>';
			echo $sheet;
		}
		
	}
	if(isset($_GET['zxRtaPxr'])){
		
		$crypt = $_GET['gZsayXfa']; 
		$cipher = $database->vArrange($crypt);
		$crypt =  $database->charEncoder($cipher);
		$arr = explode("~*$",$crypt);
		$forumId = $arr[0];
		$receiver =  $arr[1];
		$message =  $arr[2];
		
		//$forumId = $_GET['messageId'];
		//$receiver = $database->charEncoder($_GET['receiverOffice']);	
		//$message = $database->charEncoder($_GET['message']);
		
		$sender = $_SESSION['employeeNumber'];
		$senderName = $_SESSION['fullName'];
		$officeName =  $database->charEncoder($_SESSION['officeName']);
		
		//$database->InsertForumReply($forumId,$sender,$message,$senderName,$officeName,$today);	
		$sql = "INSERT INTO " . $forumDatabase  . "forumreplies (ForumId,SenderId,Message,SenderFullname,SenderOffice,DateEncoded)VALUES ('" . $forumId . "', '" . $sender . "', '" . $message . "', '"  . $senderName . "', '"  . $officeName . "', '"  . $today. "')";
		$database->query($sql);
		
		
		//$database->UpdateReplyCount($forumId);
		$sql = "UPDATE " . $forumDatabase  . "forum SET Replies = Replies + 1  WHERE Id = '" . $forumId . "' limit 1";				
		$database->query($sql);
		
		//$database->InsertForumLogs($forumId,"reply",$senderName,$receiver,$dateEncoded);
		$sql = "INSERT INTO " . $forumDatabase  . "forumlogs (MessageId,MessageType,Sender,Receiver,Date)VALUES ('" . $forumId . "', 'reply', '" . $senderName . "', '"  . $receiver . "', '"  . $dateEncoded . "')";
		$database->query($sql);
		
		
		//$record = $database->FetchSingleForumMessage($forumId);
		$sql = "SELECT t1.*, t2.* FROM " . $forumDatabase  . "forum  t1,
				    (SELECT a.Code,a.Name,b.OfficeCode,b.EmployeeNumber,b.FirstName,b.MiddleName,b.LastName  
					FROM " . $forumDatabase  . "office a inner join citydoc.employees b on a.Code = b.OfficeCode) as t2 where 
				    t1.Sender = t2.EmployeeNumber and t1.iD = '" . $forumId . "' limit 1";
		$record =$database->query($sql);
		$sheet->CreateForumView($record);
	}
	if(isset($_GET['cDsZrtEtrDFttrXly'])){
		//$messageId =  $_GET['messageId'];
		
		$crypt = $_GET['xHbkuyShkuyt']; 
		$cipher = $database->vArrange($crypt);
		$crypt =  $database->charEncoder($cipher);
		$arr = explode("*&^(",$crypt);
		$messageId = $arr[0];
		
		
		$sql =  "Select * from " . $forumDatabase . "forumreplies where ForumId = '" . $messageId  . "'";
		$record = $database->FetchThis($sql);
		//$record = $database->FetchReplies($messageId);
		$sheet->CreateViewReplies($record);
	}
	if(isset($_GET['yudfhGYAsaYgmPsXstZ'])){
		
		$crypt = $_GET['kdfYuugZxSgdkYtraKXxTga']; 
		$cipher = $database->vArrange($crypt);
		$crypt =  $database->charEncoder($cipher);
		$arr = explode("%@!~",$crypt);
		$messageId = $arr[0];
		//$messageId =  $_GET['messageId'];
		//$database->DeleteForum($messageId);
		$sql = "Delete from " . $forumDatabase . "forum   WHERE Id = '" . $messageId . "' limit 1";		
		$database->query($sql);		
		
		//$database->DeleteForumReplies($messageId);
		$sql = "Delete from " . $forumDatabase . "forumreplies   WHERE ForumId = '" . $messageId . "'";	
		$database->query($sql);			
		echo $messageId;
	}
	if(isset($_GET['kusdGrWvDFh'])){
		//$forumId = $database->charEncoder($_GET['messageId']);
		
		$crypt = $_GET['jFvAGSvKhkyAx']; 
		$cipher = $database->vArrange($crypt);
		$crypt =  $database->charEncoder($cipher);
		$arr = explode("*&^@",$crypt);
		$forumId = $arr[0];
		
		
		$accountType = $_SESSION['accountType'];
		$officeName = $database->charEncoder($_SESSION['officeName']);
		if($accountType > 1){
			$sql = "select * from " . $forumDatabase . "forum where 
				receiver = '" . $officeName . "'  and  id < '" . $forumId . "'  or
				senderoffice  =  '" .  $officeName . "' and  id < '" . $forumId . "'  or
				receiver = 'allthree' and id < '" . $forumId . "'  or
				receiver = 'all' and  id < '" . $forumId . "'  
				order by id desc limit 10";			
			$record = $database->FetchThis($sql);
		}else{
			$sql = "select * from " . $forumDatabase . "forum where 
				 receiver = '" . $officeName . "'  and id < '" . $forumId . "'  or
				senderoffice  =  '" .  $officeName . "'  and id < '" . $forumId . "' or
				receiver = 'all' and id < '" . $forumId . "'
				
				order by id desc limit 10 ";			
			$record = $database->FetchThis($sql);
		}
		
		
		$sheet->CreateForumView($record);
		$count = $database->num_rows($record);
		if($count >= 10){
			$sheet = '<div id = "loadMore" onclick = "clickLoadMore(this)"> Load more messages &#9660;<br/></div>';
			echo $sheet;
		}
	}
	if(isset($_GET['hsjuuw6YSDasuYsj'])){
		//$goToMessageVal = $_GET['goToMessageVal'];
		
		
		$crypt = $_GET['jFvAGSvmkyAx']; 
		$cipher = $database->vArrange($crypt);
		$crypt =  $database->charEncoder($cipher);
		$arr = explode("$#@&",$crypt);
		$goToMessageVal = $arr[0];
		
		$accountType = $_SESSION['accountType'];	
		
		if($accountType > 1){
			//$record = $database-> FetchAllForumMessages($goToMessageVal+1);
			
			$sql = "SELECT a.*,b.LastName,b.FirstName,b.MiddleName,c.Name 
					FROM 
					" . $forumDatabase . "forum a inner join citydoc.employees b on a.Sender = b.employeenumber 
					inner join " . $forumDatabase . "office c on b.officecode = c.code 
					where a.Id <= " . $goToMessageVal . " order by a.id desc limit 10";
					
			
			$record = $database->query($sql);
			
		}else{
			//$record = $database-> FetchMoreMessages($goToMessageVal+1,$database->charEncoder($_SESSION['officeName']));
			$sql = "SELECT t1.*, t2.* FROM " . $forumDatabase . "forum  t1,
				    (SELECT a.Code,a.Name,b.OfficeCode,b.EmployeeNumber,b.FirstName,b.MiddleName,b.LastName  
					FROM " . $forumDatabase . "office a inner join citydoc.employees b on a.Code = b.OfficeCode) as t2 where 
				    t1.Sender = t2.EmployeeNumber and t1.Receiver = 'all' and t1.Id < ". $forumId ." or 
					t1.Sender = t2.EmployeeNumber and t1.Receiver = '" . $officeName . "' and t1.Id < ". $forumId ." or 
					t1.Sender = t2.EmployeeNumber and t2.Name= '" . $officeName . "' and t1.Id < ". $forumId ."
					order by t1.id desc limit 10";
			$record = $database->query($sql);
		}
		
		$sheet->CreateForumView($record);
		$count = $database->num_rows($record);
		if($count >= 10){
			$sheet = '<div id = "loadMore" onclick = "clickLoadMore(this)"> Load more messages &#9660;<br/></div>';
			echo $sheet;
		}
	}
	//-------------------------------------------------------------------------------------------------------settings
	
	if(isset($_GET['addNewAccount'])){
		$exist = 0;
		$code = $database->charEncoder($_GET['code']);
		$title = $database->charEncoder($_GET['title']);
		$fund = $_GET['fund'];
		if($title =="delete V"){
			$database->DeleteAccountTitle($code);
		}else{
			
			$record = $database->FindAccountTitle($code);
			$count = $database->num_rows($record);
			
			if($count == 0){
				$database->SaveNewAccount($fund,$code,$title);
			}else{
				$exist = 1;
			}
		}
		if($exist ==  0){
			$record = $database->FetchAllAccountTitles();
			echo $sheet->CreateFundTable($record);
		}else{
			echo "Please review. Account code already exist.<br/>";
			echo $sheet->CreateFundTable($record);
		}
	}
	if(isset($_GET['loadAllAccountTitles'])){
		$record = $database->FetchAllAccountTitles();
		echo $sheet->CreateFundTable($record);
	}
	
	// if(isset($_GET['addNewProgram'])){
	// 	$exist = 0;
	// 	$code = $database->charEncoder($_GET['code']);
	// 	$name = $database->charEncoder($_GET['name']);
	// 	$fund = $database->charEncoder($_GET['fund']);
		
	// 	if($name == "delete V"){
	// 		$database->DeleteProgram($code);
	// 	}else{
			
	// 		$record = $database->FindProgram($code);
	// 		$count = $database->num_rows($record);
			
	// 		if($count == 0){
	// 			$database->SaveNewProgram($code,$name,$fund);
	// 		}else{
	// 			$exist = 1;
	// 		}
	// 	}
	// 	if($exist ==  0){
	// 		$record = $database->FetchAllProgram();
	// 		echo $sheet->CreateProgramTable($record);
	// 	}else{
	// 		echo "Please review. Account code already exist.<br/>";
	// 		echo $sheet->CreateProgramTable($record);
	// 	}
	// }

	if(isset($_GET['mwyeiNyduddadP5mmrmayoiriyyg5a26'])){

		$crypt = $_GET['zr0azbrpugaagrzs0a2mga12']; 
		$cipher = $database->vArrange($crypt);
		$crypt =  $database->charEncoder($cipher);
		$arr = explode("^(*",$crypt);

		$exist = 0;
		$code = $database->charEncoder($arr[0]);
		$name = urldecode($database->charEncoder($arr[1]));
		$fund = $database->charEncoder($arr[2]);
		$bnkAccount = $database->charEncoder($arr[3]);

		// $exist = 0;
		// $code = $database->charEncoder($_GET['code']);
		// $name = $database->charEncoder($_GET['name']);
		// $fund = $database->charEncoder($_GET['fund']);
		// $bnkAccount = $database->charEncoder($_GET['ac']);
		
		if($name == "delete V"){
			$database->DeleteProgram($code);
		}else{
			
			$record = $database->FindProgram($code);
			$count = $database->num_rows($record);
			
			if($count == 0){
				$database->SaveNewProgram($code,$name,$fund,$bnkAccount);
			}else{
				$exist = 1;
			}
		}
		if($exist ==  0){
			$record = $database->FetchAllProgram();
			echo $sheet->CreateProgramTable($record);
		}else{
			echo "Please review. Account code already exist.<br/>";
			echo $sheet->CreateProgramTable($record);
		}
	}

	if(isset($_GET['loadAllProgram'])){
		$record = $database->FetchAllProgram();
		echo $sheet->CreateProgramTable($record);
	}
 //------------------------------------------------------------------------panel
	if(isset($_GET['loadBudgetForApproval'])){
		$record = $database->FetchBudgetForApproval();	
		echo $sheet->CreateForApprovalBudget($record);
	}


//------------------------------------------------------------------------- OBRS
	if(isset($_GET['loadAllOBRs'])){
		$record = $database->FetchAllOBRs();	
		echo $sheet->CreateAllOBRs($record);	
	}

//------------------------------------------------------------------------------Manual Tracking

	if(isset($_GET['selectManualDoctrack'])){
		$type = $database->charEncoder($_GET['type']);
		if($type == "optMPR"){
			$condition = " where Code = '" . $office . "'";
			$field = "PR";		
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			$count = $data['PR'] + 1;
			$id  = "PR-" . $office . "-" . $count;
			$record = $database->FetchPPMP($defaultYear,$office); //-------------------------fetch ni sa  source of funds
			$record1 = $database->LoadProgramFundsByOffice($defaultYear,$office);
			echo $type . '*' . $id . '*' . $sheet->CreateSelectManualPPMP($record) . '*' . $sheet->CreateSelectManualProgramFundsByOffice($record1);
			
		}else if($type == "optMPO"){
			$condition = " where Code = '" . $office . "'";
			$field = "Doctrack";
			$record = $database->FetchDoctrackID($field,$condition);
			$data = $database->fetch_array($record);
			$count = $data['Doctrack'] + 1;
			
			$id  =  $office . "-" . $count;
			
			$record = $database->FetchManualApprovePR($defaultYear,$office);
			echo $type . '*' . $id . '*' .  $sheet->CreateSelectManualApprovePR($record);
		}
	}
	/*if(isset($_GET['saveManualPR'])){
		
		$fund = $_GET['fund'];
		$category = $_GET['category'];
		$obrData = $_GET['obrData'];
		$prTotal = $_GET['prTotal'];
		$itemCategory = $_GET['category'];
		
		if($itemCategory == "myPeak"){
			$itemCategory = "Multiple";
		}
		
		$prNumber = $_GET['prNumber'];
		$details = $_GET['details'];
		
		
		$trackType = 'PR';
		$status = "PR - GSO Received";
		$remarks = "Manually encoded.";
		
		$prMonth = '';
		$claimType = '';
		$claimant = '';
		$transtype = '';
		$periodType = '';
		$periodValue = '';
		
		
		//pagupdate sa new seq
		$updateCase = "PR = PR + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("PR",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = "PR-" . $office . '-' . $data['PR'];
		$newTrackingNumber = "PR-" . $office . '-' . ($data['PR']+1); 
		
			
		$fundCount = explode("~",$obrData);
		if(sizeof($fundCount) <= 2){
			$chargeType = 0;
			$each = explode("*",$fundCount[0]);
			$program = $each[0];
			$prAccountCode = $each[1];
			$amount = $each[2];
			$database->SaveTrackingManualPR($defaultYear,$office,$trackType,$trackingNumber,$program,$prAccountCode,$prTotal,$itemCategory,$prMonth,$employeeNumber,$dateEncoded,$status,$fund,$prNumber,$remarks);
		
			$insertCase1 = "('" . $trackingNumber . "','-','" . $details . "',1," . $amount ."," . $prTotal . ",'" . $program. "')";
			$database->InsertToManualPRrecord($insertCase1);	
		}else{
			$chargeType = 3;
			$insertCase = '';
			$insertCase1 = '';
			for($i = 0 ; $i < sizeof($fundCount) -1 ; $i++){
				$each = explode("*",$fundCount[$i]);
				$program = $each[0];
				$prAccountCode = $each[1];
				$amount = $each[2];
				$insertCase .= ",('" . $defaultYear . "','" . $office . "','" . $trackType . "','" . 
					                       $claimType . "','" . $claimant . "','" . $fund . "','" . 
										   $transtype . "','" .  $trackingNumber . "','" . $program . "','" . 
										   $prAccountCode . "'," .  $amount . ",'" . $periodType . "','" .  $periodValue . "','" .  
										   $employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "','" . 
										   $dateEncoded . "'," . $chargeType . "," . $prTotal . ",'" . $itemCategory . "','" . 
										   $prMonth  . "','" . $prNumber . "','" . $remarks . "')";
										   
				$insertCase1 .= ",('" . $trackingNumber . "','-','" . $details . "',1," . $amount ."," . $amount . ",'" . $program. "')";	
				
			}
			
			$database->SaveTrackingManualPRMultiple(substr($insertCase,1,strlen($insertCase)));	
			
			$database->InsertToManualPRrecord(substr($insertCase1,1,strlen($insertCase1)));
		}
			
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		
		

		
		echo $newTrackingNumber . '~'. $trackingNumber;
	}*/
	/*if(isset($_GET['saveManualPO'])){
		
		$supplier = $_GET['supplier'];
		$details = $_GET['details'];
		$obrNumber = $_GET['obrNumber'];
		$poTotal = $_GET['poTotal'];
		$prNumber =  $_GET['prNumber'];
		$fund =  $_GET['fund'];
		
		
		$catTrack = explode("~",$_GET['categoryTracking']);
		$itemCategory = $catTrack[0];
		$prTrackingNumber =  $catTrack[1];
		
		$trackType = 'PO';
		$note = 'Manually encoded';
		$prMonth = '';
	
		
		$poData = $database->charEncoder($_GET['poData']);
		
		$status = "PO Encoded";
		
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 
		

		
		
		$poDataRow = explode('*', $poData);
		$insertThis ='';
		$insertThis1 ='';
		
		
		$counter = 0;
		$sizeSaArray = sizeof($poDataRow);
		if($sizeSaArray > 2){
			$chargeType = 3;
		}else{
			$chargeType = 0;
		}
		for($i = 0; $i < $sizeSaArray -1;$i++ ){
			$data = explode('~', $poDataRow[$i]);
			
			
			$program = $data[0];
			$code = $data[1];
			$obrTotal = $data[2];
			$amount = $data[3];
			
			$insertThis .= ",('" . $trackingNumber . "',1,'-','" . $details . "'," . $amount ."," . $amount . ",'" . $program . "')";	
			$counter++;
			
			$insertThis1 .= ",(" . $defaultYear . ",'" . $office . "','" . $fund . "','" . $trackType . "','" . $trackingNumber  . "',
				                 '" .  $supplier . "','" .  $prTrackingNumber . "','" . $program . "','" . $code . "',
								 '" . $amount . "','" . $obrTotal . "','" . $itemCategory . "','" . $prMonth . "','" . $prNumber . "','" . $obrNumber . "',
								 '" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "',0," . $chargeType . "," . $poTotal . ",'" . $note . "','Voucher','Payment')";	
			
		}
		$database->InsertToPOrecord(substr($insertThis,1,strlen($insertThis)));
		
		
		
		if($counter <= 1){
			$insertCase = "(" . $defaultYear . ",'" . $office . "','" . $fund . "','" . $trackType . "','" . $trackingNumber  . "',
				                 '" .  $supplier . "','" .  $prTrackingNumber . "','" . $program . "','" . $code . "',
								 '" . $amount . "','" . $obrTotal . "','" . $itemCategory . "','" . $prMonth . "','" . $prNumber . "','" . $obrNumber . "',
								 '" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "',0," . $chargeType . "," . $poTotal . ",'" . $note . "','Voucher','Payment')";
								 
			$database->SaveTrackingManualPO($insertCase);
		
		}else{
			$database->SaveTrackingManualPO(substr($insertThis1,1,strlen($insertThis1)));
		}
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~' . $trackingNumber ;
		
	}*/
	
	/*if(isset($_GET['searchManualApprovedTracking'])){
		$trackingNumber = $_GET['trackingNumber'];
		$record = $database->SearchByManualTrackingNumber($trackingNumber);
		echo $sheet->CreateManualFundBreakdown($record);	
	}*/
	//-------------------------------------------------------------------------
	if(isset($_GET['loadOfficeData'])){
		$record = $database->GetOffice();
		echo $sheet->CreateOfficeOption($record);
	}
	if(isset($_GET['getOfficeProgramCode'])){
		$office = $database->charEncoder($_GET['office']);
		$record = $database->GetProgramCodesByOffice($year,$office);
		echo $sheet->CreateProgramSelect1($record,400);	
	}
	if(isset($_GET['getAcountCodeInChanges'])){
		$office = $database->charEncoder($_GET['office']);
		$program = $database->charEncoder($_GET['program']);
		
		$record = $database->GetEncodedByProgramCode($defaultYear,$office,$program);
		echo $sheet->CreateSelectAccountCodes1($record,400);
		
	}
	//--------------------------------------------saaob obrs
	if(isset($_GET['LoadOfficeSAAOB'])){
		$record = $database->GetOffice();
		$classBakit  = $database->charEncoder($_GET['classBakit']);
		$func = $database->charEncoder($_GET['func']);
		echo $sheet->CreateOfficeSelectOfficial($record,$classBakit,$func);
	}
	if(isset($_GET['LoadProgramSAAOB'])){
		
		$classVal  = $database->charEncoder($_GET['classBakit']);
		$func = $database->charEncoder($_GET['func']);
		$office = $database->charEncoder($_GET['office']);
		$classBakit  = $database->charEncoder($_GET['classBakit']);	
		if($office == "All"){
			$record = $database->GetAllProgramCodes($year);
			
		}else{
			
			$record = $database->GetProgramCodesByOffice($year,$office);	
			
		}
		echo $sheet->CreateProgramSAAOB($record,$classVal,$func);	
	
		
	}
	if(isset($_GET['LoadDisbursement'])){
		$office = $database->charEncoder($_GET['office']);
		$programCode = $database->charEncoder($_GET['programCode']);
		$record = $database->FetchDisbursement($office,$programCode);
		$arr = explode("~!~",$sheet->CreateDisbursementsTable($record)); 
		echo $arr[0] . "~!~"  . $arr[1] . "~!~"  . $arr[2];
	}
	if(isset($_GET["FetchOfficeOBR"])){
		$office = $database->charEncoder($_GET['office']);
		$record = $database->FetchOBRDisbursement($office);
		
		$arr = explode("~!~",$sheet->CreateDisbursementsOfficeOBR($record)); 
		echo $arr[0] . "~!~"  . $arr[1];
	}
	if(isset($_GET['SearchInEncodeLiquidation'])){
		$field = $database->charEncoder($_GET['field']);
		$searchValue = $database->charEncoder($_GET['searchValueSaaob']);
		//$record =  $database->FetchDisbursementLiquidatedBy($year,$field,$searchValue);
		/*$sql = 'SELECT a.Id,a.PR_CategoryCode as Category,a.TrackingType,a.ADV1,a.ADV2,a.PR_ProgramCode,a.OBR_Number,
					a.CheckNumber,
					a.CheckDate,
					a.Amount,a.TrackingNumber,
			       		 a.PR_AccountCode,
			       		 a.PO_Amount, 
			       		 a.TotalAmountMultiple,
					d.Category_Name as CategoryName, 
					a.Claimant, 
					a.DateModified,
			               a.ChargeType,
			               a.Status,
			         
			               a.ClaimType,
			               a.JevNo,
			               c.DateEncoded as JevDate
					
					FROM vouchercurrent a 
					left join (Select x.Trackingnumber,x.DateEncoded from liquidated x  group by trackingnumber)  c
					on a.TrackingNumber = c.TrackingNumber
					
					          
          			       left join bacdb2017.item_categories d          
				         on a.PR_CategoryCode = d.Category_Key	
					
					where
					a.year = ' . $year . ' and
					' . $field . ' = "' . $searchValue . '"';*/
		$sql = 'SELECT a.Id,a.PR_CategoryCode as Category,a.TrackingType,a.ADV1,a.ADV2,a.PR_ProgramCode,a.OBR_Number,
					a.CheckNumber,
					a.CheckDate,
					a.DocumentType,
					a.Amount,a.TrackingNumber,
			       		a.PR_AccountCode,
			       		a.PO_Amount, 
			       		a.TotalAmountMultiple,
					d.Description as CategoryName, 
					a.Claimant, 
					a.DateModified,
			               a.ChargeType,
			               a.Status,
			         
			               a.ClaimType,
			               a.JevNo
			           
					
					FROM vouchercurrent a 
					  left join ppmpcategories d          
				         on a.PR_CategoryCode = d.Code
					
					where
					a.year = ' . $year . ' and
					' . $field . ' = "' . $searchValue . '"';
					
		
		$record =  $database->query($sql);
		
		
		if($database->num_rows($record)!= 0 ){
			echo $sheet->CreateSearchBySAAOBOBR($record);
		}else{
			echo 0 . '~!~' . '<div style = "padding:10px 20px;background-color:rgab(252, 162, 1621);color:red;font-weight:bold;" class = "label7">No record found.</div>';
		}
	}
	if(isset($_GET['saveOBRJEV'])){
		$jevNo = $database->charEncoder($_GET['jevNo']);
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		
		$office = substr($trackingNumber,0,4);
		
		$obrNumber = $database->charEncoder($_GET['saaobOBRNo']);
		$checkNumber = $database->charEncoder($_GET['checkNumber']);
		$adv = $database->charEncoder($_GET['adv']);
		
		$claimant =  $database->charEncoder($_GET['claimant']);
		$claimType = $database->charEncoder($_GET['claimType']);
		$programCode =  $database->charEncoder($_GET['programCode']);
		$accountCode =  $database->charEncoder($_GET['accountCode']);
		$amount =  $database->charEncoder($_GET['amount']);
		$chargeType = $database->charEncoder($_GET['chargeType']);
		
		
		$jevMonth = number_format(substr($jevNo,9,2));
		$jevYear = substr($jevNo,4,4);
		
		if($chargeType > 1){
			$insertThis = '';
			$ids = '';
			$splitProgramCode = explode("~!~",$programCode);
			$splitAccountCode = explode("~!~",$accountCode);
			$splitAmount = explode("~!~",$amount);
			
			$updateCase = 'UPDATE vouchercurrent SET JevNo = "' . $jevNo . '", JevAmount = CASE ';
			for($i = 0; $i < sizeof($splitProgramCode)-1;$i++ ){
				$pCode = $splitProgramCode[$i];
				$aCode = $splitAccountCode[$i];
				$amt = $splitAmount[$i];
				$ids .=  ',"' . $pCode . '"';
				$updateCase .= ' WHEN PR_ProgramCode = "' . $pCode . '" and PR_AccountCode = "' . $aCode . '" THEN ' . $amt . ' ';
				$insertThis .= ",('" . $year . "','" . $office . "','" . $trackingNumber . "','" . $jevYear . "','" . $jevMonth . "','" . $jevNo ."','" . $adv . "','" . $obrNumber . "','" . $pCode . "','" . $aCode . "'," . $amt . ",'" . $claimant . "','" . $claimType . "','" . $employeeNumber . "','" . $dateEncoded . "')";	
				
			}
			//$database->DeleteToLiquidation($year,$trackingNumber);
			//$database->InsertToLiquidatedMultiple(substr($insertThis,1,strlen($insertThis)));
			$updateCase .= 'End WHERE Year = "' . $year . '" and  TrackingNumber = "' . $trackingNumber . '"';
			$affected = $database->UpdateInsertTransfer($updateCase);
		}else{
			//$database->DeleteToLiquidation($year,$trackingNumber);
			//$database->InsertToLiquidated($year,$office,$trackingNumber,$jevYear,$jevMonth,$jevNo,$adv,$obrNumber,$programCode,$accountCode,$amount,$claimant,$claimType, $employeeNumber,$dateEncoded);	
			$database->UpdateJevNo($year,$trackingNumber,$jevNo,$amount);	
		}
		$record =  $database->FetchDisbursementLiquidatedBy($year,"CheckNumber",$checkNumber);
		
		echo $sheet->CreateSearchBySAAOBOBR($record);
		
	}	
	
	
	if(isset($_GET['LoadAccountCodes'])){
		$office = $database->charEncoder($_GET['office']);
		$programCode = $database->charEncoder($_GET['programCode']);
		if($office == "All"){
			$record = $database->FetchAllAccountCodes($year,$programCode);
			
			
		}else if($office == "AllCodes"){
			$record = $database->FetchOverAllAccountCodes($year);
		}else{
			$record = $database->FetchAccountCodes($year,$office,$programCode);
		}
		
		echo $sheet->CreateAccountCodesHeader($record);
		
	}
	if(isset($_GET['LoadAccountCodesLiquidated'])){
		$office = $database->charEncoder($_GET['office']);
		$programCode = $database->charEncoder($_GET['programCode']);
		$accountCode = $database->charEncoder($_GET['accountCode']);
		if($office == "All"){
			$record =  $database->FetchAllDisbursementInLiquidated($year,$programCode,$accountCode);
		}else if($office == "AllCodes"){
			$record =  $database->FetchOverAllDisbursementInLiquidated($year,$accountCode);
		}else{
			$record =  $database->FetchDisbursementInLiquidated($year,$office,$programCode,$accountCode);
		}
		echo $sheet->CreateDisbursementFromLiquidated($record);
	}
	if(isset($_POST['BeginTransfer'])){
		$accountCode =   trim($database->charEncoder($_POST['accountCode']));
		$content =   $database->charEncoder($_POST['data']);
		$line = explode("~~",$content);	
		$ids = ''; 
		$length = sizeof($line)-1;
		$updateCase = 'UPDATE vouchercurrent SET JevNo = CASE ';
		$updateCaseA = '';
		$updateCaseB = ', JevAmount = CASE ';
		$insertCase = 'INSERT INTO liquidated (Year,Office,ProgramCode,TrackingNumber,Adv,Obrnumber,checknumber,Claimant,Amount,AccountCode,JevNo)
			                  SELECT Year,Office,PR_ProgramCode,TrackingNumber,if(Adv2 > 0,Adv2,Adv1) as Adv, OBR_number,checknumber,Claimant,JevAmount, PR_AccountCode,JevNo from vouchercurrent where pr_accountcode =  "' . $accountCode .'" and ';
		for($i = 1; $i < $length;  $i++){
			$field =	explode(",",$line[$i]);
			$jev = $field[0];
			$check =   $field[1].trim(" ");
			$amount = $field[2];
			$updateCaseA .= ' WHEN checknumber = ' . $check . ' THEN "' . $jev . '" ';
			$updateCaseB .= ' WHEN checknumber = ' . $check . ' THEN ' . $amount . ' ';
			$ids .=  ',' . $check ;
		}
		$updateCaseA .= ' END ' . $updateCaseB . ' END';
		$updateCase .= $updateCaseA . ' WHERE checknumber IN (' . substr($ids,1,strlen($ids)) . ') and  PR_AccountCode = "' . $accountCode . '"';
		$insertCase .= 'checknumber IN(' . substr($ids,1,strlen($ids)) . ')' ; 
		$affected = $database->UpdateInsertTransfer($updateCase);
		echo $affected .  ' of ' . ($length-1)  . ' rows updated.<br/>';
		//$deleteCase = 'Delete from liquidated  WHERE Year = ' . $year . ' and accountcode = "' . $accountCode . '"';
		//$database->UpdateInsertTransfer($deleteCase);
		//$affected = $database->UpdateInsertTransfer($insertCase);
		//echo $affected .  ' of ' . ($length-1)  . ' rows copied.';
	}
	if(isset($_POST['BeginTransferTN'])){
		$accountCode =   trim($database->charEncoder($_POST['accountCode']));
		$content =   $database->charEncoder($_POST['data']);
		$line = explode("~~",$content);	
		$ids = ''; 
		$length = sizeof($line)-1;
		$updateCase = 'UPDATE vouchercurrent SET JevNo = CASE ';
		$updateCaseA = '';
		$updateCaseB = ', JevAmount = CASE ';
		
		for($i = 1; $i < $length;  $i++){
			$field =	explode(",",$line[$i]);
			$jev = $field[0];
			$tn =  '\'' . $field[1].trim(" ") . '\'';
			$amount = $field[2];
			$updateCaseA .= ' WHEN TrackingNumber = ' . $tn . ' THEN "' . $jev . '" ';
			$updateCaseB .= ' WHEN TrackingNumber = ' . $tn . ' THEN ' . $amount . ' ';
			$ids .=  ',' . $tn ;
		}
		$updateCaseA .= ' END ' . $updateCaseB . ' END';
		$updateCase .= $updateCaseA . ' WHERE TrackingNumber IN (' . substr($ids,1,strlen($ids)) . ') and  PR_AccountCode = "' . $accountCode . '"';
		
		$affected = $database->UpdateInsertTransfer($updateCase);
		echo $affected .  ' of ' . ($length-1)  . ' rows updated.';
	}
	if(isset($_GET['CheckDetailsSAAOB'])){
		$checkNumber = $database->charEncoder($_GET['checkNumber']);
		$record =  $database->FetchDisbursementLiquidatedBy($year,"CheckNumber",$checkNumber);
	
		if($database->num_rows($record)!= 0 ){
			echo $sheet->CreateSearchBySAAOBOBR($record);
		}else{
			echo '<div style = "padding:10px 20px;background-color:rgab(252, 162, 1621);color:red;font-weight:bold;" class = "label7">No record found.</div>';
		}
	}
	if(isset($_GET['EditInLiquidated'])){
		$id = $database->charEncoder($_GET['id']);
		$field = $database->charEncoder($_GET['field']);
		$value = $database->charEncoder($_GET['value']);
		$amountOld = $database->charEncoder($_GET['amountOld']);	
		
		$checkNumber = $database->charEncoder($_GET['checkNumber']);	
		$type = $database->charEncoder($_GET['type']);
		$charge = $database->charEncoder($_GET['charge']);
		
		if($charge > 1){
			if($value > $amountOld){
				$diff = $value - $amountOld;
				$sign = '+';
			}else{
				$diff = $amountOld - $value;
				$sign = '-';
			}
			$case = "UPDATE vouchercurrent SET " . $field . " = '" . $value . "' WHERE Year = " . $year  . " and  Id = " . $id . "";
			$database->UpdateInsertSpecial($case);
			$case = "UPDATE vouchercurrent SET TotalAmountMultiple = TotalAmountMultiple " . $sign .  $diff . "  WHERE Year = " . $year  . " and  CheckNumber = " . $checkNumber . "";
			$database->UpdateInsertSpecial($case);		
		}else{
			$case = "UPDATE vouchercurrent SET " . $field . " = '" . $value . "'  WHERE Year = " . $year  . " and  Id = " . $id . "";		
			$database->UpdateInsertSpecial($case);
		}		
		$record =  $database->FetchDisbursementLiquidatedBy($year,"CheckNumber",$checkNumber);
		echo $sheet->CreateSearchBySAAOBOBR($record);
	}

	if(isset($_GET['LoadCategoryList'])){
		$record = $database->SelectCategoryList($office);
		echo $sheet->CreateCategoryList($record);	
	}
	if(isset($_GET['GetCategoryItems'])){
		$category = $database->charEncoder($_GET['category']);
		$categoryList = explode("~!~",$category); 
		$list = "";
		$size = sizeof($categoryList)-1;
		for($i = 0; $i < $size; $i++){
			$list .= '"' . $categoryList[$i] . '",';
		}
		$list = substr($list,0,strlen($list)-1);
		if($size > 0){
			$sql = "select *,quantity as qty, est_budget as amount from bacdb2018.ppmp where office_code = '" . $office . "' and  item_category in (" . $list . ")";
			$record = $database->SelectQuery($sql);
			echo $sheet->CreateCategoryItems($record);
		}else{
			echo 0;
		}		
	}
	if(isset($_GET['GetCategoryItemsByMonth'])){
		$category = $database->charEncoder($_GET['category']);
		$month = $database->charEncoder($_GET['month']);
		
		$categoryList = explode("~!~",$category); 
		$list = "";
		$size = sizeof($categoryList)-1;
		for($i = 0; $i < $size; $i++){
			$list .= '"' . $categoryList[$i] . '",';
		}
		$list = substr($list,0,strlen($list)-1);
		if($size > 0){
			$sql = "select *," . $month ." as qty, est_budget as amount from bacdb2018.ppmp where office_code = '" . $office . "' and " . $month . " > 0 and  item_category in (" . $list . ")";
			$record = $database->SelectQuery($sql);
			if($database->num_rows($record) > 0){
				echo $sheet->CreateCategoryItems($record);
			}else{
				echo 0;
			}
			
		}else{
			echo 0;
		}	
	}
	if(isset($_GET['viewHistory'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$sql = "Select * from voucherhistory where trackingnumber = '" . $trackingNumber . "'";
		
		$record = $database->SelectQuery($sql);
		echo $sheet->CreateHistory($record);
	}
	if(isset($_GET['SelectPrReleased'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$sqlA = "select TrackingNumber,PR_Number,OBR_Number,Fund,ChargeType,PR_Month,PR_CategoryCode,Description  from vouchercurrent a
				left join ppmpcategories b on a.PR_CategoryCode = b.Code	
				 where trackingnumber = '"  . $trackingNumber . "'";
		$sqlB = 'select * from prrecord where trackingnumber = "' . $trackingNumber . '"';
		$recordA = $database->SelectQuery($sqlA);
		$recordB = $database->SelectQuery($sqlB);
		$count = $database->num_rows($recordA);
		if($count >= 1){
			echo $sheet->CreatePRgendetails($recordA);
			echo $sheet->CreatePOItems($recordB);
		}else{
			echo 0;
		}
	}
	
	if(isset($_GET['loadOfficeApp'])){
		
		$sql = "Select * from office order by name asc";
		$record = $database->FetchThis($sql);
		echo $sheet->CreateOfficeSelectOfficialB($record,"SelectOfficeApp","loadAppPerOffice");
	}
	if(isset($_POST['saveFileApp'])){
		$officeCode =  $database->charEncoder($_POST['office']);
		$data = $database->charEncoder($_POST['data']);
		$insertThis = '';		
		$arrA =  explode('!*!',$data);
		$p = '';
		$prg ='';
		for($i = 0 ; $i < sizeof($arrA)-1; $i++ ){
			$arrB = 	explode('!~!',$arrA[$i]);
			$code = $arrB[0];
			$program = $arrB[1];
			if($p != $program){
				$p = $program;
				$prg  .= ',"' . $p . '"';
			}
			$amount = $arrB[2];
			$insertThis .= ",(" . $year . ",'" . $officeCode . "','" . $program . "','" . $code . "'," . $amount . ",'" . $employeeNumber . "','" . $dateEncoded ."')";
		}
		
		$deleteCase = "Delete from funds where officecode = '" . $officeCode . "' and programCode in(" . substr($prg,1,strlen($prg))  . ")";
		$database->UpdateInsertSpecial($deleteCase);
		
		$insertCase = "INSERT INTO funds (Year,OfficeCode,ProgramCode,AccountCode,Amount,EncodedBy,DateEncoded)VALUES " .  substr($insertThis,1,strlen($insertThis)) ; 
		$affected =  $database->UpdateInsertSpecial($insertCase);
		echo $affected;
	}
	if(isset($_GET['loadAppPerOffice'])){
		$officeCode = $database->charEncoder($_GET['officeCode']);
		
		$record =  $database->GetEncodedFund($defaultYear,$officeCode);
		echo $sheet->CreateEncodedFundTable($record) ;
	}
	if(isset($_GET['loadAppPerProgram'])){
		$program =  $database->charEncoder($_GET['program']);
		$officeCode = $database->charEncoder($_GET['officeCode']);
		$case = "where officecode = '" .  $officeCode . "' and ProgramCode= '" . $program . "'";
		$record = $database->GetEncodedByCondition($case);
		echo $sheet->CreateEncodedFundTable($record) ;
	}
	if(isset($_GET['removeApp'])){
		$program = $database->charEncoder($_GET['programCode']);
		$officeCode = $database->charEncoder($_GET['officeCode']);
		$code = $database->charEncoder($_GET['code']);
		
		$sql = "Delete from funds where officeCode = '" . $officeCode . "' and ProgramCode = '" . $program . "' and AccountCode = '" . $code . "'";
		$affected = $database->UpdateInsertSpecial($sql);
		echo $affected;
	}
	if(isset($_GET['prEdit'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$type = substr($trackingNumber,0,2);
		if($type == "PR"){
			$sql = "Select a.*,b.Id  as ItemId, b.Description as ItemDescription from prrecord a left join ppmpitems b on a.Item = b.Id where a.trackingnumber = '" .  $trackingNumber .  "' order by a.programcode asc";
		}else{
			$sql = "Select a.*,b.Id  as ItemId, b.Description as ItemDescription from porecord a left join ppmpitems b on a.Item = b.Id where a.trackingnumber = '" .  $trackingNumber .  "' order by a.programcode asc";
			//$sql = "Select * from porecord where trackingnumber = '" .  $trackingNumber .  "' order by programcode asc";
		}
		$record =  $database->FetchThis($sql);

		echo $sheet->CreateCategoryItemsEdit($record);
	}
	if(isset($_GET['obrEdit'])){
		$type = $database->charEncoder($_GET['type']);
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		if($type == 1){
			//added `PeriodMonth`,`Claimant`, `TrackingPartner`, `DocumentType` sa columns para sa upload file sa WAGES
			$sql = "Select a.Office,a.TrackingNumber,a.PR_ProgramCode,a.PR_AccountCode,a.Amount,a.SubCode,a.PeriodMonth,a.Claimant, a.TrackingPartner, a.DocumentType, a.PeaceOfficeId, b.Title, c.Name from vouchercurrent a left join fundtitles b on a.PR_AccountCode = b.Code left join programcode c on a.PR_ProgramCode = c.Code		
			where a.trackingnumber = '" .  $trackingNumber .  "'";
			
			$record =  $database->FetchThis($sql);

			echo $sheet->CreateOBRAmountEdit($record, $type, $office, $accountType);	
		}else{
			$sql = "Select a.Office,a.TrackingNumber,a.PR_ProgramCode,a.PR_AccountCode,a.Amount,a.SubCode,a.PeriodMonth,a.Claimant, a.TrackingPartner, a.DocumentType, a.PeaceOfficeId, b.Title, c.Name from vouchercurrent a left join fundtitles b on a.PR_AccountCode = b.Code left join programcode c on a.PR_ProgramCode = c.Code		
			where a.trackingnumber = '" .  $trackingNumber .  "'";
			$record =  $database->FetchThis($sql);

			$comp = "	<table border='0' style='border-spacing:0px; margin:0px auto; margin-bottom:20px;'>
							<tr>
								<td><span class='numberField'>Enter PTRS No.</span></td>
								<td style='padding-bottom:0px; padding-left:7px;'>
									<input style='text-align: left;padding-left:10px;font-weight: bold;text-transform:uppercase;' id='sequenceNumWGS1' onchange='resetDbfTable()' onclick='clickInput(this)' onkeydown='keypressAndWhatClear(this,event,searchPTRS,1)' class='data2 checkPY' type='text' placeholder='Please input PTRS Number and hit Enter.'>
									<input id='updateWGSTn' style='display:none;' value='".$trackingNumber."' disabled>
								</td>
							</tr>
							<tr>
								<td colspan='2' style='padding-top:20px;' id='dbfTable1'>".$sheet->CreateOBRAmountEdit($record, $type, $office, $accountType)."</td>
							</tr>
						</table>";

			echo $comp;



			// $sql = "SELECT id,type,period FROM brgs.sp_transaction_header WHERE trackingNumber = '".$trackingNumber."' AND trackingYear = '".$year."'";
			// $result = $database->query($sql);

			// $sql1 = "SELECT DocumentType FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
			// $result1 = $database->query($sql1);
			// $temp = $database->fetch_array($result1);
			// $docType = $temp['DocumentType'];

			// $ptrs = "";
			// $headerIds = "";
			// while($data = $database->fetch_array($result)){
			// 	$headerIds .= ",".$data['id'];
			// 	$type = $data['type'];
			// 	$period = $data['period'];
			// 	if($type == ""){
			// 		$type = "RP";
			// 	}

			// 	$curTable = "";
			// 	if($type == "RP" || $type == "VP"){
			// 		$curTable = "rp_transaction_details";
			// 	}else{
			// 		$curTable = "sp_transaction_details";
			// 	}

			// 	$ptrs .= ",".$type."-".$period."".$data['id'];
			// }
			// $headerIds = substr($headerIds, 1);
			// $ptrs = substr($ptrs, 1);


			// $sql = "SELECT a.*, b.lastname, b.firstname, b.middlename, b.extension 
			// 		FROM 
			// 		brgs.".$curTable." a
			// 		left join brgs.employees b on a.empno = b.empno
			// 		WHERE 
			// 		a.header_id IN (".$headerIds.")";
			// $record = $database->query($sql);
			// $empRows = $database->num_rows($record);

			// echo $sheet->CreateOBRAmountRefresh($record, $empRows, $type, $ptrs, $docType, $defaultYear, $trackingNumber, 2);
		}
		
	}
	if(isset($_GET['fetchSubProgramBalanceForEdit'])){
		$key = $database->charEncoder($_GET['key']);
		$sql = "select * from peace order by fund,name asc";
		$record = $database->query($sql);
		echo $sheet->createPeaceOfficeEDIT($record, $key);
	}
	if(isset($_GET['prEditCancel'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		
		// $record = $database->SearchTracking($trackingNumber);
		// $count =  $database->num_rows($record);
		// if($count > 0){
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }
		
		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}


	# pis

	/**if(isset($_GET['pisEditCancel'])){ 
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$record = $database->searchTrackingNumberOnInventory($trackingNumber);
		$count =  $database->num_rows($record);
		if($count > 0){
			echo $sheet->CreateAIRTrackerInfo($record);
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}

	if(isset($_GET['pisEditz'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$type = substr($trackingNumber,0,2);

		$sql =	"Select a.*, b.Item, b.ItemDescription, b.SerialNumber, b.PropertyNumber, b.ClassificationNumber, b.Setter
				 FROM amis.porecord a
				 left join amis.pirecord b on a.Id = b.ItemNumber
				 where a.TrackingNumber = '" .  $trackingNumber .  "'  order by a.programcode, b.Setter asc";
				
		$record =  $database->FetchThis($sql);
		echo $sheet->CreateCategoryPISItemsEdit($record);
	}

	if(isset($_POST['updatePISData'])){
		$trackingNumber = $database->charEncoder($_POST['trackingNumber']);
		$pisData =  $database->charEncoder($_POST['pisData']);
		$insertThis = '';
		$splitPISdata =  explode("~#~",$pisData);
		for($i = 0; $i < sizeof($splitPISdata)-1;$i++ ){
			$pisData = explode("~!~", $splitPISdata[$i]);
			$itemNumber = $database->charEncoder($pisData[0]);
			$set = $database->charEncoder(urldecode($pisData[1]));
			$item = $database->charEncoder(urldecode($pisData[2]));
			$itemDescription = $database->charEncoder(urldecode($pisData[3]));
			$sn = $database->charEncoder(urldecode($pisData[4]));
			$pn = $database->charEncoder(urldecode($pisData[5]));
			$cn = $database->charEncoder(urldecode($pisData[6]));

			$insertThis .= ",('" . $trackingNumber . "','" . $itemNumber .  "','" . $set . "','" . $item . "','" . $itemDescription . "','". $sn . "','" . $pn ."','" . $cn ."')";		
		}
			$insertPISdetails =  substr($insertThis,1,strlen($insertThis));

			$sql = "Delete from amis.pirecord  where TrackingNumber = '". $trackingNumber ."' and ItemNumber = '". $itemNumber ."'";
			$database->UpdateInsertSpecial($sql);

			$case = "Insert into amis.pirecord(TrackingNumber,ItemNumber,Setter,Item,ItemDescription,SerialNumber,PropertyNumber,ClassificationNumber)values " . $insertPISdetails ; 
			$affected = $database->UpdateInsertSpecial($case);
		
			$queryString = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.Description as  CategoryName
							FROM vouchercurrent a 
							left join office b on a.office = b.code  
							left join citydoc.employees c on a.encodedby = c.employeenumber
							left join programcode d on a.PR_ProgramCode = d.code
							left join fundtitles e on a.PR_AccountCode = e.Code
							left join ppmpcategories f on a.PR_CategoryCode = f.Code
							where a.TrackingNumber = '" . $trackingNumber . "' order by a.pr_programcode,a.pr_accountcode";
			$record1 = $database->query($queryString);
			$count =  $database->num_rows($record1);
			if($count >= 1){
				echo $sheet->CreateAIRTrackerInfo($record1);
			}else{
				echo "<span class = 'remark1'>No record found.</span>";
			}
			
	}


	if(isset($_GET['updatePISItems'])){
		$ItemNumber = $_GET['ItemNumber'];
		$rowNumber = $_GET['rowNumber'];
		$category = $_GET['category'];

		$sql = 'Select * from amis.pirecord where ItemNumber = "' . $ItemNumber . '" order by Setter asc';
		$record =  $database->FetchThis($sql);

		$sql1 = 'Select * from amis.porecord where Id = "' . $ItemNumber . '"';
		$record1 = $database->FetchThis($sql1);

		$sql2 = 'Select Description from ppmpitems where CategoryCode = "'.$category.'"';
		$record2 = $database->FetchThis($sql2);

		echo $sheet->CreatePIRrecordList($record,$record1,$rowNumber,$record2);
	}
	*/


	if(isset($_POST['updatePR'])){
		$trackingNumber = $database->charEncoder($_POST['trackingNumber']);
		$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "'";
		$record = $database->FetchThis($sql);
		while($data = $database->fetch_array($record)){
			$year = $data['Year'];
			$id = $data['Id'];
			$trackType = $data['TrackingType'];
			$office = $database->charEncoder($data['Office']);
			$adv = $data['ADV1'];
			$fund =  $data['Fund'];
			$claimType = $database->charEncoder($data['ClaimType']);
			$docType = $database->charEncoder($data['DocumentType']);
			$claimant = $database->charEncoder($data['Claimant']);
			$encodedBy = $data['EncodedBy'];
			$dateEncoded = $data['DateEncoded'];
			$modifiedBy = $data['ModifiedBy'];
			$dateModified = $data['DateModified'];
			
			$dateReleased = $data['DateReleased'];
			
			$status = $data['Status'];
			$remarks = $database->charEncoder($data['Remarks']);
			$completion = $data['Completion'];
			$obrApproved =  $data['OBR_Approve'];
			$checkNumber =  $data['checknumber'];
			$checkDate =  $database->charEncoder($data['checkdate']);
			$prCategory = $database->charEncoder($data['PR_CategoryCode']);
			$prTrackingNumber = $data['PR_TrackingNumber'];
			$prMonth = $data['PR_Month'];
			$prNumber = $data['PR_Number'];
			$obrNumber = $data['OBR_Number'];
			$poNumber =  $data['PO_Number'];
			$subCode = $database->nullToZero($data['SubCode']);
			$netAmount = $data['NetAmount'];
			$control = $data['ControlNo'];			
			
			$periodType = $data['PeriodType'];
			$periodMonth = $data['PeriodMonth'];
			$trackingPartner = $data['TrackingPartner'];
			
			$jevNo = $data['JevNo'];
			$jevAmount = $data['JevAmount'];

			$mode = $data['ModeOfProcurement'];
			$nature = $data['NatureOfPayment'];
			$specifics = $data['Specifics'];
			
			$pyTerm = $data['PaymentTerm'];
			if($pyTerm == '') {
				$pyTerm = 0;
			}

		}
		
		if($control == '' || $control < 0){
			$control = 0;
		}
		if($jevAmount == '' || $jevAmount < 0){
			$jevAmount = 0;
		}
		
		
		if($netAmount == ''){
			$netAmount = 0;
		}
		
		$prData = $_POST['prData'];
		$grp =  $database->charEncoder($_POST['grp']);
		$oTotal =  $database->charEncoder($_POST['oTotal']);
		// if($oTotal > 50000){
		// 	$mode =  1;
		// }else{
		// 	$mode =  2;
		// }
		
		$catX = 0;
		$cat = '';
		
		$progX = 0;
		$pro = '';
		
		$codeX = 0;
		$cod = '';
		
		$insertThis = '';
		$splitPRdata =  explode("~#~",$prData);
		for($i = 0; $i < sizeof($splitPRdata)-1;$i++ ){
			$prData = explode("~!~", $splitPRdata[$i]);
			$category = $database->charEncoder($prData[0]);
			$program = $database->charEncoder(urldecode($prData[1]));
			$code = $database->charEncoder(urldecode($prData[2]));
			$desc = $database->charEncoder(urldecode($prData[3]));
			//$desc = urldecode($prData[3]);
			$desc = $database->charEncoder(urldecode($prData[3]));
			$qty = $prData[4];
			$unit = $database->charEncoder(urldecode($prData[5]));
			$itemId = $database->charEncoder($prData[6]);
			$cost = $prData[7];
			
			$total = $qty * $cost;	
			// identify  charge type 1-5
			if($cat != $category){
				$catX++;
				$cat = $category;
			}
			if($pro != $program){
				$progX++;
				$pro = $program;
			}
			
			if($cod != $code){
				$codeX++;
				$cod = $code;
			}
			$insertThis .= ",('" . $trackingNumber . "','" . $category . "','" . $program . "','" . $code . "', '" . $itemId .  "','" . $desc ."'," . $qty . ",'" .   ucfirst($unit) . "'," . $cost . "," . $total . ")";		
		}
		$chargeType = 0;
		if($catX == 1){
			if($progX == 1){
				if($codeX == 1){
					$chargeType = 1;
					$oTotal = 0;
				}else{
					$chargeType = 2;
				}
				
			}else if ($progX > 1){
				$chargeType = 3;
			}
		}else if ($catX == 2){
			$chargeType = 4;
		}
		$insertPRdetails =  substr($insertThis,1,strlen($insertThis));

		if($trackType == "PR"){
			$sql = "Delete from prrecord where TrackingNumber ='" . $trackingNumber . "'";
			$database->UpdateInsertSpecial($sql);
			$case = "Insert into prrecord(TrackingNumber,Category,ProgramCode,Code,Item,Description,Qty,Unit,Amount,Total)values " . $insertPRdetails ; 
			$affected = $database->UpdateInsertSpecial($case);
		}else{
			$sql = "Delete from porecord where TrackingNumber ='" . $trackingNumber . "'";
			$database->UpdateInsertSpecial($sql);
			$case = "Insert into porecord(TrackingNumber,Category,ProgramCode,Code,Item,Description,Qty,Unit,Amount,Total)values " . $insertPRdetails ; 
			$affected = $database->UpdateInsertSpecial($case);
		}
		$insertThis = '';
	
		$splitGRPdata =  explode("~#~",$grp);
		for($i = 0; $i < sizeof($splitGRPdata)-1;$i++ ){
			$grpData = explode("~!~", $splitGRPdata[$i]);
			$category = urldecode($grpData[0]);
			$program = urldecode($grpData[1]);
			$code = urldecode($grpData[2]);
			$total = urldecode($grpData[3]);
			
			$insertThis .= ",('" . $year . "','" . $office . "','" . $fund ."' ,'" . $trackType . "','" .  $prMonth . "','" .
				                       $trackingNumber . "','" . $category . "','" . $program . "','" .  $code  . "'," . $total . "," .  $oTotal . ",'" .  
						 	 $encodedBy . "','" .  $dateEncoded . "','" .  $status .  "'," . $chargeType . ",'" .  $modifiedBy . "', '" . $dateModified . "','" . $prNumber . "','" . $obrNumber . "','" . $prTrackingNumber . "','" . $poNumber . "','" . $remarks . "'," . $adv . ",'" . $claimant . "'
						 	 ,'" . $claimType . "','" . $docType . "'," . $mode . "," . $subCode . ",'" . $control . "', '" . $netAmount . "', '" . $checkDate . "','" . $checkNumber . "','" . $dateReleased . "'
						 	 ,'" . $periodType . "','" . $periodMonth . "','" . $trackingPartner . "','" . $jevNo . "','" . $jevAmount . "','" . $completion . "','" . $nature . "','" . $specifics . "','" . $pyTerm . "')";		
		}
		$insertGRPdetails =  substr($insertThis,1,strlen($insertThis));
		if($trackType == "PR"){
			$case = "Insert into vouchercurrent(Year,Office,Fund,TrackingType,PR_Month,TrackingNumber,PR_CategoryCode,PR_ProgramCode,
					PR_AccountCode,Amount,TotalAmountMultiple,EncodedBy,DateEncoded,Status,ChargeType,ModifiedBy,DateModified,PR_Number,OBR_Number,
					PR_TrackingNumber,PO_Number,Remarks,ADV1,Claimant,ClaimType,DocumentType,ModeOfProcurement,SubCode,ControlNo,NetAmount,CheckDate,CheckNumber,DateReleased,PeriodType,PeriodMonth,TrackingPartner,JevNo,JevAmount,Completion,
					NatureOfPayment, Specifics, PaymentTerm
					)values " . $insertGRPdetails ; 
		}else{
			$case = "Insert into vouchercurrent(Year,Office,Fund,TrackingType,PR_Month,TrackingNumber,PR_CategoryCode,PR_ProgramCode,
					PR_AccountCode,PO_Amount,TotalAmountMultiple,EncodedBy,DateEncoded,Status,ChargeType,ModifiedBy,DateModified,PR_Number,OBR_Number,
					PR_TrackingNumber,PO_Number,Remarks,ADV1,Claimant,ClaimType,DocumentType,ModeOfProcurement,SubCode,ControlNo,NetAmount,CheckDate,CheckNumber,DateReleased,PeriodType,PeriodMonth,TrackingPartner,JevNo,JevAmount,Completion,
					NatureOfPayment, Specifics, PaymentTerm
					)values " . $insertGRPdetails ; 
		}
		/*$case = "Insert into vouchercurrent(Year,Office,Fund,TrackingType,PR_Month,TrackingNumber,PR_CategoryCode,PR_ProgramCode,
					PR_AccountCode,PO_Amount,TotalAmountMultiple,EncodedBy,DateEncoded,Status,ChargeType,ModifiedBy,DateModified,PR_Number,OBR_Number,
					PR_TrackingNumber,PO_Number,Remarks,ADV1,Claimant,ClaimType,DocumentType,ModeOfProcurement,SubCode,ControlNo,NetAmount,CheckDate,CheckNumber,DateReleased,PeriodType,PeriodMonth,TrackingPartner,JevNo,JevAmount,Completion
					)values " . $insertGRPdetails ; */
		$database->EditLogs($trackingNumber,$trackType,"Undetermined","Undetermined",$_SESSION['officeCode'],$_SESSION['fullName'],$today);	
		
		//insert to current
		$affected = $database->UpdateInsertSpecial($case);
		$sql = "Delete from vouchercurrent where Id <=" . $id . " and trackingnumber = '" . $trackingNumber . "'";
		$database->UpdateInsertSpecial($sql);


		// // updating sa TERMS and CONDITIONS - 2023-06-21
		// $terms = $database->charEncoder($_POST['terms']);
		// if(strlen(trim($terms)) == 0) {
		// 	$terms = "NULL";
		// }else {
		// 	$terms = "'".$terms."'";
		// }
		// $sql = "UPDATE particulars SET Terms = ".$terms." WHERE TrackingNumber = '".$trackingNumber."'";
		// $database->query($sql);

		// updating sa TERMS and CONDITIONS, HEADER - 2023-07-18
		$terms = $database->charEncoder($_POST['terms']);
		if(strlen(trim($terms)) == 0) {
			$terms = "NULL";
		}else {
			$terms = "'".$terms."'";
		}

		$header = $database->charEncoder($_POST['header']);
		if(strlen(trim($header)) == 0) {
			$header = "NULL";
		}else {
			$header = "'".$header."'";
		}

		$sql = "UPDATE particulars SET Terms = ".$terms.", Header = ".$header." WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);
		
		// $record = $database->SearchTracking($trackingNumber);
		// //$record = $database->query($sql);
		// $count =  $database->num_rows($record);
		// if($count > 0){
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			// echo $sheet->CreateDoctrackInfoPR($record);
			if($record['TrackingType'] == "PO"){
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}
			
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	if(isset($_GET['updateOBR'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		
		$sql = "Select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "'";
		$record = $database->FetchThis($sql);
		while($data = $database->fetch_array($record)){	
			$year = $data['Year'];
			$trackType = $data['TrackingType'];
			$office = $database->charEncoder($data['Office']);
			$adv = $data['ADV1'];
			$fund =  $data['Fund'];
			$claimType = $data['ClaimType'];
			$docType = $database->charEncoder($data['DocumentType']);
			$claimant = $database->charEncoder($data['Claimant']);
			
			$trackingPartner = $data['TrackingPartner'];
			$periodMonth = $data['PeriodMonth'];
			$periodType = $data['PeriodType']; 
			
			$controlNo = $data['ControlNo'];
			
			$encodedBy = $data['EncodedBy'];
			$dateEncoded = $data['DateEncoded'];
			$modifiedBy = $data['ModifiedBy'];
			$dateModified = $data['DateModified'];
			$status = $data['Status'];
			$remarks =   $database->charEncoder($data['Remarks']);
			$completion = $data['Completion'];	
			$obrApproved =  $data['OBR_Approve'];
			$checkNumber =  $data['checknumber'];
			$checkDate =  $data['checkdate'];
			$prCategory = $data['PR_CategoryCode'];
			$prTrackingNumber = $data['PR_TrackingNumber'];
			$prMonth = $data['PR_Month'];
			$prNumber = $data['PR_Number'];
			$obrNumber = $data['OBR_Number'];
			$poNumber =  $data['PO_Number'];
			$net =$data['NetAmount'];
			if($net < 0 || $net == ''){
				$net = 0;
			}
			
			$subCode = $database->nullToZero($data['SubCode']);
			
			$payrollAmountFirst =  $data['PayrollAmountFirst'];
			if($payrollAmountFirst == ''){
				$payrollAmountFirst = 0;
			}
			$payeeNumber =$data['PayeeNumber'];
			$id = $data['Id'];
		}
		
		$grp =   $database->charEncoder($_GET['grp']);
		$oTotal =  $database->charEncoder($_GET['oTotal']);
		$chargeType =   $database->charEncoder($_GET['chargeType']);
		$sub =   $database->charEncoder($_GET['subC']);
		$peorOfc =   $database->charEncoder($_GET['peorOfc']);
		
		if($office != "LING") { // 2023-09-27 - gi-add ni para kay HRMO LINGAP kay pag mag change siya charges dpat dli ma-apil ang net ug ka change pud.

			// if(substr($docType, 0, 5) != 'BILLS' && $docType != 'PAYMENT - EXTRAORDINARY EXPENSE' && $docType != 'PAYMENT - OTHER OPERATING EXPENSE' && $docType != 'PAYMENT - RENTAL' && $docType != 'REPLENISHMENT' && substr($docType, 0, 5) != 'WAGES') {
			if(substr($docType, 0, 5) != 'BILLS' && $docType != 'PAYMENT - EXTRAORDINARY EXPENSE' && $docType != 'PAYMENT - OTHER OPERATING EXPENSE' && $docType != 'PAYMENT - RENTAL' && substr($docType, 0, 5) != 'WAGES') { // 2023-07-14 - removed replenishment filter by request of CAO Janice.
				$net = $oTotal;
			}

		}

		
		
		//$sql = "Delete from vouchercurrent where TrackingNumber ='" . $trackingNumber . "'";
			
		$insertThis = '';
	
		$splitGRPdata =  explode("~~",$grp);
		$forSub = '';
		if(sizeof($splitGRPdata)-1 <= 1){
			$oTotal = 0;
		}
		
		for($i = 0; $i < sizeof($splitGRPdata)-1;$i++ ){
			$grpData = explode("~!~", $splitGRPdata[$i]);
		
			$program = urldecode($grpData[0]);
			$code = urldecode($grpData[1]);
			$total = urldecode($grpData[2]);
			
			/*$insertThis .= ",('" . $year . "','" . $office . "','" . $fund ."' ,'" . $trackType . "','"  . $docType . "','"  . $claimType . "','"  . $periodMonth . "','"   . $periodType . "','" . $trackingPartner . "','" . $controlNo . "','" . 
				                       $trackingNumber . "','" . $program . "','" .  $code  . "'," . $total . "," .  $oTotal . ",'" .  $payrollAmountFirst . "','" . $payeeNumber . "','" . 
						 	 $encodedBy . "','" .  $dateEncoded . "','" .  $status .  "'," . $chargeType . ",'" .  $modifiedBy . "', '" .
						 	  $dateModified . "','" . $prNumber . "','" . $obrNumber . "','" . $prTrackingNumber . "','" . $poNumber . "','" . $remarks . "'," . $adv . ",'" . $claimant . "'," . $subCode . ")";	*/	
			$insertThis .= ",('" . $year . "','" . $office . "','" . $fund ."' ,'" . $trackType . "','"  . $docType . "','"  . $claimType . "','"  . $periodMonth . "','"   . $periodType . "','" . $trackingPartner . "','" . $controlNo . "','" . 
				                       $trackingNumber . "','" . $program . "','" .  $code  . "'," . $total . "," .  $oTotal . ",'" .  $payrollAmountFirst . "','" . $payeeNumber . "','" . 
						 	 $encodedBy . "','" .  $dateEncoded . "','" .  $status .  "'," . $chargeType . ",'" .  $modifiedBy . "', '" .
						 	  $dateModified . "','" . $prNumber . "','" . $obrNumber . "','" . $prTrackingNumber . "','" . $poNumber . "','" . $remarks . "'," . $adv . ",'" . $claimant . "'," . $subCode . ",
						 	  '" . $checkNumber . "','" . $checkDate . "','" . $net . "')";	
			
			$forSub .= '"' . $program . '",';
		}
		$forSub = '(' . substr($forSub,0,strlen($forSub)-1) . ')';
		
		
		
		$insertGRPdetails =  substr($insertThis,1,strlen($insertThis));
		
		/*$case = "Insert into vouchercurrent(Year,Office,Fund,TrackingType,DocumentType,ClaimType,PeriodMonth,PeriodType,TrackingPartner,ControlNo,TrackingNumber,PR_ProgramCode,
				PR_AccountCode,Amount,TotalAmountMultiple,PayrollAmountFirst,PayeeNumber,  EncodedBy,DateEncoded,Status,ChargeType,ModifiedBy,DateModified,PR_Number,OBR_Number,
				PR_TrackingNumber,PO_Number,Remarks,ADV1,Claimant,SubCode
				)values " . $insertGRPdetails ;*/ 
		$case = "Insert into vouchercurrent(Year,Office,Fund,TrackingType,DocumentType,ClaimType,PeriodMonth,PeriodType,TrackingPartner,ControlNo,TrackingNumber,PR_ProgramCode,
				PR_AccountCode,Amount,TotalAmountMultiple,PayrollAmountFirst,PayeeNumber,  EncodedBy,DateEncoded,Status,ChargeType,ModifiedBy,DateModified,PR_Number,OBR_Number,
				PR_TrackingNumber,PO_Number,Remarks,ADV1,Claimant,SubCode,CheckNumber,CheckDate,NetAmount
				)values " . $insertGRPdetails ; 
		
		$database->EditLogs($trackingNumber,$trackType,"OBR Details","OBR Details",$_SESSION['officeCode'],$_SESSION['fullName'],$today);	
		
		//insert to current
		$affected = $database->UpdateInsertSpecial($case);
		
		$sql = 'select * from subprogramcode where MainCode in' . $forSub . ' limit 1';
		$record = $database->query($sql);
		$countSub = $database->num_rows($record);
		// if($countSub > 0){
		// 	$sql = "UPDATE vouchercurrent SET SubCode = '" . $sub . "' WHERE  TrackingNumber = '" . $trackingNumber . "'";
		// 	$database->query($sql);
		// }else{
		// 	$sql = "UPDATE vouchercurrent SET SubCode = '0' WHERE  TrackingNumber = '" . $trackingNumber . "'";
		// 	$database->query($sql);
		// }

		if($countSub > 0){
			$sql = "UPDATE vouchercurrent SET SubCode = '" . $sub . "', PeaceOfficeId = '".$peorOfc."' WHERE  TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
		}else{
			$sql = "UPDATE vouchercurrent SET SubCode = '0', PeaceOfficeId = '0' WHERE  TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
		}
		
		$sql = "Delete from vouchercurrent where Id <= " . $id . " and TrackingNumber = '" . $trackingNumber . "'";
		$database->UpdateInsertSpecial($sql);
		
		
		// $record = $database->SearchTracking($trackingNumber);
		// $count =  $database->num_rows($record);
		// if($count > 0){
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {
			echo $sheet->CreateDoctrackInfoPR($record);
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}
	if(isset($_GET['iosHsueji'])){
		$officeCode = $_SESSION['cbo'];
		$accountType = $_SESSION['accountType'];
		if($accountType == 1){
			$sql = "Select a.Status,a.TrackingNumber,count(a.TrackingNumber) as Count  
				     from  (select Status,TrackingNumber from vouchercurrent where office = '" . $officeCode .  "' group by TrackingNumber) a  group by a.status ";
		}else{
			if($officeCode == "SUGA"){
				$sql = "Select a.Status,a.TrackingNumber,count(a.TrackingNumber) as Count  
				     from  (select Status,TrackingNumber from vouchercurrent where office = '" . $officeCode .  "' group by TrackingNumber) a  group by a.status ";
			}
			if($officeCode == "LING"){
				$sql = "Select a.Status,a.TrackingNumber,count(a.TrackingNumber) as Count  
				     from  (select Status,TrackingNumber from vouchercurrent where office = '" . $officeCode .  "' group by TrackingNumber) a  group by a.status ";
			}
			if($officeCode == "1071"){
				$sql = "Select a.Status,a.TrackingNumber,count(a.TrackingNumber) as Count  
					 		 from (select Status,TrackingNumber from vouchercurrent 
					 		  where 
							status = 'CBO Received'  or 
							status = 'Fund Control'  or
							status = 'Pending at CBO'  or
					 		status = 'Pending Released - CBO'  or
					 		status = 'CBO Released' 
							group by TrackingNumber) a group by a.status";
				
			}else if($officeCode == "1061"){
				
				$sql = "Select Status,TrackingNumber,count(Id) as Count  from vouchercurrent where 
				 status = 'GSO Received'  or 
				 status = 'Pending at GSO'  or
				 status = 'Pending Released - GSO' or
				   
				 status = 'Forwarded to CMO' or
				 status = 'CMO Approved' or
				 status = 'Served to Supplier' or
				 status = 'Supplier Conformed' or
				 status = 'Waiting for Delivery' or
				 status = 'Voucher Encoded' or
				 status = 'GSO Received - Inspection' or
				 status = 'Pending at GSO - Inspection' or
				 status = 'Pending Released - Inspection' or
				 
				 status = 'Inventory' or
				 status = 'Pending at GSO - Inventory' or
				 
				  status = 'Pending Released - Inventory'

				group by status";
			}else if($officeCode == "1081"){
				$sql = "Select a.Status,a.TrackingNumber,count(a.TrackingNumber) as Count  
					 		 from (select Status,TrackingNumber from vouchercurrent  where 
							status = 'CAO Received'  or 
							status = 'Project Encoded' and Fund = 'General Fund' or 
							status = 'Forwarding Transmittal'  or 
							status = 'Forwarded to CTO'  or 
							
							status = 'Pending at CAO'  or
					 		status = 'Pending Released - CAO'  
							group by TrackingNumber) a group by a.Status";
			}else if($officeCode == "1091"){
				$sql = "Select a.Status,a.TrackingNumber,count(a.TrackingNumber) as Count  
					 		 from (select Status,TrackingNumber from vouchercurrent  where 
							status = 'CTO Received'  or 
							status = 'Check Preparation - CTO'  or 
							
							status = 'Forwarded to CTO'  or 
							
							status = 'Pending at CTO'  or
					 		status = 'Pending Released - CTO' or 
					 		status = 'Forwarded to Admin - Operation' or
					 		status = 'Forwarded to Admin - Administration' or
					 		status = 'Forwarded to SP - Admin' or
					 		status = 'Draft' 
					 		   
					 		
					 		
							group by TrackingNumber) a group by a.Status";
			}else if($officeCode == "1031"){
				$sql = "Select a.Status,a.TrackingNumber,count(a.TrackingNumber) as Count  
					 		 from (select Status,TrackingNumber from vouchercurrent  where 
							status = 'Admin Received'  or 	
							status = 'Pending at Admin'  or
					 		status = 'Pending Released - Admin'  
							group by TrackingNumber) a group by a.Status";
			}else if($officeCode == "8751"){ // 12-30-2021 Add para sa receiver sa CEO
				$sql = "Select a.Status,a.TrackingNumber,count(a.TrackingNumber) as Count  
					 		 from (select Status,TrackingNumber from vouchercurrent  where 
							status = 'BAC Received'  or 	
							status = 'Pending at BAC'  or
					 		status = 'Pending Released - BAC' or
					 		status = 'Project Awarded'  
							group by TrackingNumber) a group by a.Status";
			}else if($officeCode == "BACN"){ // 01-20-2022 Add para sa receiver sa BACN
				$sql = "Select a.Status,a.TrackingNumber,count(a.TrackingNumber) as Count  
					 		 from (select Status,TrackingNumber from vouchercurrent  where 
							status = 'BAC Received'  or 	
							status = 'Pending at BAC'  or
					 		status = 'Pending Released - BAC' or
					 		status = 'Project Awarded'  
							group by TrackingNumber) a group by a.Status";
			}else{//dummy lang
				$sql = "Select * from defaults where id = 10 limit 1";
			}
		}
		$record = $database->FetchThis($sql);
		echo $sheet->DisplayStatuses($record);
	}
	if(isset($_GET['hXdErt'])){
		
		$dt = time();
		$today = date('Y-m-d H:i:s', $dt);

		$crypt = $database->charEncoder($_GET['xzTceAWs']);
		$arr = explode('!~!', $database->vArrange1($crypt));
		
		
		
		$forumId = $arr[0];
		
		
		if(isset($arr[1])){
			$lastReply = $arr[1];
		}else{
			$lastReply = '';
		}
		
		
		if($forumId == -1){
			$forumId = 0;
		}
		if($lastReply == -1){
			$lastReply = date('Y-m-d H:i:s',strtotime("-20 days"));
		}
		//echo urldecode($lastReply) . '******************';
		$officeName = $database->charEncoder($_SESSION['officeName']);
		$accountType = $_SESSION['accountType'];
		$employeeNumber = $_SESSION['employeeNumber'];
		
		$lastReply = urldecode($lastReply);
		if($accountType == 1){
			$sql = "SELECT count(Id) as Count,max(Id) as ForumId  FROM forum where 
					  Id > '" . $forumId . "' and Receiver = '" . $officeName . "'  or 
					  Id > '" . $forumId . "' and  Receiver = 'all'";
		}else{
			$sql = "SELECT count(Id) as Count,max(Id) as ForumId  FROM forum where 
					  Id > '" . $forumId . "' and Receiver = '" . $officeName . "'  or 
					  Id > '" . $forumId . "' and  Receiver = 'allthree' or	
					  Id > '" . $forumId . "' and  Receiver = 'all' and SenderOffice != '" . $officeName . "'";
		}
		$record = $database->FetchThis($sql);
		
		
		if($accountType == 1){
			$sql1 = 'SELECT a.Id as ForumId, b.DateEncoded,Count(a.Id) as Count 
					FROM forum a inner join (select ForumId,DateEncoded from forumreplies where DateEncoded > "' . $lastReply . '"  and  SenderId  != "' . $employeeNumber . '" order by dateEncoded Desc) b on a.id = b.ForumId 
					where 
					a.Receiver = "' . $officeName .  '" or
					a.Receiver = "all"  or
					a.SenderOffice = "' . $officeName .  '" 
					group by a.Id order by DateEncoded desc';
		}else{
			$sql1 = 'SELECT a.Id as ForumId, b.DateEncoded,Count(a.Id) as Count 
					FROM forum a inner join (select ForumId,DateEncoded from forumreplies where DateEncoded > "' . $lastReply . '"  and  SenderId  != "' . $employeeNumber . '" order by dateEncoded Desc) b on a.id = b.ForumId 
					where 
					a.Receiver = "' . $officeName .  '" or
					a.Receiver = "all"  or
					a.Receiver = "allthree"  or
					a.SenderOffice = "' . $officeName .  '" 
					group by a.Id order by DateEncoded desc';
		}
		$record1 =    $database->FetchThis($sql1);
		echo $sheet->DisplayInbox($record,$record1);
	}
	if(isset($_GET['loadReplyUpdates'])){
		
		$ids =  $database->charEncoder($_GET['forumIds']);
		$ids =  substr($ids,0, strlen($ids)-1) ;
		$sql = "select * from forum where id in(" . $ids . ") ";
		$record = $database->FetchThis($sql);
		$sheet->CreateForumView($record);
		
	}

	if(isset($_GET['publicSearch'])){
		$key =  $database->charEncoder($_GET['searchKey']);
		$year = $database->charEncoder($_GET['year']);
		$db = $database->getDB($year);
			
		$sql = "SELECT * FROM ".$db.".vouchercurrent WHERE TrackingNumber  = '" . $key . "' LIMIT 1";
		$record = $database->query($sql);
		$many = 0;
		if($database->num_rows($record) > 0){
			$many = 1;
		}else{
			$sql = "SELECT * FROM ".$db.".vouchercurrent WHERE Claimant LIKE '%".$key."%' GROUP BY TrackingNumber ORDER BY DateModified DESC LIMIT 20";
			$record = $database->query($sql);
			if($database->num_rows($record) == 1){
				$many = 1;
			}elseif($database->num_rows($record) > 1) {
				$many = $database->num_rows($record);
			}
		}

		if($many == 1) {
			$newRecord = [];
			$data = $database->fetch_array($record);
			$newRecord['TrackingType'] = $data['TrackingType'];
			$newRecord['Status'] = $data['Status'];
			$newRecord['Claimant'] = $data['Claimant'];
			$newRecord['Year'] = $data['Year'];
			
			if($year >= '2017') {
				$newRecord['DocumentType'] = $data['DocumentType'];
				if($newRecord['TrackingType'] == 'PR') {
					$newRecord['DocumentType'] = 'Purchase Request';
				}
			}else {
				$newRecord['DocumentType'] = $data['TransactionType'];
				if($newRecord['TrackingType'] == 'PR') {
					$newRecord['DocumentType'] = 'Purchase Request';
				}
			}
		
		
			$newRecord['Fund'] = $data['Fund'];
			$newRecord['ClaimType'] = $data['ClaimType'];
		
			$newRecord['Office'] = $data['Office'];
			$sql = "SELECT Name FROM ".$db.".office WHERE Code = '".$newRecord['Office']."' LIMIT 1";
			$record0 = $database->query($sql);
			$data0 = $database->fetch_array($record0);
			$newRecord['OfficeName'] = $data0['Name'];
			
			$newRecord['PR_CategoryCode'] = $data['PR_CategoryCode'];
			if($newRecord['PR_CategoryCode'] != "") {

				if($year >= '2018') {
					$sql = "SELECT Description FROM ".$db.".ppmpcategories WHERE Code = '".$newRecord['PR_CategoryCode']."' LIMIT 1";
					$record1 = $database->query($sql);
					$data1 = $database->fetch_array($record1);
					$newRecord['PR_CategoryName'] = $data1['Description'];
				}else {
					$sql = "SELECT category_name FROM ".$bac."item_categories WHERE category_key = '".$newRecord['PR_CategoryCode']."' LIMIT 1";
					$record1 = $database->query($sql);
					$data1 = $database->fetch_array($record1);	
					$newRecord['PR_CategoryName'] = $data1['category_name'];
				}
				
			}else {
				$newRecord['PR_CategoryName'] = '';
			}
			
		
			$newRecord['EncodedBy'] = $data['EncodedBy'];
			$sql = "SELECT LastName, FirstName, MiddleName FROM citydoc.employees WHERE EmployeeNumber = '".$newRecord['EncodedBy']."' LIMIT 1";
			$record2 = $database->query($sql);
			$data2 = $database->fetch_array($record2);
			$newRecord['EncodedName'] = utf8_encode($data2['LastName'].', '.$data2['FirstName'].' '.$data2['MiddleName']);
		
			$newRecord['TrackingNumber'] = $data['TrackingNumber'];
			$newRecord['OBR_Number'] = $data['OBR_Number'];
			$newRecord['PO_Number'] = $data['PO_Number'];
			$newRecord['PR_Number'] = $data['PR_Number'];
			$newRecord['ADV1'] = $data['ADV1'];
			$newRecord['Remarks'] = $data['Remarks'];
			$newRecord['DateEncoded'] = $data['DateEncoded'];
			$newRecord['DateModified'] = $data['DateModified'];
			$newRecord['Completion'] = $data['Completion'];
		
			if($newRecord['TrackingType'] == 'PY'){
				$periodType = $data['PeriodType']; 
				$periodMonth= $data['PeriodMonth']; 
				if($periodType == 1){
					$newRecord['Period'] = $periodMonth . ' (1 - 15)';
				}else if ($periodType == 2){
					$newRecord['Period'] = $periodMonth . ' (16 - 31)';
				}else{
					$newRecord['Period'] = $periodMonth;
				}
			}else {
				$newRecord['Period'] =  $database->numberToQuarter($data['PR_Month']);
			}
			
			echo $sheet->CreatePublicTable($newRecord);
		}elseif($many > 1) {
			$newRecord = [];
			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$newRecord[$tn]['TrackingNumber'] = $tn;
				$newRecord[$tn]['TrackingType'] = $data['TrackingType'];
				$newRecord[$tn]['Status'] = $data['Status'];
				$newRecord[$tn]['Claimant'] = $data['Claimant'];
				$newRecord[$tn]['Year'] = $data['Year'];
			
				if($year >= '2017') {
					$newRecord[$tn]['DocumentType'] = $data['DocumentType'];
					if($newRecord[$tn]['TrackingType'] == 'PR') {
						$newRecord[$tn]['DocumentType'] = 'Purchase Request';
					}
				}else {
					$newRecord[$tn]['DocumentType'] = $data['TransactionType'];
					if($newRecord[$tn]['TrackingType'] == 'PR') {
						$newRecord[$tn]['DocumentType'] = 'Purchase Request';
					}
				}
			
				$newRecord[$tn]['Fund'] = $data['Fund'];
				$newRecord[$tn]['ClaimType'] = $data['ClaimType'];
			
				$newRecord[$tn]['Office'] = $data['Office'];
				$sql = "SELECT Name FROM office WHERE Code = '".$newRecord[$tn]['Office']."' LIMIT 1";
				$record0 = $database->query($sql);
				$data0 = $database->fetch_array($record0);
				$newRecord[$tn]['OfficeName'] = $data0['Name'];
				
				$newRecord[$tn]['PR_CategoryCode'] = $data['PR_CategoryCode'];
				if($newRecord[$tn]['PR_CategoryCode'] != "") {

					if($year >= '2018') {
						$sql = "SELECT Description FROM ".$db.".ppmpcategories WHERE Code = '".$newRecord[$tn]['PR_CategoryCode']."' LIMIT 1";
						$record1 = $database->query($sql);
						$data1 = $database->fetch_array($record1);
						$newRecord[$tn]['PR_CategoryName'] = $data1['Description'];
					}else {
						$sql = "SELECT category_name FROM ".$bac."item_categories WHERE category_key = '".$newRecord[$tn]['PR_CategoryCode']."' LIMIT 1";
						$record1 = $database->query($sql);
						$data1 = $database->fetch_array($record1);	
						$newRecord[$tn]['PR_CategoryName'] = $data1['category_name'];
					}

				}else {
					$newRecord[$tn]['PR_CategoryName'] = '';
				}
				
			
				$newRecord[$tn]['EncodedBy'] = $data['EncodedBy'];
				$sql = "SELECT LastName, FirstName, MiddleName FROM citydoc.employees WHERE EmployeeNumber = '".$newRecord[$tn]['EncodedBy']."' LIMIT 1";
				$record2 = $database->query($sql);
				if($database->num_rows($record2)) {
					$data2 = $database->fetch_array($record2);
					$newRecord[$tn]['EncodedName'] = utf8_encode($data2['LastName'].', '.$data2['FirstName'].' '.$data2['MiddleName']);
				}else {
					$newRecord[$tn]['EncodedName'] = '';
				}
			
				$newRecord[$tn]['OBR_Number'] = $data['OBR_Number'];
				$newRecord[$tn]['PO_Number'] = $data['PO_Number'];
				$newRecord[$tn]['PR_Number'] = $data['PR_Number'];
				$newRecord[$tn]['ADV1'] = $data['ADV1'];
				$newRecord[$tn]['Remarks'] = $data['Remarks'];
				$newRecord[$tn]['DateEncoded'] = $data['DateEncoded'];
				$newRecord[$tn]['DateModified'] = $data['DateModified'];
				$newRecord[$tn]['Completion'] = $data['Completion'];
			
				if($newRecord[$tn]['TrackingType'] == 'PY'){
					$periodType = $data['PeriodType']; 
					$periodMonth= $data['PeriodMonth']; 
					if($periodType == 1){
						$newRecord[$tn]['Period'] = $periodMonth . ' (1 - 15)';
					}else if ($periodType == 2){
						$newRecord[$tn]['Period'] = $periodMonth . ' (16 - 31)';
					}else{
						$newRecord[$tn]['Period'] = $periodMonth;
					}
				}else {
					$newRecord[$tn]['Period'] =  $database->numberToQuarter($data['PR_Month']);
				}
			}

			echo $sheet->CreatePublicTableMultiple($newRecord);
		}else {
			echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
		}
	}
	// if(isset($_GET['publicSearch'])){
	// 	$key =  $database->charEncoder($_GET['searchKey']);
	// 	$year = $database->charEncoder($_GET['year']);
		
		
	// 		if($year == '2019'){
	// 			$db = 'citydoc2019.';
				
	// 		}else if($year == '2018'){
	// 			$db = 'citydoc2018.';
	// 		}else if($year == '2017'){
	// 			$db = 'citydoc2017.';
	// 			$bac = 'bacdb2017.';
	// 		}else if($year == '2020'){
	// 			$db = 'citydoc2020.';
	// 		}else if($year == '2021'){
	// 			$db = 'citydoc2021.';
	// 		}else if($year == '2022'){
	// 			$db = 'citydoc2022.';
	// 		}else if($year == '2023'){
	// 			$db = 'citydoc2023.';
	// 		}else{
	// 			$db = 'citydoc.';
	// 			$bac = 'bac.';
	// 		}
			
	// 		if($year == '2016'){
	// 			//single search 2016 
	// 			$sql = "SELECT a.*,a.TransactionType as DocumentType,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.categoryname as  CategoryName
	// 							FROM " . $db . "vouchercurrent a 
	// 							left join " . $db . "office b on a.office = b.code  
	// 							left join citydoc.employees c on a.encodedby = c.employeenumber
	// 							left join " . $db . "programcode d on a.PR_ProgramCode = d.code
	// 							left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
	// 							left join " . $bac . "item_categories f on a.PR_CategoryCode = f.categorykey
	// 							where trackingnumber  = '" . $key . "' limit 1";
	// 			$record = $database->query($sql);
	// 			if($database->num_rows($record) > 0){
	// 				echo $sheet->CreatePublicInfo($record,1);	
	// 			}else{
	// 				//all sa 2016
	// 				$sql = " select a.*, b.Name from (SELECT *,TransactionType as DocumentType
	// 								FROM " . $db . " vouchercurrent where claimant  like '%" . $key . "%' group by trackingnumber order by datemodified desc ) as  a 
	// 								left join citydoc.office b on   a.office = b.code  " ; 
	// 				$record = $database->query($sql);
	// 				if($database->num_rows($record) > 0){
	// 					echo $sheet->CreatePublicInfo($record,2);	
	// 				}else{
	// 					echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
	// 				}
	// 			}	
	// 		}else if($year == '2017'){
	// 			$sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.category_name as  CategoryName
	// 							FROM " . $db . "vouchercurrent a 
	// 							left join " . $db . "office b on a.office = b.code  
	// 							left join citydoc.employees c on a.encodedby = c.employeenumber
	// 							left join " . $db . "programcode d on a.PR_ProgramCode = d.code
	// 							left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
	// 							left join " . $bac . "item_categories f on a.PR_CategoryCode = f.category_key
	// 							where trackingnumber  = '" . $key . "' limit 1";
	// 			$record = $database->query($sql);
	// 			if($database->num_rows($record) > 0){
	// 				echo $sheet->CreatePublicInfo($record,1);	
	// 			}else{
	// 				$sql = " select a.*, b.Name from (SELECT * FROM " . $db . " vouchercurrent where claimant  like '%" . $key . "%' group by trackingnumber order by datemodified desc ) as  a 
	// 								left join " . $db . "office b on   a.office = b.code  " ; 
	// 				$record = $database->query($sql);
	// 				if($database->num_rows($record) > 0){
	// 					echo $sheet->CreatePublicInfo($record,2);	
	// 				}else{
	// 					echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
	// 				}
	// 			}	
	// 		}else if($year >= '2018'){
	// 			$sql = "SELECT * 
	// 					FROM " . $db . "vouchercurrent
	// 					where trackingnumber  = '" . $key . "' limit 1";
	// 			$record = $database->query($sql);
	// 			if($database->num_rows($record) > 0){
	// 				echo $sheet->CreatePublicInfo($record,1);	
	// 			}else{
	// 				$sql = "SELECT a.*, b.Name
	// 						FROM 
	// 						".$db."vouchercurrent a
	// 						LEFT JOIN ".$db."office b on   a.Office = b.Code
	// 						WHERE a.Claimant  LIKE '%" . $key . "%'
	// 						GROUP BY a.TrackingNumber
	// 						ORDER BY a.DateModified DESC LIMIT 20
	// 						"; 
	// 				$record = $database->query($sql);
	// 				if($database->num_rows($record) > 0){
	// 					echo $sheet->CreatePublicInfo($record,2);	
	// 				}else{
	// 					echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
	// 				}
	// 			}	
	// 		}
			
	// }
	
	if(isset($_GET['addCheckInfo'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$checkNumber = $database->charEncoder($_GET['checkNumber']);
		$checkAmount = $database->charEncoder($_GET['checkAmount']);
		
		$checkDate = $database->charEncoder($_GET['checkDate']);
		$accountNumber = $database->charEncoder($_GET['accountNumber']);
		
		$adviceBy = $_SESSION['employeeNumber'];
		$sql = "UPDATE vouchercurrent  SET checknumber = '" . $checkNumber . "', checkdate = '" . $checkDate . "', NetAmount = '" . $checkAmount .  "'  WHERE trackingnumber = '" . $trackingNumber . "'" ;
		$database->query($sql);
		$sql  = "Select * from adviceinfo where trackingnumber = '" . $trackingNumber . "' limit 1";
		$record = 	$database->query($sql);
		
		$count = $database->num_rows($record);		
		if($count == 0){
			$sql = "Insert into adviceinfo (TrackingNumber,AdviceBy,DateAdvice,AccountNo)values('" . $trackingNumber . "', '" . $adviceBy . "', '" . $dateEncoded . "','" .  $accountNumber  . "')";
			$database->query($sql);
		}
		$record = $database->SearchTracking($trackingNumber);
		$count =  $database->num_rows($record);
		if($count > 0){
			echo $sheet->CreateDoctrackInfoPR($record);
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}	
	if(isset($_GET['viewAdvice'])){
		$fund = $database->charEncoder($_GET['fund']);
		$sel = $database->charEncoder($_GET['sel']);
		$rowLimit = $database->charEncoder($_GET['rowLimit']);
		
		if($sel == "ad"){
			$sql = "Select *,if(b.PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee  from adviceinfo a inner join 
					(select Adv1,Adv2,TrackingNumber,TrackingType,CheckNumber,CheckDate,Claimant,Fund,NetAmount ,PayeeNumber 
					 from vouchercurrent where checknumber != ''  and Fund = '" . $fund . "' group by trackingnumber) b
					on a.TrackingNumber = b.TrackingNumber where AdviceNo > 0 order by checknumber asc";
		}else if($sel == "tba"){
					
			/*$sql = " Select a.Id,b.TrackingNumber,a.AdviceId,b.Fund,a.AccountNo,b.Adv1,b.Adv2,b.CheckNumber,b.CheckDate,b.Claimant, if(b.PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee,b.Amount,b.PO_Amount,b.TotalAmountMultiple,b.PayrollAmountFirst,b.NetAmount 
					 from adviceinfo a left join vouchercurrent b on a. trackingnumber = b.trackingnumber 
					 where b.Fund = '" . $fund . "' and claimtype = 'Check' and adviceno is null  group by trackingnumber  order by b.checknumber   limit " . $rowLimit  ;*/
					 
			$sql = " Select Id,TrackingNumber,AdviceId,Fund,AccountNo,Adv1,Adv2,CheckNumber,CheckDate,Claimant, if(PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee,NetAmount 
					 from adviceinfo 
					 where Fund = '" . $fund . "' and claimType= 'Check' and adviceno is null  group by trackingnumber  order by checknumber   limit " . $rowLimit  ;		 
					 
		}else if($sel == "aAll"){
			$sql = "Select *,if(b.PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee from adviceinfo a inner join 
					(select Adv1,Adv2,TrackingNumber,TrackingType,CheckNumber,CheckDate,Claimant,Fund,NetAmount ,PayeeNumber   
					 from vouchercurrent where checknumber != '' and Fund = '" . $fund . "' group by trackingnumber) b
					on a.TrackingNumber = b.TrackingNumber order by checknumber asc";
		}
		
		$record = $database->query($sql);
		echo $sheet->CreateAdvice($record,$sel);
	}
	if(isset($_GET['assignAdvice'])){
		
		$ids = $database->charEncoder($_GET['ids']);
		$adviceId = $database->charEncoder($_GET['adviceId']);
		$seq = $database->charEncoder($_GET['seq']);
		
		$sql = "UPDATE adviceInfo SET AdviceNo = '" . $seq . "', AdviceId = '" . $adviceId . "'   where id in  (" . $ids . ")";				
		 $database->query($sql);		
	}
	if(isset($_GET['searchAdvice'])){
		$adviceNo = $database->charEncoder($_GET['adviceNo']);
		$fund = $database->charEncoder($_GET['fund']);
		
		if(strlen($adviceNo)< 5){
			/*$sql = "Select *,if(b.PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee from adviceinfo a inner join 
					(select Adv1,Adv2,TrackingNumber,TrackingType,CheckNumber,CheckDate,Claimant,Amount,PO_Amount,NetAmount,TotalAmountMultiple,PayrollAmountFirst,Fund  ,PayeeNumber 
					 from vouchercurrent group by trackingnumber) b
					on a.TrackingNumber = b.TrackingNumber where AdviceNo = '" . $adviceNo . "'  and Fund = '" . $fund  . "' order by checknumber asc";*/
			$sql = "Select *, if(PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee from adviceinfo where AdviceNo = '" . $adviceNo . "' and Fund = '" . $fund . "' order by checknumber asc";	
			
		}else{
			/*$sql = "Select *,if(b.PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee from adviceinfo a inner join 
					(select Adv1,Adv2,TrackingNumber,TrackingType,CheckNumber,CheckDate,Claimant,Amount,PO_Amount,NetAmount,TotalAmountMultiple,PayrollAmountFirst,Fund  ,PayeeNumber 
					 from vouchercurrent group by trackingnumber) b
					on a.TrackingNumber = b.TrackingNumber where AdviceId = '" . $adviceNo . "' order by checknumber asc";*/
			$sql = "Select *, if(PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee from adviceinfo where AdviceId = '" . $adviceNo . "' order by checknumber asc";
		}
		$record = $database->query($sql);
		
		echo $sheet->CreateSearchAdvice($record);
	}
	if(isset($_GET['searchAdviceAdv'])){
		$advNo = trim( $database->charEncoder($_GET['advNo']));
		$a = substr( strrev($advNo),0,1);
		$fund = $database->charEncoder($_GET['fund']);
		if( $a != 'a' ){
			$field = 'Adv1';
		}else{
			$field = 'Adv2';
		}
		/*$sql = "Select *,if(b.PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee from adviceinfo a inner join 
					(select Adv1,Adv2,TrackingNumber,TrackingType,CheckNumber,CheckDate,Claimant,Amount,PO_Amount,NetAmount,TotalAmountMultiple,PayrollAmountFirst,Fund ,PayeeNumber 
					 from vouchercurrent  where " . $field . " = '" . $advNo . "' and Fund = '" . $fund . "'  group by trackingnumber) b
					on a.TrackingNumber = b.TrackingNumber where AdviceNo > 0";*/
		$sql = "Select *, if(PayeeNumber > 0, concat('LBP - ',claimant) ,Claimant) as Payee from adviceinfo where " . $field . " = '" . $advNo . "' and Fund = '" . $fund . "'";
		$record = $database->query($sql);			
		echo $sheet->CreateSearchAdvice($record);
	}
	if(isset($_GET['saveLingap'])){
		$name = strtoupper($database->charEncoder($_GET['name']));
		$raf = $database->charEncoder($_GET['raf']);
		$amount = $database->charEncoder($_GET['amount']);
		
		
		$sql = "select * from listattachments where RAF  = '" . $raf . "'  and TrackingNumber  is NULL limit 1";
		$record =  $database->query($sql);
		$count = $database->num_rows($record);
		if($count == 0){
			$sql = "insert into  listattachments (Name,RAF,Amount,EncodedBy,DateEncoded) values('". $name . "' ," . $raf . ",'" . $amount . "','" . $employeeNumber . "','" . $dateEncoded. "')";
			$database->query($sql);
		}else{
			$sql = "Update listattachments set Name = '" .  $name. "', Amount = '" . $amount . "', EncodedBy = '" . $employeeNumber  . "', DateEncoded = '" . $dateEncoded . "' where RAF = '" . $raf . "'";
			$database->query($sql);
		}
		$sql = "select * from  listattachments order by id desc limit 1";
		$record = $database->query($sql);
		echo $sheet->CreateLingapAdded($record);
		
	}
	if(isset($_GET['fetchLingapEncoded'])){
		$encoder = $_SESSION['employeeNumber'];
		$sql = "select * from  listattachments where EncodedBy = " . $encoder . " and TrackingNumber is null order by Name asc";
		$record = $database->query($sql);
		$s =  $sheet->CreateLingapEncoded($record);

		$condition = "where code = 'LING' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$newTrackingNumber = 'LING-' . ($data['Doctrack']+1);
		$t =  $newTrackingNumber;
		
		echo $s . '~!~' . $t;
	}

	// if(isset($_GET['saveLingapTracking'])){
	// 	$p = $_SESSION['perm'];
	// 	$claimant = $database->charEncoder($_GET['claimant']);
	// 	$docType =   $database->charEncoder($_GET['docType']);
	// 	$amount =  preg_replace('/[,]/', '', $database->charEncoder($_GET['amount']));
	// 	$ids = $database->charEncoder($_GET['ids']);
	// 	$row =sizeof(explode(",", $ids));
		
		
	// 	$office = "LING";
		
	// 	if($p == 30){
	// 		$fund = "Trust Fund";
	// 		$programCode = "PCSO";
	// 		$accountCode = "PCSO";
	// 	}else if($p == 34){
	// 		$fund = "General Fund";
	// 		$programCode = "20013";
	// 		$accountCode = "50299990";
	// 	}else{
	// 		$fund = "General Fund";
	// 		$programCode = "1011-3";
	// 		$accountCode = "50299990";
	// 	}
	// 	$trackType = 'PY';
	// 	/*$fund = "General Fund";
	// 	$programCode = "1011-3";
	// 	$accountCode = "50299990";*/
		
	// 	$chargeType = 1;
	// 	$claimType = 'Check';
	// 	$month = date("m");
	// 	$periodType = 'Monthly';
	// 	$status = "Encoded";
	// 	$periodMonth = $database->numberToMonth($month);
	// 	//sa series
	// 	$updateCase = "Doctrack = Doctrack + 1";
	// 	$database->IncrementTrackingSeries($updateCase,$office);
		
	// 	//sa fetch new id
	// 	$record = $database->FetchDoctrackID("Doctrack","where code = 'LING' limit 1");
	// 	$data = $database->fetch_array($record);
	// 	$trackingNumber = 'LING-' . $data['Doctrack'];
	// 	$newTrackingNumber =  'LING-' . ($data['Doctrack'] + 1);
		
	// 	//sa vouchercurrent
	// 	$insertCase = "Insert into vouchercurrent (Year,Office,TrackingNumber,TrackingType,Fund,DocumentType,ClaimType,Claimant,Amount,ChargeType,PeriodType,PeriodMonth,EncodedBy,DateEncoded,Status,DateModified,PR_ProgramCode,PR_AccountCode)VALUES 
	// 					(" . $defaultYear . ",'" . $office . "','" . $trackingNumber . "','" . $trackType . "','" . $fund . "','" . $docType . "','" . $claimType . "','" . $claimant . "','" . $amount . "','" . $chargeType . "',
	// 					'"  .   $periodType . "','" . $periodMonth . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "','" . $programCode . "','" . $accountCode . "')";
	// 	$database->query($insertCase);
		
	// 	//sa attachements
	// 	$sql = "Update listattachments set trackingnumber = '" . $trackingNumber . "',DateEncoded = '" . $dateEncoded . "', Encodedby = '" . $employeeNumber . "',DocumentType = '"  . $docType . "', Rows = '" . $row . "'   where Id in (" . $ids . ")";
	// 	$database->query($sql);
		
	// 	//sa history
	// 	$completion = '';
	// 	$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		
		
	// 	echo $trackingNumber;
	// }

	if(isset($_GET['saveLingapTracking'])){
		$p = $_SESSION['perm'];
		$claimant = $database->charEncoder($_GET['claimant']);
		$oneTax = $database->charEncoder($_GET['onetax']);
		$docType =   $database->charEncoder($_GET['docType']);
		$amount =  preg_replace('/[,]/', '', $database->charEncoder($_GET['amount']));
		$ids = $database->charEncoder($_GET['ids']);
		$row =sizeof(explode(",", $ids));
		
		
		$office = "LING";
		
		if($p == 30){
			$fund = "Trust Fund";
			$programCode = "PCSO";
			$accountCode = "PCSO";
		}else if($p == 34){
			$fund = "General Fund";
			$programCode = "20013";
			$accountCode = "50299990";
		}else{
			$fund = "General Fund";
			$programCode = "1011-3";
			$accountCode = "50299990";
		}
		$trackType = 'PY';
		/*$fund = "General Fund";
		$programCode = "1011-3";
		$accountCode = "50299990";*/
		
		$chargeType = 1;
		$claimType = 'Check';
		$month = date("m");
		$periodType = 'Monthly';
		$status = "Encoded";
		$periodMonth = $database->numberToMonth($month);
		//sa series
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//sa fetch new id
		$record = $database->FetchDoctrackID("Doctrack","where code = 'LING' limit 1");
		$data = $database->fetch_array($record);
		$trackingNumber = 'LING-' . $data['Doctrack'];
		$newTrackingNumber =  'LING-' . ($data['Doctrack'] + 1);

		// $sql = "SELECT * FROM supplier.supplierinfo WHERE Name = '".addslashes($claimant)."' LIMIT 1";
		$sql = 'SELECT * FROM supplier.supplierinfo WHERE Name = "'.$claimant.'" LIMIT 1';
		$record = $database->query($sql);
		
		if($database->num_rows($record) > 0) {

			$data = $database->fetch_array($record);
			$supClass = $data['Classification'];

			$supType = 'VAT';
			if($data['Type'] == 'NV') {
				$supType = 'NON-VAT';
			}

			$supTIN = $data['TIN'];
			$supCode = $data['Code'];

			$net = 0;
			$taxValue = 0;
			$inTax = "";
			if($oneTax == 1) {
				
				// $baseAmount = $amount / 1.12;
				$baseAmount = $amount;
				// $taxValue = $baseAmount * 0.02;
				$taxValue = round($baseAmount * 0.02, 2);
				$net = $amount - $taxValue;

				$inTax .= ",('".$defaultYear."','".$fund."','".$trackingNumber."','".$supTIN."','".$claimant."','Services','General','".$supType."','Expanded','02','WC157'
							,'".$amount."','".$baseAmount."','2','".$taxValue."','0.00','0.00','".$net."','".$employeeNumber."','Manual',NULL,NULL,NULL)";

			}else if($oneTax == 2) {

				$net = $amount;

			}else {

				$sql = "SELECT * FROM supplier.taxtable 
						WHERE 
						Nature = 'Services' 
						AND Specifics = 'General' 
						AND TaxType = '".$supType."' 
						AND Classification = '".$supClass."' 
						AND (Form = 'Expanded' OR Form = 'GMP')";
				$record = $database->query($sql);

				$baseAmount = $amount / 1.12;
				if($supType == 'NON-VAT') {
					$baseAmount = $amount;
				}
				$taxes = [];
				$totalTax = 0;

				while ($data = $database->fetch_array($record)) {

					$taxCode = $data['TaxCode'];
					$taxForm = $data['Form'];
					$taxATC = $data['ATC'];
					$taxPercent = $data['TaxPercentage'];
					$taxPerForSaving = ($taxPercent * 100);
					// $percentageAmount = $baseAmount * $taxPercent;
					$percentageAmount = round($baseAmount * $taxPercent, 2);

					$totalTax += $percentageAmount;

					$details = $taxForm."~".$taxATC."~".$taxCode."~".$taxPerForSaving."~".$percentageAmount;

					$inTax .= ",('".$defaultYear."','".$fund."','".$trackingNumber."','".$supTIN."','".$claimant."','Services','General','".$supType."','".$taxForm."','".$taxCode."','".$taxATC."'
							,'".$amount."','".$baseAmount."','".$taxPerForSaving."','".$percentageAmount."','0.00','0.00','**netamount**','".$employeeNumber."','Auto',NULL,NULL,NULL)";

					array_push($taxes, $details);

				}

				$net = $amount - $totalTax;

				$inTax = str_replace('**netamount**', $net, $inTax);

				// for ($i=0; $i < sizeof($taxes); $i++) { 

				// 	$details = explode("~", $taxes[$i]);
				// 	$taxForm = $details[0];
				// 	$taxATC = $details[1];
				// 	$taxCode = $details[2];
				// 	$taxPerForSaving = $details[3];
				// 	$percentageAmount = $details[4];

				// 	$inTax .= ",('".$defaultYear."','".$fund."','".$trackingNumber."','".$supTIN."','".$claimant."','Services','General','".$supType."','".$taxForm."','".$taxCode."','".$taxATC."'
				// 			,'".$amount."','".$baseAmount."','".$taxPerForSaving."','".$percentageAmount."','0.00','0.00','".$net."','".$employeeNumber."','Auto',NULL,NULL,NULL)";

				// }

			}

			//sa vouchercurrent
			$insertCase = "Insert into vouchercurrent (Year,Office,TrackingNumber,TrackingType,Fund,DocumentType,ClaimType,Claimant,Amount,ChargeType,PeriodType,PeriodMonth,EncodedBy,DateEncoded,Status,DateModified,PR_ProgramCode,PR_AccountCode,NetAmount)VALUES 
							(" . $defaultYear . ",'" . $office . "','" . $trackingNumber . "','" . $trackType . "','" . $fund . "','" . $docType . "','" . $claimType . "','" . $claimant . "','" . $amount . "','" . $chargeType . "',
							'"  .   $periodType . "','" . $periodMonth . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "','" . $programCode . "','" . $accountCode . "','" . $net . "')";
			$database->query($insertCase);
			
			//sa attachements
			$sql = "Update listattachments set trackingnumber = '" . $trackingNumber . "',DateEncoded = '" . $dateEncoded . "', Encodedby = '" . $employeeNumber . "',DocumentType = '"  . $docType . "', `Rows` = '" . $row . "'   where Id in (" . $ids . ")";
			$database->query($sql);


			if($oneTax != 2) {
				$sql = "INSERT INTO `supplier`.`vouchers`
						(`Year`,`Fund`,`TrackingNumber`,`TIN`,`Supplier`,`NatureOfPayment`,`Specifics`,`ReceiptType`,`CodeType`,`TaxCode`,`ATC`,`Amount`,`BaseAmount`,`Percentage`
						,`PercentageAmount`,`LiquidatedDamages`,`Retention`,`NetAmount`,`EncodedBy`,`Entry`,`AdjustmentLabel`,`AdjustmentType`,`AdjustmentAmount`)
						VALUES ".substr($inTax, 1);
				$database->query($sql);
			}


			//sa history
			$completion = '';
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
			
			
			echo $trackingNumber;

		}else {
			echo 1;
		}

	}

	if(isset($_GET['searchLingap'])){
		$trackingNumber = "LING-" .  $database->charEncoder($_GET['trackingNumber']);
		$sql = "select * from listattachments where trackingnumber = '" . $trackingNumber . "'";
		$record = $database->query($sql);
		
		$sql = "select * from vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
		$record1 = $database->query($sql);
		$data =  $database->fetch_array($record1);
		
		
		echo   $sheet->CreateLingapTracked($record,$data['Status'],$data['Claimant'],$data['Fund']);
	}
	if(isset($_GET['updateLingap'])){

		$ids = $database->charEncoder($_GET['ids']);
		$nameAll =  $database->charEncoder($_GET['nameAll']);
		$amountAll = $database->charEncoder($_GET['amountAll']);
		$rafAll = $database->charEncoder($_GET['rafAll']);
		$amountTotal = $database->charEncoder($_GET['amount']);
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$claimant = $database->charEncoder($_GET['claimant']);
		$fund = $database->charEncoder($_GET['fund']);
		
		$splitName = explode("~!~",$nameAll);
		$splitRaf = explode("~!~",$rafAll);
		$splitAmount = explode("~!~",$amountAll);
		$splitIds = 	explode("~!~",$ids);
		
		$caseName = '';
		$caseAmount = '';
		$caseRaf = '';
		for($i = 0; $i < sizeof($splitName)-1;$i++ ){
			$name = $splitName[$i];
			$raf = $splitRaf[$i];
			$amount = $splitAmount[$i];
			$id = $splitIds[$i];
			
			$caseName  .= " WHEN Id = " . $id . " Then '" . $name . "' ";
			$caseRaf  .= " WHEN Id = " . $id . " Then " . $raf  . " ";
			$caseAmount  .= " WHEN Id = " . $id . " Then " . $amount  . " ";
		}

		$sql = "SELECT * FROM supplier.supplierinfo WHERE Name = '".addslashes($claimant)."' LIMIT 1";
		$record = $database->query($sql);

		if($database->num_rows($record) > 0) {

			$data = $database->fetch_array($record);
			$supClass = $data['Classification'];

			$supType = 'VAT';
			if($data['Type'] == 'NV') {
				$supType = 'NON-VAT';
			}

			$supTIN = $data['TIN'];
			$supCode = $data['Code'];

			$sql = "SELECT * FROM claimant WHERE Name = '".addslashes($claimant)."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$oneTax = $data['OneTax'];

			$net = 0;
			$taxValue = 0;
			$inTax = "";
			if($oneTax == 1) {
				
				$baseAmount = $amountTotal;
				// $taxValue = $baseAmount * 0.02;
				$taxValue = round($baseAmount * 0.02, 2);
				$net = $amountTotal - $taxValue;

				$inTax .= ",('".$defaultYear."','".$fund."','".$trackingNumber."','".$supTIN."','".$claimant."','Services','General','".$supType."','Expanded','02','WC157'
							,'".$amountTotal."','".$baseAmount."','2','".$taxValue."','0.00','0.00','".$net."','".$employeeNumber."','Manual',NULL,NULL,NULL)";

			}else if($oneTax == 2) {
				
				$net = $amountTotal;

			}else {

				$sql = "SELECT * FROM supplier.taxtable 
						WHERE 
						Nature = 'Services' 
						AND Specifics = 'General' 
						AND TaxType = '".$supType."' 
						AND Classification = '".$supClass."' 
						AND (Form = 'Expanded' OR Form = 'GMP')";
				$record = $database->query($sql);

				$baseAmount = $amountTotal / 1.12;
				if($supType == 'NON-VAT') {
					$baseAmount = $amountTotal;
				}
				$taxes = [];
				$totalTax = 0;

				while ($data = $database->fetch_array($record)) {

					$taxCode = $data['TaxCode'];
					$taxForm = $data['Form'];
					$taxATC = $data['ATC'];
					$taxPercent = $data['TaxPercentage'];
					$taxPerForSaving = ($taxPercent * 100);
					// $percentageAmount = $baseAmount * $taxPercent;
					$percentageAmount = round($baseAmount * $taxPercent, 2);

					$totalTax += $percentageAmount;

					$details = $taxForm."~".$taxATC."~".$taxCode."~".$taxPerForSaving."~".$percentageAmount;

					$inTax .= ",('".$defaultYear."','".$fund."','".$trackingNumber."','".$supTIN."','".$claimant."','Services','General','".$supType."','".$taxForm."','".$taxCode."','".$taxATC."'
							,'".$amountTotal."','".$baseAmount."','".$taxPerForSaving."','".$percentageAmount."','0.00','0.00','**netamount**','".$employeeNumber."','Auto',NULL,NULL,NULL)";

					array_push($taxes, $details);

				}

				$net = $amountTotal - $totalTax;

				$inTax = str_replace('**netamount**', $net, $inTax);
				
			}

			$sql = "Update vouchercurrent set Amount = '".$amountTotal."', NetAmount = '".$net."' where trackingNumber = '" . $trackingNumber  . "'";
			$database->query($sql);
			
			if($oneTax != 2) {

				$sql = "DELETE FROM `supplier`.`vouchers` WHERE Year = '".$defaultYear."' AND TrackingNumber = '".$trackingNumber."'";
				$database->query($sql);

				$sql = "INSERT INTO `supplier`.`vouchers`
						(`Year`,`Fund`,`TrackingNumber`,`TIN`,`Supplier`,`NatureOfPayment`,`Specifics`,`ReceiptType`,`CodeType`,`TaxCode`,`ATC`,`Amount`,`BaseAmount`,`Percentage`
						,`PercentageAmount`,`LiquidatedDamages`,`Retention`,`NetAmount`,`EncodedBy`,`Entry`,`AdjustmentLabel`,`AdjustmentType`,`AdjustmentAmount`)
						VALUES ".substr($inTax, 1);
				$database->query($sql);

			}

			$database->EditLogs($trackingNumber,"Lingap","Lingap","Lingap",$_SESSION['officeCode'], $_SESSION['fullName'],$dateEncoded);	
				
			$sql = "Update listattachments set Name = CASE " . $caseName . " END, RAF = CASE "  . $caseRaf .  "  END, Amount = CASE " . $caseAmount . " END  where TrackingNumber = '" . $trackingNumber . "' ";
			echo $database->UpdateInsertSpecial($sql);

		}else {
			echo 1;
		}
		

	}
	if(isset($_GET['fetchHospital'])){
		$docType = $database->charEncoder($_GET['docType']);
		$sql = "select * from claimant where DocumentType ='" . $docType  . "' order by Name asc";
		$record = $database->query($sql);
		echo $sheet->CreateHospitalSelect($record);
		
	}
	if(isset($_GET['updateParticulars'])){
	
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$textArea = utf8_decode($_GET['textArea']);
		$textArea = $database->charEncoder($textArea);
		if(substr($trackingNumber,0,4) == "LING"){
			$sql = "select id from particulars where trackingnumber = '" . $trackingNumber . "'";
			$record = $database->query($sql);
			
			$count = $database->num_rows($record);
			$arr = explode("RAF",$textArea);
			if($count == 0){
				$sql = "Insert into particulars (TrackingNumber,Particulars)values('" . $trackingNumber . "','" . $arr[0] . "')";
				$database->query($sql);
			}else{
				$sql = "update particulars set Particulars = '" . $arr[0] . "' where trackingnumber = '" . $trackingNumber . "'";
				$database->query($sql);
			}
		}else{
			$sql = "update particulars set Particulars = '" . $textArea . "' where trackingnumber = '" . $trackingNumber . "'";
			$database->query($sql);
		}
		$database->EditLogs($trackingNumber,"Particulars","A" , trim($textArea),$_SESSION['officeCode'], $_SESSION['fullName'],$dateEncoded);	
	}
	if(isset($_POST['updateParticulars1'])){
		$trackingNumber = $database->charEncoder($_POST['trackingNumber']);
		// $textArea = utf8_decode($_POST['textArea']);
		$textArea = $_POST['textArea'];
		$textArea = $database->charEncoder($textArea);
		if(substr($trackingNumber,0,4) == "LING"){
			$sql = "select id from particulars where trackingnumber = '" . $trackingNumber . "'";
			$record = $database->query($sql);
			
			$count = $database->num_rows($record);
			$arr = explode("RAF",$textArea);
			if($count == 0){
				$sql = "Insert into particulars (TrackingNumber,Particulars)values('" . $trackingNumber . "','" . $arr[0] . "')";
				$database->query($sql);
			}else{
				$sql = "update particulars set Particulars = '" . $arr[0] . "' where trackingnumber = '" . $trackingNumber . "'";
				$database->query($sql);
			}
		}else{
			$sql = "update particulars set Particulars = '" . $textArea . "' where trackingnumber = '" . $trackingNumber . "'";
			$database->query($sql);
		}
		
		$database->EditLogs($trackingNumber,"Particulars","A" , trim($textArea),$_SESSION['officeCode'], $_SESSION['fullName'],$dateEncoded);	
	}
	
	
	if(isset($_GET['pdfUpload'])) { // Invertory - Acceptance &  Inspection Report

		$officeNumber = $database->charEncoder($_GET['officeNumber']);
		$PONumber = $database->charEncoder($_GET['PONumber']);
		$Subject  = $database->charEncoder($_GET['Subject']);
		$filename = $database->charEncoder($_GET['filename']);

		$pathfile = $database->charEncoder($_GET['pathfile']);

		$yearNow = substr($dateEncoded,0,4); // get current yearNo
		$monthNow = date('m', $dt);
		$sql = "select filename from amis.archives where filename = '" . $filename . "' limit 1";
		//$count = $amisdb->amisQuery($sql, 'countrows');
		$record = $database->query($sql);
		$count = $database->num_rows($record);

		/* $record = $database->query($sql);
		$count = $database->num_rows($record);*/

		if($count >= 1 ){

		    echo "Unable to save file";
		    exit;

		}else{
            date_default_timezone_set('Asia/Manila');
            $datedisplay = date('Y-m-d-h-i-sa', $dt);
          //  $pdfEXTReplacer = str_replace(".pdf","", $filename);

           // $filename = $pdfEXTReplacer . '_' . $datedisplay . '.pdf';


            $valueString = "'".$officeNumber."','". $PONumber."','". $Subject."','". $filename."','". $yearNow."','". $monthNow."','". $employeeNumber."','". $dateEncoded;
			//$database->uploadArchivesPDF($amisDB,$valueString);
			$sql = "Insert amis.archives(Office,PO_Number,Subject,filename,year,month,UploadedBy,DateUploaded) values(" . $valueString . "')";
			//$amisdb->amisQuery($sql);
			$database->query($sql);

			$success = str_replace('1', '', $pathfile.'Upload Success!');
			echo $success;
		}
		
	}

	if(isset($_GET['createPPMPpage'])){
		$office = $database->charEncoder($_GET['office']);		
		$ppmpType =  $database->charEncoder($_GET['ppmpType']);
		$entry =  $database->charEncoder($_GET['entry']);
		$limit = $database->charEncoder($_GET['limit']);
		
		/*$sql = "SELECT a.OfficeCode as Office_code,a.ProgramCode as program_Code,c.Name as General, a.AccountCode as Account_Code, 
				(ifnull(a.Jan,0) + ifnull(a.Feb,0) + ifnull(a.Mar,0) + ifnull(a.Apr,0) + ifnull(a.May,0) + ifnull(a.Jun,0) + ifnull(a.Jul,0) + ifnull(a.Aug,0) + ifnull(a.Sep,0) + ifnull(a.Oct,0) + ifnull(a.Nov,0) + ifnull(a.Dex,0)) 
				as quantity,a.Unit as quantity_unit,a.Item as item_type, a.Total as  est_budget,
				       if(a.jan < 1,'',a.jan) as jan,
				       if(a.feb < 1,'',a.feb) as feb,
				       if(a.mar < 1,'',a.mar) as mar,
				      if(a.apr < 1,'',a.apr) as apr,
				      if(a.may < 1,'',a.may) as may,
				      if(a.jun < 1,'',a.jun) as jun,
				       if(a.jul < 1,'',a.jul) as jul,
				      if(a.aug < 1,'',a.aug) as aug,
				      if(a.sep < 1,'',a.sep) as sep,
				      if(a.oct < 1,'',a.oct) as oct,
				      if(a.nov < 1,'',a.nov) as nov,
				        if(a.dex < 1,'',a.dex) as decx,
				        b.Name 
				FROM ppmpmain as a
				left join office b on a.officeCode = b.code 
				left join programcode c on a.programCode = c.code
				where a.OfficeCode = '" . $office . "' and a.Fund = '" . $ppmpType . "' and a.type = '" . $entry . "' order by a.programCode asc";	*/	
		
		
		
		$sql = "select Name from office where Code = '" . $office . "' limit 1";
		$record = $database->query($sql);		
		$data = $database->fetch_array($record);
		$officeName =  addslashes($data['Name']);
			
		$sql = "SELECT Office as Office_code,if( length(Lump) > 0,Lump,Code) as program_Code, Name as General, ExpenseCode  as Account_Code,1 as quantity,'Lot' as quantity_unit, Amount as est_budget,
					'" . $entry . "' as item_type,'" . $officeName . "' as Name, 
					if(Milestone = 1,1,'') as jan,
					if(Milestone = 2,1,'') as feb,
				    if(Milestone = 3,1,'') as mar,
				    if(Milestone = 4,1,'') as apr,
				    if(Milestone = 5,1,'') as may,
				    if(Milestone = 6,1,'') as jun,
				    if(Milestone = 7,1,'') as jul,
				    if(Milestone = 8,1,'') as aug,
				    if(Milestone = 9,1,'') as sep,
				    if(Milestone = 10,1,'') as oct,
				    if(Milestone = 11,1,'') as nov,
				    if(Milestone = 12,1,'') as decx
				  FROM programcode where FundYear = '" . $year . "' and  Office = '" . $office . "' and Fund = '" . $ppmpType . "' and Entry = '" . $entry . "' and Category = 'Infrastructure Project' order by Code asc";
		
		$record = $database->query($sql);
		
		echo $sheet->CreatePPMPview($record,$limit);
	}
	if(isset($_GET['loadMore'])){ // updated code - 06-10-2022
		$id = $database->charEncoder($_GET['id']);
		$ctr = $database->charEncoder($_GET['ctr']);
		$key = $database->charEncoder($_GET['key']);
		
		$arr = explode('*!*',$key);
		$field = $arr[0];
		$searchValue  = $arr[1];

		$searchStr = "";
		if($field == "Claimant") {
			$searchStr = " LIKE  '%" . $searchValue . "%'";
		}elseif($field == "Status") {
			$searchStr = " =  '" . $searchValue . "'";
		}

		if($_SESSION['accountType'] == 1){
			$condition = "WHERE ".$field.$searchStr."   AND Office = '"  .  $office .  "' AND Id < '"  . $id . "'";
		}
		
		if($_SESSION['accountType'] == 2  || ($_SESSION['officeCode'] == '1081' && $_SESSION['accountType'] > 1)){
			$condition = "WHERE ".$field.$searchStr."   AND Id < '"  . $id . "'";
		}

		$newRecord = [];
		$sql = "SELECT * FROM vouchercurrent ".$condition." GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 40";
		$record = $database->query($sql);
		$countMany = $database->num_rows($record);

		while ($data = $database->fetch_array($record)) {
			$color = '';
			$period = '';
			$thisId  = $data['Id'];
			// $office = $data['Name'];
			$office = '';
			$type = $data['TrackingType'];
			$status = $data['Status'];
			$claimant = strtoupper($data['Claimant']);
			$check = $data['checknumber'];
			
			$docType = $data['DocumentType'];
			$doc = explode("-",$docType);
			if(sizeof($doc) == 1 ){
				$doc[1] = $docType;
			}
			$category = $data['PR_CategoryCode'];
			if($type == 'PR'){
				$docType = 'Purchase Request';
				$doc[1] = $category;
			}

			$fund = $data['Fund'];
			$claimType = $data['ClaimType'];
			
			$amount  = $data['Amount'];
			if($data['PO_Amount']> 0){
				$amount = $data['PO_Amount'];
			}
			if($data['TotalAmountMultiple'] > 0){
				$amount = $data['TotalAmountMultiple'];
			}
			
			
			$tn = $data['TrackingNumber'];
			$obr = $data['OBR_Number'];
			$po = $data['PO_Number'];
			$pr = $data['PR_Number'];
			$adv = $data['ADV1'];
			if($adv == 0){
				$adv = $data['ADV2'];
				if($adv == 0){
					$adv = '';
					}
			}
			
			
			$dateEncoded = $data['DateEncoded'];
			$dateModified = $data['DateModified'];
			$completion = $data['Completion'];
			$periodType = $data['PeriodType']; 
			$periodMonth= $data['PeriodMonth'];
			$encodedBy = '';
			if($type == 'PY'){
				 
				if($periodType == 1){
					$period =  '(1 -15)';
				}else if ($periodType == 2){
					if(strtoupper($periodMonth) == "FEBRUARY"){
						$period =  ' (16 - 28)';
					}else{
						$period =  ' (16 - 31)';
					}
				}else if($periodType == 4){
					$period =  '(1 -15)';
				}else if ($periodType == 5){
					if(strtoupper($periodMonth) == "FEBRUARY"){
						$period =  ' (16 - 28)';
					}else{
						$period =  ' (16 - 31)';
					}
				}else{
					$period = "";
				}
			}else {
				$period =  $database->numberToQuarter($data['PR_Month']);
				$period  =  "";
			}

			$newRecord[$tn]['Id'] = $thisId;
			$newRecord[$tn]['OfficeName'] = $office;
			$newRecord[$tn]['TrackingType'] = $type;
			$newRecord[$tn]['Status'] = $status;
			$newRecord[$tn]['Claimant'] = $claimant;
			$newRecord[$tn]['checknumber'] = $check;
			$newRecord[$tn]['DocumentType'] = $doc[1];
			$newRecord[$tn]['Fund'] = $fund;
			$newRecord[$tn]['ClaimType'] = $claimType;
			$newRecord[$tn]['Amount'] = $amount;
			$newRecord[$tn]['TrackingNumber'] = $tn;
			$newRecord[$tn]['OBR_Number'] = $obr;
			$newRecord[$tn]['PO_Number'] = $po;
			$newRecord[$tn]['PR_Number'] = $pr;
			$newRecord[$tn]['ADV'] = $adv;
			$newRecord[$tn]['DateEncoded'] = $dateEncoded;
			$newRecord[$tn]['DateModified'] = $dateModified;
			$newRecord[$tn]['Completion'] = $completion;
			$newRecord[$tn]['EncodedBy'] = $encodedBy;
			$newRecord[$tn]['Period'] = $period;
			$newRecord[$tn]['PeriodMonth'] = $periodMonth;
		}
		$countMany = $database->num_rows($record);
		echo $sheet->CreateListResultPrivate2022($newRecord,$searchValue,$countMany,$ctr,$id,1);
		
		// if($field == "Claimant"){
		// 	if($_SESSION['accountType'] == 1){
		// 		$condition = "where claimant  like  '%" . $searchValue . "%' and a.Office = '"  .  $office .  "' and a.id < '"  . $id . "'";
		// 	}
		// 	if($_SESSION['accountType'] == 2  || $_SESSION['officeCode'] == '1081' ){
		// 		$condition = "where claimant  like  '%" . $searchValue . "%' and a. id < '"  . $id . "'";
		// 	}
		// 	$sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.category_name as  CategoryName
		// 					FROM " . $db . "vouchercurrent a 
		// 					left join " . $db . "office b on a.office = b.code  
		// 					left join citydoc.employees c on a.encodedby = c.employeenumber
		// 					left join " . $db . "programcode d on a.PR_ProgramCode = d.code
		// 					left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
		// 					left join " . $bac . "item_categories f on a.PR_CategoryCode = f.category_key " . $condition . " group by trackingnumber order by id desc limit 40";
		// 	$record = $database->query($sql);
		// 	$countMany = $database->num_rows($record);
		// 	echo $sheet->CreateListResultPrivate($record,0,0,$searchValue,$countMany,$ctr,$id,1);
		// }else if($field == "Status"){
		// 	if($_SESSION['accountType'] == 1){
		// 		$condition = "where status =  '" . $searchValue . "' and a.Office = '"  .  $office .  "' and a.id < '"  . $id . "'";
		// 	}
		// 	if($_SESSION['accountType'] == 2  || $_SESSION['officeCode'] == '1081' ){
		// 		$condition = "where status =  '" . $searchValue . "' and a. id < '"  . $id . "'";
		// 	}
		// 	$sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.category_name as  CategoryName
		// 					FROM " . $db . "vouchercurrent a 
		// 					left join " . $db . "office b on a.office = b.code  
		// 					left join citydoc.employees c on a.encodedby = c.employeenumber
		// 					left join " . $db . "programcode d on a.PR_ProgramCode = d.code
		// 					left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
		// 					left join " . $bac . "item_categories f on a.PR_CategoryCode = f.category_key " . $condition . " group by trackingnumber order by id desc limit 40";
		// 	$record = $database->query($sql);
		// 	$countMany = $database->num_rows($record);
		// 	echo $sheet->CreateListResultPrivate($record,0,$searchValue,0,$countMany,$ctr,$id,1);
		// }
	}
	if(isset($_GET['getRecordBac'])){
		$record = $database->charEncoder($_GET['record']);
		$sql = "select * from bacuploads where record = '" . $record . "' order by year desc,month desc,type asc";
		$record =  $database->query($sql);
		echo $sheet->CreateBACReports($record);
	}	
	if(isset($_GET['removeUploaded'])){
		$id = $database->charEncoder($_GET['id']);
		$filename = $database->charEncoder($_GET['filename']);
		$sql = "delete from bacuploads where id = '" . $id . "'";
		$database->query($sql);
		
		unlink("../uploadsBAC/". $filename);
		
		echo $id;
	}
	if(isset($_GET['fetchLingapName'])){
		$name  = $database->charEncoder($_GET['name']);
		$sql = "select a.*,b.Status,b.TrackingNumber,b.Completion,b.DateModified,b.checknumber from listattachments a left join vouchercurrent b on a.TrackingNumber = b.TrackingNumber  where a.name like '%" . $name . "%' order by name asc";
		$record= $database->query($sql);
		echo $sheet->CreateLingapNameList($record);
	}
	if(isset($_GET['updatePayeeNumber'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$payeeNumber = $database->charEncoder($_GET['payeeNumber']);
		
		$sql = "UPDATE vouchercurrent SET PayeeNumber = '" . $payeeNumber . "'  WHERE TrackingNumber = '" . $trackingNumber  . "'";				
		$result = $database->query($sql);
	}
	if(isset($_GET['removeBeneficiary'])){
		
		$tn = $database->charEncoder($_GET['tn']);
		$amount = $database->charEncoder($_GET['amount']);
		$id = $database->charEncoder($_GET['id']);
		

		$sql  = "Select * from vouchercurrent where trackingnumber  = '" . $tn . "' limit 1";
		$result = $database->query($sql);
		$data = $database->fetch_array($result);
		$status =  $data['Status'];
		
	
		if($status == "CAO Released"){
			echo "0";
		}else{
			$sql = "Update listattachments SET TrackingNumber = NULL, DocumentType = NULL, Rows = NULL where id  = '" . $id  . "'";
			$database->query($sql);
			
			$sql = "Update listattachments SET Rows = (Rows -1)  where trackingnumber  = '" . $tn  . "'";
			$database->query($sql);
			
			$sql = "Update vouchercurrent SET Amount = (Amount -  " . $amount  . ")  where trackingnumber  = '" . $tn  . "'";
			$database->query($sql);
			echo    str_replace('LING','',$tn);
		} 
	}
	if(isset($_GET['fetchPODetails'])){
		$tn = $database->charEncoder($_GET['tn']);
		if(substr($tn,0,2) == "PR"){
			// $sql = "select Id,sum(qty) as Qty, Unit,Description, Amount, sum(Total) as Total,ProgramCode,Code  from prrecord  where trackingnumber = '"  . $tn  . "' group by Unit, Description,Amount order by Description,ProgramCode asc";
			$sql = "select Id,sum(qty) as Qty, Unit,Description, Amount, sum(Total) as Total,ProgramCode,Code  from prrecord  where trackingnumber = '"  . $tn  . "' group by Unit, Description,Amount order by Sequence,Description,ProgramCode asc";
			
			$record = $database->query($sql);
		}else{
			$sql = "select Id,sum(qty) as Qty, Unit,Description, Amount, sum(Total) as Total,ProgramCode,Code  from porecord  where trackingnumber = '"  . $tn  . "' group by Unit, Description,Amount order by Sequence,Description,ProgramCode asc";
			// $sql = "select Id,sum(qty) as Qty, Unit,Description, Amount, sum(Total) as Total,ProgramCode,Code  from porecord  where trackingnumber = '"  . $tn  . "' group by Unit, Description,Amount order by Description,ProgramCode asc";
			//$sql = "select sum(qty) as Qty, Unit,Description, sum(Amount) as Amount, sum(Total) as Total,ProgramCode,Code  from porecord  where trackingnumber = '"  . $tn  . "' group by Unit, Description order by Description,ProgramCode asc";
			$record = $database->query($sql);
		}
		
		$sql = "select Office,Claimant,PR_Number,PR_Month,PR_CategoryCode,Year,PR_ProgramCode,PR_AccountCode,PO_Number,Particulars,PaymentTerm,ModeOfProcurement  from vouchercurrent a left join particulars b
				on a.TrackingNumber = b.TrackingNumber
		  where a.trackingnumber = '"  . $tn  . "'";
		
		$record1 = $database->query($sql);
		//$data = $database->fetch_array($record1);
		$pro = '';
		$progs = array();
		$acc = '';
		$accs = array();
		$i =0;
		$pyTerm = '';
		
		while($data = $database->fetch_array($record1)){
			$supplier = $data['Claimant'];
			$prNumber = $data['PR_Number'];
			$category = $data['PR_CategoryCode'];
			$poNumber = $data['PO_Number'];
			// $purposeA = urlencode($data['Particulars']);
			$purposeA = $data['Particulars'];
			
			$office = $data['Office'];
			$quarter= $database->numberToQuarter($data['PR_Month']) . ' ' . $data['Year'];
			
			$pro = $data['PR_ProgramCode'];
			$progs[$i] = $pro;
			//array_push($progs,$pro); 
			$acc = $data['PR_AccountCode'];
			
			$pyTerm = $data['PaymentTerm'];
			if($pyTerm == 1) {
				$pyTerm = 'After full delivery';
			}elseif($pyTerm == 2) {
				$pyTerm = 'Per Statement';
			}elseif($pyTerm == 3) {
				$pyTerm = 'Cash on Delivery';
			}else {
				$pyTerm = '';
			}

			$modOfProcList = [	'','Competitive Bidding','Shopping','Shopping 52.1.b','Alternative','Agency to Agency','Negotiated','Negotiated Procurement 53.9(SVP)',
								'Negotiated Procurement 53.1(TFB)','Negotiated Procurement 53.6(MS)','Negotiated Procurement 53.7','Negotiated Procurement 53.2(E.C.)',
								'Postal Office','Direct Contracting','Repeat Order','Two Failed Biddings(TFB)','Extension of Contract Appx. 21 Sec. 3.31',
								'Renewal of Contract Based on Appendix 21 3.3.1.3','Agency to Agency (DBM)','Lease of Real Property Sec 5.10'];
			$mdOfProc = $modOfProcList[$data['ModeOfProcurement']];
			

			array_push($accs,$acc); 
			$i++;
		}
		
		$sql = "Select Description from ppmpcategories where code = '" . $category  . "'";
		$record2 = $database->query($sql);
		$data1 = $database->fetch_array($record2);
		$categoryName = $data1['Description'];
			
		$sql = "Select Name from office where code = '" . $office  . "'";
		$record3 = $database->query($sql);
		$data3 = $database->fetch_array($record3);
		$officeName = $data3['Name'];
			
		$sql = "SELECT Header, Terms FROM particulars WHERE TrackingNumber = '".$tn."' LIMIT 1";
		$record4 = $database->query($sql);
		$data4 = $database->fetch_array($record4);
		// $terms =  $database->charEncoder(nl2br($data4['Terms']));
		// $terms = nl2br($data4['Terms']);
		$terms = $data4['Terms'];
		$header = $data4['Header'];
	
		class POdetails {
			public $trackingNumber;	
			public $office;
		
			public $supplier;	
			public $prNumber;
			
			public $catCode;
			public $catName;
			public $quarter;
			
			public $programs;
			public $codes;
			public $purpose;

			public $paymentTerm;
			public $modeOfProc;
			public $terms;
			
			public $qty = array();	
			public $unit = array();
			public $desc = array();
			public $cost = array();
			public $total = array();
			public $poId = array();   
		 }		
		$p = new POdetails();
		$i = 0;

		if(strlen(trim($header)) > 0) {
			$p->qty[$i] = 0;
			$p->unit[$i] = '';
			$p->desc[$i] = $header;
			$p->cost[$i] = number_format(0,2);
			$p->total[$i] = number_format(0,2);
			$p->poId[$i] = 0;
			$i++;
		}

		while($data = $database->fetch_array($record)){
			$p->qty[$i] = $data['Qty'];
			$p->unit[$i] = $data['Unit'];
			$p->desc[$i] = $data['Description'];
			$p->cost[$i] = number_format($data['Amount'],2);
			$p->total[$i] = number_format($data['Total'],2);
			$p->poId[$i] = $data['Id'];
			$i++;
		}
		
		$p->trackingNumber = $tn; 
		$p->office = $officeName; 
		$p->officeCode = $office; 
		
		
		// $p->supplier = $supplier;
		$p->supplier = utf8_encode($supplier);
		$p->prNumber = $prNumber;
		$p->poNumber = $poNumber;
		
		
		
		
		$p->caoName = "Hello";
		
		
		
		$p->catCode = $category;
		$p->catName = $categoryName;
		$p->qua = $quarter;


		$p->paymentTerm = $pyTerm;
		$p->modeOfProc = $mdOfProc;
		$p->terms = $terms;
		
		
		$uniProg =  array_unique($progs);
		$progCom = implode(",", $uniProg);
		$p->programs = $progCom;
		
		$uniAcc =  array_unique($accs);
		$accCom = implode(",", $uniAcc);
		$p->codes = $accCom;
		$p->purpose = $purposeA;
		echo  json_encode($p);
		
		
	}
//------------------------------------------------------------------------------------------------------------------------ 2018
// PPMP------------------------------------------------------------------------------------------------------------- new	
	if(isset($_GET['loadPPMPbyCode'])){
		$officeCode = $_SESSION['officeCode'];
		$programCode = $database->charEncoder($_GET['programCode']);
		
		$sql = "select * from bacdb2017.ppmp where office_code = '" . $officeCode . "' and program_code = '" . $programCode . "'";
		$record = $database->query($sql);
		
		echo $sheet1->CreatePPMPprevious($record);
	}
	if(isset($_GET['loadPPMPbyCategory'])){
		$officeCode = $_SESSION['officeCode'];
		$programCode = $database->charEncoder($_GET['programCode']);
		$sql = "select * from bacdb2017.ppmp where office_code = '" . $officeCode . "' and program_code = '" . $programCode . "'";
		$record = $database->query($sql);
		
		echo $sheet1->CreatePPMPprevious($record);
	}
	if(isset($_GET['loadPPMPProgramCode'])){
		$sql = "select * from programcode order by code asc";
		$record = $database->query($sql);
		echo $sheet1->CreateProgramCodeOnly($record);
	}
	if(isset($_GET['preLoad'])){
		
		$officeCode = $_SESSION['cbo'];
		
		// $sql = "select * from programcode where locker  = 0 or locker is null order by code asc";
		$sql = "select * from programcode where (locker  = 0 or locker is null) and Code is not null order by code asc";
		$record = $database->query($sql);
		$programs  =  $sheet1->CreateProgramCodeOnly($record);
		
		$sql = "select * from fundtitles where fund = 'MOOE' or fund  = 'CO'  or fund  = 'PS'  order by code asc";
		$record = $database->query($sql);
		$accountCodes  =  $sheet1->CreateAccountCodes($record);
		
		$sql = "select * from  ppmpcategories order by code asc";
		$record = $database->query($sql);
		$category  =  $sheet1->CreatePPMPcategory($record);
		
		$sql = "select * from ppmpunits order by unit asc";
		$record = $database->query($sql);
		$units  =  $sheet1->CreatePPMPunits1($record);
		
		$sql = "select * from office where code = '" . $officeCode . "' limit 1";
		$record = $database->query($sql);
		
		$data = $database->fetch_array($record);
		$lock = $data['PPMP']; 
		echo $programs . '~~' .  $accountCodes . '~~' . $category  . '~~' . $units . '~~' .  $lock;
	}
	if(isset($_GET["fetchItemsByCategory"])){
		$categoryCode = trim($database->charEncoder($_GET['categoryCode']));
		$sql = "select Id,Description,EstimatedPrice,PurchasedUnit from ppmpitems where CategoryCode = '" .  $categoryCode .  " 'order by description asc";
		$record = $database->query($sql);
		echo $sheet1->CreatePPMPItems($record);
	}

	if(isset($_GET['ItemManagementReload'])){  // Inventory - Item Management
		$a = '';
		$b = '';
		$c = '';
		$d = '';
		$e = '';

		$sql = "select * from ppmpcategories order by code asc";
		$record1 = $database->query($sql);
		$record2 = $database->query($sql);
		$record2a = $database->query($sql);

		$sql1 = "select * from ppmpunits order by unit asc";
		$record3 = $database->query($sql1);
		$record4 = $database->query($sql1);

		$a = $sheet1->ListOutCategories1($record1);
		$b = $sheet1->ListOutCategories2($record2);
		$e = $sheet1->ListOutCategories3($record2a);
		$c = $sheet1->CreatePPMPunits($record3);
	
		class PPMPUnits {
			public $unit = array();
		}

		$x = new PPMPUnits();
		$i = 0;
		while($data = $database->fetch_array($record4)){
			$x->unit[$i] = $data['Unit'];
			$i++;
		}
		$d = json_encode($x);

		echo $a . '!~!' . $b . '!~!' . $c .'!~!' . $d .'!~!' . $e; 
	}


	if(isset($_GET['ListOutCategory'])){  // Inventory - Item Management
		$category = $database->charEncoder($_GET['category']);
		$sql = "select b.*, a.Description as CatergoryDescription
					from ppmpcategories a
					left join ppmpitems b on b.CategoryCode = a.Code where CategoryCode = '" . $category . "' order by b.Description asc";
		$record = $database->query($sql);
		if ($database->num_rows($record) > 0){
			echo $sheet1->ListOutEntryonView($record);
		} else {
			echo '';
		}
	}


	if(isset($_GET['ListOutItemClassification'])){  // Inventory - Item Management
		$itemclassification = $database->charEncoder($_GET['itemclassification']);
		$cat = $database->charEncoder($_GET['category']);
		if($cat){
			$sql = "select b.*, a.Description as CatergoryDescription from ppmpcategories a
					left join ppmpitems b on b.CategoryCode = a.Code where Classification = '" . $itemclassification ."' and CategoryCode = '" . $cat . "' order by b.CategoryCode, b.Description ASC";
		}else{
			$sql = "select b.*, a.Description as CatergoryDescription from ppmpcategories a
					left join ppmpitems b on b.CategoryCode = a.Code where Classification = '" . $itemclassification ."' order by b.CategoryCode, b.Description ASC";
		}
		
		$record = $database->query($sql);
		if ($database->num_rows($record) > 0){
			echo $sheet1->ListOutEntryonView($record);
		} else {
			echo '';
		}
	}


	if(isset($_GET['searchViewItemList'])){ // Inventory - Item Management
		$key = $database->charEncoder($_GET['key']);
		
		if (is_numeric($key)) {
			$sql =	"select b.*, a.Description as CatergoryDescription
				from ppmpcategories a
				left join ppmpitems b on b.CategoryCode = a.Code
				where b.Id = '".$key."' limit 1";
		}else{
			$sql =	"select b.*, a.Description as CatergoryDescription
				from ppmpcategories a
				left join ppmpitems b on b.CategoryCode = a.Code
				where b.Description like '%".$key."%' order by b.CategoryCode, b.Description ASC";
		} 
		
		$record = $database->query($sql);
		if ($database->num_rows($record) > 0){
			echo $sheet1->ListOutEntryonView($record);
		} else {
			echo '<div style = "font-weight:bold;padding:15px;font-size:20px;">No record found.</div>';
		}	
	}

	if(isset($_POST["saveItemEntry"])){ // Inventory - Item Management
		$date = $database->charEncoder($_POST['date']);
		$category = $database->charEncoder($_POST['category']);
		$description =  $database->charEncoder(urldecode($_POST['description']));
		$classification = $database->charEncoder($_POST['classification']);
		//$economiclife = $database->charEncoder($_POST['economiclife']);
		$purchasedunit = $database->charEncoder($_POST['purchasedunit']);
		//$releasedunit = $database->charEncoder($_POST['releasedunit']);
		//$order = $database->charEncoder($_POST['order']);
		//$reorderunit = $database->charEncoder($_POST['reorderunit']);
		$estimatedprice = $database->charEncoder($_POST['estimatedprice']);
		//$reorderpoint = $database->charEncoder($_POST['reorderpoint']);
		
		$sql = "Select * from ppmpitems WHERE description  = '" . $description . "' and PurchasedUnit = '" . $purchasedunit . "' limit 1";
		$record = $database->query($sql);
		
		$count = $database->num_rows($record);
		if($count == 1 ){
			$data = $database->fetch_array($record);
			$id  = $data['Id']; 
			echo $id;
		}else{
			$queryThis  = "Insert ppmpitems (CategoryCode,Description,Classification,PurchasedUnit,EstimatedPrice,DateCanvassed,DateEncoded,EncodedBy)";
			$queryThis .= "VALUES('". $category ."','". $description ."','" . $classification ."','". $purchasedunit ."','". $estimatedprice ."','" . $date . "','" . $dateEncoded . "','" . $employeeNumber . "')";
			$database->query($queryThis);
			
			
			$queryThis = "select b.*, a.Description as CatergoryDescription
					from ppmpcategories a
					left join ppmpitems b on b.CategoryCode = a.Code
					where b.categoryCode = '". $category  ."' order by b.Id desc limit 1";

			$record = $database->query($queryThis);
			
			$value =  $estimatedprice . '-' . $date;
			$database->EditLogs('','PPMP Items',"New Entry",$value ,$office,$employeeNumber,$dateEncoded);
			
			echo $sheet1->CreateItemEntryList($record);
		}
		
	}

	if(isset($_POST['updateItemManagementItems'])){  // Inventory - Item Management

		$Id = $database->charEncoder($_POST['id']);
		$Category = $database->charEncoder($_POST['editCategory']); 
		$Description = $database->charEncoder(urldecode($_POST['editDescription']));
		$Classification = $database->charEncoder($_POST['editClassification']);
		
		//$Economiclife = $database->charEncoder($_POST['editEconomiclife']);
		$purchasedunit = $database->charEncoder($_POST['editpurchasedunit']);
		//$Releasedunit = $database->charEncoder($_POST['editReleasedunit']);
		//$Order = $database->charEncoder($_POST['editOrder']);
		//$ReorderUnit = $database->charEncoder($_POST['editReorderUnit']);
		
		$EstimatedPrice = $database->charEncoder($_POST['editEstimatedPrice']);
		
		
		
		
		//$ReorderPoint = $database->charEncoder($_POST['editReorderPoint']);
		$dateCanvassed =   $database->charEncoder($_POST['dateCanvassed']);

		/*$queryThis  = "Update ppmpitems Set CategoryCode ='" .$Category. "', Description ='" .$Description. "', Classification ='" . $Classification. "',";
		$queryThis .= "EconomicLife ='" .$Economiclife. "', PurchasedUnit ='" .$purchasedunit. "', ReleasedUnit ='" .$Releasedunit. "', OrderQuantity ='".$Order. "',";
		$queryThis .= "ReorderUnit ='" .$ReorderUnit. "', EstimatedPrice ='".$EstimatedPrice."', ReorderPoint ='".$ReorderPoint."', DateCanvassed = '" . $dateCanvassed . "', DateModified = '" . $dateEncoded . "', EncodedBy = '" . $employeeNumber . "' 
						where Id ='".$Id."'";*/
		
		$queryThis  = "Update ppmpitems Set CategoryCode ='" .$Category. "', Description ='" .$Description. "', Classification ='" . $Classification. "',PurchasedUnit ='" .$purchasedunit. "', EstimatedPrice ='".$EstimatedPrice."', DateCanvassed = '" . $dateCanvassed . "', DateModified = '" . $dateEncoded . "', EncodedBy = '" . $employeeNumber . "' 
						where Id ='".$Id."'";


		$row = $database->affected_rows($database->query($queryThis));
		$queryThis = "select b.*, a.Description as CatergoryDescription
				from ppmpcategories a
				left join ppmpitems b on b.CategoryCode = a.Code
				where b.Id = '".$Id."'";

		$record = $database->query($queryThis);
		$value =  $EstimatedPrice . '-' . $dateCanvassed;
		$database->EditLogs($Id,'PPMP Items',"Edit Entry",$value ,$office,$employeeNumber,$dateEncoded);
		
		
		echo $sheet1->CreateItemEntryList($record) . '!~!' . $Id ;
	}
	if(isset($_POST["savePPMP"])){
		
		$type = $database->charEncoder($_POST['type']);
		$fund = $database->charEncoder($_POST['fund']);
		$programCode = $database->charEncoder($_POST['programCode']);
		$code = $database->charEncoder($_POST['code']);
		$category = $database->charEncoder($_POST['category']);
		$itemId =  $database->charEncoder($_POST['itemNo']);
		
		//$item = $database->charEncoder(urldecode( $_POST['item']));
		$desc = $database->charEncoder(urldecode($_POST['desc']));
		$item = $desc;
		
		$unit = $database->charEncoder($_POST['unit']);
		$cost = $database->charEncoder($_POST['cost']);
		$total = $database->charEncoder($_POST['total']);
		$addCase = trim($database->charEncoder($_POST['addCase']));
		$months = explode(',',$addCase);
		$m1 ='';
		$mv = '';
		for($i = 0; $i < sizeof($months); $i++){
			$m = explode('=',$months[$i]);
			$m1 .= $m[0] . ',';
			$mv .= $m[1] . ',';
		}
		$m1 = substr($m1,0,strlen($m1)-1);
		$mv = substr($mv,0,strlen($mv)-1);
		
		$office = $_SESSION['officeCode'];
		$encodedBy = $_SESSION['employeeNumber'];
		
		$sql = "Insert into ppmpmain (OfficeCode,ProgramCode,AccountCode,Type,Fund,Category,Unit,ItemNo,Item,Description,Cost,Total,EncodedBy,DateEncoded," . $m1 . ") 
			   VALUES ('" . $office . "', '" . $programCode . "', '" . $code . "', '" . $type . "', '" . $fund . "','" . $category . "','" . $unit . "'," . $itemId . ", '" . $item . "','" . $desc . "'," . $cost . "," . $total . ",'" . $encodedBy . "','" . $dateEncoded . "', " . $mv .  " )";
		$database->query($sql);	
		
		$sql = "select * from ppmpmain order by id desc limit 1";
		$record = $database->query($sql);
		
		echo $sheet1->CreateTRitem($record);		
		
		
		
	}
	if(isset($_GET['fetchPPMPbyProgram'])){
		$programCode =  $database->charEncoder($_GET['programCode']);
		$officeCode = $_SESSION['officeCode'];
		//$sql = "select * from ppmpmain where officecode = '" . $officeCode . "' and programcode = '" .  $programCode . "' order by id desc";
		$sql = "select a.*,b.Title,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code left join programcode c on a.programcode = c.Code
		
		where officecode = '" . $officeCode . "' and programcode = '" . $programCode . "' order by id desc";
		$record = $database->query($sql);
		if($database->num_rows($record) > 0){
			echo $sheet1->CreateSavedPPMPbyProgram($record);
		}else{
			echo '';
		}
	}
	if(isset($_GET['deletePPMP'])){
		$id = $database->charEncoder($_GET['ppmpId']);
		$sql = "delete from ppmpmain where Id = '" . $id . "'";
		 $database->query($sql);
		echo $id;
	}
	if(isset($_POST['updatePPMP'])){
		
		$id = $database->charEncoder($_POST['id']);
		$type = $database->charEncoder($_POST['type']);
		$fund = $database->charEncoder($_POST['fund']);
		$programCode = $database->charEncoder($_POST['programCode']);
		$code = $database->charEncoder($_POST['code']);
		$category = $database->charEncoder($_POST['category']);
		$item = $database->charEncoder(urldecode($_POST['item']));
		$desc = $database->charEncoder(urldecode($_POST['desc']));
		$unit = $database->charEncoder($_POST['unit']);
		$cost = $database->charEncoder($_POST['cost']);
		$total = $database->charEncoder($_POST['total']);
		
		$jan = $database->nullToZero($database->charEncoder($_POST['jan']));
		$feb = $database->nullToZero($database->charEncoder($_POST['feb']));
		$mar = $database->nullToZero($database->charEncoder($_POST['mar']));
		$apr = $database->nullToZero($database->charEncoder($_POST['apr']));
		$may = $database->nullToZero($database->charEncoder($_POST['may']));
		$jun =$database->nullToZero($database->charEncoder($_POST['jun']));
		$jul = $database->nullToZero($database->charEncoder($_POST['jul']));
		$aug = $database->nullToZero($database->charEncoder($_POST['aug']));
		$sep = $database->nullToZero($database->charEncoder($_POST['sep']));
		$oct = $database->nullToZero($database->charEncoder($_POST['oct']));
		$nov = $database->nullToZero($database->charEncoder($_POST['nov']));
		$dec = $database->nullToZero($database->charEncoder($_POST['dec']));
		
		$sql = "update ppmpmain set Type = '" . $type . "', Fund = '" . $fund . "', ProgramCode = '" . $programCode  . "', AccountCode = '" . $code . "', Category = '" . $category . "',
								  Item = '" . $item . "', Description = '" . $desc . "', Unit = '" . $unit . "', Cost = '" . $cost ."' ,Total = '" . $total . "', Jan = '" . $jan . "', Feb = '" . $feb . "' , Mar = '" . $mar . "',
								  Apr = '" . $apr . "', May = '" . $may . "', Jun = '" . $jun . "', Jul = '" . $jul . "', Aug = '" . $aug . "', Sep = '" . $sep . "', Oct = '" . $oct . "', Nov = '" . $nov . "', Dex = '" . $dec . "'
								   where Id = '" . $id  . "'";
		$row = $database->affected_rows($database->query($sql));
		
		$sql = "select * from ppmpmain where id = '" . $id . "'";
		$record = $database->query($sql);
		echo $sheet1->CreateTRitem($record) . '!~!' . $id ;	
	}
	
	
//	----------------------------------------------------------------------------------------------------------View
	if(isset($_GET['loadSelectViewProgram'])){
		$a = '';
		$b = '';
		$c = '';
		
		if($accountType == 2){
			$sql = "select * from ppmpmain group by programcode order by ProgramCode asc";
		}else{
			$sql = "select * from ppmpmain where officecode = '" . $office . "' group by programcode order by ProgramCode asc";
			
		}
		$record = $database->query($sql);
		$count = $database->num_rows($record);
		if($count > 1){
			$a =  $sheet1->CreateProgramInView($record);	
			
		}else if($count == 1){
			$data = $database->fetch_array($record);
			$program =  $data['ProgramCode'];
			$a = $sheet1->CreateProgramInViewFixed($program);
			
			if($accountType == 1){
				//$sql = "select * from ppmpmain where officecode = '" . $office . "'  and programcode = '" . $program . "' order by Category asc";
				$sql = "select a.*, b.Lockers from ppmpmain a  left join programcode b on a.ProgramCode = b.Code where a.officecode = '" . $office . "'  and a.programcode = '" . $program . "' order by Category asc";
				
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal,Type from ppmpmain where officecode = '" . $office . "'  and  programcode = '" . $program . "'";
			}else{
				$sql = "select * from ppmpmain where programcode = '" . $program . "' order by Category asc";
				
				
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal,Type from ppmpmain where programcode = '" . $program . "'";
			}
			$record = $database->query($sql);
			$b =  $sheet1->CreateSavedPPMPbyProgram($record);	
			
			$record = $database->query($sql1);
			$c = $sheet1->CreateSavedPPMPTotals($record,$office,1);
		}else{
			$a = $sheet1->CreateProgramInViewFixed("No record");
		}
		
		echo $sql;
		echo $a . '!~!'  . $b .  '!~!' . $c;
	}
	if(isset($_GET['fetchSavePPMP'])){
		$program= $database->charEncoder($_GET['program']);
		$type = $database->charEncoder($_GET['type']);
		$officeCode = $database->charEncoder($_GET['officeCode']);
		$c = '';
		if($accountType == 1){
			if($program == ""){
				$sql = "select a.*,b.Title,c.Locker,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code 
						left join programcode c on a.ProgramCode = c.Code
						 where officecode = '" . $office . "' and  Type = '" . $type . "' order by Category asc";
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal  from ppmpmain where officecode = '" . $officeCode . "'  and Type = '" . $type . "' group by programcode ";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $office . "' and  Type = '" . $type . "' group by accountcode";
			}else{
				$sql = "select a.*,b.Title,c.Locker,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code 
						left join programcode c on a.ProgramCode = c.Code
						 where officecode = '" . $office . "' and programcode = '" . $program . "' and Type = '" . $type . "' order by Category asc";
				
				
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $office . "'  and  programcode = '" . $program . "' and Type = '" . $type . "'";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $office . "' and programcode = '" . $program . "' and Type = '" . $type . "' group by accountcode";
			}
			$officeCode = $office;
		}else{
			if($program == ""){
				
				$sql = "select a.*,b.Title,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code left join programcode c on a.programcode = c.code
						where officecode = '" . $officeCode . "' and Type = '" . $type . "' order by Category asc";
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal  from ppmpmain  where  Type = '" . $type . "' group by programcode ";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $officeCode . "'  and Type = '" . $type . "' group by accountcode";
			}else{
				$sql = "select a.*,b.Title,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code left join programcode c on a.programcode = c.code
						where officecode = '" . $officeCode . "' and programcode = '" . $program . "' and Type = '" . $type . "' order by Category asc";
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $officeCode . "' and programcode = '" . $program . "' and Type = '" . $type . "'";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $officeCode . "' and programcode = '" . $program . "' and Type = '" . $type . "' group by accountcode";
			}
			
		}
		$record = $database->query($sql);
		$a =  $sheet1->CreateSavedPPMPbyProgram($record);
		
		$record = $database->query($sql1);
		$b = $sheet1->CreateSavedPPMPTotals($record,$officeCode,$type);
		
		$record = $database->query($sql2);
		$c = $sheet1->CreateSavedPPMPexpenseTotals($record);
		
		echo $a . '!~!' . $c . $b;
	}
	if(isset($_GET['previewPPMP'])){
		
		$val = trim($database->charEncoder($_GET['val']));
		
		$arr = explode('~',$val);
		
		$officeCode = $arr[0];
		$programCode = $arr[1];
		$type = $arr[2];
		$fund = $arr[3];
		
		$sql = "select a.*, b.Name as ProgramDescription,c.Name as OfficeName from ppmpmain a 
					left join programcode b on a.ProgramCode = b.Code 
					left join office c on a.OfficeCode = c.Code
			    		where a.Fund = '" . $fund . "' and  officecode = '" .  $officeCode . "'  and  programcode = '" . $programCode . "' and Type = '" . $type . "'  order by accountcode,  description asc
			    ";
			    
			    
			    
		$record = $database->query($sql);
		
	    
		
		$sql = "select a.AccountCode,b.Title,sum(a.Total) as Total, a.Fund from ppmpmain a left join fundtitles b on a.accountcode = b.code 
				where a.Fund = '" . $fund . "' and OfficeCode ='" .  $officeCode . "'  and type ='" . $type . "'  and a.programCode  = '" . $programCode . "' GROUP BY a.accountcode  order by accountCode asc";
				
		$record1 = $database->query($sql);
		
		class PPMPdetails {
		    
		     public $officeName;
		     public $programCode;
		     public $programDescription;
		    
		 
		     public $accountCode = array();	
		     public $description = array();
		     public $desc = array();
		     public $cost = array();
		     public $unit = array();
		     public $qty= array();
		     public $total = array();
		     
		     public $jan = array();
		     public $feb = array();
		     public $mar = array();
		     public $apr = array();
		     public $may = array();
		     public $jun = array();
		     public $jul = array();
		     public $aug = array();
		     public $sep = array();
		     public $oct = array();
		     public $nov = array();
		     public $dec = array();
		     
		}
		$v = new PPMPdetails();
		
		$i = 0;
		$on = '';
		$pc = '';
		$pd = '';
		 
		while($data = $database->fetch_array($record)){
			$pd = $data['ProgramDescription'];
			$pc = $data['ProgramCode'];
			$on = $data['OfficeName'];
			
			$v->accountCode[$i] = $data['AccountCode'];
			$v->description[$i] = $data['Description'];
			
			$v->unit[$i] = $data['Unit'];
			$v->cost[$i] = $data['Cost'];
			$v->total[$i] = number_format($data['Total'],2);
			
			$v->jan[$i] = $data['Jan'];
			$v->feb[$i] = $data['Feb'];
			$v->mar[$i] =$data['Mar'];
			$v->apr[$i] = $data['Apr'];
			$v->may[$i] =$data['May'];
			$v->jun[$i] = $data['Jun'];
			$v->jul[$i] = $data['Jul'];
			$v->aug[$i] = $data['Aug'];
			$v->sep[$i] = $data['Sep'];
			$v->oct[$i] = $data['Oct'];
			$v->nov[$i] = $data['Nov'];
			$v->dec[$i] =$data['Dex'];
			
			$i++;
		}
		
		$i = 0;
		while($data = $database->fetch_array($record1)){
			$code = $data['AccountCode'];
			$title = $data['Title'];
			$total = $data['Total'];
			$v->consoCode[$i] =$data['AccountCode'];
			$v->consoDesc[$i] =$data['Title'];
			$v->consoTotal[$i] =$data['Total'];
			$i++;
		}
		
		$v->programDescription = $pd; 
		$v->programCode = $pc;
		$v->officeName = $on; 
		
		
		
		echo  json_encode($v);
		
	}
	
	if(isset($_GET['loadPPMPviewOffice'])){
		$acct =  $accountType;
		$a = '';
		$b = '';
		$c = '';
		$d = '';
		$e = '';
		$f= '';
		$g = '';
		if($acct == 1){
			$sql3 = "select Fund  from ppmpmain where officecode = '" . $office . "' group by Fund";
			$record = $database->query($sql3);
			$gCount = $database->num_rows($record);
			$g = '';
			$gQuery = '';
			$fund = '';
			while($data = $database->fetch_array($record)){
				$fund = $data['Fund'];
				$g .= '<option>' . $fund . '</option>';
			}
			$gQuery = " and a.Fund = '" . $fund . "'";
			
			if($gCount > 1){
				$gQuery = '';
				$g = '<option></option><option>All</option>' . $g;
			}
			
			$sql = "select Type from ppmpmain where officecode = '" . $office . "' group by Type";
			$recordType = $database->query($sql);
			$e =  $sheet1->CreateTypeInView($recordType);
			
			$sql = "select * from ppmpmain where officecode = '" . $office . "' group by programcode order by ProgramCode asc";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			if($count > 1){
				$a =  $sheet1->CreateProgramInView($record);	
			}else if($count == 1){
				$data = $database->fetch_array($record);
				$program =  $data['ProgramCode'];
				$type = $data['Type'];
				$a = $sheet1->CreateProgramInViewFixed($program);	
				
				//$sql = "select * from ppmpmain where officecode = '" . $office . "'  and programcode = '" . $program . "' order by Category asc";
				$sql = "select a.*,b.Title from ppmpmain a left join fundtitles b  on a.accountcode = b.code where officecode = '" . $office . "' and programcode = '" . $program . "' and Type = '" . $type . "'" . $gQuery . " order by Category asc";
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal,Type from ppmpmain a where officecode = '" . $office . "'  and  programcode = '" . $program . "'" . $gQuery . "";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain a where officecode = '" . $office . "' and programcode = '" . $program . "' and Type = '" . $type . "'" . $gQuery . " group by accountcode ";
				
				
				
				$count  = $database->num_rows($recordType);
				if($count == 1){
					$record = $database->query($sql);
					$b =  $sheet1->CreateSavedPPMPbyProgram($record);	
					$record = $database->query($sql1);
					$c = $sheet1->CreateSavedPPMPTotals($record,$office,1);
					
					$record = $database->query($sql2);
					$f = $sheet1->CreateSavedPPMPexpenseTotals($record);
				}
				
			}else{
				$a = $sheet1->CreateProgramInViewFixed("No record");
			}
			echo $a . '!~!'  . $b .  '!~!' . $f . $c .  '!~!' . $d  .  '!~!' . $e .  '!~!' . $g; 
		}else{
			$sql = "select Type from ppmpmain  group by Type order by ProgramCode asc";
			$recordType = $database->query($sql);
			$e =  $sheet1->CreateTypeInView($recordType);
			
			$sql = "select b.Code,b.Name from ppmpmain a left join office b on a.OfficeCode = b.Code group by officecode order by Name asc";
			
			
			$record = $database->query($sql);
			$a = $sheet1->CreatePPMPselectEmpty();
			$d = $sheet1->CreatePPMPviewOffice($record);
			
			echo $a . '!~!'  . $b .  '!~!' . $c .   '!~!' . $d .   '!~!' . $e ;
		}
	}
	if(isset($_GET['fetchPPMPprogramPerOffice'])){
		$a = '';
		$b = '';
		$c = '';
		$d = ''; 
		$e = '';
		
		
		
		$officeCode = $database->charEncoder($_GET['officeCode']);
		$sql3 = "select Fund  from ppmpmain where officecode = '" . $officeCode . "' group by Fund";
		$record = $database->query($sql3);
		$gCount = $database->num_rows($record);
		$g = '';
		$fund = '';
		
		while($data = $database->fetch_array($record)){
			$fund = $data['Fund'];
			$g .= '<option>' . $fund . '</option>';
		}
		
		if($gCount > 1){
			$gQuery = '';
			$g = '<option></option><option>All</option>' . $g;
		}
		
		
		
		$sql = "select Type from ppmpmain where officecode = '" . $officeCode . "' group by Type order by ProgramCode asc";
		$recordType = $database->query($sql);
		$recordType1 = $database->query($sql);
		
		$d =  $sheet1->CreateTypeInView($recordType);

		$sql = "select ProgramCode from ppmpmain where officecode = '" . $officeCode . "' group by programcode order by ProgramCode asc";
		$record = $database->query($sql);
		$count = $database->num_rows($record);
		if($count > 1){
			$a =  $sheet1->CreateProgramInView($record);
		}else if($count == 1){
			$data = $database->fetch_array($record);
			$program =  $data['ProgramCode'];
			$a = $sheet1->CreateProgramInViewFixed($program);	
			
			
			$count = $database->num_rows($recordType);
			
			if($count == 1){
				//$sql = "select * from ppmpmain where officecode = '" . $officeCode . "'  and programcode = '" . $program . "' order   by Category asc, Description asc";
				$sql = "select a.*,b.Title from ppmpmain a left join fundtitles b  on a.accountcode = b.code where officecode = '" . $officeCode . "' and programcode = '" . $program . "' order by Category asc";
				$record = $database->query($sql);
				$b =  $sheet1->CreateSavedPPMPbyProgram($record);	 //details

				$sql = "select ProgramCode,sum(Total) as GrandTotal,Type from ppmpmain where officecode = '" . $officeCode . "'  and programcode = '" . $program . "'";			
				$record = $database->query($sql);
				$c = $sheet1->CreateSavedPPMPTotals($record,$officeCode,1); //totals
				
				$data = $database->fetch_array($recordType1);
				$type = $data['Type'];
				
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $officeCode . "' and programcode = '" . $program . "' and Type = '" . $type . "' group by accountcode";
				$record = $database->query($sql2);
				$e= $sheet1->CreateSavedPPMPexpenseTotals($record); 
			}
		}else{
			$a = $sheet1->CreateProgramInViewFixed("No record");
		}
		
		echo $a  . '!~!' . $b  .  '!~!' . $e . $c . '!~!' . $d . '!~!' . $g;
		
	}
	
	if(isset($_GET['selectProgramPerType'])){
		$a = '';
		$b = '';
		$c = '';
		$d = '';
		$type = $database->charEncoder($_GET['type']);
		$officeCode = $database->charEncoder($_GET['officeCode']);
		if($officeCode == 1){
			$sql = "select ProgramCode from ppmpmain where officecode = '" . $office . "' and type = '" . $type . "' group by programcode";
		}else{
			$sql = "select ProgramCode from ppmpmain where officecode = '" . $officeCode . "' and type = '" . $type . "' group by programcode";
		}
		
		$recordProgram = $database->query($sql);
		$recordProgram1 = $database->query($sql);
		
		$a =  $sheet1->CreateProgramInView($recordProgram);	
		$count = $database->num_rows($recordProgram);
		if($count > 1){
			echo $a  . '!~!' . $b  .  '!~!' . $c ;	
		}else{
			$data = $database->fetch_array($recordProgram1);
			$programCode = $data['ProgramCode'];
			if($accountType == 1){
				//$sql = "select * from ppmpmain where officecode = '" . $office . "'  and programcode = '" . $programCode . "' and type = '" . $type . "' order by Category asc,description asc";
				$sql = "select a.*,b.Title,C.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code left join programcode c on a.ProgramCode = c.Code
				where officecode = '" . $office . "' and programcode = '" . $programCode . "' and type = '" . $type . "'  order by Category asc";
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal,Type from ppmpmain where officecode = '" . $office . "'  and  programcode = '" . $programCode . "' and type = '" . $type . "'  order by ProgramCode Asc";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $office . "' and programcode = '" . $programCode . "' and Type = '" . $type . "' group by accountcode";
			}else{
				//$sql = "select * from ppmpmain where officecode = '" . $officeCode . "'  and programcode = '" . $programCode . "' and type = '" . $type . "' order by Category asc";
				$sql = "select a.*,b.Title,C.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code left join programcode c on a.ProgramCode = c.Code
				where officecode = '" . $officeCode . "' and programcode = '" . $programCode . "' and type = '" . $type . "'  order by Category asc";
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal,Type from ppmpmain where officecode = '" . $officeCode . "'  and  programcode = '" . $programCode . "' and type = '" . $type . "'";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $officeCode . "' and programcode = '" . $programCode . "' and Type = '" . $type . "' group by accountcode";
			}
			
			$record = $database->query($sql);
			$b =  $sheet1->CreateSavedPPMPbyProgram($record);	
			$record = $database->query($sql1);
			$c = $sheet1->CreateSavedPPMPTotals($record,$office,1);
			
			$record = $database->query($sql2);
			$d = $sheet1->CreateSavedPPMPexpenseTotals($record);
			echo $a  . '!~!' . $b  .  '!~!' . $d. $c ;	
		}
	}
	if(isset($_GET['searchValue'])){
		
		$key =  $database->charEncoder($_GET['key']);
		$officeCode = $database->charEncoder($_GET['officeCode']);
		
		if($accountType== 1){
			
			//$sql = "select * from ppmpmain where 
			   $sql = "select a.*,b.Title,c.Locker,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code  left join programcode c on a.ProgramCode = c.Code
			   
			    WHERE
			    officecode = '" . $office . "' and a.category = '" . $key . "' or
			    officecode = '" . $office . "' and description like '%" . $key . "%' or
			    officecode = '" . $office . "' and item like '%" . $key . "%' or
			    officecode = '" . $office . "' and unit like '%" . $key . "%' or
			    officecode = '" . $office . "' and programcode like '%" . $key . "%' or
			    officecode = '" . $office . "' and accountcode like '%" . $key . "%' or
			    officecode = '" . $office . "' and type like '%" . $key . "%' 	
		            order by description asc";
		            
		       
		}else{
		
			$sql = "select a.*,b.Title,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code  left join programcode c on a.ProgramCode = c.Code
				
				 WHERE
			    officecode = '" . $officeCode . "' and a.category = '" . $key . "' or
			    officecode = '" . $officeCode . "' and description like '%" . $key . "%' or
			    officecode = '" . $officeCode . "' and item like '%" . $key . "%' or
			    officecode = '" . $officeCode . "' and unit like '%" . $key . "%' or
			    officecode = '" . $officeCode . "' and programcode like '%" . $key . "%' or
			    officecode = '" . $officeCode . "' and accountcode like '%" . $key . "%' or
			     officecode = '" . $officeCode . "' and type like '%" . $key . "%' 
		            order by description asc";
		}
		
		$record =$database->query($sql);
		
		echo $sheet1->CreateSavedPPMPbyProgram($record);
	}
	if(isset($_GET['searchPPPMPperAccount'])){
		$officeCode = $database->charEncoder($_GET['officeCode']);
		$programCode = $database->charEncoder($_GET['programCode']);
		$type = $database->charEncoder($_GET['type']);
		$code = $database->charEncoder($_GET['code']);
		if($accountType == 1){
			$officeCode = $office;
		}
		//$sql = "select * from ppmpmain where officecode = '" . $officeCode . "' and type = '" . $type . "' and programcode = '" . $programCode . "' and accountcode = '" . $code . "' order by description desc";
		$sql = "select a.*,b.Title from ppmpmain a left join fundtitles b  on a.accountcode = b.code where officecode = '" . $officeCode . "' and programcode = '" . $programCode . "' and type = '" . $type . "'  and accountcode = '" . $code . "'  order by Category asc";
		$record = $database->query($sql);
		
		echo $sheet1->CreateSavedPPMPbyProgram($record);
		
	}
	
// Doctrack-------------------------------------------------------------------------------------------c
	if(isset($_GET['loadPPMPCategoryList'])){
		
		$qtr = $database->charEncoder($_GET['qtr']);
		if($qtr == "opt1st"){
			$sql = "SELECT a.Category, count(a.Id) as Count,b.Description FROM ppmpmain a left join ppmpcategories b on a.Category = b.Code 
					where 
					   OfficeCode = '" . $office . "' and Jan > 0   or
					  OfficeCode = '" . $office . "' and Feb > 0   or
				     	  OfficeCode = '" . $office . "' and Mar > 0    group by Category";
		}else if($qtr == "opt2nd"){
			$sql = "SELECT a.Category, count(a.Id) as Count,b.Description FROM ppmpmain a left join ppmpcategories b on a.Category = b.Code 
					where 
					   OfficeCode = '" . $office . "' and Apr > 0   or
					  OfficeCode = '" . $office . "' and May > 0   or
				     	  OfficeCode = '" . $office . "' and Jun > 0    group by Category";
		}else if($qtr == "opt3rd"){
			$sql = "SELECT a.Category, count(a.Id) as Count,b.Description FROM ppmpmain a left join ppmpcategories b on a.Category = b.Code 
					where 
					   OfficeCode = '" . $office . "' and Jul > 0   or
					  OfficeCode = '" . $office . "' and Aug > 0   or
				     	  OfficeCode = '" . $office . "' and Sep > 0    group by Category";
		}else if($qtr == "opt4th"){
			$sql = "SELECT a.Category, count(a.Id) as Count,b.Description FROM ppmpmain a left join ppmpcategories b on a.Category = b.Code 
					where 
					   OfficeCode = '" . $office . "' and Oct > 0   or
					   OfficeCode = '" . $office . "' and Nov > 0   or
				     	   OfficeCode = '" . $office . "' and Dex > 0    group by Category";
		}
		$record = $database->query($sql);
		echo $sheet1->CreateCategoryList($record);
	}
	if(isset($_GET['GetCategoryItems2018'])){
		$category = $database->charEncoder($_GET['category']);
		$qtr = $database->charEncoder($_GET['qtr']);
		if($qtr == "opt1st"){
			$sql = "SELECT Fund,ProgramCode,Cost,AccountCode,Item,Category ,(IFNULL(Jan, 0) + IFNULL(Feb, 0) + IFNULL(Mar, 0))  as Qty,  Total as Amount, Unit, Description,ItemNo  FROM ppmpmain 
					  where 
					  OfficeCode = '" . $office . "' and Category = '" . $category . "' and Jan > 0   or
					  OfficeCode = '" . $office . "' and Category = '" . $category . "' and Feb > 0   or
				     	  OfficeCode = '" . $office . "' and Category = '" . $category . "' and Mar > 0 order by description asc";
		}else if($qtr == "opt2nd"){
			$sql = "SELECT  Fund,ProgramCode,Cost,AccountCode,Item,Category, (IFNULL(Apr, 0) + IFNULL(May, 0) + IFNULL(Jun, 0))  as Qty, Total as Amount, Unit, Description,ItemNo FROM ppmpmain 
					where 
					   OfficeCode = '" . $office . "' and Category = '" . $category . "' and Apr > 0   or
					  OfficeCode = '" . $office . "' and Category = '" . $category . "' and May > 0   or
				     	  OfficeCode = '" . $office . "' and Category = '" . $category . "' and Jun > 0 order by description asc";
		}else if($qtr == "opt3rd"){
			$sql = "SELECT  Fund,ProgramCode,Cost,AccountCode,Item,Category, (IFNULL(Jul, 0) + IFNULL(Aug, 0) + IFNULL(Sep, 0))  as Qty, Total as Amount, Unit, Description,ItemNo FROM ppmpmain 
					where 
					   OfficeCode = '" . $office . "' and Category = '" . $category . "' and Jul > 0   or
					  OfficeCode = '" . $office . "' and Category = '" . $category . "' and Aug > 0   or
				     	  OfficeCode = '" . $office . "' and Category = '" . $category . "' and Sep > 0 order by description asc";
		}else if($qtr == "opt4th"){
			$sql = "SELECT  Fund,ProgramCode,Cost,AccountCode,Item,Category,(IFNULL(Oct, 0) + IFNULL(Nov, 0) + IFNULL(Dex, 0))  as Qty, Total as Amount, Unit, Description,ItemNo FROM ppmpmain  
					where 
					   OfficeCode = '" . $office . "' and Category = '" . $category . "' and Oct > 0   or
					   OfficeCode = '" . $office . "' and Category = '" . $category . "' and Nov > 0   or
				     	   OfficeCode = '" . $office . "' and Category = '" . $category . "' and Dex > 0 order by description,ItemNo  asc";
		}
		$record = $database->SelectQuery($sql);
		echo $sheet1->CreateCategoryItems2018($record);
		
	}
	



	
	if(isset($_GET['fetchAIRDetails'])) { // Inventory - form AR
		$tn = $database->charEncoder($_GET['tn']);
		
		$sql = "select sum(qty) as Qty, Unit,Description, Amount, sum(Total) as Total,ProgramCode,Code  from porecord  where trackingnumber = '"  . $tn  . "' group by Unit, Description,Amount order by Description,ProgramCode asc";
		$record = $database->query($sql);

		$sql = "select Office,Claimant,PR_Number,PR_Month,PR_CategoryCode,Year,PR_ProgramCode,PR_AccountCode,PO_Number  from vouchercurrent  where trackingnumber = '"  . $tn  . "'";
		$record1 = $database->query($sql);

		$pro = '';
		$progs = array();
		$acc = '';
		$accs = array();
		$i =0;
		while($data = $database->fetch_array($record1)){
			$supplier = $data['Claimant'];
			$prNumber = $data['PR_Number'];
			$category = $data['PR_CategoryCode'];
			$office = $data['Office'];
			$quarter= $database->numberToQuarter($data['PR_Month']) . ' ' . $data['Year'];
			$PO_Number 	= $data['PO_Number'];

			if (empty($PO_Number)) {
				$PO_Number = '';
			}

			$pro = $data['PR_ProgramCode'];
			$progs[$i] = $pro;
			//array_push($progs,$pro); 
			$acc = $data['PR_AccountCode'];
			array_push($accs,$acc); 
			$i++;
		}



		
		$sql = "Select Description from ppmpcategories where code = '" . $category  . "'";
		$record2 = $database->query($sql);
		$data1 = $database->fetch_array($record2);
		$categoryName = $data1['Description'];
		
		$sql = "Select Name from office where code = '" . $office  . "'";
		$record3 = $database->query($sql);
		$data3 = $database->fetch_array($record3);
		$officeName = $data3['Name'];
			
		
		class POdetails {
		     public $trackingNumber;	
		     public $office;
		    
		     public $supplier;	
		     public $prNumber;
		     
		     public $catCode;
		     public $catName;
		     public $quarter;
		     
		     public $programs;
		     public $codes;
		     
		     public $PO_Number;

		     public $qty = array();	
		     public $unit = array();
		     public $desc = array();
		     public $cost = array();
		     public $total = array();
		 }
		
		$p = new POdetails();
		$i = 0;
		
		
		
		while($data = $database->fetch_array($record)){
			$p->qty[$i] = $data['Qty'];
			$p->unit[$i] = $data['Unit'];
			$p->desc[$i] = $data['Description'];
			$p->cost[$i] = number_format($data['Amount'],2);
			$p->total[$i] = number_format($data['Total'],2);
			$i++;
		}
		
		$p->trackingNumber = $tn; 
		$p->office = $officeName; 
		$p->officeCode = $office; 
		
		
		$p->supplier = $supplier;
		$p->prNumber = $prNumber;
		
		$p->catCode = $category;
		$p->catName = $categoryName;
		$p->qua = $quarter;
		
		$p->PO_Number = $PO_Number;
		
		$uniProg =  array_unique($progs);
		$progCom = implode(",", $uniProg);
		$p->programs = $progCom;
		
		$uniAcc =  array_unique($accs);
		$accCom = implode(",", $uniAcc);
		$p->codes = $accCom;
		
		echo  json_encode($p);
	}






	/*---------------------------------------------------------------------------------------- releaser 2018 */
	if(isset($_GET['searchTrackingNumber2018'])){
		
		$key = $database->charEncoder($_GET['trackingNumber']);
		$dbYear = $database->charEncoder($_GET['dbYear']);
		if($dbYear == "2018"){
			$db = "citydoc2018.";
		}else if($dbYear == "2017"){
			$db = "citydoc2017.";
		}else if($dbYear == "2016"){
			$db = "citydoc.";
		}else if($dbYear == "2019"){
			$db = "citydoc2019.";
		}else if($dbYear == "2020"){
			$db = "citydoc2020.";
		}else if($dbYear == "2021"){
			$db = "citydoc2021.";
		}else if($dbYear == "2022"){
			$db = "citydoc2022.";
		}else if($dbYear == "2023"){
			$db = "citydoc2023.";
		}
		
		/*if($dbYear >= 2017){
			$sql = "SELECT b.DateEdited as xxx,a.* FROM " . $db . "vouchercurrent a left join (select TrackingNumber,DateEdited from " . $db . "editlogs where trackingnumber  = '" . $key . "' and  OldValue = '99999') b on a.TrackingNumber = b.TrackingNumber  where 
				a.trackingnumber  = '" . $key . "'  group by  a.trackingnumber";
		}else{
			$sql = "SELECT * FROM " . $db . "vouchercurrent where trackingnumber  = '" . $key . "' group by  trackingnumber";
			
		}*/
		$sql = "SELECT * FROM " . $db . "vouchercurrent where trackingnumber  = '" . $key . "' group by  trackingnumber LIMIT 1";
						
		$record = $database->query($sql);
		$countOne = $database->num_rows($record);
		if($countOne  >= 1){
			
			echo $sheet1->CreateDoctrackInfoPR2018($record,$db);
		}else{
			
			/*if($dbYear > 2017){
				$sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.Description as  CategoryName
								FROM vouchercurrent a 
								left join " . $db . "office b on a.office = b.code  
								left join citydoc.employees c on a.encodedby = c.employeenumber
								left join " . $db . "programcode d on a.PR_ProgramCode = d.code
								left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
								left join ppmpcategories f on a.PR_CategoryCode = f.code where claimant  like  '%" . $key . "%' group by trackingnumber order by id desc limit 40";
			}else if($dbYear == 2017){
				$sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.category_name as  CategoryName
								FROM " . $db . "vouchercurrent a 
								left join " . $db . "office b on a.office = b.code  
								left join citydoc.employees c on a.encodedby = c.employeenumber
								left join " . $db . "programcode d on a.PR_ProgramCode = d.code
								left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
								left join bacdb2017.item_categories f on a.PR_CategoryCode = f.category_key where claimant  like  '%" . $key . "%'  group by trackingnumber order by id desc limit 40";
			}else{
				$sql = "SELECT a.*,a.ClaimType as DocumentType,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.categoryname as  CategoryName
								FROM " . $db . "vouchercurrent a 
								left join " . $db . "office b on a.office = b.code  
								left join citydoc.employees c on a.encodedby = c.employeenumber
								left join " . $db . "programcode d on a.PR_ProgramCode = d.code
								left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
								left join bac.item_categories f on a.PR_CategoryCode = f.categorykey where claimant  like  '%" . $key . "%'  group by trackingnumber order by id desc limit 40";
			}
			
								
			$record = $database->query($sql);
			$countMany = $database->num_rows($record);
			if($countMany == 1){
				echo $sheet1->CreateDoctrackInfoPR2018($record,$db);
			}else if($countMany > 1){
				$ctr =1;
				$prime = 0;
				$id = 1;
				echo $sheet1->CreateListResultPrivate2018($record,0,0,$key,$countMany,$ctr,$id,$prime);	
			}else{
				echo "<div class = 'norecord'> No record found.</div>";
			}*/
		}
		
	}
	// if(isset($_GET['saveControl2018'])){
	// 	$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
	// 	$dbYear = $database->charEncoder($_GET['dbYear']);
	// 	$claimType =  $database->charEncoder($_GET['claimType']);
	// 	$trackingType =  $database->charEncoder($_GET['trackingType']);
	// 	$docType =  $database->charEncoder($_GET['docType']);
		
	// 	$ctrlNo = $database->charEncoder($_GET['ctrlNo']);
	// 	$encoded = $database->charEncoder($_GET['encoded']);
		
	// 	if($dbYear == "2018"  ){
	// 		$db = "citydoc2018.";
	// 		if( strtoupper($claimType) =="CHECK"){
	// 			$completion =  "";
	// 			$status = 'Check Preparation - CTO';
	// 		}else if( strtoupper($claimType) =="WINDOW"){
	// 			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 			$status = 'Forwarded to CTO';
	// 		}else{
	// 			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 			$status = 'CAO Released';
	// 		}
	// 	}else if($dbYear == "2019"){
	// 		$db = "citydoc2019.";
	// 		if( strtoupper($claimType) =="CHECK"){
	// 			$completion =  "";
	// 			$status = 'Check Preparation - CTO';
	// 		}else if( strtoupper($claimType) =="WINDOW"){
	// 			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 			$status = 'Forwarded to CTO';
	// 		}else{
	// 			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 			$status = 'CAO Released';
	// 		}
	// 	}else if($dbYear == "2017"){
	// 		$db = "citydoc2017.";
	// 		$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 		$status = "CAO Released";
	// 	}else if($dbYear == "2016"){
	// 		$db = "citydoc.";
	// 		$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 		$status = "CAO Released";
	// 	}else if($dbYear == "2020"){
	// 		$db = "citydoc2020.";
	// 		if( strtoupper($claimType) =="CHECK"){
	// 			$completion =  "";
	// 			//$status = 'Check Preparation - CTO';
	// 			$status = 'Forwarding Transmittal';
	// 		}else if( strtoupper($claimType) =="WINDOW"){
	// 			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 			//$status = 'Forwarded to CTO';
	// 			$status = 'CAO Released';
	// 		}else{
	// 			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 			$status = 'CAO Released';
	// 		}
	// 		$completion =  "";
	// 		$status = 'Forwarding Transmittal';
	// 	}else if($dbYear == "2021"){
	// 		$db = "citydoc2021.";
	// 		if( strtoupper($claimType) =="CHECK"){
	// 			$completion =  "";
	// 			//$status = 'Check Preparation - CTO';
	// 			$status = 'Forwarding Transmittal';
	// 		}else if( strtoupper($claimType) =="WINDOW"){
	// 			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 			//$status = 'Forwarded to CTO';
	// 			$status = 'CAO Released';
	// 		}else{
	// 			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
	// 			$status = 'CAO Released';
	// 		}
	// 		/*$completion =  "";
	// 		$status = 'Forwarding Transmittal';*/
	// 	}
		
		
		
		
	// 	//$updateCase = " ControlNo = '" . $ctrlNo . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',Completion = '" . $completion . "' ";
	// 	//$database->UpdateTrackingStatus($updateCase,$trackingNumber);
	// 	$sql = "Update " . $db . "vouchercurrent set  ControlNo = '" . $ctrlNo . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',DateReleased = '" . $dateEncoded  . "',Completion = '" . $completion . "'   where TrackingNumber = '" . $trackingNumber . "'";
	// 	$database->query($sql);
		
		
	// 	//$database->UpdateVoucherHistory($trackingNumber);
	// 	$sql = "UPDATE " . $db . "voucherhistory SET " . $database->completion("datemodified") . " where id =  (select maxID from (SELECT MAX(Id)  MaxId FROM " . $db . "voucherhistory where TrackingNumber = '" . $trackingNumber . "') as t)";
	// 	$database->query($sql);
			              
	// 	//$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
	// 	$sql = "Insert into " . $db . "voucherhistory (TrackingNumber,ModifiedBy,DateModified,Status,Completion) values ('" . $trackingNumber . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $completion . "')";
	// 	$database->query($sql);

	// 	$sql = "SELECT * FROM " . $db . "vouchercurrent where trackingnumber  = '" . $trackingNumber . "' group by  trackingnumber";
	// 	$record = $database->query($sql);
	// 	echo $sheet1->CreateDoctrackInfoPR2018($record,$db);
		
	// }

	if(isset($_GET['saveControl2018'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$dbYear = $database->charEncoder($_GET['dbYear']);
		$claimType =  $database->charEncoder($_GET['claimType']);
		$trackingType =  $database->charEncoder($_GET['trackingType']);
		$docType =  $database->charEncoder($_GET['docType']);
		
		$ctrlNo = $database->charEncoder($_GET['ctrlNo']);
		$encoded = $database->charEncoder($_GET['encoded']);
		
		$netAmount = floatval($database->charEncoder($_GET['netAmount']));

		if($dbYear == "2018"  ){
			$db = "citydoc2018.";
			if( strtoupper($claimType) =="CHECK"){
				$completion =  "";
				$status = 'Check Preparation - CTO';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'Forwarded to CTO';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
		}else if($dbYear == "2019"){
			$db = "citydoc2019.";
			if( strtoupper($claimType) =="CHECK"){
				$completion =  "";
				$status = 'Check Preparation - CTO';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'Forwarded to CTO';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
		}else if($dbYear == "2017"){
			$db = "citydoc2017.";
			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
			$status = "CAO Released";
		}else if($dbYear == "2016"){
			$db = "citydoc.";
			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
			$status = "CAO Released";
		}else if($dbYear == "2020"){
			$db = "citydoc2020.";
			if( strtoupper($claimType) =="CHECK"){
				$completion =  "";
				$status = 'Forwarding Transmittal';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
		}else if($dbYear == "2021"){
			$db = "citydoc2021.";
			if( strtoupper($claimType) =="CHECK"){
				$completion =  "";
				$status = 'Forwarding Transmittal';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
		}else if($dbYear == "2022"){
			$db = "citydoc2022.";
			if( strtoupper($claimType) =="CHECK"){
				$completion =  "";
				$status = 'Forwarding Transmittal';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
		}else if($dbYear == "2023"){
			$db = "citydoc2023.";
			if( strtoupper($claimType) =="CHECK"){
				$completion =  "";
				$status = 'Forwarding Transmittal';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
		}

		$error =  $database->compareGrossWithTNandPTRS($db, $dbYear, $trackingNumber, $trackingType, $claimType, $docType);

		if($netAmount == 0) {
			$error = "	<div class='norecord' style='font-size:72px; padding-top:0px;'>Please input Net Amount.</div>";
		}

		if($error == ""){
			$sql = "Update " . $db . "vouchercurrent set  ControlNo = '" . $ctrlNo . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',DateReleased = '" . $dateEncoded  . "',Completion = '" . $completion . "'   where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);

			/*$sql = "UPDATE " . $db . "voucherhistory SET " . $database->completion("datemodified") . " where id =  (select maxID from (SELECT MAX(Id)  MaxId FROM " . $db . "voucherhistory where TrackingNumber = '" . $trackingNumber . "') as t)";
			$database->query($sql);*/
			
			$database->UpdateVoucherHistory($trackingNumber);              
								
			$sql = "Insert into " . $db . "voucherhistory (TrackingNumber,ModifiedBy,DateModified,Status,Completion) values ('" . $trackingNumber . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $completion . "')";
			$database->query($sql);

			$sql = "SELECT * FROM " . $db . "vouchercurrent where trackingnumber  = '" . $trackingNumber . "' group by  trackingnumber";
			$record = $database->query($sql);

			//checking sa document type
			if(substr($docType, 0, 3) == "SLP"){
				$sql = "SELECT TrackingNumber FROM " . $db . "vouchercurrent WHERE BatchTracking = '".$trackingNumber."' GROUP BY TrackingNumber";
				$result = $database->query($sql);

				$where = "";
				while($data = $database->fetch_array($result)){
					// $where .= ",\"".$data['TrackingNumber']."\"";

					$database->UpdateVoucherHistory($data['TrackingNumber']);
					
					$completion = '';
					$database->InsertToVoucherHistoryChild($data['TrackingNumber'],$employeeNumber,$dateEncoded,$status,$completion,1);
				}

				// $sql = "UPDATE " . $db . "vouchercurrent SET Status = '".$status."', DateModified = '".$dateEncoded."', ModifiedBy = '".$employeeNumber."' WHERE TrackingNumber IN(".substr($where, 1).")";
				$sql = "UPDATE " . $db . "vouchercurrent SET Status = '".$status."', DateModified = '".$dateEncoded."', ModifiedBy = '".$employeeNumber."' WHERE BatchTracking = '".$trackingNumber."'";
				$database->query($sql);
				// $database->sendUpdateForSLPBatch($year, $trackingNumber, $status, $dateEncoded);
			}	

			if($docType == 'CASH ADVANCE TO PAYMASTER') {
				echo $database->sendUpdateForPaymasterBatch($dbYear, $trackingNumber);
			}

			echo $sheet1->CreateDoctrackInfoPR2018($record,$db);
		}else{
			echo $error;
		}

	}

	if(isset($_GET['skipAndSave2018'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$claimType =  $database->charEncoder($_GET['claimType']);
		$trackingType =  $database->charEncoder($_GET['trackingType']);
		$encoded = $database->charEncoder($_GET['encoded']);
		$ctrlNo =  $database->charEncoder($_GET['ctrlNo']);
		$dbYear = $database->charEncoder($_GET['dbYear']);
		$docType =  $database->charEncoder($_GET['docType']);

		$netAmount = floatval($database->charEncoder($_GET['netAmount']));
		
		if($dbYear == "2018"){
			$db = "citydoc2018.";
			if( strtoupper($claimType) =="CHECK"){
				$completion =  "";
				$status = 'Check Preparation - CTO';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'Forwarded to CTO';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
		}else if($dbYear == "2017"){
			
			$db = "citydoc2017.";
			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
			$status = 'CAO Released';
		}else if($dbYear == "2016"){
			$db = "citydoc.";
			$completion =  str_replace(" ago","",$database->ezDate1($encoded));
			$status = 'CAO Released';
		}else if($dbYear == "2019"){
			$db = "citydoc2019.";
			if(strtoupper($claimType) =="CHECK"){
				$completion =  "";
				$status = 'Check Preparation - CTO';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'Forwarded to CTO';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
		}else if($dbYear == "2020"){
			$db = "citydoc2020.";
			if(strtoupper($claimType) =="CHECK"){
				$completion =  "";
				//$status = 'Check Preparation - CTO';
				$status = 'Forwarding Transmittal';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				//$status = 'Forwarded to CTO';
				$status = 'CAO Released';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
			//$completion =  "";
			//$status = 'Forwarding Transmittal';
		}else if($dbYear == "2021"){
			$db = "citydoc2021.";
			if(strtoupper($claimType) =="CHECK"){
				$completion =  "";
				//$status = 'Check Preparation - CTO';
				$status = 'Forwarding Transmittal';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				//$status = 'Forwarded to CTO';
				$status = 'CAO Released';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
			//$completion =  "";
			//$status = 'Forwarding Transmittal';
		}else if($dbYear == "2022"){
			$db = "citydoc2022.";
			if(strtoupper($claimType) =="CHECK"){
				$completion =  "";
				//$status = 'Check Preparation - CTO';
				$status = 'Forwarding Transmittal';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				//$status = 'Forwarded to CTO';
				$status = 'CAO Released';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
			//$completion =  "";
			//$status = 'Forwarding Transmittal';
		}else if($dbYear == "2023"){
			$db = "citydoc2023.";
			if(strtoupper($claimType) =="CHECK"){
				$completion =  "";
				//$status = 'Check Preparation - CTO';
				$status = 'Forwarding Transmittal';
			}else if( strtoupper($claimType) =="WINDOW"){
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				//$status = 'Forwarded to CTO';
				$status = 'CAO Released';
			}else{
				$completion =  str_replace(" ago","",$database->ezDate1($encoded));
				$status = 'CAO Released';
			}
			//$completion =  "";
			//$status = 'Forwarding Transmittal';
		}      

		$error =  $database->compareGrossWithTNandPTRS($db, $dbYear, $trackingNumber, $trackingType, $claimType, $docType);

		if($netAmount == 0) {
			$error = "	<div class='norecord' style='font-size:72px; padding-top:0px;'>Please input Net Amount.</div>";
		}

		if($error == ""){
			if($ctrlNo == 0){
				$ctrlNo = 0;
			}else if($ctrlNo == 1){
				$ctrlNo = 1;
			}else{
				$ctrlNo =  $_GET['ctrlNo'] - 1;
			}

			//$updateCase = " ControlNo = '" . $ctrlNo . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',Completion = '" . $completion . "' ";
			//$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$sql = "Update " . $db . "vouchercurrent set ControlNo = '" . $ctrlNo . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',DateReleased = '" . $dateEncoded  . "',Completion = '" . $completion . "'   where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);

			//$database->UpdateVoucherHistory($trackingNumber);
			/*$sql = "UPDATE " . $db . "voucherhistory SET " . $database->completion("datemodified") . " where id =  (select maxID from (SELECT MAX(Id)  MaxId FROM " . $db . "voucherhistory where TrackingNumber = '" . $trackingNumber . "') as t)";
			$database->query($sql);*/
			$database->UpdateVoucherHistory($trackingNumber);              

				
			//$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
			$sql = "Insert into " . $db . "voucherhistory (TrackingNumber,ModifiedBy,DateModified,Status,Completion) values ('" . $trackingNumber . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $completion . "')";
			$database->query($sql);

			if($docType == 'CASH ADVANCE TO PAYMASTER') {
				$database->sendUpdateForPaymasterBatch($dbYear, $trackingNumber);
			}

			$sql = "SELECT * FROM " . $db . "vouchercurrent where trackingnumber  = '" . $trackingNumber . "' group by  trackingnumber";
			$record = $database->query($sql);
			echo $sheet1->CreateDoctrackInfoPR2018($record,$db);
		}else{
			echo $error;
		}
		
	}

	if(isset($_GET['viewHistory2018'])){
		$dbYear = $database->charEncoder($_GET['dbYear']);
		if($dbYear == "2018"){
			$db = "citydoc2018.";
		}else if($dbYear == "2017"){
			$db = "citydoc2017.";
		}else if($dbYear == "2016"){
			$db = "citydoc.";
		}else if($dbYear == "2019"){
			$db = "citydoc2019.";
		}else if($dbYear == "2020"){
			$db = "citydoc2020.";
		}else if($dbYear == "2021"){
			$db = "citydoc2021.";
		}else if($dbYear == "2022"){
			$db = "citydoc2022.";
		}else if($dbYear == "2023"){
			$db = "citydoc2023.";
		}
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$sql = "Select * from " . $db . "voucherhistory where trackingnumber = '" . $trackingNumber . "'";
		$record = $database->query($sql);
		echo $sheet1->CreateHistory2018($record);
	}
	if(isset($_GET['editField2018'])){
		
		$trackingNumber =  $database->charEncoder($_GET['trackingNumber']);
		
		$field = $database->charEncoder($_GET['field']);
		$value = $database->charEncoder(urldecode($_GET['value']));
		$oldValue = $database->charEncoder($_GET['oldValue']);
		$dbYear = $database->charEncoder($_GET['dbYear']);
		if($dbYear == "2018"){
			$db = "citydoc2018.";
		}else if($dbYear == "2017"){
			$db = "citydoc2017.";
		}else if($dbYear == "2016"){
			$db = "citydoc.";
		}else if($dbYear == "2019"){
			$db = "citydoc2019.";
		}else if($dbYear == "2020"){
			$db = "citydoc2020.";
		}else if($dbYear == "2021"){
			$db = "citydoc2021.";
		}else if($dbYear == "2022"){
			$db = "citydoc2022.";
		}else if($dbYear == "2023"){
			$db = "citydoc2023.";
		}
		$state = 1;
		 if($field == "Adv1"){
			
			$sql = "Select * from  " . $db . "vouchercurrent where trackingnumber = '" . $trackingNumber . "' limit 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			
			$fund = $data['Fund'];
			
			//$year = $data['Year'];
			//$record = $database->FetchByAdv($value,$fund,$year); 
			$sql = "SELECT Id,TrackingNumber FROM "  .  $db .  "vouchercurrent where 
					ADV1 = '" . $value . "' and Fund = '" . $fund . "'  
					or 
					ADV2 = '" . $value . "' and Fund = '" . $fund . "' 
					limit 1";
			$record = $database->query($sql);
			
			$count = $database->num_rows($record);
		
			if($count > 0){
				$state = 0;
				$data = $database->fetch_array($record);
				echo '*' . $data['TrackingNumber'];
				
			}else{
				$updateCase = " " . $field  . " = '" . $value . "'";
				//$database->UpdateTrackingStatus($updateCase,$trackingNumber);
				$database->UpdateTrackingStatus2018($updateCase,$trackingNumber,$db);
				$state = 1;
				//$database->EditLogs($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
				if($dbYear >2016){
					$database->EditLogs2018($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded,$db);
				}
			}
		}else{
			
			
			$updateCase = " " . $field  . " = '" . $value . "'";
			$database->UpdateTrackingStatus2018($updateCase,$trackingNumber,$db);
			if($dbYear >2016){
				$database->EditLogs2018($trackingNumber,$field,$oldValue,$value,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded,$db);
			}
			
		}
		
		
		if($state == 1){
			$sql = "SELECT * FROM " . $db . "vouchercurrent where trackingnumber  = '" . $trackingNumber . "' group by  trackingnumber";
			$record = $database->query($sql);
			echo $sheet1->CreateDoctrackInfoPR2018($record,$db);
		}
		
	}
	
	//-------------------------------------------------------------------------------------------------------------  receiver
	
	if(isset($_GET['receive2018'])){
		$trackingNumber =  $database->charEncoder($_GET['trackingNumber']);
		$status = $database->charEncoder($_GET['status']);
		$fund = $database->charEncoder($_GET['fund']);
		$value = trim(intval($database->charEncoder(urldecode($_GET['input']))));
		
		$dbYear = $database->charEncoder($_GET['dbYear']);
		/*if($dbYear == "2018"){
			$db = "citydoc2018.";
		}else if($dbYear == "2017"){
			$db = "citydoc2017.";
		}else if($dbYear == "2016"){
			$db = "citydoc.";
		}*/
		
		
		if($dbYear == "2018"){
			$db = "citydoc2018.";
		}else if($dbYear == "2017"){
			$db = "citydoc2017.";
		}else if($dbYear == "2016"){
			$db = "citydoc.";
		}else if($dbYear == "2019"){
			$db = "citydoc2019.";
		}else if($dbYear == "2020"){
			$db = "citydoc2020.";
		}else if($dbYear == "2021"){
			$db = "citydoc2021.";
		}else if($dbYear == "2022"){
			$db = "citydoc2022.";
		}else if($dbYear == "2023"){
			$db = "citydoc2023.";
		}
		
		
		$updateNa = 0;
		if($value !=0){
			if(strtoupper($status) == "PENDING RELEASED - CAO" || strtoupper($status) == "PENDING RETURNED"){
				$updateNa = 1;	
			}else{
				$sql = "Select TrackingNumber  from " . $db . "vouchercurrent where fund = '" . $fund . "' and Adv1 = '" . $value . "' limit 1";
				$record = $database->query($sql);
				$count = $database->num_rows($record);
				if($count > 0){
					$data =  $database->fetch_array($record);
					echo "<div class = 'norecord' style = 'font-size:38px;color:rgb(86, 145, 94);text-align:center;'>Adv number already exist in : <span style = 'color:grey;'>" . $data['TrackingNumber'] . "</span></div>";
				}else{
					$updateNa = 1;	
				}
			}
		}else{
			$value = '99999';
			$updateNa = 1;	
		}
		if($updateNa == 1){
			
			$status = 'CAO Received';
			if($dbYear == "2016"){
				$status = "CAO on Process";
			}
			$completion =  '';
			
			$sql = "Update " . $db . "vouchercurrent set Adv1 = '" . $value . "',Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "',Completion = '" . $completion . "'   where TrackingNumber = '" . $trackingNumber . "'";
			$database->query($sql);
			
			$sql = "UPDATE " . $db . "voucherhistory SET " . $database->completion("datemodified") . " where id =  (select maxID from (SELECT MAX(Id)  MaxId FROM " . $db . "voucherhistory where TrackingNumber = '" . $trackingNumber . "') as t)";
			$database->query($sql);
		
			$sql = "Insert into " . $db . "voucherhistory (TrackingNumber,ModifiedBy,DateModified,Status,Completion) values ('" . $trackingNumber . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $completion . "')";
			$database->query($sql);
		}
		
		$sql = "SELECT * FROM " . $db . "vouchercurrent where trackingnumber  = '" . $trackingNumber . "' group by  trackingnumber";
		$record = $database->query($sql);
		echo $sheet1->CreateDoctrackInfoPR2018($record,$db);
	}
	if(isset($_GET['loadMore2018'])){
		$dbYear = $database->charEncoder($_GET['dbYear']);
		if($dbYear == "2018"){
			$db = "citydoc2018.";
		}else if($dbYear == "2017"){
			$db = "citydoc2017.";
		}else if($dbYear == "2016"){
			$db = "citydoc.";
		}else if($dbYear == "2019"){
			$db = "citydoc2019.";
		}else if($dbYear == "2020"){
			$db = "citydoc2020.";
		}else if($dbYear == "2021"){
			$db = "citydoc2021.";
		}else if($dbYear == "2022"){
			$db = "citydoc2022.";
		}else if($dbYear == "2023"){
			$db = "citydoc2023.";
		}
		
		$id = $database->charEncoder($_GET['id']);
		$ctr = $database->charEncoder($_GET['ctr']);
		$key = $database->charEncoder($_GET['key']);
		
		$arr = explode('*!*',$key);
		$field = $arr[0];
		$searchValue  = $arr[1];
		
		if($field == "Claimant"){
			
			$condition = "where claimant  like  '%" . $searchValue . "%' and a. id < '"  . $id . "'";
			
			if($dbYear > 2017){
				$sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.Description as  CategoryName
								FROM vouchercurrent a 
								left join " . $db . "office b on a.office = b.code  
								left join citydoc.employees c on a.encodedby = c.employeenumber
								left join " . $db . "programcode d on a.PR_ProgramCode = d.code
								left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
								left join ppmpcategories f on a.PR_CategoryCode = f.code where claimant  like  '%" . $searchValue . "%' group by trackingnumber order by id desc limit 40";
			}else if($dbYear == 2017){
				$sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.category_name as  CategoryName
								FROM " . $db . "vouchercurrent a 
								left join " . $db . "office b on a.office = b.code  
								left join citydoc.employees c on a.encodedby = c.employeenumber
								left join " . $db . "programcode d on a.PR_ProgramCode = d.code
								left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
								left join bacdb2017.item_categories f on a.PR_CategoryCode = f.category_key where claimant  like  '%" . $searchValue . "%'  group by trackingnumber order by id desc limit 40";
			}else{
				$sql = "SELECT a.*,a.ClaimType as DocumentType,b.Name,c.LastName,c.FirstName,c.MiddleName,d.Name as ProgramName,e.Title,f.categoryname as  CategoryName
								FROM " . $db . "vouchercurrent a 
								left join " . $db . "office b on a.office = b.code  
								left join citydoc.employees c on a.encodedby = c.employeenumber
								left join " . $db . "programcode d on a.PR_ProgramCode = d.code
								left join " . $db . "fundtitles e on a.PR_AccountCode = e.Code
								left join bac.item_categories f on a.PR_CategoryCode = f.categorykey where claimant  like  '%" . $searchValue . "%'  group by trackingnumber order by id desc limit 40";
			}
			$record = $database->query($sql);
			$countMany = $database->num_rows($record);
			echo $sheet1->CreateListResultPrivate2018($record,0,0,$searchValue,$countMany,$ctr,$id,1);
		}
	}
	
	
	if(isset($_GET['loadSummary'])){
		if($accountType == 1){
			$sql = "SELECT a.ProgramCode,b.Name,a.Amount as AnnualBudget, c.Amount as Obligated,c.NetLiq as Liquidated, (a.Amount - c.Amount) as Savings, c.Paid,
					(a.Amount - c.Amount) as Balance1, (a.Amount - c.Paid) as Balance2,   (c.Paid - c.NetLiq) as Unliquidated
					FROM 
					(select ProgramCode,sum(if(Amount > 1,Amount,'')) as Amount from funds where  officeCode = '" . $office . "' group by ProgramCode) a
					left join programcode b on a.ProgramCode = b.Code
					left join
					(SELECT PR_ProgramCode, sum(Amount) as Amount, sum(JevAmount) as JevTotal, sum(if(checknumber is null,0,if(TrackingType = 'PO',PO_Amount,Amount))) as Paid, sum(if(JevNo is null,0,NetAmount)) as NetLiq FROM vouchercurrent 
					where obr_number > 0 and status != 'Cancelled'  group by PR_ProgramCode) c
					on a.ProgramCode = c.PR_ProgramCode
					order by a.ProgramCode asc";
					
		}else{
			$sql = "SELECT a.ProgramCode,b.Name,a.Amount as AnnualBudget, c.Amount as Obligated,c.NetLiq as Liquidated, (a.Amount - c.Amount) as Savings, c.Paid,
					(a.Amount - c.Amount) as Balance1, (a.Amount - c.Paid) as Balance2,   (c.Paid - c.NetLiq) as Unliquidated
					FROM 
					(select ProgramCode,sum(if(Amount > 1,Amount,'')) as Amount from funds where ProgramCode = '1011-1'   group by ProgramCode) a
					left join programcode b on a.ProgramCode = b.Code
					left join
					(SELECT PR_ProgramCode, sum(Amount) as Amount, sum(JevAmount) as JevTotal, sum(if(checknumber is null,0,if(TrackingType = 'PO',PO_Amount,Amount))) as Paid, sum(if(JevNo is null,0,NetAmount)) as NetLiq FROM vouchercurrent 
					where 
					obr_number > 0 and status != 'Cancelled'  group by PR_ProgramCode) c
					on a.ProgramCode = c.PR_ProgramCode
					order by a.ProgramCode asc limit 10";
					
		}
		
		$record = $database->query($sql);
		echo $sheet->CreateSummaryBalance($record);		
	}
	if(isset($_GET['selectWhatOffice'])){
		$program = $database->charEncoder($_GET['program']);
		if($program == 'xValx'){
			$sql = "SELECT a.ProgramCode,b.Name,a.Amount as AnnualBudget, c.Amount as Obligated,c.NetLiq as Liquidated, (a.Amount - c.Amount) as Savings, c.Paid,
					(a.Amount - c.Amount) as Balance1, (a.Amount - c.Paid) as Balance2,   (c.Paid - c.NetLiq) as Unliquidated
					FROM 
					(select ProgramCode,sum(if(Amount > 1,Amount,'')) as Amount from funds   group by ProgramCode) a
					left join programcode b on a.ProgramCode = b.Code
					left join
					(SELECT PR_ProgramCode, sum(Amount) as Amount, sum(JevAmount) as JevTotal, sum(if(checknumber is null,0,if(TrackingType = 'PO',PO_Amount,Amount))) as Paid, sum(if(JevNo is null,0,NetAmount)) as NetLiq FROM vouchercurrent 
					where 
					obr_number > 0 and status != 'Cancelled'  group by PR_ProgramCode) c
					on a.ProgramCode = c.PR_ProgramCode
					order by a.ProgramCode asc";
		}else{
			$sql = "SELECT a.ProgramCode,b.Name,a.Amount as AnnualBudget, c.Amount as Obligated,c.NetLiq as Liquidated, (a.Amount - c.Amount) as Savings, c.Paid,
					(a.Amount - c.Amount) as Balance1, (a.Amount - c.Paid) as Balance2,   (c.Paid - c.NetLiq) as Unliquidated
					FROM 
					(select ProgramCode,sum(if(Amount > 1,Amount,'')) as Amount from funds where ProgramCode = '"  . $program . "'   group by ProgramCode) a
					left join programcode b on a.ProgramCode = b.Code
					left join
					(SELECT PR_ProgramCode, sum(Amount) as Amount, sum(JevAmount) as JevTotal, sum(if(checknumber is null,0,if(TrackingType = 'PO',PO_Amount,Amount))) as Paid, sum(if(JevNo is null,0,NetAmount)) as NetLiq FROM vouchercurrent 
					where 
					obr_number > 0 and status != 'Cancelled'  group by PR_ProgramCode) c
					on a.ProgramCode = c.PR_ProgramCode
					order by a.ProgramCode asc ";
		}
		$record = $database->query($sql);
		echo $sheet->CreateSummaryBalanceAccountTable($record);	
	}
	if(isset($_GET['loadSummaryOffice'])){
		
		$sql = "SELECT a.ProgramCode,b.Name,a.Amount as AnnualBudget, c.Amount as Obligated,c.NetLiq as Liquidated, (a.Amount - c.Amount) as Savings, c.Paid,
					(a.Amount - c.Amount) as Balance1, (a.Amount - c.Paid) as Balance2,   (c.Paid - c.NetLiq) as Unliquidated
					FROM 
					(select ProgramCode,sum(if(Amount > 1,Amount,'')) as Amount from funds where  officeCode = '" . $office . "' group by ProgramCode) a
					left join programcode b on a.ProgramCode = b.Code
					left join
					(SELECT PR_ProgramCode, sum(Amount) as Amount, sum(JevAmount) as JevTotal, sum(if(checknumber is null,0,if(TrackingType = 'PO',PO_Amount,Amount))) as Paid, sum(if(JevNo is null,0,NetAmount)) as NetLiq FROM vouchercurrent 
					where obr_number > 0 and status != 'Cancelled'  group by PR_ProgramCode) c
					on a.ProgramCode = c.PR_ProgramCode
					order by a.ProgramCode asc";
		$record = $database->query($sql);
		echo $sheet->CreateSummaryBalance($record);		
	}
	if(isset($_GET['loadBalanceByProgram'])){
		$programCode = $database->charEncoder($_GET['program']);
		
		$periodType = $database->charEncoder($_GET['period']);
		$month = $database->charEncoder($_GET['periodMonth']);
		$day = $database->charEncoder($_GET['periodDay']);
		$year = $database->charEncoder($_GET['periodYear']);
		if($periodType == 2){
			$checkDate = $year . '-' . $month . '-' . $day;
			$searchCondition = " and substr(CheckDate,1,10) = '" . $checkDate . "'" ;	
		}else if($periodType == 3){
			$checkDate = $year . '-' . $month ;
			$searchCondition = " and substr(CheckDate,1,7) = '" . $checkDate . "'" ;
		}else{
			$searchCondition = '';
		}
		$sql = "SELECT a.AccountCode,b.Title,a.Amount as AnnualBudget, c.Amount as Obligated,c.NetLiq as Liquidated, c.Paid,
					(a.Amount - c.Amount) as Balance1, (a.Amount - c.Paid) as Balance2,   (c.Paid - c.NetLiq) as Unliquidated
					FROM 
					(select AccountCode, Amount from funds where Amount > 1 and ProgramCode = '" . $programCode . "' group by AccountCode) a
					left join 
					fundtitles b on a.AccountCode = b.Code
					left join
					(SELECT PR_AccountCode, sum(Amount) as Amount, sum(JevAmount) as JevTotal,sum(if(checknumber is null,0,if(TrackingType = 'PO',PO_Amount,Amount))) as Paid,sum(if(JevNo is null,0,NetAmount)) as NetLiq FROM vouchercurrent 
					where PR_ProgramCode = '" . $programCode . "' 
					and obr_number > 0 and status != 'Cancelled'" . $searchCondition . "
					 group by PR_AccountCode) c
					on a.AccountCode = c.PR_accountCode
					order by b.Title asc";
		$record = $database->query($sql);
		$a =  $sheet->CreateSummaryBalanceAccount($record);
		$sql = "SELECT Id,Adv1,OBR_Number,TrackingType,TrackingNumber,ChargeType,NetAmount,CheckNumber,CheckDate,DocumentType,Claimant,Status,Amount, PO_Amount, TotalAmountMultiple,DateModified 
				FROM vouchercurrent where pr_programcode = '" . $programCode  . "'" . $searchCondition .  "
				group by TrackingNumber order by DateModified Desc;";
		$record = $database->query($sql);
		$b = $sheet->CreatSummaryDetails($record,1);
		
		echo $a . '~!~' . $b;
		
	}
	if(isset($_GET['loadBalanceByProgramOffice'])){
		$programCode = $database->charEncoder($_GET['program']);
		
		$periodType = $database->charEncoder($_GET['period']);
		$month = $database->charEncoder($_GET['periodMonth']);
		$day = $database->charEncoder($_GET['periodDay']);
		$year = $database->charEncoder($_GET['periodYear']);
		if($periodType == 2){
			$checkDate = $year . '-' . $month . '-' . $day;
			$searchCondition = " and substr(CheckDate,1,10) = '" . $checkDate . "'" ;	
		}else if($periodType == 3){
			$checkDate = $year . '-' . $month ;
			$searchCondition = " and substr(CheckDate,1,7) = '" . $checkDate . "'" ;
		}else{
			$searchCondition = '';
		}
		$sql = "SELECT a.AccountCode,b.Title,a.Amount as AnnualBudget, c.Amount as Obligated,c.NetLiq as Liquidated, c.Paid,
					(a.Amount - c.Amount) as Balance1, (a.Amount - c.Paid) as Balance2,   (c.Paid - c.NetLiq) as Unliquidated
					FROM 
					(select AccountCode, Amount from funds where officecode ='" . $office . "'  and Amount > 1 and ProgramCode = '" . $programCode . "' group by AccountCode) a
					left join 
					fundtitles b on a.AccountCode = b.Code
					left join
					(SELECT PR_AccountCode, sum(Amount) as Amount, sum(JevAmount) as JevTotal,sum(if(checknumber is null,0,if(TrackingType = 'PO',PO_Amount,Amount))) as Paid,sum(if(JevNo is null,0,NetAmount)) as NetLiq FROM vouchercurrent 
					where  PR_ProgramCode = '" . $programCode . "' 
					and obr_number > 0 and status != 'Cancelled'" . $searchCondition . "
					 group by PR_AccountCode) c
					on a.AccountCode = c.PR_accountCode
					order by b.Title asc";
		$record = $database->query($sql);
		$a =  $sheet->CreateSummaryBalanceAccount($record);
		
		$sql = "SELECT Id,Adv1,OBR_Number,TrackingType,TrackingNumber,ChargeType,NetAmount,CheckNumber,CheckDate,DocumentType,Claimant,Status,Amount, PO_Amount, TotalAmountMultiple,DateModified 
				FROM vouchercurrent where office = '" . $office . "' and pr_programcode = '" . $programCode  . "'" . $searchCondition .  "
				group by TrackingNumber order by DateModified Desc;";
		
		$record = $database->query($sql);
		$b = $sheet->CreatSummaryDetails($record,1);
		echo $a . '~!~' . $b;
	}
	if(isset($_GET['loadBalanceByAccount'])){
		$programCode = $database->charEncoder($_GET['program']);
		$accountCode = $database->charEncoder($_GET['accountCode']);
		$periodType = $database->charEncoder($_GET['period']);
		$month = $database->charEncoder($_GET['periodMonth']);
		$day = $database->charEncoder($_GET['periodDay']);
		$year = $database->charEncoder($_GET['periodYear']);
		if($periodType == 2){
			$checkDate = $year . '-' . $month . '-' . $day;
			$searchCondition = " and substr(CheckDate,1,10) = '" . $checkDate . "'" ;	
		}else if($periodType == 3){
			$checkDate = $year . '-' . $month ;
			$searchCondition = " and substr(CheckDate,1,7) = '" . $checkDate . "'" ;
		}else{
			$searchCondition = '';
		}
		$sql = "SELECT Id,Adv1,OBR_Number,TrackingType,TrackingNumber,ChargeType,NetAmount,CheckNumber,CheckDate,DocumentType,Claimant,Status,Amount, PO_Amount, TotalAmountMultiple,NetAmount,DateModified 
				FROM vouchercurrent where pr_programcode = '" . $programCode  . "' and PR_AccountCode = '" . $accountCode . "' 
				and obr_number > 0 " . $searchCondition . "
				order by DateModified Desc;";
		$record = $database->query($sql);
		echo $sheet->CreatSummaryDetails($record,2);
	}
	if(isset($_GET['loadBalanceByAccountOffice'])){
		$programCode = $database->charEncoder($_GET['program']);
		$accountCode = $database->charEncoder($_GET['accountCode']);
		$periodType = $database->charEncoder($_GET['period']);
		$month = $database->charEncoder($_GET['periodMonth']);
		$day = $database->charEncoder($_GET['periodDay']);
		$year = $database->charEncoder($_GET['periodYear']);
		if($periodType == 2){
			$checkDate = $year . '-' . $month . '-' . $day;
			$searchCondition = " and substr(CheckDate,1,10) = '" . $checkDate . "'" ;	
		}else if($periodType == 3){
			$checkDate = $year . '-' . $month ;
			$searchCondition = " and substr(CheckDate,1,7) = '" . $checkDate . "'" ;
		}else{
			$searchCondition = '';
		}
		$sql = "SELECT Id,Adv1,OBR_Number,TrackingType,TrackingNumber,ChargeType,NetAmount,CheckNumber,CheckDate,DocumentType,Claimant,Status,Amount, PO_Amount, TotalAmountMultiple,NetAmount,DateModified 
				FROM vouchercurrent where office = '" . $office . "' and pr_programcode = '" . $programCode  . "' and PR_AccountCode = '" . $accountCode . "' 
				and obr_number > 0 " . $searchCondition . "
				order by DateModified Desc;";
		$record = $database->query($sql);
		echo $sheet->CreatSummaryDetails($record,2);
	}

//	----------------------------------------------------------------------------------- liquidation
	if(isset($_GET['saveTrackingLQ'])){
		$cashAdvanceTracking = $database->charEncoder($_GET['caTN']);
		$cashAdvanceAmount = $database->charEncoder($_GET['caAmount']);
		$cashAdvanceRefund = $database->nullToZero($database->charEncoder($_GET['caRefund']));
		$cashAdvanceReim = $database->nullToZero($database->charEncoder($_GET['caReim']));
		$cashAdvanceSpent = $database->charEncoder($_GET['caSpent']);
		$cashAdvanceOR = $database->charEncoder($_GET['or']);
		$cashAdvanceClaimant = $database->charEncoder($_GET['claimant']);
		
		
		$trackType = 'PY';
		$chargeType = 0;
		$fund = "";
		$docType = 'Liquidation';
		$claimType = 'Others';
		
		
		$periodType = "Monthly";
		$periodValue = date('F');
		$status = "Encoded";
		 
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 
		
		//update cash advance partner
		$sql = "Update vouchercurrent  set TrackingPartner = '" . $trackingNumber . "'  where trackingnumber = '" . $cashAdvanceTracking . "'";
		$database->query($sql);
		
		//pagsave sa record
		
		$insertCase = "Insert into vouchercurrent (TrackingPartner,Year,Office,TrackingNumber,TrackingType,Fund,DocumentType,ClaimType,Claimant,Amount,ChargeType,PeriodType,PeriodMonth,EncodedBy,DateEncoded,Status,DateModified)VALUES 
						('" . $cashAdvanceTracking . "','" . $defaultYear . "','" . $office . "','" . $trackingNumber . "','" . $trackType . "','" . $fund . "','" . $docType . "','" . $claimType . "','" . $cashAdvanceClaimant . "','" . $cashAdvanceSpent . "','" . $chargeType . "','"  .   $periodType . "','" . $periodValue . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "')";
		$database->query($insertCase);
		
		
		$sql = "Insert into particulars (trackingnumber)values ('" . $trackingNumber  . "')";
		$database->query($sql);
		
		$sql = "Insert into liquidation (TrackingNumber,CashAdvanceTN,Spent,Refund,Reimbursement,ORdetails)values ('" . $trackingNumber  . "',
				'" . $cashAdvanceTracking . "','" . $cashAdvanceSpent . "','" . $cashAdvanceRefund . "','" . $cashAdvanceReim . "', '" . $cashAdvanceOR . "')";
		$database->query($sql);
		
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~'. $trackingNumber;
		
	}
	if(isset($_GET['editLiquidationAmount'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$orDetails = $database->charEncoder($_GET['or']);
		$cashAdvanceRefund = $database->nullToZero($database->charEncoder($_GET['ref']));
		$cashAdvanceReim = $database->nullToZero($database->charEncoder($_GET['reim']));
		$cashAdvanceSpent =  $database->charEncoder($_GET['spent']);
		$state = 1;
		$sql = "Update vouchercurrent  set Amount = '" . $cashAdvanceSpent . "'  where trackingnumber = '" . $trackingNumber . "'";
		$database->query($sql);
		
	
		$sql = "Update liquidation  set Spent = '" . $cashAdvanceSpent . "', Refund = " . $cashAdvanceRefund  . ",
				 Reimbursement = " . $cashAdvanceReim . ", ORdetails= '" . $orDetails . "'   where trackingnumber = '" . $trackingNumber . "'";
		$database->query($sql);
		
		$database->EditLogs($trackingNumber,'PY',"Liquidation","Liquidation",$_SESSION['officeCode'],$_SESSION['fullName'],$today);
		
		if($state == 1){
			$record = $database->SearchTracking($trackingNumber);
			$count =  $database->num_rows($record);
			if($count > 0){
				echo $sheet->CreateDoctrackInfoPR($record);
			}else{
				echo "<span class = 'remark1'>No record found.</span>";
			}
		}
	}
	if(isset($_GET['loadLiquidated'])){
		
		$acct = $_SESSION['cbo'];
		if($acct == 1){
			$office = $_SESSION['officeCode'];	
			$sql = "select a.*,b.Status as LQstatus from (select Id,TrackingType,TrackingNumber,Status,DateModified,DocumentType,Claimant,Amount,NetAmount,PO_Amount,TotalAmountMultiple,ChargeType,checknumber,checkdate,TrackingPartner,ADV1,OBR_Number,PeriodMonth from citydoc2018.vouchercurrent
						 where 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - PETTY CASH' and status != 'Cancelled' or 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (FOREIGN)' and status != 'Cancelled' or 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (LOCAL)' and status != 'Cancelled' or 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - SPECIAL' and status != 'Cancelled' 
							 	group by trackingnumber
							 	order by datemodified desc
								) a left join 
						    (select TrackingNumber,Status from vouchercurrent
								where 
									office = '" . $office . "' and documenttype = 'Liquidation'  and status != 'Cancelled'
									
								) as b
							on a.TrackingPartner = b.TrackingNumber group by a.TrackingNumber";
		}else{
			$office = $database->charEncoder($_GET['office']);
			if($office == 'all'){
				$sql = "select a.*,b.Status as LQstatus from (select Id,TrackingType,TrackingNumber,Status,DateModified,DocumentType,Claimant,Amount,NetAmount,PO_Amount,TotalAmountMultiple,ChargeType,checknumber,checkdate,TrackingPartner,ADV1,OBR_Number,PeriodMonth from vouchercurrent
						 where 
							 	documenttype = 'CASH ADVANCE - PETTY CASH' and status != 'Cancelled' or 
							 	documenttype = 'CASH ADVANCE - TRAVEL (FOREIGN)' and status != 'Cancelled' or 
							 	documenttype = 'CASH ADVANCE - TRAVEL (LOCAL)' and status != 'Cancelled' or 
							 	documenttype = 'CASH ADVANCE - SPECIAL' and status != 'Cancelled' 
							 
							 	
							 	group by trackingnumber
							 	
							 	order by datemodified desc
								) a left join 
						    (select TrackingNumber,Status from vouchercurrent
								where 
									documenttype = 'Liquidation' and status != 'Cancelled' 
									
								) as b
							on a.TrackingPartner = b.TrackingNumber group by a.TrackingNumber";	 	
			}else{
				
				$sql = "select a.*,b.Status as LQstatus from (select Id,TrackingType,TrackingNumber,Status,DateModified,DocumentType,Claimant,Amount,NetAmount,PO_Amount,TotalAmountMultiple,ChargeType,checknumber,checkdate,TrackingPartner,ADV1,OBR_Number,PeriodMonth from vouchercurrent
						 where 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - PETTY CASH' and status != 'Cancelled' or 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (FOREIGN)' and status != 'Cancelled' or
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (LOCAL)' and status != 'Cancelled' or
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - SPECIAL' and status != 'Cancelled' 
							 	
							 	group by trackingnumber
							 	order by datemodified desc
								) a left join 
						    (select TrackingNumber,Status from vouchercurrent
								where 
									office = '" . $office . "' and documenttype = 'Liquidation'  and status != 'Cancelled'
									
								) as b
							on a.TrackingPartner = b.TrackingNumber group by a.TrackingNumber";	 	
			}
		}

		$record = $database->query($sql);
		echo $sheet->CreateLiquidated($record);
	}
	if(isset($_GET['searchCashAdvanceName'])){
		$name = $database->charEncoder($_GET['name']);
		$acct = $_SESSION['accountType'];
		
		if($acct == 1){
			$office = $_SESSION['officeCode'];
			
			$sql = "select a.*,b.Status as LQstatus from (select Id,TrackingType,Claimant,TrackingNumber,Status,DateModified,DocumentType,Amount,NetAmount,PO_Amount,TotalAmountMultiple,ChargeType,checknumber,checkdate,TrackingPartner,ADV1,OBR_Number,PeriodMonth from vouchercurrent
						 where 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - PETTY CASH' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (FOREIGN)' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (LOCAL)' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - SPECIAL' and status != 'Cancelled' and Claimant like  '%" . $name . "%' 	
							 	
							 	group by trackingnumber
							 	
							 	order by datemodified desc
								) a left join 
						    (select TrackingNumber,Status from vouchercurrent
								where 
									office = '" . $office . "' and documenttype = 'Liquidation' and status != 'Cancelled' 
									
								) as b
							on a.TrackingPartner = b.TrackingNumber";	 
			
			
		}else{
			$office = $database->charEncoder($_GET['office']);
			if($office != 'all'){
				/*$sql = "select a.*,b.Status as LQstatus from (select Id,TrackingType,Claimant,TrackingNumber,Status,DateModified,DocumentType,Amount,NetAmount,PO_Amount,TotalAmountMultiple,ChargeType,checknumber,checkdate,TrackingPartner,ADV1,OBR_Number,PeriodMonth from vouchercurrent
						 where 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or 
							 	office = '" . $office . "' and documenttype = 'ALLOWANCE - TRAVEL' and status != 'Cancelled' and Claimant like  '%" . $name . "%' group by trackingnumber
							 	
							 	order by datemodified desc
								) a left join 
						    (select TrackingNumber,Status from vouchercurrent
								where 
									office = '" . $office . "' and documenttype = 'Liquidation' and status != 'Cancelled' 
									
								) as b
							on a.TrackingPartner = b.TrackingNumber";*/	
				$sql = "select a.*,b.Status as LQstatus from (select Id,TrackingType,Claimant,TrackingNumber,Status,DateModified,DocumentType,Amount,NetAmount,PO_Amount,TotalAmountMultiple,ChargeType,checknumber,checkdate,TrackingPartner,ADV1,OBR_Number,PeriodMonth from vouchercurrent
						 where 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - PETTY CASH' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (FOREIGN)' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (LOCAL)' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - SPECIAL' and status != 'Cancelled' and Claimant like  '%" . $name . "%' 	
							 	
							 	group by trackingnumber
							 	
							 	order by datemodified desc
								) a left join 
						    (select TrackingNumber,Status from vouchercurrent
								where 
									office = '" . $office . "' and documenttype = 'Liquidation' and status != 'Cancelled' 
									
								) as b
							on a.TrackingPartner = b.TrackingNumber"; 
			}else{
				
				$sql = "select a.*,b.Status as LQstatus from (select Id,TrackingType,Claimant,TrackingNumber,Status,DateModified,DocumentType,Amount,NetAmount,PO_Amount,TotalAmountMultiple,ChargeType,checknumber,checkdate,TrackingPartner,ADV1,OBR_Number,PeriodMonth from vouchercurrent
						 where 
							 	documenttype = 'CASH ADVANCE - PETTY CASH' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or 
							 	documenttype = 'CASH ADVANCE - TRAVEL (FOREIGN)' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or
							 	documenttype = 'CASH ADVANCE - TRAVEL (LOCAL)' and status != 'Cancelled' and Claimant like  '%" . $name . "%' or
							 	documenttype = 'CASH ADVANCE - SPECIAL' and status != 'Cancelled' and Claimant like  '%" . $name . "%' 
							 	
							 	group by trackingnumber
							 	
							 	order by datemodified desc
								) a left join 
						    (select TrackingNumber,Status from vouchercurrent
								where 
									documenttype = 'Liquidation' and status != 'Cancelled' 
									
								) as b
							on a.TrackingPartner = b.TrackingNumber";	 	
			}
			
		}
		$record = $database->query($sql);
		echo $sheet->CreateLiquidated($record);
	}
	if(isset($_GET['loadCashAdvanceOffice'])){
		$sql = "select b.* from  (Select Office from vouchercurrent where 
					DocumentType = 'CASH ADVANCE - PETTY CASH' or 
					DocumentType = 'CASH ADVANCE - TRAVEL (FOREIGN)' or
					DocumentType = 'CASH ADVANCE - TRAVEL (LOCAL)' or
					DocumentType = 'CASH ADVANCE - SPECIAL' 
				group by office ) as a left join office b on a.Office =  b.Code order by b.Name asc;";
		$record = $database->query($sql);
		$sheet = '<option></option>';
		while($data = $database->fetch_array($record)){
			$code = $data['Code'];
			$name =  ucwords(strtolower($data['Name']));
			$sheet .= '<option value = "' . $code . '">' .  $name . '</option>';
		}
		$sheet .= '<option value = "all">All Offices</option>';
		echo $sheet;
	}
	if(isset($_GET['loadCashAdvanceOfficeAcct1'])){
		$office = $_SESSION['officeCode'];
		$sql = "select a.*,b.Status as LQstatus from (select Id,TrackingType,TrackingNumber,Status,DateModified,DocumentType,Claimant,Amount,NetAmount,PO_Amount,TotalAmountMultiple,ChargeType,checknumber,checkdate,TrackingPartner,ADV1,OBR_Number,PeriodMonth from vouchercurrent
						 where 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - PETTY CASH' and status != 'Cancelled' or 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (FOREIGN)' and status != 'Cancelled' or 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - TRAVEL (LOCAL)' and status != 'Cancelled' or 
							 	office = '" . $office . "' and documenttype = 'CASH ADVANCE - SPECIAL' and status != 'Cancelled' 
			
							 	group by trackingnumber
							 	order by datemodified desc
								) a left join 
						    (select TrackingNumber,Status from vouchercurrent
								where 
									office = '" . $office . "' and documenttype = 'Liquidation' 
									
								) as b
							on a.TrackingPartner = b.TrackingNumber";
		$record = $database->query($sql);
		echo $sheet->CreateLiquidated($record);
	}

	if(isset($_GET['loadLiquidatedWBrkDwn'])){
		$acct = $_SESSION['cbo'];
	
		if($acct == 1){
			$sql1 = "SELECT c.*, d.Amount as realLqAmount FROM 
					(
					
						(
							SELECT TrackingNumber as caTN, TrackingPartner as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, Amount as caAmount, null as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate 
							FROM vouchercurrent
							WHERE Office = '".$office."' 
							AND Status != 'Cancelled' 
							AND substr(DocumentType, 1, 12) = 'CASH ADVANCE' 
							AND DocumentType != 'CASH ADVANCE TO PAYMASTER'
						)
						UNION
						(
							SELECT TrackingPartner as caTN, TrackingNumber as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, null as caAmount, Amount as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate
							FROM vouchercurrent
							WHERE Office = '".$office."' 
							AND DocumentType = 'Liquidation' 
							AND Status != 'Cancelled' 
						)
					
					) c left join vouchercurrent d on concat(c.lqTN,c.PR_AccountCode) = concat(d.TrackingNumber,d.PR_AccountCode) GROUP BY caTN, lqTN, PR_AccountCode ORDER BY caTN ASC, DocumentType ASC";
		}else{
			$office = $database->charEncoder($_GET['office']);
			if($office == 'all'){
				$sql1 = "SELECT c.*, d.Amount as realLqAmount FROM 
						(
						
							(
								SELECT TrackingNumber as caTN, TrackingPartner as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, Amount as caAmount, null as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate 
								FROM vouchercurrent
								WHERE
								Status != 'Cancelled' 
								AND substr(DocumentType, 1, 12) = 'CASH ADVANCE' 
								AND DocumentType != 'CASH ADVANCE TO PAYMASTER'
							)
							UNION
							(
								SELECT TrackingPartner as caTN, TrackingNumber as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, null as caAmount, Amount as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate
								FROM vouchercurrent
								WHERE
								DocumentType = 'Liquidation' 
								AND Status != 'Cancelled' 
							)
						
						) c left join vouchercurrent d on concat(c.lqTN,c.PR_AccountCode) = concat(d.TrackingNumber,d.PR_AccountCode) GROUP BY caTN, lqTN, PR_AccountCode ORDER BY caTN ASC, DocumentType ASC";

				$office = "";
			}else{
				$sql1 = "SELECT c.*, d.Amount as realLqAmount FROM 
						(
						
							(
								SELECT TrackingNumber as caTN, TrackingPartner as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, Amount as caAmount, null as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate 
								FROM vouchercurrent
								WHERE Office = '".$office."' 
								AND Status != 'Cancelled' 
								AND substr(DocumentType, 1, 12) = 'CASH ADVANCE' 
								AND DocumentType != 'CASH ADVANCE TO PAYMASTER'
							)
							UNION
							(
								SELECT TrackingPartner as caTN, TrackingNumber as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, null as caAmount, Amount as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate
								FROM vouchercurrent
								WHERE Office = '".$office."' 
								AND DocumentType = 'Liquidation' 
								AND Status != 'Cancelled' 
							)
						
						) c left join vouchercurrent d on concat(c.lqTN,c.PR_AccountCode) = concat(d.TrackingNumber,d.PR_AccountCode) GROUP BY caTN, lqTN, PR_AccountCode ORDER BY caTN ASC, DocumentType ASC";

			}
		}

		$record1 = $database->query($sql1);
		$numRows = $database->num_rows($record1);

		if($numRows > 0){
			echo $sheet->CreateLiquidatedWBrkDwn($record1, $office);
		}
		
	}

	if(isset($_GET['searchCashAdvanceNameBrkDwn'])){
		$name = $database->charEncoder($_GET['name']);
		$acct = $_SESSION['accountType'];
		
		if($acct == 1){
			$office = $_SESSION['officeCode'];
			$sql1 = "SELECT c.*, d.Amount as realLqAmount FROM 
					(
					
						(
							SELECT TrackingNumber as caTN, TrackingPartner as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, Amount as caAmount, null as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate 
							FROM vouchercurrent
							WHERE Office = '".$office."' 
							AND Status != 'Cancelled' 
							AND substr(DocumentType, 1, 12) = 'CASH ADVANCE' 
							AND DocumentType != 'CASH ADVANCE TO PAYMASTER'
							AND Claimant LIKE '%".$name."%'
						)
						UNION
						(
							SELECT TrackingPartner as caTN, TrackingNumber as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, null as caAmount, Amount as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate
							FROM vouchercurrent
							WHERE Office = '".$office."' 
							AND DocumentType = 'Liquidation' 
							AND Status != 'Cancelled'
							AND Claimant LIKE '%".$name."%'
						)
					
					) c left join vouchercurrent d on concat(c.lqTN,c.PR_AccountCode) = concat(d.TrackingNumber,d.PR_AccountCode) GROUP BY caTN, lqTN, PR_AccountCode ORDER BY caTN ASC, DocumentType ASC";
			
		}else{
			$office = $database->charEncoder($_GET['office']);
			if($office == 'all'){
				$sql1 = "SELECT c.*, d.Amount as realLqAmount FROM 
						(
						
							(
								SELECT TrackingNumber as caTN, TrackingPartner as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, Amount as caAmount, null as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate 
								FROM vouchercurrent
								WHERE 
								Status != 'Cancelled' 
								AND substr(DocumentType, 1, 12) = 'CASH ADVANCE' 
								AND DocumentType != 'CASH ADVANCE TO PAYMASTER'
								AND Claimant LIKE '%".$name."%'
							)
							UNION
							(
								SELECT TrackingPartner as caTN, TrackingNumber as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, null as caAmount, Amount as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate
								FROM vouchercurrent
								WHERE 
								DocumentType = 'Liquidation' 
								AND Status != 'Cancelled'
								AND Claimant LIKE '%".$name."%'
							)
						
						) c left join vouchercurrent d on concat(c.lqTN,c.PR_AccountCode) = concat(d.TrackingNumber,d.PR_AccountCode) GROUP BY caTN, lqTN, PR_AccountCode ORDER BY caTN ASC, DocumentType ASC";
				$office = "";
			}else{
				$sql1 = "SELECT c.*, d.Amount as realLqAmount FROM 
						 (
						 
							 (
								 SELECT TrackingNumber as caTN, TrackingPartner as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, Amount as caAmount, null as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate 
								 FROM vouchercurrent
								 WHERE Office = '".$office."' 
								 AND Status != 'Cancelled' 
								 AND substr(DocumentType, 1, 12) = 'CASH ADVANCE' 
								 AND DocumentType != 'CASH ADVANCE TO PAYMASTER'
								 AND Claimant LIKE '%".$name."%'
							 )
							 UNION
							 (
								 SELECT TrackingPartner as caTN, TrackingNumber as lqTN, TrackingNumber, TrackingPartner, PR_ProgramCode, PR_AccountCode, null as caAmount, Amount as lqAmount, DocumentType, Claimant, PeriodMonth, ADV1, OBR_Number, Status, NetAmount, checknumber, checkdate
								 FROM vouchercurrent
								 WHERE Office = '".$office."' 
								 AND DocumentType = 'Liquidation' 
								 AND Status != 'Cancelled'
								 AND Claimant LIKE '%".$name."%'
							 )
						 
						 ) c left join vouchercurrent d on concat(c.lqTN,c.PR_AccountCode) = concat(d.TrackingNumber,d.PR_AccountCode) GROUP BY caTN, lqTN, PR_AccountCode ORDER BY caTN ASC, DocumentType ASC";
			}

	

		}
		$record = $database->query($sql1);
		$numRows = $database->num_rows($record);
		if($numRows > 0){
			echo $sheet->CreateLiquidatedWBrkDwn($record, $office);
		}
	}
//-----------------------------------------------------------------
	if(isset($_GET['loadSubCodes'])){
		$sql = "select * from subprogramcode order by description asc";
		$record = $database->query($sql);
		//$sheet = '<option value = "-1"></option>';
		$sheet = '';
		while($data = $database->fetch_array($record)){
			$subCode = $data['SubCode'];
			$desc = $data['Description'];
			$sheet .= '<option value = "' . $subCode . '">' . $desc . '</option>';
		}
		echo $sheet;
	}	
	if(isset($_GET['getSubCodeEditOBR'])){
		$mainCode = $database->charEncoder($_GET['subCode']);
		$sql = "select * from subprogramcode where MainCode = '" . $mainCode . "' order by description asc";
		$record = $database->query($sql);
		
		$count = $database->num_rows($record);
		if($count > 0){
			//$sheet = '<option value = "-1"></option>';
			$sheet = '';
			while($data = $database->fetch_array($record)){
				$subCode = $data['SubCode'];
				$desc = $data['Description'];
				$sheet .= '<option value = "' . $subCode . '">' . $desc . '</option>';
			}
			echo $sheet;
		}else{
			echo '-';
		}
	}	
	if(isset($_GET['searcher'])){
		$text = $database->charEncoder($_GET['text']);
		$sql = "select * from supplier.supplierinfo where Name like '" . $text . "%' order by Name asc limit 20 ";
		$record = $database->query($sql);
		$sheet = '';
		while($data = $database->fetch_array($record)){
			$name  = $data['Name'];
			$sheet .= "<div>" .$name . "</div>";
		}
		echo $sheet;
	}
	if(isset($_GET['loadSupplierAdd'])){
		$sql = "Select * from supplier.supplierinfo order by name asc";
		$record = $database->query($sql);
		$sheet = '<div style = "font-family:Oswald;font-size:26px;letter-spacing:1px;margin-left:15px;background-color:rgb(227, 239, 242);padding-left:10px;border-bottom:1px solid grey;">Select Supplier</div>';
		$sheet .= '<div  style = "height:500px;overflow-x:hidden; overflow-y:auto;font-family:Oswald;width:500px; "><ol >';
		$i =0;
		while($data = $database->fetch_array($record)){
			$name = utf8_encode($data['Name']);
			$sheet .= "<li style = 'color:rgb(0, 164, 201);font-weight:bold; font-size:12px;'> <option class = 'hoverSupplier'  style = 'color:black;padding-left:5px;'  onclick = 'clickSupplier(this)'>" . $name . "</option></li>";
		}
		$sheet .= '</ol></div>';
		echo $sheet;
		
	}



	/********************************************/
	/*                  FORM AR                 */
	/********************************************/
	if (isset($_POST['updateAirItem'])) {
		$item = $database->charEncoder($_POST['AirId']);
		$oldDesc = $database->charEncoder($_POST['oldDesc']);
		$newDesc = $database->charEncoder($_POST['newDesc']);

		$updDesc = $oldDesc."\nReplacement:\n".$newDesc;

		$query = "UPDATE porecord SET Description = '".$updDesc."' WHERE Id = '".$item."'";

		$result = $database->query($query);
		echo 1;
	}
	if (isset($_POST['setInvoiceDetails'])) {
		$tn = $database->charEncoder($_POST['tn']);
		$invs = $database->charEncoder($_POST['invs']);
		$invDate = $database->charEncoder($_POST['invsdate']);
		//update save received by;
		$receivedBy = $database->charEncoder($_POST['receivedBy']);
		$acceptance = $database->charEncoder($_POST['acceptance']);
		$poDate = $database->charEncoder($_POST['poDate']);

		$dateReceived = $database->charEncoder($_POST['dateReceived']);

		$query = "UPDATE particulars SET 
					InvoiceNumber = '".$invs."', 
					InvoiceDate = '".$invDate."', 
					ReceivedBy = '".$receivedBy."', 
					Acceptance = '".$acceptance."', 
					DateAcquired = '".$dateReceived."', 
					PoDate = '".$poDate."' WHERE Trackingnumber = '".$tn."'";

		$result = $database->query($query);
		echo 1;
	}
	if (isset($_GET['fetchPartInv'])) {
		$tn = $database->charEncoder($_GET['tn']);
       
		$query = "SELECT InvoiceNumber, InvoiceDate, ReceivedBy, Acceptance, PoDate, DateAcquired FROM particulars WHERE Trackingnumber = '".$x."'";
		$result = $database->query($query);
		if ($result->num_rows) {
			$sheet = "";
			while ($data = $database->fetch_array($result)) {
				$sheet .= $data['InvoiceNumber']."<!>".$data['InvoiceDate']."<!>".$data['ReceivedBy']."<!>".$data['Acceptance']."<!>".$data['PoDate']."<!>".$data['DateAcquired'];
			};
			echo $sheet;
		} else {
			echo "No record found.";
		}
	}
	if (isset($_GET['getArUploadTypes'])) {
		$query = "SELECT Id, subject FROM inventory.fileclassification";
		$result = $database->query($query);
		if ($result->num_rows) {
			$sheet = "";
			while ($data = $database->fetch_array($result)) {
				$sheet .= "<option value='".$data['Id']."'>".$data['subject']."</option>";
			};
			echo $sheet;
		} else {
			echo "No record found.";
		}
	}
	if (isset($_POST['uploadARFile'])) {
		$trackingnumber = $database->charEncoder($_POST['trackingNumber']);
		$subject = $database->charEncoder($_POST['subject']);
		$year = Date("Y");
		$encodedBy = $_SESSION['employeeNumber'];
		$dateEncoded = Date("Y-m-d h:i:s A");


		$folder = "uploads";
		$file_field = "arFile";

		$path = '../../inventory/'.$folder."/"; 

		$whitelist_ext = array('jpeg','jpg','png','gif');
		$whitelist_type = array('image/jpeg', 'image/jpg', 'image/png','image/gif');

		$out = array('error'=>null);

		$tempName = explode(".", $_FILES[$file_field]['name']);
		if (sizeof($tempName) > 2) {
			$out['error'][] = "Multiple File extensions are not allowed.";
		}

		if (!$path) {
		  $out['error'][] = "Please specify a valid upload path";               
		}

		if (count($out['error'])>0) {
		  return $out;
		}

		if((!empty($_FILES[$file_field])) && ($_FILES[$file_field]['error'] == 0)) {

			$file_info = pathinfo($_FILES[$file_field]['name']);
			$name = $file_info['filename'];
			$ext = $file_info['extension'];

			if (!in_array($ext, $whitelist_ext)) {
			  $out['error'][] = "Invalid file Extension";
			}

			if (!in_array($_FILES[$file_field]["type"], $whitelist_type)) {
			  $out['error'][] = "Invalid file Type";
			}
		}

		if (sizeof($out['error']) > 0) {
			echo implode(", ", $out['error']);
		} else {
			$filename = $subject."~".$year."~".$trackingnumber.".".pathinfo($_FILES[$file_field]['name'], PATHINFO_EXTENSION);
			$query = "INSERT INTO inventory.fileupload (Year, Trackingnumber, Classification, Filename, UploadBy, DateUploaded) 
						VALUES 
						('".$year."','".$trackingnumber."','".$subject."','".$filename."','".$encodedBy."','".$dateEncoded."')";

			$result = $database->query($query);
			$saveFile = move_uploaded_file($_FILES[$file_field]['tmp_name'], $path.$filename);
			echo 1;
		}
	}
	if (isset($_GET['loadPPMPlockOffice'])){
		$type = $database->charEncoder($_GET['type']);
		if($type == 1){
			$sql = "Select * from office order by Name asc";
		}else if($type == 2){
			$sql = "Select * from office where ppmp = 1 order by Name asc";
		}else if($type == 3){
			$sql = "Select * from office where ppmp = 0 order by Name asc";
		}
		$record = $database->query($sql);
		echo $sheet->CreateLockItems($record);
	}
	if (isset($_GET['loadPPMPlockFund'])){
		$type = $database->charEncoder($_GET['type']);
		$field = $database->charEncoder($_GET['field']);
		
		if($type == 1){
			$sql = "Select * from programcode order by " . $field . " asc";
		}else if($type == 2){
			$sql = "Select * from programcode where Locker = 1 order by " . $field . " asc";
		}else if($type == 3){
			$sql = "Select * from programcode where Locker = 0 order by " . $field . " asc";
		}
		$record = $database->query($sql);
		echo $sheet->CreateLockFunds($record);
	}
	
	if (isset($_GET['lockThis'])){
		$ppmp = $database->charEncoder($_GET['ppmp']);
		$code = $database->charEncoder($_GET['code']);
		
		$sql = "Update office set PPMP = " . $ppmp . " where code = '" . $code . "'";
		$record = $database->query($sql);
		echo $sql;
	}
	if (isset($_GET['lockThisFund'])){
		$lock = $database->charEncoder($_GET['lock']);
		$code = $database->charEncoder($_GET['code']);
		
		$sql = "Update programcode set Locker = " . $lock . " where code = '" . $code . "'";
		$record = $database->query($sql);
		echo $sql;
	}
	if(isset($_GET['loadItemsByCat'])){
		$idPR = $database->charEncoder($_GET['id']);
		$cat = $database->charEncoder($_GET['cat']);
		$sql = "Select * from ppmpitems where CategoryCode = '" . $cat . "' order by Description asc";
		$record = $database->query($sql);
		$sheet = '<div style = "font-family:Oswald;font-size:24px;letter-spacing:1px;margin-left:0px;background-color:rgb(227, 239, 242);padding-left:10px;border-bottom:1px solid grey;">Select from<span style = "font-weight:bold;color:rgb(20, 166, 234);"> ' . $cat . ' </span> items.</div>';
		/*$sheet .= '<div  style = "height:600px;overflow-x:hidden; overflow-y:auto;font-family:Oswald;width:1500px; "><ol >';
		$i =0;
		while($data = $database->fetch_array($record)){
			$id = $data['Id'];
			$name = utf8_encode($data['Description']);
			$sheet .= "<li style = 'color:rgb(0, 164, 201);font-weight:bold;font-size:12px; '> 
					   <option class = 'hoverSupplier'  style = 'color:black;padding-left:5px;font-size:12px;' id = '" . $idPR . "' value ='" . $id . "'  onclick = 'clickPPMPItem(this)'>" . $name . "</option></li>";
		}
		$sheet .= '</ol></div>';*/
		$sheet .= '<div  style = "height:600px;overflow-x:hidden; overflow-y:auto;font-family:Oswald;width:920px;">';
		$sheet .= "<table id  = 'prItemEdit' border ='0' style = 'width:100%;'>";
		$i =1;
		while($data = $database->fetch_array($record)){
			$id = $data['Id'];
			$name = utf8_encode($data['Description']);
			$sheet .= "<tr>";
			$sheet .= "<td style = 'text-align:right;vertical-align:top;padding:2px 0px;padding-right:5px;font-size:14px;width:1%;background-color:white;'>" . $i++ . "</td>
						<td class = 'hoverSupplier'  style = 'color:black;font-size:13px;padding:2px;' id = '" . $idPR . '!' . $id . "'  onclick = 'clickPPMPItem(this)'>" . $name . "</td>";
			$sheet .= "</tr>";
		}
		$sheet .= "</table>";
		$sheet .= '</div>';
		
		echo $sheet;
	}
	if(isset($_GET['fetchRecoDetails'])){
		$tn = $database->charEncoder($_GET['tn']);
		if(substr($tn,0,2) == "PR"){
			// $sql = "select Id,sum(qty) as Qty, Unit,Description, Amount, sum(Total) as Total,ProgramCode,Code  from prrecord  where trackingnumber = '"  . $tn  . "' group by Unit, Description,Amount order by Description,ProgramCode asc";
			$sql = "select a.Id,sum(a.qty) as Qty, a.Unit,a.Description, a.Amount, sum(a.Total) as Total,a.ProgramCode,a.Code, b.DateCanvassed, b.Description as ppmpDesc  from prrecord a 
					left join ppmpitems b on a.Item = b.Id and a.Category = b.CategoryCode 
					where a.trackingnumber = '"  . $tn  . "' group by a.Unit, a.Description,a.Amount order by a.Description,a.ProgramCode asc";
			$record = $database->query($sql);
		}else{
			$sql = "select Id,sum(qty) as Qty, Unit,Description, Amount, sum(Total) as Total,ProgramCode,Code  from porecord  where trackingnumber = '"  . $tn  . "' group by Unit, Description,Amount order by Description,ProgramCode asc";
			//$sql = "select sum(qty) as Qty, Unit,Description, sum(Amount) as Amount, sum(Total) as Total,ProgramCode,Code  from porecord  where trackingnumber = '"  . $tn  . "' group by Unit, Description order by Description,ProgramCode asc";
			$record = $database->query($sql);
		}
		
		
		$sql = "select a.Office,a.Claimant,a.PR_Number,a.PR_Month,a.PR_CategoryCode,a.Year,a.PR_ProgramCode,a.PR_AccountCode,a.PO_Number,b.Particulars 
				from vouchercurrent a
				left join particulars b on a.TrackingNumber = b.TrackingNumber
				where a.trackingnumber = '"  . $tn  . "'";
		$record1 = $database->query($sql);
		//$data = $database->fetch_array($record1);
		$pro = '';
		$progs = array();
		$acc = '';
		$accs = array();
		$i =0;
		while($data = $database->fetch_array($record1)){
			$supplier = $data['Claimant'];
			$prNumber = $data['PR_Number'];
			$category = $data['PR_CategoryCode'];
			$poNumber = $data['PO_Number'];
			
			$office = $data['Office'];
			$quarter= $database->numberToQuarter($data['PR_Month']) . ' ' . $data['Year'];
			
			$pro = $data['PR_ProgramCode'];
			$progs[$i] = $pro;
			//array_push($progs,$pro); 
			$acc = $data['PR_AccountCode'];
			array_push($accs,$acc); 

			$purpose = $data['Particulars'] ? $data['Particulars'] : "";

			$i++;
		}
		
		$sql = "Select Description from ppmpcategories where code = '" . $category  . "'";
		$record2 = $database->query($sql);
		$data1 = $database->fetch_array($record2);
		$categoryName = $data1['Description'];
		
		$sql = "Select Name from office where code = '" . $office  . "'";
		$record3 = $database->query($sql);
		$data3 = $database->fetch_array($record3);
		$officeName = $data3['Name'];
			
		
		class POdetails {
		     public $trackingNumber;	
		     public $office;
		    
		     public $supplier;	
		     public $prNumber;
		     
		     public $catCode;
		     public $catName;
		     public $quarter;
		     
		     public $programs;
		     public $codes;
		     public $poNumber;
		     
		     public $qty = array();	
		     public $unit = array();
		     public $desc = array();
		     public $cost = array();
		     public $total = array();
		     public $poId = array();   

		     public $dateCanvassed = array();
		     public $ppmpDesc = array();

		     public $purpose;
		 }		
		$p = new POdetails();
		$i = 0;
		while($data = $database->fetch_array($record)){
			$p->qty[$i] = $data['Qty'];
			$p->unit[$i] = $data['Unit'];
			$p->desc[$i] = $data['Description'];
			$p->cost[$i] = number_format($data['Amount'],2);
			$p->total[$i] = number_format($data['Total'],2);
			$p->poId[$i] = $data['Id'];
			$p->dateCanvassed[$i] = $data['DateCanvassed'] ? $data['DateCanvassed'] : "";
			$p->ppmpDesc[$i] = $data['ppmpDesc'];
			$i++;
		}
		
		$p->trackingNumber = $tn; 
		$p->office = $officeName; 
		$p->officeCode = $office; 
		
		
		$p->supplier = $supplier;
		$p->prNumber = $prNumber;
		$p->poNumber = $poNumber;
		
		
		$p->catCode = $category;
		$p->catName = $categoryName;
		$p->qua = $quarter;
		
		
		
		$uniProg =  array_unique($progs);
		$progCom = implode(",", $uniProg);
		$p->programs = $progCom;
		
		$uniAcc =  array_unique($accs);
		$accCom = implode(",", $uniAcc);
		$p->codes = $accCom;
		$p->purpose = $purpose;
		
		echo  json_encode($p);
	}

	if (isset($_GET['savePrPurpose'])) {
		$tn = $database->charEncoder($_GET['tn']);
		$purpose = $database->charEncoder($_GET['purpose']);
		
		$sql = "UPDATE particulars SET Particulars = '".$purpose."' WHERE TrackingNumber = '".$tn."'";
		$result = $database->query($sql);
	}
	if (isset($_GET['deleteThisSelectedRow'])) {
		$id = $database->charEncoder($_GET['id']);
		$item = $database->charEncoder($_GET['item']);
		
		$sql = "delete from ppmpitems  WHERE Id = '" . $id . "'";
		$database->query($sql);
		
		$database->EditLogs($id,'Item Management',"Deleted",$item,$_SESSION['officeCode'],$_SESSION['fullName'],$today);
		
	}
	
	
	if(isset($_GET['getAttachments'])){
		$record = $database->SearchAttachments();
		echo $sheet->CreateAttachment($record);
	}
	if(isset($_GET['deleteAttachments'])){
		
		$id =  $database->charEncoder($_GET['id']);
		$text =  $database->charEncoder($_GET['text']);
		$filename = $database->charEncoder($_GET['filename']);
		$encodedBy = $_SESSION['employeeNumber'];
		$sql = "Delete from posting.information where id  = '" . $id . "'";
		$database->query($sql);
		
		$path = '../../attachments/' . $filename;
		unlink($path);
		
		$sql = "Insert into posting.logs (Action,Value,EditedBy,DateModified) VALUE ('Deleted','" . $text . "','" . $encodedBy . "','" . $dateEncoded . "')";
		$database->query($sql);
		
		$record = $database->SearchAttachments();
		echo $sheet->CreateAttachment($record);
	}
	if(isset($_GET['loadMoreAttach'])){
		$lim = 10;
		$id = $database->charEncoder($_GET['id']);
		$accountType =  $_SESSION['accountType'];
		$officeCode =  $_SESSION['officeCode'];
		if($accountType > 1 || $officeCode == '1081'){
			$sql = "select a.*,b.Name,c.Name as ReceiverName 
				from posting.information a 
				left join office b on a.Sender  = b.Code 
				left join office c on a.Receiver  = c.Code 
				where a.Id < '" . $id .  "'
				order by a.id desc limit " . $lim;
		}else{
			$sql = "select a.*,b.Name,c.Name as ReceiverName 
				from posting.information a 
				left join office b on a.Sender  = b.Code 
				left join office c on a.Receiver  = c.Code 
				WHERE (Sender  = '" . $officeCode . "' || Receiver = '" . $officeCode . "' || Receiver = 'All') and  a.Id < '" . $id .  "'
				order by a.id desc limit " . $lim;
		}
		
		$record =  $database->query($sql);
		echo $sheet->CreateAttachment($record);
	}
	if(isset($_GET['publicSearchAdviser'])){
		$key = $database->charEncoder($_GET['searchKey']);

		$num =  (int)($key);
		if($num > 0 ){
			$sql = "
				(select *, 2020 as Year from citydoc2020.adviceinfo where checknumber = '"  . $key . "') 
				union
				(select *, 2019 as Year from citydoc2019.adviceinfo where checknumber = '"  . $key . "') 
				union
				(select *, 2018 as Year from citydoc2018.adviceinfo where checknumber = '"  . $key . "') 
				union
				(select *, 2017 as Year from citydoc2017.adviceinfo where checknumber = '"  . $key . "') 
				
				";
			$record = $database->query($sql);
			
			$count = $database->num_rows($record);
			if($count > 0 ){
				echo $sheet->CreateAdviserInfo($record);
			}else{ //adv
				$sql = "(select *, 2020 as Year from citydoc2020.adviceinfo where Adv1 = '"  . $key . "' or Adv2 = '"  . $key . "') 
						union	
						(select *, 2019 as Year from citydoc2019.adviceinfo where Adv1 = '"  . $key . "' or Adv2 = '"  . $key . "')
						union
						(select *, 2018 as Year from citydoc2018.adviceinfo where Adv1 = '"  . $key . "' or Adv2 = '"  . $key . "') 
						union
						(select *, 2017 as Year from citydoc2017.adviceinfo where Adv1 = '"  . $key . "' or Adv2 = '"  . $key . "') 
						
						
						";
				$record = $database->query($sql);
				$count = $database->num_rows($record);
				if($count > 0 ){
					echo $sheet->CreateAdviserInfo($record);
				}else{
					echo "<div class = 'wiggle' style = 'font-family:Oswald;font-size:42px;margin-top:20px;text-align:center;color:white;font-weight:bold;' >No record found.</div>";
				}
			}
		}else{
			/*$sql = "(select *, 2019 as Year from citydoc2019.adviceinfo where Claimant like '%"  . $key . "%')
					union 
					(select *, 2018 as Year from citydoc2018.adviceinfo where Claimant like '%"  . $key . "%')
					union
					(select *, 2017 as Year from citydoc2017.adviceinfo where Claimant like '%"  . $key . "%')
					";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			if($count > 0 ){
				echo $sheet->CreateAdviserInfo($record);
			}else{
				echo "<div class = 'wiggle' style = 'font-family:Oswald;font-size:42px;margin-top:20px;text-align:center;color:white;font-weight:bold;' >No record found.</div>";
			}*/
			echo "<div class = 'wiggle' style = 'font-family:Oswald;font-size:42px;margin-top:20px;text-align:center;color:white;font-weight:bold;' >Numbers only.</div>";
		}
	}
	if(isset($_GET['adviseBatch'])){
		$id =  $database->charEncoder($_GET['adviceId']);
		$year = $database->charEncoder($_GET['year']);
		$sql = "Select *, "  .  $year . " as Year from citydoc" . $year . ".adviceinfo where adviceid = '" . $id . "' order by checknumber asc";
		$record = $database->query($sql);
		echo $sheet->CreateAdviserInfo($record);
	}
	if(isset($_GET['getPPMPbyFund'])){
		$accountType = $_SESSION['accountType'];
		$officeCode = $database->charEncoder($_GET['officeCode']);
		$program = $database->charEncoder($_GET['programCode']);
		$type = $database->charEncoder($_GET['type']);
		$fund = $database->charEncoder($_GET['fund']);
		
		if($program){
			$pg = " = '" . $program . "' ";
			
		}else{
			$pg = " != 0 ";
		}
		
		if($accountType == 1){
			if($fund == "All"){
				$sql = "select a.*,b.Title,c.Locker,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code 
						left join programcode c on a.ProgramCode = c.Code
						 where officecode = '" . $office . "' and programcode  " . $pg . " and Type = '" . $type . "'  order by Category asc";				
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $office . "'  and  programcode " . $pg . " and Type = '" . $type . "' group by programcode";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $office . "' and programcode " . $pg . " and Type = '" . $type . "' group by accountcode";
			}else{
			
				$sql = "select a.*,b.Title,c.Locker,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code 
						left join programcode c on a.ProgramCode = c.Code
						 where officecode = '" . $office . "' and programcode = '" . $program . "' and Type = '" . $type . "' and a.Fund = '" . $fund .  "' order by Category asc";
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $office . "'  and  programcode = '" . $program . "' and Type = '" . $type . "' and Fund = '" . $fund .  "'";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $office . "' and programcode = '" . $program . "' and Type = '" . $type . "' and Fund = '" . $fund .  "' group by accountcode";
			}
			$officeCode = $office;
		}else{
			if($fund == "All"){
				$sql = "select a.*,b.Title,c.Locker,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code 
						left join programcode c on a.ProgramCode = c.Code
						where officecode = '" . $officeCode . "' and programcode " . $pg . " and Type = '" . $type . "'  order by Category asc";
						 				
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $officeCode . "'  and  programcode  " . $pg . " and Type = '" . $type . "' group by programcode";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $officeCode . "' and programcode  " . $pg . " and Type = '" . $type . "' group by accountcode";
			}else{
			
				$sql = "select a.*,b.Title,c.Locker,c.Name from ppmpmain a left join fundtitles b  on a.accountcode = b.code 
						left join programcode c on a.ProgramCode = c.Code
						 where officecode = '" . $officeCode . "' and programcode  " . $pg . " and Type = '" . $type . "' and a.Fund = '" . $fund .  "' order by Category asc";
				$sql1 = "select ProgramCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $officeCode . "'  and  programcode = '" . $program . "' and Type = '" . $type . "' and Fund = '" . $fund .  "'";
				$sql2 = "select AccountCode,sum(Total) as GrandTotal from ppmpmain where officecode = '" . $officeCode . "' and programcode = '" . $program . "' and Type = '" . $type . "' and Fund = '" . $fund .  "' group by accountcode";
			}
		}

		$record = $database->query($sql);
		$a =  $sheet1->CreateSavedPPMPbyProgram($record);
		
		$record = $database->query($sql1);
		$b = $sheet1->CreateSavedPPMPTotals($record,$officeCode,$type);
		
		$record = $database->query($sql2);
		$c = $sheet1->CreateSavedPPMPexpenseTotals($record);
		
		echo $a . '!~!' . $c . $b;
	}
	if(isset($_GET['generateItemSelect'])){
		$category = $database->charEncoder($_GET['category']);
		
		/*if($category == "CAT 100"){
			$sql = "select *, Code as CategoryCode,Name as Description, '' as PurchasedUnit, '' as EstimatedPrice from programcode where substr(code,1,2) = '" . substr($year,0,2) . "'";
			echo $sql;
		}else{
			$sql = "select * from $dbasePPMPItems.ppmpitems where categorycode = '" . $category . "' order by description asc";
		}*/
		$sql = "select * from $dbasePPMPItems.ppmpitems where categorycode = '" . $category . "' order by description asc";
		$record  = $database->query($sql); 
		
		$sql2 = "select * from $dbasePPMPItems.ppmpcategories where code = '" . $category . "' limit 1";
		$record1  = $database->query($sql2); 
		
		$data = $database->fetch_array($record1);
		$catDes = $data['Description'];
		$catName = $category . " - " . $catDes;

		echo $sheet->CreatePPMPItemSelect($record,$catName,$catDes,$year);
	}
	if(isset($_GET['sendSMS'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$sendPublic = $database->publicSender($trackingNumber,$year);
		if($sendPublic == 0){
			$database->sender($trackingNumber);
		}
	}
	if(isset($_GET['sendSMSAlways'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$database->senderNotifyReleasedPayroll($trackingNumber);
	}
	if(isset($_GET['jkytafiwTY'])){
		
		$crypt = $database->charEncoder($_GET['kksduh']);
		$arr = explode('!@!', $crypt);
		$control =  $arr[0];
		$numbers = $database->vArrange1($arr[1]);
		$statuses = $arr[2]; 
		
		$_SESSION['smsControl'] = $arr[0];
		$_SESSION['smsStatuses'] = $statuses;
		$_SESSION['smsNumbers'] = $numbers;
		
		$office = $_SESSION['officeCode'];
		$sql = "select Id from citydoc.sms where office = '" . $office . "' and EmployeeNumber = '" . $employeeNumber . "' limit  1";
		$record = $database->query($sql);
		$count = $database->num_rows($record);
		if($count > 0){
			$sql = "Update  citydoc.sms set Office = '" . $office . "', EmployeeNumber = '" . $employeeNumber . "', Numbers = '" . $numbers . "', Statuses = '" . $statuses . "',
											  Control = '" . $control . "',DateUpdated = '" .  $dateEncoded . "'  where Office = '" . $office . "' and EmployeeNumber  = '" . $employeeNumber . "'";
			$database->query($sql);
		}else{
			$sql = "INSERT INTO citydoc.sms (Office,EmployeeNumber,Numbers, Statuses,Control, DateUpdated) VALUES('" . $office . "', '" . $employeeNumber .  "','" . $numbers . "', '" . $statuses . "', '" . $control . "','" . $dateEncoded . "')";
			$database->query($sql);
		}
	}
	if(isset($_GET['getSMSsetup'])){
		$office = $_SESSION['officeCode'];
		$sql = "select * from citydoc.sms where Office = '" .  $office . "' and EmployeeNumber = '" . $employeeNumber . "'";
		$record = $database->query($sql);
		$count  = $database->num_rows($record);
		if($count > 0){
			$data = $database->fetch_array($record);
			$numbers = $data['Numbers'];
			$statuses = $data['Statuses'];
			$control = $data['Control'];
			echo $numbers . '*' . $statuses . '*' . $control;
		}else{
			echo '';
		}
	}
	if(isset($_GET['searchPPMPitems'])){
		$key = $database->charEncoder($_GET['keyword']);
		$sql = "select * from $dbasePPMPItems.ppmpitems where Id = '" . $key . "' || description like '%" . $key . "%' order by description";
		$record  = $database->query($sql); 
		echo $sheet->CreatePPMPItemSelect1($record);
		
	}
	
	if(isset($_GET['fetchSupplierAddress'])){
		$supplier = $database->charEncoder($_GET['supplier']);
		$sql = "select Address from supplier.supplierinfo where Name like  '%" . addslashes($supplier) . "%' limit 1";
		$record = $database->query($sql);
		if($database->num_rows($record) > 0){
			$data = $database->fetch_array($record);
			echo $data['Address'];
		}else{
			echo "&nbsp;";
		}
	}

	if(isset($_GET['updateOBRParticulars'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$particulars = $database->charEncoder(urldecode($_GET['obrparticulars']));

		$sql = "update particulars set OBRParticulars = '" . $particulars . "' where trackingnumber = '" . $trackingNumber . "'";
		$database->query($sql);
		
		$database->EditLogs($trackingNumber,"OBRParticulars","A" , trim($particulars),$_SESSION['officeCode'], $_SESSION['fullName'],$dateEncoded);	
		echo 1;
	}


	/********************************************/
	/*             RETENTION - START            */
	/********************************************/
	if(isset($_GET['getPODetailsForRET'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		$dntChk = 0;
		if(isset($_GET['dntChk'])){
			$dntChk = 1;
		}

		if($_SESSION['perm'] == 34) {
			$sql = "SELECT a.Claimant,a.PO_Number, a.PO_Amount, a.TotalAmountMultiple, a.Status, a.checknumber, a.checkdate, a.TrackingType, a.TrackingPartner, a.TrackingNumber, b.InvoiceNumber, b.InvoiceDate
				FROM ".$db."vouchercurrent a 
				left join ".$db."particulars b on a.TrackingNumber = b.TrackingNumber
				where a.TrackingNumber = '".$trackingNumber."' group by a.TrackingNumber";
		}else{
			$sql = "SELECT a.Claimant,a.PO_Number, a.PO_Amount, a.TotalAmountMultiple, a.Status, a.checknumber, a.checkdate, a.TrackingType, a.TrackingPartner, a.TrackingNumber, b.InvoiceNumber, b.InvoiceDate
				FROM ".$db."vouchercurrent a 
				left join ".$db."particulars b on a.TrackingNumber = b.TrackingNumber
				where a.TrackingNumber = '".$trackingNumber."' and a.Office = '".$_SESSION['cbo']."' group by a.TrackingNumber";
		}
		
		$record = $database->query($sql);

		$err = [];
		$res = [];


		if($database->num_rows($record) == 0){
			array_push($err, "Not found.");
		}else{
			$data = $database->fetch_array($record);
			if($data['TrackingType'] != "PO"){
				array_push($err, "Please use PO Tracking No.");
			}else{
				// if($data['Status'] != "Check Released"){
				// 	array_push($err, "Status should be check released.");
				// }
				if($data['Status'] != "For Payment"){
					array_push($err, "PO should be for payment.");
				}
				// if($data['checknumber'] == "" || $data['checkdate'] == ""){
				// 	array_push($err, "Incomplete Check details");
				// }
				if($data['TrackingPartner'] != "" && $dntChk == 0){
					$chkSql = "select TrackingNumber, Status from ".$db."vouchercurrent where TrackingNumber = '".$data['TrackingPartner']."' limit 1";
					$chkRec = $database->query($chkSql);
					$chkData = $database->fetch_array($chkRec);
					if($chkData['Status'] != "Cancelled"){
						array_push($err, "Retention already created in : ".$data['TrackingPartner']);
					}
				}
			}
		}

		if(sizeof($err) > 0){
			echo json_encode([$err, 0]);
		}else{
			$res[0] = $data['InvoiceNumber'];
			$res[1] = $data['InvoiceDate'];
			if($data['TotalAmountMultiple'] > 0){
				$res[2] = $data['TotalAmountMultiple'];
			}else{
				$res[2] = $data['PO_Amount'];
			}
			$res[3] = $data['PO_Number'];
			$res[4] = $data['TrackingNumber'];
			$res[5] = $data['Claimant'];

			echo json_encode([$res, 1]);
		}
	}

	if(isset($_GET['saveTrackingRET'])){
		$gross = $database->charEncoder($_GET['gross']);
		$fund = $database->charEncoder($_GET['fund']);
		$period = date("F");
		$claimant = $database->charEncoder($_GET['claimant']);
		$rows = explode("~", $database->charEncoder($_GET['retDetails']));

		$office = $_SESSION['cbo'];
		$employeeNumber = $_SESSION['employeeNumber'];
		$status = "Encoded";
		$docType = "BOND - RETENTION MONEY";

		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 

		$trackingPartner = $database->charEncoder($_GET['tnPartner']);


		// $sql = "insert into ".$db."vouchercurrent (Year,Office,TrackingType,TrackingNumber,Fund,ClaimType,DocumentType,PeriodMonth,PeriodType,Claimant,Amount,EncodedBy,DateEncoded,DateModified,Status,SubCode,NetAmount,TrackingPartner) VALUES 
		// 		('".$defaultYear."','".$office."','PY','".$trackingNumber."','".$fund."','Check','".$docType."','".$period."','Monthly','".$claimant."','".$gross."','".$employeeNumber."','".$dateEncoded."','".$dateEncoded."','".$status."','0',0.00,'".$trackingPartner."');
		// 		";
		$sql = "insert into ".$db."vouchercurrent (Year,Office,TrackingType,TrackingNumber,Fund,ClaimType,DocumentType,PeriodMonth,PeriodType,Claimant,Amount,EncodedBy,DateEncoded,DateModified,Status,SubCode,NetAmount,TrackingPartner) VALUES 
				('".$defaultYear."','".$office."','PY','".$trackingNumber."','".$fund."','Check','".$docType."','".$period."','Monthly','".$claimant."','".$gross."','".$employeeNumber."','".$dateEncoded."','".$dateEncoded."','".$status."','0','".$gross."','".$trackingPartner."');
				";
		$database->query($sql);
		
		$particulars = "";
		$particulars = "\n\tTo payment of refund of RETENTION MONEY of " . $claimant . " in the amount of. . .\n";

		$particulars .= "\n".$database->autoSpacer("TN",8)."&emsp;".$database->autoSpacer("PO No.",9)."&emsp;".$database->autoSpacer("INV#",6)."&emsp;".$database->autoSpacer("INV DATE",9)."&emsp;"."AMOUNT";
		$particulars .= "\n------------------------------------------------------------------------------------";
		
		$updateSQL = "update ".$db."vouchercurrent set TrackingPartner = (case TrackingNumber ";
		$whereCondt = "where TrackingNumber IN(";
		$whereTN = [];

		$invNumCase = "(case TrackingNumber ";
		$invDatCase = "(case TrackingNumber ";
		$updateInvDets = 0;

		for($i=0; $i<sizeof($rows); $i++){
			$data = explode("!", $rows[$i]);

			$trackingNumber1 = $data[0];
			$invNum = $data[1];
			$poNum = $data[2];
			$invDate = $data[3];
			$amountRet = $data[4];
			$updateInvFlag = $data[5];

			$particulars .= "\n".$database->autoSpacer($trackingNumber1,9)."&emsp;".$database->autoSpacer($poNum,9)."&emsp;".$database->autoSpacer($invNum,7)."&emsp;".$database->autoSpacer($invDate,10)."&emsp;".number_format($amountRet,2);
			$updateSQL .= "\n when '".$trackingNumber1."' then '".$trackingNumber."'";
			$whereTN[] = "'".$trackingNumber1."'";

			if($updateInvFlag == 1){
				$invNumCase .= "\n when '".$trackingNumber1."' then '".$invNum."'";
				$invDatCase .= "\n when '".$trackingNumber1."' then '".$invDate."'";
				$updateInvDets = 1;
			}
		}
		$updateSQL .= "\n END) ".$whereCondt.implode(",", $whereTN).")";
		$database->query($updateSQL);

		if($updateInvDets == 1){
			$invNumCase .= "\n END)";
			$invDatCase .= "\n END)";

			$updateInvSql = "update ".$db."particulars set InvoiceNumber = ".$invNumCase." , InvoiceDate = ".$invDatCase." ".$whereCondt.implode(",", $whereTN).")";
			$database->query($updateInvSql);
		}

		$sql = "Insert into particulars (TrackingNumber, Particulars)values ('".$trackingNumber."', '".$particulars."')";
		$database->query($sql);
		
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~'. $trackingNumber;
	}

	if(isset($_GET['searchRetentionBySupplier'])){
		$name = $database->charEncoder($_GET['name']);
		$acct = $_SESSION['accountType'];

		if($acct == 1){
			$office = $_SESSION['officeCode'];
			$sql = "select TrackingNumber, TrackingPartner as tnPartner, Claimant, ADV1, PeriodMonth, Amount, Status, NetAmount, checknumber, checkdate
					from ".$db."vouchercurrent
					where DocumentType = 'BOND - RETENTION MONEY'
					and Office = '".$office."' 
					and Claimant like '%".$name."%'
					group by TrackingNumber order by Id desc";
		}else{
			$sql = "select TrackingNumber, TrackingPartner as tnPartner, Claimant, ADV1, PeriodMonth, Amount, Status, NetAmount, checknumber, checkdate
					from ".$db."vouchercurrent
					where DocumentType = 'BOND - RETENTION MONEY'
					and Claimant like '%".$name."%'
					group by TrackingNumber order by Id desc";
		}
		$record = $database->query($sql);
		echo $sheet1->CreateRetentionList($record);
	}
	if(isset($_GET['loadRetentionOffice'])){
		$sql = "select b.* from  (Select Office from ".$db."vouchercurrent where 
					DocumentType = 'BOND - RETENTION MONEY'
				group by office ) as a left join ".$db."office b on a.Office =  b.Code order by b.Name asc;";
		$record = $database->query($sql);
		$sheet = '<option></option>';
		while($data = $database->fetch_array($record)){
			$code = $data['Code'];
			$name =  ucwords(strtolower($data['Name']));
			$sheet .= '<option value = "' . $code . '">' .  $name . '</option>';
		}
		$sheet .= '<option value = "all">All Offices</option>';
		echo $sheet;
	}
	if(isset($_GET['loadRetention'])){
		$office = $database->charEncoder($_GET['office']);
		$accountType = $database->charEncoder($_SESSION['accountType']);

		if($accountType > 1){
			$sql = "select TrackingNumber, TrackingPartner as tnPartner, Claimant, ADV1, PeriodMonth, Amount, Status, NetAmount, checknumber, checkdate
					from ".$db."vouchercurrent
					where DocumentType = 'BOND - RETENTION MONEY'
					and Status != 'Cancelled'
					group by TrackingNumber order by Id desc limit 20";
		}else {
			$sql = "select TrackingNumber, TrackingPartner as tnPartner, Claimant, ADV1, PeriodMonth, Amount, Status, NetAmount, checknumber, checkdate
					from ".$db."vouchercurrent
					where DocumentType = 'BOND - RETENTION MONEY'
					and Office = '".$office."'
					and Status != 'Cancelled'
					group by TrackingNumber order by Id desc limit 20";
		}

		$record = $database->query($sql);
		echo $sheet1->CreateRetentionList($record);
	}
	if(isset($_GET['searchPOTrackingPartnerRET'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		$sql = "SELECT 
				a.TrackingNumber, a.Claimant, a.ADV1, a.PeriodMonth, a.Amount, a.Status, a.NetAmount, a.checknumber, a.checkdate, b.TrackingNumber as tnPartner
				FROM 
				".$db."vouchercurrent a
				left join (select * from ".$db."vouchercurrent where TrackingPartner = '".$trackingNumber."') b on b.TrackingPartner = a.TrackingNumber
				where a.TrackingNumber = '".$trackingNumber."'";

		$record = $database->query($sql);
		
		echo $sheet1->CreateRetentionList($record);
	}

	if(isset($_GET['fetchCounter'])){
		$qtr = $database->charEncoder($_GET['qtr']);
		if($qtr == 1){
			$month = $database->charEncoder($_GET['month']);
			
			if($month < 4){
				$qtr = "optCounter1st";
			}else if($month < 7){
				$qtr = "optCounter2nd";
			}else if($month <10){
				$qtr = "optCounter3rd";
			}else{
				$qtr = "optCounter4th";
			}
			
		}
		if($qtr == "optCounter1st"){
			$qtrLabel = "1st Quarter";
			$frm =  $year . "-01-01";
			$frmCurrent = $year . "-01-01";
			$to = $year . "-03-31";
		}else if($qtr == "optCounter2nd"){
			$qtrLabel = "2nd Quarter";
			$frm =  $year . "-04-01";
			$frmCurrent = $frm;
			$to = $year . "-06-30";
		}else if($qtr == "optCounter3rd"){
			$qtrLabel = "3rd Quarter";
			$frm =  $year . "-07-01";
			$frmCurrent = $frm;
			$to = $year . "-09-30";
		}else if($qtr == "optCounter4th"){
			$qtrLabel = "4th Quarter";
			$frm =  $year . "-10-01";
			$frmCurrent = $frm;
			$to = $year . "-12-31";
		}else if($qtr == "optCounterYearPlus"){
			$qtrLabel = "Year Plus";
			$frm =  ($year+1) . "-01-01";
			$frmCurrent = $frm;
			$to = ($year+5) . "-12-31";
			
		}else if($qtr == "optCounterYearMinus"){
			$qtrLabel = "Year Before";
			$frm =  ($year-1) . "-06-01";
			$frmCurrent = $frm; 
			$to = ($year-1) . "-12-31";
		}else{
			$qtrLabel = "All";
			$frm =  $year . "-01-01";
			$frmCurrent = ($year-1) . "-10-01"; 
			$to1 = ($year+5) . "-12-31";
			$to = $to1;
		}		
		
		$sql = "Select a.*, 
				
				case when status = 'CAO Received' then '01' 
				 when status = 'CAO - SLP' then  '02' 
				 when status = 'CAO - SLP 1' then  '03' 
				 when status = 'Pending at CAO' then  '04' 
				 when status = 'Pending Released - CAO' then '05' 
				 when status = 'Forwarding Transmittal' then '06' 
				 when status = 'CAO Released' then '06' 
				 
				 when status = 'Check Advised' then '07'
				 when status = 'Cancelled' then '08' 
				
				 when status = 'CBO Received' then '09' 
				 when status = 'Pending at CBO' then '10' 
				 when status = 'Pending Released - CBO' then '11' 
				 when status = 'Fund Control' then '12' 
				 when status = 'CBO Released' then '13' 
				 when status = 'Waiting For Delivery' then '14' 
				
				 when status = 'GSO Received' then '15' 
				 when status = 'Pending at GSO' then '16' 
				 when status = 'Pending Released - GSO' then '17' 
				 when status = 'GSO Released' then '18' 
				 when status = 'Served to Supplier' then '19' 
				 when status = 'Supplier Conformed' then '20' 
				 
				 when status = 'For Inspection' then '21' 
				 when status = 'Pending at GSO - Inspection' then '22' 
				 when status = 'Pending Released - Inspection' then '23' 
				
				 when status = 'Inspected' then '24' 
				 when status = 'Inventory' then '25'
				 when status = 'Pending at GSO - Inventory' then '26' 
				 when status = 'Pending Released - Inventory' then '27'  
				 
				 when status = 'CTO Received' then '28'
				 when status = 'Pending at CTO' then '29'
				 when status = 'Pending Released - CTO' then '30' 
				 when status = 'Check Preparation - CTO' then '31' 
				 
				 when status = 'Forwarded to Admin - Administration' then '32' 
				 when status = 'Forwarded to Admin - Operation' then '33' 
				 when status = 'Forwarded to SP - Admin' then '34' 
				 when status = 'Forwarded to SP Admin - PR' then '34' 
				 when status = 'Check Released' then '35' 
				 
				 
				 when status = 'Admin Received' then '36' 
				 when status = 'Pending at Admin' then '37' 
				 when status = 'Pending Released - Admin' then '38' 
				 
				 
				 when status = 'BAC Received' then '39' 
				 when status = 'Pending at BAC' then '40' 
				 when status = 'Pending Released - BAC' then '41' 
				 when status = 'For P.O' then '42' 
				 
				end as seq
				
				from 
				(
					(SELECT status,count(id) as Count FROM citydoc" . $year  . ".voucherhistory where substr(DateModified,1,10) >= '" . $frmCurrent . "' and substr(DateModified,1,10) <= '" . $to . "' group by Status) 
					union
					(SELECT status,count(id) as Count FROM citydoc" . ($year - 1) . ".voucherhistory where substr(DateModified,1,10) >= '" . $frm . "' and substr(DateModified,1,10) <= '" . $to . "' group by Status)
					union
					(SELECT status,count(id) as Count FROM citydoc" .($year - 2) . ".voucherhistory where substr(DateModified,1,10) >= '" . $frm . "' and substr(DateModified,1,10) <= '" . $to . "' group by Status)
					union
					(SELECT status,count(id) as Count FROM citydoc" . ($year - 3) . ".voucherhistory where substr(DateModified,1,10) >= '" . $frm . "' and substr(DateModified,1,10) <= '" . $to . "' group by Status)
				 )
				as a group by status order by seq Asc";
			
		
		if($qtr == "optCounterYearMinus"){
			$qtrLabel = "Year Before";
			$frm =  ($year-1) . "-06-01";
			$frmCurrent = $frm; 
			$to = ($year-1) . "-12-31";
			
			$sql = "Select a.*, 
				
				case when status = 'CAO Received' then '01' 
				 when status = 'CAO - SLP' then  '02' 
				 when status = 'CAO - SLP 1' then  '03' 
				 when status = 'Pending at CAO' then  '04' 
				 when status = 'Pending Released - CAO' then '05' 
				 when status = 'Forwarding Transmittal' then '06' 
				 when status = 'CAO Released' then '06' 
				 
				 when status = 'Check Advised' then '07'
				 when status = 'Cancelled' then '08' 
				
				 when status = 'CBO Received' then '09' 
				 when status = 'Pending at CBO' then '10' 
				 when status = 'Pending Released - CBO' then '11' 
				 when status = 'Fund Control' then '12' 
				 when status = 'CBO Released' then '13' 
				 when status = 'Waiting For Delivery' then '14' 
				
				 when status = 'GSO Received' then '15' 
				 when status = 'Pending at GSO' then '16' 
				 when status = 'Pending Released - GSO' then '17' 
				 when status = 'GSO Released' then '18' 
				 when status = 'Served to Supplier' then '19' 
				 when status = 'Supplier Conformed' then '20' 
				 
				 when status = 'For Inspection' then '21' 
				 when status = 'Pending at GSO - Inspection' then '22' 
				 when status = 'Pending Released - Inspection' then '23' 
				
				 when status = 'Inspected' then '24' 
				 when status = 'Inventory' then '25'
				 when status = 'Pending at GSO - Inventory' then '26' 
				 when status = 'Pending Released - Inventory' then '27'  
				 
				 when status = 'CTO Received' then '28'
				 when status = 'Pending at CTO' then '29'
				 when status = 'Pending Released - CTO' then '30' 
				 when status = 'Check Preparation - CTO' then '31' 
				 
				 when status = 'Forwarded to Admin - Administration' then '32' 
				 when status = 'Forwarded to Admin - Operation' then '33' 
				 when status = 'Forwarded to SP - Admin' then '34' 
				 when status = 'Check Released' then '35' 
				 
				 when status = 'Admin Received' then '36' 
				 when status = 'Pending at Admin' then '37' 
				 when status = 'Pending Released - Admin' then '38' 
				 
				 when status = 'BAC Received' then '39' 
				 when status = 'Pending at BAC' then '40' 
				 when status = 'Pending Released - BAC' then '41' 
				 when status = 'For P.O' then '42' 
				end as seq
				from 
				(
					(SELECT status,count(id) as Count FROM citydoc" . $year  . ".voucherhistory where substr(DateModified,1,10) >= '" . $frmCurrent . "' and substr(DateModified,1,10) <= '" . $to . "' group by Status) 	
				 )
				as a group by status order by seq Asc";
			
			
		}
		
		$sql1 = "select a.Status,
					b.Count as Jan,
					c.Count as Feb,
					d.Count as Mar, 
					e.Count as Apr, 
					f.Count as May, 
					g.Count as Jun, 
					h.Count as Jul, 
					i.Count as Aug, 
					j.Count as Sep, 
					k.Count as Oct, 
					l.Count as Nov, 
					m.Count as Dex,
					
					case when a.Status = 'Encoded' then '01' 
					 when a.Status = 'CBO Received' then  '02' 
					 when a.Status = 'Pending at CBO' then  '03' 
					 when a.Status = 'Pending Released - CBO' then  '04' 
					 when a.Status = 'CBO Released' then '05' 
					 when a.Status = 'CAO Received' then '06' 
					 when a.Status = 'Pending at CAO' then '06' 
					 
					 when a.Status = 'Pending Released - CAO' then '07'
					 
					 when a.Status = 'CAO - SLP' then '07'
					 when a.Status = 'CAO - SLP 1' then '070'
					 
					 
					 when a.Status = 'Forwarding Transmittal' then '08' 
					 when a.Status = 'CAO Released' then '08' 
					 when a.Status = 'Check Recorded' then '08' 
					 
					 
					
					 when a.Status = 'Check Preparation - CTO' then '09' 
					 when a.Status = 'Forwarded to Admin - Administration' then '10' 
					 
					 when a.Status = 'Forwarded to Admin - Operation' then '11' 
					 when a.Status = 'Forwarded to SP - Admin' then '12' 
					 when a.Status = 'Check Advised' then '13' 
					 when a.Status = 'Forwarded to CTO' then '14' 
					 when a.Status = 'Check Released' then '14'
					 
					
					 when a.Status = 'GSO Received' then '15' 
					 when a.Status = 'Pending at GSO' then '16' 
					 when a.Status = 'Pending Released - GSO' then '17' 
					 
					 
					 
					when a.Status = 'GSO Released' then '18' 
					when a.Status = 'CTO Received' then '19'
					when a.Status = 'Pending at CTO' then '20'
					when a.Status = 'Pending Released - CTO' then '21' 
					 
					 
					when a.Status = 'Admin Received' then '22' 
					when a.Status = 'Pending at Admin' then '23' 
					when a.Status = 'Pending Released - Admin' then '24'
					
					
					when a.Status = 'BAC Received' then '25' 
					when a.Status = 'Pending at BAC' then '26' 
					when a.Status = 'Pending Released - BAC' then '27' 
					when a.Status = 'For P.O' then '28' 
					 
					 
					when a.Status = 'Forwarded to CMO' then '29'  
					when a.Status = 'CMO Approved' then '30'  
					
					 
					when a.Status = 'Served to Supplier' then '31' 
					when a.Status = 'Supplier Conformed' then '32' 
					when a.Status = 'Fund Control' then '33' 
					
					when a.Status = 'Waiting for Delivery' then '34' 
					
					
					
					
					when a.status = 'For Inspection' then '35' 
					when a.status = 'Pending at GSO - Inspection' then '36' 
					when a.status = 'Pending Released - Inspection' then '37' 
					when a.status = 'Inspected' then '38' 
					
					when a.Status = 'Inventory' then '39'
					when a.Status = 'Pending at GSO - Inventory' then '40' 
					when a.Status = 'Pending Released - Inventory' then '41'  
					when a.Status = 'Reverted to Check Advised' then '42'  
					when a.Status = 'CBO Received - Reverted' then '42'  
					when a.Status = 'Cancelled' then '42'  			 
					end as seq
					from
					(SELECT TrackingNumber,Status FROM voucherhistory where TrackingNumber like '%" . $office ."%'  group by Status) a
				    left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-01' group by Status) b on a.Status = b.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-02' group by Status) c on a.Status = c.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-03' group by Status) d on a.Status = d.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-04' group by Status) e on a.Status = e.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-05' group by Status) f on a.Status = f.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-06' group by Status) g on a.Status = g.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-07' group by Status) h on a.Status = h.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-08' group by Status) i on a.Status = i.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-09' group by Status) j on a.Status = j.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-10' group by Status) k on a.Status = k.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-11' group by Status) l on a.Status = l.Status
					left join 
					(SELECT TrackingNumber,Status,count(id) as Count FROM voucherhistory where TrackingNumber like '%" . $office ."%' and substr(DateModified,1,7) = '" . $year . "-12' group by Status) m on a.Status = m.Status



					group by a.Status order by seq asc

					";
	
		
		if($accountType > 1){
			$record = $database->query($sql);
			echo $sheet->displayCounter($record,$year,$qtrLabel);
		}else{
			$record = $database->query($sql1);
			echo $sheet->displayOfficeCounter($record,$year,$qtrLabel);
		}		
	}

	// if(isset($_GET['editRetention'])){
	// 	$trackingNumber = $database->charEncoder($_GET['tn']);

	// 	if($_SESSION['perm'] == 34) {
	// 		$sql = "SELECT a.Claimant,a.PO_Number, a.PO_Amount, a.TotalAmountMultiple, a.Status, a.checknumber, a.checkdate, a.TrackingType, a.TrackingPartner, a.TrackingNumber, b.InvoiceNumber, b.InvoiceDate
	// 			FROM ".$db."vouchercurrent a 
	// 			left join ".$db."particulars b on a.TrackingNumber = b.TrackingNumber
	// 			where a.TrackingPartner = '".$trackingNumber."' GROUP BY a.TrackingNumber";
	// 	}else{
	// 		$sql = "SELECT a.Claimant,a.PO_Number, a.PO_Amount, a.TotalAmountMultiple, a.Status, a.checknumber, a.checkdate, a.TrackingType, a.TrackingPartner, a.TrackingNumber, b.InvoiceNumber, b.InvoiceDate
	// 			FROM ".$db."vouchercurrent a 
	// 			left join ".$db."particulars b on a.TrackingNumber = b.TrackingNumber
	// 			where a.TrackingPartner = '".$trackingNumber."' and a.Office = '".$_SESSION['cbo']."' GROUP BY a.TrackingNumber";
	// 	}

	// 	$record = $database->query($sql);


	// 	$total = 0.00;
	// 	$sheet = "";
	// 	$sheet .= "	<div class='editorContainer'>
	// 					<table border='0' style='padding:20px; border-spacing:0px;'>
	// 						<tr>
	// 							<td class='editorHeader'>Editor</td>
	// 							<td class='editorHeader'><div onclick='closeAbsolute(this)' class='closeEditor'></div></td>
	// 						</tr>
	// 						<tr>
	// 							<td colspan='2' style='text-align:right; padding:10px 28px 10px 0px;'>
	// 								<span style='margin-right:8px;font-family:oswald;'>Search PO TN#</span>
	// 								<input id='searchPORet' maxlength='9' class='text3' style='width:150px;font-weight: bold;font-family:oswald; padding:2px 5px; font-size: 22px;text-align:center;' onkeydown='keypressAndWhatClear(this,event,getPODetailsForRET1,1)' type='text'>
	// 							</td>
	// 						</tr>
	// 						<tr>
	// 							<td colspan='2' style='text-align:left; padding:10px 0px 10px 30px;'>
	// 								Claimant
	// 								<input disabled='' style='background-color:white;color:black;font-size:22px;padding-right:20px;border:0;border-bottom:1px dashed silver;padding-left:10px;font-weight: bold;width:0px;width:400px;margin-left:8px;' id='claimantRETEdit' class='data2' type='text' value='--CLAIMANTHERE--'>
	// 							</td>
	// 						</tr>
	// 						<tr>
	// 							<td colspan='2'>
	// 							<table border='0' style='margin:20px 10px 0px 20px; border-spacing:0px;' id='retentionList1'>
	// 								<thead style='background-color:rgb(247, 252, 252);'>
	// 									<th style='padding:3px 10px; border-bottom:1px solid rgba(0,0,0,.4);'>Tracking No.</th>
	// 									<th style='padding:3px 10px; border-bottom:1px solid rgba(0,0,0,.4);'>PO No.</th>
	// 									<th style='padding:3px 10px; border-bottom:1px solid rgba(0,0,0,.4);'>Invoice No.</th>
	// 									<th style='padding:3px 10px; border-bottom:1px solid rgba(0,0,0,.4);'>Invoice Date</th>
	// 									<th style='padding:3px 10px; border-bottom:1px solid rgba(0,0,0,.4); text-align:right;'>Amount</th>
	// 									<th style='padding:3px 10px; border-bottom:1px solid rgba(0,0,0,.4); text-align:right;'>Ret (1%)</th>
	// 									<th style='background-color:white;'></th>
	// 								</thead>
	// 								<tbody>
	// 								";

	// 	while($data = $database->fetch_array($record)){
	// 		$claimant = $data['Claimant'];
	// 		$trackingNumber1 = $data['TrackingNumber'];
	// 		$poNum = $data['PO_Number'];
	// 		$invNum = $data['InvoiceNumber'];
	// 		$invDate = $data['InvoiceDate'];
	// 		$amount = $data['PO_Amount'];

	// 		if($data['TotalAmountMultiple'] != "" && $data['TotalAmountMultiple'] != 0.00){
	// 			$amount = $data['TotalAmountMultiple'];
	// 		}
			
	// 		$amountPer = $amount*0.01;

	// 		$sheet .= "				<tr>
	// 									<td style='padding:3px 5px 3px 10px; border-bottom:1px solid rgba(0,0,0,.1);'>".$trackingNumber1."</td>
	// 									<td style='padding:3px 5px 3px 10px; border-bottom:1px solid rgba(0,0,0,.1);'>".$poNum."</td>
	// 									<td style='padding:3px 5px 3px 10px; border-bottom:1px solid rgba(0,0,0,.1); width:160px;'>
	// 										<input style='font-family:mainFont; border:0px; background-color:transparent; font-size:16px;' onclick='changeToEditable(this)' value='".$invNum."' readonly>
	// 									</td>
	// 									<td style='padding:3px 5px 3px 10px; border-bottom:1px solid rgba(0,0,0,.1); width:160px;'>
	// 										<input style='font-family:mainFont; border:0px; background-color:transparent; font-size:16px;' onclick='changeToEditable(this)' value='".$invDate."' readonly>
	// 									</td>
	// 									<td style='padding:3px 10px 3px 5px; border-bottom:1px solid rgba(0,0,0,.1); text-align:right;'>".number_format($amount,2)."</td>
	// 									<td style='padding:3px 10px 3px 5px; border-bottom:1px solid rgba(0,0,0,.1); text-align:right;'>".number_format($amountPer,2)."</td>
	// 									<td><i style='cursor:pointer;font-size:24px;font-weight:bold;color:red;' onclick='removeRetention1(this)'>&times;</i></td>
	// 								</tr>";

	// 		$total+=$amountPer;

	// 	}
	// 	$sheet .= "				</tbody>
	// 							</table>
	// 							<div id='retEditCont1' style='text-align:right; margin-right:25px;'>
	// 								<span style='font-weight:bold; padding-right:5px;'>Total</span>
	// 								<span id='retEditTotal' style='text-align:right; padding-right:10px; font-family:Oswald; font-size:16px; color:rgb(64, 161, 202); font-weight:bold;'>".number_format($total,2)."</span>
	// 							</div>
	// 							<div id='retEditCont2' style='text-align:right; margin-right:25px;'>
	// 								<div id='editor1011-1969' class='button1 b1' style='width:70px;' onclick='updateRetention(\"".$trackingNumber."\")'>Update</div>
	// 							</div>
	// 							</td>
	// 						</tr>
	// 					</table>
	// 				</div>";

	// 	$sheet = str_replace("--CLAIMANTHERE--", $claimant, $sheet);

	// 	echo $sheet;

	// }

	if(isset($_GET['updateTrackingRET'])){
		$claimant = $database->charEncoder($_GET['claimant']);
		$gross = $database->charEncoder($_GET['gross']);
		$fund = $database->charEncoder($_GET['fund']);
		$period = date("F");
		$tn = $database->charEncoder($_GET['tn']);
		$rows = explode("~", $database->charEncoder($_GET['retDetails']));

		$office = $_SESSION['cbo'];
		$employeeNumber = $_SESSION['employeeNumber'];

		$trackingPartner = $database->charEncoder($_GET['tnPartner']);
		if(sizeof($rows) > 1){
			$trackingPartner = "Multiple";
		}

		$db = $database->getDB($year);

		//Claimant,Amount,ModifiedBy,DateModified,TrackingPartner
		$sql = "UPDATE ".$db.".vouchercurrent SET Claimant = '".$claimant."', Amount = '".floatval($gross)."', ModifiedBy = '".$employeeNumber."', DateModified = '".$dateEncoded."', TrackingPartner = '".$trackingPartner."' WHERE TrackingNumber = '".$tn."'";
		$database->query($sql);

		$particulars = "";
		$particulars = "\n\tTo payment of refund of RETENTION MONEY of " . $claimant . " in the amount of. . .\n";

		$particulars .= "\n".$database->autoSpacer("TN",8)."&emsp;".$database->autoSpacer("PO No.",9)."&emsp;".$database->autoSpacer("INV#",6)."&emsp;".$database->autoSpacer("INV DATE",9)."&emsp;"."AMOUNT";
		$particulars .= "\n------------------------------------------------------------------------------------";
		
		$updateSQL = "update ".$db.".vouchercurrent set TrackingPartner = (case TrackingNumber ";
		$whereCondt = "where TrackingNumber IN(";
		$whereTN = [];

		$invNumCase = "(case TrackingNumber ";
		$invDatCase = "(case TrackingNumber ";
		$updateInvDets = 0;

		for($i=0; $i<sizeof($rows); $i++){
			$data = explode("!", $rows[$i]);

			$trackingNumber1 = $data[0];
			$invNum = $data[1];
			$poNum = $data[2];
			$invDate = $data[3];
			$amountRet = $data[4];
			$updateInvFlag = $data[5];

			$particulars .= "\n".$database->autoSpacer($trackingNumber1,9)."&emsp;".$database->autoSpacer($poNum,9)."&emsp;".$database->autoSpacer($invNum,7)."&emsp;".$database->autoSpacer($invDate,10)."&emsp;".number_format($amountRet,2);
			$updateSQL .= "\n when '".$trackingNumber1."' then '".$tn."'";
			$whereTN[] = "'".$trackingNumber1."'";

			if($updateInvFlag == 1){
				$invNumCase .= "\n when '".$trackingNumber1."' then '".$invNum."'";
				$invDatCase .= "\n when '".$trackingNumber1."' then '".$invDate."'";
				$updateInvDets = 1;
			}
		}
		$updateSQL .= "\n END) ".$whereCondt.implode(",", $whereTN).")";

		$sql = "UPDATE ".$db.".vouchercurrent SET TrackingPartner = null WHERE TrackingPartner = '".$tn."'";
		$database->query($sql);

		$database->query($updateSQL);

		if($updateInvDets == 1){
			$invNumCase .= "\n END)";
			$invDatCase .= "\n END)";

			$updateInvSql = "update ".$db.".particulars set InvoiceNumber = ".$invNumCase." , InvoiceDate = ".$invDatCase." ".$whereCondt.implode(",", $whereTN).")";
			$database->query($updateInvSql);
		}

		$sql = "DELETE FROM ".$db.".particulars WHERE TrackingNumber = '".$tn."'";
		$database->query($sql);

		$sql = "Insert into ".$db.".particulars (TrackingNumber, Particulars)values ('".$tn."', '".$particulars."')";
		$database->query($sql);

		echo $tn;
	}

	/********************************************/
	/*             RETENTION - END              */
	/********************************************/
	
	//---------- Start: PR Summary ----------//
	
	if(isset($_GET['getPrSummaryTotal'])){
		$sql = "";

		$sql = "SELECT 
				a.Fund, count(*) as TNTotal, sum(if(a.TotalAmountMultiple > 0, a.TotalAmountMultiple,a.Amount)) as Total 
				FROM 
				(
					select * 
					from 
					".$db."vouchercurrent 
					where 
					TrackingType = 'PR' and  Status = 'GSO Released' 
					or TrackingType = 'PR' and Status = 'CTO Received' 
					or TrackingType = 'PR' and Status = 'Admin Received' 
					or TrackingType = 'PR' and Status = 'Pending at Admin'
					or TrackingType = 'PR' and Status = 'Pending Released - Admin'
					or TrackingType = 'PR' and Status = 'BAC Received'
					or TrackingType = 'PR' and Status = 'Pending at BAC'
					or TrackingType = 'PR' and Status = 'Pending Released - BAC'
					or TrackingType = 'PR' and Status = 'For P.O' 
					group by TrackingNumber
				) a
				where a.TrackingType = 'PR' group by a.Fund";
		$result = $database->query($sql);
		echo $sheet1->genPrSumTransTotalTable($result);
	}

	if(isset($_GET['getPrSumDet'])){
		$ctrlType = $database->charEncoder($_GET['ctrlType']);
		$fund = $database->charEncoder($_GET['fund']);
		$loadMore = $database->charEncoder($_GET['defaultLoadMore']);

		if($ctrlType == 'TRANS'){
			$loadStr = "limit ".$loadMore;
			if($loadMore == 'All'){
				$loadStr = "";
			}
			$sql = "SELECT a.*, b.Description as CatTitle, c.Name as OfficeName FROM 
					(
						SELECT Id, TrackingNumber, PR_Number, OBR_Number, PR_CategoryCode, Status, Amount, TotalAmountMultiple, Office 
						FROM ".$db."vouchercurrent 
						where 
						TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'GSO Released'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'CTO Received'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Admin Received'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending at Admin'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending Released - Admin'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'BAC Received'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending at BAC'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending Released - BAC'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'For P.O'
						group by TrackingNumber 
					) a
					left join ".$db."ppmpcategories b on a.PR_CategoryCode = b.Code
					left join ".$db."office c on a.Office = c.Code
					order by a.Id asc ".$loadStr."
					";
			$result = $database->query($sql);
			echo $sheet1->genPrTransTable($result, $fund, $loadMore, $year);
		}else{
			$sql = "SELECT 
					PR_CategoryCode, b.Description, count(*) as TNTotal, sum(Amount) as Total, c.Name as OfficeName 
					FROM 
					(
						select * 
						from ".$db."vouchercurrent 
						where 
						TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'GSO Released'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'CTO Received'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Admin Received'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending at Admin'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending Released - Admin'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'BAC Received'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending at BAC'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending Released - BAC'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'For P.O'
						group by TrackingNumber
					) a 
					left join ".$db."ppmpcategories b on a.PR_CategoryCode = b.Code
					left join ".$db."office c on a.Office = c.Code
					group by PR_CategoryCode";
			$result = $database->query($sql);
			echo $sheet1->genPrTransTableByCat($result, $fund, $loadMore, $year);
		}
	}

	if(isset($_GET['getPrSumDetLoadMore'])){
		$lastTr = $database->charEncoder($_GET['lastTr']);
		$addtl = $database->charEncoder($_GET['addtl']);
		$fund = $database->charEncoder($_GET['fund']);

		$loadStr = "limit ".$addtl;
		if($addtl == 'All'){
			$loadStr = "";
		}

		$sql = "SELECT 
					a.*, b.Description as CatTitle, c.Name as OfficeName
				FROM 
				( 
					SELECT 
						Id, TrackingNumber, PR_Number, OBR_Number, PR_CategoryCode, Status, Amount, TotalAmountMultiple, Office 
					FROM
						".$db."vouchercurrent 
					where 
						TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'GSO Released'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'CTO Received'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Admin Received'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending at Admin'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending Released - Admin'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'BAC Received'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending at BAC'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'Pending Released - BAC'
						or TrackingType = 'PR' and  Fund = '".$fund."' and Status = 'For P.O'
					group by TrackingNumber 
				) a 
				left join ".$db."ppmpcategories b on a.PR_CategoryCode = b.Code 
				left join ".$db."office c on a.Office = c.Code
				where a.Id > '".$lastTr."' order by a.Id asc ".$loadStr;

		$result = $database->query($sql);
		echo $sheet1->genPrTransTableAddtl($result);
	}

	//---------- End: PR Summary ----------//

if(isset($_GET['fetchCalendar'])){
		$month = $database->charEncoder($_GET['month']);
		$year = $database->charEncoder($_GET['year']);
		if($month == 13){
			$month =   date('m');
		}
		$monthSearch = $year . '-' . $month;
		//$monthSearch = $year . '-11';
		
		if($accountType == 1){
			$officeQ = "office = '" . $office . "' and  ";
		}else{
			$officeQ = '';
		}
		
		/*$sql = "SELECT Status,count(Id) as Count,substr(DateModified,9,2) as Day FROM vouchercurrent  
				where $officeQ  substring(DateModified,1,7) = '" . $monthSearch . "' and 
				status in (
				'CAO Received','Pending at CAO','Pending Released - CAO','Forwarding Transmittal',
				'CBO Received','Pending at CBO','Pending Released - CBO','Fund Control',

				'GSO Received','Pending at GSO', 'Pending Released - GSO',
				'Served to Supplier','Supplier Conformed',
				'For Inspection', 'Inspected','Pending at GSO - Inspection','Pending Released - Inspection',
				'Inventory','Pending at GSO - Inventory','Pending Released - Inventory',
				'CTO Received','pending at CTO','Pending Released - CTO','Check Preparation - CTO',
				'Admin Received','Pending at Admin','Pending Released - Admin',
				'Forwarded to Admin - Administration','Forwarded to Admin - Operation','Forwarded to SP - Admin',
				'BAC Received','Pending at BAC','Pending Released - BAC','Encoded','Waiting for Delivery','Cancelled')
				group by  status ,substr(DateModified,1,10) 
				order by Status,Datemodified";	*/
				
		// $sql = "select a.*,count(a.Status) as Count from(
		// 		SELECT Status,substr(DateModified,9,2) as Day FROM 
		// 		vouchercurrent 
		// 		where $officeQ substring(DateModified,1,7) = '" . $monthSearch . "' and status in 
		// 		( 'CAO Received','Pending at CAO','Pending Released - CAO','On Evaluation - Accounting','Evaluated - Accounting','Carded - Accounting','SLP Created - Accounting',
		// 		'Forwarding Transmittal','CAO Released', 'CBO Received','Pending at CBO','Pending Released - CBO',
		// 		'Fund Control', 'Obligation Request for Pick-up', 'GSO Received','Pending at GSO', 'Pending Released - GSO', 'Served to Supplier','Supplier Conformed', 'For Inspection', 'Inspected',
		// 		'Pending at GSO - Inspection','Pending Released - Inspection', 'Inventory','Pending at GSO - Inventory','Pending Released - Inventory', 'CTO Received',
		// 		'Pending at CTO','Pending Released - CTO','Check Preparation - CTO', 
		// 		'Admin Received','Pending at Admin','Pending Released - Admin','PO Signed',
		// 		'Forwarded to Admin - Administration','Forwarded to Admin - Operation','Forwarded to SP - Admin', 'BAC Received','Pending at BAC','Pending Released - BAC',
		// 		'Encoded','Waiting for Delivery','Cancelled')
		// 		group by TrackingNumber order by Status,Datemodified) a group by a.Status,Day";

		$sql = "select a.*,count(a.Status) as Count from(
				SELECT Status,substr(DateModified,9,2) as Day FROM 
				vouchercurrent 
				where $officeQ substring(DateModified,1,7) = '" . $monthSearch . "' and status in 
				( 'CAO Received','Pending at CAO','Pending Released - CAO','On Evaluation - Accounting','Evaluated - Accounting','Carded - Accounting','SLP Created - Accounting',
				'Forwarding Transmittal','CAO Released', 'CBO Received','Pending at CBO','Pending Released - CBO',
				'Fund Control', 'Obligation Request for Pick-up', 'GSO Received','Pending at GSO', 'Pending Released - GSO', 'Served to Supplier','Supplier Conformed', 'For Inspection', 'Inspected',
				'Pending at GSO - Inspection','Pending Released - Inspection', 'Inventory','Pending at GSO - Inventory','Pending Released - Inventory', 'CTO Received',
				'Pending at CTO','Pending Released - CTO','Check Preparation - CTO', 
				'Admin Received','Pending at Admin','Pending Released - Admin','PO Signed','Plans, PoW, and Detailed Estimates for Approval','Plans, PoW, and Detailed Estimates Signed','Notice of Award for Admin Signature','Notice of Award Admin Signed','Contract and NTP for Admin Signature','Document for Pick-up - Admin',
				'Forwarded to Admin - Administration','Forwarded to Admin - Operation','Forwarded to SP - Admin', 'BAC Received','Pending at BAC','Pending Released - BAC',
				'Encoded','Waiting for Delivery','Cancelled')
				group by TrackingNumber order by Status,Datemodified) a group by a.Status,Day";
				
		$record = $database->query($sql);
		$res = '';
		while($data = $database->fetch_array($record)){
			$status = $data['Status'];
			$count = $data['Count'];
			$day = $data['Day'];
			$id = $status . $day;
			$res .= $id . '~' . $count . '*';
		}

		// Fund specific
		$sql = "select a.*, count(a.Status) as Count from(
				SELECT Status,substr(DateModified,9,2) as Day, Fund FROM 
				vouchercurrent 
				where $officeQ substring(DateModified,1,7) = '" . $monthSearch . "' and status in 
				('Requesting for Fund Certification','Acknowledge Certification Request','Fund Certification Signed')
				group by TrackingNumber order by Status,Datemodified) a group by a.Status,Day,Fund";
			
		$record = $database->query($sql);
		$res1 = '';
		while($data = $database->fetch_array($record)){
			$status = $data['Status'];
			$count = $data['Count'];
			$day = $data['Day'];
			$fund = $data['Fund'];

			$office = "Budget";
			if($fund == 'Trust Fund') {
				$office = "Accounting";
			}

			$id = $office . $status . $day;
			$res1 .= $id . '~' . $count . '*';
		}

		// for COMPLEX column
		$sql = "SELECT a.*, count(Complex) as Count
				FROM (
						SELECT DISTINCT TrackingNumber, Status, Complex
						FROM vouchercurrent 
						WHERE 
						".$officeQ."
						substring(DateModified,1,7) = '" . $monthSearch . "' 
						AND
						Complex = 2
						AND
						Status IN 
								('CAO Received','Pending at CAO','Pending Released - CAO','On Evaluation - Accounting','Evaluated - Accounting','Carded - Accounting','SLP Created - Accounting',
								'Forwarding Transmittal','CAO Released', 'CBO Received','Pending at CBO','Pending Released - CBO',
								'Fund Control', 'Obligation Request for Pick-up', 'GSO Received','Pending at GSO', 'Pending Released - GSO', 'Served to Supplier','Supplier Conformed', 'For Inspection', 'Inspected',
								'Pending at GSO - Inspection','Pending Released - Inspection', 'Inventory','Pending at GSO - Inventory','Pending Released - Inventory', 'CTO Received',
								'pending at CTO','Pending Released - CTO','Check Preparation - CTO',
								'Admin Received','Pending at Admin','Pending Released - Admin','PO Signed','Plans, PoW, and Detailed Estimates for Approval','Plans, PoW, and Detailed Estimates Signed','Notice of Award for Admin Signature','Notice of Award Admin Signed','Contract and NTP for Admin Signature','Document for Pick-up - Admin', 
								'Forwarded to Admin - Administration','Forwarded to Admin - Operation','Forwarded to SP - Admin', 'BAC Received','Pending at BAC','Pending Released - BAC',
								'Encoded','Waiting for Delivery','Cancelled')
				) a
				GROUP BY a.Status";
		$record = $database->query($sql);
		$res2 = '';

		while($data = $database->fetch_array($record)){
			$status = $data['Status'];
			$count = $data['Count'];
			$day = 32;
			$id = $status . $day;
			$res2 .= $id . '~' . $count . '*';
		}

		echo $res.$res1.$res2;
		
	}
	
	if(isset($_GET['getTrackingFromCalendar'])){
		$month = $database->charEncoder($_GET['month']);
		$year = $database->charEncoder($_GET['year']);
		$day = $database->charEncoder($_GET['day']);
		$status = $database->charEncoder($_GET['status']);
		$office = $database->charEncoder($_GET['office']);
		// $dataModified =  $year . '-' . $month . '-' . $day ;

		$complexStr = '';
		if($day < 32) {
			$dataModified =  $year . '-' . $month . '-' . $day ;
		}else {
			$dataModified =  $year . '-' . $month;
			$complexStr = " AND Complex = '2'";
		}

		if($accountType == 1){
			$officeQ = "office = '" . $office . "' and  ";
		}else{
			$officeQ = '';
		}

		$fundStr = '';
		if($office == 'Accounting'){
			$fundStr .= "AND Fund = 'Trust Fund'";
		}elseif($office == 'Budget') {
			$fundStr .= "AND (Fund = 'General Fund' OR Fund = 'SEF')";
		}
		
		$sql = "select TrackingNumber,Claimant,TrackingType,DocumentType,Status,Amount,PO_Amount,TotalAmountMultiple,Office,DateModified,Name,Complex from 	
				vouchercurrent a left join office b on a.Office = b.Code
		 		where $officeQ status = '" . $status . "' ".$fundStr." and DateModified like '%" .  ($dataModified) . "%' ".$complexStr." group by trackingnumber order by Name,Claimant 
		        ";
		$record = $database->query($sql);

		$return = $sheet->createTableCalendarTracking($record);

		$return .= "<div style='text-align:right; padding: 5px 5px 5px 0px;'>
						<span style='font-size:10px; font-family:roboto; letter-spacing:1px; cursor:pointer;' onclick=\"gotoFormCalendar('".$day."','".$status."','".$year."','".$month."')\">
							PRINT LIST
						</span>
					</div>";
		echo $return;	
	}
	
	
	if(isset($_GET['forCheckReleased'])){
		$record = $database->checkAdviseList();
		echo $sheet->createForReleasedChecks($record);
	}
	if(isset($_GET['ctoClaimLate'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$sql = "select DateEncoded from vouchercurrent where trackingnumber = '" .$trackingNumber . "' limit 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$encoded = $data['DateEncoded'];
		$completion =  str_replace(" ago","",$database->ezDate1($encoded));
		$status = "Check Released";
		$updateCase = "Completion = '" . $completion . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		$database->paymasterClaim($year, $trackingNumber, $employeeNumber, $dateEncoded);
	}
	
	if(isset($_GET['ctoUnClaimLate'])){
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$sql = "select DateEncoded from vouchercurrent where trackingnumber = '" .$trackingNumber . "' limit 1";
		$record = $database->query($sql);
		
		$data = $database->fetch_array($record);
		
		$encoded = $data['DateEncoded'];
		
		$completion =  str_replace(" ago","",$database->ezDate1($encoded));
		$status = "Unclaimed";
		
		$updateCase = "Completion = '" . $completion . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
	}
	
	
	if(isset($_GET['showCheckUnclaimed'])){
		$sql = "select TrackingNumber,Claimant,NetAmount,CheckNumber,CheckDate,DateModified,DocumentType,b.Name from vouchercurrent a
				left join office b on a.Office  = b.code
				where status  = 'Unclaimed' and checknumber > 0 group by TrackingNumber order by datemodified desc";
		$record = $database->query($sql);
		echo $sheet->createUnclaimedChecks($record);
	}

	if(isset($_GET['showCheckReleased'])){
		$sql = "select TrackingNumber,Claimant,NetAmount,CheckNumber,CheckDate,DateModified,DocumentType,b.Name from vouchercurrent a
				left join office b on a.Office  = b.code
				
				where status  = 'Check Released' and checknumber > 0 group by TrackingNumber order by datemodified desc limit 50";
		$record = $database->query($sql);
		echo $sheet->createClaimedChecks($record);
	}
	if(isset($_GET['showCancelledChecks'])){
		$sql = "select a.*,c.Name as Office,b.Claimant,b.DocumentType,b.NetAmount from cancelledchecks a 
				left join vouchercurrent b on a.TrackingNumber = b.TrackingNumber
				left join office c on b.Office = c.Code 
				order by a.DateModified desc limit 50";
		$record = $database->query($sql);
		echo $sheet->createCancelledChecks($record);
	}
	if(isset($_GET['showAllChecks'])){
		/*$sql = "select a.TrackingNumber,a.Fund,a.checknumber,a.checkdate,a.NetAmount,a.ADV1,a.OBR_Number,a.Status,a.DateModified,a.Office,a.Claimant,a.DocumentType,
				a.PR_AccountCode,a.PR_ProgramCode, b.AccountNo  from vouchercurrent a  join adviceinfo b on a.TrackingNumber = b.TrackingNumber where a.checknumber > 1 
				order by checknumber asc limit 50 ";*/
				
			$sql = "select b.*,c.AccountNo from (select a.TrackingNumber,a.Fund,a.checknumber,a.checkdate,a.NetAmount,a.ADV1,a.OBR_Number,a.Status,a.DateModified,a.Office,a.Claimant,a.DocumentType,
					a.PR_AccountCode,a.PR_ProgramCode  from vouchercurrent a where a.checknumber > 1 
					group by trackingnumber  order by a.checknumber asc limit 50) b left join adviceinfo c on b.TrackingNumber = c.TrackingNumber ";	
				
		$record = $database->query($sql);
		echo $sheet->createAllChecksFilters($record);
		echo $sheet->createAllChecks($record,1);
	}
	if(isset($_GET['showAllChecksFilter'])){
		$year = $_GET['year'];
		$month = $_GET['month'];
		$fund = $_GET['fund'];
		$column = $_GET['column'];
		$order = $_GET['order'];
		$limit = $_GET['limit'];
		$dbase = $_GET['dbase'];
		$respo = $_GET['respo'];
		
		if($month == 13){
			$checkPeriod =  " and substr(CheckDate,1,4) = '" . $year . "'";
		}else{
			if($month < 10){
				$month = '0' .$month;
			}
			$checkPeriod =  " and substr(CheckDate,1,7) = '" . $year . "-" . $month . "'";
		}
		
		if($respo == "Yes"){
			$grp = "";
		}else{
			
			$grp = " group by TrackingNumber";
		}
		
		if($fund == "GF"){
			$fund =" and Fund = 'General Fund'";
		}else if($fund == "SF"){
			$fund =" and Fund = 'SEF'";
		}else if($fund == "TF"){
			$fund =" and Fund = 'Trust Fund'";
		}else if($fund == "All"){
			$fund =" and Fund != ''";
		}
		
		if($limit != 'All'){
			$limit = " limit $limit ";
		}else{
			$limit = '';
		}
		$sql = "select a.*,b.AccountNo from (select * from citydoc$dbase.vouchercurrent 
				where checknumber > 1 $checkPeriod $fund
				$grp  order by " . $column . " $order  $limit) a left join citydoc$dbase.adviceinfo b on a.TrackingNumber = b.TrackingNumber ";
		$record = $database->query($sql);
		echo $sheet->createAllChecks($record,$respo);
		
	}
	
	
	if(isset($_GET['ctoBackToAdvise'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$completion =  '';
		$status = "Check Advised";
		
		$updateCase = "Completion = '" . $completion . "', Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		$database->paymasterUnclaim($year, $trackingNumber, $dateEncoded);
	}

	//---------------------------------------------------------------------------------------------------WAGES - START
	if(isset($_GET['searchPTRS'])){
		// RP - Plantilla, Back Pay, Underpayment - rp_transaction_details
		// VP - Salary JO (All), Salary Differential - rp_transaction_details
		// SP - Incidental Expense, Overtime Pay, etc. - sp_transaction_details

		$docType = $database->charEncoder($_GET['doctype']);
		$upType = $database->charEncoder($_GET['uptype']);
		$ptrs =  strtoupper($database->charEncoder($_GET['ptrs']));
		$ptrs = str_replace(" ", "", $ptrs);
		$temp = explode(",", $ptrs);


		$table = "";
		$hyb = 0;

		$whereIn = "";
		for ($i=0; $i < sizeof($temp); $i++) { 
			$temp1 = explode("-", $temp[$i]);
			if(sizeof($temp1) > 2){
				$type = $temp1[0];
				$period = $temp1[1];
				$headerId = $temp1[2];
			}else{
				$type = "RP";
				$period = $temp1[0];
				$headerId = $temp1[1];
			}

			$whereIn .= ",".$headerId;

			$curTable = "";
			// if($type == "RP"){
			// 	$curTable = "rp_transaction_details";
			// }else{
			// 	$curTable = "sp_transaction_details";
			// }

			if($type == "RP"){
				$curTable = "rp_transaction_details";
			}elseif($type == "SP"){
				$curTable = "sp_transaction_details";
			}


			if($table == ""){
				$table = $curTable;
			}else if($table != $curTable){
				$hyb = 1;
			}
		}

		if($table == ""){
			$hyb = 1;
		}

		if($hyb == 0){
			// $sql = "SELECT a.*, b.lastname, b.firstname, b.middlename, b.extension, sum(c.amt) as othrded 
			// 		FROM 
			// 		brgs.".$table." a
			// 		left join brgs.employees b on a.empno = b.empno
			// 		left join brgs.rp_transaction_deductions c ON a.header_id = c.header_id AND a.empno = c.empno
			// 		WHERE 
			// 		a.header_id IN (".substr($whereIn, 1).") ORDER BY b.lastname ASC";

			$sql = "SELECT OfficeCode, OfficeName FROM brgs.office";
			$record = $database->query($sql);

			$offices = [];
			while($data = $database->fetch_array($record)) {
				$offices[$data['OfficeCode']] = trim($data['OfficeName']);
			}

			$sql = "SELECT * FROM 
					(	SELECT 
						b.lastname, b.firstname, b.middlename, b.extension, b.office as empOffice, a.*, a.header_id as headerId, a.empno as empNumber
						FROM 
						brgs.".$table." a
						left join brgs.employees b on a.empno = b.empno
						WHERE 
						a.header_id IN (".substr($whereIn, 1).")
					) a
					LEFT JOIN 
					(	SELECT header_id, empno, sum(amt) as othrded 
						FROM brgs.rp_transaction_deductions 
						WHERE header_id IN (".substr($whereIn, 1).") 
						GROUP BY header_id, empno
					) c 
					ON a.header_id = c.header_id and a.empno = c.empno ORDER BY a.header_id ASC, a.lastname ASC, a.firstname ASC"; // added firstname order by for same surname purposes 08-09-2022
			$record = $database->query($sql);

			$totalGross = 0;
			$totalNet = 0;
			$totalPera = 0;
			$totalState = 0;
			$totalRate = 0;
			$totalLwop = 0;
			$totalOther = 0;
			$totalWtax = 0;

			//gov share
			$totalGSIS = 0;
			$totalPagIbig = 0;
			$totalPhilHealth = 0;

			//personal share
			$totalGSIS1 = 0;
			$totalPagIbig1 = 0;
			$totalPhilHealth1 = 0;

			$claimant = "";
			$empRows = $database->num_rows($record);
			$row = 0;
			$curHeaderId = "";
			$sheet0 = "<table border='0' cellspacing='0' cellpadding='0' id='tableDoctrackDBFList' style='margin:0px auto;'>
							<thead>
								<tr style='background-color:rgb(12, 71, 123); color:white;'>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); padding:3px 5px 3px 10px; text-align:left;'></th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>Office</th>
									<th style='background-color:rgb(43, 50, 56); border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 5px 3px 8px; text-align:left;'>Employee</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>Compensation</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>Pera</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>GSIS</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>PhilHealth</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>Pagibig</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>ECIP</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>Gross</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>Absences</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>Deductions</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>Tax</th>
									<th style='border-bottom:1px solid rgba(0,0,0,.2); letter-spacing:1px; padding:3px 8px 3px 10px; text-align:right;'>Net</th>
								</tr>
							</thead>
							<tbody id='wagesEmployeeDetailsContainer'>
						";

			$empNumber = "";
			$firstEmpNumber = "";
		
			while($data = $database->fetch_array($record)){
					
				$lname = $data['lastname'];
				$fname = $data['firstname'];
				$mname = "";
				if ($data['middlename'] != "") {
					$mname = str_replace(" ", "", $data['middlename'])[0];
				}
				$empOffCode = $data['empOffice'];
				$empNumber = $data['empNumber'];
				$exten = str_replace(" ", "", $data['extension']);
				// $fullname = $lname.", ".$fname." ".$mname." ".$exten;
				$fullname = utf8_encode($lname.", ".$fname." ".$mname." ".$exten);
				if($totalGross == 0){
					if($empRows > 1){
						$claimant = $fullname." ET AL";
					}else{
						$claimant = $fullname;
					}

					$firstEmpNumber = $empNumber;

				}	
				$headerId = $data['headerId'];

				if($curHeaderId == "" || $curHeaderId != $headerId){
					$period = $database->numberToMonth(str_replace($year, "", substr($ptrs, (strpos($ptrs, "-".$headerId) - 6), 6)));
					$sheet0 .= "	<tr style='background-color:white;'>
										<td style='border-bottom:1px dashed silver;'></td>
										<td colspan='13' style='padding:3px 5px; text-align:left; font-style:italic; font-weight:bold; font-size:12px; letter-spacing:1px; border-bottom:1px dashed silver;'>
											".$period."
										</td>
									</tr>";

					$curHeaderId = $headerId;
				}

				//if($type == "RP" || $type == "VP" || $type == "SD"){
				if($type == "RP"){
					$rate = $data['rate']; // for plantilla
					$compen = $data['compen']; // for other payroll 
					$lwop = $data['lwop']; // absences
					$gsis = $data['gvgsis'];
					$pera = $data['pera'];
					$pagibig = $data['gvpagibig'];
					$philhealth = $data['gvphilhealth'];
					$state = $data['state'];

					$gsis1 = $data['gsis'];
					$pagibig1 = $data['pagibig'];
					$philhealth1 = $data['philhealth'];
                    $wtax = $data['wtax'];

					if($docType == "WAGES - SALARY PLANTILLA" || $docType == "WAGES - BACK PAY" || $docType == "WAGES - SALARY DIFFERENTIAL"){
						$salary = floatval($rate) - floatval($lwop); 
					}else{
						$salary = floatval($compen) - floatval($lwop); 
						$rate = $compen;
					}

				}else{
					$amt1 = $data['amt1'];
					$tax1 = $data['tax1'];
					$amt2 = $data['amt2'];
					$tax2 = $data['tax2'];
					$rate = floatval($amt1) + floatval($amt2); // for special payroll
					$compen = 0.00;
					$lwop = 0.00;
					$gsis = 0.00;
					$pera = 0.00;
					$pagibig = 0.00;
					$philhealth = 0.00;
					$state = 0.00;

					$gsis1 = 0.00;
					$pagibig1 = 0.00;
					$philhealth1 = 0.00;
                    $wtax = 0.00;
                    // $wtax = ($tax1 + $tax2);

					$salary = $rate;
					$compen = $salary - ($tax1 + $tax2);
				}

				$other = floatval($data['othrded']); // other deductions

                $perShare = $gsis1 + $pagibig1 + $philhealth1 + $lwop + $wtax;

                $net = ($compen - $perShare) - $other; 

				if($type == "SP"){
					$wtax = ($tax1 + $tax2);
				}
			
				$totalPera += $pera;
				$totalState += $state;
				$totalGross += $salary;
				$totalNet += $net;

				//gov share
				$totalGSIS += $gsis;
				$totalPagIbig += $pagibig;
				$totalPhilHealth += $philhealth;

				//personal share
				$totalGSIS1 += $gsis1;
				$totalPagIbig1 += $pagibig1;
				$totalPhilHealth1 += $philhealth1;

				$totalRate += $rate;
				$totalLwop += $lwop;
				$totalOther += $other;
				$totalWtax += $wtax;

				$sheet0 .= "	<tr>
									<td style='padding:0px 5px; text-align:left; font-style:italic; font-weight:bold; font-size:9px;'>
										".++$row."
									</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px; white-space:nowrap;' id='".$empOffCode."'>".$offices[$empOffCode]."</td>
									<td style='padding:5px 10px 5px 10px; text-align:left; white-space:nowrap;' id='".$empNumber."'>".utf8_encode($fullname)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($rate, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($pera, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($gsis, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($philhealth, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($pagibig, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($state, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($salary, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($lwop, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($other, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;'>".number_format($wtax, 2)."</td>
									<td style='padding:5px 5px 5px 10px; letter-spacing:1px;' id='".$headerId."'>".number_format($net, 2)."</td>
								</tr>";

			}

			$multipleRecs = 1;
			if($firstEmpNumber == $empNumber) {

				// reason of failure : if first employee of last month's ptrs is the last employee of the current month's ptrs
				// Ex. February PTRS - Zebra; March PTRS - Ape, Cat, Dog, Eagle, Zebra;
				// failure only applicable for multiple ptrs
				
				$claimant = str_replace(" ET AL", "", $claimant);
				$multipleRecs = 0;
			}

			$sheet0 .= "	<tr style='font-weight:bold;'>
								<td style='background-color:white; padding:0px 5px; text-align:left; font-style:italic; font-weight:bold; font-size:9px;'>
									<input type='hidden' id='wgsTotGSISPS' value='".$totalGSIS1."'>
									<input type='hidden' id='wgsTotPIbigPS' value='".$totalPagIbig1."'>
									<input type='hidden' id='wgsTotPHealthPS' value='".$totalPhilHealth1."'>
									<input type='hidden' id='wgsMultipleRecs' value='".$multipleRecs."'>
								</td>
								<td style='background-color:white; padding:5px 10px 5px 10px; text-align:left; white-space:nowrap; text-align:right;'></td>
								<td style='background-color:white; padding:5px 10px 5px 10px; text-align:left; white-space:nowrap; text-align:right;'></td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px;' id='wgsTotCompensation'>".number_format($totalRate, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px;' id='wgsTotPERA'>".number_format($totalPera, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px;' id='wgsTotGSIS'>".number_format($totalGSIS, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px;' id='wgsTotPHealth'>".number_format($totalPhilHealth, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px;' id='wgsTotPIbig'>".number_format($totalPagIbig, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px;' id='wgsTotECIP'>".number_format($totalState, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px; color:rgb(35, 116, 157);' id='wgsTotGross'>".number_format($totalGross, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px;' id='wgsTotLWOP'>".number_format($totalLwop, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px;' id='wgsTotDeductions'>".number_format($totalOther, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px;' id='wgsTotTax'>".number_format($totalWtax, 2)."</td>
								<td style='background-color:white; border-top:1px solid silver; padding:5px 5px 5px 10px; letter-spacing:1px; color:red;' id='wgsTotalNetUniv'>".number_format($totalNet, 2)."</td>
							</tr>";

			$sheet0 .= "	</tbody>
						</table>";

			$totalAmountMultiple = $totalGross + $totalPera + $totalGSIS + $totalPagIbig + $totalPhilHealth + $totalState;

			echo $sheet->createWAGESView($sheet0,$ptrs,$claimant,$upType,$docType,$defaultYear,$_SESSION['cbo'],$totalGross,$totalPera,$totalGSIS,$totalPagIbig,$totalPhilHealth,$totalState,$totalNet,$totalAmountMultiple);
		}else{
			echo "<div style='text-align:center;'>Please enter the correct PTRS No.</div>"."*j*"."";
		}
	}

	if(isset($_POST['saveWagesComp'])){
		$ptrs = $database->charEncoder($_POST['ptrs']);
		$totalBreakdown = explode("$", $database->charEncoder($_POST['totalBreakdown']));
		$fund = $database->charEncoder($_POST['fund']);
		$claimtype = $database->charEncoder($_POST['claimtype']);
		$period = $database->charEncoder($_POST['period']);	
		$period1 = $database->numberToMonth(intval($period));
		$claimant = $database->charEncoder($_POST['claimant']);
		$docType = $database->charEncoder($_POST['docType']);
		$subCode = $database->charEncoder($_POST['subPrgCode']);
		$peorOfc = $database->charEncoder($_POST['peorOfcId']);
		$netAmount = $database->charEncoder($_POST['netAmount']);
		$empBreakdown = $database->charEncoder($_POST['empBreakdown']);

		$totCompensation = $database->charEncoder($_POST['totCompensation']);
		$totPERA = $database->charEncoder($_POST['totPERA']);
		$totGSIS = $database->charEncoder($_POST['totGSIS']);
		$totPHealth = $database->charEncoder($_POST['totPHealth']);
		$totPIbig = $database->charEncoder($_POST['totPIbig']);
		$totECIP = $database->charEncoder($_POST['totECIP']);
		$totGross = $database->charEncoder($_POST['totGross']);
		$totLWOP = $database->charEncoder($_POST['totLWOP']);
		$totDeductions = $database->charEncoder($_POST['totDeductions']);
		$totTax = $database->charEncoder($_POST['totTax']);

		$totGSISPS = $database->charEncoder($_POST['totGSISPS']);
		$totPIbigPS = $database->charEncoder($_POST['totPIbigPS']);
		$totPHealthPS = $database->charEncoder($_POST['totPHealthPS']);

		$multipleRecs = $database->charEncoder($_POST['multipleRecs']);

		//pagkuha sa new seq
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];

		$trackingPartner = "";
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1);

		$periodType = "Monthly";

		$paytype = substr($ptrs, 0, 2);

		if($docType == "WAGES - SALARY PLANTILLA"){
			$periodType = '1';
			if($paytype == "RP"){
				$periodType = "Monthly";
			}
		}

		$payrollAmountFirst = 0;
		$payrollAmountSecond = 0;
		$payeeNumber = "";

		$status = "Encoded";
		$totalAmountMultiple = 0;
		$charges = "";

		$complex = 1;
		if($docType == 'BENEFITS - TERMINAL LEAVE') {
			$complex = 2;
		}

		$vouchercurrent = "insert into ".$db."vouchercurrent (Year,Office,TrackingType,TrackingNumber,Fund,ClaimType,DocumentType,PeriodMonth,PeriodType,Claimant,Amount,EncodedBy,DateEncoded,DateModified,Status,SubCode,PR_ProgramCode,PR_AccountCode,TotalAmountMultiple,NetAmount,TrackingPartner,PayrollAmountFirst,PayrollAmountSecond,JevNo,PeaceOfficeId,Complex) 
				VALUES ";
		for ($i=0; $i < sizeof($totalBreakdown); $i++) { 
			$chargesB = explode("~", $totalBreakdown[$i]);
			$program = $chargesB[0];
			$account = $chargesB[1];
			$amount = $chargesB[2];

			$totalAmountMultiple += $amount;
			$charges .=	",('".$defaultYear."','".$office."','PY','".$trackingNumber."','".$fund."','".$claimtype."','".$docType."','".$period1."','".$periodType."','".$claimant."','".$amount."','".$employeeNumber."','".$dateEncoded."','".$dateEncoded."','".$status."','".$subCode."','".$program."','".$account."','totalAmountMultiple','netAmount','".$trackingPartner."', '".$payrollAmountFirst."', '".$payrollAmountSecond."', '".$payeeNumber."', '".$peorOfc."', '".$complex."')";
		}


		$charges = str_replace("totalAmountMultiple", $totalAmountMultiple, $charges);
		if($netAmount > 0) {
			$charges = str_replace("netAmount", $netAmount, $charges);
		}else {
			$charges = str_replace("netAmount", $totalAmountMultiple, $charges);
		}

		$database->query($vouchercurrent.substr($charges, 1));

		// if($trackingPartner != ""){
		// 	$partner = "insert into ".$db."vouchercurrent (Year,Office,TrackingType,TrackingNumber,Fund,ClaimType,DocumentType,PeriodMonth,PeriodType,Claimant,Amount,EncodedBy,DateEncoded,Status,TrackingPartner,NetAmount,PayeeNumber)
		// 			VALUES
		// 			('".$defaultYear."','".$office."','PY','".$trackingPartner."','".$fund."','".$claimtype."','".$docType."','".$period1."','2','".$claimant."','".$payrollAmountSecond."','".$employeeNumber."','".$dateEncoded."','Encoded','".$trackingNumber."','".$payrollAmountSecond."', '".$payeeNumber."')";
		// // $database->query($partner);
		// }

		$ptrs = str_replace(" ", "", $ptrs);
		$temp = explode(",", $ptrs);

		$whereIn = "";
		for ($i=0; $i < sizeof($temp); $i++) { 
			$temp1 = explode("-", $temp[$i]);
			if(sizeof($temp1) > 2){
				$type = $temp1[0];
				$period = $temp1[1];
				$headerId = $temp1[2];
			}else{
				$type = "RP";
				$period = $temp1[0];
				$headerId = $temp1[1];
			}
			

			$whereIn .= ",".$headerId;

		}

		$sql = "UPDATE brgs.sp_transaction_header SET trackingNumber = '".$trackingNumber."', trackingYear = '".$defaultYear."' WHERE id in (".substr($whereIn, 1).")";
		$database->query($sql);

		$wgsRow1 = "";
		$wgsRow2 = "";

		// $breakdown = "GVGSIS~".$totGSIS."*j*GVPhilHealth~".$totPHealth."*j*GVPag-ibig~".$totPIbig."*j*ECIP~".$totECIP."*j*Gross~".$totCompensation."*j*PERA~".$totPERA
		// 			."*j*Absences~".$totLWOP."*j*GSIS~".$totGSISPS."*j*PhilHealth~".$totPHealthPS."*j*Pag-ibig~".$totPIbigPS."*j*Deductions~".$totDeductions."*j*Tax~".$totTax;

		$breakdown = "Gross~".$totCompensation."*j*PERA~".$totPERA."*j*Absences~".$totLWOP."*j*GSIS~".$totGSISPS."*j*PhilHealth~".$totPHealthPS."*j*Pag-ibig~".$totPIbigPS."*j*Deductions~".$totDeductions."*j*Tax~".$totTax."*j*GVGSIS~".$totGSIS."*j*GVPhilHealth~".$totPHealth."*j*GVPag-ibig~".$totPIbig."*j*ECIP~".$totECIP."*j*MultipleRecs~".$multipleRecs;

		$sql = "INSERT INTO ".$db."particulars (TrackingNumber,PTRSNo,WGSBreakdown) VALUES ('".$trackingNumber."','".$ptrs."','".addslashes($breakdown)."')";
		$database->query($sql);

		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~'. $trackingNumber;

		$database->importPtrsEmployeeDetailsFromBrgs($trackingNumber, $empBreakdown, $ptrs);
	}

	if(isset($_GET['LoadProgramFundsByOfficeWages'])){
		// $record = $database->LoadProgramFundsByOffice($defaultYear,$_SESSION['officeCode']);
		if($_SESSION['accountType'] === "1"){
			$record = $database->LoadProgramFundsByOffice($defaultYear,$office);
			$sheet = '<select id ="fundSourceWGS1"  class = "data2" style = "width:200px; display:block;" onchange="onChangeWGSCodesPY(this); showHidePEORCodeWGS(this);">';
		}else{
			$record = $database->LoadProgramFundsWGS();
			$sheet = '<select id ="fundSourceWGS1"  class = "data2" style = "width:200px; display:block;" onchange="showHidePEORCodeWGS(this);">';
		}

		$sheet .= '<option value = ""></option>';
		while($data = $database->fetch_array($record)){
			$sheet .= '<option value = "'  . $data['Code'] . '">';
			$sheet .= $data['Code'] . ' ' . $data['Name'];
			$sheet .= '</option>';
		}
		$sheet .= '</select>';
		echo $sheet;
	}

	if(isset($_GET['wagesOtherDetails'])){
		$tn = $database->charEncoder($_GET['trackingNumber']);
		$tnPartner = $database->charEncoder($_GET['trackingPartner']);
		$fundSource = $database->charEncoder($_GET['fundSource']);

		$sql = "UPDATE ".$db."vouchercurrent SET PR_ProgramCode = '".$fundSource."' WHERE TrackingNumber = '".$tn."'";
		$database->query($sql);

		echo $tn;
	}

	if(isset($_POST['updateWages'])){
		$ptrs = $database->charEncoder($_POST['ptrs']);
	    $tn = $database->charEncoder($_POST['tn']);
		$totalBreakdown = explode("$", $database->charEncoder($_POST['totalBreakdown']));
	    $claimant = $database->charEncoder($_POST['claimant']);
	    $docType = $database->charEncoder($_POST['docType']);
	    $subPrgCode = $database->charEncoder($_POST['subPrgCode']);
		$peorOfc = $database->charEncoder($_POST['peorOfcId']);
	    $updateWages = $database->charEncoder($_POST['updateWages']);
		$netAmount = $database->charEncoder($_POST['netAmount']);
		$empBreakdown = $database->charEncoder($_POST['empBreakdown']);

		$totCompensation = $database->charEncoder($_POST['totCompensation']);
		$totPERA = $database->charEncoder($_POST['totPERA']);
		$totGSIS = $database->charEncoder($_POST['totGSIS']);
		$totPHealth = $database->charEncoder($_POST['totPHealth']);
		$totPIbig = $database->charEncoder($_POST['totPIbig']);
		$totECIP = $database->charEncoder($_POST['totECIP']);
		$totGross = $database->charEncoder($_POST['totGross']);
		$totLWOP = $database->charEncoder($_POST['totLWOP']);
		$totDeductions = $database->charEncoder($_POST['totDeductions']);
		$totTax = $database->charEncoder($_POST['totTax']);

		$totGSISPS = $database->charEncoder($_POST['totGSISPS']);
		$totPIbigPS = $database->charEncoder($_POST['totPIbigPS']);
		$totPHealthPS = $database->charEncoder($_POST['totPHealthPS']);

		$multipleRecs = $database->charEncoder($_POST['multipleRecs']);

		$sql = "SELECT * FROM ".$db."vouchercurrent WHERE TrackingNumber = '".$tn."' LIMIT 1";
		$result = $database->query($sql);
		$data = $database->fetch_array($result);
		$columns = array_keys($data);
		
		$Status = $data['Status'];  
		$docType = $data['DocumentType'];  

		$sql = "INSERT INTO ".$db."vouchercurrent (";
		$insert = "";
		for ($i=0; $i < sizeof($columns); $i++) {
			if($data[$columns[$i]] != "" && gettype($columns[$i]) != 'integer' && $columns[$i] != "Id"){
				$sql .= $columns[$i].",";
				if($columns[$i] == "Claimant"){
					$insert .= "'".$claimant."',";
				}else if($columns[$i] == "Amount"){
					$insert .= "'1*',";
				}else if($columns[$i] == "ModifiedBy"){
					$insert .= "'".$employeeNumber."',";
				}else if($columns[$i] == "DateModified"){
					$insert .= "'".$dateEncoded."',";
				}else if($columns[$i] == "PayeeNumber"){
					$insert .= "'".$payeeNumber."',";
				}else if($columns[$i] == "PR_ProgramCode"){
					$insert .= "'3*',";
				}else if($columns[$i] == "TotalAmountMultiple"){
					$insert .= "'totalAmountMultiple',";
				}else if($columns[$i] == "PR_AccountCode"){
					$insert .= "'2*',";
				}else if($columns[$i] == "SubCode"){
					$insert .= "'".$subPrgCode."',";
				}else if($columns[$i] == "PeaceOfficeId"){
					$insert .= "'".$peorOfc."',";
				}else if($columns[$i] == "NetAmount"){
					$insert .= "'netAmount',";
				}else if($columns[$i] == "Remarks"){
					$insert .= "'".addslashes($data[$columns[$i]])."',";
				}else{
					$insert .= "'".$data[$columns[$i]]."',";
				}

				// else if($columns[$i] == "PayrollAmountFirst"){
				// 	$insert .= "'".$payrollAmountFirst."',";
				// }else if($columns[$i] == "PayrollAmountSecond"){
				// 	$insert .= "'".$payrollAmountSecond."',";
				// }else if($columns[$i] == "NetAmount"){
				// 	$insert .= "'netAmount',";
				// }

				// Claimant, Amount, ModifiedBy, DateModified, PR_ProgramCode, PR_AccountCode, TotalAmountMultiple, NetAmount,PayrollAmountFirst, PayrollAmountSecond, PayeeNumber
				
			}
		}
		$sql = substr($sql, 0, -1).")";

		$totalAmountMultiple = 0;
		$insert1 = "";
		$net = 0;

		for ($i=0; $i < sizeof($totalBreakdown); $i++) { 
			$chargesB = explode("~", $totalBreakdown[$i]);
			$program = $chargesB[0];
			$account = $chargesB[1];
			$amount = $chargesB[2];
			
			$totalAmountMultiple += $amount;
			$insert1 .= ",(".substr($insert, 0, -1).")";
			$insert1 = str_replace("1*", $amount, $insert1);
			$insert1 = str_replace("2*", $account, $insert1);
			$insert1 = str_replace("3*", $program, $insert1);
		}
		$insert1 = str_replace("totalAmountMultiple", $totalAmountMultiple, $insert1);
		if($netAmount > 0){
			$insert1 = str_replace("netAmount", $netAmount, $insert1);
		}else {
			$insert1 = str_replace("netAmount", $totalAmountMultiple, $insert1);
		}
		$sql = $sql." VALUES ".substr($insert1, 1);
		$delete = "DELETE FROM ".$db."vouchercurrent WHERE TrackingNumber = '".$tn."'";
		$database->query($delete);
		$database->query($sql);


		$ptrs = str_replace(" ", "", $ptrs);
		$temp = explode(",", $ptrs);

		$whereIn = "";
		for ($i=0; $i < sizeof($temp); $i++) { 
			$temp1 = explode("-", $temp[$i]);
			if(sizeof($temp1) > 2){
				$type = $temp1[0];
				$period = $temp1[1];
				$headerId = $temp1[2];
			}else{
				$type = "RP";
				$period = $temp1[0];
				$headerId = $temp1[1];
			}
			

			$whereIn .= ",".$headerId;

		}

		// $sql = "SELECT date_carded FROM brgs.sp_transaction_header WHERE id in (".substr($whereIn, 1).") AND date_carded is null";
		// $result = $database->query($sql);
		// $numRows = $result->num_rows;

		// $sql = "UPDATE ".$db."particulars SET PTRSNo = '".strtoupper($ptrs)."' WHERE TrackingNumber = '".$tn."'";
		// $database->query($sql);

		// if(sizeof($temp) == $numRows){
			$sql = "UPDATE brgs.sp_transaction_header 
					SET trackingNumber = '".$tn."', 
					trackingYear = '".$defaultYear."' 
					WHERE id in (".substr($whereIn, 1).") 
					AND date_carded is null";
			$database->query($sql);

			echo $tn."*j*";
		// } else {
		// 	echo $tn."*j*"."Tracking already carded.";
		// }

		$wgsRow1 = "";
		$wgsRow2 = "";

		$net = 0;
		if($netAmount > 0){
			$net = $netAmount;
		}else {
			$net = $totalAmountMultiple;
		}

		$personalShare = ($totCompensation + $totPERA) - ($totLWOP + $totDeductions + $totTax + $net);

		// $breakdown = "GVGSIS~".$totGSIS."*j*GVPhilHealth~".$totPHealth."*j*GVPag-ibig~".$totPIbig."*j*ECIP~".$totECIP."*j*Gross~".$totCompensation."*j*PERA~".$totPERA
		// 			."*j*Absences~".$totLWOP."*j*GSIS~".$totGSISPS."*j*PhilHealth~".$totPHealthPS."*j*Pag-ibig~".$totPIbigPS."*j*Deductions~".$totDeductions."*j*Tax~".$totTax;

		$breakdown = "Gross~".$totCompensation."*j*PERA~".$totPERA."*j*Absences~".$totLWOP."*j*GSIS~".$totGSISPS."*j*PhilHealth~".$totPHealthPS."*j*Pag-ibig~".$totPIbigPS."*j*Deductions~".$totDeductions."*j*Tax~".$totTax."*j*GVGSIS~".$totGSIS."*j*GVPhilHealth~".$totPHealth."*j*GVPag-ibig~".$totPIbig."*j*ECIP~".$totECIP."*j*MultipleRecs~".$multipleRecs;

		$sql = "UPDATE ".$db."particulars SET PTRSNo = '".strtoupper($ptrs)."', WGSBreakdown = '".addslashes($breakdown)."' WHERE TrackingNumber = '".$tn."'";
		$database->query($sql);

		$database->importPtrsEmployeeDetailsFromBrgs($tn, $empBreakdown, $ptrs);
		$database->EditLogs($tn,"PTRS","PTRS",$ptrs,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);

	}

	if(isset($_GET['updateTrackingToSLP'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$db = $database->getDB($year);

		$sql = "SELECT JevNo, DocumentType FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);

		$empNum = $data['JevNo'];
		$docType = $data['DocumentType'];

		$periodType = 'Monthly';
		if($docType == 'WAGES - SALARY PLANTILLA'){
			$periodType = '1';
		}else if($docType == 'WAGES - SALARY J.O (Whole month)'){
			$periodType = '3';
		}else if($docType == 'WAGES - SALARY J.O (1st half)'){
			$periodType = '4';
		}else if($docType == 'WAGES - SALARY J.O (2nd half)'){
			$periodType = '5';
		}

		$sql = "UPDATE ".$db.".vouchercurrent SET PayeeNumber = '".$empNum."', PeriodType = '".$periodType."', JevNo = null WHERE TrackingNumber = '".$trackingNumber."'";
		$record = $database->query($sql);

		$status = "CAO - SLP";
		
		$completion = '';
		$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		
		echo $trackingNumber;
	}

	if(isset($_GET['fetchAccountCodesPYWGS'])){
		$programCode = $database->charEncoder($_GET['programCode']);
		// if($office == "LUMP"){
		// 	$sql = "SELECT a.Id,Year, OfficeCode,ProgramCode,a.Amount,a.Fund,
				
		// 			AccountCode as Code,Title
		// 			FROM  
		// 			funds  a left join fundtitles b on a.AccountCode = b.Code
					
		// 			where
		// 			a.ProgramCode = '" . $programCode . "' 
					
		// 			group by a.AccountCode
					
		// 			order by b.Title asc";
		// }else{
		// 	$sql = "SELECT a.Id,Year, OfficeCode,ProgramCode,a.Amount,a.Fund,
				
		// 			AccountCode as Code,Title
		// 			FROM  
		// 			funds  a left join fundtitles b on a.AccountCode = b.Code
					
		// 			where
		// 			a.OfficeCode = '" . $office . "' and a.ProgramCode = '" . $programCode . "' 
		// 			OR
		// 			a.OfficeCode = 'LUMP' and a.ProgramCode = '" . $programCode . "' 
		// 			order by b.Title asc";
		// }

		$sql = "SELECT Code, Title FROM fundtitles ORDER BY Title ASC";
				
		$record = $database->query($sql);

		$sheet = "<select class = 'data2 checkPY' style = 'width:300px;'>";
		$sheet .= "<option></option>";
		while($data = $database->fetch_array($record)){
			$code = $data['Code'];
			$title = $data['Title'];
			
			$sheet .= '<option value = "' . $code . '">';
			$sheet .= 	$code."&nbsp;&nbsp;&nbsp;".$title ;
			$sheet .= "</option>";
		}
		$sheet .= "</select>";
		echo $sheet;
	}

	if(isset($_GET['fetchSubProgramBalanceForWGS'])){
		$upType = $database->charEncoder($_GET['upType']);
		$sql = "select * from peace order by fund,name asc";
		$record = $database->query($sql);
		echo $sheet->createPeaceOfficeWGS($record, $upType);
	}
	//---------------------------------------------------------------------------------------------------WAGES - END

	//---------------------------------------------------------------------------------------------------PAYMASTER - START
	if(isset($_GET['getPYDetailsForPAY'])){
		$key = $database->charEncoder($_GET['trackingNumber']);

		$sql = "SELECT Id, TrackingPartner FROM vouchercurrent WHERE TrackingNumber = '".$key."' LIMIT 1";
		$record = $database->query($sql); 
		$data = $database->fetch_array($record);
		$tnPartner = $data['TrackingPartner'];

		if($tnPartner == ""){
			$sql = "SELECT a.*, b.* 
					FROM vouchercurrent a 
					LEFT JOIN particulars b ON a.TrackingNumber = b.TrackingNumber
					WHERE a.TrackingNumber  = '" . $key . "' ORDER BY a.PR_ProgramCode, a.PR_AccountCode LIMIT 1";	
			$record = $database->query($sql);

			$err = "";
			if($database->num_rows($record) > 0){
				$details = "";
				$data = $database->fetch_array($record);
				$docType = $data['DocumentType'];
				
				$trackingNumber = $data['TrackingNumber'];
				$claimant = utf8_decode(utf8_encode($data['Claimant']));
				$fund = $data['Fund'];
				$program = $data['PR_ProgramCode'];
				$account = $data['PR_AccountCode'];
				$obr = $data['OBR_Number'];
				$adv = $data['ADV1'];

				$vcAmount = 0;
				if(floatval($data['TotalAmountMultiple']) > 0){
					$vcAmount = floatval($data['TotalAmountMultiple']);
				}else{
					$vcAmount = floatval($data['Amount']);
				}
				$vcNet = floatval($data['NetAmount']);

				$periodMonth = $data['PeriodMonth'];
				$periodType = $data['PeriodType'];
				
				if($periodType  == 1 ){
					$p = '&nbsp;1&nbsp;-&nbsp;15,&nbsp;';
				}else if($periodType  == 2){
					$p = '&nbsp;16&nbsp;-&nbsp;31,&nbsp;';
				}else{
					$p = '';
				}

				$vcPeriod = $periodMonth.$p;

				$status = $data['Status'];
				$type = $data['TrackingType'];
				$claimType = $data['ClaimType'];

				$empsNum = 0;
				$ptrs = $data['PTRSNo'];
				$officeAssigned = $data['OfficeAssigned'];

				if($status != "CAO Released"){
					$err.="\nStatus should be CAO Released";
				}
				if($type != "PY"){
					$err.="\nTransaction should be Salary Tracking";
				}
				if($claimType != "Window"){
					$err.="\nFor Window transactions only";
				}

				if(strlen(trim($ptrs)) > 0){
					$headerId = "";
					$arrPtrs = explode(",", $ptrs);
					for ($i=0; $i < sizeof($arrPtrs); $i++) { 
						$temp1 = explode("-", $arrPtrs[$i]);
						$type = $temp1[0];
						$period = $temp1[1];
						$id = $temp1[2];

						$curTable = "";
						if($type == "SP"){
							$curTable = "sp_transaction_details";
						}else{
							$curTable = "rp_transaction_details";
						}

						$headerId .= ",'".$id."'";
					}

					$sql = "SELECT sum(empsNum) as totalEmps FROM (SELECT count(id) as empsNum FROM brgs.".$curTable." WHERE header_id IN (".substr($headerId, 1).") GROUP BY empno) a";
					$record = $database->query($sql);
					$data = $database->fetch_array($record);
					$empsNum = $data['totalEmps'];
				}else{
					$empsNum = 0;
				}

				$details .= $trackingNumber."*payContent*".$claimant."*payContent*".$vcAmount."*payContent*".$vcNet."*payContent*".$empsNum."*payContent*".$fund."*payContent*".$officeAssigned."*payContent*".$docType."*payContent*".$vcPeriod."*payContent*".$program."*payContent*".$account."*payContent*".$obr."*payContent*".$adv;
	
				echo json_encode(substr($err, 1)."*j*".$details);
			}else{
				echo json_encode("No record found"."*j*");
			}
		}else{
			echo json_encode("Already tracked under TN# ".$tnPartner."*j*");
		}
	}

	if(isset($_GET['savePaymasterNew'])) {
		$officer = $database->charEncoder($_GET['officer']);
		$fund = $database->charEncoder($_GET['fund']);
		$window = $database->charEncoder($_GET['window']);
		$addTN = $database->charEncoder($_GET['addTN']);
		$addClaimant = $database->charEncoder($_GET['addClaimant']);
		$addDocType = $database->charEncoder($_GET['addDocType']);
		$addPeriod = $database->charEncoder($_GET['addPeriod']);
		$addOffice = $database->charEncoder($_GET['addOffice']);
		$addEmps = intval($database->charEncoder($_GET['addEmps']));
		$addGross = floatval($database->charEncoder($_GET['addGross']));
		$addNet = floatval($database->charEncoder($_GET['addNet']));
		$addProgram = $database->charEncoder($_GET['addProgram']);
		$addAccount = $database->charEncoder($_GET['addAccount']);
		$addOBR = $database->charEncoder($_GET['addOBR']);
		$addADV = $database->charEncoder($_GET['addADV']);
		$period = date("F");

		$office = $_SESSION['cbo'];
		$employeeNumber = $_SESSION['employeeNumber'];
		$status = "Draft";
		$docType = "CASH ADVANCE TO PAYMASTER";

		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office,$db);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition,$db);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 

		// $trackingPartner = $database->charEncoder($_GET['tnPartner']);
		$trackingPartner = "Multiple";

		// sa paymaster ni
		$sql = "insert into vouchercurrent (Year,Office,TrackingType,TrackingNumber,Fund,ClaimType,DocumentType,PeriodMonth,PeriodType,Claimant,Amount,EncodedBy,DateEncoded,DateModified,Status,SubCode,NetAmount,TrackingPartner) VALUES 
			('".$year."','".$office."','PY','".$trackingNumber."','".$fund."','Check','".$docType."','".$period."','Monthly','".$officer."','".$addNet."','".$employeeNumber."','".$dateEncoded."','".$dateEncoded."','".$status."','0','".$addNet."','".$trackingPartner."');
			";
		$database->query($sql);

		// sa paymaster ni
		$sql = "INSERT INTO particulars (TrackingNumber, `Window`, NumOfEmps) VALUES ('".$trackingNumber."', '".$window."', '".$addEmps."')";
		$database->query($sql);
		
		// sa gi-add na tracking sa paymaster
		$sql = "UPDATE particulars SET NumOfEmps = '".$addEmps."', OfficeAssigned = '".$addOffice."' WHERE TrackingNumber = '".$addTN."'";
		$database->query($sql);

		// sa gi-add na tracking sa paymaster - halted kay case kung previous year ang tracking then ang paymaster kay current year ang tracking partner na mabutang kay dli mao ang tuig.
		$sql = "UPDATE vouchercurrent SET TrackingPartner = '".$trackingNumber."', NetAmount = '".$addNet."' WHERE TrackingNumber = '".$addTN."'";
		$database->query($sql);

		$sql = "INSERT INTO chequerist.paymaster (PMTrackYear, PMTrackingNumber, PMClaimant, PMFund, PMWindow, PMNumOfEmps, PMTotalNet, AddedProgram, AddedOBR_Number, AddedAccount, AddedADV, AddedDocumentType, AddedTrackYear, AddedTrackingNumber, AddedClaimant, AddedOfficeAssigned, AddedNumOfEmps, AddedGross, AddedNet, AddedPeriod)
				VALUES
				('".$year."','".$trackingNumber."','".$officer."','".$fund."','".$window."','".$addEmps."','".$addNet."','".$addProgram."','".$addOBR."','".$addAccount."','".$addADV."','".$addDocType."','".$year."','".$addTN."','".$addClaimant."','".$addOffice."','".$addEmps."','".$addGross."','".$addNet."','".$addPeriod."')
				";
		$database->query($sql);

		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion,$db);
		echo $newTrackingNumber . '~'. $trackingNumber."*j*";
	}

	if(isset($_GET['searchPMForAdding'])) {
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		$sql = "SELECT * FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$officer = utf8_decode(utf8_encode($data['Claimant']));
		$fund = $data['Fund'];

		$sql = "SELECT * FROM particulars WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record1 = $database->query($sql); 
		$data1 = $database->fetch_array($record1);
		$window = $data1['Window'];

		$return = $trackingNumber."*j*".$officer."*j*".$fund."*j*".$window;
		echo $return;
	}

	if(isset($_GET['getTrackingUnderPM'])) {
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		$sql = "SELECT * FROM chequerist.paymaster WHERE PMTrackYear = '".$year."' AND PMTrackingNumber = '".$trackingNumber."' ORDER BY AddedClaimant ASC";
		$record = $database->query($sql);

		$sheet = "";
		$row = 0;
		while($data = $database->fetch_array($record)) {
			$tnYear = $data['AddedTrackYear'];
			$addTN = $data['AddedTrackingNumber'];
			$addClaimant = $data['AddedClaimant'];
			$addOffice = $data['AddedOfficeAssigned'];
			$addEmps = $data['AddedNumOfEmps'];
			$addGross = floatval($data['AddedGross']);
			$addNet = floatval($data['AddedNet']);

			$sheet .= "	<tr>
							<td style='text-align:center; width:10px;'>".++$row."</td>
							<td style='text-align:center;'>".$tnYear."</td>
							<td style=''>".$addTN."</td>
							<td style=''>".utf8_decode(utf8_encode($addClaimant))."</td>
							<td style=''>".$addOffice."</td>
							<td style='text-align:center;'>".$addEmps."</td>
							<td style='text-align:right;'>".$database->toNumberFormat($addGross)."</td>
							<td style='text-align:right;'>".$database->toNumberFormat($addNet)."</td>
							<td style=''>
								<i style='cursor:pointer; font-weight:bold; color:red; font-style:normal; font-size:12px;' onclick='pmRemoveThisDirect(this)'>&#x2715;</i>
							</td>
						</tr>";
		}

		echo $sheet;
	}

	if(isset($_GET['addToPaymaster'])) {
		$pmTrackingNumber = $database->charEncoder($_GET['pmTrackingNumber']);
		$officer = $database->charEncoder($_GET['officer']);
		$fund = $database->charEncoder($_GET['fund']);
		$window = $database->charEncoder($_GET['window']);

		$addTrackingNumber = $database->charEncoder($_GET['addTN']);
		$addClaimant = $database->charEncoder($_GET['addClaimant']);
		$addDocType = $database->charEncoder($_GET['addDocType']);
		$addPeriod = $database->charEncoder($_GET['addPeriod']);
		$addOBR = $database->charEncoder($_GET['addOBR']);
		$addADV = $database->charEncoder($_GET['addADV']);
		$addProgram = $database->charEncoder($_GET['addProgram']);
		$addAccount = $database->charEncoder($_GET['addAccount']);
		$addOfficeAssigned = $database->charEncoder($_GET['addOffice']);
		$addEmps = intval($database->charEncoder($_GET['addEmps']));
		$addGross = floatval($database->charEncoder($_GET['addGross']));
		$addNet = floatval($database->charEncoder($_GET['addNet']));

		$sql = "SELECT Amount, NetAmount FROM vouchercurrent WHERE TrackingNumber = '".$pmTrackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$pmAmount = $data['Amount'];
		$pmNet = $data['NetAmount'];

		$sql = "SELECT NumOfEmps FROM particulars WHERE TrackingNumber = '".$pmTrackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$totalEmps = $data['NumOfEmps'];
		
		$newAmount = $pmAmount + $addNet;
		$newNet = $pmNet + $addNet;
		$newTotalEmps = $totalEmps + $addEmps;



		$sql = "INSERT INTO chequerist.paymaster (PMTrackYear, PMTrackingNumber, PMClaimant, PMFund, PMWindow, PMNumOfEmps, PMTotalNet, AddedProgram, AddedOBR_Number, AddedAccount, AddedADV, AddedDocumentType, AddedTrackYear, AddedTrackingNumber, AddedClaimant, AddedOfficeAssigned, AddedNumOfEmps, AddedGross, AddedNet, AddedPeriod)
				VALUES
				('".$year."','".$pmTrackingNumber."','".$officer."','".$fund."','".$window."','".$newTotalEmps."','".$newNet."','".$addProgram."','".$addOBR."','".$addAccount."','".$addADV."','".$addDocType."','".$year."','".$addTrackingNumber."','".$addClaimant."','".$addOfficeAssigned."','".$addEmps."','".$addGross."','".$addNet."','".$addPeriod."')
				";
		$database->query($sql);

		// sa gi-add na tracking sa paymaster
		$sql = "UPDATE particulars SET NumOfEmps = '".$addEmps."', OfficeAssigned = '".$addOfficeAssigned."' WHERE TrackingNumber = '".$addTrackingNumber."'";
		$database->query($sql);

		// sa gi-add na tracking sa paymaster - halted kay case kung previous year ang tracking then ang paymaster kay current year ang tracking partner na mabutang kay dli mao ang tuig.
		$sql = "UPDATE vouchercurrent SET TrackingPartner = '".$pmTrackingNumber."', NetAmount = '".$addNet."' WHERE TrackingNumber = '".$addTrackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE vouchercurrent SET Amount = '".$newNet."', NetAmount = '".$newNet."' WHERE TrackingNumber = '".$pmTrackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE particulars SET NumOfEmps = '".$newTotalEmps."' WHERE TrackingNumber = '".$pmTrackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE chequerist.paymaster SET PMNumOfEmps = '".$newTotalEmps."', PMTotalNet = '".$newNet."' WHERE PMTrackYear = '".$year."' AND PMTrackingNumber = '".$pmTrackingNumber."'";
		$database->query($sql);

		echo $pmTrackingNumber;
	}

	if(isset($_GET['pmRemoveThisDirect'])) {
		$pmTrackingNumber = $database->charEncoder($_GET['pmTrackingNumber']);

		$addTrackYear = $database->charEncoder($_GET['addTNYear']);
		$addTrackingNumber = $database->charEncoder($_GET['addTN']);
		$addEmps = intval($database->charEncoder($_GET['addEmps']));
		$addNet = floatval($database->charEncoder($_GET['addNet']));

		$sql = "SELECT Amount, NetAmount FROM vouchercurrent WHERE TrackingNumber = '".$pmTrackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$pmAmount = $data['Amount'];
		$pmNet = $data['NetAmount'];

		$sql = "SELECT NumOfEmps FROM particulars WHERE TrackingNumber = '".$pmTrackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$totalEmps = $data['NumOfEmps'];
		
		$newAmount = $pmAmount - $addNet;
		$newNet = $pmNet - $addNet;
		$newTotalEmps = $totalEmps - $addEmps;

		$sql = "DELETE FROM chequerist.paymaster WHERE AddedTrackYear = '".$addTrackYear."' AND AddedTrackingNumber = '".$addTrackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE vouchercurrent SET TrackingPartner = null WHERE TrackingNumber = '".$addTrackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE vouchercurrent SET Amount = '".$newNet."', NetAmount = '".$newNet."' WHERE TrackingNumber = '".$pmTrackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE particulars SET NumOfEmps = '".$newTotalEmps."' WHERE TrackingNumber = '".$pmTrackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE chequerist.paymaster SET PMNumOfEmps = '".$newTotalEmps."', PMTotalNet = '".$newNet."' WHERE PMTrackYear = '".$year."' AND PMTrackingNumber = '".$pmTrackingNumber."'";
		$database->query($sql);

		echo $pmTrackingNumber;
	}

	if(isset($_GET['pmRemoveThisDirectInTracker'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		$sql = "SELECT NetAmount, TrackingPartner FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$tnNet = floatval($data['NetAmount']);
		$tnPartner = $data['TrackingPartner'];

		$sql = "SELECT Amount, NetAmount FROM vouchercurrent WHERE TrackingNumber = '".$tnPartner."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$pmNet = floatval($data['Amount']);
		$pmAmount = floatval($data['NetAmount']);

		$newPMNet = $pmNet - $tnNet;
		$newPMAmount = $newPMNet;

		$sql = "SELECT NumOfEmps FROM particulars WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$tnEmps = intval($data['NumOfEmps']);

		$sql = "SELECT NumOfEmps FROM particulars WHERE TrackingNumber = '".$tnPartner."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$pmEmps = intval($data['NumOfEmps']);

		$newEmps = $pmEmps - $tnEmps;

		$sql = "UPDATE vouchercurrent SET Amount = '".$newPMAmount."', NetAmount = '".$newPMNet."' WHERE TrackingNumber = '".$tnPartner."'";
		$database->query($sql);

		$sql = "UPDATE particulars SET NumOfEmps = '".$newEmps."' WHERE TrackingNumber = '".$tnPartner."'";
		$database->query($sql);

		$sql = "UPDATE vouchercurrent SET TrackingPartner = null WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		$sql = "DELETE FROM chequerist.paymaster WHERE AddedTrackYear = '".$year."' AND AddedTrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE chequerist.paymaster SET PMNumOfEmps = '".$newEmps."', PMTotalNet = '".$newPMNet."' WHERE PMTrackYear = '".$year."' AND PMTrackingNumber = '".$tnPartner."'";
		$database->query($sql);

		echo $tnPartner;

	}

	// if(isset($_GET['editPaymaster'])){
	// 	$tn = $database->charEncoder($_GET['tn']);
	// 	$total = 0;

	// 	// $sql = "SELECT TrackingNumber, Claimant, Amount, TotalAmountMultiple, NetAmount FROM vouchercurrent WHERE TrackingPartner = '".$tn."' GROUP BY TrackingNumber";
	// 	// $record = $database->query($sql); 

	// 	$sql = "SELECT Amount, NetAmount FROM vouchercurrent WHERE TrackingNumber = '".$tn."' LIMIT 1";
	// 	$record = $database->query($sql);
	// 	$data = $database->fetch_array($record);
	// 	$pmAmount = floatval($data['Amount']);
	// 	$pmNet = floatval($data['NetAmount']);

	// 	$sql = "SELECT NumOfEmps FROM particulars WHERE TrackingNumber = '".$tn."' LIMIT 1";
	// 	$record1 = $database->query($sql); 
	// 	$data1 = $database->fetch_array($record1);
	// 	$totalEmps = $data1['NumOfEmps'];

	// 	$sheet = "<div class = 'editorContainer'>
	// 				<table class='editorTable' border='0' cellpadding='0' cellspacing='0' style = 'font-family:Oswald;text-align:right;'>
	// 					<tr>
	// 						<td class = 'editorHeader' colspan = '2' style = 'text-align:left;' >
	// 							Editor<div id='editorPaymasterX' onclick ='closeAbsolute(this)' class = 'closeEditor'></div>
	// 						</td>
	// 					</tr>
	// 					<tr>
	// 						<td colspan ='1' style ='padding:5px;'></td>
	// 					</tr>
	// 					<tr>
	// 						<td style='padding:0px 10px;'>
	// 							<table border='0' cellpadding='0' cellspacing='0' style='text-align:right; font-size:16px; line-height:18px; letter-spacing:1px;'>
	// 								<tr>
	// 									<td colspan='2' style='text-align:left; padding:2px 5px; font-weight:bold; color:rgb(64, 161, 202); border-bottom:1px solid silver;'>Current</td>
	// 								</tr>
	// 								<tr>
	// 									<td style='padding:2px 5px;'>Gross Amount&nbsp;:</td>
	// 									<td style='padding:2px 5px; font-weight:bold; border-bottom:1px dashed gray;'>".$database->toNumberFormat($pmAmount)."</td>
	// 								</tr>
	// 								<tr>
	// 									<td style='padding:2px 5px;'>Net Amount&nbsp;:</td>
	// 									<td style='padding:2px 5px; font-weight:bold; border-bottom:1px dashed gray;'>".$database->toNumberFormat($pmNet)."</td>
	// 								</tr>
	// 								<tr>
	// 									<td style='padding:2px 5px;'>Employees&nbsp;:</td>
	// 									<td id='payEmpsCur' style='padding:2px 5px; font-weight:bold; border-bottom:1px dashed gray; text-align:left;'>".$database->zeroToNothing($totalEmps)."</td>
	// 								</tr>
	// 							</table>
	// 						</td>
	// 						<td style='padding:0px 10px; vertical-align:bottom;'>
	// 							<span style='margin-right:8px;font-family:oswald;'>Search PY TN#</span>
	// 							<input type='text' id='searchPYPay1' maxlength='9' class='text3' style = 'width:150px;font-weight: bold;font-family:oswald; padding:2px 5px; font-size: 22px;text-align:center;' id='' onkeydown='keypressAndWhatClear(this,event,getPYDetailsForPAY1,1)'>
	// 						</td>
	// 					</tr>
	// 					<tr>
	// 						<td colspan='2' style=''>
	// 							<div style='height:500px; overflow-x:scroll;'>
	// 								<table border='0' cellpadding='0' cellspacing='0' style='margin:0px auto;width:780px;'>
	// 									<tr>
	// 										<td style='padding:0px 10px;'>
	// 											<table id='paymasterList1' class='tableRetVal' border='0' cellpadding='0' cellspacing='0'>
	// 												<thead style='background-color:rgba(150,150,150,.1); letter-spacing:1px;'>
	// 													<th style='border-bottom: 1px solid rgba(0,0,0,.2);padding:3px 10px; width:10px;'>Tracking&nbsp;No.</th>
	// 													<th style='border-bottom: 1px solid rgba(0,0,0,.2);padding-left:10px;'>Claimant</th>
	// 													<th style='border-bottom: 1px solid rgba(0,0,0,.2);padding-left:10px;'>Office</th>
	// 													<th style='border-bottom: 1px solid rgba(0,0,0,.2);width:10px;text-align:right;padding:0px 5px;'>Employees&nbsp;<span style='color:red; font-weight:normal; font-size:14px;'>(<span id='payEmpsNum1'>0</span>)</span></th>
	// 													<th style='border-bottom: 1px solid rgba(0,0,0,.2);width:100px; text-align:right; padding:0px 10px;'>Gross Amount</th>
	// 													<th style='border-bottom: 1px solid rgba(0,0,0,.2);width:100px; text-align:right; padding:0px 10px;'>Net Amount</th>
	// 													<th style='border-bottom: 1px solid rgba(0,0,0,.2);padding: 0px 10px;width:10px;'></th>
	// 												</thead>
	// 												<tbody style = 'background-color:white;'></tbody>
	// 											</table>
	// 										</td>
	// 									</tr>
	// 									<tr id='totalTrPay' style=''>
	// 										<td style='text-align:right; padding:0px 10px; padding-right:46px;'>
	// 											<table border='0' cellpadding='0' cellspacing='0' style='margin:0px 0px 0px auto; text-align:right;'>
	// 												<tr>
	// 													<td style='padding:2px 5px;'>Total Added</td>
	// 													<td id='paymasterTotal1' style='padding:2px 5px; color:rgb(24, 167, 219); font-weight:bold; font-size:18px;'>0.00</td>
	// 												</tr>
	// 												<tr>
	// 													<td style='padding:2px 5px;'>Current Total</td>
	// 													<td id='paymasterTotalOld' style='padding:2px 5px; font-weight:bold; font-size:18px;'>".$database->toNumberFormat($pmNet)."</td>
	// 												</tr>
	// 												<tr>
	// 													<td style='padding:2px 5px;'>Grand Total</td>
	// 													<td id='paymasterGrandTotal' style='padding:2px 5px; color:red; font-weight:bold; font-size:18px;'>".$database->toNumberFormat($pmNet)."</td>
	// 												</tr>
	// 											</table>
	// 										</td>
	// 									</tr>
	// 									<tr id='' style=''>
	// 										<td  colspan='3' style='text-align:center;'>
	// 											<input disabled id='claimantPAY'  type='text' value='TBA' style='display:none;'/>
	// 											<div style = 'display:inline-block;' class = 'button1' onclick = 'clearTrackingPaymaster(\"".$tn."\")'>Clear</div>
	// 											<div style = 'margin-left:20px; display:inline-block;' class = 'button1' onclick = 'updateTrackingPaymaster(\"".$tn."\")'>Update</div>
	// 										</td>
	// 									</tr>
	// 								</table>
	// 							</div>
	// 						</td>
	// 					</tr>
	// 				</table>
	// 			  </div>";

		
	// 	echo $sheet;
	// }

	// if(isset($_GET['updateTrackingPaymaster'])){
	// 	$gross = floatval($database->charEncoder($_GET['gross']));
	// 	$grossOld = floatval($database->charEncoder($_GET['grossOld']));
	// 	$addedGross = 0;
	// 	$newGross = 0;
	// 	$period = date("F");

	// 	$rows = explode('~', $database->charEncoder($_GET['payDetails']));
	// 	$tn = $database->charEncoder($_GET['tn']);
	// 	$totalEmps = $database->charEncoder($_GET['empsNum']);
		
	// 	$updatePart1 = "";
	// 	$updatePart2 = "";
	// 	$updateCase = "";
	// 	for ($i=0; $i < sizeof($rows); $i++) { 
	// 		$data = explode('*pm*', $rows[$i]);

	// 		$tnPay = $data[0];
	// 		$claimantPay = $data[1];
	// 		$amount = floatval($data[2]);
	// 		$empsNum = $data[3];
	// 		$officeAssigned = $data[4];

	// 		$addedGross += $amount;
	// 		$updateCase .= ",'".$tnPay."'";
	// 		$updatePart1 .= " WHEN TrackingNumber = '".$tnPay."' THEN '".$empsNum."'";
	// 		$updatePart2 .= " WHEN TrackingNumber = '".$tnPay."' THEN '".$officeAssigned."'";
	// 	}

	// 	$newGross = $grossOld + $addedGross;

	// 	if($gross == round($newGross, 2) ){
	// 		$sql = "UPDATE particulars SET NumOfEmps = CASE".$updatePart1." END WHERE TrackingNumber IN (".substr($updateCase, 1).")";
	// 		$database->query($sql);

	// 		$sql = "UPDATE particulars SET OfficeAssigned = CASE".$updatePart2." END WHERE TrackingNumber IN (".substr($updateCase, 1).")";
	// 		$database->query($sql);

	// 		$sql = "UPDATE ".$db."vouchercurrent SET Amount = '".$newGross."', NetAmount = '".$newGross."' where TrackingNumber = '".$tn."'";
	// 		$database->query($sql);
			
	// 		$sql = "UPDATE particulars SET NumOfEmps = '".$totalEmps."' WHERE TrackingNumber = '".$tn."'";
	// 		$database->query($sql);

	// 		$update = "UPDATE vouchercurrent SET TrackingPartner = '".$tn."' WHERE TrackingNumber IN (".substr($updateCase, 1).")";
	// 		$database->query($update);

	// 		$database->EditLogs2018($tn,"Cash Advance Details","Undetermined","Undetermined",$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded,$db);
	// 		echo $tn."*j*";
	// 	}else{
	// 		echo $tn."*j*Amount mismatch. Please repeat the process.";
	// 	}
		
	// }

	// if(isset($_GET['clearTrackingPaymaster'])){
	// 	$trackingNumber = $database->charEncoder($_GET['tn']);

	// 	$sql = "UPDATE vouchercurrent SET TrackingPartner = null WHERE TrackingPartner = '".$trackingNumber."'";
	// 	$database->query($sql);

	// 	$sql = "UPDATE vouchercurrent SET Amount = '0.00', NetAmount = '0.00' WHERE TrackingNumber = '".$trackingNumber."'";
	// 	$database->query($sql);

	// 	$sql = "UPDATE particulars SET NumOfEmps = '0' WHERE TrackingNumber = '".$trackingNumber."'";
	// 	$database->query($sql);

	// 	echo $trackingNumber;
	// }

	// if(isset($_GET['pmRemoveThisDirect'])){
	// 	$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

	// 	$sql = "SELECT NetAmount, TrackingPartner FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
	// 	$record = $database->query($sql);
	// 	$data = $database->fetch_array($record);
	// 	$tnNet = floatval($data['NetAmount']);
	// 	$tnPartner = $data['TrackingPartner'];

	// 	$sql = "SELECT Amount, NetAmount FROM vouchercurrent WHERE TrackingNumber = '".$tnPartner."' LIMIT 1";
	// 	$record = $database->query($sql);
	// 	$data = $database->fetch_array($record);
	// 	$pmNet = floatval($data['Amount']);
	// 	$pmAmount = floatval($data['NetAmount']);

	// 	$newPMNet = $pmNet - $tnNet;
	// 	$newPMAmount = $newPMNet;

	// 	$sql = "SELECT NumOfEmps FROM particulars WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
	// 	$record = $database->query($sql);
	// 	$data = $database->fetch_array($record);
	// 	$tnEmps = intval($data['NumOfEmps']);

	// 	$sql = "SELECT NumOfEmps FROM particulars WHERE TrackingNumber = '".$tnPartner."' LIMIT 1";
	// 	$record = $database->query($sql);
	// 	$data = $database->fetch_array($record);
	// 	$pmEmps = intval($data['NumOfEmps']);

	// 	$newEmps = $pmEmps - $tnEmps;

	// 	$sql = "UPDATE vouchercurrent SET Amount = '".$newPMAmount."', NetAmount = '".$newPMNet."' WHERE TrackingNumber = '".$tnPartner."'";
	// 	$database->query($sql);

	// 	$sql = "UPDATE particulars SET NumOfEmps = '".$newEmps."' WHERE TrackingNumber = '".$tnPartner."'";
	// 	$database->query($sql);

	// 	$sql = "UPDATE vouchercurrent SET TrackingPartner = null WHERE TrackingNumber = '".$trackingNumber."'";
	// 	$database->query($sql);

	// 	echo $tnPartner;

	// }
	//---------------------------------------------------------------------------------------------------PAYMASTER - END
	
	//---------------------------------------------------------------------------------------------------PUBLIC SEARCH - START
	if(isset($_GET['publicSearchPayroll'])){
		$key =  $database->charEncoder($_GET['searchKey']);
		$year = intval($database->charEncoder($_GET['year']));
		
		$db = $database->getDB($year);

		if(substr($key, 4, 1) == "-"){
			$sql = "SELECT DocumentType FROM " . $db . ".vouchercurrent WHERE TrackingNumber = '".$key."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);

			if(substr($data['DocumentType'], 0, 5) == "WAGES"){
				$sql = "SELECT a.*,b.Name,c.LastName,c.FirstName,c.MiddleName
								FROM " . $db . ".vouchercurrent a 
								left join " . $db . ".office b on a.office = b.code  
								left join citydoc.employees c on a.encodedby = c.employeenumber
								where trackingnumber  = '" . $key . "' limit 1";
				$record = $database->query($sql);
				if($database->num_rows($record) > 0){
					// echo $sheet->CreatePublicInfo($record,1);	
					echo $sheet->CreatePublicTableMultiple1($record, "", 1);
				}	
			}else{
				echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
			}
		}elseif(is_numeric($key) == 1){
			// employees > sp_transaction_details && rp_transaction_details > sp_transaction_header
			$sql = "SELECT lastname, firstname, extension, middlename FROM brgs.employees WHERE empno = '".$key."' LIMIT 1";
			$record = $database->query($sql);

			if($database->num_rows($record) > 0){
				$data = $database->fetch_array($record);
				
				$mname = "";
				if($data['middlename'] != ""){
					$mname = $data['middlename'][0].".";
				}
				$fullName = $data['lastname'].", ".$data['firstname']." ".$mname." ".$data['extension'];

				$headerId = "";
				$sql = "SELECT a.* FROM 
						(
						SELECT header_id FROM brgs.rp_transaction_details WHERE empno = '".$key."'
						UNION
						SELECT header_id FROM brgs.sp_transaction_details WHERE empno = '".$key."'
						) a
						ORDER BY a.header_id DESC LIMIT 30
						;";
				$record = $database->query($sql);

				while($data = $database->fetch_array($record)){
					$headerId .= ",\"".$data['header_id']."\"";
				}
				$headerId = substr($headerId, 1);

				$trackingNumbers = "";
				$sql = "SELECT TrackingNumber FROM brgs.sp_transaction_header WHERE trackingYear = '".$year."' AND id IN (".$headerId.") ORDER BY id DESC";
				$record = $database->query($sql);
				$count = $database->num_rows($record);
				if($count > 0){
					while($data = $database->fetch_array($record)){
						$trackingNumbers .= ",\"".$data['TrackingNumber']."\"";
					}
					$trackingNumbers = substr($trackingNumbers, 1);
					$sql = "SELECT 	a.TrackingNumber, a.TrackingType, a.Year, a.Fund, a.ClaimType, a.Office, a.PR_CategoryCode, a.EncodedBy,
									a.OBR_Number, a.PO_Number, a.PR_Number, a.ADV1, a.Remarks, a.DateEncoded, a.Completion, a.PR_Month, 
									b.Name, a.Claimant, a.DocumentType, a.PeriodType, a.PeriodMonth, a.Status, a.DateModified
							FROM ".$db.".vouchercurrent a
							INNER JOIN ".$db.".office b on a.Office = b.Code
							WHERE a.TrackingNumber IN (".$trackingNumbers.") GROUP BY a.TrackingNumber ORDER BY a.DateModified DESC";
					$record = $database->query($sql);
					echo $sheet->CreatePublicTableMultiple1($record, $fullName, $database->num_rows($record));
				}else{
					echo "<div class = 'wiggle' style = 'color:white;font-size:48px; display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
				}
			}else{
				echo "<div class = 'wiggle' style = 'color:white;font-size:48px; display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
			}
		}else{
			$temp = explode("*j*", $key);

			if(sizeof($temp) > 1) {
				$lname = $temp[0];
				$fname = $temp[1];
				$sql = "SELECT empno, lastname, firstname, extension, middlename
						 FROM brgs.employees WHERE lastname = '".$lname."' AND firstname = '".$fname."' LIMIT 1";
				$record = $database->query($sql);
				  
				if($database->num_rows($record) == 1){
					$data = $database->fetch_array($record);
					$empno =$data['empno'];
	
					$mname = "";
					if($data['middlename'] != ""){
						$mname = $data['middlename'][0].".";
					}
					$fullName = $data['lastname'].", ".$data['firstname']." ".$mname." ".$data['extension'];
						
					
					$headerId = "";
	
					$sql = "SELECT a.* FROM 
							(
							SELECT header_id FROM brgs.rp_transaction_details WHERE empno = '".$empno."'
							UNION
							SELECT header_id FROM brgs.sp_transaction_details WHERE empno = '".$empno."'
							) a
							ORDER BY a.header_id DESC LIMIT 30
							;";
					$record = $database->query($sql);
	
					while($data = $database->fetch_array($record)){
						$headerId .= ",\"".$data['header_id']."\"";
					}
					$headerId = substr($headerId, 1);
	
					$trackingNumbers = "";
					$sql = "SELECT TrackingNumber FROM brgs.sp_transaction_header WHERE trackingYear = '".$year."' AND id IN (".$headerId.") ORDER BY id DESC";
					$record = $database->query($sql);
					$count = $database->num_rows($record);
					if($count > 0){
						while($data = $database->fetch_array($record)){
							$trackingNumbers .= ",\"".$data['TrackingNumber']."\"";
						}
						$trackingNumbers = substr($trackingNumbers, 1);
						$sql = "SELECT 	a.TrackingNumber, a.TrackingType, a.Year, a.Fund, a.ClaimType, a.Office, a.PR_CategoryCode, a.EncodedBy,
										a.OBR_Number, a.PO_Number, a.PR_Number, a.ADV1, a.Remarks, a.DateEncoded, a.Completion, a.PR_Month, 
										b.Name, a.Claimant, a.DocumentType, a.PeriodType, a.PeriodMonth, a.Status, a.DateModified
								FROM ".$db.".vouchercurrent a
								INNER JOIN ".$db.".office b on a.Office = b.Code
								WHERE a.TrackingNumber IN (".$trackingNumbers.") GROUP BY a.TrackingNumber ORDER BY a.DateModified DESC";
						$record = $database->query($sql);
						echo $sheet->CreatePublicTableMultiple1($record, $fullName, $database->num_rows($record));
					}else{
						echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
					}
						
				}else{
					if($database->num_rows($record) > 1){
						echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Multiple Employees found. Please use employee number instead.</div>";
					}else{
						echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
					}
				}
				
			}else{
				echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
			}

		}
	}
	//---------------------------------------------------------------------------------------------------PUBLIC SEARCH - END

	//---------------------------------------------------------------------------------------------------RETRACKING - START
	if(isset($_GET['rtkTransferTracking'])){
		$srcYear = $database->charEncoder($_GET['source']);
		$rcvYear = $database->charEncoder($_GET['receiver']);
		$tn = $database->charEncoder($_GET['tn']);
		$officeRtk = $database->charEncoder($_GET['office']);

		$sourceDB = $database->getDB($srcYear);
		$receivDB = $database->getDB($rcvYear);

		// Checking sa kung na-transfer na ba
		$sql0 = "SELECT * FROM ".$sourceDB.".voucherhistory WHERE TrackingNumber = '".$tn."' and Status = 'Transferred'";
		$result0 = $database->query($sql0);

		if($database->num_rows($result0) > 0){
			echo 0;
		}else{
			// Checking kung PO ba ni
			$sql1 = "SELECT TrackingNumber, TrackingType, PR_TrackingNumber FROM ".$sourceDB.".vouchercurrent where TrackingNumber = '".$tn."' LIMIT 1";
			$result1 = $database->query($sql1);
			$data1 = $database->fetch_array($result1);

			// If pag PO ang i-transfer ang gamiton pagkuha sa mga rows both PR and PO kay ang PR_TrackingNumber
			if($data1['TrackingType'] == "PO"){
				$tn = $data1['PR_TrackingNumber'];
			}

			// Pag kuha sa mga rows gamit tn sa PR, PO, or PY
			$sql1 = "SELECT TrackingNumber, TrackingType FROM ".$sourceDB.".vouchercurrent where TrackingNumber = '".$tn."' or PR_TrackingNumber = '".$tn."'";
			$result1 = $database->query($sql1);
			

			if($database->num_rows($result1) > 0){
				$vcrColumns = $database->getDBTableCols($sourceDB, "vouchercurrent");
				$vcrColumns = str_replace('Id,', '', $vcrColumns);

				if($rcvYear < 2022){
					$vcrColumns = str_replace('BatchTracking,', '', $vcrColumns);
					$vcrColumns = str_replace('FundYear,', '', $vcrColumns);
					$vcrColumns = str_replace('InfraJevAmount,', '', $vcrColumns);
					$vcrColumns = str_replace(',InfraId', '', $vcrColumns);
					$vcrColumns = str_replace(',InfraPeaceOfficeId', '', $vcrColumns);
				}


				$vcrColumnsArr = explode(",", $vcrColumns);

				$curTN = "";

				$tnForCancel = "";
				$insert8 = "";

				while($data = $database->fetch_array($result1)){

					$loopTN = $data['TrackingNumber'];
					$loopType = $data['TrackingType'];

					$sql2 = "SELECT * FROM ".$sourceDB.".vouchercurrent where TrackingNumber = '".$loopTN."'";
					$result2 = $database->query($sql2);

					if($curTN == "" || $curTN != $data['TrackingNumber']){
						if($loopType == "PR"){
							$field = "PR";
							$tnPref = "PR-";		
						}else{
							$field = "Doctrack";
							$tnPref = "";		
						}
						$sql = "SELECT concat('".$tnPref."', Code,'-', (".$field.")) as newTN, concat('".$tnPref."', Code,'-', (".$field." + 1)) as nxtTN FROM ".$receivDB.".office where Code = '".$officeRtk."'";
						$record = $database->query($sql);
						$row = $database->fetch_array($record);
						$newTN  = $row['newTN'];
						$nxtTN  = $row['nxtTN'];

						if($loopType == "PR"){
							$updateCase = "PR = PR + 1";
							$database->IncrementTrackingSeriesRTK($receivDB,$updateCase,$officeRtk);
						}else{
							$updateCase = "Doctrack = Doctrack + 1";
							$database->IncrementTrackingSeriesRTK($receivDB,$updateCase,$officeRtk);
						}

						$curTN = $data['TrackingNumber'];

						if($loopType == "PR"){
							$primPR = $newTN;
						}	

						$tnForCancel .= ",'".$loopTN."'";

						$status = "Transferred";
						$completion = '';
						$insert8 .= ",('" . $loopTN . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $completion . "')";
					}
						


					// Mao ni ang loop sa "vouchercurrent"
					if($database->num_rows($result2) > 0){
						$insert = $database->stringifyForDB($result2, $vcrColumnsArr, $loopType, $newTN, $primPR);
						$sql3 = "INSERT INTO ".$receivDB.".vouchercurrent(".$vcrColumns.") VALUES ".$insert;
						$result3 = $database->query($sql3);
						
					}

					// Mao ni ang loop sa "prrecord" ug "porecord"
					if($loopType != "PY"){
						$dbTable = "";
						if($loopType == "PR"){
							$dbTable = "prrecord";
						}else{
							$dbTable = "porecord";
						}
						$itmColumns = $database->getDBTableCols($sourceDB, $dbTable);
						$itmColumns = str_replace('Id,', '', $itmColumns);
						$itmColumnsArr = explode(",", $itmColumns);

						$sql11 = "SELECT Id FROM ".$receivDB.".".$dbTable." WHERE TrackingNumber = '".$newTN."'";
						$result11 = $database->query($sql11);
						
						if($database->num_rows($result11) == 0){
							$sql5 = "SELECT * FROM ".$sourceDB.".".$dbTable." WHERE TrackingNumber = '".$loopTN."'";
							$result5 = $database->query($sql5);

							$insert1 = $database->stringifyForDB($result5, $itmColumnsArr, $loopType, $newTN, $primPR);
							$sql6 = "INSERT INTO ".$receivDB.".".$dbTable."(".$itmColumns.") VALUES ".$insert1;
							$result6 = $database->query($sql6);
						}
					}
				}

				$sql7 = "UPDATE ".$sourceDB.".vouchercurrent SET Status = 'Cancelled' WHERE Trackingnumber IN (".substr($tnForCancel,1).")";
				$result7 = $database->query($sql7);
				
				$sql8 = "Insert into ".$sourceDB.".voucherhistory (TrackingNumber,ModifiedBy,DateModified,Status,Completion) values ".substr($insert8, 1);
				$result8 = $database->query($sql8);

				if($primPR != ""){
					echo "PR"."~".$primPR;
				}else{
					echo $nxtTN."~".$newTN;
				}

			}else{
				echo 2;
			}
		}

	}

	

	if(isset($_GET['selectNewDoctrackRTK'])){
		$type = $database->charEncoder($_GET['type']);
		$office = $database->charEncoder($_GET['office']);
		$rcvYear = $database->charEncoder($_GET['receiver']);
		$receivDB = $database->getDB($rcvYear);

		if($type == "optPR"){ // pag pr ang gi pili
			$condition = " where Code = '" . $office . "' and Code = '".$office."'";
			$field = "PR";		
			$sql = "Select " . $field . " from ".$receivDB.".office " . $condition;
			$record = $database->query($sql);
			$data = $database->fetch_array($record);

			$count = $data['PR'] + 1;
			$id  = "PR-" . $office . "-" . $count;
			
			if($database->num_rows($record) > 0){
				echo $type . '*' . $id;
			}else{
				echo 0;
			}
		}else{ // pag po og py ang gi pili
			$condition = " where Code = '" . $office . "' and Code = '".$office."'";
			$field = "Doctrack";
			$sql = "Select " . $field . " from ".$receivDB.".office " . $condition;
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			
			$count = $data['Doctrack'] + 1;
			$id  =  $office . "-" . $count;
			
			if($database->num_rows($record) > 0){
				echo $type . '*' . $id;
			}else{
				echo 0;
			}
		}
	}
	//---------------------------------------------------------------------------------------------------RETRACKING - END

	//---------------------------------------------------------------------------------------------------MULTIPLE LIQUIDATION - START
		
	if (isset($_GET['saveTrackingMLQ'])) {
		$caBreakdown = $database->charEncoder($_GET['caBreakdown']);
		$caBreakdown = explode("*j*", $caBreakdown);


		$cashAdvanceAmount = $database->charEncoder($_GET['caAmount']);
		$cashAdvanceSpent = $database->charEncoder($_GET['caSpent']);
		$cashAdvanceRefund = $database->nullToZero($database->charEncoder($_GET['caRefund']));
		$cashAdvanceReim = $database->nullToZero($database->charEncoder($_GET['caReim']));
		$cashAdvanceClaimant = $database->charEncoder($_GET['claimant']);
		
		
		$trackType = 'PY';
		$chargeType = 0;
		$fund = "";
		$docType = 'Liquidation';
		$claimType = 'Others';
		
		
		$periodType = "Monthly";
		$periodValue = date('F');
		$status = "Encoded";
		 
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 

		$cashAdvanceTracking = "";
		$cashAdvanceORDetail = "";
		$insertToLiquidation = "";
		for ($i=0; $i < sizeof($caBreakdown); $i++) { 
			$temp = explode("~", $caBreakdown[$i]);
			$caTn 	 = $temp[0];
			$spent   = floatval($temp[1]);
			$refund  = floatval($temp[2]);
			$reimbrs = floatval($temp[3]);
			$orDets  = $temp[4];

			$cashAdvanceTracking .= ",'".$caTn."'";
			if($orDets != ""){
				$cashAdvanceORDetail .= ",".$orDets;
			}
			$insertToLiquidation .= ",('".$trackingNumber."','".$caTn."','".$spent."','".$refund."','".$reimbrs."','".$orDets."')";
		}
		$cashAdvanceTracking = substr($cashAdvanceTracking, 1);
		$cashAdvanceORDetail = substr($cashAdvanceORDetail, 1);
		$insertToLiquidation = substr($insertToLiquidation, 1);
		
		//update cash advance partner
		$sql = "Update vouchercurrent  set TrackingPartner = '" . $trackingNumber . "'  where TrackingNumber in (".$cashAdvanceTracking.")";
		$database->query($sql);

		$tnPartner = str_replace("'", "", $cashAdvanceTracking);
		if(substr_count($cashAdvanceTracking, ",") > 0){
			$tnPartner = "Multiple";
		}

		//pagsave sa record
		$insertCase = "Insert into vouchercurrent (TrackingPartner,Year,Office,TrackingNumber,TrackingType,Fund,DocumentType,ClaimType,Claimant,Amount,ChargeType,PeriodType,PeriodMonth,EncodedBy,DateEncoded,Status,DateModified)VALUES 
						('" . $tnPartner . "','" . $defaultYear . "','" . $office . "','" . $trackingNumber . "','" . $trackType . "','" . $fund . "','" . $docType . "','" . $claimType . "','" . $cashAdvanceClaimant . "','" . $cashAdvanceSpent . "','" . $chargeType . "','"  .   $periodType . "','" . $periodValue . "','" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "')";
		$database->query($insertCase);

		
		$sql = "Insert into particulars (trackingnumber)values ('" . $trackingNumber  . "')";
		$database->query($sql);

		// $sql = "Insert into liquidation (TrackingNumber,CashAdvanceTN,Spent,Refund,Reimbursement,ORdetails)values ('" . $trackingNumber  . "',
		// 		'" . $cashAdvanceTracking . "','" . $cashAdvanceSpent . "','" . $cashAdvanceRefund . "','" . $cashAdvanceReim . "', '" . $cashAdvanceOR . "')";
		$sql = "Insert into liquidation (TrackingNumber,CashAdvanceTN,Spent,Refund,Reimbursement,ORdetails) values ".$insertToLiquidation;
		$database->query($sql);
		
		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~'. $trackingNumber;
		
	}

	if (isset($_GET['editTrackingMLQ'])) {
		$tn = $database->charEncoder($_GET['tn']);
		$tn = str_replace("editor", "", $tn);

		$condition = " where Code = '" . $office . "'";
		$field = "Doctrack";
		$record = $database->FetchDoctrackID($field,$condition);
		$data = $database->fetch_array($record);
		
		$count = $data['Doctrack'] + 1;
		$id  =  $office . "-" . $count;
		
		$sql = "Select TrackingNumber,Claimant,PeriodMonth,NetAmount as Gross from vouchercurrent 
				where 
				office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Petty Cash' and Checknumber > 0  or
				office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Foreign)' and Checknumber > 0  or
				office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Travel (Local)' and Checknumber > 0  or
				office = '" . $_SESSION['officeCode'] . "' and documenttype = 'Cash Advance - Special' and Checknumber > 0  
				group by trackingnumber order by dateencoded  desc ";		
		$record = $database->query($sql);	
		$select = $sheet->CreateSelectLiquidationMLQ($record, 2);

		$sql = "SELECT 
				a.TrackingNumber, 
				a.CashAdvanceTN, 
				b.PeriodMonth, 
				b.Claimant, 
				if(b.TotalAmountMultiple > 0, b.TotalAmountMultiple, b.Amount) as CashAdvance, 
				a.Spent,
				a.Refund,
				a.ORdetails,
				a.Reimbursement 
				FROM liquidation a
				LEFT JOIN vouchercurrent b ON a.CashAdvanceTN = b.TrackingNumber
				WHERE a.TrackingNumber = '".$tn."' GROUP BY CashAdvanceTN ORDER BY a.Id;";
		$record = $database->query($sql);

		$sheet = "";
		$totalCAmnt = 0;
		$totalSpent = 0;
		$totalRefnd = 0;
		$totalReimb = 0;

		$sheet .= "<div class='editorContainer' style='padding:25px;'>
					<div style='background-color:rgb(8, 149, 196); padding:10px;'>
					<span style='display:inline-block; color:white; letter-spacing:1px; text-shadow: 0px 0px 2px orange; font-family:Oswald; width:95%; text-align:left;'>Editor</span>
					<span style='display:inline-block;'><div id='closeEditorMLQ' onclick='closeAbsolute(this)' class='closeEditor'></div></span>
					</div>
					<div style='text-align:left; margin-top:15px;'><span class='numberField' style='margin-right:10px;'>Select Cash Advance</span>".$select."</div>
					<div style='text-align:left; margin-top:15px; padding-left:10px;'>
						Claimant
						<input disabled style='background-color:white;color:black;font-size:22px;padding-right:20px;border:0;border-bottom:1px dashed silver;padding-left:10px;font-weight: bold;width:0px;width:400px;margin-left:8px;' id='claimantMLQ1' value='*claimantHere*' class='data2' type='text'>
					</div>
					<table id='caListAddedMLQ1' class='tableRetVal' style='margin:15px auto;' border='0'>
					<thead>
						<tr>
							<th style='border-bottom:1px solid lightgray; padding:5px 10px 0px 10px;'>TN</th>
							<th style='border-bottom:1px solid lightgray; padding:5px 10px 0px 10px;'>Month</th>
							<th style='border-bottom:1px solid lightgray; padding:5px 10px 0px 10px;'>Claimant</th>
							<th style='border-bottom:1px solid lightgray; padding:5px 10px 0px 10px;'>Cash Advance</th>
							<th style='border-bottom:1px solid lightgray; padding:5px 10px 0px 10px;'>Spent</th>
							<th style='border-bottom:1px solid lightgray; padding:5px 10px 0px 10px;'>Refunded</th>
							<th style='border-bottom:1px solid lightgray; padding:5px 10px 0px 10px;'>O.R. Details</th>
							<th style='border-bottom:1px solid lightgray; padding:5px 10px 0px 10px;'>Reimbursement</th>
							<th style='border-bottom:1px solid lightgray; padding:5px 10px 0px 10px;'></th>
						</tr>
					</thead>
					<tbody style='background-color: white;'>";
		while ($data = $database->fetch_array($record)) {
			$caTN = $data['CashAdvanceTN'];
			$month = $data['PeriodMonth'];
			$claimant = $data['Claimant'];
			$caAmount = floatval($data['CashAdvance']);
			$spent = floatval($data['Spent']);
			$refund = floatval($data['Refund']);
			$orDetails = $data['ORdetails'];
			$reimbrs = floatval($data['Reimbursement']);

			$remove = "<i style='cursor:pointer;font-size:24px;font-weight:bold;color:red;' onclick='removeThisRowMLQ1(this)'></i>";


			$sheet .="<tr>
			   		  <td style='padding-left:10px; width:100px;'>
			   		  	<input name='caTNList1' value='".$caTN."' style='font-family:Oswald; width:100%; color:black; background-color:white; border:0px; font-size:14px; font-weight:bold; padding:0px;' disabled>
			   		  </td>
			   		  <td style='padding:0px 10px; font-size:14px;'>".$month."</td>
			   		  <td style='padding:0px 10px; font-size:14px;'>
						<span class='caNameList1'>".$claimant."</span>
			   		  </td>
			   		  <td style='padding-right:10px; font-size:14px; text-align:right;'>
			   			<input maxlength='16' name='mlqCAAmount1' class='data2' style='font-size:13px; width:110px; text-align:right; border:0px; background-color:white; color:black;' value='".number_format($caAmount,2)."' disabled>
			   		  </td>
			   		  <td style='padding:5px 5px;'>
			   			<input maxlength='16' name='mlqSpent1' onkeydown='return isAmount(this,event)' class='data2' style='font-size:13px; width:110px; text-align:right; border:0px; border-bottom:1px dashed black;' onkeyup='newKeyUpSpentMLQ1(this)' value='".number_format($spent,2)."'>
			   		  </td>
			   		  <td style='padding:5px 5px;'>
			   			<input maxlength='16' name='mlqRefund1' onkeydown='return isAmount(this,event)' class='data2' style='font-size:13px; width:110px; text-align:right; border:0px; border-bottom:1px dashed black; background-color:white;' value='".number_format($refund,2)."' disabled>
			   		  </td>
			   		  <td style='padding:5px 5px;'>
			   			<input maxlength='16' name='mlqORDetails1' onkeydown='return isAmount(this,event)' class='data2' style='font-size:13px; width:110px; text-align:right; border:0px; border-bottom:1px dashed black;' value='".$orDetails."'>
			   		  </td>
			   		  <td style='padding:5px 5px;'>
			   			<input maxlength='16' name='mlqReimbrsmnt1' onkeydown='return isAmount(this,event)' class='data2' style='font-size:13px; width:110px; text-align:right; border:0px; border-bottom:1px dashed black; background-color:white;' value='".number_format($reimbrs,2)."' disabled>
			   		  </td>
			   		  <td style='text-align:center;'>".$remove."</td>
			   		  </tr>";

			$totalCAmnt += $caAmount;
			$totalSpent += $spent;
			$totalRefnd += $refund;
			$totalReimb += $reimbrs;
		}
		$sheet .= "</tbody>
				   </table>
				   <div style='padding-right:20px; margin-bottom: 25px;'>
						<table border='0' style='border-spacing:0px; margin-right:0px; margin-left:auto;'>
						<tr>
							<td style='text-align:right;'>Cash Advance</td>
							<td>
								<input style = 'letter-spacing:1px; background-color:white;padding-right:20px;border:0;border-bottom:1px dashed silver;text-align: right;padding-left:10px;font-weight: bold;width:180px;' value='".number_format($totalCAmnt,2)."'  id  = 'cashAdvanceAmountMLQ1' disabled type ='text' class = 'data2'/>
							</td>
						</tr>
						<tr>
							<td style='text-align:right;'>Spent</td>
							<td>
								<input disabled style = 'background-color:white;letter-spacing:1px; padding-right:20px;border:0;border-bottom:1px dashed silver;text-align: right;padding-left:10px;font-weight: bold;width:180px;' value='".number_format($totalSpent,2)."'  id  = 'cashSpentMLQ1'  type ='text' class = 'data2'/>
							</td>
						</tr>
						<tr>
							<td style='text-align:right;'>Refunded</td>
							<td>
								<input disabled style = 'background-color:white;letter-spacing:1px; padding-right:20px;border:0;border-bottom:1px dashed silver;text-align: right;padding-left:10px;font-weight: bold;width:180px;' value='".number_format($totalRefnd,2)."'  id  = 'cashAdvanceRefundMLQ1' type ='text' class = 'data2'/>
							</td>
						</tr>
						<tr>
							<td style='text-align:right;'>To be Reimbursed</td>
							<td>
								 <input disabled style = 'background-color:white;letter-spacing:1px; padding-right:20px;border:0;border-bottom:1px dashed silver;text-align: right;padding-left:10px;font-weight: bold;width:180px;' value='".number_format($totalReimb,2)."'  id  = 'cashAdvanceReimbursedMLQ1' type ='text' class = 'data2'/>
							</td>
						</tr>
						</table>
				   </div>
				   <div class='button1 b1' onclick='saveMLQ1(\"".$tn."\")'>Save</div>
				   </div>
				   ";
		$sheet = str_replace("*claimantHere*", $claimant, $sheet);
		echo $sheet;
	}

	if (isset($_GET['updateTrackingMLQ'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);
		$caBreakdown = $database->charEncoder($_GET['caBreakdown']);
		$caBreakdown = explode("*j*", $caBreakdown);

		$cashAdvanceAmount = $database->charEncoder($_GET['caAmount']);
		$cashAdvanceSpent = $database->charEncoder($_GET['caSpent']);
		$cashAdvanceRefund = $database->nullToZero($database->charEncoder($_GET['caRefund']));
		$cashAdvanceReim = $database->nullToZero($database->charEncoder($_GET['caReim']));
		$cashAdvanceClaimant = $database->charEncoder($_GET['claimant']);

		$cashAdvanceTracking = "";
		$cashAdvanceORDetail = "";
		$insertToLiquidation = "";
		for ($i=0; $i < sizeof($caBreakdown); $i++) { 
			$temp = explode("~", $caBreakdown[$i]);
			$caTn 	 = $temp[0];
			$spent   = floatval($temp[1]);
			$refund  = floatval($temp[2]);
			$reimbrs = floatval($temp[3]);
			$orDets  = $temp[4];

			$cashAdvanceTracking .= ",'".$caTn."'";
			if($orDets != ""){
				$cashAdvanceORDetail .= ",".$orDets;
			}
			$insertToLiquidation .= ",('".$trackingNumber."','".$caTn."','".$spent."','".$refund."','".$reimbrs."','".$orDets."')";
		}
		$cashAdvanceTracking = substr($cashAdvanceTracking, 1);
		$cashAdvanceORDetail = substr($cashAdvanceORDetail, 1);
		$insertToLiquidation = substr($insertToLiquidation, 1);

		$tnPartner = str_replace("'", "", $cashAdvanceTracking);
		if(substr_count($cashAdvanceTracking, ",") > 0){
			$tnPartner = "Multiple";
		}

		// step 1: update ang values sa vouchercurrent - TrackingPartner => $tnPartner, Claimant => $cashAdvanceClaimant, Amount => $cashAdvanceSpent, ModifiedBy => $employeeNumber, DateModified => $dateEncoded
		$sql = "UPDATE vouchercurrent 
				SET 
				TrackingPartner = '".$tnPartner."', 
				Claimant = '".$cashAdvanceClaimant."', 
				Amount = '".$cashAdvanceSpent."', 
				ModifiedBy = '".$employeeNumber."', 
				DateModified = '".$dateEncoded."' 
				WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		// step 2: remove ang mga TrackingPartner na daan
		$sql = "UPDATE vouchercurrent SET TrackingPartner = null WHERE TrackingPartner = '".$trackingNumber."'";
		$database->query($sql);

		// step 3: update ang mga TrackingPartner sa new
		$sql = "UPDATE vouchercurrent SET TrackingPartner = '" . $trackingNumber . "'  WHERE TrackingNumber in (".$cashAdvanceTracking.")";
		$database->query($sql);

		// step 4: delete ang mga rows sa liquidation na table na naay TrackingNumber sa i-update
		$sql = "DELETE FROM liquidation WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		// step 5: insert ang mga new records sa liquidation na table
		$sql = "INSERT INTO liquidation (TrackingNumber, CashAdvanceTN, Spent, Refund, Reimbursement, ORdetails) VALUES ".$insertToLiquidation;
		$database->query($sql);

		// step 6: return ang TrackingNumber sa i-update
		echo $trackingNumber;

	}

	//---------------------------------------------------------------------------------------------------MULTIPLE LIQUIDATION - END
	
	if(isset($_GET['fetchCAOBRBreakdown'])){
		$tn = $database->charEncoder($_GET['tn']);

		$sql = "SELECT TrackingPartner FROM vouchercurrent WHERE TrackingNumber = '".$tn."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$tnPartner = $data['TrackingPartner'];

		if($tnPartner == null || $tnPartner == ""){

			$sql = "SELECT TrackingNumber, Amount, TotalAmountMultiple, PR_ProgramCode, PR_AccountCode
					FROM vouchercurrent
					WHERE TrackingNumber = '".$tn."'";
			$record = $database->query($sql);

			$rows = [];
			$prgs = [];
			$acct = [];
			$caTotal = 0;

			$prgsStr = "";
			$acctStr = "";
			while($data = $database->fetch_array($record)){
				$amount = $data['Amount'];
				$total = $data['TotalAmountMultiple'];
				$prgCode = $data['PR_ProgramCode'];
				$acctCode = $data['PR_AccountCode'];

				if(strpos($prgsStr, "'".$prgCode."'") != true){
					$prgsStr .= ",'".$prgCode."'";
				}else{
					$prgCode = "x";
				}

				$rows[] = $prgCode."*".$acctCode."*".$amount."*".$total;

				$caTotal += $amount;

				$acctStr .= ",'".$acctCode."'";

			}

			$prgsStr = substr($prgsStr, 1);
			$acctStr = substr($acctStr, 1);


			$sql = "SELECT Code, Name FROM programcode WHERE Code IN (".$prgsStr.")";
			$record = $database->query($sql);
			while($data = $database->fetch_array($record)){
				$prgs[strval($data['Code'])] = $data['Name'];
			}

			$sql = "SELECT Code, Title FROM fundtitles WHERE Code IN (".$acctStr.")";
			$record = $database->query($sql);
			while($data = $database->fetch_array($record)){
				$acct[strval($data['Code'])] = $data['Title'];
			}

			$curPrgCode = "";
			$sheet = "	<table border='0' cellspacing='0' cellpadding='0' style='width:100%; margin-bottom:8px;'>
							<tr>
								<td style='width:0px; padding:0px 8px; padding-left:0px;'><div style='font-weight:bold;'>Program</div><select class='data2' id='encLiqProg' style='width:277px;' onchange='getEncLiqAcct()'></select></td>
								<td style='width:0px; padding:0px 8px;'><div style='font-weight:bold;'>Code</div><select class='data2' id='encLiqAcct' style='width:277px;'></select></td>
								<td style=' vertical-align:bottom;'>
									<span style='display:inline-block; border:2px solid silver; border-bottom:2px solid gray; border-right:2px solid gray; padding:4px 8px; background-color:rgb(18, 184, 240); user-select:none; cursor:pointer; color:white; font-weight:bold; white-space:nowrap;' onclick='encLiqAddCharges()'>Add +</span>
								</td>
							</tr>
						</table>
						<table border='0' id='encLiqTable' style='margin:0px auto; border-spacing:0px; border:1px solid silver;'>
							<tr style='font-size:18px; font-family:Oswald;'>
								<td colspan='2' style='font-weight:bold; padding-left:5px; border-bottom:1px solid silver; background-color:rgb(232, 239, 239);'>OBR Details</td>
								<td style='text-align:right; padding-right:12px; font-weight:bold; border-bottom:1px solid silver; background-color:rgb(236, 243, 244);'>Cash Advance</td>
								<td style='text-align:right; padding:0px 5px; font-weight:bold; border-bottom:1px solid silver; background-color:rgb(236, 243, 244);'>Spent</td>
							</tr>";

			for ($i=0; $i < sizeof($rows); $i++) { 
				$temp = explode("*",$rows[$i]);
				$prgCode = $temp[0];
				$acctCode = $temp[1];
				$amount = $temp[2];
				$total = $temp[3];
				$acctTitle = $acct[$acctCode];
				$prgName = "";
				if($prgCode != "x"){
					$prgName = $prgs[$prgCode];
					$curPrgCode = $prgCode;
				}


				$prgCont = "";
				if($prgCode != "x"){
					$prgCont = "<span style='display:block; font-weight:bold;' class='encLiqPrgs'>".$prgCode."</span>
								<span>".$prgName."</span>";
				}

				$sheet .= "	<tr>
								<td style='padding:0px 5px;'>".$prgCont."</td>
								<td style='padding:0px 5px; padding-bottom:8px;'>
									<span style='display:block; font-weight:bold;'>".$acctCode."</span>
									<span>".$acctTitle."</span>
								</td>
								<td style='padding:0px 5px;'>
									<input name='nliqOBRValueCA' class='data2' style='width:130px; text-align:right; border:0px; background-color:transparent; color:black;' value='".number_format($amount,2)."' disabled>
								</td>
								<td style='padding:0px 5px;'>
									<input name='nliqOBRValue' class='data2' style='width:130px; text-align:right; border:0px; border-bottom:1px dashed silver;' value='' onkeydown='return isAmount(this,event)' onkeyup='newKeyUpSpentNLIQ(this)'>
									<input type='hidden' name='nliqOBRHidden' value='".$curPrgCode."*".$acctCode."'>
								</td>
							</tr>";
			}
			$sheet .= "</table>";

			echo $sheet."*j*".number_format($caTotal,2);	
		}else{
			echo "x*j*".$tnPartner;
		}
	}
	if(isset($_GET['saveNewLiquidation'])){
		$breakdown = $database->charEncoder($_GET['breakdown']);
		$breakdown = explode("~", $breakdown);

		$caTN = $database->charEncoder($_GET['caTN']);
		$amount = $database->charEncoder($_GET['amount']);
		$spent = $database->charEncoder($_GET['spent']);
		$refund = $database->nullToZero($database->charEncoder($_GET['refund']));
		$reimb = $database->nullToZero($database->charEncoder($_GET['reimb']));
		$claimant = $database->charEncoder($_GET['claimant']);
		$orDetails = $database->charEncoder($_GET['orDetails']);
		$tax = $database->charEncoder($_GET['tax']);
		
		
		$trackType = 'PY';
		$chargeType = 0;
		$fund = "";
		$docType = 'Liquidation';
		$claimType = 'Others';
		
		
		$periodType = "Monthly";
		$periodValue = date('F');
		$status = "Encoded";
		 
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 

		//pagsave sa record
		$insertToVcurrent = "Insert into vouchercurrent (TrackingPartner,Year,Office,TrackingNumber,TrackingType,Fund,DocumentType,ClaimType,Claimant,Amount,ChargeType,PeriodType,PeriodMonth,EncodedBy,DateEncoded,Status,DateModified,PR_ProgramCode,PR_AccountCode,TotalAmountMultiple,NetAmount) VALUES ";
						
		$insertCase = "";
		for ($i=0; $i < sizeof($breakdown); $i++) { 
			$temp = explode("*", $breakdown[$i]);
			$prgCode = $temp[0];
			$acctCode = $temp[1];
			$amount = floatval($temp[2]);
		
			$insertCase .= ",('".$caTN ."','".$defaultYear."','".$office."','".$trackingNumber."','".$trackType."','".$fund."','".$docType."','".$claimType."','".$claimant."','".$amount."','".$chargeType."','".$periodType."','".$periodValue."','".$employeeNumber."','".$dateEncoded."','".$status."','".$dateEncoded."','".$prgCode."','".$acctCode."','".$spent."','".$spent."')";
		}

		$insertToVcurrent .= substr($insertCase, 1);
		$database->query($insertToVcurrent);
		
		//update cash advance partner
		$sql = "Update vouchercurrent  set TrackingPartner = '" . $trackingNumber . "'  where TrackingNumber = '".$caTN."'";
		$database->query($sql);

		$particulars = "";
		if($tax > 0) {
			$particulars = "Included Tax : ".number_format($tax, 2);
		}

		$sql = "Insert into particulars (TrackingNumber, Particulars) values ('" . $trackingNumber  . "', '".$particulars."')";
		$database->query($sql);

		$sql = "Insert into liquidation (TrackingNumber,CashAdvanceTN,Spent,Refund,Reimbursement,ORdetails,Tax) VALUES ('".$trackingNumber."','".$caTN."','".$spent."','".$refund."','".$reimb."','".$orDetails."','".$tax."')";
		$database->query($sql);

		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~'. $trackingNumber;
	}
	if(isset($_GET['editTrackingNLIQ'])) {
		$tn = $database->charEncoder($_GET['tn']);
		$tn = str_replace("editor", "", $tn);

		// $sql = "SELECT TrackingNumber, Amount, TotalAmountMultiple, PR_ProgramCode, PR_AccountCode, TrackingPartner
		// 			FROM vouchercurrent
		// 			WHERE TrackingNumber = '".$tn."'";

		$sql = "SELECT TrackingNumber, Amount, TotalAmountMultiple, PR_ProgramCode, PR_AccountCode, TrackingPartner
				FROM vouchercurrent
				WHERE TrackingNumber = '".$tn."' ORDER BY PR_ProgramCode ASC, PR_AccountCode ASC";

		$record = $database->query($sql);

		$rows = [];
		$prgs = [];
		$acct = [];

		$prgsStr = "";
		$acctStr = "";
		while($data = $database->fetch_array($record)){
			$amount = $data['Amount'];
			$total = $data['TotalAmountMultiple'];
			$prgCode = $data['PR_ProgramCode'];
			$acctCode = $data['PR_AccountCode'];
			$tnPartner = $data['TrackingPartner'];

			if(strpos($prgsStr, "'".$prgCode."'") != true){
				$prgsStr .= ",'".$prgCode."'";
			}else{
				$prgCode = "x";
			}

			$rows[] = $prgCode."*".$acctCode."*".$amount."*".$total;

			$acctStr .= ",'".$acctCode."'";

		}

		$prgsStr = substr($prgsStr, 1);
		$acctStr = substr($acctStr, 1);

		$sql = "SELECT Code, Name FROM programcode WHERE Code IN (".$prgsStr.")";
		$record = $database->query($sql);

		$options = "";
		if($database->num_rows($record) > 1) {
			$options = "<option></option>";
		}
		while($data = $database->fetch_array($record)){
			$code = $data['Code'];
			$title = $data['Name'];

			$prgs[strval($code)] = $title;
			$options .= "<option value='".$code."'>".$code." ".$title."</option>";
		}

		$sql = "SELECT Code, Title FROM fundtitles WHERE Code IN (".$acctStr.")";
		$record = $database->query($sql);
		while($data = $database->fetch_array($record)){
			$acct[strval($data['Code'])] = $data['Title'];
		}

		$sheet = "	<div class='editorContainer' style='padding:25px;'>
		 			<div style='background-color:rgb(8, 149, 196); padding:10px;'>
		 				<span style='display:inline-block; color:white; letter-spacing:1px; text-shadow: 0px 0px 2px orange; font-family:Oswald; width:95%; text-align:left;'>Editor</span>
		 				<span style='display:inline-block;'><div id='closeEditorMLQ' onclick='closeAbsolute(this)' class='closeEditor'></div></span>
		 			</div>";

		$sheet .= "<div style='padding-top:10px;'>
					<table border='0' cellspacing='0' cellpadding='0' style='width:100%; margin-bottom:8px; font-family:Oswald;'>
						<tr>
							<td style='padding:0px 8px; padding-left:0px;'><div style='font-weight:bold;'>Program</div><select class='data2' id='encLiqProgEd' style='width:320;' onchange='getEncLiqAcctEdMode()'>".$options."</select></td>
							<td style='padding:0px 8px;'><div style='font-weight:bold;'>Code</div><select class='data2' id='encLiqAcctEd' style='width:320px;'></select></td>
							<td style='padding:0px 8px; vertical-align:bottom; width:0px;'>
								<span style='display:inline-block; border:2px solid silver; border-bottom:2px solid gray; border-right:2px solid gray; padding:4px 8px; background-color:rgb(18, 184, 240); user-select:none; cursor:pointer; color:white; font-weight:bold; white-space:nowrap;' onclick='encLiqAddChargesEd()'>Add +</span>
							</td>
						</tr>
					</table>
					<table id='encLiqTableEd' border='0' style='margin:0px auto; border-spacing:0px; border:1px solid silver;'>
					<tr style='font-size:18px; font-family:Oswald;'>
						<td colspan='2' style='font-weight:bold; padding-left:5px; border-bottom:1px solid silver; background-color:rgb(232, 239, 239);'>Liquidated Expense Account</td>
						<td style='text-align:center; font-weight:bold; border-bottom:1px solid silver; background-color:rgb(236, 243, 244);'>Spent</td>
					</tr>";
		$curPrgCode = "";
		for ($i=0; $i < sizeof($rows); $i++) { 
			$temp = explode("*",$rows[$i]);
			$prgCode = $temp[0];
			$acctCode = $temp[1];
			$amount = $temp[2];
			$total = $temp[3];
			$acctTitle = $acct[$acctCode];
			$prgName = "";
			if($prgCode != "x"){
				$prgName = $prgs[$prgCode];
				$curPrgCode = $prgCode;
			}


			$prgCont = "";
			if($prgCode != "x"){
				$prgCont = "<span style='display:block; font-weight:bold;'>".$prgCode."</span>
							<span>".$prgName."</span>";
			}

			$sheet .= "	<tr>
							<td style='padding:0px 5px;'>".$prgCont."</td>
							<td style='padding:0px 5px; padding-bottom:8px;'>
								<span style='display:block; font-weight:bold;'>".$acctCode."</span>
								<span>".$acctTitle."</span>
							</td>
							<td style='padding:0px 5px;'>
								<input name='nliqOBRValue1' class='data2' style='width:130px; text-align:right; border:0px; border-bottom:1px dashed silver;' value='".number_format($amount, 2)."' onkeydown='return isAmount(this,event)' onkeyup='newKeyUpSpentNLIQ1(this)'>
								<input type='hidden' name='nliqOBRHidden1' value='".$curPrgCode."*".$acctCode."*0'>
							</td>
						</tr>";
		}
		$sheet .= "	</table>
					</div>";

		$sheet .= "<div style='text-align:right; padding-right:5px; padding-top:10px;'>";
		
		$sql = "SELECT NetAmount, Amount, TotalAmountMultiple FROM vouchercurrent WHERE TrackingNumber = '".$tnPartner."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$curCA = floatval($data['NetAmount']);

		$curCAGross = floatval($data['Amount']);
		if($data['TotalAmountMultiple'] > 0) {
			$curCAGross = floatval($data['TotalAmountMultiple']);
		}


		$sql = "SELECT * FROM liquidation WHERE TrackingNumber = '".$tn."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);

		$spent = $data['Spent'];
		$refund = $data['Refund'];
		$orDetails = $data['ORdetails'];
		$reimb = $data['Reimbursement'];
		$tax = $data['Tax'];

		$showTax = 'display:none;';
		if($tax > 0) {
			$showTax = '';
		}

		$sheet .= "<table border='0' style='display:inline-block; border-spacing:0px; text-align: right; margin-bottom:40px;'>
						<tr>
							<td style='padding:0px 5px;'>Cash Advance (Gross)</td>
							<td style='border-bottom:1px dashed silver;'><span id='nliqCurCAGross1' class='data2' style='border:0px; width:130px; color:rgb(35, 116, 157);'>".number_format($curCAGross, 2)."</span></td>
						</tr>
						<tr>
							<td style='padding:0px 5px;'>Cash Advance (Net)</td>
							<td style='border-bottom:1px dashed silver;'><span id='nliqCurCA1' class='data2' style='border:0px; width:130px; color:rgb(35, 116, 157);'>".number_format($curCA, 2)."</span></td>
						</tr>
						<tr>
							<td style='padding:0px 5px;'>Total Spent</td>
							<td style='border-bottom:1px dashed silver;'><span id='nliqCurSpent1' class='data2' style='border:0px; width:130px; color: red;'>".number_format($spent, 2)."</span></td>
						</tr>	
						<tr id='nliqTaxRow1' style='".$showTax."'>
							<td style='padding:0px 8px;'>Tax</td>
							<td style='border-bottom:1px dashed silver;'>
								<input id='nliqTax1' style='width:130px; border:0px; background-color:transparent; font-family:Oswald; font-size:18px; font-weight:bold; text-align:right; padding-right:6px;' value='".number_format($tax, 2)."' onkeydown='return isAmount(this,event)'>
							</td>
						</tr>	
						<tr>
							<td style='padding:0px 5px;'>Refunded</td>
							<td style='border-bottom:1px dashed silver;'><span id='nliqCurRefund1' class='data2' style='border:0px; width:130px;'>".number_format($refund, 2)."</span></td>
						</tr>	
						<tr>
							<td style='padding:0px 5px;'>O.R. Details</td>
							<td style='border-bottom:1px dashed silver;'><input id='nliqCurORDets1' class='data2' style='border:0px; width:130px;' value='".$orDetails."'></td>
						</tr>
						
						<tr>
							<td style='padding:0px 5px;'>Reimbursement</td>
							<td style='border-bottom:1px dashed silver;'><span id='nliqCurReimb1' class='data2' style='border:0px; width:130px;'>".number_format($reimb, 2)."</span></td>
						</tr>									
					</table>";
				
		$sheet .= "<div style = '' class = 'button1' onclick = 'updateNLIQ(\"".$tn."\")'>Save</div>";
		$sheet .= "</div>";

		$sheet .= "	</div>";

		echo $sheet;
	}
	if(isset($_GET['updateNewLiquidation'])) {
		$breakdown = $database->charEncoder($_GET['breakdown']);
		$breakdown = explode("~", $breakdown);

		$tn = $database->charEncoder($_GET['tn']);
		$caAmnt = $database->charEncoder($_GET['amount']);
		$spent = $database->charEncoder($_GET['spent']);
		$refund = $database->nullToZero($database->charEncoder($_GET['refund']));
		$orDetails = $database->charEncoder($_GET['orDetails']);
		$reimb = $database->nullToZero($database->charEncoder($_GET['reimb']));
		$tax = $database->charEncoder($_GET['tax']);

		$update = "";
		$columnCont = [];
		for ($i=0; $i < sizeof($breakdown); $i++) { 
			$temp = explode("*", $breakdown[$i]);
			$prgCode = $temp[0];
			$acctCode = $temp[1];
			$new = $temp[2];
			$amount = floatval($temp[3]);


			if($amount > 0) {
				if($new == 1) {
					$db = $database->getDB($year);
					$sql = "SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS	WHERE TABLE_SCHEMA = '".$db."' AND TABLE_NAME = 'vouchercurrent'";
					$record = $database->query($sql);
	
					while ($data = $database->fetch_array($record)) {
						if($data['COLUMN_NAME'] != 'Id') {
							// $columnCont[$data['COLUMN_NAME']] = "";
							array_push($columnCont, $data['COLUMN_NAME']);
						}
					}
	
					$sql = "SELECT * FROM vouchercurrent WHERE TrackingNumber = '".$tn."' LIMIT 1";
					$record = $database->query($sql);
					$data = $database->fetch_array($record);
	
					$columnList = "";
					$valueList = "";
					for ($i=0; $i < sizeof($columnCont); $i++) { 
						$columnList .= ",`".$columnCont[$i]."`";
	
						if($columnCont[$i] == 'PR_ProgramCode') {
							$valueList .= ",'".$prgCode."'";
						}elseif($columnCont[$i] == 'PR_AccountCode') {
							$valueList .= ",'".$acctCode."'";
						}elseif($columnCont[$i] == 'TotalAmountMultiple') {
							$valueList .= ",'".$spent."'";
						}elseif($columnCont[$i] == 'NetAmount') {
							$valueList .= ",'".$spent."'";
						}elseif($columnCont[$i] == 'Amount') {
							$valueList .= ",'".$amount."'";
						}elseif($columnCont[$i] == 'PO_Amount' || $columnCont[$i] == 'SubCode' || $columnCont[$i] == 'FundYear' || $columnCont[$i] == 'NetAmount' || $columnCont[$i] == 'PayrollAmountFirst' 
								|| $columnCont[$i] == 'PayrollAmountSecond' || $columnCont[$i] == 'JevAmount' || $columnCont[$i] == 'OBR_Approve' || $columnCont[$i] == 'ModeOfProcurement' 
								|| $columnCont[$i] == 'PeaceOfficeId' || $columnCont[$i] == 'Complex'){
	
							$valueList .= ",null";
	
						}else {
							if($data[$columnCont[$i]] == "") {
								$valueList .= ",null";
							}else {
								$valueList .= ",'".$data[$columnCont[$i]]."'";
							}
						}
	
					}
					
					$sql = "INSERT INTO vouchercurrent (".substr($columnList, 1).") VALUES (".substr($valueList, 1).")";
					$database->query($sql);
	
				}else {
					$update = "UPDATE vouchercurrent SET TotalAmountMultiple = '".$spent."', Amount = '".$amount."', NetAmount = '".$spent."' WHERE TrackingNumber = '".$tn."' AND PR_ProgramCode = '".$prgCode."' AND PR_AccountCode = '".$acctCode."';";
					$database->query($update);
				}
			}else {
				$delete = "DELETE FROM vouchercurrent WHERE TrackingNumber = '".$tn."' AND PR_ProgramCode = '".$prgCode."' AND PR_AccountCode = '".$acctCode."';";
				$database->query($delete);
			}
			
		}

		$sql = "UPDATE liquidation SET Spent = '".$spent."', Refund = '".$refund."', Reimbursement = '".$reimb."', ORdetails = '".$orDetails."', Tax = '".$tax."' WHERE TrackingNumber = '".$tn."'";
		$database->query($sql);

		echo $tn;
	}
	// if(isset($_GET['encLiqLoadProgCodes'])) {
	// 	$office = $_SESSION['cbo'];

	// 	$sql = "SELECT ProgramCode FROM funds WHERE OfficeCode = '".$office."' GROUP BY ProgramCode";
	// 	$record = $database->query($sql);

	// 	$progList = "";
	// 	while ($data = $database->fetch_array($record)) {
	// 		$progCode = $data['ProgramCode'];
	// 		$progList .= ",'".$progCode."'";
	// 	}

	// 	$sql = "SELECT Code, Name FROM programcode WHERE Code IN (".substr($progList, 1).") ORDER BY Code ASC";
	// 	$record = $database->query($sql);

	// 	$options = "<option></option>";
	// 	while ($data = $database->fetch_array($record)) {
	// 		$code = $data['Code'];
	// 		$title = $data['Name'];

	// 		$options .= "<option value='".$code."'>".$code." ".$title."</option>";
	// 	}

	// 	echo $options;
	// }

	if(isset($_GET['encLiqLoadProgCodes'])) {
		$office = $_SESSION['cbo'];
		$trackingNumber = $_GET['tn'];

		// $sql = "SELECT PR_ProgramCode FROM vouchercurrent WHERE TrackingPartner = '".$trackingNumber."' GROUP BY PR_ProgramCode";
		$sql = "SELECT PR_ProgramCode FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' GROUP BY PR_ProgramCode";
		$record = $database->query($sql);

		$progList = "";
		while ($data = $database->fetch_array($record)) {
			$progCode = $data['PR_ProgramCode'];
			$progList .= ",'".$progCode."'";
		}


		$sql = "SELECT Code, Name FROM programcode WHERE Code IN (".substr($progList, 1).") ORDER BY Code ASC";
		$record = $database->query($sql);

		$options = "";
		if($database->num_rows($record) > 1) {
			$options = "<option></option>";
		}
		while ($data = $database->fetch_array($record)) {
			$code = $data['Code'];
			$title = $data['Name'];

			$options .= "<option value='".$code."'>".$code." ".$title."</option>";
		}

		echo $options;
	}

	if(isset($_GET['getEncLiqAcct'])) {
		$office = $_SESSION['cbo'];
		$progCode = $database->charEncoder($_GET['prog']);

		$sql = "SELECT AccountCode FROM funds WHERE OfficeCode = '".$office."' AND ProgramCode = '".$progCode."'";
		$record = $database->query($sql);

		$acctList = "";
		while ($data = $database->fetch_array($record)) {
			$code = $data['AccountCode'];
			$acctList .= ",'".$code."'";
		}

		$sql = "SELECT Code, Title FROM fundtitles WHERE Code IN (".substr($acctList, 1).") ORDER BY Code ASC";
		$record = $database->query($sql);

		$options = "<option></option>";
		while ($data = $database->fetch_array($record)) {
			$code = $data['Code'];
			$title = $data['Title'];

			$options .= "<option value='".$code."'>".$code." ".$title."</option>";
		}

		echo $options;
	}

	
	//---------------------------------------------------------------------------------------------------Infra start
	
	if(isset($_GET['fetchOfficeInfra'])){
		$sql = "select * from office where Infra = 1 order by Name asc";
		$record = $database->query($sql);
		$sheet = '<option></option>';
		while($data =$database->fetch_array($record)){
			$code = $data['Code'];
			$office = $data['Name'];
			$sheet .= '<option value = "' . $code . '">' . $office . '</option>';
		}
		echo $sheet;
	}
	if(isset($_GET['fetchNewTrackingInfra'])){
		$code = $database->charEncoder($_GET['code']);
		$sql = "select Doctrack from office where code = '" . $code . "' limit 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$newTN = $code . '-' .  ($data['Doctrack'] + 1);
		/*$sql = "select a.ProgramCode,a.Fund,b.Name,a.Total,a.AccountCode 
				from ppmpmain a left join programcode b on a.ProgramCode = b.Code 
				where Type = 'Infrastructure' and OfficeCode = '" . $code . "' and a.TrackingNumber is null order by Name asc";*/
		$sql = "select a.*,b.Description as SubDescription from programcode a left join subprogramcode b on a.subcode = b.subcode 
				where category = 'Infrastructure Project' and Office  = '" . $code . "' and TrackingNumberInfra is null order by Name asc";
		$record = $database->query($sql);
		$sheet = '<option>&nbsp;</option>';
		while($data = $database->fetch_array($record)){
			/*$code = $data['ProgramCode'];
			$name = $data['Name'];
			$cost = $data['Total'];
			$account = $data['AccountCode'];
			$fund  = $data['Fund'];*/
			$infraId = $data['Id'];
			$code = $data['Code'];
			$lump = $data['Lump'];
			if(strlen($lump) > 0){
				$code = $lump;
			}
			$name = $data['Name'];
			$cost = $data['Amount'];
			$account = $data['ExpenseCode'];
			$fund  = $data['Fund'];
			$fundYear  = $data['FundYear'];
			$subcode  = $data['SubCode'];
			$subDescription  = $data['SubDescription'];
			if(strtoupper($fund) == "DEVELOPMENT FUND"){
				$fund = "General Fund";
			}
			$sheet .= '<option value = "' . $code . '~!~' . $cost . '~!~'  . $account . '~!~'  . $fund . '~!~'  . $infraId  . '~!~'  . $fundYear .  '~!~'  . $subcode . '~!~'  . $subDescription .'" >' . $code . '&nbsp;&nbsp;&nbsp;&nbsp;' .  utf8_encode($name) . '</option>';
		}
		echo $newTN . '!@!' . $sheet;
	}
	if(isset($_GET['fetchAccountName'])){
		$code = $database->charEncoder($_GET['code']);
		$sql = "select * from fundtitles where Code = '" . $code . "' limit 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$title = $data['Title'];
		echo $title;
	}
	if(isset($_GET['saveTrackingInfra'])){
		$code = $database->charEncoder($_GET['code']);
		$name = $database->charEncoder($_GET['name']);
		$accountCode = $database->charEncoder($_GET['accountCode']);
		$cost = $database->charEncoder($_GET['cost']);
		$accountName = $database->charEncoder($_GET['accountName']);
		$office = $database->charEncoder($_GET['office']);
		$fund = $database->charEncoder($_GET['fund']);
		$batchno = $database->charEncoder($_GET['batchno']);
		$location = $database->charEncoder($_GET['location']);
		
		$duration = $database->charEncoder($_GET['duration']);
		$infraId = $database->charEncoder($_GET['infraId']);
		
		$fundYear = $database->charEncoder($_GET['fundYear']);
		$subcode = $database->charEncoder($_GET['subcode']);
		
		
		
		//pagincrement sa new tn
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new tn
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$tn = $office . '-' . $data['Doctrack'];
		$newTN = $office . '-' . ($data['Doctrack'] + 1);
		$trackType = "NF";
		$docType = "Infrastructure Project";
		$status = "Project Encoded";
		
		$sql = "Insert into vouchercurrent (Year,Office,TrackingNumber,TrackingType,DocumentType,Fund,Amount,EncodedBy,DateEncoded,Status,DateModified,PR_ProgramCode,PR_AccountCode,InfraId,FundYear,SubCode)VALUES 
						(" . $defaultYear . ",'" . $office . "','" . $tn . "','" . $trackType . "','" . $docType. "','" . $fund . "'," . $cost . ",
						'" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "','" . $code . "','" . $accountCode . "','" . $infraId . "','" . $fundYear . "','" . $subcode . "')";
		$database->query($sql);	

		$sql = "INSERT INTO infra (TrackingNumber, BatchNumber, Location, Duration) VALUES ('".$tn."','".$batchno."','".$location."','".$duration."')";
		$database->query($sql);	


		$sql = "UPDATE ppmpmain SET TrackingNumber = '".$tn."' WHERE ProgramCode = '".$code."'";
		$database->query($sql);	
		
		$sql = "UPDATE programcode SET TrackingNumberinfra = '".$tn."' WHERE Id = '" . $infraId . "'";
		$database->query($sql);	

		$completion = '';
		$database->UpdateVoucherHistory($tn);               //update para sa completion
		$database->InsertToVoucherHistory($tn,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		
		echo $tn . "!@!" . $newTN ;
		
	}

	//---------------------------------------------------------------------------------------------------Infra end



	//---------------------------------------------------------------------------------------------------INFRA FINAL - START

	if(isset($_GET['selectInfraPayment'])){
			$sql = "SELECT TrackingNumber, Office, Claimant, NetAmount, Fund FROM vouchercurrent 
					WHERE 
					DocumentType = 'Infrastructure Project' AND Status = 'NTP Forwarded to Construction Division'";
			$record = $database->query($sql);
			echo $sheet->CreateSelectInfraFinal($record);
	}

	if(isset($_GET['fetchINTNDetails'])){
		$tn = $database->charEncoder($_GET['tn']);
		$mixedINFRA = $database->charEncoder($_GET['mixedINs']);

		$sql = "SELECT 
				TrackingNumber, Claimant, Amount, NetAmount, PR_ProgramCode, PR_AccountCode, Fund
				FROM vouchercurrent
				WHERE TrackingNumber = '".$tn."' LIMIT 1";
		$record = $database->query($sql);

		$data = $database->fetch_array($record);

		$tn = $data['TrackingNumber'];
		$claimant = $data['Claimant'];
		$pCost = $data['Amount'];
		$aCost = $data['NetAmount'];
		$fund = $data['Fund'];

		$progCode = $data['PR_ProgramCode'];
		$acctCode = $data['PR_AccountCode'];

		

		$sql = "SELECT FundYear,Name FROM programcode WHERE TrackingNumberInfra = '".$tn."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$progTitle = $data['Name'];
		$fundYear = $data['FundYear'];

		$sql = "SELECT Title FROM fundtitles WHERE Code = '".$acctCode."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$acctTitle = $data['Title'];
		
		
		$office =  substr($tn,0,4);
		$case ="Select Doctrack from office where code = '" . $office . "' limit 1";
		$record = $database->FetchThis($case);
		$data = $database->fetch_array($record);

		$newTrackingNumber =  $office . '-' . ($data['Doctrack']+1); 
		
		$sql = "select * from infra where TrackingNumber ='" . $tn ."' limit 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$currentProgress = $data['Progress'];
		$variation = $data['Variation'];
		$unperformed = $data['Unperformed'];
		$batchNumber = $data['BatchNumber'];
		
		// $sql = "SELECT TrackingNumber FROM infrapayment WHERE InfraTracking = '".$tn."' LIMIT 1";
		// $record = $database->query($sql);
		// $pyTN = "";
		// if($database->num_rows($record) > 0) {
		// 	$data = $database->fetch_array($record);
		// 	$pyTN = $data['TrackingNumber'];
		// }

		// $sql = "SELECT BatchNumber FROM particulars WHERE TrackingNumber = '".$pyTN."' LIMIT 1";
		// $record = $database->query($sql);
		// $pyBatchNum = "";
		// if($database->num_rows($record) > 0) {
		// 	$data = $database->fetch_array($record);
		// 	$pyBatchNum = $data['BatchNumber'];
		// }
		
		$sql = "select * from infrapayment where InfraTracking ='" . $tn ."' order by id asc";
		$record = $database->query($sql);
		
		$sheet = '<table id ="infraPaymentHistory" style ="font-family:NOR;margin:0 auto;font-size:14px;border-collapse:collapse;width:100%;background-color:white;padding:50px;" border ="0">';
		$sheet .= '<tr><td colspan = "100%" style ="background-color:rgb(227, 236, 239);padding:2px 5px;letter-spacing:2px;font-size:13px;">PAYMENT RECORD </td></tr>';
		$sheet .= '<tr>
				   		<th style = "padding:2px 5px;">TN</th>
				   		<th style = "padding:2px 5px;text-align:left;">Payment</th>
				   		<th style = "padding:2px 5px;">Variation</th>
				   		<th style = "padding:2px 5px;">Unperformed</th>
				   		<th style = "padding:2px 5px;">Contract</th>
				   		<th style = "padding:2px 5px;">Adjustment</th>
				   		
				   		<th style = "padding:2px 5px;">T.Progress</th>
				   		<th style = "padding:2px 5px;">B.Progress</th>
				   		
				   		<th style = "padding:2px 5px;text-align:center;">S.Curve</th>
				   		<th style = "padding:2px 5px;">Billed Amount</th>
				   		<th style = "padding:2px 5px;text-align:right;">2(%)</th>
				   		<th style = "padding:2px 5px;text-align:right;">5(%)</th>
				   		<th style = "padding:2px 5px;text-align:right;">Tax</th>
				   		<th style = "padding:2px 5px;text-align:right;">Ret</th>
				   		<th style = "padding:2px 5px;text-align:right;">Delay</th>
				   		<th style = "padding:2px 5px;text-align:right;">LD</th>
				   		<th style = "padding:2px 5px;text-align:right;">Net</th>
				   </tr>
				   <tr><td colspan ="100%" style = "border-top:1px solid grey;"></td></tr>	
				   ';
		$totalGross = 0;		   
		$totalNet = 0;
		$totalTwo =0;
		$totalFive =0;
		$totalRetention =0;
		$totalTax =0;
		$totalLD =0;
		
		$retentionTotal = 0;
		$done = 0;
		$lastProgress = 0;
		$billedProgress = 0;
		$pCostAdjusted = 0;
		
		$ld =0;
		$type = array('1st Payment','2nd Payment','3rd Payment','4th Payment','5th Payment','6th Payment','7th Payment','Final Payment');
		while($data = $database->fetch_array($record)){
				$infaTN = $data['TrackingNumber'];
				$infaPaymentType = $data['Type'];
				$arrayKey = array_search($infaPaymentType, $type);
				unset($type[$arrayKey]);
				if($infaPaymentType == 'Final Payment'){
					$done = 1;
				}
				
				$progress = $data['Progress'];
				$gross = $data['Gross'];
				$variationSaved =  $data['Variation'];
				$unperformedSaved = $data['Unperformed'];
				if($variationSaved > 0 || $unperformedSaved > 0){
					$adjustment = number_format($data['ActualAdjustment']);
				}else{
					$adjustment = '';
					
				}
				
				 
				$billedProgress = $data['BilledProgress'];
				$lastProgress = $progress;
				$sCurve = $data['Scurve'];
				$delay = $data['Delay'];
				$tax = $data['Tax'];
				$retention = $data['Retention'];
				
				$net = $data['Net'];
				$two = $data['Two'];
				$five = $data['Five'];
				$ld = $data['LD'];

				$retentionTotal += $retention;
				$totalTax += $tax;
				$totalTwo += $two;
				$totalFive += $five;
				$totalNet += $net;
				$totalGross += $gross;
				$sheet .= '<tr>
					   		<td style = "padding:0px 5px;border-bottom:1px solid rgb(232, 234, 235);cursor:pointer;" class = "hover" onclick ="searchThisPartner(this)">' . $infaTN . '</td>
					   		<td style = "padding:0px 5px;border-bottom:1px solid rgb(232, 234, 235);">' . $infaPaymentType . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $database->zeroToNothing(number_format($variationSaved,2)) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $database->zeroToNothing(number_format($unperformedSaved,2)) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . number_format($aCost,2) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $adjustment .  '</td>
					   		<td style = "text-align:center;border-bottom:1px solid rgb(232, 234, 235);">' . $progress . '</td>
					   		<td style = "text-align:center;border-bottom:1px solid rgb(232, 234, 235);">' . $billedProgress . '</td>
					   		<td style = "padding:0px 5px;text-align:center;border-bottom:1px solid rgb(232, 234, 235);">' . $sCurve . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . number_format($gross,2) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' .number_format($two,2) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' .number_format($five,2) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' .number_format($tax,2) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . number_format($retention,2) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $database->zeroToNothing($delay) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $database->zeroToNothing(number_format($ld,2)) . '</td>
					   		<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);border-right:1px solid rgb(232, 234, 235);">' . number_format($net,2) . '</td>
					   </tr>';
			}
			$sheet .= ' <tr>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);" id="nfTotalBAmount">' . number_format($totalGross,2) .'</th>
							<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . number_format($totalTwo,2) . '</th>
							<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . number_format($totalFive,2) . '</th>
							<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . number_format($totalTax,2) . '</th>
							<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . number_format($retentionTotal,2) . '</th>
							<th></th>
							<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . $database->zeroToNothing(number_format($ld,2)) . '</th>
							<th style = "padding:5px;text-align:right;"><span style = "color:red;font-weight:bold;">' . number_format($totalNet,2)  . '</span></th>
						</tr>';	
			$sheet .= ' <tr><td colspan ="100%"  style = "padding:5px; border-left:0px;"></td></tr>';	
		$sheet .= '</table>';
		
	
		
		if($done == 0){
			$options = '';
			foreach ($type as $paymentType) {
				if($currentProgress < 100){
					$options .= '<option>' . $paymentType . '</option>';
				}
				break;
			}

			if($currentProgress == 100 && $mixedINFRA == 1) {
				$options .= '<option>' . $paymentType . '</option>';
			}

			$options .= '<option>' . str_replace(" Payment","",$paymentType) . ' and Final Payment</option>';
		}else{
			$options = '<option style ="padding:5px;"></option>';
		}
		$billedProgress = $currentProgress - $lastProgress;
		//pag naay adjustment s last payment tapos naa nay payment before sa adjustment
		//$aCost = $aCost - $totalBilledAmountWithoutAdjustment;
		if($variation > 0){
			$retention =  round(($aCost + $variation) * .05,2);
			$pCostAdjusted = $aCost + $variation;
		}else if($unperformed > 0){
			$retention =  round(($aCost - $unperformed) * .05,2);
			$pCostAdjusted = $aCost - $unperformed;
		}else{
			$retention =  round($aCost * .05,2);
			$pCostAdjusted = $aCost;
		}
		 
		
		
		$retentionBalance = round($retention-$retentionTotal,2);
		echo utf8_encode($claimant)."*".$fund."*".$progCode."*".$progTitle."*".$acctCode."*".$acctTitle."*".number_format($pCost, 2)."*".number_format($aCost, 2) . "*" .$newTrackingNumber . "*" . $sheet .
									 "*" . $options . "*" . $currentProgress . "*" . number_format($retention,2) . "*" . 
									 $database->zeroToEmpty(number_format($retentionTotal,2)) . "*" . $database->zeroToEmpty(number_format($retentionBalance,2))  . "*" . $billedProgress  . 
									 "*" . $database->zeroToEmpty(number_format($variation,2))  . "*" . $database->zeroToEmpty(number_format($unperformed,2)) . "*" . number_format($pCostAdjusted,2) ."*".$fundYear."*".$batchNumber;
	}

	// if(isset($_GET['saveTrackingInfraPY'])){
	// 	//$office = $_SESSION['cbo'];
	// 	$coTN = $database->charEncoder($_GET['tn']); // PR_TrackingNumber
	// 	$fund = $database->charEncoder($_GET['fund']);
		
	// 	$supplier = $database->charEncoder($_GET['supplier']); // Claimant
	// 	$gross = $database->charEncoder($_GET['gross']);
	// 	$type = $database->charEncoder($_GET['type']);
	// 	$progress = $database->charEncoder($_GET['progress']);
	// 	$retention = $database->charEncoder($_GET['retention']);
	// 	$tax = $database->charEncoder($_GET['tax']);
	// 	$net = $database->charEncoder($_GET['net']);
	// 	$delay = $database->nullToZero($database->charEncoder($_GET['delay']));
	// 	$progress = $database->charEncoder($_GET['progress']);
		
	// 	$actual = $database->charEncoder($_GET['actual']);
	// 	$actualAdjustment = $database->charEncoder($_GET['actualAdjustment']);
		
	// 	$from = $database->charEncoder($_GET['from']);
	// 	$to = $database->charEncoder($_GET['to']);
	// 	$wholeProgress = $database->charEncoder($_GET['wholeProgress']);
	// 	$sCurve = $database->charEncoder($_GET['sCurve']);
		
	// 	$two = $database->charEncoder($_GET['two']);
	// 	$five = $database->charEncoder($_GET['five']);
	// 	$ld = $database->nullToZero($database->charEncoder($_GET['ld']));
		
	// 	$variation = $database->nullToZero($database->charEncoder($_GET['variation']));
	// 	$unperformed = $database->nullToZero($database->charEncoder($_GET['unperformed']));
		
	// 	$ldPercentage = $database->nullToZero($database->charEncoder($_GET['ldPercentage']));
		
	// 	if($ldPercentage > 0){
	// 		$ldPercentage = number_format(($ldPercentage /100),4);
	// 	}
		
	// 	$complex = 2;
		
	// 	$deduction = ($tax + $retention + $ld);
	// 	$sql = "select OBR_Number from vouchercurrent where TrackingNumber  ='" . $coTN . "' limit 1";
	// 	$record = $database->query($sql);
	// 	$data = $database->fetch_array($record);
	// 	$obrNumber  = $data['OBR_Number'];
		
	// 	$sql = "select Name from programcode where TrackingNumberInfra  ='" . $coTN . "' limit 1";
	// 	$record = $database->query($sql);
	// 	$data = $database->fetch_array($record);
	// 	$projectName  = $data['Name'];
				
	// 	$office =  substr($coTN,0,4);
	// 	//pagincrement sa new tn
	// 	$updateCase = "Doctrack = Doctrack + 1";
	// 	$database->IncrementTrackingSeries($updateCase,$office);
		
	// 	//pagkuha sa new tn
	// 	$condition = "where code = '" . $office . "' limit 1";
	// 	$record = $database->FetchDoctrackID("Doctrack",$condition);
	// 	$data = $database->fetch_array($record);
	// 	$tn = $office . '-' . $data['Doctrack'];
	// 	$newTN = $office . '-' . ($data['Doctrack'] + 1);

	// 	$trackType = "IP";
	// 	$docType = "Infrastructure Payment";
	// 	$status = "Encoded";
	// 	$claimType = "Check";
		
	// 	$sql = "Insert into vouchercurrent 
	// 			(Year,Office,TrackingNumber,TrackingType,DocumentType,Fund,Amount,EncodedBy,DateEncoded,Status,DateModified,TrackingPartner,Claimant,ClaimType,NetAmount,Complex,OBR_Number)
	// 			VALUES 
	// 			(" . $defaultYear . ",'" . $office . "','" . $tn . "','" . $trackType . "','" . $docType. "','" . $fund . "', " . $gross . ",'" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "'
	// 			,'" . $coTN . "','" . $supplier . "','" . $claimType . "','" . $net . "','" . $complex . "','" . $obrNumber . "')";
	// 	$database->query($sql);	
		
	// 	$sql = "Insert into infrapayment (InfraTracking,TrackingNumber,Type,Progress,Retention,Tax,Gross,Net,Delay,PeriodFrom,PeriodTo,Actual,BilledProgress,Scurve,Two,Five,LD,Variation,Unperformed,ActualAdjustment,LDpercentage)
	// 			VALUES ('" . $coTN . "','" . $tn . "','" . $type . "','" . $wholeProgress . "','" . $retention . "',
	// 					'" . $tax . "','" . $gross . "','" . $net . "','" . $delay . "','" . $from . "','" . $to . "','" . $actual . "','" . $progress . "',
	// 					'" . $sCurve . "','" . $two . "','" . $five . "','" . $ld . "','" . $variation . "','" . $unperformed . "','" . $actualAdjustment . "','" . $ldPercentage . "')";
	// 	$database->query($sql);
		
	// 	$part = "\n    For ("  . $type . ") of a bid contract for the project : "  . $projectName . " covering for the period of " . $from . " to " . $to . " as per supporting documents hereto attached in the amount of ....\n";		                 
	// 	$part .= "\nContract Details : " . $coTN . ", s-Curve : " . $sCurve;
	// 	$part .= "\nContract Amount : " . number_format($actual,2);
	// 	if(strlen($variation) > 0){
	// 		$part .= "\nAdd. Fund due to Variation order No. 1 : " . number_format($variation,2);
	// 		$part .= "\nRevised Contract Amount " . number_format($actualAdjustment,2);
	// 	}
		
	// 	if($unperformed > 0){
	// 		$part .= "\nLess : Unperformed Works" . number_format($unperformed,2);
	// 		$part .= "\nRevised Contract Amount " . number_format($actualAdjustment,2);
	// 	}
	// 	if($type == "1st Payment"){
	// 		$part .= "\nAccomplishment to Date : " . $wholeProgress ."%";
	// 	}else{
	// 		$part .= "\nTotal Accomplishment : " . $wholeProgress ."%"  . ", Accomplishment Billed : " . $progress ."%";
	// 	}
		
		
    //     $part .= "\nTax(2%)  " . number_format($gross,2) . " / 1.12 x .02  :  " .  number_format($two,2);
    //     $part .= "\nTax(5%)  " . number_format($gross,2) . " / 1.12 x .05  :  " .  number_format($five,2);
	// 	$part .= "\n                                           			               Total Tax :  " .  number_format($tax,2);
	// 	$part .= "\n										              Retention :  " . number_format($retention,2);
	// 	if($ld > 0){
	// 		$part .= "\n							     	          Liquidated Damages :  " .  number_format($ld,2);
	// 	}
	// 	$part .= "\n							     	                 Total Deduction :  " .  number_format($deduction,2);
		
			                                                        				
	// 	$sql = "Insert into particulars(TrackingNumber,Particulars) values('" . $tn . "','" . $part . "')";
	// 	$database->query($sql);
			

	// 	$completion = '';
	// 	$database->UpdateVoucherHistory($tn);               //update para sa completion
	// 	$database->InsertToVoucherHistory($tn,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		
	// 	echo $tn . "!@!" . $newTN;
	// }

	if(isset($_GET['saveTrackingInfraPY'])){
		//$office = $_SESSION['cbo'];
		$coTN = $database->charEncoder($_GET['tn']); // PR_TrackingNumber
		$fund = $database->charEncoder($_GET['fund']);
		
		$supplier = $database->charEncoder($_GET['supplier']); // Claimant
		$gross = $database->charEncoder($_GET['gross']);
		$type = $database->charEncoder($_GET['type']);
		$progress = $database->charEncoder($_GET['progress']);
		$retention = $database->charEncoder($_GET['retention']);
		$tax = $database->charEncoder($_GET['tax']);
		$net = $database->charEncoder($_GET['net']);
		$delay = $database->nullToZero($database->charEncoder($_GET['delay']));
		$progress = $database->charEncoder($_GET['progress']);
		
		$actual = $database->charEncoder($_GET['actual']);
		$actualAdjustment = $database->charEncoder($_GET['actualAdjustment']);
		
		$from = $database->charEncoder($_GET['from']);
		$to = $database->charEncoder($_GET['to']);
		$wholeProgress = $database->charEncoder($_GET['wholeProgress']);
		$sCurve = $database->charEncoder($_GET['sCurve']);
		
		$two = $database->charEncoder($_GET['two']);
		$five = $database->charEncoder($_GET['five']);
		$ld = $database->nullToZero($database->charEncoder($_GET['ld']));
		
		$variation = $database->nullToZero($database->charEncoder($_GET['variation']));
		$unperformed = $database->nullToZero($database->charEncoder($_GET['unperformed']));
		
		$ldPercentage = $database->nullToZero($database->charEncoder($_GET['ldPercentage']));
		
		if($ldPercentage > 0){
			$ldPercentage = number_format(($ldPercentage /100),4);
		}

		$batchNumber = $database->charEncoder($_GET['batchNumber']);
		$mixedINFRA = $database->charEncoder($_GET['mixedINFRA']);
		$partBatchNumber = 'NULL';

		if($mixedINFRA == 1) {
			
			$pyNum = str_replace([' Payment', ' and Final Payment'],'',$type);
			$pyNum = str_replace(['st','nd','rd','th'],'',$pyNum);
			$pyNum = intval($pyNum);

			$partBatchNumber = "'".$pyNum."*".$batchNumber."'";

		}
		
		$complex = 2;
		
		$deduction = ($tax + $retention + $ld);
		$sql = "select OBR_Number from vouchercurrent where TrackingNumber  ='" . $coTN . "' limit 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$obrNumber  = $data['OBR_Number'];
		
		$sql = "select Name from programcode where TrackingNumberInfra  ='" . $coTN . "' limit 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$projectName  = $data['Name'];
				
		$office =  substr($coTN,0,4);
		//pagincrement sa new tn
		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new tn
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$tn = $office . '-' . $data['Doctrack'];
		$newTN = $office . '-' . ($data['Doctrack'] + 1);

		$trackType = "IP";
		$docType = "Infrastructure Payment";
		$status = "Encoded";
		$claimType = "Check";
		
		$sql = "Insert into vouchercurrent 
				(Year,Office,TrackingNumber,TrackingType,DocumentType,Fund,Amount,EncodedBy,DateEncoded,Status,DateModified,TrackingPartner,Claimant,ClaimType,NetAmount,Complex,OBR_Number)
				VALUES 
				(" . $defaultYear . ",'" . $office . "','" . $tn . "','" . $trackType . "','" . $docType. "','" . $fund . "', " . $gross . ",'" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "'
				,'" . $coTN . "','" . $supplier . "','" . $claimType . "','" . $net . "','" . $complex . "','" . $obrNumber . "')";
		$database->query($sql);	
		
		$sql = "Insert into infrapayment (InfraTracking,TrackingNumber,Type,Progress,Retention,Tax,Gross,Net,Delay,PeriodFrom,PeriodTo,Actual,BilledProgress,Scurve,Two,Five,LD,Variation,Unperformed,ActualAdjustment,LDpercentage)
				VALUES ('" . $coTN . "','" . $tn . "','" . $type . "','" . $wholeProgress . "','" . $retention . "',
						'" . $tax . "','" . $gross . "','" . $net . "','" . $delay . "','" . $from . "','" . $to . "','" . $actual . "','" . $progress . "',
						'" . $sCurve . "','" . $two . "','" . $five . "','" . $ld . "','" . $variation . "','" . $unperformed . "','" . $actualAdjustment . "','" . $ldPercentage . "')";
		$database->query($sql);
		
		$part = "\n    For ("  . $type . ") of a bid contract for the project : "  . $projectName . " covering for the period of " . $from . " to " . $to . " as per supporting documents hereto attached in the amount of ....\n";		                 
		$part .= "\nContract Details : " . $coTN . ", s-Curve : " . $sCurve;
		$part .= "\nContract Amount : " . number_format($actual,2);
		if(strlen($variation) > 0){
			$part .= "\nAdd. Fund due to Variation order No. 1 : " . number_format($variation,2);
			$part .= "\nRevised Contract Amount " . number_format($actualAdjustment,2);
		}
		
		if($unperformed > 0){
			$part .= "\nLess : Unperformed Works" . number_format($unperformed,2);
			$part .= "\nRevised Contract Amount " . number_format($actualAdjustment,2);
		}
		if($type == "1st Payment"){
			$part .= "\nAccomplishment to Date : " . $wholeProgress ."%";
		}else{
			$part .= "\nTotal Accomplishment : " . $wholeProgress ."%"  . ", Accomplishment Billed : " . $progress ."%";
		}
		
		
        $part .= "\nTax(2%)  " . number_format($gross,2) . " / 1.12 x .02  :  " .  number_format($two,2);
        $part .= "\nTax(5%)  " . number_format($gross,2) . " / 1.12 x .05  :  " .  number_format($five,2);
		$part .= "\n                                           			               Total Tax :  " .  number_format($tax,2);
		$part .= "\n										              Retention :  " . number_format($retention,2);
		if($ld > 0){
			$part .= "\n							     	          Liquidated Damages :  " .  number_format($ld,2);
		}
		$part .= "\n							     	                 Total Deduction :  " .  number_format($deduction,2);
		
			                                                        				
		// $sql = "Insert into particulars(TrackingNumber,Particulars) values('" . $tn . "','" . $part . "')";
		$sql = "Insert into particulars(TrackingNumber,Particulars,BatchNumber) values('" . $tn . "','" . $part . "', ".$partBatchNumber.")";
		$database->query($sql);
			

		$completion = '';
		$database->UpdateVoucherHistory($tn);               //update para sa completion
		$database->InsertToVoucherHistory($tn,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	
		
		echo $tn . "!@!" . $newTN;
	}

	if(isset($_GET['getNFStatusList'])){
		$tn = $database->charEncoder($_GET['tn']);
		$status = $database->charEncoder($_GET['status']);
		
		// $sql = "select  Status, StatusId from Status order by OrderStat asc";
		$sql = "select  Status, StatusId from Status WHERE Type = 'NF' order by OrderStat asc";
		$record = $database->query($sql);
		$options = '';
		$show = 1;
		while($data = $database->fetch_array($record)){
			$statusAll = trim($data['Status']);
			$statusId = $data['StatusId'];

			if(strpos($statusAll, 'CAO') > -1 && $accountType != 7) {
				$show = 0;
			}

			if($show == 1) {

				if($status == $statusAll){
					$options .= '<option value = "' . $statusAll . '" selected >' . $statusId . '.&nbsp;&nbsp; ' . $statusAll . '</option>';
				}else{
					$options .= '<option value = "' . $statusAll . '">' . $statusId . '.&nbsp;&nbsp; ' . $statusAll . '</option>';
				}

			}

		}

		$editor = "	<div class='editorContainer'>
						<table class='editorTable' style='font-family:Oswald;'>
							<tbody>
								<tr>
									<td class='editorHeader' colspan='2'>Editor
										<div onclick='closeAbsolute(this)' class='closeEditor'></div>
									</td>
								</tr>
								<tr>
									<td class='editorLabel'>Status</td>
									<td style='padding-bottom:20px; padding-top:40px;padding-right:40px;'>
										<select id='editNFStatus' class='select2' style='font-family:Oswald; font-size:20px; width:360px;'>
											".$options."
										</select>
									</td>
								</tr>
								<tr>
									<td colspan='2' style='padding-bottom:20px;text-align:center;'>
										<div id='editor".$tn."' class='button1 b1' onclick='editNFUpdateStatus(this)'>Save</div>
									</td>
								</tr>
							</tbody>
						</table>
					</div>";

		echo $editor;
	}

	if(isset($_GET['editNFUpdateStatus'])) {
		$tn = $database->charEncoder($_GET['tn']);
		$status = $database->charEncoder($_GET['status']);

		// $sql = "UPDATE vouchercurrent SET Status = \"".$status."\" WHERE TrackingNumber = \"".$tn."\"";
		$sql = "UPDATE vouchercurrent SET Status = \"".$status."\", DateModified = '".$dateEncoded."', ModifiedBy = '".$employeeNumber."' WHERE TrackingNumber = \"".$tn."\"";
		$database->query($sql);

		$completion = '';
		$database->UpdateVoucherHistory($tn);               //update para sa completion
		$database->InsertToVoucherHistory($tn,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

		echo $tn;
	}

	if(isset($_GET['saveINFRADetails'])) {
		$tn = $database->charEncoder($_GET['trackingNumber']);

		$sql = "select * from citydoc.signatories where role = 'Infra Requestor' limit 1";	
		$database->query($sql);
		
		$data = $database->fetch_array($record);
		$name = $data['Name'];
		
		$title = $data['Title'];
		$prefix = '';
		if(strlen($data['Prefix']) > 0  ){
			$prefix =  $data['Prefix'] . ' ';
		}
		$suffix = '';
		if(strlen($data['Suffix']) > 0  ){
			$suffix =  ', ' . $data['Suffix'];
		}
		$name = $prefix  . $name . $suffix;
		$sql = "UPDATE infra SET Requestor = '".$name."', RequestorTitle = '".$title."' WHERE TrackingNumber = '".$tn."'";
		$database->query($sql);

		echo "button". $tn;
	}
	if(isset($_GET['showInfraPhase1'])){		
		$sql = "SELECT * FROM status where phase = 1"; // status
		$record = $database->query($sql);
			
		/*$sql1 = "SELECT if(a.Fund = 'Development Fund','General Fund',a.Fund) as Fund,a.ProgramCode,b.Name 
				FROM ppmpmain a left join programcode b on a.ProgramCode = b.Code 
				where type = 'Infrastructure'  group by a.ProgramCode order by Name asc"; // projects
		$record1 = $database->query($sql1);	*/
		$sql1 = "SELECT Id, Fund, Code, Lump, Name, FundYear, Entry FROM  programcode where Category = 'Infrastructure Project'  order by Name asc"; // projects
		$record1 = $database->query($sql1);
		
		
		$sql2 = "SELECT a.InfraId,a.TrackingNumber,a.Fund,a.Amount,a.PO_Amount,a.PR_ProgramCode, a.Status,a.Claimant,a.DateEncoded, a.DateModified, a.Amount,b.StatusId,b.Color,b.Office FROM 
				vouchercurrent a left join status b on a.status = b.Status 
				where TrackingType = 'NF' and a.Status  != 'Cancelled'";  //transactions
		$record2 = $database->query($sql2);	
		
		
		$statusIdString = '-';
		$transactionArray = array();
		while($data = $database->fetch_array($record2)){
			$programCode = $data['PR_ProgramCode'];
			$statusId = $data['StatusId'];
			$status = trim($data['Status']);
			$tn = $data['TrackingNumber'];
			$color = $data['Color'];
			$fund = $data['Fund'];
			$location = $data['Office'];
			$infraId = $data['InfraId'];
			if($status == "Acknowledge Certification Request" || $status == "Fund Certification Signed" ){
				if($fund == "Trust Fund"){
					$color = "rgb(74, 144, 226)";
					$location = "City Accountant's Office";
				}else{
					$color = "rgb(255, 0, 0)";
					$location = "City Budget Office";
				}
			}
			
			$encoded = $data['DateEncoded'];
			$totalDays = $database->ezDateTotalDay($encoded);
			$workingDays = $database->mondayToFriday($encoded);
			
			$dateModified = $data['DateModified'];
			$dateModifiedCount =  $database->ezDateDay($data['DateModified']);
			
			$amount = $data['Amount'];
			$net = $data['PO_Amount'];
				
			$match = preg_match('/pending/i', $status);
			if($match == 1){
				$match1 = preg_match('/' . $status . '/i', $statusIdString);
				if($match1 == 0){
					$statusIdString .= $status . '-';
				}
			}
			/*$transactionArray[$programCode][$statusId] = $tn . '*' . $dateModifiedCount . '*' . $color  . '*' . $encoded  . '*' . 
														$totalDays  . '*' . $dateModified . '*' . $status . '*' .
													    $amount . '*' . $net  . '*' . $location . '*' . $workingDays;*/
			$transactionArray[$infraId][$statusId] = $tn . '*' . $dateModifiedCount . '*' . $color  . '*' . $encoded  . '*' . 
														$totalDays  . '*' . $dateModified . '*' . $status . '*' .
													    $amount . '*' . $net  . '*' . $location . '*' . $workingDays;
		}
		
		$sheetTDcontent = '';
		$sheetHeader = '<tr>
							<th colspan = "2" style ="background-color:rgb(250, 252, 250);padding-right:10px;">
								
								<table id ="tableLegend" style = "border-collapse:collapse; text-align:left;border:1px solid silver;font-family:tahoma;padding:2px;float:right;box-shadow:0px 0px 10px 1px silver;">
									<tr><th colspan = "2" style = "font-size:13px;background-color:rgb(201, 203, 74);color:white;padding:2px 5px;text-align:center;font-weight:bold;">Office Legend</th></tr>
									<tr><th style = "font-size:12px;">CEO</th><th><div class ="colorOffice" style = "background-color:rgb(245, 166, 35)">&nbsp;</div></th></tr>
									<tr><th style = "font-size:12px;">Admin</th><th><div class ="colorOffice" style = "background-color:rgb(126, 211, 33)">&nbsp;</div></th></tr>
									<tr><th style = "font-size:12px;">Accounting</th><th><div class ="colorOffice" style = "background-color:rgb(74, 144, 226)">&nbsp;</div></th></tr>
									<tr><th style = "font-size:12px;">Controller</th><th><div class ="colorOffice" style = "background-color:rgb(188, 144, 219)">&nbsp;</div></th></tr>
									<tr><th style = "font-size:12px;">Budget</th><th><div class ="colorOffice" style = "background-color:red">&nbsp;</div></th></tr>
									<tr><th style = "font-size:12px;">BAC - Secretariat</th><th><div class ="colorOffice" style = "background-color:rgb(134, 134, 134)">&nbsp;</div></th></tr>
									<tr><th style = "font-size:12px;">BAC - Chairman</th><th><div class ="colorOffice" style = "background-color:rgb(0, 0, 0)">&nbsp;</div></th></tr>
									<tr><th style = "font-size:12px;">Office</th><th><div class ="colorOffice" style = "background-color:rgb(255, 204, 231)">&nbsp;</div></th></tr>
									<tr><th style = "font-size:12px;">Contractor</th><th><div class ="colorOffice" style = "background-color:rgb(80, 227, 194)">&nbsp;</div></th></tr>
								</table>
								
							</th>
							
							<th></th>
							';
						
		$sheetOffice = '<tr style = "background-color:transparent;">
							<th style = "border-bottom:2px solid silver;background-color:rgb(237, 237, 234);" colspan ="3">
								<table id  ="tableFundControls" style ="float:right;width:200px;padding:0;border-collapse:collapse; margin-right:22px;border:1px solid silver;" border ="0">
									<tr style = "background-color:white;">
										<td style = "vertical-align:top;text-align:center;" onclick ="tdClickFund(this)"><input type ="radio" id  ="optTF" name = "optionFund" onclick ="clickFundType(this)"></td>
										<td style = "vertical-align:top;text-align:center;" onclick ="tdClickFund(this)"><input type ="radio" id  ="optSF" name = "optionFund" onclick ="clickFundType(this)"></td>
										<td style = "vertical-align:top;text-align:center;" onclick ="tdClickFund(this)"><input type ="radio" id  ="optGF" name = "optionFund" onclick ="clickFundType(this)"></td>
										<td style = "vertical-align:top;text-align:center;" onclick ="tdClickFund(this)"><input type ="radio" id  ="optAll" name = "optionFund" onclick ="clickFundType(this)" checked></td>
										<td style = "vertical-align:top;text-align:center;"><input type ="checkbox" id  ="checkList" checked></td>
										<td style = "vertical-align:top;text-align:center;"><input type ="checkbox" id  ="checkCode" onclick ="showCode(this)"></td>
										
									</tr>
									<tr >
										<td style= "text-align:center;background-color:rgb(250, 61, 105);border:2px solid white;color:white;border-left:1px solid white;"><label for = "optTF">TF</label></td>
										<td style= "text-align:center;background-color:rgb(209, 184, 39);border:2px solid white;color:white;"><label for = "optSF">SEF</label></td>
										<td style= "text-align:center;background-color:rgb(92, 137, 222);border:2px solid white;color:white;"><label for = "optGF">GF</label></td>
										<td style= "text-align:center;border:2px solid white;"><label for = "optAll">All</label></td>
										<td style= "text-align:center;border:2px solid white;border-right:1px solid silver;"><label for = "checkList">List</label></td>
										<td style= "text-align:center;border:2px solid white;border-right:1px solid silver;"><label for = "checkCode">Code</label></td>
										
									</tr>
								</table>	
							</th>
							';
		
		$statusArray = array();
		$i = 0;
		$color = '';
		$visibleLimit =1; 
		$counterVisible = 1;
		while($data = $database->fetch_array($record)){ // sa header rows
			$id = $data['StatusId'];
			$office = $data['Office'];
			$division = $data['Division'];
			$visible = $data['Visible'];
			if($office == "City Accountant's Office"){
				$color = "rgb(74, 144, 226)";
			}else if($office == "City Budget Office"){
				$color = "rgb(208, 2, 27)";
			}else if($office == "City Administrator's Office"){
				$color = "rgb(126, 211, 33)";
			}else if($office == "Bids and Awards Committee"){
				$color = "rgb(134, 134, 134)";
				if($division == "Chairman"){
					$color = "rgb(0, 0, 0)";
				}
			}else if($office == "City Engineer's Office"){
				$color = "rgb(245, 166, 35)";
			}else if($office == "Contractor"){
				$color = "rgb(80, 227, 194)";
			}else if($office == "Controller"){
				$color = "BC90DB";
			}else if($office == "Impementing Office"){
				$color = "FFCCE7";
			}
			
			$status = trim($data['Status']);	
			if($visible == 0){
				$visibleLimit++;
				$match = preg_match('/-' . $status . '-/i', $statusIdString);
				if($match == 1){
					$counterVisible++;
					$statusArray[$i++] = $id . '*' . 1;
					$sheetHeader .= '<th class="rotate" style ="font-family:NOR;"><div><span>' .$status . '</span><br/></div></th>';
					$sheetOffice .= '<th class = "tdOffice"><div class = "headerNumber">' . $i . '</div><div class ="colorOffice" style = "background-color:' . $color . ';">&nbsp;</div></th>';
					
				}else{
					$statusArray[$i++] = $id . '*' . $visible;
					$sheetHeader .= '<th class="rotate" style = "display:none;font-family:NOR;"><div><span>' .$status . '</span><br/></div></th>';
					$sheetOffice .= '<th class ="colorOffice" style = "display:none;" ><div class = "headerNumber">' . $i . '</div><div style = "background-color:' . $color . ';">&nbsp;</div></th>';
				}
			}else{
				$statusArray[$i++] = $id . '*' . $visible;
				$sheetHeader .= '<th class="rotate" style = "display:table-cell;font-family:NOR;"><div><span>' .$status . '</span><br/></div></th>';
				$sheetOffice .= '<th class = "tdOffice" style = "display:table-cell;" ><div class = "headerNumber">' . $i . '</div><div class ="colorOffice" style = "background-color:' . $color . ';"></div></th>';
			}
		}
		$sheetHeader .= '<th colspan = "3" ></th>
						
						 </tr>';
		$sheetOffice .= '<td style = "font-family:NOR; background-color:727A72;font-size:10px;color:white;text-align:center;">CALENDAR DAYS</td>
						 <td style = "font-family:NOR;background-color:727A72;tahoma;font-size:10px;color:white;text-align:center;">WORKING DAYS</td>
						 <td style = "font-family:NOR;background-color:727A72;tahoma;font-size:10px;color:white;text-align:center;">';
		$sheetOffice .= 'PROGRESS';		 
		$sheetOffice .= '</td></tr>';	
	
		echo "<div class = 'triangle' onclick = 'newLink()'></div>";
		echo "<div class = 'trianglePointer' onclick = 'newLink()'></div>";
		
		$title = '<tr style ="font-family:NOR;font-weight:bold;">
					<th  style = "text-align:right;vertical-align:bottom;color:grey;">INFRASTRUCTURE PROJECT
						<div style = "font-size:18px;line-height:12px;color:silver;"><span style = "font-size:16px;">CY</span> <span id="infraPBPYear">2023</span></div>
						<div id ="logoInfra"></div>
					</th>
				  	<th colspan ="50%" style = "text-align:left;font-size:22px;font-weight:bold;vertical-align:bottom;line-height:20px;">PREPARATION, BIDDING AND PRE-CONSTRUCTION PHASE
				  		<div style = "font-size:14px;line-height:12px;color:rgb(77, 132, 70);">CITY GOVERNMENT OF DAVAO, PHILIPPINES</div>
				  		
				  	</th>
				  	<th colspan ="50%" style ="vertical-align:bottom;padding-right:10px;font-family:oswald;">
				  		<span style = "font-size:12px;float:right;display:inline;color:grey;letter-spacing:1px;font-weight:normal;">Today : ' . $dateEncoded . '</span>
				  	</th>
				  </tr>';
		$sheet  = '<table id  = "tableInfra" border = "0" style = "border-bottom:1px solid silver; width:100%;">';
		$sheet .= $title;
		$sheet .= $sheetHeader;
		$sheet .= $sheetOffice;
		$colorTail = "rgb(77, 132, 70)";
		$j = 1;
		
		while($data = $database->fetch_array($record1)){
			$startBorder = 0;
			$border = 0;
			/*$code = $data['ProgramCode'];
			$name = utf8_encode($data['Name']);
			$fund = $data['Fund'];*/
			$infraId = $data['Id'];
			$code = $data['Code'];
			$lump = $data['Lump'];
			if(strlen($lump) > 0){
				$code = $lump;
			}
			
			$name = utf8_encode($data['Name']);
			$fund = $data['Fund'];
			$fundYear = $data['FundYear'];
			$entry = $data['Entry'];
			if($entry == "Regular"){
				$entry = '';
			}
			if($fund == "General Fund"){
				$fund = "GF";
				$colorFund = "rgba(92, 137, 222,.2)";
			}else if($fund == "SEF"){
				$fund = "SF";
				$colorFund = "rgba(209, 184, 39,.2)";
				
			}else if($fund == "Trust Fund"){
				$fund = "TF";
				$colorFund = "rgba(250, 61, 105,.2)";
			}
			//$colorFund = '';
			if(isset($transactionArray[$infraId])){
				$colorTail = "rgb(77, 132, 70)";
				$startBorder = 1;
				$borderContentTop = "1px solid rgb(137, 166, 105);";
			}else{
				$colorTail = "";
				$startBorder = 0;
				$borderContentTop = "";
			}
			$sheet .= '<tr class = "trContentInfra" name = "' . $fund . '*' . $startBorder .'" >';
			$sheet .= '<td class = "headerRow" style = "border-left:1px solid silver;font-size:12px;font-family:NOR;padding:5px 0px;padding-right:2px;">'  . $name . '</td>
					   <th  style = "height:100%;border:1px solid white;background-color:white;width:1px;">
						   	<div style = "text-align:left;padding-left:2px;border:0; height:100%;font-family:NOR;background-color:' . $colorFund . ';">
						   		<span class ="programCode" style ="height:100%;padding:0px 2px;font-weight:normal;font-size:12px;display:none;"><b style = "color:black;">' . $entry . ' ' . $fundYear . '</b> - '  . $code . '</span>
						   	</div>
					   	</th>';
			$sheet .= '<th class = "headerNumber" style = "">' . $j++ . '</th>';
			$sizeStatus = sizeof($statusArray);
			
			
			$appeared = ($sizeStatus - $visibleLimit) + $counterVisible;
			$k = 0;
			$emptyRow = '';
			for($i = 0; $i < sizeof($statusArray) ; $i++){
				$arr = explode('*',$statusArray[$i]);
				$id = $arr[0];
				$visible = $arr[1];
				
				
				$v = "table-cell";
				if($visible == 0){
					$v = "none";
					$k--;
				}
				if(isset($transactionArray[$infraId][$id])){
					$details = $transactionArray[$infraId][$id];
					$arr = explode('*',$details);
					$tn = $arr[0];
					$dateModifiedCount = $arr[1];
					$color = $arr[2];
					$encoded = $arr[3];
					$totalDays= $arr[4];
					$dateModified = $arr[5];
					$status = $arr[6];
					$amount = $arr[7];
					$net = $arr[8];
					$location = $arr[9];
					$workingDays = $arr[10];
					$percent = abs(number_format($id / sizeof($statusArray),2)) * 100;
					
					
					$index = $k;
					$colspan = $appeared - $index;
					
					if($k > 0){
						$sheet .= '<td colspan = "' . $index . '" style ="background-color:rgb(137, 166, 105);border-top:1px solid rgba(172, 210, 171,.5);">';
						if($k > 20){
							$sheet .=  '<table border = "0" style = "margin-right:-25px; float:right;font-family:NOR;font-size:12px;border-collapse:collapse;width:600px;">
											<tr>
												<th style = "padding-right:5px;color:white;font-size:16px;font-weight:normal;text-align:right;">
													<span class ="infraDaysUpdated" style = "color:white;">' . $dateModifiedCount  . '</span>
													<span  class ="infraDaysUpdated" style = "color:white;font-weight:normal;padding-left:5px;padding-right:10px;">' . $dateModified .  '</span>
													<span style = "text-shadow:0px 0px 2px black;">' .$status . '</span></th>
												<th class = "tn" style = "cursor:pointer;color:black;font-size:14px; cursor:pointer; width:80px;" onclick = "clickToSearchInfra(this)">' . $tn . '</th>
												<th style = "width:1px;padding-left:-5px;">
													<div id = "' . $encoded  . '*' . $tn  . '*' . $amount  . '*' . $net  . '*' . $location . '" onclick ="hoverColor(this)" class = "colorOfficeMid"  
													style = " background-color:' . $color. ';"></div>
												</th>
											</tr>	
										</table>' ; 
						}	
					}
					$sheet .= '</td>';
					$sheet .= '<td colspan = "' . $colspan   . '" class = "tdContentInfra" style = "border:0;text-align:left;
								border-top:1px solid white;vertical-align:middle;padding:0;" >';
					if($k <= 20){
						$sheet .=  '<table border = "0" style = "font-family:NOR;font-size:12px;border-collapse:collapse;">
										<tr>
											<th style = "width:1px;padding: 0px 3px;">
												<div id = "' . $encoded  . '*' . $tn  . '*' . $amount  . '*' . $net  . '*' . $location . '" onclick ="hoverColor(this)" class = "colorOfficeMid"  
												style = " background-color:' . $color. ';"></div>
											</th>
											<th class = "tn" style = "cursor:pointer;color:black;font-size:14px;padding:0px 10px;" onclick = "clickToSearchInfra(this)">' . $tn . '</th>
											<th style = "padding-right:10px;font-size:16px;font-weight:normal;">' .$status . '</th>
											
											
											<th style = "font-weight:normal;color:black;width:200px;text-align:left;">
												<span class ="infraDaysUpdated" >' . $dateModifiedCount  . '</span>
												<span  class ="infraDaysUpdated" style = "color:grey;font-weight:normal;padding-left:5px;">' . $dateModified .  '</span>

											</th>
										</tr>
									</table>' ; 		
					}				
					$sheet .= '</td><td style ="font-family:NOR;text-align:center;font-size:16px;text-shadow:0px 0px 2px white;">' . $totalDays . '</td>
									<td style ="font-family:NOR;text-align:center;font-size:16px;text-shadow:0px 0px 2px white;">'  . $workingDays . '</td>
									<td style ="font-family:NOR;text-align:center;font-size:16px;">'  . $percent . '%</td> ';
					$colorTail = "";
					break;
				}else{
					if($startBorder == 1){
						$border = "0";	
					}else{
						$border = "1px solid rgba(220, 232, 212);";	
					}
					$emptyRow .= '<td class = "tdContentInfra" style = "display:' . $v . '; border-right:' . $border . ';border-top:' . $borderContentTop . '; background-color:' . $colorTail . '"></td>';
					if($i == sizeof($statusArray)-1){
						$sheet .= $emptyRow;
						$sheet .= '<td ></td><td ></td>';
						$sheet .= '<td ></td>';
					}
					$k++;
				}	
			}
			$sheet .= '</tr>';
		}
		$sheet .= '<tr>
						<th colspan ="100%" style = "border-top:1px solid rgb(237, 240, 235);padding-top:10px;"></th>
					</tr></table>';
		echo $sheet ;
	}
	if(isset($_GET['showInfraPhase2'])){		
		$sheet = "<div class = 'triangle' ></div>";
		$sheet .="<div class = 'trianglePointer' onclick = 'newLink1()'></div>";
		$sheet .= '<table id  = "tableInfra" border = "0" style = "width:100%;">
						<tr style ="font-family:NOR;font-weight:bold;">
								<th  style = "text-align:right;vertical-align:bottom;color:grey;">INFRASTRUCTURE PROJECT
									<div style = "font-size:18px;line-height:12px;color:silver;"><span style = "font-size:16px;">CY</span> <span id = "infraConsYear">'  . $year . '</span></div>
									<div id ="logoInfra"></div>
								</th>
							  	<th colspan ="50%" style = "text-align:left;font-size:22px;font-weight:bold;vertical-align:bottom;line-height:20px;">CONSTRUCTION PHASE AND PROGRESS
							  		<div style = "font-size:14px;line-height:12px;color:rgb(77, 132, 70);">CITY GOVERNMENT OF DAVAO, PHILIPPINES</div>
							  	</th>
							  	<th colspan ="50%" style ="vertical-align:bottom;padding-right:10px;font-family:oswald;">
							  		<span style = "font-size:12px;float:right;display:inline;color:grey;letter-spacing:1px;font-weight:normal;">Today : ' . $dateEncoded . '</span>
							  	</th>
						</tr>
						
					</table>';
		
		$sql = "select TrackingNumber,Claimant,Amount,NetAmount from vouchercurrent where TrackingType = 'NF' and Status != 'Cancelled' and Status != 'Not Feasible'";
		$record = $database->query($sql);
		$listVC = array();
		while($data = $database->fetch_array($record)){
			
		 	$tn = $data['TrackingNumber'];
		 	
		 	$claimant = $data['Claimant'];
		 	$amount = $data['Amount'];
		 	$contractAmount = $data['NetAmount'];
		 	
		 	
		 	$listVC['Claimant'][$tn] = $claimant;
		 	$listVC['BudgetAmount'][$tn] = $amount;
		 	$listVC['ContractAmount'][$tn] = $contractAmount;
		 	
		}
		$sql = "select a.TrackingNumber,a.Progress,a.Duration,a.ProgressDate,a.Variation,a.Unperformed,a.Started,a.Completed,
				b.Name,b.Lump, b.Code,b.FundYear from 
				infra a left join 
				programcode b on a.trackingnumber = b.trackingnumberinfra where progress > 0 ORDER BY progressdate desc";
		$record = $database->query($sql);
		
		$sheet .= '<div  style = "background-color:white;padding:20px;height:100%;">';
		$sheet .='<table id ="constructionTableGraph">';
		$sheet .=	'<tr>
						<th></th>
						<th style ="text-align:left;">TN</th>
						<th style ="text-align:left;">Source of Fund</th>
						<th style ="text-align:right;">Budget</th>
						<th style ="text-align:right;">Contract</th>
						<th>Start</th>
						<th>End</th>
						<th>Duration</th>
					 	<th style ="text-align:left;">Project</th>
					 	<th style ="text-align:left;">Contractor</th>
					 	<th style ="text-align:left;width:200px;font-weight:normal;background-color:rgb(110, 114, 114);color:white;font-size:12px;">1%</th>
					 	<th style ="text-align:right;width:200px;font-weight:normal;background-color:rgb(110, 114, 114);color:white;font-size:12px;">100%</th>
					 	<th>Progress</th>
					 	<th style ="text-align:left;">Inspected</th>
					 	<th>Details</th>
					 </tr>';
		$i = 1;		
		
		while($data = $database->fetch_array($record)){
			$tn = $data['TrackingNumber'];
			$name = $data['Name'];
			$progress = $data['Progress'];
			$duration = $data['Duration'];
			$updated = '';	
			$dateUpdated = $data['ProgressDate'];
			$year = $data['FundYear'];
			$code = $data['Code'];
			$lump = $data['Lump'];
			if(strlen($dateUpdated) > 0 ){
				$updated = $database->ezDateDay($dateUpdated);
			}
			$variation = $data['Variation'];
			$unperformed = $data['Unperformed'];
			$started = $data['Started'];
			$completed = $data['Completed'];
			$actualContract = $listVC['ContractAmount'][$tn];
			if($variation > 0){
				$actualContract =  ($actualContract +  $variation);
			}
			if($unperformed > 0){
				$actualContract = ($actualContract - $unperformed);
			}
			if($lump > $code ){
				$code = $lump;
			}
			$status = '&nbsp;';
			if($progress < 50){
				$color ="rgb(201, 142, 155)";
			}else if($progress >= 100){
				$color = "rgb(95, 141, 170)";
				$status = 'COMPLETED';
			}else{
				$color = "rgb(126, 157, 129)";
			}
			$sheet .=	'<tr>
							<td style ="font-weight:bold;">' .$i++  . '</td>
							<td style="white-space:nowrap; cursor:pointer;" class="hover" onclick="clickToSearchInfra(this)">' .$tn  . '</td>
							<td >
								<div>' . $year  . '</div>
								<div>' . $code  . '</div>
							</td>
							<td style ="text-align:right;">' . number_format($listVC['BudgetAmount'][$tn],2) . '</td>
							<td style ="text-align:right;">' . number_format($actualContract,2) . '</td>
							<td>' .$started  . '</td>
							<td>' .$completed  . '</td>
							<td style ="text-align:center;">' . $duration. '</td>
							<td>' . $name . '</td>
							<td style = "">
								<div>' . $listVC['Claimant'][$tn] . '</div>
							</td>
							<td colspan ="2" style = "width:400px;padding-right:5px;vertical-align:middle;line-height:10px; ">
								<div style = "border-radius:0px 2px 2px 0px; background-color:' . $color . ';width:' . $progress . '%;padding:1px;font-weight:bold;letter-spacing:2px; font-size:10px;color:white;font-family:Arial;text-align:center;">' . $status . '</div>
							</td>
							<td style ="text-align:center;width:70px;vertical-align:middle;">' . $progress. '</td>
							
							<td style ="text-align:left;vertical-align:middle;">' . $updated . '</td>
							<td style ="vertical-align:middle;padding:0px 5px;text-align:center;">
								<div  class ="button1" onclick = "newLinkProject(this)" style = "display:inline-block;letter-spacing: 1px;padding:2px 5px;" id ="' . $tn . '">show</div></td>
						</tr>';
		}
		$sheet .= '</table>';
		$sheet .= '</div>';
		echo $sheet ;
	}
	
	
	
	if(isset($_GET['updateInfraTF'])){
		$tn = $database->charEncoder($_GET['trackingNumber']);
		$fund = $database->charEncoder($_GET['fund']);
		$reference = $database->charEncoder($_GET['reference']);
		$arr = explode('-',$reference);
		$year = $arr[1];
		$seq = $arr[2];
		$sql = "update  infra set Fund = '" . $fund . "',  ReferenceCert = '" . $reference . "' where TrackingNumber = '" . $tn . "'";
		$database->query($sql);
		$sql = "update  citydoc.defaults set TF = '" . $seq . "' where YearFundEncoded = '" . $year . "'";
		$database->query($sql);
	}
	if(isset($_GET['saveRemark'])){
		$tn = $database->charEncoder($_GET['tn']);
		$office = addslashes($_SESSION['officeName']);
		
		$note = strip_tags($database->charEncoder($_GET['value']));
		
		$value = '<div class = "remarkMessage">' . $note . '</div>';
		$value .= '<div class ="remarkOffice">' .  $office .  '</div>';
		$value .= '<div class ="remarkCreated">' . $dateEncoded .  '</div>';
		
		//$sql = "update infra set Remarks =  concat('" . $value . "', Remarks) where trackingnumber = '" . $tn . "'";
		$sql = "update infra set Remarks = concat('"  . $value . "', ifnull(Remarks,'')) where trackingnumber = '" . $tn . "'";
		$database->query($sql);
		
		$record = $database->SearchTracking($tn);
		echo $sheet->CreateDoctrackInfoPR($record);
	}
	
	
	if(isset($_GET['saveNewProject'])){
		
		$lump = $database->charEncoder($_GET['lump']);
		$office = $database->charEncoder($_GET['office']);
		$entry = $database->charEncoder($_GET['entry']);
		$fund = $database->charEncoder($_GET['fund']);
		$code = $database->charEncoder($_GET['code']);
		$expense = $database->charEncoder($_GET['expense']);
		$description = $database->charEncoder($_GET['description']);
		$amount = $database->charEncoder($_GET['amount']);
		$milestone = $database->charEncoder($_GET['milestone']);
		$fundYear = $database->charEncoder($_GET['fundYear']);
		$subcode = $database->charEncoder($_GET['subcode']);
		
		if($lump == "No"){
			$sql = "select code from programcode where InfraCode ='" . $code . "' or  Code ='" . $code . "' or Name  = '" . $description . "' limit 1";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			if($count > 0){
				echo "<div class = 'remarks'>Project : ''" . $code . ' ' . $description .   "'' already exist.</div>";
			}else{
				$sql = "Insert into programcode (Amount,Milestone,ExpenseCode,Fund,Entry,Office,Category,InfraCode,Code,Name,DateEncoded,FundYear,SubCode)
						values('" . $amount . "','" . $milestone . "','" . $expense . "','" . $fund . "','" . $entry . "','" .$office . "','Infrastructure Project','" . $code . "','" . $code . "','" . $description . "','" . $dateEncoded . "','" . $fundYear . "','" . $subcode . "')";
				$infraId = $database->insertReturnId($sql);
				
				
				$field = $database->numToMonthField($milestone);
				$sql = "Insert into ppmpmain (Type,OfficeCode,ProgramCode,AccountCode,Fund,Category,Item,Description,Unit,Cost,Total," . $field . ",InfraId)
						values('Infrastructure','" . $office . "','" . $code . "','" . $expense . "','" . $fund . "','CAT 100','" . $description . "','" . $description . "','Lot'," . $amount . "," . $amount . ",'" . $milestone . "','" . $infraId . "')";
				$database->query($sql);
			}
			echo $sheet->createInfraProjects();
		}else{
			$sql = "select InfraCode,Name from programcode where Name ='" . $description . "' limit 1";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			if($count > 0){
				$data = $database->fetch_array($record);
				$infraCode = $data['InfraCode'];
				echo "<div class = 'remarks'>Project Name : ''" . $description . "'' already exist in Project Code : ''" . $infraCode . "''</div>";
			}else{
				$sql = "select Series,Lump from programcode where Lump = '" . $code . "' order by id desc limit 1";
				$record = $database->query($sql);
				$count = $database->num_rows($record);
				$seq = 1;
				if($count > 0){
					$data = $database->fetch_array($record);
					$series = $data['Series'];
					$seq = ($series+1);
				}
				$sql = "Insert into programcode (Series,Amount,Milestone,ExpenseCode,Fund,Entry,Office,Category,Lump,Name,DateEncoded,FundYear,SubCode)
						values('" . $seq . "', '" . $amount . "','" . $milestone . "','" . $expense . "','" . $fund . "','" . $entry . "','" .$office . "','Infrastructure Project','" . $code . "','" . $description . "','" . $dateEncoded . "','" . $fundYear . "','" . $subcode . "')";
				$infraId = $database->insertReturnId($sql);
				
				$field = $database->numToMonthField($milestone);
				$sql = "Insert into ppmpmain (Type,OfficeCode,ProgramCode,AccountCode,Fund,Category,Item,Description,Unit,Cost,Total," . $field . ",InfraId)
						values('Infrastructure','" . $office . "','" . $code . "','" . $expense . "','" . $fund . "','CAT 100','" . $description . "','" . $description . "','Lot'," . $amount . "," . $amount . ",'" . $milestone . "','" . $infraId . "')";
				$database->query($sql);
				echo $sheet->createInfraProjects();
			}
		}
		
	}
	if(isset($_GET['fetchInfraProjects'])){
		echo $sheet->createInfraProjects();
	}
	if(isset($_GET['removeThisProject'])){
		$id = $database->charEncoder($_GET['id']);
		$sql = "delete from programcode where id  = '" . $id . "'";
		$database->query($sql);
		
		$sql = "delete from ppmpmain where InfraId  = '" . $id . "'";
		$database->query($sql);
		
		echo $sheet->createInfraProjects();
	}
	
	if(isset($_GET['saveNowMyNumber'])){
		$crypt = $database->charEncoder($_GET['txet']);
		$arr = explode('~!~', $database->vArrange($crypt));
		$year = $arr[0];
		$tn = $arr[1];
		$number = $arr[2];
		
		$sql ="select * from citydoc.sms2 where year  ='" . $year . "' and TrackingNumber = '" . $tn  . "' limit 1";
		$record = $database->query($sql);
		$count = $database->num_rows($record);
		if($count > 0){
			$sql ="select * from citydoc.sms2 where year  ='" . $year . "' and TrackingNumber = '" . $tn  . "' and Numbers like '%" . $number . "%' limit 1";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			if($count == 0){
				$sql ="update citydoc.sms2 set Numbers = concat(Numbers,';','" . $number . "') where Year = '" . $year . "' and TrackingNumber = '" . $tn . "'";
				$database->query($sql);
			}
		}else{
			$sql = "insert into citydoc.sms2 (Year,TrackingNumber,Numbers) value('" . $year . "','" . $tn . "','" . $number . "')";
			$database->query($sql);
		}
	}
	if(isset($_GET['loadOBRfunds'])){
		$sql = "select * from programcode where  code > 0 order by code asc";
		$record = $database->query($sql);
		$sheet = '<select id = "selectOBRfund" style ="display:inline;width:18px;padding:0;border:0;" onchange ="selectFundOBR(this)">';
		$sheet .= '<option></option>';
		while($data = $database->fetch_array($record)){
			$code = $data['Code'];
			$name = $data['Name'];
			$sheet .= '<option value = "'.$code.'">' . $code . '  ' . $name . '</option>';
		}
		$sheet .= '</select>';
		echo $sheet;
	}
	if(isset($_GET['selectFundOBR'])){
		$code = $database->charEncoder($_GET['code']);
		
		if($code == "1011-1"){
			$sql = "SELECT count(a.Id) as Count,sum(Amount) as Total,PR_AccountCode,SubCode,PeaceOfficeId,b.Title,b.Fund,c.Name
				FROM vouchercurrent a
				left join fundtitles b on a.PR_AccountCode = b.Code
				left join peace c on a.PeaceOfficeId = c.OfficeId
				where 
				pr_programcode ='" . $code . "' and status != 'Cancelled' and status != 'Encoded' and TrackingType = 'PY' and OBR_Number > 0
				group by PeaceOfficeId,Title order by Fund,Title;";
			$record = $database->query($sql);
			echo $sheet->createExpenseByCodeBalance1('PY',$record);
			
			$sql = "SELECT count(a.Id) as Count,sum(Amount) as Total,PR_AccountCode,SubCode,PeaceOfficeId,b.Title,b.Fund,c.Name
				FROM vouchercurrent a
				left join fundtitles b on a.PR_AccountCode = b.Code
				left join peace c on a.PeaceOfficeId = c.OfficeId
				where 
				pr_programcode ='" . $code . "' and status != 'Cancelled' and status != 'Encoded' and TrackingType = 'PR' and OBR_Number != ''
				group by PeaceOfficeId,Title order by Fund,Title;";
			$record = $database->query($sql);
			echo $sheet->createExpenseByCodeBalance1('PR',$record);
			
			
			$sql = "SELECT count(a.Id) as Count,sum(PO_Amount) as Total,PR_AccountCode,SubCode,PeaceOfficeId,b.Title,b.Fund,c.Name
				FROM vouchercurrent a
				left join fundtitles b on a.PR_AccountCode = b.Code
				left join peace c on a.PeaceOfficeId = c.OfficeId
				where 
				pr_programcode ='" . $code . "' and status != 'Cancelled' and status != 'Encoded' and TrackingType = 'PO' and OBR_Number > 0
				group by PeaceOfficeId,Title order by Fund,Title;";
			$record = $database->query($sql);
			echo $sheet->createExpenseByCodeBalance1('PO',$record);
			
		}else{
			$sql = "SELECT count(a.Id) as Count,sum(Amount) as Total,PR_AccountCode,b.Title,b.Fund
				FROM vouchercurrent a
				left join fundtitles b on a.PR_AccountCode = b.Code
				where 
				pr_programcode ='" . $code . "' and status != 'Cancelled' and status != 'Encoded' and TrackingType = 'PY' and OBR_Number > 0
				group by Title order by Fund,Title;";
			$record = $database->query($sql);
			echo $sheet->createExpenseByCodeBalance('PY',$record);
			
			$sql = "SELECT count(a.Id) as Count,sum(Amount) as Total,PR_AccountCode,b.Title,b.Fund
				FROM vouchercurrent a
				left join fundtitles b on a.PR_AccountCode = b.Code
				where 
				pr_programcode ='" . $code . "' and status != 'Cancelled' and status != 'Encoded' and TrackingType = 'PR' and OBR_Number != ''
				group by Title order by Fund,Title;";
			$record = $database->query($sql);
			echo $sheet->createExpenseByCodeBalance('PR',$record);
			
			
			$sql = "SELECT count(a.Id) as Count,sum(PO_Amount) as Total,PR_AccountCode,b.Title,b.Fund
					FROM vouchercurrent a
					left join fundtitles b on a.PR_AccountCode = b.Code
					where 
					pr_programcode ='" . $code . "' and status != 'Cancelled' and status != 'Encoded' and TrackingType = 'PO' and OBR_Number > 0
					group by Title order by Fund,Title;";
			$record = $database->query($sql);
			echo $sheet->createExpenseByCodeBalance('PO',$record);
		}
		
		
		
		
	}
	if(isset($_GET['selectTransactionsInBalances'])){
		$program = trim($database->charEncoder($_GET['program']));
		$expenseCode = $database->charEncoder($_GET['expenseCode']);
		$type = $database->charEncoder($_GET['type']);
		$pId = $database->charEncoder($_GET['pId']);
		
		$case ='';
		if($program == "1011-1"){
			if(strlen($pId)> 0){
				$case = " and PeaceOfficeId = '" . $pId . "'";
			}else{
				$case = " and PeaceOfficeId is null";
			}
			
		}
		
		if($type != 'PO'){
			$sql = "SELECT TrackingType,Claimant,PR_ProgramCode,SubCode,PR_AccountCode,PeriodMonth,DateModified,OBR_Number,TrackingNumber,DocumentType, Amount as Total,b.Title, TotalAmountMultiple,Status,Name FROM vouchercurrent a 
				left join fundtitles b on a.PR_AccountCode = b.Code left join 
				office c on a.Office = c.Code where pr_programcode ='" . $program . "' and PR_AccountCode = '" . $expenseCode . "' 
				and status != 'Cancelled' and status != 'Encoded' and TrackingType = '" . $type . "' and OBR_Number != '' $case
				
				
				order by claimant;";
			$record = $database->query($sql);
		}else{
			$sql = "SELECT TrackingType,Claimant,PR_ProgramCode,SubCode,PR_AccountCode,PeriodMonth,DateModified,OBR_Number,TrackingNumber,DocumentType, PO_Amount as Total,b.Title, TotalAmountMultiple,Status,Name FROM vouchercurrent a 
				left join fundtitles b on a.PR_AccountCode = b.Code left join 
				office c on a.Office = c.Code where pr_programcode ='" . $program . "' and PR_AccountCode = '" . $expenseCode . "' 
				and status != 'Cancelled' and status != 'Encoded' and TrackingType = '" . $type . "' and OBR_Number > 0 $case order by claimant;";
			$record = $database->query($sql);
		}
		echo $sheet->createTransactionByCodeBalance($record);
	}
	if(isset($_GET['fetchSubProgramBalance'])){
		$tn = $database->charEncoder($_GET['tn']);
		$sql = "select * from peace order by fund,name asc";
		$record = $database->query($sql);
		echo $sheet->createPeaceOffice($record,$tn);
	}
	
	if(isset($_GET['updatePeaceSubcode'])){
		$program = trim($database->charEncoder($_GET['program']));
		$expenseCode = $database->charEncoder($_GET['expenseCode']);
		$officeId = $database->charEncoder($_GET['officeId']);
		$subcode = $database->charEncoder($_GET['subcode']);
		$tn = $database->charEncoder($_GET['tn']);
		
		$sql = "update vouchercurrent set PeaceOfficeId = '" . $officeId . "', Subcode = '" . $subcode . "' where TrackingNumber = '" . $tn . "'";
		$database->query($sql);
		
		
		$sql = "SELECT TrackingType,Claimant,PR_ProgramCode,SubCode,PR_AccountCode,PeriodMonth,DateModified,OBR_Number,TrackingNumber,DocumentType, Amount as Total,b.Title, TotalAmountMultiple,Status,Name FROM vouchercurrent a 
				left join fundtitles b on a.PR_AccountCode = b.Code left join 
				office c on a.Office = c.Code where pr_programcode ='" . $program . "' and PR_AccountCode = '" . $expenseCode . "' 
				and status != 'Cancelled' and status != 'Encoded' and TrackingType = 'PY' and OBR_Number != '' order by claimant;";
		$record = $database->query($sql);
		echo $sheet->createTransactionByCodeBalance($record);
	}

	if(isset($_GET['updateTrackingForwardPending'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$remarks = $database->charEncoder($_GET['remarks']);

		// $office = $_SESSION['cbo'];
		// $employeeNumber = $_SESSION['employeeNumber'];
		// $accountType = $_SESSION['accountType'];

		if($office == '1081' && $accountType == '4'){
			$sql = "SELECT Remarks FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$oldNote = $data['Remarks'];

			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $remarks . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CAO</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $remarks . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CAO</b></span>';
			}

			$completion = '';
			$status = 'Pending at CAO';
			$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "', Remarks = '".$pendingNote."'";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
		}

		$record = $database->SearchTracking($trackingNumber);
		$count =  $database->num_rows($record);
		if($count > 0){
			echo $sheet->CreateDoctrackInfoPR($record);
		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}

	if(isset($_GET['showSubCodeSelectionEditDirect'])){
		$tn = $database->charEncoder($_GET['tn']);
		$sql = "select * from peace order by fund,name asc";
		$record = $database->query($sql);
		echo $sheet->createPeaceOfficeEDITDirect($record, $tn);
	}

	if(isset($_GET['updateEDITPEORDirect'])){
		$subCode = $database->charEncoder($_GET['subCode']);
		$peorOfc = $database->charEncoder($_GET['peorOfc']);
		$tn = $database->charEncoder($_GET['tn']);
		$sql = "UPDATE vouchercurrent SET PeaceOfficeId = '" . $peorOfc . "', Subcode = '" . $subCode . "' where TrackingNumber = '" . $tn . "'";
		$record = $database->query($sql);
		echo $tn;
	}
	if(isset($_GET['fetchPaymaster'])){
		/*$sql = "select a.TrackingNumber,Claimant,Fund, DocumentType,Status, DateModified,Amount,b.Window,NumOfEmps FROM vouchercurrent a
				left join particulars b on a.trackingnumber= b.trackingnumber
				where DocumentType = 'CASH ADVANCE TO PAYMASTER' and TrackingPartner = 'Multiple'
				order by datemodified desc
				";*/
		$sql = "select a.TrackingNumber,Claimant,Fund, DocumentType,Status, DateModified,Amount,b.Window,NumOfEmps FROM vouchercurrent a
				left join particulars b on a.trackingnumber= b.trackingnumber
				where DocumentType = 'CASH ADVANCE TO PAYMASTER' and Status != 'Cancelled'
				order by datemodified desc
				";
		$record = $database->query($sql);
		echo $sheet->CreatePaymasterList($record);
	}
	if(isset($_GET['getPaymasterTracking'])){
		$tn = $database->charEncoder($_GET['tn']);
		$sql = "select  a.TrackingNumber,Claimant,a.Fund, DocumentType,Status, DateModified,a.Amount, a.NetAmount, a.OBR_Number, a.ADV1,PR_ProgramCode,PR_AccountCode,b.Name,c.Title from 
				vouchercurrent a left join programcode b on a.PR_ProgramCode = b.Code 
				left join fundtitles c on a.PR_AccountCode =c.Code
				where TrackingPartner = '" . $tn . "' order by Claimant asc";
		$record = $database->query($sql);
		echo $sheet->CreatePaymasterBreakdown($record);
	}
	if(isset($_GET['cancelCheck'])){
		
		$employeeNumber = $_SESSION['employeeNumber'];
		
		$tn = $database->charEncoder($_GET['tn']);
		$reason = $database->charEncoder($_GET['reason']);
		
		$sql = "select CheckDate,CheckNumber from vouchercurrent where trackingnumber = '" . $tn . "' limit 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$checkNumber = $data['CheckNumber'];
		$checkDate = $data['CheckDate'];
		
		
		$status = "Cancelled Check";
		$sql = "update vouchercurrent set Status = '" . $status . "', DateModified = '" . $dateEncoded . "', ModifiedBy = '" . $employeeNumber . "' where trackingnumber = '" . $tn . "'";
		$database->query($sql);
		
		$sql = "Insert into cancelledchecks (TrackingNumber,CheckNumber,CheckDate,DateModified,ModifiedBy,Remarks) values('" . $tn . "','" . $checkNumber . "','" . $checkDate . "','" . $dateEncoded . "','" . $employeeNumber . "','" . $reason . "')";
		$database->query($sql);
		
		$completion = '';
		$database->UpdateVoucherHistory($tn);               //update para sa completion
		$database->InsertToVoucherHistory($tn,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
		
		
		// $record = $database->SearchTracking($tn);	
		// echo $sheet->CreateDoctrackInfoPR($record);

		// $record = $database->searchTrackingNumber2022($tn);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
		  
		
	}
	if(isset($_GET['reissueCheck'])){
		$tn = $database->charEncoder($_GET['tn']);
		$sql = "select CheckDate,CheckNumber from vouchercurrent where trackingnumber = '" . $tn . "' limit 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$checkNumber = $data['CheckNumber'];
		$checkDate = $data['CheckDate'];
		$status = "Check Preparation - CTO";
		
		$sql = "update cancelledchecks set Reissue = 'Yes' where trackingnumber = '" . $tn . "'";
		$database->query($sql);
		
		$sql = "update vouchercurrent set Status = '" . $status . "',CheckDate = null , Checknumber = null,  DateModified = '" . $dateEncoded . "', ModifiedBy = '" . $_SESSION['employeeNumber'] . "' where trackingnumber = '" . $tn . "'";
		$database->query($sql);
		
		
		$completion = '';
		$database->UpdateVoucherHistory($tn);               //update para sa completion
		$database->InsertToVoucherHistory($tn,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status
		
		// $record = $database->SearchTracking($tn);	
		// echo $sheet->CreateDoctrackInfoPR($record);

		// $record = $database->searchTrackingNumber2022($tn);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
		
	}


	//---------------------------------------------------------------------------------------------------INFRA UPLOADER - START

	if(isset($_GET['fetchINTNDetailsForInfraUp'])){
		/*$tn = $database->charEncoder($_GET['tn']);
		$sql = "SELECT 
				TrackingNumber, Claimant, InfraId, TrackingType
				FROM vouchercurrent
				WHERE TrackingNumber = '".$tn."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);

		$tn = $data['TrackingNumber'];
		$claimant = utf8_decode(utf8_encode($data['Claimant']));
		$infraId = $data['InfraId'];
		$trackType = $data['TrackingType'];

		$sql = "SELECT Location FROM infra WHERE TrackingNumber = '".$tn."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$location = utf8_decode(utf8_encode($data['Location']));

		$sql = "SELECT Name FROM programcode WHERE Id = '".$infraId."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$projTitle = utf8_decode(utf8_encode($data['Name']));

		if($trackType == 'NF') {
			echo utf8_encode($claimant)."*j*".$projTitle."*j*".$location."*j*".$tn;
		}else {
			echo "No record found.*j*";
		}*/
		
		// $trackingNumber = $database->charEncoder($_GET['tn']);
		$trackingNumber = strtoupper($database->charEncoder($_GET['tn']));
		echo $sheet->createInfraUploadDisplay($trackingNumber);
		
	}
	
	if(isset($_GET['saveInfraUploadDetails'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);
		$progress = floatval($database->charEncoder($_GET['progress']));
		$details = $database->charEncoder($_GET['details']);
		$numOfFiles = $database->charEncoder($_GET['files']);
		$series = $database->charEncoder($_GET['series']);
		$video = $database->charEncoder(trim($_GET['video']));
		
		$e = strpos($video,"embed");
		if($e !=  ''){
			$x = strpos($video,"https://www.youtube.com/embed/");
			if(sizeof($x) == 0 ){
				$video = '';
			}
		}else{
			$x = strpos($video,"https://youtu.be");
			if(strlen($x) > 0){
				$arr = parse_url($video);
				$video = "https://www.youtube.com/embed" . $arr['path'];
			}else{
				$video = '';
			}
		}
		

		$sql = "INSERT INTO infraconstruction (TrackingNumber, Progress, ProgressDescription, Files, DateEncoded,Video)
				VALUES
				('".$trackingNumber."','".$progress."','" . $details . "','" . $series . "','" . $dateEncoded . "','" . $video . "')";
		$database->query($sql);

		$sql = "UPDATE infra SET Progress = '".$progress."', ProgressDescription = '".$details."', Files = if(Files is null OR Files = '', ".$numOfFiles.", Files + ".$numOfFiles."), ProgressDate = '".$dateEncoded."'
				WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		$trackingNumber = $database->charEncoder($_GET['tn']);
		echo $sheet->createInfraUploadDisplay($trackingNumber);
	}
	
	if(isset($_GET['getProgressDetails'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);
		$progress = $database->charEncoder($_GET['progress']);
		$src = "../../../uploads/infra/reduced/";
		$des = "../../tempUpload/";

		$sql = "SELECT * FROM infraconstruction WHERE Progress = '".$progress."' AND TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);

		$description = $data['ProgressDescription'];
		$videoLink = $data['Video'];
		$files = $data['Files'];
		$start = substr($files, 0, 1);
		$end = substr($files, -1);
		
		$fileNames = [];
		for ($i=$start; $i <= $end; $i++) { 
			$fileName = $year."~".$trackingNumber."~".$progress."~".$i;

			$fileList = glob($src.$fileName.'*');
			foreach($fileList as $filesource){
				if(is_file($filesource)){
					$file = realpath( dirname(__FILE__) ). '/' .$filesource;
					$fileNameWext = str_replace($src, '', $filesource);
					array_push($fileNames, $fileNameWext);
					$file_handle = fopen($des . $fileNameWext , 'a+');
					fwrite($file_handle, file_get_contents($file));
					fclose($file_handle);
				}   
			}
		}
		unset($fileList);

		$imageDivLandscape = '';
		$imageDivPortrait ='';
		foreach($fileNames as $f){
			$sourcePath = '../../tempUpload/' . $f;
			list($width, $height) = getimagesize($sourcePath);		
			if($width > $height){
				$imageDivLandscape .= '<div class="displayImage" style="text-align:right; background:url('.$sourcePath.'); background-repeat:no-repeat; background-size:auto 100%; background-position:50%;">
									   		<div style = "display:inline; padding:0px 5px; font-weight:bold;">
											   	<span id="file'.$f.'" style="font-size:14px; color:rgb(255, 53, 53); cursor:pointer;" onclick="removeThisInfraProgFile(this)"></span>
											</div>
									   </div>';
			}else{
				$imageDivLandscape .= '<div class="displayImage" style="text-align:right; background:url('.$sourcePath.'); background-repeat:no-repeat; background-size:70%; background-position:50%;">
									   		<div style = "display:inline; padding:0px 5px; font-weight:bold;">
											   	<span id="file'.$f.'" style="font-size:14px; color:rgb(255, 53, 53); cursor:pointer;" onclick="removeThisInfraProgFile(this)"></span>
											</div>
									   </div>';
			}
		}
		$sheet ='<table border="0" cellpadding="0" cellspacing="0" style="">
					<tr>
						<td>
							<div style="width:100%;">' . $imageDivLandscape . '</div>
						</td>
					</tr>
				 </table>';
				 

		echo $progress."*j*".$description."*j*".$sheet."*j*".$videoLink;
	}

	if(isset($_GET['removeThisInfraProgFile'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);
		$fileName = $database->charEncoder($_GET['fileName']);
		$temp = explode('.', $fileName);
		$ext = $temp[2];
		$details = explode('~', str_replace('.'.$ext, '', $fileName));
		$year = $details[0];
		$progress = $details[2];
		$fileSeries = $details[3];

		unset($temp);
		unset($details);

		$sql = "SELECT Files FROM infraconstruction WHERE Progress = '".$progress."' AND TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);

		$nums = explode('-', $data['Files']);
		$newSeries = "";
		for ($i=0; $i < sizeof($nums); $i++) { 
			if($nums[$i] != $fileSeries) {
				$newSeries .= "-".$nums[$i];
			}
		}

		$newSeries = substr($newSeries, 1);
		
		$sql = "UPDATE infraconstruction SET Files = '".$newSeries."' WHERE Progress = '".$progress."' AND TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		$path1 = "../../../uploads/infra/reduced/";
		$path2 = "../../../uploads/infra/";
		$path3 = "../../tempUpload/";

		unlink($path1.$fileName);
		unlink($path2.$fileName);
		unlink($path3.$fileName);
	}

	//---------------------------------------------------------------------------------------------------INFRA UPLOADER - END
	
	
	if(isset($_GET['fetchInfraRevision'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);
		echo $sheet->createRevisionDisplay($trackingNumber);
	}
	if(isset($_GET['saveRevision'])){
		$tn = $database->charEncoder($_GET['tn']);
		$type = $database->charEncoder($_GET['type']);
		$amount = $database->charEncoder($_GET['amount']);
		$adjusted = $database->charEncoder($_GET['adjusted']);
		
		
		if($type == "Variation"){
			$case = " Variation  = '" . $amount . "' , Unperformed = 0 ";
		}else{
			$case = " Unperformed  = '" . $amount . "', Variation = 0 ";
		}
		
		$sql = "UPDATE infra SET " . $case . " WHERE TrackingNumber = '". $tn ."'";
		$database->query($sql);
		
		$database->EditLogs($tn,'Type',$type .'-'. $amount . '-' .$adjusted,'','CEO',$_SESSION['fullName'] ,$dateEncoded);	
		
		echo $sheet->createRevisionDisplay($tn);
	}

	if(isset($_GET['fetchCalendarNcal'])){
		$month = $database->charEncoder($_GET['month']);
		$year = $database->charEncoder($_GET['year']);
		if($month == 13){
			$month = date('m');
		}
		$monthSearch = $year . '-' . $month;

		$statuses = "'CAO Received','On Evaluation - Accounting','Evaluated - Accounting','Carded - Accounting','SLP Created - Accounting',
						'Pending at CAO','Pending Released - CAO','Forwarding Transmittal', 'CAO Released', 'CBO Received','Pending at CBO','Pending Released - CBO',
						'Fund Control', 'GSO Received','Pending at GSO', 'Pending Released - GSO', 'Served to Supplier','Supplier Conformed', 'For Inspection', 'Inspected',
						'Pending at GSO - Inspection','Pending Released - Inspection', 'Inventory','Pending at GSO - Inventory','Pending Released - Inventory', 'CTO Received',
						'pending at CTO','Pending Released - CTO','Check Preparation - CTO', 'Admin Received','Pending at Admin','Pending Released - Admin', 
						'Forwarded to Admin - Administration','Forwarded to Admin - Operation','Forwarded to SP - Admin', 'BAC Received','Pending at BAC','Pending Released - BAC',
						'Encoded','Waiting for Delivery','Cancelled'";
		
		// if naay tnpartner ug wages/benefits/allowance na check claimtype dili apil sa ihap
		// $sql = "SELECT Status, substr(DateModified, 9, 2) as Day, count(Id) as cnt 
		// 		FROM voucherhistory 
		// 		where substr(DateModified, 1, 7) = '".$monthSearch."'
		// 		AND Child is null
		// 		AND Status IN 
		// 		(".$statuses.") 
		// 		GROUP BY Status, substr(DateModified, 1, 10) ORDER BY DateModified DESC;";
		$sql = "SELECT Status, substr(DateModified, 9, 2) as Day, count(Id) as cnt 
				FROM voucherhistory 
				where substr(DateModified, 1, 7) = '".$monthSearch."'
				AND Status IN 
				(".$statuses.") 
				GROUP BY Status, substr(DateModified, 1, 10) ORDER BY DateModified DESC;";
		$record = $database->query($sql);
		
		$res = '';
		while($data = $database->fetch_array($record)){
			$status = $data['Status'];
			$count = $data['cnt'];
			$day = $data['Day'];
			$id = $status . $day;
			$res .= "ncal".$id . '~' . $count . '*';
		}
		echo $res;
		
	}

	if(isset($_GET['getTrackingFromCalendarNcal'])){
		$month = $database->charEncoder($_GET['month']);
		$year = $database->charEncoder($_GET['year']);
		$day = $database->charEncoder($_GET['day']);
		$status = $database->charEncoder($_GET['status']);
		$dateModified =  $year . '-' . $month . '-' . $day ;

		$sql = "SELECT TrackingNumber FROM voucherhistory WHERE Status = '".$status."' AND substr(DateModified, 1, 10) = '".$dateModified."' AND Child is null GROUP BY TrackingNumber";
		$record = $database->query($sql);
		$tnStr = "";
		while($data = $database->fetch_array($record)) {
			$tnStr .= ",'".$data['TrackingNumber']."'";
		}

		$sql = "SELECT TrackingNumber, Claimant, TrackingType, DocumentType, Status, Amount, PO_Amount, TotalAmountMultiple, Office, DateModified, Name, Complex 
				FROM vouchercurrent a
				LEFT JOIN office b ON a.Office = b.Code 
				WHERE TrackingNumber IN (".substr($tnStr, 1).") GROUP BY TrackingNumber ASC ORDER BY Name, Claimant";
		$record = $database->query($sql);

		$return = $sheet->createTableCalendarTracking($record);
		$return .= "<div style='text-align:right; padding: 5px 5px 5px 0px;'>
						<span style='font-size:10px; font-family:roboto; letter-spacing:1px; cursor:pointer;' onclick=\"gotoFormCalendarNcal('".$day."','".$status."','".$year."','".$month."')\">
							PRINT LIST
						</span>
					</div>";
		echo $return;	
	}


	//---------------------------------------------------------------------------------------------------INFRA PAYMENT TYPE B - START
	if(isset($_GET['fetchMultiProjIPb'])) {
		$sql = "SELECT TrackingNumber, BatchNumber, count(Id) as tnCnt FROM infra WHERE LENGTH(BatchNumber) > 8 GROUP BY BatchNumber";
		$record = $database->query($sql);

		$infraTNs = '';
		$batchNumbers = [];
		while($data = $database->fetch_array($record)) {
			if($data['tnCnt'] > 1) {
				$infraTNs .= ",'".$data['TrackingNumber']."'";
				$batchNumbers[$data['TrackingNumber']] = $data['BatchNumber'];
			}
		}

		// $sql = "SELECT a.TrackingNumber, b.Name, a.BatchNumber 
		// 		FROM infra a
		// 		LEFT JOIN programcode b ON a.TrackingNumber = b.TrackingNumberInfra
		// 		WHERE a.TrackingNumber IN (".substr($infraTNs, 1).")";
		$sql = "SELECT TrackingNumber FROM vouchercurrent WHERE TrackingNumber IN (".substr($infraTNs, 1).") AND Status = 'NTP Forwarded to Construction Division'";
		$record = $database->query($sql);

		$infraTNs = '';
		while($data = $database->fetch_array($record)) {
			$infraTNs .= ",'".$data['TrackingNumber']."'";
		}


		$sql = "SELECT TrackingNumberInfra, Name FROM programcode WHERE TrackingNumberInfra IN (".substr($infraTNs, 1).")";
		$record = $database->query($sql);

		echo $sheet->createIpbInfraTNList($record, $batchNumbers);
	}
	

	if(isset($_GET['getTNsUnderThisBatchNumber'])) {
		$batchNumber = $database->charEncoder($_GET['batchNumber']);

		$sql = "SELECT TrackingNumber, Progress, Duration, Variation, Unperformed FROM infra WHERE BatchNumber = '".$batchNumber."'";
		$record = $database->query($sql);

		$infraTNs = '';
		$infraTNsDetails = [];
		while($data = $database->fetch_array($record)) {
			$infraTNs .= ",'".$data['TrackingNumber']."'";
			$infraTNsDetails[$data['TrackingNumber']]['Progress'] = $data['Progress'];
			$infraTNsDetails[$data['TrackingNumber']]['Duration'] = $data['Duration'];
			$infraTNsDetails[$data['TrackingNumber']]['Variation'] = $data['Variation'];
			$infraTNsDetails[$data['TrackingNumber']]['Unperformed'] = $data['Unperformed'];
		}

		// change to array
		$sql = "SELECT * FROM vouchercurrent WHERE TrackingNumber IN (".substr($infraTNs, 1).") GROUP BY TrackingNumber";
		$record = $database->query($sql);

		$sheet1 = "	<table id='ipbInfraTNDetails' border='0' cellpadding='0' cellspacing='0'>
						<thead>
							<th></th>
							<th style='text-align:left;'>Tracking Number</th>
							<th style='text-align:left;'>Contractor</th>
							<th style='text-align:left;'>Project Code</th>
							<th style='text-align:right;'>Budget Amount</th>
							<th style='text-align:right;'>Contract Amount</th>
							<th style=''>Variation</th>
							<th style=''>Unperformed</th>
							<th style=''>Adjustment</th>
							<th style=''>Base Percentage</th>
							<th style=''>Progress</th>
						</thead>
						<tbody>";

		$row = 0;
		$totalBudget = 0;
		$totalContract = 0;
		$totalProgress = 0;
		$totalVariation = 0;
		$totalUnperformed = 0;
		$totalAdjustment = 0;
		$totalRetention = 0;
		$numRows = $database->num_rows($record);
		$base = 100/$numRows;
		$progressBase = $base/100;
		while($data = $database->fetch_array($record)) {
			$trackingNumber = $data['TrackingNumber'];
			$contractor = $data['Claimant'];
			$budgetAmount = floatval($data['Amount']);
			$contractAmount = floatval($data['NetAmount']);
			$projectCode = $data['PR_ProgramCode'];

			$progress = floatval($infraTNsDetails[$trackingNumber]['Progress']);
			$duration = $infraTNsDetails[$trackingNumber]['Duration'];
			$variation = floatval($infraTNsDetails[$trackingNumber]['Variation']);
			$unperformed = floatval($infraTNsDetails[$trackingNumber]['Unperformed']);
			$adjustment = 0;

			if($variation > 0){
				$adjustment = round($contractAmount + $variation, 2);
			}elseif($unperformed > 0){
				$adjustment = round($contractAmount - $unperformed, 2);
			}else{
				$adjustment = round($contractAmount, 2);
			}

			$retention = round($adjustment * .05, 2);

			$sheet1 .= "		<tr>
								<td style='font-size:12px;'>".++$row."</td>
								<td name='ipbNfTracking'>".$trackingNumber."</td>
								<td name='ipbNfClaimant'>".$contractor."</td>
								<td>".$projectCode."</td>
								<td style='text-align:right;'>".$database->toNumberFormat($budgetAmount)."</td>
								<td style='text-align:right;'>".$database->toNumberFormat($contractAmount)."</td>
								<td style='text-align:center;'>".$database->toNumberFormat($variation)."</td>
								<td style='text-align:center;'>".$database->toNumberFormat($unperformed)."</td>
								<td style='text-align:center;'>".$database->toNumberFormat($adjustment)."</td>
								<td style='text-align:center;'>".$base."%</td>
								<td style='text-align:center;'>".$progress."</td>
							</tr>";
			
			$totalBudget += $budgetAmount;
			$totalContract += $contractAmount;
			$totalProgress += $progress*$progressBase;
			$totalVariation += $variation;
			$totalUnperformed += $unperformed;
			$totalAdjustment += $adjustment;
			$totalRetention += $retention;
		}
		$sheet1 .= "		<tr>
							<td></td>
							<td></td>
							<td></td>
							<td style='text-align:right; font-weight:bold;'>Total</td>
							<td style='text-align:right;'>".$database->toNumberFormat($totalBudget)."</td>
							<td id='' style='text-align:right;'>".$database->toNumberFormat($totalContract)."</td>
							<td id='' style='text-align:center;'>".$database->toNumberFormat($totalVariation)."</td>
							<td id='' style='text-align:center;'>".$database->toNumberFormat($totalUnperformed)."</td>
							<td id='' style='text-align:center;'>".$database->toNumberFormat($totalAdjustment)."</td>
							<td style='text-align:center;'>100%</td>
							<td id='' style='text-align:center;'>".$totalProgress."</td>
						</tr>";

		$sheet1 .= "		</tbody>
					</table>";

		$sql = "SELECT FundYear, Fund FROM programcode WHERE TrackingNumberInfra = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$fundYear = $data['FundYear'];
		$fund = $data['Fund'];

		// $totalProgress.'*j*'.$totalVariation.'*j*'.$totalUnperformed
		$currentProgress = $totalProgress;
		$variation = $totalVariation;
		$unperformed = $totalUnperformed;
		$pCost = $totalBudget;
		$aCost = $totalContract;

		$returns = $contractor."~".$fundYear."~".$fund."~".$duration."~".$currentProgress."~".$database->toNumberFormat($variation)."~".$database->toNumberFormat($unperformed)."~".$database->toNumberFormat($pCost)."~".$database->toNumberFormat($aCost)."~".$database->toNumberFormat($totalAdjustment);


		$sql = "SELECT * FROM infrapayment WHERE InfraTracking IN (".substr($infraTNs, 1).") GROUP BY TrackingNumber ORDER BY Id ASC";
		$record = $database->query($sql);

		$sheet2 = '<table id ="ipbPaymentHistory" style ="font-family:NOR;margin:0 auto;font-size:14px;border-collapse:collapse;width:100%;background-color:white;padding:50px;" border ="0">';
		$sheet2 .= '	<tr><td colspan = "100%" style ="background-color:rgb(227, 236, 239);padding:2px 5px;letter-spacing:2px;font-size:13px;">PAYMENT RECORD </td></tr>';
		$sheet2 .= '	<tr>
						<th style = "padding:2px 5px;">TN</th>
						<th style = "padding:2px 5px;text-align:left;">Payment</th>
						<th style = "padding:2px 5px;">Variation</th>
						<th style = "padding:2px 5px;">Unperformed</th>
						<th style = "padding:2px 5px;">Contract</th>
						<th style = "padding:2px 5px;">Adjustment</th>
						
						<th style = "padding:2px 5px;">T.Progress</th>
						<th style = "padding:2px 5px;">B.Progress</th>
						
						<th style = "padding:2px 5px;text-align:center;">S.Curve</th>
						<th style = "padding:2px 5px;">Billed Amount</th>
						<th style = "padding:2px 5px;text-align:right;">2(%)</th>
						<th style = "padding:2px 5px;text-align:right;">5(%)</th>
						<th style = "padding:2px 5px;text-align:right;">Tax</th>
						<th style = "padding:2px 5px;text-align:right;">Ret</th>
						<th style = "padding:2px 5px;text-align:right;">Delay</th>
						<th style = "padding:2px 5px;text-align:right;">LD</th>
						<th style = "padding:2px 5px;text-align:right;">Net</th>
					</tr>
					<tr><td colspan ="100%" style = "border-top:1px solid grey;"></td></tr>	
				';
		$totalGross = 0;		   
		$totalNet = 0;
		$totalTwo =0;
		$totalFive =0;
		$totalRetention =0;
		$totalTax =0;
		$totalLD =0;
		
		$retentionTotal = 0;
		$done = 0;
		$lastProgress = 0;
		$billedProgress = 0;
		$pCostAdjusted = 0;
		$ld =0;
		$type = array('1st Payment','2nd Payment','3rd Payment','4th Payment','5th Payment','6th Payment','7th Payment','Final Payment');
		while($data = $database->fetch_array($record)){
			$infaTN = $data['TrackingNumber'];
			$infaPaymentType = $data['Type'];
			$arrayKey = array_search($infaPaymentType, $type);
			unset($type[$arrayKey]);
			if($infaPaymentType == 'Final Payment'){
				$done = 1;
			}
			
			$progress = $data['Progress'];
			
			$gross = $data['Gross'];
			$variationSaved =  $data['Variation'];
			$unperformedSaved = $data['Unperformed'];
			if($variationSaved > 0 || $unperformedSaved > 0){
				$adjustment = number_format($data['ActualAdjustment']);
			}else{
				$adjustment = '';
			}
			
			
			$billedProgress = $data['BilledProgress'];
			$lastProgress = $progress;
			$sCurve = $data['Scurve'];
			$delay = $data['Delay'];
			$tax = $data['Tax'];
			$retention = $data['Retention'];
			
			$net = $data['Net'];
			$two = $data['Two'];
			$five = $data['Five'];
			$ld = $data['LD'];

			$ldPercentage = '';
			if($data['LDpercentage'] != '') {
				$ldPercentage = "<span style='color:rgb(72, 169, 220); margin-left:3px;'>(".($data['LDpercentage'] * 100)."%)</span>";
			}

			$retentionTotal += $retention;
			$totalTax += $tax;
			$totalTwo += $two;
			$totalFive += $five;
			$totalNet += $net;
			$totalGross += $gross;
			$sheet2 .= '<tr>
						<td style = "padding:0px 5px;border-bottom:1px solid rgb(232, 234, 235);cursor:pointer;" class = "hover" onclick ="searchThisPartner(this)">' . $infaTN . '</td>
						<td style = "padding:0px 5px;border-bottom:1px solid rgb(232, 234, 235);">' . $infaPaymentType . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $database->zeroToNothing(number_format($variationSaved,2)) . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $database->zeroToNothing(number_format($unperformedSaved,2)) . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . number_format($aCost,2) . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $adjustment . '</td>
						<td style = "text-align:center;border-bottom:1px solid rgb(232, 234, 235);">' . $progress . '</td>
						<td style = "text-align:center;border-bottom:1px solid rgb(232, 234, 235);">' . $billedProgress . '</td>
						<td style = "padding:0px 5px;text-align:center;border-bottom:1px solid rgb(232, 234, 235);">' . $sCurve . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . number_format($gross,2) . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' .number_format($two,2) . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' .number_format($five,2) . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' .number_format($tax,2) . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . number_format($retention,2) . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $database->zeroToNothing($delay) . '</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);">' . $database->zeroToNothing(number_format($ld,2)).$ldPercentage.'</td>
						<td style = "padding:0px 5px;text-align:right;border-bottom:1px solid rgb(232, 234, 235);border-right:1px solid rgb(232, 234, 235);">' . number_format($net,2) . '</td>
				</tr>';
		}
		$sheet2 .= ' <tr>
						<th ></th>
						<th ></th>
						<th ></th>
						<th ></th>
						<th ></th>
						<th colspan ="4"></th>
						<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);" id="nfTotalBAmountBatch">' . number_format($totalGross,2) .'</th>
						<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . number_format($totalTwo,2) . '</th>
						<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . number_format($totalFive,2) . '</th>
						<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . number_format($totalTax,2) . '</th>
						<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . number_format($retentionTotal,2) . '</th>
						<th></th>
						<th style = "padding:5px;text-align:right;color:rgb(10, 82, 149);font-weight:normal;">' . $database->zeroToNothing(number_format($ld,2)) . '</th>
						<th style = "padding:5px;text-align:right;"><span style = "color:red;font-weight:bold;">' . number_format($totalNet,2) . '</span></th>
					</tr>';	
		$sheet2 .= ' <tr><td colspan ="100%"  style = "padding:5px;"></td></tr>';	
		$sheet2 .= '</table>';

		if($done == 0){
			$options = '';
			foreach ($type as $paymentType) {
				if($currentProgress < 100){
					$options .= '<option>' . $paymentType . '</option>';
				}
				break;
			}
			$options .= '<option>' . str_replace(" Payment","",$paymentType) . ' and Final Payment</option>';
		}else{
			$options = '<option style ="padding:5px;"></option>';
		}

		$billedProgress = $currentProgress - $lastProgress;
		if($variation > 0){
			$retention =  round(($aCost + $variation) * .05,2);
			$pCostAdjusted = $aCost + $variation;
		}else if($unperformed > 0){
			$retention =  round(($aCost - $unperformed) * .05,2);
			$pCostAdjusted = $aCost - $unperformed;
		}else{
			$retention =  round($aCost * .05,2);
			$pCostAdjusted = $aCost;
		}
		$retentionBalance = $retention - $retentionTotal;
		$returns .= "~".$billedProgress."~".$database->toNumberFormat($retention)."~".$database->toNumberFormat($retentionTotal)."~".$database->toNumberFormat($retentionBalance)."~".$pCostAdjusted;
		echo $sheet1.'*j*'.$sheet2.'*j*'.$options.'*j*'.$returns;
	}

	if(isset($_GET['saveTrackingInfraPYIPB'])){
		//$office = $_SESSION['cbo'];
		$coTN = substr($database->charEncoder($_GET['tn']), 1); // PR_TrackingNumber
		$coTNs = explode("~", $coTN);
		$fund = $database->charEncoder($_GET['fund']);
		
		$supplier = $database->charEncoder($_GET['supplier']); // Claimant
		$gross = $database->charEncoder($_GET['gross']);
		$type = $database->charEncoder($_GET['type']);
		$progress = $database->charEncoder($_GET['progress']);
		$retention = $database->charEncoder($_GET['retention']);
		$tax = $database->charEncoder($_GET['tax']);
		$net = $database->charEncoder($_GET['net']);
		$delay = $database->nullToZero($database->charEncoder($_GET['delay']));
		$progress = $database->charEncoder($_GET['progress']);
		
		$actual = $database->charEncoder($_GET['actual']);
		$actualAdjustment = $database->charEncoder($_GET['actualAdjustment']);
		
		$from = $database->charEncoder($_GET['from']);
		$to = $database->charEncoder($_GET['to']);
		$wholeProgress = $database->charEncoder($_GET['wholeProgress']);
		$sCurve = $database->charEncoder($_GET['sCurve']);
		
		$two = $database->charEncoder($_GET['two']);
		$five = $database->charEncoder($_GET['five']);
		$ld = $database->nullToZero($database->charEncoder($_GET['ld']));
		
		$variation = $database->nullToZero($database->charEncoder($_GET['variation']));
		$unperformed = $database->nullToZero($database->charEncoder($_GET['unperformed']));

		$ldPercentage = $database->nullToZero($database->charEncoder($_GET['ldPercentage']));
		
		if($ldPercentage > 0){
			$ldPercentage = number_format(($ldPercentage /100),4);
		}
		
		$deduction = ($tax + $retention + $ld);
		
		$tn = "";
		$newTN = "";
		$projNamesForPart = "";
		for($i = 0; $i < sizeof($coTNs); $i++) {
			$sql = "select Name from programcode where TrackingNumberInfra  ='" . $coTNs[$i] . "' limit 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$projectName  = $data['Name'];
			$projNamesForPart .= ", ".$projectName;
					
			$office =  substr($coTNs[$i],0,4);
			if($tn == "" && $newTN == "") {
				//pagincrement sa new tn
				$updateCase = "Doctrack = Doctrack + 1";
				$database->IncrementTrackingSeries($updateCase,$office);
				
				//pagkuha sa new tn
				$condition = "where code = '" . $office . "' limit 1";
				$record = $database->FetchDoctrackID("Doctrack",$condition);
				$data = $database->fetch_array($record);
				$tn = $office . '-' . $data['Doctrack'];
				$newTN = $office . '-' . ($data['Doctrack'] + 1);
			}
			

			$trackType = "IP";
			$docType = "Infrastructure Payment";
			$status = "Encoded";
			$claimType = "Check";
			
			$sql = "Insert into vouchercurrent 
					(Year,Office,TrackingNumber,TrackingType,DocumentType,Fund,Amount,EncodedBy,DateEncoded,Status,DateModified,TrackingPartner,Claimant,ClaimType,NetAmount)
					VALUES 
					(" . $defaultYear . ",'" . $office . "','" . $tn . "','" . $trackType . "','" . $docType. "','" . $fund . "', " . $gross . ",'" . $employeeNumber . "','" . $dateEncoded . "','" . $status . "','" . $dateEncoded . "'
					,'" . $coTNs[$i] . "','" . $supplier . "','" . $claimType . "','" . $net . "')";
			$database->query($sql);	

			$sql = "Insert into infrapayment (InfraTracking,TrackingNumber,Type,Progress,Retention,Tax,Gross,Net,Delay,PeriodFrom,PeriodTo,Actual,BilledProgress,Scurve,Two,Five,LD,Variation,Unperformed,ActualAdjustment,LDPercentage)
					VALUES ('" . $coTNs[$i] . "','" . $tn . "','" . $type . "','" . $wholeProgress . "','" . $retention . "',
							'" . $tax . "','" . $gross . "','" . $net . "','" . $delay . "','" . $from . "','" . $to . "','" . $actual . "','" . $progress . "',
							'" . $sCurve . "','" . $two . "','" . $five . "','" . $ld . "','" . $variation . "','" . $unperformed . "','" . $actualAdjustment . "','" . $ldPercentage . "')";
			$database->query($sql);
		}

		$part = "\n     For ("  . $type . ") of a bid contract for the project : "  . substr($projNamesForPart,2) . " covering for the period of " . $from . " to " . $to . " as per supporting documents hereto attached in the amount of ....\n";		                 
		$part .= "\nContract Details : " . implode(", ", $coTNs) . ", s-Curve : " . $sCurve;
		$part .= "\nContract Amount : " . number_format($actual,2);
		if($variation > 0){
			$part .= "\nAdd. Fund due to Variation order No. 1 : " . number_format($variation,2);
			$part .= "\nRevised Contract Amount " . number_format($actualAdjustment,2);
		}
		if($unperformed > 0){
			$part .= "\nLess : Unperformed Works" . number_format($unperformed,2);
			$part .= "\nRevised Contract Amount " . number_format($actualAdjustment,2);
		}
		if($type == "1st Payment"){
			$part .= "\nAccomplishment to Date : " . $wholeProgress ."%";
		}else{
			$part .= "\nTotal Accomplishment : " . $wholeProgress ."%"  . ", Accomplishment Billed : " . $progress ."%";
		}
		
		
		$part .= "\nTax(2%)  " . number_format($gross,2) . " / 1.12 x .02  :  " .  number_format($two,2);
		$part .= "\nTax(5%)  " . number_format($gross,2) . " / 1.12 x .05  :  " .  number_format($five,2);
		$part .= "\n                                           			               Total Tax :  " .  number_format($tax,2);
		$part .= "\n										              Retention :  " . number_format($retention,2);
		if($ld > 0){
			$part .= "\n							     	          Liquidated Damages :  " .  number_format($ld,2);
		}
		$part .= "\n							     	                 Total Deduction :  " .  number_format($deduction,2);
		
																					
		$sql = "Insert into particulars(TrackingNumber,Particulars) values('" . $tn . "','" . $part . "')";
		$database->query($sql);
			

		$completion = '';
		$database->UpdateVoucherHistory($tn);               //update para sa completion
		$database->InsertToVoucherHistory($tn,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

		echo $tn . "!@!" . $newTN;


	}
	//---------------------------------------------------------------------------------------------------INFRA PAYMENT TYPE B - END
	if(isset($_GET['saveMap'])){
		$tn = $database->charEncoder($_GET['tn']);
		$year = $database->charEncoder($_GET['year']);
		$url = $database->charEncoder($_GET['url']);
		
		
		$link = 0;
		$h = @get_headers($url);
		if(sizeof($h) > 1){
			$x = in_array("X-Frame-Options: SAMEORIGIN",$h); //not allowed by source
			if($x >= 1){
				$link = 0;
			}else{
				$result =  $h[0];
				$live =  strpos($result,"OK"); //correct params, active
				if($live >= 1){
					$a =  strpos($url,"https://www.google.com/maps/embed?"); // valid content
					if($a >= 0){
						$link = 1;
					}
				}
			}
		}
		if($link == 1){
			$db = $database->getDB($year);
			
			if($_SESSION['perm'] == 41 || $_SESSION['perm'] == 42){
				$sql = "update  infra set Map = '" . $url . "' where TrackingNumber= '"  .$tn . "'";
				$database->query($sql);
			}
			echo $link . "~!~" . $url;
		}else{
			echo "0~!~Set again";
		}
	}

	if(isset($_GET['showImgOrigSize'])) {
		$filename = $database->charEncoder($_GET['filename']);

		$source = '/../../../uploads/infra/';
		$destination = '../../tempUpload/';
		
		if($filename != 0){
			$file = realpath( dirname(__FILE__) ). $source . $filename;
			$filenameInfo = pathinfo($file);	
			$extFilename = $filenameInfo['filename'];
			$ext = $filenameInfo['extension'];
			$newFilename = $extFilename.'-ORIG.'.$ext;

			$file_handle = fopen($destination . $newFilename , 'a+');
			fwrite($file_handle, file_get_contents($file));
			fclose($file_handle);
		}

		echo $destination . $newFilename;
	}

	//---------------------------------------------------------------------------------------------------INFRA VIEWER - START

	if(isset($_GET['fetchViewerInfra'])) {
		$part = $database->charEncoder($_GET['part']);
		$findType = $database->charEncoder($_GET['findType']);

		$infraTns = "";
		$expCodes = "";
		$project = [];
		$flag = 0;
		if($findType == 'Project') {
			$sql = "SELECT Id, TrackingNumberInfra, Name, ExpenseCode, Fund, FundYear, Code, Lump FROM programcode WHERE (Name LIKE '%".$part."%') AND Category = 'Infrastructure Project'";
			$record = $database->query($sql);
			$numRows = $database->num_rows($record);

			if($numRows > 0) {
				$noRow = 0;
				$noRowExp = '';
				while($data = $database->fetch_array($record)) {
					$tn = $data['TrackingNumberInfra'];
					$title = $data['Name'];
					$id = $data['Id'];
					$expCode = $data['ExpenseCode'];
					$fund = $data['Fund'];
					$fundYear = $data['FundYear'];
					$code = $data['Code'];
					$lump = $data['Lump'];

					if($tn != "") {
						$project[$tn]['Title'] = $title;
						$infraTns .= ",'".$tn."'";
					}else {
						++$noRow;
						$project['infraTN'.$noRow]['Title'] = $title;
						$project['infraTN'.$noRow]['FundYear'] = $fundYear;
						$project['infraTN'.$noRow]['Fund'] = $fund;
						$project['infraTN'.$noRow]['Contractor'] = '';+

						$project['infraTN'.$noRow]['Code'] = $code;
						if(strlen($lump) > 0) {
							$project['infraTN'.$noRow]['Code'] = $lump;
						}

						if($expCode != "") {
							$noRowExp .= ",'".$expCode."'";
							$project['infraTN'.$noRow]['ExpCode'] = $expCode;
						}else {
							$project['infraTN'.$noRow]['ExpCode'] = '';
						}

						$project['infraTN'.$noRow]['Location'] = '';
						$project['infraTN'.$noRow]['Progress'] = '';
						$project['infraTN'.$noRow]['Inspector'] = '';
						$project['infraTN'.$noRow]['Programmer'] = '';
					}
					
				}

				$sql = "SELECT TrackingNumber, Claimant, PR_ProgramCode, FundYear, Fund, PR_AccountCode FROM vouchercurrent WHERE TrackingNumber IN (".substr($infraTns, 1).")";
				$record = $database->query($sql);
				while($data = $database->fetch_array($record)) {
					$tn = $data['TrackingNumber'];
					$claimant = $data['Claimant'];
					$code = $data['PR_ProgramCode'];
					$fundYear = $data['FundYear'];
					$fund = $data['Fund'];
					$accCode = $data['PR_AccountCode'];

					$project[$tn]['Contractor'] = $claimant;
					$project[$tn]['Code'] = $code;
					$project[$tn]['FundYear'] = $fundYear;
					$project[$tn]['Fund'] = $fund;
					$project[$tn]['ExpCode'] = $accCode;


					$expCodes .= ",'".$accCode."'";
				}

				$expCodes .= ",'".$accCode."'".$noRowExp;
				$flag = 1;
			}
			
		}elseif($findType == 'Contractor') {
			$sql = "SELECT TrackingNumber, Claimant, PR_ProgramCode, FundYear, Fund, PR_AccountCode FROM vouchercurrent WHERE (Claimant LIKE '%".$part."%') AND InfraId IS NOT NULL";
			$record = $database->query($sql);
			$numRows = $database->num_rows($record);

			if($numRows > 0) {
				while($data = $database->fetch_array($record)) {
					$tn = $data['TrackingNumber'];
					$claimant = $data['Claimant'];
					$code = $data['PR_ProgramCode'];
					$fundYear = $data['FundYear'];
					$fund = $data['Fund'];
					$accCode = $data['PR_AccountCode'];

					$project[$tn]['Contractor'] = $claimant;
					$project[$tn]['Code'] = $code;
					$project[$tn]['FundYear'] = $fundYear;
					$project[$tn]['Fund'] = $fund;
					$project[$tn]['ExpCode'] = $accCode;
					$infraTns .= ",'".$tn."'";
					$expCodes .= ",'".$accCode."'";

				}

				$sql = "SELECT TrackingNumberInfra, Name FROM programcode WHERE TrackingNumberInfra IN (".substr($infraTns, 1).")";
				$record = $database->query($sql);
				$numRows = $database->num_rows($record);

				$projTitles = [];
				while($data = $database->fetch_array($record)) {
					$tn = $data['TrackingNumberInfra'];
					$title = $data['Name'];

					$project[$tn]['Title'] = $title;
				}
				
				$flag = 1;
			}
		}elseif($findType == 'Code') {
			$sql = "SELECT Id, TrackingNumberInfra, Name, ExpenseCode, Fund, FundYear, Code, Lump FROM programcode WHERE (Lump = '".$part."' OR Code = '".$part."') AND Category = 'Infrastructure Project'";
			$record = $database->query($sql);
			$numRows = $database->num_rows($record);

			if($numRows > 0) {
				$noRow = 0;
				$noRowExp = '';
				while($data = $database->fetch_array($record)) {
					$tn = $data['TrackingNumberInfra'];
					$title = $data['Name'];
					$id = $data['Id'];
					$expCode = $data['ExpenseCode'];
					$fund = $data['Fund'];
					$fundYear = $data['FundYear'];
					$code = $data['Code'];
					$lump = $data['Lump'];

					if($tn != "") {
						$project[$tn]['Title'] = $title;
						$infraTns .= ",'".$tn."'";
					}else {
						++$noRow;
						$project['infraTN'.$noRow]['Title'] = $title;
						$project['infraTN'.$noRow]['FundYear'] = $fundYear;
						$project['infraTN'.$noRow]['Fund'] = $fund;
						$project['infraTN'.$noRow]['Contractor'] = '';+

						$project['infraTN'.$noRow]['Code'] = $code;
						if(strlen($lump) > 0) {
							$project['infraTN'.$noRow]['Code'] = $lump;
						}

						if($expCode != "") {
							$noRowExp .= ",'".$expCode."'";
							$project['infraTN'.$noRow]['ExpCode'] = $expCode;
						}else {
							$project['infraTN'.$noRow]['ExpCode'] = '';
						}

						$project['infraTN'.$noRow]['Location'] = '';
						$project['infraTN'.$noRow]['Progress'] = '';
						$project['infraTN'.$noRow]['Inspector'] = '';
						$project['infraTN'.$noRow]['Programmer'] = '';
					}
					
				}

				$sql = "SELECT TrackingNumber, Claimant, PR_ProgramCode, FundYear, Fund, PR_AccountCode FROM vouchercurrent WHERE TrackingNumber IN (".substr($infraTns, 1).")";
				$record = $database->query($sql);
				while($data = $database->fetch_array($record)) {
					$tn = $data['TrackingNumber'];
					$claimant = $data['Claimant'];
					$code = $data['PR_ProgramCode'];
					$fundYear = $data['FundYear'];
					$fund = $data['Fund'];
					$accCode = $data['PR_AccountCode'];

					$project[$tn]['Contractor'] = $claimant;
					$project[$tn]['Code'] = $code;
					$project[$tn]['FundYear'] = $fundYear;
					$project[$tn]['Fund'] = $fund;
					$project[$tn]['ExpCode'] = $accCode;


					$expCodes .= ",'".$accCode."'";
				}

				$expCodes .= ",'".$accCode."'".$noRowExp;
				$flag = 1;
			}
			
		}

		if($flag == 1) {
			$fundTitles = [];
			$sql = "SELECT 	Code, Title FROM fundtitles WHERE Code IN (".substr($expCodes, 1).")";
			$record = $database->query($sql);
			while($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$title = $data['Title'];
				$fundTitles[$code] = $title;
			}

			$sql = "SELECT * FROM infra WHERE TrackingNumber IN (".substr($infraTns, 1).") ORDER BY Progress DESC";
			$record = $database->query($sql);

			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$location = $data['Location'];
				$progress = $database->nullToZero($data['Progress'])."%";
				$inspector = $data['Inspector'];
				$programmer = $data['Programmer'];

				$project[$tn]['Location'] = $location;
				$project[$tn]['Progress'] = $progress;
				$project[$tn]['Inspector'] = $inspector;
				$project[$tn]['Programmer'] = $programmer;
				$project[$tn]['ExpTitle'] = $fundTitles[$project[$tn]['ExpCode']];
			}

			if($noRow > 0) {
				for ($i=1; $i <= $noRow; $i++) { 
					$project['infraTN'.$i]['ExpTitle'] = '';
					if($project['infraTN'.$i]['ExpCode'] != "") {
						$project['infraTN'.$i]['ExpTitle'] = $fundTitles[$project['infraTN'.$i]['ExpCode']];
					}
				}
			}

			echo $sheet->createInfraViewerMultipleView($project);
		}else {
			echo "<div class='norecord'>No record found.</div>";
		}
		
		
	}

	

	//---------------------------------------------------------------------------------------------------INFRA VIEWER - END
	
	
	if(isset($_GET['fetchPaymasterSolo'])){
		$text = $database->charEncoder($_GET['name']);
		$name =   urldecode($database->vArrange($text));
		
		$sql ="SELECT Id,PMTrackYear as TrackYear, PMTrackingNumber as TN,PMFund as Fund, Count(Id) as Payroll FROM chequerist.paymaster where PMClaimant ='" . $name . "' group by PMTrackingNumber order by Id desc limit 20";
		$record = $database->query($sql);
		
		$tns = '';
		$yrs = '';
		$arr  = array();
		$arrYear = array();
		while($data = $database->fetch_array($record)){
			$tn = $data['TN'];
			$fund= $data['Fund'];
			$payroll = $data['Payroll'];
			$year = $data['TrackYear'];
			
	
			$arr[$tn]['TN'] = $tn;
			$arr[$tn]['Fund'] = $fund;
			$arr[$tn]['Payroll'] = $payroll;
			$arr[$tn]['TrackYear'] = $year;
		
			
			if(isset($arrYear[$year])){
				$arrYear[$year] .=  ",'" . $tn . "'";
			}else{
				$arrYear[$year] =  ",'" . $tn . "'";
			}
			
			
			$tns .= ",'" . $tn . "'"; 	
			
		}
		$tns = substr($tns,1);
		

		foreach($arrYear as  $arrTN){
			$year = array_search($arrTN, $arrYear);
			$tns = substr($arrTN,1);
			$sql = "select TrackingNumber,Status,DateModified, NetAmount from citydoc".  $year . ".vouchercurrent where TrackingNumber in($tns)";
			$record = $database->query($sql);
			while($data = $database->fetch_array($record)){
				$tn = $data['TrackingNumber'];
				$status = $data['Status'];
				$modified = $data['DateModified'];
				$net =  $data['NetAmount'];	
				
				$arr[$tn]['Status'] = $status;
				$arr[$tn]['Modified'] = $modified;
				$arr[$tn]['Net'] = $net;
			}
			
		}
		
		$i =1;
		$sheet = '<div style = "padding:5px;font-weight:bold;line-height:14px;">LIST OF PAYMASTER</div>	';
		$sheet .= '<table id = "paymasterSoloTable1"  style = "border-bottom:1px solid silver;">';
		$sheet .= '<tr>
						<th></th>
						<th>FND</th>
						<th style = "text-align:center;">TN</th>
						<th>No</th>
						<th	style = "text-align:right;">AMOUNT</th>
						<th style = "white-space:nowrap;text-align:left;">STATUS</th>
						
					 </tr>';
		foreach($arr as $value){
			$tn = $value['TN'];
			$fund = $value['Fund'];
			$payroll = $value['Payroll'];
			$trackYear = $value['TrackYear'];
			$status = $value['Status'];
			$modified =  $value['Modified'];
			$net =  $value['Net'];
			
			
			if($status != 'Check Released'){
				
				$class = 'statusDiff';
			}else{
				
				$class = '';
			}
			
			
			if($fund = 'General Fund'){
				$fund = "GF";
			}else if($fund = 'SEF'){
				$fund = 'SF';
			}else{
				$fund = 'TF';
			}
			$sheet .= '<tr  id = "'  . $trackYear . '*' . $tn  . '" onclick ="fetchPayroll1(this)">
						<td style = "text-align:center;">' . $i++ . '</td>
						<td style = "text-align:center;">' . $fund . '</td>
						<td style = "text-align:center;">' . $tn . '</td>
						<td style = "text-align:center;">' . $payroll . '</td>
						<td style = "text-align:right;">' . number_format($net,2) . '</td>
						<td class ="' . $class . '" style = "white-space:nowrap;">' . $status . '<br><span class ="innerModified" style ="text-shadow:none;">' . $modified . '</span></td>
						
					 </tr>';
		}
		$sheet .= '</table>';
		
		echo $sheet;
		
	}
	if(isset($_GET['fetchPaymasterSoloPayroll'])){
		$text =  $database->charEncoder($_GET['test']);
		$arr = explode('**', $database->vArrange($text));
		$year = $arr[0];
		$tn = $arr[1];
		
		
		$sql = "SELECT AddedTrackingNumber,AddedClaimant,AddedNumOfEmps,AddedOfficeAssigned,AddedNet,AddedPeriod,AddedDocumentType FROM chequerist.paymaster where pmtrackyear ='" . $year . "' and pmtrackingnumber ='" . $tn . "' order by AddedOfficeAssigned,AddedClaimant asc";
		$record = $database->query($sql);
		$count = $database->num_rows($record);
		$i = 1;
		
		$sheet = '<table style ="line-height:12px;border-spacing:0px;padding:10px;font-size:12px;">
				 	<tr>
				 		<td style ="text-align:right;">YEAR</td><td style = "font-weight:bold;letter-spacing:1px;">' . $year .  '</td>
				 	</tr>
				 	<tr>
				 		<td style ="text-align:right;">TN</td><td style = "font-weight:bold;letter-spacing:1px;">' . $tn . '</td>
				 	</tr>
				 </table>
				 <div style = "padding:5px;font-weight:bold;">LIST OF PAYROLLS ('  . $count . ')</div>	
				 ';
		$sheet .= '<table id = "paymasterSoloTable2"  style = "border-bottom:1px solid silver;">';
		$sheet .= '<tr>
						<th></th>
						<th	style = "text-align:left;">OFFICE</th>
						<th>TN</th>
						<th style = "text-align:left;">CLAIMANT</th>
						<th>EMP</th>
						<th style = "text-align:left;">TRANSACTION</th>
					 </tr>';
		while($data = $database->fetch_array($record)){
			
			$tn = $data['AddedTrackingNumber'];
			$claimant = utf8_decode($data['AddedClaimant']);
			$emp = $data['AddedNumOfEmps'];
			$office = strtoupper($data['AddedOfficeAssigned']);
			$net = $data['AddedNet'];
			$period =  $data['AddedPeriod'];
			$type =  $data['AddedDocumentType'];
			$sheet .= '<tr id = "'  . $year . '**' . $tn  . '"  style ="vertical-align:top;" onclick ="fetchPayroll2(this)">
						<td style = "text-align:center;">' . $i++ . '</td>
						<td style = "text-align:left;">' . $office . '</td>
						<td style = "text-align:center;">' . $tn . '</td>
						<td style = "">' . $claimant . '</td>
						<td style = "text-align:center;">' . $emp . '</td>
						<td style = "text-align:left;">' . $period . '<br><span style = "font-size:10px;">' .$type  . '<br>' . number_format($net,2) . '</span></td>
					
					 </tr>';
		}
		$sheet .= '</table>';
		echo $sheet;
		
	}
	if(isset($_GET['fetchPaymasterSoloPayrollVoucher'])){
		$text =  $database->charEncoder($_GET['test']);
		$arr = explode('**', $database->vArrange($text));
		$year = $arr[0];
		$tn = $arr[1];
		$firstPerson = $arr[2];
		$office = $arr[3];
		
		$sql = "SELECT Id,Type from brgs.sp_transaction_header where trackingyear = '" . $year . "' and trackingnumber = '" . $tn . "' limit 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$id = $data['Id'];
		$type = $data['Type'];
		
		if($type == 'SP'){
			$sql = "select empno from brgs.sp_transaction_details where header_id = '" . $id . "'";
		}else{
			$sql = "select empno from brgs.rp_transaction_details where header_id = '" . $id . "'";
		}
		
		$emps = '';
		$record = $database->query($sql);
		$count = $database->num_rows($record);
		while($data = $database->fetch_array($record)){
			$empno = $data['empno'];
			$emps .=  ",'" . $empno . "'";
		}
		$i = 1;
		$emps =  substr($emps,1);
		$sql = "select lastname, firstname, middlename,extension from brgs.employees where empno in(" . $emps . ") order by lastname asc";
		$record = $database->query($sql);
		
					 
		$sql =  "select registryid from afmis.registryheader where transactionyear ='" . $year . "' and trackingnumber = '" . $tn . "' limit 1";
		$record = $database->query($sql);			 
		$data = $database->fetch_array($record); 
		$id = $data['registryid'];
		
		$arrEmp = array();
		$emps = '';
		$sql = "select empno,netamount,status,b16Tracking from afmis.capayrollreference where transactionref = '" . $id . "'";
		$record = $database->query($sql);
		while($data = $database->fetch_array($record)){
			$empno = $data['empno'];
			$net = $data['netamount'];
			$status = $data['status'];
			$bTN = $data['b16Tracking'];
			
			$arrEmp[$empno]['net'] = $net;
			$arrEmp[$empno]['status'] = $status;
			$arrEmp[$empno]['bTN'] = $bTN;	
			
			$emps .=  ",'" . $empno . "'";
		}
		$emps =  substr($emps,1);
		
		$sql = "select empno,lastname, firstname, middlename,extension from brgs.employees where empno in(" . $emps . ")";
		$record = $database->query($sql);
		while($data = $database->fetch_array($record)){
			$empno= utf8_encode($data['empno']);
			$lastname = utf8_encode($data['lastname']);
			$firstname = utf8_encode($data['firstname']);
			$middlename = utf8_encode($data['middlename']);
			$ext = $data['extension'];
			$arrEmp[$empno]['lastname'] = $lastname;
			$arrEmp[$empno]['firstname'] = $firstname;
			$arrEmp[$empno]['middlename'] = $middlename;
			$arrEmp[$empno]['ext'] = $ext;
		}
		$sheet = '<table style ="line-height:12px;border-spacing:0px;padding:10px;font-size:12px;width:100%;margin-top:15px;">
				 	<tr>
				 		<td style ="text-align:right;width:1px;white-space:nowrap;">YEAR</td><td style = "font-weight:bold;letter-spacing:1px;">' . $year .  '</td>
				 		<td style ="text-align:right;">Office</td><td style = "font-weight:bold;letter-spacing:1px;width:10px;white-space:nowrap;">' . $office . '</td>
				 	</tr>
				 	<tr>
				 		
				 		<td style ="text-align:right;white-space:nowrap;">TN</td><td style = "font-weight:bold;letter-spacing:1px;">' . $tn . '</td>
				 		<td style ="text-align:right;white-space:nowrap;">PAYROLL</td><td style = "font-weight:bold;letter-spacing:1px;white-space:nowrap;">' . $firstPerson . '</td>
				 	</tr>
				 	<tr>
				 		
				 	</tr>
				 </table>
				 <div style = "padding:5px;font-weight:bold;line-height:14px;background-color:rgb(246, 246, 245); ">LIST OF EMPLOYEES ('  . $count . ')</div>	
				  <div style = "font-weight:bold;color:green;line-height:12px;padding-bottom:10px;font-size:12px;letter-spacing:1px;cursor:pointer;background-color:rgb(246, 246, 245);" id = "'  . $year . '**' . $tn  . '" onclick ="viewBreakdown(this)">VIEW BREAKDOWN</div>	
				 ';
		$sheet .= '<table id = "paymasterSoloTable3"  style = "border-bottom:1px solid silver;width:100%;">';
		$sheet .= '<tr>
						<th></th>
						<th	style = "text-align:left;" >Surname</th>
						<th	style = "text-align:left;" >Firstname</th>
						<th	style = "text-align:left;" >Middlename</th>
						<th style = "text-align:right;">Amount</th>
						<th style = "text-align:center;">B16</th>
					 </tr>';
		foreach($arrEmp as $rec){
			$net =   $rec['net'];
			$lastname =  $rec['lastname'];
			$firstname =  $rec['firstname'];
			$middlename =  $rec['middlename'];
			$ext =  $rec['ext'];
			
			$bTN =  $rec['bTN'];
			$status =  $rec['status'];
			
			$b16 = '';
			$change = '';
			if($status > 0){
				$b16 = 'Unclmd';
				$change = "font-weight:bold;color:white;background-color:rgb(101, 103, 98);";
			}
			if(strlen($bTN) > 0){
				$b16 = $bTN;
			}
			$sheet .= '<tr style ="vertical-align:top;" onclick ="changeColorTRpaymaster3(this)">
						<td style = "text-align:center;' . $change . '">' . $i++ . '</td>
						<td style = "text-align:left;">' . $lastname . '</td>
						<td style = "text-align:left;">' . $firstname . '</td>
						<td style = "text-align:left;">' . $middlename . $ext . '</td>
						<td style = "text-align:right;">' . number_format($net,2) . '</td>
						<td style = "text-align:center;">' . $b16 . '</td>
					 </tr>';
		}
		echo $sheet;	
		
		unset($arrEmp);
	}

	//---------------------------------------------------------------------------------------------------MOBILE VIEWER - START

	if(isset($_GET['searchMobileVouchers'])) {
		$key = $database->charEncoder($_GET['value']);
		$year = $database->charEncoder($_GET['year']);
		$db = $database->getDB($year);

		$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, Remarks
				FROM ".$db.".vouchercurrent WHERE TrackingType = 'PY' AND TrackingNumber = '".$key."' LIMIT 1";
		$record = $database->query($sql);
		$numRows = 0;
		if($database->num_rows($record) > 0){
			$numRows = 1;
		}else{
			$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, Remarks
					FROM ".$db.".vouchercurrent WHERE TrackingType = 'PY' AND Claimant LIKE '%".$key."%' GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 10";
			$record = $database->query($sql);
			
			if($database->num_rows($record) > 0) {
				$numRows = 1;
			}
		}

		if($numRows > 0) {
			$newRecord = [];
			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$newRecord[$tn]['TrackingNumber'] = $tn;
				$newRecord[$tn]['Id'] = $data['Id'];
				$newRecord[$tn]['TrackingType'] = $data['TrackingType'];
				$newRecord[$tn]['Status'] = $data['Status'];
				$newRecord[$tn]['Claimant'] = $data['Claimant'];
				$newRecord[$tn]['Year'] = $data['Year'];
				$newRecord[$tn]['DocumentType'] = $data['DocumentType'];
			
				$newRecord[$tn]['Office'] = $data['Office'];
				$sql = "SELECT Name FROM office WHERE Code = '".$newRecord[$tn]['Office']."' LIMIT 1";
				$record0 = $database->query($sql);
				$data0 = $database->fetch_array($record0);
				$newRecord[$tn]['OfficeName'] = $data0['Name'];
				
				$newRecord[$tn]['DateEncoded'] = $data['DateEncoded'];
				$newRecord[$tn]['DateModified'] = $data['DateModified'];
				$newRecord[$tn]['Period'] = $data['PeriodMonth'];
				$newRecord[$tn]['Remarks'] = $data['Remarks'];
			}

			$return = $sheet->CreatePublicTableMultipleMobileVouchers($newRecord, 0);

			$return .= "<span id='lastIdKey' style='display:none;'>".$key."</span>";

			echo $return;

			unset($newRecord);
		}else {
			echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
		}
	}

	if(isset($_GET['loadMoreMobileVouchers'])) {
		$key = $database->charEncoder($_GET['value']);
		$year = $database->charEncoder($_GET['year']);
		$lastId = $database->charEncoder($_GET['lastId']);
		$cnt = $database->charEncoder($_GET['count']);
		$db = $database->getDB($year);
		$numRows = 0;

		$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, Remarks, ADV1, OBR_Number
				FROM ".$db.".vouchercurrent WHERE TrackingType = 'PY' AND Claimant LIKE '%".$key."%' AND Id < '".$lastId."' GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 10";
		$record = $database->query($sql);
			
		if($database->num_rows($record) > 0) {
			$numRows = 1;
		}

		if($numRows > 0) {
			$newRecord = [];
			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$newRecord[$tn]['TrackingNumber'] = $tn;
				$newRecord[$tn]['Id'] = $data['Id'];
				$newRecord[$tn]['TrackingType'] = $data['TrackingType'];
				$newRecord[$tn]['Status'] = $data['Status'];
				$newRecord[$tn]['Claimant'] = $data['Claimant'];
				$newRecord[$tn]['Year'] = $data['Year'];
				$newRecord[$tn]['DocumentType'] = $data['DocumentType'];
			
				$newRecord[$tn]['Office'] = $data['Office'];
				$sql = "SELECT Name FROM office WHERE Code = '".$newRecord[$tn]['Office']."' LIMIT 1";
				$record0 = $database->query($sql);
				$data0 = $database->fetch_array($record0);
				$newRecord[$tn]['OfficeName'] = $data0['Name'];
				
				$newRecord[$tn]['DateEncoded'] = $data['DateEncoded'];
				$newRecord[$tn]['DateModified'] = $data['DateModified'];
				$newRecord[$tn]['Period'] = $data['PeriodMonth'];
				$newRecord[$tn]['Remarks'] = $data['Remarks'];

				$newRecord[$tn]['ADV'] = $data['ADV1'];
				$newRecord[$tn]['OBR'] = $data['OBR_Number'];
			}

			$return = $sheet->CreatePublicTableMultipleMobileVouchers($newRecord,$cnt);

			$return .= "<span id='lastIdKey' style='display:none;'>".$key."</span>";

			echo $return;

			unset($newRecord);
		}else {
			echo "<span style='font-size:12px; line-height:10px; color:rgba(104,104,104,1); user-select:none;'>NOTHING FOLLOWS<br/ >&#8943;</span>";
		}
	}
	
	if(isset($_GET['searchMobileGoods'])) {
		$key = $database->charEncoder($_GET['value']);
		$year = $database->charEncoder($_GET['year']);
		$db = $database->getDB($year);

		$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, PR_Month, Remarks, ADV1, OBR_Number, PR_Number, PO_Number
				FROM ".$db.".vouchercurrent WHERE TrackingType = 'PO' AND TrackingNumber = '".$key."' LIMIT 1";
		$record = $database->query($sql);
		$numRows = 0;
		if($database->num_rows($record) > 0){
			$numRows = 1;
		}else{
			$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, PR_Month, Remarks, ADV1, OBR_Number, PR_Number, PO_Number
					FROM ".$db.".vouchercurrent WHERE TrackingType = 'PO' AND Claimant LIKE '%".$key."%' GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 10";
			$record = $database->query($sql);
			
			if($database->num_rows($record) > 0) {
				$numRows = 1;
			}
		}

		if($numRows > 0) {
			$newRecord = [];
			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$newRecord[$tn]['TrackingNumber'] = $tn;
				$newRecord[$tn]['Id'] = $data['Id'];
				$newRecord[$tn]['TrackingType'] = $data['TrackingType'];
				$newRecord[$tn]['Status'] = $data['Status'];
				$newRecord[$tn]['Claimant'] = $data['Claimant'];
				$newRecord[$tn]['Year'] = $data['Year'];
				$newRecord[$tn]['DocumentType'] = $data['DocumentType'];
			
				$newRecord[$tn]['Office'] = $data['Office'];
				$sql = "SELECT Name FROM office WHERE Code = '".$newRecord[$tn]['Office']."' LIMIT 1";
				$record0 = $database->query($sql);
				$data0 = $database->fetch_array($record0);
				$newRecord[$tn]['OfficeName'] = $data0['Name'];
				
				$newRecord[$tn]['DateEncoded'] = $data['DateEncoded'];
				$newRecord[$tn]['DateModified'] = $data['DateModified'];
				$newRecord[$tn]['Period'] = $data['PeriodMonth'];
				$newRecord[$tn]['PR_Month'] = $data['PR_Month'];
				$newRecord[$tn]['Remarks'] = $data['Remarks'];

				$newRecord[$tn]['ADV'] = $data['ADV1'];
				$newRecord[$tn]['OBR'] = $data['OBR_Number'];
				$newRecord[$tn]['PR_Number'] = $data['PR_Number'];
				$newRecord[$tn]['PO_Number'] = $data['PO_Number'];
			}

			$return = $sheet->CreatePublicTableMultipleMobileGoods($newRecord, 0);

			$return .= "<span id='lastIdKey' style='display:none;'>".$key."</span>";

			echo $return;

			unset($newRecord);
		}else {
			echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
		}
	}

	if(isset($_GET['loadMoreMobileGoods'])) {
		$key = $database->charEncoder($_GET['value']);
		$year = $database->charEncoder($_GET['year']);
		$lastId = $database->charEncoder($_GET['lastId']);
		$cnt = $database->charEncoder($_GET['count']);
		$db = $database->getDB($year);
		$numRows = 0;

		$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, PR_Month, Remarks, ADV1, OBR_Number, PR_Number, PO_Number
				FROM ".$db.".vouchercurrent WHERE TrackingType = 'PO' AND Claimant LIKE '%".$key."%' AND Id < '".$lastId."' GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 10";
		$record = $database->query($sql);
			
		if($database->num_rows($record) > 0) {
			$numRows = 1;
		}

		if($numRows > 0) {
			$newRecord = [];
			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$newRecord[$tn]['TrackingNumber'] = $tn;
				$newRecord[$tn]['Id'] = $data['Id'];
				$newRecord[$tn]['TrackingType'] = $data['TrackingType'];
				$newRecord[$tn]['Status'] = $data['Status'];
				$newRecord[$tn]['Claimant'] = $data['Claimant'];
				$newRecord[$tn]['Year'] = $data['Year'];
				$newRecord[$tn]['DocumentType'] = $data['DocumentType'];
			
				$newRecord[$tn]['Office'] = $data['Office'];
				$sql = "SELECT Name FROM office WHERE Code = '".$newRecord[$tn]['Office']."' LIMIT 1";
				$record0 = $database->query($sql);
				$data0 = $database->fetch_array($record0);
				$newRecord[$tn]['OfficeName'] = $data0['Name'];
				
				$newRecord[$tn]['DateEncoded'] = $data['DateEncoded'];
				$newRecord[$tn]['DateModified'] = $data['DateModified'];
				$newRecord[$tn]['Period'] = $data['PeriodMonth'];
				$newRecord[$tn]['PR_Month'] = $data['PR_Month'];
				$newRecord[$tn]['Remarks'] = $data['Remarks'];

				$newRecord[$tn]['ADV'] = $data['ADV1'];
				$newRecord[$tn]['OBR'] = $data['OBR_Number'];
				$newRecord[$tn]['PR_Number'] = $data['PR_Number'];
				$newRecord[$tn]['PO_Number'] = $data['PO_Number'];
			}

			$return = $sheet->CreatePublicTableMultipleMobileGoods($newRecord,$cnt);

			$return .= "<span id='lastIdKey' style='display:none;'>".$key."</span>";

			echo $return;

			unset($newRecord);
		}else {
			echo "<span style='font-size:12px; line-height:10px; color:rgba(104,104,104,1); user-select:none;'>NOTHING FOLLOWS<br/ >&#8943;</span>";
		}
	}

	if(isset($_GET['searchMobileInfra'])) {
		$key = $database->charEncoder($_GET['value']);
		$year = $database->charEncoder($_GET['year']);
		$db = $database->getDB($year);

		$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, PR_Month, Remarks
				FROM ".$db.".vouchercurrent WHERE (TrackingType = 'NF' OR TrackingType = 'IP') AND TrackingNumber = '".$key."' LIMIT 1";
		$record = $database->query($sql);
		$numRows = 0;
		if($database->num_rows($record) > 0){
			$numRows = 1;
		}else{
			$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, PR_Month, Remarks
					FROM ".$db.".vouchercurrent WHERE (TrackingType = 'NF' OR TrackingType = 'IP') AND Claimant LIKE '%".$key."%' GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 10";
			$record = $database->query($sql);
			
			if($database->num_rows($record) > 0) {
				$numRows = 1;
			}
		}

		if($numRows > 0) {
			$newRecord = [];
			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$newRecord[$tn]['TrackingNumber'] = $tn;
				$newRecord[$tn]['Id'] = $data['Id'];
				$newRecord[$tn]['TrackingType'] = $data['TrackingType'];
				$newRecord[$tn]['Status'] = $data['Status'];
				$newRecord[$tn]['Claimant'] = $data['Claimant'];
				$newRecord[$tn]['Year'] = $data['Year'];
				$newRecord[$tn]['DocumentType'] = $data['DocumentType'];
			
				$newRecord[$tn]['Office'] = $data['Office'];
				$sql = "SELECT Name FROM office WHERE Code = '".$newRecord[$tn]['Office']."' LIMIT 1";
				$record0 = $database->query($sql);
				$data0 = $database->fetch_array($record0);
				$newRecord[$tn]['OfficeName'] = $data0['Name'];
				
				$newRecord[$tn]['DateEncoded'] = $data['DateEncoded'];
				$newRecord[$tn]['DateModified'] = $data['DateModified'];
				$newRecord[$tn]['Period'] = $data['PeriodMonth'];
				$newRecord[$tn]['PR_Month'] = $data['PR_Month'];
				$newRecord[$tn]['Remarks'] = $data['Remarks'];
			}

			$return = $sheet->CreatePublicTableMultipleMobileInfra($newRecord, 0);

			$return .= "<span id='lastIdKey' style='display:none;'>".$key."</span>";

			echo $return;

			unset($newRecord);
		}else {
			echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
		}
	}

	if(isset($_GET['loadMoreMobileInfra'])) {
		$key = $database->charEncoder($_GET['value']);
		$year = $database->charEncoder($_GET['year']);
		$lastId = $database->charEncoder($_GET['lastId']);
		$cnt = $database->charEncoder($_GET['count']);
		$db = $database->getDB($year);
		$numRows = 0;

		$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, PR_Month, Remarks
				FROM ".$db.".vouchercurrent WHERE (TrackingType = 'NF' OR TrackingType = 'IP') AND Claimant LIKE '%".$key."%' AND Id < '".$lastId."' GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 10";
		$record = $database->query($sql);

		if($database->num_rows($record) > 0) {
			$numRows = 1;
		}

		if($numRows > 0) {
			$newRecord = [];
			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$newRecord[$tn]['TrackingNumber'] = $tn;
				$newRecord[$tn]['Id'] = $data['Id'];
				$newRecord[$tn]['TrackingType'] = $data['TrackingType'];
				$newRecord[$tn]['Status'] = $data['Status'];
				$newRecord[$tn]['Claimant'] = $data['Claimant'];
				$newRecord[$tn]['Year'] = $data['Year'];
				$newRecord[$tn]['DocumentType'] = $data['DocumentType'];
			
				$newRecord[$tn]['Office'] = $data['Office'];
				$sql = "SELECT Name FROM office WHERE Code = '".$newRecord[$tn]['Office']."' LIMIT 1";
				$record0 = $database->query($sql);
				$data0 = $database->fetch_array($record0);
				$newRecord[$tn]['OfficeName'] = $data0['Name'];
				
				$newRecord[$tn]['DateEncoded'] = $data['DateEncoded'];
				$newRecord[$tn]['DateModified'] = $data['DateModified'];
				$newRecord[$tn]['Period'] = $data['PeriodMonth'];
				$newRecord[$tn]['PR_Month'] = $data['PR_Month'];
				$newRecord[$tn]['Remarks'] = $data['Remarks'];
			}

			$return = $sheet->CreatePublicTableMultipleMobileInfra($newRecord,$cnt);

			$return .= "<span id='lastIdKey' style='display:none;'>".$key."</span>";

			echo $return;

			unset($newRecord);
		}else {
			echo "<span style='font-size:12px; line-height:10px; color:rgba(104,104,104,1); user-select:none;'>NOTHING FOLLOWS<br/ >&#8943;</span>";
		}
	}

	if(isset($_GET['searchMobilePayroll'])) {
		$key = $database->charEncoder($_GET['value']);
		$year = $database->charEncoder($_GET['year']);
		$db = $database->getDB($year);

		$sql = "SELECT TrackingNumber FROM ".$db.".payrollptrs WHERE EmployeeNumber = '".$key."' GROUP BY TrackingNumber";
		$record = $database->query($sql);
		$numRows = 0;
		if($database->num_rows($record) > 0) {
			$numRows = 1;
		}else {
			$sql = "SELECT TrackingNumber FROM ".$db.".payrollptrs WHERE EmployeeName LIKE '%".$key."%' GROUP BY TrackingNumber";
			$record = $database->query($sql);
					
			if($database->num_rows($record) > 0) {
				$numRows = 1;
			}
		}

		if($numRows > 0) {

			$tnList = "";
			while($data = $database->fetch_array($record)) {
				$tnList .= ",'".$data['TrackingNumber']."'";
			}

			$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, PR_Month, Remarks
					FROM ".$db.".vouchercurrent WHERE TrackingNumber IN (".substr($tnList, 1).") GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 10";
			$record = $database->query($sql);

			$newRecord = [];
			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$newRecord[$tn]['TrackingNumber'] = $tn;
				$newRecord[$tn]['Id'] = $data['Id'];
				$newRecord[$tn]['TrackingType'] = $data['TrackingType'];
				$newRecord[$tn]['Status'] = $data['Status'];
				$newRecord[$tn]['Claimant'] = $data['Claimant'];
				$newRecord[$tn]['Year'] = $data['Year'];
				$newRecord[$tn]['DocumentType'] = $data['DocumentType'];
			
				$newRecord[$tn]['Office'] = $data['Office'];
				$sql = "SELECT Name FROM office WHERE Code = '".$newRecord[$tn]['Office']."' LIMIT 1";
				$record0 = $database->query($sql);
				$data0 = $database->fetch_array($record0);
				$newRecord[$tn]['OfficeName'] = $data0['Name'];
				
				$newRecord[$tn]['DateEncoded'] = $data['DateEncoded'];
				$newRecord[$tn]['DateModified'] = $data['DateModified'];
				$newRecord[$tn]['Period'] = $data['PeriodMonth'];
				$newRecord[$tn]['PR_Month'] = $data['PR_Month'];
				$newRecord[$tn]['Remarks'] = $data['Remarks'];
			}

			$return = $sheet->CreatePublicTableMultipleMobilePayroll($newRecord, 0, $tnList);

			$return .= "<span id='lastIdKey' style='display:none;'>".$key."</span>";

			echo $return;

			unset($newRecord);
		}else {
			echo "<div class = 'wiggle' style = 'color:white;font-size:48px;   display:block;margin-top:60px ;text-align:center;text-shadow:0px 2px 2px black;'>Wala'y nakita na record.</div>";
		}
	
	}

	if(isset($_GET['loadMoreMobilePayroll'])) {
		$key = $database->charEncoder($_GET['value']);
		$year = $database->charEncoder($_GET['year']);
		$lastId = $database->charEncoder($_GET['lastId']);
		$cnt = $database->charEncoder($_GET['count']);
		$tnList = stripslashes($database->charEncoder($_GET['tns']));
		$db = $database->getDB($year);

		$sql = "SELECT Id, TrackingNumber, TrackingType, Status, Claimant, Year, DocumentType, Office, DateEncoded, DateModified, PeriodMonth, PR_Month, Remarks
				FROM ".$db.".vouchercurrent WHERE TrackingNumber IN (".substr($tnList, 1).") AND Id < '".$lastId."' GROUP BY TrackingNumber ORDER BY Id DESC LIMIT 10";
		$record = $database->query($sql);

		$newRecord = [];
		while($data = $database->fetch_array($record)) {
			$tn = $data['TrackingNumber'];
			$newRecord[$tn]['TrackingNumber'] = $tn;
			$newRecord[$tn]['Id'] = $data['Id'];
			$newRecord[$tn]['TrackingType'] = $data['TrackingType'];
			$newRecord[$tn]['Status'] = $data['Status'];
			$newRecord[$tn]['Claimant'] = $data['Claimant'];
			$newRecord[$tn]['Year'] = $data['Year'];
			$newRecord[$tn]['DocumentType'] = $data['DocumentType'];
		
			$newRecord[$tn]['Office'] = $data['Office'];
			$sql = "SELECT Name FROM office WHERE Code = '".$newRecord[$tn]['Office']."' LIMIT 1";
			$record0 = $database->query($sql);
			$data0 = $database->fetch_array($record0);
			$newRecord[$tn]['OfficeName'] = $data0['Name'];
			
			$newRecord[$tn]['DateEncoded'] = $data['DateEncoded'];
			$newRecord[$tn]['DateModified'] = $data['DateModified'];
			$newRecord[$tn]['Period'] = $data['PeriodMonth'];
			$newRecord[$tn]['PR_Month'] = $data['PR_Month'];
			$newRecord[$tn]['Remarks'] = $data['Remarks'];
		}

		$return = $sheet->CreatePublicTableMultipleMobilePayroll($newRecord, $cnt, $tnList);

		$return .= "<span id='lastIdKey' style='display:none;'>".$key."</span>";

		echo $return;

		unset($newRecord);
	
	}

	if(isset($_GET['getGenDetailsVouchers'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);
		$year = $database->charEncoder($_GET['year']);
		$db = $database->getDB($year);
		$return = "";

		$return = "<div style='padding:0px 10px;'>";


		$sql = "SELECT ADV1, OBR_Number, Fund, FundYear, checknumber, checkdate, NetAmount, Remarks, TrackingType, DocumentType, ModeOfProcurement, Status, ClaimType FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);

		$data = $database->fetch_array($record);
		$newRecord = [];
		$newRecord['ADV1'] = $data['ADV1'];
		$newRecord['OBR_Number'] = $data['OBR_Number'];
		$newRecord['Fund'] = $data['Fund'];
		$newRecord['FundYear'] = $data['FundYear'];
		$newRecord['checknumber'] = $data['checknumber'];
		$newRecord['checkdate'] = $data['checkdate'];
		$newRecord['NetAmount'] = $data['NetAmount'];
		$newRecord['Remarks'] = $data['Remarks'];
		$newRecord['TrackingType'] = $data['TrackingType'];
		$newRecord['DocumentType'] = $data['DocumentType'];
		$newRecord['ModeOfProcurement'] = $data['ModeOfProcurement'];
		$newRecord['Status'] = $data['Status'];
		$newRecord['ClaimType'] = $data['ClaimType'];
		
		$return .= $sheet->createPublicMobileGenDetails($newRecord);
		$chkdetails = $sheet->createPublicMobileCheckDetails($newRecord);
		$pendingNote = $sheet->createPublicMobilePendingNote($newRecord);
		$progress = $sheet->createPublicMobileProgress($newRecord);
		
		unset($newRecord);

		$sql = "SELECT PR_ProgramCode, PR_AccountCode, Amount, TotalAmountMultiple FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' AND PR_ProgramCode IS NOT NULL";
		$record = $database->query($sql);

		if($database->num_rows($record) > 0) {
			$prgList = "";
			$accList = "";
			while ($data = $database->fetch_array($record)) {
				$prgCode = $data['PR_ProgramCode'];
				$accCode = $data['PR_AccountCode'];
				$amount = $data['Amount'];
				$total = $data['TotalAmountMultiple'];

				$newRecord[$prgCode][$accCode]['Amount'] = $amount;

				if(floatval($total) > 0) {
					$newRecord['Total'] = $total;
				}else {
					$newRecord['Total'] = $amount;
				}

				$prgList .= ",'".$prgCode."'";
				$accList .= ",'".$accCode."'";
			}

			$sql = "SELECT Code, Name FROM ".$db.".programcode WHERE Code IN (".substr($prgList, 1).")";
			$record = $database->query($sql);

			while ($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$title = $data['Name'];
				
				$newRecord[$code]['Title'] = $title;
			}

			$sql = "SELECT Code, Title FROM ".$db.".fundtitles WHERE Code IN (".substr($accList, 1).")";
			$record = $database->query($sql);

			$accTitles = [];
			while ($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$title = $data['Title'];
				
				$accTitles[$code] = $title;
			}

			foreach ($newRecord as $key => $value) {
				if($key != "Total") {
					foreach ($value as $code => $value1) {
						if ($code != "Title") {
							$newRecord[$key][$code]['Title'] = $accTitles[$code];
						}
					}
				}
				
			}
			$return .= $sheet->createPublicMobileOBR($newRecord);

			unset($newRecord);
		}
		
		$return .= $chkdetails;

		$sql = "SELECT * FROM ".$db.".voucherhistory WHERE TrackingNumber = '".$trackingNumber."'";
		$record = $database->query($sql);
		$return .= $sheet->createPublicMobileHistory($record);

		$return .= $pendingNote;
		$return .= $progress;

		$return .= "</div>";

		echo $return;
	}

	if(isset($_GET['getGenDetailsGoods'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);
		$year = $database->charEncoder($_GET['year']);
		$db = $database->getDB($year);
		$return = "";

		$return = "<div style='padding:0px 10px;'>";


		$sql = "SELECT ADV1, OBR_Number, Fund, FundYear, checknumber, checkdate, NetAmount, Remarks, TrackingType, DocumentType, ModeOfProcurement, Status, ClaimType FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);

		$data = $database->fetch_array($record);
		$newRecord = [];
		$newRecord['ADV1'] = $data['ADV1'];
		$newRecord['OBR_Number'] = $data['OBR_Number'];
		$newRecord['Fund'] = $data['Fund'];
		$newRecord['FundYear'] = $data['FundYear'];
		$newRecord['checknumber'] = $data['checknumber'];
		$newRecord['checkdate'] = $data['checkdate'];
		$newRecord['NetAmount'] = $data['NetAmount'];
		$newRecord['Remarks'] = $data['Remarks'];
		$newRecord['TrackingType'] = $data['TrackingType'];
		$newRecord['DocumentType'] = $data['DocumentType'];
		$newRecord['ModeOfProcurement'] = $data['ModeOfProcurement'];
		$newRecord['Status'] = $data['Status'];
		$newRecord['ClaimType'] = $data['ClaimType'];
		
		$return .= $sheet->createPublicMobileGenDetails($newRecord);
		$chkdetails = $sheet->createPublicMobileCheckDetails($newRecord);
		$pendingNote = $sheet->createPublicMobilePendingNote($newRecord);
		$progress = $sheet->createPublicMobileProgress($newRecord);
		
		unset($newRecord);

		$sql = "SELECT PR_ProgramCode, PR_AccountCode, PO_Amount, TotalAmountMultiple FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' AND PR_ProgramCode IS NOT NULL";
		$record = $database->query($sql);

		if($database->num_rows($record) > 0) {
			$prgList = "";
			$accList = "";
			while ($data = $database->fetch_array($record)) {
				$prgCode = $data['PR_ProgramCode'];
				$accCode = $data['PR_AccountCode'];
				$amount = $data['PO_Amount'];
				$total = $data['TotalAmountMultiple'];

				$newRecord[$prgCode][$accCode]['Amount'] = $amount;

				if(floatval($total) > 0) {
					$newRecord['Total'] = $total;
				}else {
					$newRecord['Total'] = $amount;
				}

				$prgList .= ",'".$prgCode."'";
				$accList .= ",'".$accCode."'";
			}

			$sql = "SELECT Code, Name FROM ".$db.".programcode WHERE Code IN (".substr($prgList, 1).")";
			$record = $database->query($sql);

			while ($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$title = $data['Name'];
				
				$newRecord[$code]['Title'] = $title;
			}

			$sql = "SELECT Code, Title FROM ".$db.".fundtitles WHERE Code IN (".substr($accList, 1).")";
			$record = $database->query($sql);

			$accTitles = [];
			while ($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$title = $data['Title'];
				
				$accTitles[$code] = $title;
			}

			foreach ($newRecord as $key => $value) {
				if($key != "Total") {
					foreach ($value as $code => $value1) {
						if ($code != "Title") {
							$newRecord[$key][$code]['Title'] = $accTitles[$code];
						}
					}
				}
				
			}
			$return .= $sheet->createPublicMobileOBR($newRecord);

			unset($newRecord);
		}
		
		$return .= $chkdetails;

		$sql = "SELECT * FROM ".$db.".voucherhistory WHERE TrackingNumber = '".$trackingNumber."'";
		$record = $database->query($sql);
		$return .= $sheet->createPublicMobileHistory($record);

		$return .= $pendingNote;
		$return .= $progress;

		$return .= "</div>";

		echo $return;
	}

	if(isset($_GET['getGenDetailsInfra'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);
		$year = $database->charEncoder($_GET['year']);
		$db = $database->getDB($year);
		$return = "";

		$return = "<div style='padding:0px 10px;'>";


		$sql = "SELECT ADV1, OBR_Number, Fund, FundYear, checknumber, checkdate, NetAmount, Remarks, TrackingType, DocumentType, ModeOfProcurement, Status, ClaimType FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);

		$data = $database->fetch_array($record);
		$newRecord = [];
		$newRecord['ADV1'] = $data['ADV1'];
		$newRecord['OBR_Number'] = $data['OBR_Number'];
		$newRecord['Fund'] = $data['Fund'];
		$newRecord['FundYear'] = $data['FundYear'];
		$newRecord['checknumber'] = $data['checknumber'];
		$newRecord['checkdate'] = $data['checkdate'];
		$newRecord['NetAmount'] = $data['NetAmount'];
		$newRecord['Remarks'] = $data['Remarks'];
		$newRecord['TrackingType'] = $data['TrackingType'];
		$newRecord['DocumentType'] = $data['DocumentType'];
		$newRecord['ModeOfProcurement'] = $data['ModeOfProcurement'];
		$newRecord['Status'] = $data['Status'];
		$newRecord['ClaimType'] = $data['ClaimType'];
		
		$return .= $sheet->createPublicMobileGenDetails($newRecord);
		$chkdetails = $sheet->createPublicMobileCheckDetails($newRecord);
		$pendingNote = $sheet->createPublicMobilePendingNote($newRecord);
		$progress = $sheet->createPublicMobileProgress($newRecord);
		
		unset($newRecord);

		$sql = "SELECT PR_ProgramCode, PR_AccountCode, Amount, TotalAmountMultiple FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' AND PR_ProgramCode IS NOT NULL";
		$record = $database->query($sql);

		if($database->num_rows($record) > 0) {
			$prgList = "";
			$accList = "";
			while ($data = $database->fetch_array($record)) {
				$prgCode = $data['PR_ProgramCode'];
				$accCode = $data['PR_AccountCode'];
				$amount = $data['Amount'];
				$total = $data['TotalAmountMultiple'];

				$newRecord[$prgCode][$accCode]['Amount'] = $amount;

				if(floatval($total) > 0) {
					$newRecord['Total'] = $total;
				}else {
					$newRecord['Total'] = $amount;
				}

				$prgList .= ",'".$prgCode."'";
				$accList .= ",'".$accCode."'";
			}

			$sql = "SELECT Code, Name FROM ".$db.".programcode WHERE Code IN (".substr($prgList, 1).")";
			$record = $database->query($sql);

			while ($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$title = $data['Name'];
				
				$newRecord[$code]['Title'] = $title;
			}

			$sql = "SELECT Code, Title FROM ".$db.".fundtitles WHERE Code IN (".substr($accList, 1).")";
			$record = $database->query($sql);

			$accTitles = [];
			while ($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$title = $data['Title'];
				
				$accTitles[$code] = $title;
			}

			foreach ($newRecord as $key => $value) {
				if($key != "Total") {
					foreach ($value as $code => $value1) {
						if ($code != "Title") {
							$newRecord[$key][$code]['Title'] = $accTitles[$code];
						}
					}
				}
				
			}
			$return .= $sheet->createPublicMobileOBR($newRecord);

			unset($newRecord);
		}
		
		$return .= $chkdetails;

		$sql = "SELECT * FROM ".$db.".voucherhistory WHERE TrackingNumber = '".$trackingNumber."'";
		$record = $database->query($sql);
		$return .= $sheet->createPublicMobileHistory($record);

		$return .= $pendingNote;
		$return .= $progress;

		$return .= "</div>";

		echo $return;
	}

	if(isset($_GET['getGenDetailsPayroll'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);
		$year = $database->charEncoder($_GET['year']);
		$db = $database->getDB($year);
		$return = "";

		$return = "<div style='padding:0px 10px;'>";


		$sql = "SELECT ADV1, OBR_Number, Fund, FundYear, checknumber, checkdate, NetAmount, Remarks, TrackingType, DocumentType, ModeOfProcurement, Status, ClaimType FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);

		$data = $database->fetch_array($record);
		$newRecord = [];
		$newRecord['ADV1'] = $data['ADV1'];
		$newRecord['OBR_Number'] = $data['OBR_Number'];
		$newRecord['Fund'] = $data['Fund'];
		$newRecord['FundYear'] = $data['FundYear'];
		$newRecord['checknumber'] = $data['checknumber'];
		$newRecord['checkdate'] = $data['checkdate'];
		$newRecord['NetAmount'] = $data['NetAmount'];
		$newRecord['Remarks'] = $data['Remarks'];
		$newRecord['TrackingType'] = $data['TrackingType'];
		$newRecord['DocumentType'] = $data['DocumentType'];
		$newRecord['ModeOfProcurement'] = $data['ModeOfProcurement'];
		$newRecord['Status'] = $data['Status'];
		$newRecord['ClaimType'] = $data['ClaimType'];
		
		$return .= $sheet->createPublicMobileGenDetails($newRecord);
		$chkdetails = $sheet->createPublicMobileCheckDetails($newRecord);
		$pendingNote = $sheet->createPublicMobilePendingNote($newRecord);
		$progress = $sheet->createPublicMobileProgress($newRecord);
		
		unset($newRecord);

		$sql = "SELECT PR_ProgramCode, PR_AccountCode, Amount, TotalAmountMultiple FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' AND PR_ProgramCode IS NOT NULL";
		$record = $database->query($sql);

		if($database->num_rows($record) > 0) {
			$prgList = "";
			$accList = "";
			while ($data = $database->fetch_array($record)) {
				$prgCode = $data['PR_ProgramCode'];
				$accCode = $data['PR_AccountCode'];
				$amount = $data['Amount'];
				$total = $data['TotalAmountMultiple'];

				$newRecord[$prgCode][$accCode]['Amount'] = $amount;

				if(floatval($total) > 0) {
					$newRecord['Total'] = $total;
				}else {
					$newRecord['Total'] = $amount;
				}

				$prgList .= ",'".$prgCode."'";
				$accList .= ",'".$accCode."'";
			}

			$sql = "SELECT Code, Name FROM ".$db.".programcode WHERE Code IN (".substr($prgList, 1).")";
			$record = $database->query($sql);

			while ($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$title = $data['Name'];
				
				$newRecord[$code]['Title'] = $title;
			}

			$sql = "SELECT Code, Title FROM ".$db.".fundtitles WHERE Code IN (".substr($accList, 1).")";
			$record = $database->query($sql);

			$accTitles = [];
			while ($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$title = $data['Title'];
				
				$accTitles[$code] = $title;
			}

			foreach ($newRecord as $key => $value) {
				if($key != "Total") {
					foreach ($value as $code => $value1) {
						if ($code != "Title") {
							$newRecord[$key][$code]['Title'] = $accTitles[$code];
						}
					}
				}
				
			}
			$return .= $sheet->createPublicMobileOBR($newRecord);

			unset($newRecord);
		}
		
		$return .= $chkdetails;

		$sql = "SELECT * FROM ".$db.".voucherhistory WHERE TrackingNumber = '".$trackingNumber."'";
		$record = $database->query($sql);
		$return .= $sheet->createPublicMobileHistory($record);

		$return .= $pendingNote;
		$return .= $progress;

		$return .= "</div>";

		echo $return;
	}
	
	//---------------------------------------------------------------------------------------------------MOBILE VIEWER - END


	if(isset($_GET['saveRegisterNotification'])){
		$crypt = $database->charEncoder($_GET['txetreg']);
		$arr = explode('@#$', $database->vArrange($crypt));
		$emp = $arr[0];
		$lastname = $arr[1];
		$firstname = $arr[2];
		$number = $arr[3];
		$sql = "select * from brgs.employees where empno = '"  . $emp . "' and lastname = '" . $lastname . "' and firstname = '" . $firstname . "' limit 1";
		$record = $database->query($sql);
		$count = $database->num_rows($record);
		if($count > 0){
			
			$data = $database->fetch_array($record);
			$officeCode = $data['office'];
			$sql = "select OfficeName from brgs.office where officecode = '"  . $officeCode . "' limit 1";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			$officeName = '';
			if($count > 0){
				$data = $database->fetch_array($record);
				$officeName =  $data['OfficeName'];
			}
			
			$sql = "select * from citydoc.employeenumbers where employeenumber = '" . $emp . "' limit 1";
			$record = $database->query($sql);
			$count = $database->num_rows($record);
			if($count > 0){
				if(strlen($number) == 11){
					$sql = "update citydoc.employeenumbers set ContactNumber = '" . $number . "',State = 1, DateUpdated  = '" . $dateEncoded . "' where employeenumber = '" . $emp . "'";
					$database->query($sql);
					echo 1 . "!@!Contact number has been updated.\nTo disable notifications submit empty contact number.\nThank you.";
				}else{
					$sql = "update citydoc.employeenumbers set ContactNumber = '" . $number . "',State = 0, DateUpdated  = '" . $dateEncoded . "'  where employeenumber = '" . $emp . "'";
					$database->query($sql);
					echo 1 . "!@!You will no longer receive notifications.\nInput valid number to active notifications again.\nThank you!";
				}
			}else{
				$sql = "Insert into citydoc.employeenumbers (EmployeeNumber,LastName,FirstName,ContactNumber,DateRegistered,Office,State)
						values('" . $emp . "','" . $lastname . "','" . $firstname . "','" . $number . "','" . $dateEncoded . "','" . addslashes($officeName) . "','1') ";
				$database->query($sql);
				echo 2 . "!@!You can now receive notifications when you have released transactions.\nTo disable notifications submit empty contact number.\nThank you.";
			}
		}else{
			echo 0;
		}
	}
	if(isset($_GET['selectCtrRegister'])){
		$sql = "select count(Id) as Count from citydoc.employeenumbers";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		echo $data['Count'];
	}

	if(isset($_GET['getTotalNumberOfComplexTN'])) {
		$month = $database->charEncoder($_GET['month']);
		$yearSel = $database->charEncoder($_GET['year']);
		$period = $yearSel.'-'.$month;

		// $sql = "SELECT Id FROM vouchercurrent where Complex = '2' AND substr(DateEncoded, 1, 7) = '".$period."' GROUP BY TrackingNumber";
		// $record = $database->query($sql);
		// $rows = $database->num_rows($record);

		$sql = "SELECT COUNT(b.Id) as cnt
				FROM (SELECT * FROM vouchercurrent WHERE Complex = '2' GROUP BY TrackingNumber) a
				LEFT JOIN (SELECT * FROM voucherhistory WHERE substr(DateModified, 1, 7) = '".$period."' AND Status = 'On Evaluation - Accounting' GROUP BY TrackingNumber) b ON a.TrackingNumber = b.TrackingNumber
				WHERE b.Status IS NOT NULL;";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$rows = $data['cnt'];

		$sheet = "";
		if($rows > 0) {
			$sheet = "<span style='margin-right:8px; font-size:11px;'>Total Complex Transactions :</span><span style='color:red; font-weight:bold; font-size:14px; cursor:pointer; user-select:none;' onclick='getTrackingComplexNcal()'>".$rows."</span>";
		}

		echo $sheet;
	}

	if(isset($_GET['getTrackingComplexNcal'])){
		$month = $database->charEncoder($_GET['month']);
		$yearSel = $database->charEncoder($_GET['year']);
		$period = $yearSel.'-'.$month;

		$sql = "SELECT TrackingNumber, Claimant, TrackingType, DocumentType, Status, Amount, PO_Amount, TotalAmountMultiple, Office, DateModified, Name, Complex 
				FROM vouchercurrent a
				LEFT JOIN office b ON a.Office = b.Code  
				WHERE Complex = '2' AND substr(DateEncoded, 1, 7) = '".$period."' GROUP BY TrackingNumber";
		$record = $database->query($sql);

		$return = $sheet->createTableCalendarTrackingComplex($record);
		$return .= "<div style='text-align:right; padding: 5px 5px 5px 0px;'>
						<span style='font-size:10px; font-family:roboto; letter-spacing:1px; cursor:pointer;' onclick=\"gotoFormCalendarComplex('".$year."','".$month."')\">
							PRINT LIST
						</span>
					</div>";
		echo $return;	
	}

	if(isset($_GET['inventorySearchByKey'])) {
		$key = $database->charEncoder($_GET['key']);
		$office = $database->charEncoder($_GET['office']);
		// $office = $_SESSION['cbo'];


		if (substr($key, 0,1) == "*") {
			$key = str_replace("*", "", $key);
			$sql = "SELECT Id, TrackingNumber, Year, Item, Brand, Description, PropertyNumber, StickerNumber, SerialNumber, NameAssignedTo, EmployeeNumber, Status,CurrentUser  
					FROM inventory.pisrecord 
					WHERE 
					Office = '".$office."' and Brand LIKE '%".$key."%'
					ORDER BY Id DESC
					";
		} else if (substr($key, 0,1) == "/") {
			$key = str_replace("/", "", $key);
			$sql = "SELECT Id, TrackingNumber, Year, Item, Brand, Description, PropertyNumber, StickerNumber, SerialNumber, NameAssignedTo, EmployeeNumber, Status,CurrentUser  
					FROM inventory.pisrecord 
					WHERE 
					Office = '".$office."' and SerialNumber LIKE '%".$key."%'
					ORDER BY Id DESC
					";
		} else if (substr($key, 0,1) == "\\") {
			$key = str_replace("\\", "", $key);
			$sql = "SELECT Id, TrackingNumber, Year, Item, Brand, Description, PropertyNumber, StickerNumber, SerialNumber, NameAssignedTo, EmployeeNumber, Status,CurrentUser  
					FROM inventory.pisrecord 
					WHERE 
					Office = '".$office."' and CurrentUserNum LIKE '%".$key."%'
					ORDER BY Id DESC
					";
		} else if (substr($key, 0,1) == "~") {
			$key = str_replace("~", "", $key);
			$sql = "SELECT Id, TrackingNumber, Year, Item, Brand, Description, PropertyNumber, StickerNumber, SerialNumber, NameAssignedTo, EmployeeNumber, Status,CurrentUser  
					FROM inventory.pisrecord 
					WHERE 
					Office = '".$office."' and CurrentUser LIKE '%".$key."%'
					ORDER BY Id DESC
					";
		} else {
			$sql = "SELECT Id, TrackingNumber, Year, Item, Brand, Description, PropertyNumber, StickerNumber, SerialNumber, NameAssignedTo, EmployeeNumber, Status,CurrentUser 
					FROM inventory.pisrecord 
					WHERE 
					Office = '".$office."' and TrackingNumber LIKE '%".$key."%' OR 
					Office = '".$office."' and Description LIKE '%".$key."%' OR 
					Office = '".$office."' and EmployeeNumber LIKE '%".$key."%' OR 
					Office = '".$office."' and NameAssignedTo LIKE '%".$key."%' OR 
					Office = '".$office."' and PropertyNumber LIKE '%".$key."%' OR 
					Office = '".$office."' and StickerNumber LIKE '%".$key."%' 
					ORDER BY Id DESC
					";
		}

		$result = $database->query($sql);
		echo $sheet->generateInvViewerView($result);
	}

	if (isset($_GET['invSearchByParams'])) {
		$year = $database->charEncoder($_GET['Year']);
		$item = $database->charEncoder($_GET['Item']);
		$brand = $database->charEncoder($_GET['Brand']);
		$classification = $database->charEncoder($_GET['classification']);
		$category =$database->charEncoder($_GET['category']);
		$office =$database->charEncoder($_GET['office']);
		// $office = $_SESSION['cbo'];

		$op1 = "=";
		if ($year == "") {
			$op1 = "!=";
		}
		$op2 = "=";
		if ($item == "") {
			$op2 = "!=";
		}
		$op3 = "=";
		if ($brand == "") {
			$op3 = "!=";
		}
		$op4 = "=";
		if ($classification == "") {
			$op4 = "!=";
		}
		$op5 = "=";
		if ($category == "") {
			$op5 = "!=";
		}

		$sql = "SELECT a.Id, a.TrackingNumber, a.Year, a.Item, a.Brand, a.Description, a.PropertyNumber, a.StickerNumber, a.SerialNumber, a.NameAssignedTo, a.EmployeeNumber, a.Status, a.CurrentUser,a.ItemClassification,a.Category 
				FROM inventory.pisrecord a
				WHERE 
				a.Year ".$op1." '".$year."' and
				a.Office = '".$office."' and
				a.ItemClassification " .$op4 . " '". $classification."' and
				a.Category ".$op5." '".$category."' and
				a.ItemId ".$op2." '".$item."' and
				a.Brand ".$op3." '".$brand."' 
				ORDER BY a.Year DESC, a.TrackingNumber DESC, a.Item DESC";

		$result = $database->query($sql);
		echo $sheet->generateInvViewerView($result);
	}

	if(isset($_GET['invLoadItemsByCategory'])){
		$office =$database->charEncoder($_GET['office']);
		$category = $database->charEncoder($_GET['category']);
		$sql = 'Select ItemId,Item from inventory.pisrecord where office = "' . $office . '" and Category = "' . $category . '" group by ItemId order by Item';
		$record = $database->query($sql);
		$sheet = '<option></option>';
		while($data = $database->fetch_array($record)){
			$itemId = $data['ItemId'];
			$item = $data['Item'];
			$sheet .= '<option value  = "' . $itemId . '">' . $item . '</option>';
		}		
		echo $sheet;
	}

	if(isset($_GET['invLoadBrand'])){
		$itemId = $database->charEncoder($_GET['itemId']);
		$office =$database->charEncoder($_GET['office']);
	
		$sql = "Select * from inventory.pisrecord where office = '" . $office . "' and ItemId = '" . $itemId . "' group by Brand";
		$record = $database->query($sql);
		$sheet = '<option></option>';
		while($data = $database->fetch_array($record)){
			$brand = $data['Brand'];
			$sheet .= '<option>' . $brand . '</option>';
		}
		echo $sheet;
	}

	if(isset($_GET['invLoadCategoryViewer'])){
		$office = $database->charEncoder($_GET['office']);

		$sql = "select a.Category, b.Description, b.Code from inventory.pisrecord a left join ppmpcategories b on a.Category = b.Code WHERE office = '" . $office . "'  group by a.Category order by b.Description asc";
		$record = $database->query($sql);
		$sheet = '<option></option>';
		while($data = $database->fetch_array($record)){
			$description = $data['Description'];
			$code =  $data['Code'];
			$sheet .= '<option value = "' . $code  . '">' . $description . '</option>';
		} 
		echo $sheet;
	}

	if (isset($_GET['invGetSingleItem'])) {
		$row = $database->charEncoder($_GET['row']);
		$year = $database->charEncoder($_GET['year']);
		$tn = $database->charEncoder($_GET['tn']);

		$db = $database->getDB($year);

		$sql = "SELECT a.*, c.InvoiceNumber, c.InvoiceDate, c.PoDate, c.DateAcquired, b.PO_Number, b.Claimant, d.Name, concat(  e.FirstName , ' ' ,e.LastName) as EncodedName FROM 
				inventory.pisrecord a 
				left join ".$db.".vouchercurrent b
				on a.trackingnumber = b.trackingnumber
				left join ".$db.".office d
				on d.Code = a.Office
				left join ".$db.".particulars c 
				on a.Trackingnumber = c.TrackingNumber
				left join citydoc.employees e 
				on a.EncodedBy  = e.EmployeeNumber
				where a.Id = '".$row."' 
				group by a.serialnumber order by a.DateEncoded DESC";

		$newRecord = [];
				
		$sql = "SELECT * FROM inventory.pisrecord WHERE Id = '".$row."' LIMIT 1";
		$record = $database->query($sql);

		$data = $database->fetch_array($record);
		$yearTn = $data['Year'];
		$tnThis = $data['TrackingNumber'];
		$item = $data['Item'];
		$brand = $data['Brand'];
		$desc = $data['Description'];
		$unit = $data['Unit'];
		$unit = substr($unit, 0, strpos($unit, '/'));
		$sn = $data['SerialNumber'];
		$model = $data['ModelNumber'];
		$classification = $data['ItemClassification'];
		$empN = $data['EmployeeNumber'];
		$uname = $data['NameAssignedTo'];
		$set = $data['Set'];
		$dateAcq = $data['DateAcquired'];
		$dateReceived = $data['DateReceived'];
		$poDetails = $data['ManualDetails'];
		$proNum = $data['PropertyNumber'];
		$stcNum = $data['StickerNumber'];
		$classificationNumber =  $data['ClassificationNumber'];
		$ucost = $data['UnitCost'];
		$amount = $data['Amount'];
		$inBy = $data['InspectedBy'];
		$remarks = $data['Remarks'];
		$postn = $data['Position'];
		$curName = $data['CurrentUser'];
		$curNum = $data['CurrentUserNum'];
		$curPos = $data['CurrentUserPos'];
		$status = $data['Status'];
		$transfer = $data['Transfer'];
		$encoded = $data['DateEncoded'];
		$cost =  number_format($database->nullToZero($data['UnitCost']),2);
		$category = $data['Category'];
		$officeCode = $data['Office'];
		$encodedBy = $data['EncodedBy'];

		$newRecord['Year'] = $yearTn;
		$newRecord['TrackingNumber'] = $tnThis;
		$newRecord['Item'] = $item;
		$newRecord['Brand'] = $brand;
		$newRecord['Description'] = $desc;
		$newRecord['Unit'] = $unit;
		$newRecord['SerialNumber'] = $sn;
		$newRecord['ModelNumber'] = $model;
		$newRecord['ItemClassification'] = $classification;
		$newRecord['EmployeeNumber'] = $empN;
		$newRecord['NameAssignedTo'] = $uname;
		$newRecord['Set'] = $set;
		$newRecord['DateAcquired'] = $dateAcq;
		$newRecord['DateReceived'] = $dateReceived;
		$newRecord['ManualDetails'] = $poDetails;
		$newRecord['PropertyNumber'] = $proNum;
		$newRecord['StickerNumber'] = $stcNum;
		$newRecord['ClassificationNumber'] = $classificationNumber;
		$newRecord['UnitCost'] = $ucost;
		$newRecord['Amount'] = $amount;
		$newRecord['InspectedBy'] = $inBy;
		$newRecord['Remarks'] = $remarks;
		$newRecord['Position'] = $postn;
		$newRecord['CurrentUser'] = $curName;
		$newRecord['CurrentUserNum'] = $curNum;
		$newRecord['CurrentUserPos'] = $curPos;
		$newRecord['Status'] = $status;
		$newRecord['Transfer'] = $transfer;
		$newRecord['DateEncoded'] = $encoded;
		$newRecord['UnitCost'] = $cost;
		$newRecord['Category'] = $category;
		$newRecord['Office'] = $officeCode;
		$newRecord['EncodedBy'] = $encodedBy;

		if($tn != "") {
			$sql = "SELECT PO_Number, Claimant FROM ".$db.".vouchercurrent WHERE TrackingNumber = '".$tn."' LIMIT 1";
			$record = $database->query($sql);

			$data = $database->fetch_array($record);
			$newRecord['PO_Number'] = $data['PO_Number'];
			$newRecord['Claimant'] = $data['Claimant'];
		}else {
			$newRecord['PO_Number'] = "";
			$newRecord['Claimant'] = "";
		}

		$sql = "SELECT Name FROM ".$db.".office WHERE Code = '".$officeCode."' LIMIT 1";
		$record = $database->query($sql);

		$data = $database->fetch_array($record);
		$newRecord['OfficeName'] = $data['Name'];

		if($year > 2017 && $tn != "") {
			$sql = "SELECT InvoiceNumber, InvoiceDate, PoDate, DateAcquired FROM ".$db.".particulars WHERE TrackingNumber = '".$tn."' LIMIT 1";
			$record = $database->query($sql);

			$data = $database->fetch_array($record);
			$newRecord['InvoiceNumber'] = $data['InvoiceNumber'];
			$newRecord['InvoiceDate'] = $data['InvoiceDate'];
			$newRecord['PoDate'] = $data['PoDate'];
			$newRecord['DateAcquired'] = $data['DateAcquired'];
		}else {
			$newRecord['InvoiceNumber'] = "";
			$newRecord['InvoiceDate'] = "";
			$newRecord['PoDate'] = "";
			$newRecord['DateAcquired'] = "";
		}
		

		$sql = "SELECT FirstName, LastName FROM citydoc.employees WHERE EmployeeNumber = '".$encodedBy."' LIMIT 1";
		$record = $database->query($sql);

		$data = $database->fetch_array($record);
		$newRecord['EncodedName'] = $data['FirstName']." ".$data['LastName'];

		echo $sheet->generateSingleItemViewInv($newRecord);


		// if($tn == "" ){
		// 	$sql = "SELECT a.*, b.Name, concat(  e.FirstName , ' ' ,e.LastName) as EncodedName FROM inventory.pisrecord a 
		// 			LEFT JOIN ".$db.".office b ON b.Code = a.Office
		// 			left join citydoc.employees e 
		// 			on a.EncodedBy  = e.EmployeeNumber
		// 			WHERE a.Id = '".$row."' GROUP BY a.SerialNumber";
		// }else{

		// 	if ($year < 2017) {
		// 		$sql = "SELECT a.*, b.PO_Number, b.Claimant, c.Name FROM 
		// 				inventory.pisrecord a 
		// 				left join ".$db.".vouchercurrent b
		// 				on a.trackingnumber = b.trackingnumber
		// 				left join ".$db.".office c
		// 				on c.Code = a.Office
		// 				where a.Id = '".$row."'
		// 				group by a.serialnumber order by a.DateEncoded DESC";	
		// 	} else {
		// 		$sql = "SELECT a.*, c.InvoiceNumber, c.InvoiceDate, c.PoDate, c.DateAcquired, b.PO_Number, b.Claimant, d.Name, concat(  e.FirstName , ' ' ,e.LastName) as EncodedName FROM 
		// 				inventory.pisrecord a 
		// 				left join ".$db.".vouchercurrent b
		// 				on a.trackingnumber = b.trackingnumber
		// 				left join ".$db.".office d
		// 				on d.Code = a.Office
		// 				left join ".$db.".particulars c 
		// 				on a.Trackingnumber = c.TrackingNumber
		// 				left join citydoc.employees e 
		// 				on a.EncodedBy  = e.EmployeeNumber
		// 				where a.Id = '".$row."' 
		// 				group by a.serialnumber order by a.DateEncoded DESC";	
		// 	}
		// }
		// $result = $database->query($sql);
		// echo $sheet->generateSingleItemViewInv($result);
	}

	if (isset($_GET['getInvItemSummary'])) {
		$employeeNumber = $database->charEncoder($_GET['emp']);

		$sql = "SELECT a.Year, a.Brand, a.Description, a.StickerNumber, a.DateReceived, a.EmployeeNumber, a.NameAssignedTo, a.Position, b.Name as OfficeName 
				FROM inventory.pisrecord a
				LEFT JOIN office b ON b.Code = a.Office
				WHERE a.EmployeeNumber = '".$employeeNumber."'";
		$result = $database->query($sql);
		echo $sheet->generateSummaryOfItemsInv($result);
	}

	if(isset($_GET['invLoadOffices'])) {
		$office = $_SESSION['cbo'];
		$sql = "SELECT Code, Name FROM office ORDER BY Name ASC";
		$record = $database->query($sql);
		
		$sheet = "<option></option>";
		while ($data = $database->fetch_array($record)) {
			$code = $data['Code'];
			$name = $data['Name'];

			if($code == $office) {
				$sheet .= "<option value='".$code."' selected>".$name."</option>";
			}else {
				$sheet .= "<option value='".$code."'>".$name."</option>";
			}
		}

		echo $sheet;
	}

	if(isset($_GET['loadInvCategoriesView'])) {
		$office = $database->charEncoder($_GET['office']);

		$sql = "SELECT Category, count(Id) as cnt FROM inventory.pisrecord WHERE Office = '".$office."' GROUP BY Category ORDER BY Category ASC";
		$record = $database->query($sql);

		if($database->num_rows($record) > 0) {
			$newRecord = [];
			$catCodes = "";
			while ($data = $database->fetch_array($record)) {
				$category = $data['Category'];
				$cnt = $data['cnt'];

				if(trim($category) != "") {
					$newRecord[$category]['Code'] = $category;
					$newRecord[$category]['Count'] = $cnt;
					$catCodes .= ",'".$category."'";
				}else {
					if(!isset($newRecord['Uncategorized']['Count'])) {
						$newRecord['Uncategorized']['Count'] = 0;
					}

					$newRecord['Uncategorized']['Code'] = "";
					$newRecord['Uncategorized']['Title'] = "Uncategorized";
					$newRecord['Uncategorized']['Count'] += $cnt;
				}
			}

			$sql = "SELECT * FROM ppmpcategories WHERE Code IN (".substr($catCodes, 1).")";
			$record = $database->query($sql);
			
			while($data = $database->fetch_array($record)) {
				$code = $data['Code'];
				$desc = $data['Description'];

				$newRecord[$code]['Title'] = $desc;
			}
			echo $sheet->generateInventorySummaryByCat($newRecord);
		}else {
			echo "<div style='padding:8px 0px; font-weight:bold; text-align:center; width:100%; color:gray;'>No record found.</div>";
		}
	}

	if(isset($_GET['getThisInvCatItems'])) {
		$office = $database->charEncoder($_GET['office']);
		$category = $database->charEncoder($_GET['category']);

		$sql = "SELECT Id, TrackingNumber, Year, Item, Brand, Description, PropertyNumber, StickerNumber, SerialNumber, NameAssignedTo, EmployeeNumber, Status, CurrentUser, Remarks, DateAcquired  
				FROM inventory.pisrecord 
				WHERE 
				Office = '".$office."' AND Category = '".$category."'
				ORDER BY Year DESC, TrackingNumber DESC
				";
		$record = $database->query($sql);
		if ($database->num_rows($record) > 0) {
			$newRecord = [];
			while($data = $database->fetch_array($record)) {
				$tn = $data['TrackingNumber'];
				$yr = $data['Year'];
				$id = $data['Id'];
				$newRecord[$id]['Id'] = $data['Id'];
				$newRecord[$id]['TrackingNumber'] = $tn;
				$newRecord[$id]['Year'] = $data['Year'];
				$newRecord[$id]['Item'] = $data['Item'];
				$newRecord[$id]['Brand'] = $data['Brand'];
				$newRecord[$id]['Description'] = $data['Description'];
				$newRecord[$id]['PropertyNumber'] = $data['PropertyNumber'];
				$newRecord[$id]['StickerNumber'] = $data['StickerNumber'];
				$newRecord[$id]['SerialNumber'] = $data['SerialNumber'];
				$newRecord[$id]['NameAssignedTo'] = $data['NameAssignedTo'];
				$newRecord[$id]['EmployeeNumber'] = $data['EmployeeNumber'];
				$newRecord[$id]['Status'] = $data['Status'];
				$newRecord[$id]['CurrentUser'] = $data['CurrentUser'];
				$newRecord[$id]['Remarks'] = $data['Remarks'];
				$newRecord[$id]['DateAcquired'] = $data['DateAcquired'];
			}

			if($category != "") {
				$sql = "SELECT * FROM ppmpcategories WHERE Code = '".$category."' LIMIT 1";
				$record = $database->query($sql);

				$data = $database->fetch_array($record);
				$title = $data['Description'];
				$header = "<div style='font-weight:bold; font-size:20px; background-image:linear-gradient(to right, rgba(0,0,0,.1), white); padding:3px 10px; padding-left:40px;'><span style='color:rgb(0, 96, 128);'>".$category."</span> - ".$title."</div>";
			}else {
				$header = "<div style='font-weight:bold; font-size:20px; background-image:linear-gradient(to right, rgba(0,0,0,.1), white); padding:3px 10px; padding-left:40px;'><span style='color:rgb(0, 96, 128);'>Uncategorized</span></div>";
			}

			echo $sheet->generateInvViewerGenOnly($newRecord, $header);
		} else {
			echo "<div class = 'norecord' style='' >
						No record found.
				</div>";
		}
	}

	if(isset($_GET['revertForComputeLD'])) {
		$trackingNumber = $database->charEncoder($_GET['tn']);

		$sql = "SELECT * FROM porecord WHERE TrackingNumber = '".$trackingNumber."'";
		$record = $database->query($sql);

		$insertCase = "";
		while ($data = $database->fetch_array($record)) {
			$category = $data['Category'];
			$progCode = $data['ProgramCode'];
			$acctCode = $data['Code'];
			$unit = $data['Unit'];
			$itemNum = $data['Item'];
			$description = $data['Description'];
			$qty = $data['Qty'];
			$amount = $data['Amount'];
			$total = $data['Total'];

			$insertCase .= ",('".$trackingNumber."','".$category."','".$progCode."','".$acctCode."','".$unit."','".$itemNum."','".addslashes($description)."','".$qty."','".$amount."','".$total."')";
		}

		// if($accountType != 1) {
		if($_SESSION['accountType'] != 1) {

			$sql = "SELECT Remarks FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$oldNote = $data['Remarks'];
			
			$pendingNote = "Adjust Unit Cost/s with Liquidated Damages.";

			$status = "Pending at CAO";

			if(strlen($oldNote) > 0){
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' .  $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CAO</b></span><br/><br/>' . $oldNote;
			}else{
				$pendingNote  = '<span style = "color:rgb(47, 167, 219);">' . $pendingNote . '</span><br/><span class = "label1" style = "color:grey;font-weight:normal">' .$dateEncoded . ' - <b>CAO</b></span>';
			}

			$updateCase = " Remarks = '" . $pendingNote . "',OBR_Approve = 0, Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "'";
		
			$completion = "";
			$database->UpdateTrackingStatus($updateCase,$trackingNumber);
			$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

		}

		

		$sql = "INSERT INTO porecordoriginal (TrackingNumber, Category, ProgramCode, Code, Unit, Item, Description, Qty, Amount, Total) VALUES ".substr($insertCase, 1);
		$database->query($sql);


		echo $trackingNumber;
	}

	//---------------------------------------------------------------------------------------------------INFRA RETENTION - START

	if(isset($_GET['fetchMultiProjRETIN'])) {

		$sql = "SELECT TrackingNumber FROM infra WHERE Progress = '100.00' AND RetentionTrackingNumber IS NULL";
		$record = $database->query($sql);

		$tns = "";
		while ($data = $database->fetch_array($record)) {
			$tns .= ",'".$data['TrackingNumber']."'";
		}

		$sql = "SELECT TrackingNumberInfra, Name FROM programcode WHERE TrackingNumberInfra IN (".substr($tns, 1).")";
		$record = $database->query($sql);

		$sheet = "<option></option>";
		while ($data = $database->fetch_array($record)) {
			$trackingNumber = $data['TrackingNumberInfra'];
			$project = $data['Name'];

			$sheet .= "<option value='".$trackingNumber."'>".$trackingNumber."&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".$project."</option>";
		}

		echo $sheet;

	}

	if(isset($_GET['getInfraTrackingDetails'])) {
		
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$newRecord = [];

		$sql = "SELECT TrackingNumber, Claimant, FundYear, PR_ProgramCode, PR_AccountCode, Fund FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);

		if($database->num_rows($record) > 0) {
			$newRecord['TrackingNumber'] = $data['TrackingNumber'];
			$newRecord['Claimant'] = $data['Claimant'];
			$newRecord['FundYear'] = $data['FundYear'];
			$newRecord['PR_ProgramCode'] = $data['PR_ProgramCode'];
			$newRecord['PR_AccountCode'] = $data['PR_AccountCode'];
			$newRecord['Fund'] = $data['Fund'];

			$sql = "SELECT Name FROM programcode WHERE TrackingNumberInfra = '".$trackingNumber."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$newRecord['ProjectName'] = $data['Name'];

			$sql = "SELECT Title FROM fundtitles WHERE Code = '".$newRecord['PR_AccountCode']."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$newRecord['AccountTitle'] = $data['Title'];

			$sql = "SELECT Progress, Duration FROM infra WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$newRecord['Progress'] = $data['Progress'];
			$newRecord['Duration'] = $data['Duration'];

			$sql = "SELECT Retention FROM infrapayment WHERE InfraTracking = '".$trackingNumber."'";
			$record = $database->query($sql);
			$totalRetention = 0;

			while ($data = $database->fetch_array($record)) {
				$retention = $data['Retention'];

				$totalRetention += $retention;
			}
			$newRecord['Retention'] = $totalRetention;

			
			$thisOfis = explode('-', $newRecord['TrackingNumber']);
			$thisOfis = $thisOfis[0];

			//pagkuha sa new seq
			$condition = "where code = '" . $thisOfis . "' limit 1";
			$record = $database->FetchDoctrackID("Doctrack",$condition);
			$data = $database->fetch_array($record);
			$trackingNumber = $thisOfis . '-' . ($data['Doctrack']+1); 

			echo $sheet->createInfraRetentionDetails($newRecord)."*j*".$trackingNumber;	
		}else {
			echo 0;
		}

	}

	if(isset($_GET['saveTrackingInfraRETIN'])) {
		$infraTN = $database->charEncoder($_GET['infraTN']);
		$contractor = $database->charEncoder($_GET['contractor']);
		$retention = $database->charEncoder($_GET['retention']);
		$fund = $database->charEncoder($_GET['fund']);
		$program = $database->charEncoder($_GET['program']);

		$thisOfis = explode('-', $infraTN);
		$thisOfis = $thisOfis[0];
		$trackingType = 'PY';

		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$thisOfis);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $thisOfis . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $thisOfis . '-' . $data['Doctrack'];
		$newTrackingNumber = $thisOfis . '-' . ($data['Doctrack']+1); 

		$claimType = 'Check';
		$docType = 'RETENTION - INFRA';

		$dt = time();
		$periodMonth = date('F', $dt);
		$periodType = 'Monthly';
		$status = 'Encoded';

		$sql = "INSERT INTO vouchercurrent 
				(Year, Office, TrackingType, TrackingNumber, TrackingPartner, Fund, ClaimType, DocumentType, PeriodMonth, PeriodType, Claimant, Amount, EncodedBy, DateEncoded, Status, NetAmount)
				VALUES 
				('".$year."','".$thisOfis."','".$trackingType."','".$trackingNumber."','".$infraTN."','".$fund."','".$claimType."','".$docType."','".$periodMonth."','".$periodType."','".$contractor."','".$retention."','".$employeeNumber."','".$dateEncoded."','".$status."','".$retention."')
				";
		$database->query($sql);

		$sql = "UPDATE infra SET RetentionTrackingNumber = '".$trackingNumber."' WHERE TrackingNumber = '".$infraTN."'";
		$database->query($sql);

		$sql = "SELECT Name FROM programcode WHERE TrackingNumberInfra = '".$infraTN."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$project = $data['Name'];

		$particulars = "\n\n&nbsp;&nbsp;&nbsp;For payment of (Retention Money) of a bid contract for the project : ".$project.", as per supporting papers hereto attached in the amount of.....\n\nProject Code : ".$program."\nProject Tracking : ".$infraTN;
		$sql = "INSERT INTO particulars (TrackingNumber, Particulars) VALUES ('".$trackingNumber."','".$particulars."')";
		$database->query($sql);

		echo $newTrackingNumber."~".$trackingNumber;
	}

	//---------------------------------------------------------------------------------------------------INFRA RETENTION - END

	//---------------------------------------------------------------------------------------------------NEW PR PO GOODS AND SERVICES - START

	if(isset($_GET['getTrackedPRs'])) {
		$category = $database->charEncoder($_GET['category']);
		$qtr = $database->charEncoder($_GET['qtr']);
		$totalTracked = 0.00;

		$qtrCond = "";
		$qtrDisp = "";
		if ($qtr == 'optGoods1st') {
			$qtrCond = "(PR_Month >= 1 AND PR_Month <= 3)";
			$qtrDisp = "1st Quarter";
		}elseif ($qtr == 'optGoods2nd') {
			$qtrCond = "(PR_Month >= 4 AND PR_Month <= 6)";
			$qtrDisp = "2nd Quarter";
		}elseif ($qtr == 'optGoods3rd') {
			$qtrCond = "(PR_Month >= 7 AND PR_Month <= 9)";
			$qtrDisp = "3rd Quarter";
		}elseif ($qtr == 'optGoods4th') {
			$qtrCond = "(PR_Month >= 10 AND PR_Month <= 12)";
			$qtrDisp = "4th Quarter";
		}

		$sql = "SELECT * FROM vouchercurrent where ".$qtrCond." AND PR_CategoryCode = '".$category."' AND Office = '".$office."' AND TrackingType = 'PR' GROUP BY TrackingNumber ORDER BY DateModified DESC";
		$record = $database->query($sql);

		$sql = "SELECT * FROM ppmpcategories WHERE Code = '".$category."' LIMIT 1";
		$record1 = $database->query($sql);
		$data = $database->fetch_array($record1);
		$catName = $data['Description'];


		if($database->num_rows($record) > 0) {

			$remarks = "Note: You already have tracking number for this quarter. Please review the tracking number.";
			if($database->num_rows($record) > 1) {
				$remarks = "Note: You already have tracking numbers for this quarter. Please review the tracking numbers.";
			}

			$row = 0;
			$sheet = "	
						<table border='0' style='border-spacing:0px; width:95%; font-family:NOR; font-size:14px; margin:0px auto;'>
							<thead>
								<tr>
									<th colspan='6' style='text-align:left; font-weight:normal; font-size:14px; color:rgb(230, 94, 132); font-weight:bold;'>
										".$remarks."
									</th>
								</tr>
								<tr>
									<th colspan='6' style='text-align:left; font-weight:normal; font-size:14px;'>
										<span style=''>".$qtrDisp."</span>
									</th>
								</tr>
								<tr>
									<th colspan='6' style='text-align:left; font-weight:normal; font-size:14px;'>
										<span style=''>".$category."&nbsp;-&nbsp;".$catName."</span>
									</th>
								</tr>
								<tr>
									<th colspan='6' style='padding:2px 0px;'></th>
								</tr>
								<tr style='background-color:rgba(121,137,141,1);'>
									<th style='color:white; border-top:1px solid silver; border-bottom:1px solid black; border-left:1px solid silver;'></th>
									<th style='color:white; text-align:left; padding:0px 5px; border-top:1px solid silver; border-bottom:1px solid black;'>TN</th>
									<th style='color:white; text-align:left; padding:0px 5px; border-top:1px solid silver; border-bottom:1px solid black;'>Status</th>
									<th style='color:white; text-align:left; padding:0px 5px; border-top:1px solid silver; border-bottom:1px solid black;'>Encoded</th>
									<th style='color:white; text-align:left; padding:0px 5px; border-top:1px solid silver; border-bottom:1px solid black; white-space:nowrap;'>Last Updated</th>
									<th style='color:white; text-align:right; padding:0px 5px; border-top:1px solid silver; border-bottom:1px solid black; border-right:1px solid silver;'>Amount</th>
								</tr>
								<tr>
									<th colspan='6' style='padding:1px 0px; border-bottom:1px solid silver;'></th>
								</tr>
							</thead>";
			while ($data = $database->fetch_array($record)) {
				$trackingNumber = $data['TrackingNumber'];
				// $supplier = $data['TrackingNumber'];
				$status = $data['Status'];

				$amount = $data['Amount'];
				if($data['TotalAmountMultiple'] > 0) {
					$amount = $data['TotalAmountMultiple'];
				}

				$dateEncoded = $data['DateEncoded'];
				$dateModified = $data['DateModified'];


				$clr = "rgba(207,209,187,1)";
				if($row%2 > 0) {
					$clr = "rgba(207,209,187,.7)";
				}

				$sheet .= "	<tr>
								<td style='border:1px solid silver; border-top:0px; text-align:center; width:0px; font-size:11px; padding:0px 5px;'>".++$row."</td>
								<td style='border:1px solid silver; border-left:0px; border-top:0px; text-align:left; padding:2px 5px; font-weight:bold; cursor:pointer;' onclick='clickToSearchTNNew(this)'>".$trackingNumber."</td>
								<td style='border:1px solid silver; border-left:0px; border-top:0px; text-align:left; padding:2px 5px; width:0px; white-space:nowrap;'>".$status."</td>
								<td style='border:1px solid silver; border-left:0px; border-top:0px; text-align:left; padding:2px 5px; width:0px; white-space:nowrap;'>".$dateEncoded."</td>
								<td style='border:1px solid silver; border-left:0px; border-top:0px; text-align:left; padding:2px 5px; width:0px; white-space:nowrap;'>".$dateModified."</td>
								<td style='border:1px solid silver; border-left:0px; border-top:0px; text-align:right; padding:2px 5px; width:0px;'>".number_format($amount, 2)."</td>
								</tr>";
				
				$totalTracked += floatval($amount);
				
			}
			$sheet .= "	<tr>
							<td style=''></td>
							<td style=''></td>
							<td style=''></td>
							<td style=''></td>
							<td style=''></td>
							<td style='text-align:right; padding:2px 5px; font-weight:bold; color:red;' id='goodsTrackedTotal'>".number_format($totalTracked, 2)."</td>
						</tr>";
			$sheet .= "	</table>";

			echo $sheet;
		}
	}

	if(isset($_GET['getDetailsByPORelease'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$sql = "SELECT TrackingNumber, Claimant, PR_TrackingNumber, PO_Number, PR_Number, OBR_Number, Fund, ChargeType, PR_Month, PR_CategoryCode, NatureOfPayment, Specifics, ModeOfProcurement, PaymentTerm, ProjectId
				FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		
		if($database->num_rows($record) >= 1){
			$newRecord = [];
			$data = $database->fetch_array($record);
			$newRecord['TrackingNumber'] = $data['TrackingNumber'];
			$newRecord['Claimant'] = $data['Claimant'];
			$newRecord['PR_TrackingNumber'] = $data['PR_TrackingNumber'];
			$newRecord['PO_Number'] = $data['PO_Number'];
			$newRecord['PR_Number'] = $data['PR_Number'];
			$newRecord['OBR_Number'] = $data['OBR_Number'];
			$newRecord['Fund'] = $data['Fund'];
			$newRecord['ChargeType'] = $data['ChargeType'];
			$newRecord['PR_Month'] = $data['PR_Month'];
			$newRecord['PR_CategoryCode'] = $data['PR_CategoryCode'];
			$newRecord['NatureOfPayment'] = $data['NatureOfPayment'];
			$newRecord['Specifics'] = $data['Specifics'];
			$newRecord['DisaId'] = $data['ProjectId'];

			$modOfProcList = [	'','Competitive Bidding','Shopping','Shopping 52.1.b','Alternative','Agency to Agency','Negotiated','Negotiated Procurement 53.9(SVP)',
								'Negotiated Procurement 53.1(TFB)','Negotiated Procurement 53.6(MS)','Negotiated Procurement 53.7','Negotiated Procurement 53.2(E.C.)',
								'Postal Office','Direct Contracting','Repeat Order','Two Failed Biddings(TFB)','Extension of Contract Appx. 21 Sec. 3.31',
								'Renewal of Contract Based on Appendix 21 3.3.1.3','Agency to Agency (DBM)','Lease of Real Property Sec 5.10'];
			
			$newRecord['ModeOfProcurement'] = $modOfProcList[$data['ModeOfProcurement']];

			$newRecord['WithRetention'] = $database->CheckWithRetention($trackingNumber, $newRecord['NatureOfPayment'], $data['ModeOfProcurement'], $data['Specifics']);

			if($data['PaymentTerm'] == 1){
				$newRecord['PaymentTerm'] = 'After full delivery';
			}elseif($data['PaymentTerm'] == 2) {
				// $newRecord['PaymentTerm'] = 'Multiple';
				$newRecord['PaymentTerm'] = 'Per Statement';
			}elseif($data['PaymentTerm'] == 3) {
				$newRecord['PaymentTerm'] = 'Cash on Delivery';
			}elseif($data['PaymentTerm'] == 4) {
				$newRecord['PaymentTerm'] = 'Complete Delivery';
			}

			$sql = "SELECT * FROM ppmpcategories WHERE Code = '".$newRecord['PR_CategoryCode']."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			if($database->num_rows($record) > 0) {
				$newRecord['PR_CategoryName'] = $data['Description'];
			}else {
				$newRecord['PR_CategoryName'] = "";
			}

			if(strlen(trim($newRecord['DisaId'])) == 0) {
				$newRecord['DisaId'] = 0;
			}

			$newRecord['DisaName'] = "";
			if($newRecord['DisaId'] > 0) {
				$sql = "SELECT * FROM disasterprojects WHERE Id = '".$newRecord['DisaId']."' LIMIT 1";
				$record = $database->query($sql);
				$data = $database->fetch_array($record);
				$newRecord['DisaName'] = $data['Name'];
	
				unset($data);
			}

			


			// $sql = "SELECT * FROM supplier.supplierinfo WHERE Name = \"". utf8_encode($newRecord['Claimant']) ."\" OR Alias = \"". utf8_encode($newRecord['Claimant']) ."\" LIMIT 1";
			// $sql = "SELECT * FROM supplier.supplierinfo WHERE Name = \"". $newRecord['Claimant'] ."\" OR Alias = \"". $newRecord['Claimant'] ."\" LIMIT 1";
			// $sql = "SELECT * FROM supplier.supplierinfo WHERE Name = \"". utf8_decode($newRecord['Claimant']) ."\" OR Alias = \"". utf8_decode($newRecord['Claimant']) ."\" LIMIT 1";
			$sql = "SELECT * FROM supplier.supplierinfo WHERE Name = \"". $newRecord['Claimant'] ."\" OR Alias = \"". $newRecord['Claimant'] ."\" LIMIT 1";
			$record = $database->query($sql);
			if($database->num_rows($record) > 0) {
				$data = $database->fetch_array($record);
				$newRecord['SuppClassification'] = $data['Classification'];
				$newRecord['SuppType'] = $data['Type'];
				$newRecord['SuppTIN'] = $data['TIN'];
				$newRecord['SuppCode'] = $data['Code'];
			}else {
				$newRecord['SuppClassification'] = "";
				$newRecord['SuppType'] = "";
				$newRecord['SuppTIN'] = "";
				$newRecord['SuppCode'] = "";
			}


			$suppType = "VAT";
			if($newRecord['SuppType'] == 'NV') {
				$suppType = "NON-VAT";
			}

			$nature = $newRecord['NatureOfPayment'];
			if($nature == 'Goods') {
				$nature = 'Goods/Items';
			}

			$thisSpecifics = $newRecord['Specifics'];
			if($thisSpecifics == 'Combi') {
				$thisSpecifics = 'General';
			}

			if($thisSpecifics == 'Gasoline') {
				$thisSpecifics = 'General';
			}

			if($thisSpecifics == 'With Retention') {
				$thisSpecifics = 'General';
			}

			if($thisSpecifics == 'Without Retention') {
				$thisSpecifics = 'General';
			}

			if($thisSpecifics == 'Agricultural Products Without Retention') {
				$thisSpecifics = 'Agricultural Products';
			}
			
			// $sql = "SELECT * FROM supplier.taxtable 
			// 		WHERE 
			// 		Nature = '".$nature."' 
			// 		AND Specifics = '".$newRecord['Specifics']."' 
			// 		AND TaxType = '".$suppType."' 
			// 		AND Classification = '".$newRecord['SuppClassification']."' 
			// 		AND (Form = 'Expanded' OR Form = 'GMP')";

			if($newRecord['ModeOfProcurement'] != 'Agency to Agency' && $newRecord['ModeOfProcurement'] != 'Postal Office' && $newRecord['ModeOfProcurement'] != 'Agency to Agency (DBM)') {

				$sql = "SELECT * FROM supplier.taxtable 
						WHERE 
						Nature = '".$nature."' 
						AND Specifics = '".$thisSpecifics."' 
						AND TaxType = '".$suppType."' 
						AND Classification = '".$newRecord['SuppClassification']."' 
						AND (Form = 'Expanded' OR Form = 'GMP')";
				$record = $database->query($sql);

				while ($data = $database->fetch_array($record)) {
					$form = $data['Form'];
					$tax = $data['TaxPercentage'];
					$taxCode = $data['TaxCode'];
					$atc = $data['ATC'];

					if(!isset($newRecord[$form])) {
						$newRecord[$form] = $tax."~".$taxCode."~".$atc;
					}

				}

			}else {
				$newRecord['NoTax'] = 1;
			}

			$sheet1 = $sheet->goodsPOGenDetailsForPX($newRecord);

			// $sql = "SELECT TrackingNumber, Claimant, Amount, PO_Amount, TotalAmountMultiple, DateEncoded, DateModified, Status, checknumber, checkdate FROM vouchercurrent WHERE TrackingPartner = '".$trackingNumber."' GROUP BY TrackingNumber ORDER BY DateModified DESC";
			$sql = "SELECT TrackingNumber, Claimant, Amount, PO_Amount, TotalAmountMultiple, DateEncoded, DateModified, Status, checknumber, checkdate 
					FROM vouchercurrent WHERE TrackingPartner = '".$trackingNumber."' AND Status NOT IN ('Cancelled','Cancelled Check')
					GROUP BY TrackingNumber ORDER BY DateModified DESC";
			$record = $database->query($sql);
			$sheet2 = $sheet->goodsListOfPXsThisPO($record);

			$sql = "SELECT * FROM porecord WHERE TrackingNumber = '".$trackingNumber."'";
			$record = $database->query($sql);
			$sheet3 = $sheet->CreatePXItems($record, $newRecord['Specifics'], $newRecord['ModeOfProcurement']);

			$thisSpecifics = $newRecord['Specifics'];
			if($thisSpecifics == 'Combi') {
				$thisSpecifics = 'Agricultural products & other Goods/Items';
			}

			unset($modOfProcList);
			unset($newRecord);

			echo $sheet1.$sheet2.$sheet3;

		}else{
			echo 0;
		}
		
	}

	if(isset($_GET['editNature'])) {
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$nature = $database->charEncoder($_GET['nature']);
		$specifics = $database->charEncoder($_GET['specifics']);

		if($specifics == 'Agricultural products & other Goods/Items') {
			$specifics = 'Combi';
		}

		$sql = "UPDATE vouchercurrent SET NatureOfPayment = '".$nature."', Specifics = '".$specifics."' WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		$database->EditLogs($trackingNumber,'NatureOfPayment','Undetermined',$nature,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
		$database->EditLogs($trackingNumber,'Specifics','Undetermined',$specifics,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);


		echo $trackingNumber;
	}

	if(isset($_POST['saveTrackingPostPX'])) {

		$trackType = $database->charEncoder($_POST["trackType"]);
		$poTrackingNumber = $database->charEncoder($_POST["poTrackingNumber"]);
		$poNumber = $database->charEncoder($_POST["poNumber"]);
		$obrNumber = $database->charEncoder($_POST["obrNumber"]);
		$supplier = $database->charEncoder(utf8_decode($_POST["supplier"]));
		$disaProject = $database->charEncoder($_POST["disaster"]);

		$poMonth = $database->charEncoder($_POST["poMonth"]);
		$poMonthNum = 0;
		if($poMonth == "1st Quarter"){
			$poMonthNum = 1;
		}else if($poMonth == "2nd Quarter"){
			$poMonthNum = 4;
		}else if($poMonth == "3rd Quarter"){
			$poMonthNum = 7;
		}else{
			$poMonthNum = 10;
		}

		$fund = $database->charEncoder($_POST["fund"]);
		$grp = $database->charEncoder($_POST["grp"]);
		$poData = $database->charEncoder($_POST["poData"]);
		$oTotal = $database->charEncoder($_POST["oTotal"]);
		$taxes = $database->charEncoder($_POST["taxes"]);
		$totalLDAll = $database->charEncoder($_POST["totalLD"]);
		$ret = $database->charEncoder($_POST["ret"]);
		$category = $database->charEncoder($_POST["category"]);
		$net = $database->charEncoder($_POST["net"]);
		$tin = $database->charEncoder($_POST["tin"]);
		$nature = $database->charEncoder($_POST["nature"]);
		$specifics = $database->charEncoder($_POST["specifics"]);
		$recType = $database->charEncoder($_POST["recType"]);
		$busType = $database->charEncoder($_POST["busType"]);
		$baseAmnt = $database->charEncoder($_POST["baseAmnt"]);
		$pxTotal = $database->charEncoder($_POST["pxTotal"]);

		$accntNumber = $database->charEncoder($_POST["acctNumber"]);
		if(strlen(trim($accntNumber)) > 0) {
			$accntNumber = "'".$accntNumber."'";
		}else {
			$accntNumber = "NULL";
		}

		$gasPeriod = $database->charEncoder($_POST["gasPeriod"]);
		if(strlen(trim($gasPeriod)) > 0) {
			$gasPeriod = "'".$gasPeriod."'";
		}else {
			$gasPeriod = "NULL";
		}

		$aType = $database->charEncoder($_POST["aType"]);
		$aDesc = $database->charEncoder($_POST["aDesc"]);
		$aAmnt = floatval($database->charEncoder($_POST["aAmnt"]));

		if(strlen(trim($aType)) == 0) {
			$aType = '';
			$aDesc = '';
			$aAmnt = 0.00;
		}

		$status = 'Encoded';
		$claimType = "Check";
		$docType = "Payment";	
		$updateCase = "Doctrack = Doctrack + 1";
		
		//update id
		$case= "Update office set " . $updateCase .  "  where code = '" . $office . "'";
		$database->UpdateInsertSpecial($case);
		
		$case ="Select Doctrack from office where code = '" . $office . "' limit 1";
		$record = $database->FetchThis($case);
		$data = $database->fetch_array($record);
		$trackingNumber =  $office . '-' . $data['Doctrack'];
		$newTrackingNumber =  $office . '-' . ($data['Doctrack']+1); 

		$catX = 0;
		$cat = '';
		
		$progX = 0;
		$pro = '';
		
		$codeX = 0;
		$cod = '';

		$totalJustLD = 0;
		$inPXRecord = "";
		$pxRows = explode('~#~', $poData);
		for ($i=0; $i < sizeof($pxRows); $i++) { 
			$pxData = explode('~!~', $pxRows[$i]);
			$category = $pxData[0];
			$progCode = $database->charEncoder(urldecode($pxData[1]));
			$acctCode = $database->charEncoder(urldecode($pxData[2]));
			$desc = $database->charEncoder($pxData[3]);
			$qty = $pxData[4];
			// $unit = urldecode($pxData[5]);
			$unit = $database->charEncoder( urldecode($pxData[5]) );
			$cost = $pxData[6];
			$total = $qty * $cost;	
			$itemDes = $database->charEncoder(urldecode($pxData[7]));
			$days = $pxData[8];
			$ld = $pxData[9];
			$totalLD = $pxData[10];
			$agriChecked = $pxData[11];

			// identify  charge type 1-5
			if($cat != $category){
				$catX++;
				$cat = $category;
			}
			if($pro != $progCode){
				$progX++;
				$pro = $progCode;
			}
			
			if($cod != $acctCode){
				$codeX++;
				$cod = $acctCode;
			}

			$totalJustLD += floatval($ld);

			$inPXRecord .= ",('".$trackingNumber."','".$category."','".$progCode."','".$acctCode."','".$unit."','".$itemDes."','".$desc."','".$qty."','".$cost."','".$total."','".$days."','".$ld."','".$totalLD."','".$agriChecked."')";
		}

		$sql = "INSERT INTO pxrecord (TrackingNumber, Category, ProgramCode, Code, Unit, Item, Description, Qty, Amount, Total, Days, LiquidatedDamages, TotalLD, AgriChecked) VALUES ".substr($inPXRecord, 1);
		$database->query($sql);

		$chargeType = 0;
		if($catX == 1){
			if($progX == 1){
				if($codeX == 1){
					$chargeType = 1;
					$oTotal = 0;
				}else{
					$chargeType = 2;
				}
				
			}else if ($progX > 1){
				$chargeType = 3;
			}
		}else if ($catX == 2){
			$chargeType = 4;
		}


		$insertThis = '';
		$splitGRPdata =  explode("~#~",$grp);
		for($i = 0; $i < sizeof($splitGRPdata)-1;$i++ ){
			$grpData = explode("~!~", $splitGRPdata[$i]);
			$category = urldecode($grpData[0]);
			$program = urldecode($grpData[1]);
			$code = urldecode($grpData[2]);
			$total = urldecode($grpData[3]);

			$insertThis .= ",('" . $defaultYear . "','" . $office . "','" . $fund ."' ,'" . $trackType . "','" .  $poMonthNum . "','" .
									$trackingNumber . "','" . $category . "','" . $program . "','" .  $code  . "'," . $total . "," .  $oTotal . ",'" .  
									$employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "'," . $chargeType . ",'" . $dateEncoded . "','" . $docType  ."','" .
									$poNumber . "','" . $obrNumber . "','" . $poTrackingNumber . "','" . $supplier . "','" . $claimType . "','" . $net . "'," . $gasPeriod . "," . $disaProject . ")";		

		}

		$insertGRPdetails =  substr($insertThis,1,strlen($insertThis));
		$case = "INSERT INTO vouchercurrent (Year,Office,Fund,TrackingType,PR_Month,TrackingNumber,PR_CategoryCode,PR_ProgramCode,PR_AccountCode,Amount
											,TotalAmountMultiple,EncodedBy,DateEncoded,Status,ChargeType,DateModified,DocumentType,PO_Number,OBR_Number
											,TrackingPartner,Claimant,ClaimType,NetAmount,PeriodMonth,ProjectId
											)
											VALUES " . $insertGRPdetails ; 
		$database->query($case);


		$adjDesc = "null";
		if(strlen(trim($aDesc)) > 0) {
			$adjDesc = "'".$aDesc."'";
		}

		$adjType = "null";
		if(strlen(trim($aType)) > 0) {
			$adjType = "'".$aType."'";
		}


		$taxes = $database->charEncoder($_POST["taxes"]);
		$taxList = explode('*j*', $taxes);
		$vouchersIn = "";
		for ($i=0; $i < sizeof($taxList); $i++) { 

			$arr = explode('~', $taxList[$i]);
			$type = $arr[0];

			$typeIn = 'GMP';
			if($type == 'EXP') {
				$typeIn = 'Expanded';
			}elseif($type == 'NAN') {
				$typeIn = 'NAN';
			}

			$taxPer = $arr[1] * 100;
			$amount = $arr[2];
			$taxCode = $arr[3];
			$atc = $arr[4];
			$indiSpecifics = $arr[5];
			$indiBaseAmount = $arr[6];
			$indiAmount = $arr[7];

			$entryType = "Auto";
			if($indiSpecifics == 'Agricultural Products') {
				$entryType = "Manual";
			}


			$vouchersIn .= ",('".$defaultYear."','".$fund."','".$trackingNumber."','".$tin."','".$supplier."','".$nature."','".$indiSpecifics."','".$recType."','".$typeIn."','".$taxCode."','".$atc."',
							'".$indiAmount."','".$indiBaseAmount."','".$taxPer."','".$amount."','".$totalJustLD."','".$ret."','".$net."','".$employeeNumber."','".$entryType."', ".$adjDesc.", ".$adjType.",'".$aAmnt."')";
		}

		$sql = "INSERT INTO `pxvouchertax`
				(`Year`,`Fund`,`TrackingNumber`,`TIN`,`Supplier`,`NatureOfPayment`,`Specifics`,`ReceiptType`,`CodeType`,`TaxCode`,`ATC`,`Amount`,`BaseAmount`,`Percentage`
				,`PercentageAmount`,`LiquidatedDamages`,`Retention`,`NetAmount`,`EncodedBy`,`Entry`,`AdjustmentLabel`,`AdjustmentType`,`AdjustmentAmount`)
				VALUES ".substr($vouchersIn, 1);
		$database->query($sql);

		$sql = "INSERT INTO particulars (TrackingNumber, AccountNumber) VALUES ('".$trackingNumber."', ".$accntNumber.")";
		$database->query($sql);

		$case = "Insert into voucherhistory(TrackingNumber,ModifiedBy,DateModified,Status)values ('" . $trackingNumber . "'," . $employeeNumber . ",'" . $dateEncoded . "','" . $status . "')"; 
		//insert to history
		$affected = $database->UpdateInsertSpecial($case);

		echo $newTrackingNumber."~".$trackingNumber;
	}

	if(isset($_GET['pxEdit'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$trackingNumberPO = $database->charEncoder($_GET['poTrackingNumber']);
		$type = substr($trackingNumber,0,2);
		$newRecord = [];

		$sql = "SELECT Year, Fund, Claimant, NatureOfPayment, Specifics, PO_Amount, TotalAmountMultiple, ModeOfProcurement, PR_CategoryCode FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumberPO."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$newRecord['TrackingNumber'] = $trackingNumber;
		$newRecord['PO_TrackingNumber'] = $trackingNumberPO;
		$newRecord['Year'] = $data['Year'];
		$newRecord['Fund'] = $data['Fund'];
		$newRecord['Supplier'] = $data['Claimant'];
		$newRecord['NatureOfPayment'] = $data['NatureOfPayment'];
		$newRecord['Specifics'] = $data['Specifics'];
		$newRecord['ModeOfProcurement'] = $data['ModeOfProcurement'];
		$newRecord['PR_CategoryCode'] = $data['PR_CategoryCode'];

		// $newRecord['WithRetention'] = $database->CheckWithRetention($trackingNumber, $newRecord['NatureOfPayment'], $data['ModeOfProcurement']);
		$newRecord['WithRetention'] = $database->CheckWithRetention($trackingNumberPO, $newRecord['NatureOfPayment'], $data['ModeOfProcurement'], $data['Specifics']);

		$newRecord['Amount'] = $data['PO_Amount'];
		if($data['TotalAmountMultiple'] > 0) {
			$newRecord['Amount'] = $data['TotalAmountMultiple'];
		}

		unset($record);

		// $sql = "SELECT * FROM supplier.supplierinfo WHERE Name = '".$newRecord['Supplier']."' LIMIT 1";
		// $sql = "SELECT * FROM supplier.supplierinfo WHERE Name = \"". utf8_encode($newRecord['Supplier']) ."\" OR Alias = \"". utf8_encode($newRecord['Supplier']) ."\" LIMIT 1";
		$sql = "SELECT * FROM supplier.supplierinfo WHERE Name = \"". $newRecord['Supplier'] ."\" OR Alias = \"". $newRecord['Supplier'] ."\" LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$newRecord['SuppClassification'] = $data['Classification'];
		$newRecord['SuppType'] = $data['Type'];
		$newRecord['SuppTIN'] = $data['TIN'];
		$newRecord['SuppCode'] = $data['Code'];

		$suppType = "VAT";
		if($newRecord['SuppType'] == 'NV') {
			$suppType = "NON-VAT";
		}
		$newRecord['SuppType'] = $suppType;

		unset($record);

		// $sql = "SELECT * FROM supplier.taxtable 
		// 		WHERE 
		// 		Nature = '".$newRecord['NatureOfPayment']."' 
		// 		AND Specifics = '".$newRecord['Specifics']."' 
		// 		AND TaxType = '".$suppType."' 
		// 		AND Classification = '".$newRecord['SuppClassification']."' 
		// 		AND (Form = 'Expanded' OR Form = 'GMP')";
				
		$thisSpecifics = $newRecord['Specifics'];
		if($thisSpecifics == 'Combi') {
			$thisSpecifics = 'General';
		}

		if($thisSpecifics == 'Gasoline') {
			$thisSpecifics = 'General';
		}

		if($thisSpecifics == 'With Retention') {
			$thisSpecifics = 'General';
		}

		if($thisSpecifics == 'Without Retention') {
			$thisSpecifics = 'General';
		}

		if($thisSpecifics == 'Agricultural Products Without Retention') {
			$thisSpecifics = 'Agricultural Products';
		}

		if($newRecord['ModeOfProcurement'] != 5 && $newRecord['ModeOfProcurement'] != 12 && $newRecord['ModeOfProcurement'] != 18) {

			$sql = "SELECT * FROM supplier.taxtable 
					WHERE 
					Nature = '".$newRecord['NatureOfPayment']."' 
					AND Specifics = '".$thisSpecifics."' 
					AND TaxType = '".$suppType."' 
					AND Classification = '".$newRecord['SuppClassification']."' 
					AND (Form = 'Expanded' OR Form = 'GMP')";

			$record = $database->query($sql);

			while ($data = $database->fetch_array($record)) {
				$form = $data['Form'];
				$tax = $data['TaxPercentage'];
				$taxCode = $data['TaxCode'];
				$atc = $data['ATC'];

				if(!isset($newRecord[$form])) {
					$newRecord[$form] = $tax."~".$taxCode."~".$atc;
				}

			}

		}else {
			$newRecord['NoTax'] = 1;
		}
		

		unset($record);

		$sql = "SELECT AdjustmentLabel, AdjustmentType, AdjustmentAmount FROM pxvouchertax WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$newRecord['AdjustmentLabel'] = $data['AdjustmentLabel'];
		$newRecord['AdjustmentType'] = $data['AdjustmentType'];
		$newRecord['AdjustmentAmount'] = $data['AdjustmentAmount'];

		unset($record);

		$sheet2 = $sheet->CreatePXTaxAndDeductionsDetails($newRecord);


		$sql = "SELECT Item FROM pxrecord WHERE TrackingNumber = '".$trackingNumber."'";
		$record = $database->query($sql);

		$itemList = [];
		while ($data = $database->fetch_array($record)) {
			$item = $data['Item'];
			if(!in_array($item, $itemList)) {
				array_push($itemList, $item);
			}
		}

		unset($record);

		$sql = "SELECT * FROM pxrecord WHERE TrackingNumber = '".$trackingNumber."' ORDER BY Id ASC";
		// $sql = "SELECT * FROM porecord WHERE TrackingNumber = '".$trackingNumberPO."'";
		$record =  $database->FetchThis($sql);
		$sheet1 = $sheet->CreatePXItemsEdit($record, $newRecord, $itemList);

		unset($record);

		// $sql = "SELECT TrackingNumber, Claimant, Amount, PO_Amount, TotalAmountMultiple, DateEncoded, DateModified, Status, checknumber, checkdate FROM vouchercurrent WHERE TrackingPartner = '".$trackingNumberPO."' GROUP BY TrackingNumber ORDER BY DateModified DESC";
		$sql = "SELECT TrackingNumber, Claimant, Amount, PO_Amount, TotalAmountMultiple, DateEncoded, DateModified, Status, checknumber, checkdate 
				FROM vouchercurrent WHERE TrackingPartner = '".$trackingNumberPO."' AND Status NOT IN ('Cancelled','Cancelled Check')
				GROUP BY TrackingNumber ORDER BY DateModified DESC";
		$record = $database->query($sql);
		$sheet0 = $sheet->goodsListOfPXsThisPOInEdit($record, $trackingNumber);

		$sheet3 = "	<div style='text-align:center; padding-top:20px;'>
						<div style='width:60px;font-size:16px;display:inline-block;margin-right:10px;' class  = 'button1' onclick='cancelEditPR(this)' id='editPR".$trackingNumber."' >Cancel</div>
						<div style='width:60px; font-size:16px; display:inline-block;' class='button1' id='updatePX".$trackingNumber."' onclick='updatePX(this)'>Update</div>
					</div>";
		echo $sheet0.$sheet1.$sheet2.$sheet3.'*j*';

	}

	if(isset($_POST['updateTrackingPostPX'])) {

		$trackingNumber = $database->charEncoder($_POST['trackingNumber']);
		$tnYear = $database->charEncoder($_POST['tnYear']);
		$fund = $database->charEncoder($_POST['fund']);

		// $supplier = $database->charEncoder($_POST['supplier']);
		$supplier = $database->charEncoder(utf8_decode($_POST['supplier']));

		$nature = $database->charEncoder($_POST['nature']);
		$specifics = $database->charEncoder($_POST['specifics']);
		$classification = $database->charEncoder($_POST['classification']);
		$recType = $database->charEncoder($_POST['recType']);
		$tin = $database->charEncoder($_POST['tin']);
		$suppCode = $database->charEncoder($_POST['suppCode']);
		$grp = $database->charEncoder($_POST['grp']);
		$pxData = $database->charEncoder($_POST['poData']);
		$oTotal = $database->charEncoder($_POST['oTotal']);
		$taxes = $database->charEncoder($_POST['taxes']);
		$totalLDAll = $database->charEncoder($_POST['totalLD']);
		$ret = $database->charEncoder($_POST['ret']);

		$aType = $database->charEncoder($_POST['aType']);
		$aDesc = $database->charEncoder($_POST['aDesc']);
		$aAmnt = $database->charEncoder($_POST['aAmnt']);

		$aType = $database->charEncoder($_POST["aType"]);
		$aDesc = $database->charEncoder($_POST["aDesc"]);
		$aAmnt = floatval($database->charEncoder($_POST["aAmnt"]));
		if(strlen(trim($aType)) == 0) {
			$aType = '';
			$aDesc = '';
			$aAmnt = 0.00;
		}

		$adjDesc = "null";
		if(strlen(trim($aDesc)) > 0) {
			$adjDesc = "'".$aDesc."'";
		}

		$adjType = "null";
		if(strlen(trim($aType)) > 0) {
			$adjType = "'".$aType."'";
		}

		$baseAmnt = $database->charEncoder($_POST['baseAmnt']);
		$net = $database->charEncoder($_POST['net']);
		$category = $database->charEncoder($_POST['category']);
		$db = $database->getDB($tnYear);

		// $sql = "SELECT CONCAT(
		// 			'SELECT `',
		// 			GROUP_CONCAT(COLUMN_NAME ORDER BY `ORDINAL_POSITION` SEPARATOR '`,`'),
		// 			'` FROM `',
		// 			`TABLE_SCHEMA`,
		// 			'`.`',
		// 			TABLE_NAME,
		// 			'`'
		// 		) as part1Qry
		// 		FROM INFORMATION_SCHEMA.COLUMNS
		// 		WHERE `TABLE_SCHEMA` = '".$db."'
		// 			AND `TABLE_NAME` = 'vouchercurrent'
		// 			AND `COLUMN_NAME` NOT IN ('Id', 'PO_Amount', 'PR_ProgramCode', 'PR_AccountCode', 'TotalAmountMultiple');";
		// $record = $database->query($sql);
		// $data = $database->fetch_array($record);

		$sql = "SELECT `COLUMN_NAME` 
				FROM `INFORMATION_SCHEMA`.`COLUMNS` 
				WHERE `TABLE_SCHEMA`='".$db."' 
				AND `TABLE_NAME`='vouchercurrent'
				AND `COLUMN_NAME` NOT IN ('Id', 'Amount', 'PR_ProgramCode', 'PR_AccountCode', 'TotalAmountMultiple', 'NetAmount');";
		$record = $database->query($sql);

		$part1Qry = '';
		while ($data = $database->fetch_array($record)) {
			$part1Qry .= ",`".$data['COLUMN_NAME']."`";
		}

		// $sql = $data['part1Qry'] . " WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$sql = "SELECT ".substr($part1Qry, 1)." FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$columns = array_keys($data);

		$newRecord = [];
		$sqlCols = "";
		$sqlVal1 = "";
		for ($i=0; $i < sizeof($columns); $i++) { 
			if(!is_numeric($columns[$i])) {
				$newRecord[$columns[$i]] = $data[$columns[$i]];
				$sqlCols .= ",`".$columns[$i]."`";

				// if(strlen( trim($data[$columns[$i]]) ) > 0) {
				// 	$sqlVal1 .= ",'".$data[$columns[$i]]."'";
				// }else {
				// 	$sqlVal1 .= ",NULL";
				// }

				// if(strlen( trim($data[$columns[$i]]) ) > 0) {
				// 	$sqlVal1 .= ',"'.$data[$columns[$i]].'"';
				// }else {
				// 	$sqlVal1 .= ",NULL";
				// }

				if(strlen( trim($data[$columns[$i]]) ) > 0) {

					$vals = $data[$columns[$i]];
					if($columns[$i] == 'Remarks') {
						$vals = $database->charEncoder($data[$columns[$i]]);
					}

					$sqlVal1 .= ',"'.$vals.'"';
				}else {
					$sqlVal1 .= ",NULL";
				}
				
			}
		}

		unset($data);
		unset($columns);

		$sqlCols = substr($sqlCols, 1).",`PR_ProgramCode`,`PR_AccountCode`,`Amount`,`TotalAmountMultiple`,`NetAmount`";
		$sqlVal1 = substr($sqlVal1, 1);

		
		$insertThis = '';
		$splitGRPdata =  explode("~#~",$grp);
		for($i = 0; $i < sizeof($splitGRPdata)-1;$i++ ){
			$grpData = explode("~!~", $splitGRPdata[$i]);
			$program = urldecode($grpData[0]);
			$code = urldecode($grpData[1]);
			$total = urldecode($grpData[2]);
			
			// $insertThis .= ",(".$sqlVal1.",'".$program."','".$code."','".$total."','".$oTotal."','".$net."')";	
			$insertThis .= ',('.$sqlVal1.', "'.$program.'", "'.$code.'", "'.$total.'", "'.$oTotal.'", "'.$net.'")';			

		}
		unset($splitGRPdata);
		unset($grpData);

		$vcSql = "INSERT INTO vouchercurrent (".$sqlCols.") VALUES ".substr($insertThis, 1);

		$totalJustLD = 0;
		$insertPXRecord = "";
		$splitPXData = explode('~#~', $pxData);
		for($i = 0; $i < sizeof($splitPXData); $i++){
			$data = explode("~!~", $splitPXData[$i]);

			$program = $data[0];
			$actCode = $data[1];
			$desc = $data[2];
			$qty = $data[3];
			$unit = $data[4];
			$cost = $data[5];
			$itemId = $data[6];
			$days = $data[7];
			$ld = $data[8];
			$totalLD = $data[9];	
			$totalPX = $cost * $qty;
			$agriChecked = $data[10];	
			
			$totalJustLD += floatval($ld);

			$insertPXRecord .= ",('".$trackingNumber."','".$category."','".$program."','".$actCode."','".$unit."','".$itemId."','".$desc."','".$qty."','".$cost."','".$totalPX."','".$days."','".$ld."','".$totalLD."','".$agriChecked."')";
		}

		$pxSql = "INSERT INTO pxrecord (TrackingNumber, Category, ProgramCode, Code, Unit, Item, Description, Qty, Amount, Total, Days, LiquidatedDamages, TotalLD, AgriChecked) VALUES ".substr($insertPXRecord, 1);

		$taxes = $database->charEncoder($_POST["taxes"]);
		$taxList = explode('*j*', $taxes);
		$vouchersIn = "";
		for ($i=0; $i < sizeof($taxList); $i++) { 

			$arr = explode('~', $taxList[$i]);
			$type = $arr[0];

			$typeIn = 'GMP';
			if($type == 'EXP') {
				$typeIn = 'Expanded';
			}elseif($type == 'NAN') {
				$typeIn = 'NAN';
			}

			$taxPer = $arr[1] * 100;
			$amount = $arr[2];
			$taxCode = $arr[3];
			$atc = $arr[4];
			$indiSpecifics = $arr[5];
			$indiBaseAmount = $arr[6];
			$indiAmount = $arr[7];

			// $supplier = $database->charEncoder($supplier);

			$entryType = "Auto";
			if($indiSpecifics == 'Agricultural Products') {
				$entryType = "Manual";
			}

			$vouchersIn .= ",('".$tnYear."','".$fund."','".$trackingNumber."','".$tin."','".$supplier."','".$nature."','".$indiSpecifics."','".$recType."','".$typeIn."','".$taxCode."','".$atc."',
							'".$indiAmount."','".$indiBaseAmount."','".$taxPer."','".$amount."','".$totalJustLD."','".$ret."','".$net."','".$employeeNumber."','".$entryType."', ".$adjDesc.", ".$adjType.",'".$aAmnt."')";
		}

		$taxSql = "INSERT INTO `pxvouchertax`
				(`Year`,`Fund`,`TrackingNumber`,`TIN`,`Supplier`,`NatureOfPayment`,`Specifics`,`ReceiptType`,`CodeType`,`TaxCode`,`ATC`,`Amount`,`BaseAmount`,`Percentage`
				,`PercentageAmount`,`LiquidatedDamages`,`Retention`,`NetAmount`,`EncodedBy`,`Entry`,`AdjustmentLabel`,`AdjustmentType`,`AdjustmentAmount`)
				VALUES ".substr($vouchersIn, 1);

		$sql = "DELETE FROM pxrecord WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);
		$database->query($pxSql);

		$sql = "DELETE FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);
		$database->query($vcSql);

		$sql = "DELETE FROM pxvouchertax WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);
		$database->query($taxSql);

		// $record = $database->searchTrackingNumber2022($trackingNumber);
		// if(sizeof($record) > 0) {
		// 	echo $sheet->CreateDoctrackInfoPR($record);
		// }else{
		// 	echo "<span class = 'remark1'>No record found.</span>";
		// }

		$database->EditLogs($trackingNumber,'PX',"Undetermined","Undetermined",$_SESSION['officeCode'],$_SESSION['fullName'],$today);	


		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PO"){
				// echo $sheet->CreateDoctrackInfoPR($record);
				echo $sheet->NewCreateDoctrackInfoPO($record);
			}elseif($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}

	if(isset($_GET['loadSupplierAddNewPO'])){
		$sql = "SELECT * FROM supplier.supplierinfo WHERE LENGTH(Type) > 0 ORDER BY name ASC";
		$record = $database->query($sql);
		// $sheet = '<div style = "font-family:NOR;font-size:26px;letter-spacing:1px;margin-left:15px;background-color:rgb(227, 239, 242);padding-left:10px;border-bottom:1px solid grey;">Select Supplier</div>';
		// $sheet .= '<div  style = "height:500px;overflow-x:hidden; overflow-y:auto;font-family:Oswald;width:500px; "><ol >';
		// $i =0;
		// while($data = $database->fetch_array($record)){
		// 	$name = utf8_encode($data['Name']);
		// 	$alias = utf8_encode($data['Alias']);

		// 	$dispName = $name;
		// 	if(strlen(trim($alias)) > 0) {
		// 		$dispName = $alias;
		// 	}

		// 	$sheet .= "<li style = 'color:rgb(0, 164, 201);font-weight:bold; font-size:12px;'> <option class = 'hoverSupplier'  style = 'color:black;padding-left:5px; font-family:NOR;'  onclick = 'clickSupplierGoodsPO(this)'>" . $dispName . "</option></li>";
		// }
		// $sheet .= '</ol></div>';

		$sheet = "";
		$options = "";

		while($data = $database->fetch_array($record)){
			$name = utf8_encode($data['Name']);
			$alias = utf8_encode($data['Alias']);

			$dispName = $name;
			if(strlen(trim($alias)) > 0) {
				$dispName = $alias;
			}

			$options .= "	<li style='color:rgb(0, 164, 201); font-weight:bold; font-size:12px;'>
								<option class='hoverSupplier' style='color:black; padding-left:5px; font-family:NOR;'  onclick='clickSupplierGoodsPO(this)'>".$dispName."</option>
							</li>";
		}

		
		$sheet .= "	<table border='0' cellpadding='0' style='border-spacing:0px; font-family:NOR; font-size:26px; border-collapse:collapse;'>
						<tr style='background-color:rgb(227, 239, 242); border-bottom:1px solid grey;'>
							<td style='width:0px; white-space:nowrap; padding-left:10px;'>Select Supplier</td>
							<td style='font-size:0px; text-align:right; padding:8px 8px;'>
								<span style='font-size:14px;'>Search Key</span>
								<input style='margin-left:10px; font-size:18px; width:150px; font-family:NOR; text-align:center; padding:2px 8px;' onkeyup='shortSrchSupplier(this)'>
							</td>
						</tr>
						<tr>
							<td colspan='2' style='padding:0px;'>
								<div style='height:500px; overflow-x:hidden; overflow-y:auto; font-family:Oswald; width:500px;'>
									<ol style='padding:0px; padding-left:35px; margin:0px;' id='supplierSelList'>".$options."</ol>
								</div>
							</td>
						</tr>
					</table>";

		echo $sheet;
		
	}

	if(isset($_GET['loadSupplierAddNewPOInEdit'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$oldValue = $database->charEncoder(utf8_decode($_GET['oldValue']));

		$sql = "SELECT * FROM supplier.supplierinfo WHERE LENGTH(Type) > 0 ORDER BY name ASC";
		$record = $database->query($sql);
		// $sheet = '<div style = "font-family:NOR;font-size:26px;letter-spacing:1px;margin-left:15px;background-color:rgb(227, 239, 242);padding-left:10px;border-bottom:1px solid grey;">Select Supplier</div>';
		// $sheet .= '<div  style = "height:500px;overflow-x:hidden; overflow-y:auto;font-family:Oswald;width:500px; ">
		// 				<input type="hidden" id="poSupTN" value="'.$trackingNumber.'">
		// 				<input type="hidden" id="poSupOld" value="'.$oldValue.'">
		// 				<ol>';
		// $i =0;
		// while($data = $database->fetch_array($record)){
		// 	$name = utf8_encode($data['Name']);
		// 	$alias = utf8_encode($data['Alias']);

		// 	$dispName = $name;
		// 	if(strlen(trim($alias)) > 0) {
		// 		$dispName = $alias;
		// 	}

		// 	$sheet .= "		<li style = 'color:rgb(0, 164, 201);font-weight:bold; font-size:12px;'> <option class = 'hoverSupplier'  style = 'color:black;padding-left:5px; font-family:NOR;'  onclick = 'clickSupplierGoodsPOInEdit(this)'>" . $dispName . "</option></li>";
		// }
		// $sheet .= '		</ol>
		// 			</div>';

		// echo $sheet;

		$sheet = "";
		$options = "";

		while($data = $database->fetch_array($record)){
			$name = utf8_encode($data['Name']);
			$alias = utf8_encode($data['Alias']);

			$dispName = $name;
			if(strlen(trim($alias)) > 0) {
				$dispName = $alias;
			}

			$options .= "	<li style='color:rgb(0, 164, 201);font-weight:bold; font-size:12px;'>
								<option class = 'hoverSupplier'  style = 'color:black;padding-left:5px; font-family:NOR;'  onclick = 'clickSupplierGoodsPOInEdit(this)'>" . $dispName . "</option>
							</li>";
		}

		
		$sheet .= "	<table border='0' cellpadding='0' style='border-spacing:0px; font-family:NOR; font-size:26px; border-collapse:collapse;'>
						<tr style='background-color:rgb(227, 239, 242); border-bottom:1px solid grey;'>
							<td style='width:0px; white-space:nowrap; padding-left:10px;'>Select Supplier</td>
							<td style='font-size:0px; text-align:right; padding:8px 8px;'>
								<span style='font-size:14px;'>Search Key</span>
								<input style='margin-left:10px; font-size:18px; width:150px; font-family:NOR; text-align:center; padding:2px 8px;' onkeyup='shortSrchSupplier(this)'>
							</td>
						</tr>
						<tr>
							<td colspan='2' style='padding:0px;'>
								<input type='hidden' id='poSupTN' value='".$trackingNumber."'>
								<input type='hidden' id='poSupOld' value='".$oldValue."'>
								<div style='height:500px; overflow-x:hidden; overflow-y:auto; font-family:Oswald; width:500px;'>
									<ol style='padding:0px; padding-left:35px; margin:0px;' id='supplierSelList'>".$options."</ol>
								</div>
							</td>
						</tr>
					</table>";

		echo $sheet;
	}

	if(isset($_GET['loadPPMPCategoryListNewPR'])){
		
		$qtr = $database->charEncoder($_GET['qtr']);
		if($qtr == "optGoods1st"){
			$sql = "SELECT a.Category, count(a.Id) as Count,b.Description FROM ppmpmain a left join ppmpcategories b on a.Category = b.Code 
					where 
					   OfficeCode = '" . $office . "' and Jan > 0   or
					  OfficeCode = '" . $office . "' and Feb > 0   or
				     	  OfficeCode = '" . $office . "' and Mar > 0    group by Category";
		}else if($qtr == "optGoods2nd"){
			$sql = "SELECT a.Category, count(a.Id) as Count,b.Description FROM ppmpmain a left join ppmpcategories b on a.Category = b.Code 
					where 
					   OfficeCode = '" . $office . "' and Apr > 0   or
					  OfficeCode = '" . $office . "' and May > 0   or
				     	  OfficeCode = '" . $office . "' and Jun > 0    group by Category";
		}else if($qtr == "optGoods3rd"){
			$sql = "SELECT a.Category, count(a.Id) as Count,b.Description FROM ppmpmain a left join ppmpcategories b on a.Category = b.Code 
					where 
					   OfficeCode = '" . $office . "' and Jul > 0   or
					  OfficeCode = '" . $office . "' and Aug > 0   or
				     	  OfficeCode = '" . $office . "' and Sep > 0    group by Category";
		}else if($qtr == "optGoods4th"){
			$sql = "SELECT a.Category, count(a.Id) as Count,b.Description FROM ppmpmain a left join ppmpcategories b on a.Category = b.Code 
					where 
					   OfficeCode = '" . $office . "' and Oct > 0   or
					   OfficeCode = '" . $office . "' and Nov > 0   or
				     	   OfficeCode = '" . $office . "' and Dex > 0    group by Category";
		}
		$record = $database->query($sql);
		echo $sheet->CreateCategoryListNewPr($record);
	}

	if(isset($_GET['GetCategoryItems2023'])){
		$category = $database->charEncoder($_GET['category']);
		$qtr = $database->charEncoder($_GET['qtr']);
		if($qtr == "optGoods1st"){
			$sql = "SELECT Fund,ProgramCode,Cost,AccountCode,Item,Category ,(IFNULL(Jan, 0) + IFNULL(Feb, 0) + IFNULL(Mar, 0))  as Qty,  Total as Amount, Unit, Description,ItemNo  FROM ppmpmain 
					where 
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Jan > 0   or
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Feb > 0   or
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Mar > 0 order by description asc";

		}else if($qtr == "optGoods2nd"){
			$sql = "SELECT  Fund,ProgramCode,Cost,AccountCode,Item,Category, (IFNULL(Apr, 0) + IFNULL(May, 0) + IFNULL(Jun, 0))  as Qty, Total as Amount, Unit, Description,ItemNo FROM ppmpmain 
					where 
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Apr > 0   or
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and May > 0   or
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Jun > 0 order by description asc";
		}else if($qtr == "optGoods3rd"){
			$sql = "SELECT  Fund,ProgramCode,Cost,AccountCode,Item,Category, (IFNULL(Jul, 0) + IFNULL(Aug, 0) + IFNULL(Sep, 0))  as Qty, Total as Amount, Unit, Description,ItemNo FROM ppmpmain 
					where 
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Jul > 0   or
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Aug > 0   or
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Sep > 0 order by description asc";
		}else if($qtr == "optGoods4th"){
			$sql = "SELECT  Fund,ProgramCode,Cost,AccountCode,Item,Category,(IFNULL(Oct, 0) + IFNULL(Nov, 0) + IFNULL(Dex, 0))  as Qty, Total as Amount, Unit, Description,ItemNo FROM ppmpmain  
					where 
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Oct > 0   or
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Nov > 0   or
					OfficeCode = '" . $office . "' and Category = '" . $category . "' and Dex > 0 order by description,ItemNo  asc";
		}
		// $record = $database->SelectQuery($sql);
		// echo $sheet->CreateCategoryItems2023($record);

		$record = $database->query($sql);

		$disaProjs = '';
		$sql1 = "SELECT Id, Name FROM disasterprojects WHERE Office = '".$office."'";
		$record1 = $database->query($sql1);
		if($database->num_rows($record1) > 0) {
			$disaProjs = '<option></option>';
			$disaProjs .= '<option value="0">Regular Procurement</option>';
			while($data1 = $database->fetch_array($record1)) {
				$projectId = $data1['Id'];
				$projectName = $data1['Name'];
				$disaProjs .= '<option value="'.$projectId.'">'.$projectName.'</option>';
			}
		}

		echo $sheet->CreateCategoryItemsNew($record) .'*j*'. $sheet->CreateTermsNConditionsSheet('newPR', '') .'*j*'. $sheet->CreateHeaderNewSheet('newPR', '').'*j*'.$disaProjs;
		
	}

	if(isset($_POST['saveTrackingPostGoods'])){
		$trackType = $database->charEncoder($_POST['trackType']);
		$prMonth = $database->charEncoder($_POST['prMonth']);
		$terms = $database->charEncoder($_POST['terms']);
		$header = $database->charEncoder($_POST['header']);
		$projectIdDisa = $database->charEncoder($_POST['disaster']);
		
		$prData =  $_POST['prData'];
		
		$grp =  $database->charEncoder($_POST['grp']);
		$oTotal =  $database->charEncoder($_POST['oTotal']);
		if($oTotal > 50000){
			$mode = 1;
		}else{
			$mode = 2;
		}
		$status = 'Encoded';
	    	$updateCase = "PR = PR + 1";
		//update id
		$database->IncrementTrackingSeries($updateCase,$office);
		
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("PR",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = "PR-" . $office . '-' . $data['PR'];
		$newTrackingNumber = "PR-" . $office . '-' . ($data['PR']+1); 
	
		
		$catX = 0;
		$cat = '';
		
		$progX = 0;
		$pro = '';
		
		$codeX = 0;
		$cod = '';
		
		$insertThis = '';
		$splitPRdata =  explode("~#~",$prData);
		for($i = 0; $i < sizeof($splitPRdata)-1;$i++ ){
			$prData = explode("~!~", $splitPRdata[$i]);
			$category = $prData[0];
			$program = $database->charEncoder(urldecode($prData[1]));
			$code = $database->charEncoder(urldecode($prData[2]));
			
			$desc = $database->charEncoder($prData[3]);
			//$desc = $prData[3];
			
			$qty = $prData[4];
			$unit =$database->charEncoder(urldecode($prData[5]));
			$cost = $prData[6];
			$item = $database->charEncoder(urldecode($prData[7]));
			$total = $qty * $cost;	
			// identify  charge type 1-5
			if($cat != $category){
				$catX++;
				$cat = $category;
			}
			if($pro != $program){
				$progX++;
				$pro = $program;
			}
			if($cod != $code){
				$codeX++;
				$cod = $code;
			}
			$insertThis .= ",('" . $trackingNumber . "','" . $category . "','" . $program . "','" . $code . "','" . $desc ."'," . $qty . ",'" .  ucfirst($unit) . "','" . $cost . "','" . $total . "','" . $item . "')";		
		}
		$chargeType = 0;
		if($catX == 1){
			if($progX == 1){
				if($codeX == 1){
					$chargeType = 1;
					$oTotal = 0;
				}else{
					$chargeType = 2;
				}
				
			}else if ($progX > 1){
				$chargeType = 3;
			}
		}else if ($catX == 2){
			$chargeType = 4;
		}
	
		$insertPRdetails =  substr($insertThis,1,strlen($insertThis));
			
		
		$case = "Insert into prrecord(TrackingNumber,Category,ProgramCode,Code,Description,Qty,Unit,Amount,Total,Item)values " . $insertPRdetails ; 
		//insert to prrecord
		$affected = $database->UpdateInsertSpecial($case);
		//insert to particulars
		// $sql = "Insert into particulars (trackingnumber)values ('" . $trackingNumber  . "')";
		if(strlen(trim($terms)) == 0) {
			$terms = "NULL";
		}else {
			$terms = "'".$terms."'";
		}

		if(strlen(trim($header)) == 0) {
			$header = "NULL";
		}else {
			$header = "'".$header."'";
		}
		$sql = "Insert into particulars (trackingnumber, Terms, Header)values ('" . $trackingNumber  . "', ".$terms.", ".$header.")";
		$database->query($sql);
		
		$insertThis = '';
		$fund = $_POST['fund'];
		/*if($office == "LSBD"){
			$fund = "SEF";
		}else{
			$fund = "GENERAL FUND";
		}*/
		
		$splitGRPdata =  explode("~#~",$grp);
		for($i = 0; $i < sizeof($splitGRPdata)-1;$i++ ){
			$grpData = explode("~!~", $splitGRPdata[$i]);
			$category = urldecode($grpData[0]);
			$program = urldecode($grpData[1]);
			$code = urldecode($grpData[2]);
			$total = urldecode($grpData[3]);
			
			// $insertThis .= ",('" . $defaultYear . "','" . $office . "','" . $fund ."' ,'" . $trackType . "','" .  $prMonth . "','" .
			// 	                       $trackingNumber . "','" . $category . "','" . $program . "','" .  $code  . "'," . $total . "," .  $oTotal . ",'" .  
			// 			 	 $employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "'," . $chargeType . ",'" . $dateEncoded . "', " . $mode . ")";
			
			$insertThis .= ",('" . $defaultYear . "','" . $office . "','" . $fund ."' ,'" . $trackType . "','" .  $prMonth . "','" .
								$trackingNumber . "','" . $category . "','" . $program . "','" .  $code  . "'," . $total . "," .  $oTotal . ",'" .  
								$employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "'," . $chargeType . ",'" . $dateEncoded . "', " . $mode . ", '" . $projectIdDisa . "')";
		}
		$insertGRPdetails =  substr($insertThis,1,strlen($insertThis));
		$case = "Insert into vouchercurrent(Year,Office,Fund,TrackingType,PR_Month,TrackingNumber,PR_CategoryCode,PR_ProgramCode,PR_AccountCode,Amount,TotalAmountMultiple,EncodedBy,DateEncoded,Status,ChargeType,DateModified,ModeOfProcurement,ProjectId)values " . $insertGRPdetails ; 
		//insert to current
		$affected = $database->UpdateInsertSpecial($case);
		$case = "Insert into voucherhistory(TrackingNumber,ModifiedBy,DateModified,Status)values ('" . $trackingNumber . "'," . $employeeNumber . ",'" . $dateEncoded . "','" . $status . "')"; 
		//insert to history
		$affected = $database->UpdateInsertSpecial($case);
		echo $newTrackingNumber . '~' . $trackingNumber;
	}
	
	if(isset($_POST['saveTrackingPostPOGoods'])){
		
		$trackType = $database->charEncoder($_POST['trackType']);
		$prTrackingNumber = $database->charEncoder($_POST['prTrackingNumber']);
		$prNumber =  $database->charEncoder($_POST['prNumber']);
		$obrNumber =  $database->charEncoder($_POST['obrNumber']);
		$supplier = $database->charEncoder(utf8_decode($_POST['supplier']));
		$fund =  $database->charEncoder($_POST['fund']);
		$prMonth = $database->charEncoder($_POST['prMonth']);
		$nature = $database->charEncoder($_POST['nature']);
		$specifics = $database->charEncoder($_POST['specifics']);

		$modeOfProc = $database->charEncoder($_POST['modeOfProc']);
		$pyTerm = $database->charEncoder($_POST['pyTerm']);
		$terms = $database->charEncoder($_POST['terms']);
		$header = $database->charEncoder($_POST['header']);

		$disaster = $database->charEncoder($_POST['disaster']);

		if($specifics == 'Agricultural products & other Goods/Items') {
			$specifics = 'Combi';
		}
		
		$prData =  $_POST['prData'];
		$grp =  $database->charEncoder($_POST['grp']);
		$oTotal =  $database->charEncoder($_POST['oTotal']);
		
		$status = 'Encoded';
		$claimType = "Check";
	    $docType = "Payment";	
		$updateCase = "Doctrack = Doctrack + 1";
		
	    	
		//update id
		$case= "Update office set " . $updateCase .  "  where code = '" . $office . "'";
		$database->UpdateInsertSpecial($case);
		
		$case ="Select Doctrack from office where code = '" . $office . "' limit 1";
		$record = $database->FetchThis($case);
		$data = $database->fetch_array($record);
		$trackingNumber =  $office . '-' . $data['Doctrack'];
		$newTrackingNumber =  $office . '-' . ($data['Doctrack']+1); 
	
		$catX = 0;
		$cat = '';
		
		$progX = 0;
		$pro = '';
		
		$codeX = 0;
		$cod = '';
		
		$insertThis = '';
		$splitPRdata =  explode("~#~",$prData);
		for($i = 0; $i < sizeof($splitPRdata)-1;$i++ ){
			$prData = explode("~!~", $splitPRdata[$i]);
			$category = $prData[0];
			$program = $database->charEncoder(urldecode($prData[1]));
			$code = $database->charEncoder(urldecode($prData[2]));
			//$desc = $database->charEncoder(urldecode($prData[3]));
			$desc = $database->charEncoder($prData[3]);
			$qty = $prData[4];
			$unit = urldecode($prData[5]);
			$cost = $prData[6];
			$itemDes = $database->charEncoder(urldecode($prData[7]));
			$total = $qty * $cost;	
			// identify  charge type 1-5
			if($cat != $category){
				$catX++;
				$cat = $category;
			}
			if($pro != $program){
				$progX++;
				$pro = $program;
			}
			
			if($cod != $code){
				$codeX++;
				$cod = $code;
			}
			$insertThis .= ",('" . $trackingNumber . "','" . $category . "','" . $program . "','" . $code . "','" . $desc ."'," . $qty . ",'" . $unit . "','" . $cost . "','" . $total . "','" . $itemDes . "')";		
		}
		$chargeType = 0;
		if($catX == 1){
			if($progX == 1){
				if($codeX == 1){
					$chargeType = 1;
					$oTotal = 0;
				}else{
					$chargeType = 2;
				}
				
			}else if ($progX > 1){
				$chargeType = 3;
			}
		}else if ($catX == 2){
			$chargeType = 4;
		}
		$insertPRdetails =  substr($insertThis,1,strlen($insertThis));
		$case = "Insert into porecord(TrackingNumber,Category,ProgramCode,Code,Description,Qty,Unit,Amount,Total,Item)values " . $insertPRdetails ; 
		//insert to prrecord
		$affected = $database->UpdateInsertSpecial($case);


		$insertThis = '';
	
		//$fund = "GENERAL FUND";
		$splitGRPdata =  explode("~#~",$grp);
		for($i = 0; $i < sizeof($splitGRPdata)-1;$i++ ){
			$grpData = explode("~!~", $splitGRPdata[$i]);
			$category = urldecode($grpData[0]);
			$program = urldecode($grpData[1]);
			$code = urldecode($grpData[2]);
			$total = urldecode($grpData[3]);
			
			$insertThis .= ",('" . $defaultYear . "','" . $office . "','" . $fund ."' ,'" . $trackType . "','" .  $prMonth . "','" .
				                       $trackingNumber . "','" . $category . "','" . $program . "','" .  $code  . "'," . $total . "," .  $oTotal . ",'" .  
						 	  $employeeNumber . "','" .  $dateEncoded . "','" .  $status .  "'," . $chargeType . ",'" . $dateEncoded . "','" . $docType  ."','" .$prNumber . "','" . $obrNumber . "','" . $prTrackingNumber . "','" . $supplier . "','" . $claimType . "','" . $nature . "','" . $specifics . "', '".$modeOfProc."', '".$pyTerm."', '".$disaster."')";		
	


		}
		$insertGRPdetails =  substr($insertThis,1,strlen($insertThis));
		$case = "Insert into vouchercurrent(Year,Office,Fund,TrackingType,PR_Month,TrackingNumber,
											PR_CategoryCode,PR_ProgramCode,PR_AccountCode,
											PO_Amount,TotalAmountMultiple,EncodedBy,
											DateEncoded,Status,ChargeType,DateModified,DocumentType,PR_Number,OBR_Number,PR_TrackingNumber,Claimant, ClaimType, NatureOfPayment, Specifics, ModeOfProcurement, PaymentTerm, ProjectId)
											values " . $insertGRPdetails ; 
		//insert to current
		$affected = $database->UpdateInsertSpecial($case);




		if(strlen(trim($terms)) == 0) {
			$terms = "NULL";
		}else {
			$terms = "'".$terms."'";
		}

		if(strlen(trim($header)) == 0) {
			$header = "NULL";
		}else {
			$header = "'".$header."'";
		}

		// $sql = "Insert into particulars (TrackingNumber)values ('".$trackingNumber."')";
		$sql = "Insert into particulars (TrackingNumber, Terms, Header)values ('".$trackingNumber."', ".$terms.", ".$header.")";
		$database->query($sql);
		
		$case = "Insert into voucherhistory(TrackingNumber,ModifiedBy,DateModified,Status)values ('" . $trackingNumber . "'," . $employeeNumber . ",'" . $dateEncoded . "','" . $status . "')"; 
		//insert to history
		$affected = $database->UpdateInsertSpecial($case);
		
		echo $newTrackingNumber . '~' . $trackingNumber;
		
	}

	if(isset($_GET['SelectPrReleasedGoods'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$sql = "SELECT TrackingNumber, PR_Number, OBR_Number, Fund, ChargeType, PR_Month, PR_CategoryCode, ProjectId FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		
		if($database->num_rows($record) >= 1){
			$newRecord = [];
			$data = $database->fetch_array($record);
			$newRecord['TrackingNumber'] = $data['TrackingNumber'];
			$newRecord['PR_Number'] = $data['PR_Number'];
			$newRecord['OBR_Number'] = $data['OBR_Number'];
			$newRecord['Fund'] = $data['Fund'];
			$newRecord['ChargeType'] = $data['ChargeType'];
			$newRecord['PR_Month'] = $data['PR_Month'];
			$newRecord['PR_CategoryCode'] = $data['PR_CategoryCode'];
			$newRecord['DisaId'] = $data['ProjectId'];

			$sql = "SELECT * FROM ppmpcategories WHERE Code = '".$newRecord['PR_CategoryCode']."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			if($database->num_rows($record) > 0) {
				$newRecord['PR_CategoryName'] = $data['Description'];
			}else {
				$newRecord['PR_CategoryName'] = "";
			}

			unset($data);

			$newRecord['DisaName'] = "";

			if($newRecord['DisaId'] > 0) {
				$sql = "SELECT * FROM disasterprojects WHERE Id = '".$newRecord['DisaId']."' LIMIT 1";
				$record = $database->query($sql);
				$data = $database->fetch_array($record);
				$newRecord['DisaName'] = $data['Name'];
	
				unset($data);
			}

			$sheet1 = $sheet->goodsPRGenDetailsForPO($newRecord);

			// $sql = "SELECT TrackingNumber, Claimant, PO_Amount, TotalAmountMultiple, DateEncoded, DateModified, Status FROM vouchercurrent WHERE PR_TrackingNumber = '".$trackingNumber."' GROUP BY TrackingNumber ORDER BY DateModified DESC";
			$sql = "SELECT TrackingNumber, Claimant, PO_Amount, TotalAmountMultiple, DateEncoded, DateModified, Status FROM vouchercurrent WHERE PR_TrackingNumber = '".$trackingNumber."' AND Status != 'Cancelled' GROUP BY TrackingNumber ORDER BY DateModified DESC";
			$record = $database->query($sql);
			$sheet2 = $sheet->goodsListOfPOsThisPR($record);

			$sql = "SELECT * FROM prrecord WHERE TrackingNumber = '".$trackingNumber."'";
			$record = $database->query($sql);
			$sheet3 = $sheet->CreatePOItemsNew($record);

			$sql = "SELECT Header, Terms FROM particulars WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
			$record1 = $database->query($sql);
			$data = $database->fetch_array($record1);
			$terms = $data['Terms'];
			$header = $data['Header'];
			$sheet4 = $sheet->CreateTermsNConditionsSheet('newPO', $terms);
			$sheet5 = $sheet->CreateHeaderNewSheet('newPO', $header);

			echo $sheet1."*j*".$sheet2.$sheet3."*j*".$sheet4."*j*".$sheet5;

			unset($newRecord);
		}else{
			echo 0;
		}
		
	}

	if(isset($_GET['pxAddItemFromPO'])) {
		$poTrackingNumber = $database->charEncoder($_GET['poTN']);

		$sql = "SELECT * FROM porecord WHERE TrackingNumber = '".$poTrackingNumber."'";
		$record = $database->query($sql);
		echo $sheet->CreatePOItemsListForPXEdit($record);
	}

	if(isset($_GET['transferToTaxifier'])) {
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		$sql = "SELECT * FROM supplier.vouchers WHERE year = '".$defaultYear."' AND TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);

		if($database->num_rows($record) == 0) {

			$sql = "SELECT Claimant FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$supplier = utf8_encode($data['Claimant']);

			$sql = "SELECT Name, Alias FROM supplier.supplierinfo WHERE Name = \"". $supplier ."\" OR Alias = \"". $supplier ."\" LIMIT 1";
			$record = $database->query($sql);
			$data = $database->fetch_array($record);
			$realSupplierName = $data['Name'];

			$sql = "SELECT * FROM pxvouchertax WHERE TrackingNumber = '".$trackingNumber."'";
			$record = $database->query($sql);

			// $fields = [	'Year','Fund','TrackingNumber','TIN','Supplier','NatureOfPayment','Specifics','ReceiptType',
			// 			'CodeType','TaxCode','ATC','Amount','BaseAmount','Percentage','PercentageAmount','LiquidatedDamages',
			// 			'Retention','NetAmount','EncodedBy','DateTag','Remarks','Entry','CheckNumber','CheckDate','RemitYear',
			// 			'RemitMonth','ADF','Respo','RemitSet','BankAccount','AdjustmentLabel','AdjustmentType','AdjustmentAmount'];

			$fields = [	'Year','Fund','TrackingNumber','TIN','Supplier','NatureOfPayment','Specifics','ReceiptType',
						'CodeType','TaxCode','ATC','Amount','BaseAmount','Percentage','PercentageAmount','LiquidatedDamages',
						'Retention','NetAmount','EncodedBy','Entry','AdjustmentLabel','AdjustmentType','AdjustmentAmount','DateTag'];

			$numFields = sizeof($fields);
			$insertStr = '';

			while ($data = $database->fetch_array($record)) {
				$insertStr .= ",(";
				$vals = "";

				for ($i=0; $i < $numFields; $i++) { 

					if(strlen(trim($data[$fields[$i]])) > 0) {

						if($fields[$i] == 'Supplier') {
							$vals .= ",'".$realSupplierName."'";
						}else {
							$vals .= ",'".$data[$fields[$i]]."'";
						}

					}else {
						// $vals .= ",NULL";
						if($fields[$i] == 'DateTag') {
							$vals .= ",'".$dateEncoded."'";
						}else {
							$vals .= ",NULL";
						}
					}

				}

				$insertStr .= substr($vals, 1).")";
			}
			
			$sql = "INSERT INTO supplier.vouchers (`".implode("`,`", $fields)."`) VALUES ".substr($insertStr, 1);
			$database->query($sql);

			unset($fields);

			echo $trackingNumber;
		}else {
			echo 1;
		}
		
	}

	if(isset($_GET['editPOSupplier'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$newSupplier = $database->charEncoder(utf8_decode($_GET['supplier']));
		$oldSupplier = $database->charEncoder(utf8_decode($_GET['oldValue']));

		$sql = "SELECT PR_TrackingNumber FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$poTrackingNumber = $data['PR_TrackingNumber'];

		$sql = "SELECT Id FROM vouchercurrent WHERE PR_TrackingNumber = '".$poTrackingNumber."' AND Claimant = '".$newSupplier."' AND TrackingNumber != '".$trackingNumber."'";
		$record = $database->query($sql);
		$numRows = $database->num_rows($record);

		if($numRows > 0) {
			echo 0;
		}else {

			$sql = "UPDATE vouchercurrent SET Claimant = '".$newSupplier."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Claimant",$oldSupplier,$newSupplier,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);

			echo $trackingNumber;

		}


	}

	//---------------------------------------------------------------------------------------------------NEW PR PO GOODS AND SERVICES - END



	//---------------------------------------------------------------------------------------------------MANPOWER - START

	if(isset($_GET['editManpower'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$field = $database->charEncoder($_GET['field']);
		$oldValue = $database->charEncoder($_GET['old']);
		$sheet = "";

		$srch = "";
		$save = "";
		if($field == 'Project Programmer') {
			$srch = "Programmer";
		}elseif($field == 'Construction Inspector'){
			$srch = "Inspector";
		}elseif($field == 'Project Checker'){
			$srch = "Checker";
		}elseif($field == 'Project Surveyor'){
			$srch = "Surveyor";
		}elseif($field == 'Project Draftsman'){
			$srch = "Draftsman";
		}

		// $sql = "SELECT * FROM inframanpower WHERE Function LIKE '%".$srch."%' ORDER BY LastName ASC";
		$sql = "SELECT * FROM inframanpower WHERE Office = '8751' ORDER BY LastName ASC";
		$record = $database->query($sql);

		$sheet .= "	<div class='editorContainer'>
						<table class='editorTable' border='0' cellpadding='0' style=''>
							<tr>
								<td class = 'editorHeader' colspan = '2' style = 'text-align:left;' >Editor<div onclick ='closeAbsolute(this)' class = 'closeEditor'></div></td>
							</tr>
							<tr>
								<td style='width:0px; white-space:nowrap; font-weight:bold; padding:0px 5px 0px 20px;'>".$field."</td>
								<td style='padding:10px 20px 5px 0px;'>
									<input type='hidden' id='oldPerson' value='".$oldValue."'>
									<select class='select2' style='width:300px; font-family:Oswald; font-size:16px;' id='newPerson'>
										<option></option>";

		while ($data = $database->fetch_array($record)) {

			$midName = $data['MiddleName'];
			if(strlen(trim($midName)) > 0) {
				$midName = $data['MiddleName'][0].".";
			}

			$suffix = $data['Suffix'];
			if(strlen(trim($suffix)) > 0) {
				$suffix = ", ".$data['Suffix'];
			}
			
			// $fullName = $data['FirstName'].' '. $midName .' '.$data['LastName'].$suffix;
			$fullName = $data['LastName'].', '.$data['FirstName'].' '.$midName.$suffix;

			$selected = "";
			if(strtoupper($oldValue) == $fullName) {
				$selected = "selected";
			}

			// $sheet .= "<option ".$selected.">". $fullName."</option>";
			$sheet .= "<option ".$selected.">". utf8_encode($fullName)."</option>";

		}

		$sheet .= "					</select>
								</td>
							</tr>
							<tr>
								<td></td>
								<td style='padding:10px 20px 20px 0px; padding-right:20px;'>
									<div id='editor".$srch."*".$trackingNumber."' class='button1' onclick= 'goUpdateManpower(this)'>Save</div>
								</td>
							</tr>
						</table>
					</div>";

		echo $sheet;

	}

	if(isset($_GET['goUpdateManpower'])) {

		$field = $database->charEncoder($_GET['field']);
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$person = $database->charEncoder($_GET['person']);
		$oldPerson = $database->charEncoder($_GET['oldPerson']);


		if($field == 'Programmer') {

			$sql = "UPDATE infra SET Programmer = '".$person."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Infra Programmer",$oldPerson,$person,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);	

		}elseif($field == 'Inspector') {

			$sql = "UPDATE infra SET Inspector = '".$person."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Infra Inspector",$oldPerson,$person,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);	

		}elseif($field == 'Checker') {

			$sql = "UPDATE infra SET Checker = '".$person."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Infra Checker",$oldPerson,$person,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);	

		}elseif($field == 'Surveyor') {

			$sql = "UPDATE infra SET Surveyor = '".$person."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Infra Surveyor",$oldPerson,$person,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);	

		}elseif($field == 'Draftsman') {

			$sql = "UPDATE infra SET Draftsman = '".$person."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);
			$database->EditLogs($trackingNumber,"Infra Draftsman",$oldPerson,$person,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);	

		}

		echo $trackingNumber;
	}

	//---------------------------------------------------------------------------------------------------MANPOWER - END
	if(isset($_GET['getVouchersTime'])) {
		
		$sql = "select PeriodMonth,DocumentType,NumMonth,sum(Diff) / count(Id) as Total,count(Id) as Transaction from(
				select Id,PeriodMonth,DocumentType,NumMonth, 
				
				
					if(substring(DateModified,1,4) = substring(DateEncoded,1,4),
						 TIMESTAMPDIFF(DAY, substring(DateEncoded,1,10),substring(DateModified,1,10)) + 1 - 
						 (WEEK(substring(DateModified,1,10)) - WEEK(substring(DateEncoded,1,10))) * 2 - 
						 (CASE WHEN WEEKDAY(substring(DateEncoded,1,10)) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateEncoded,1,10)) = 5 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateModified,1,10)) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateModified,1,10)) = 5 THEN 1 ELSE 0 END)
					,
						TIMESTAMPDIFF(DAY, concat(substring(DateModified,1,4) ,'-01-01'),substring(DateModified,1,10)) + 1 -
						(WEEK(substring(DateModified,1,10)) - WEEK( concat(substring(DateModified,1,4) ,'-01-01') )) * 2 -
						 (CASE WHEN WEEKDAY(concat(substring(DateModified,1,4) ,'-01-01')) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(concat(substring(DateModified,1,4) ,'-01-01')) = 5 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateModified,1,10)) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateModified,1,10)) = 5 THEN 1 ELSE 0 END) 
						 +
						 TIMESTAMPDIFF(DAY, substring(DateEncoded,1,10), concat(substring(DateEncoded,1,4),'-12-31')) + 1 -
						 (WEEK(concat(substring(DateEncoded,1,4),'-12-31')) - WEEK(substring(DateEncoded,1,10))) * 2 - 
						 (CASE WHEN WEEKDAY(concat(substring(DateEncoded,1,4) ,'-12-31')) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(concat(substring(DateEncoded,1,4) ,'-12-31')) = 5 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateEncoded,1,10)) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateEncoded,1,10)) = 5 THEN 1 ELSE 0 END) 
					)
				 
				 as Diff
				
						from (
						SELECT Id,TrackingNumber,DocumentType,PeriodType,DateEncoded,PeriodMonth,DateModified, 
				        CASE
							When PeriodMonth = 'January' then 1
				            When PeriodMonth = 'February' then 2
				            When PeriodMonth = 'March' then 3
				            When PeriodMonth = 'April' then 4
				            When PeriodMonth = 'May' then 5
				            When PeriodMonth = 'June' then 6
				            When PeriodMonth = 'July' then 7
				            When PeriodMonth = 'August' then 8
				            When PeriodMonth = 'September' then 9
				            When PeriodMonth = 'October' then 10
				            When PeriodMonth = 'November' then 11
				            When PeriodMonth = 'December' then 12
				            
						end as NumMonth
				        FROM vouchercurrent where  
						PeriodType = 'Monthly' and Status = 'Check Released' group by PeriodMonth,TrackingNumber) as a
				) c group by DocumentType,PeriodMonth order by DocumentType,NumMonth asc";
		
		$record = $database->query($sql);
		$sheet->createVouchersTime($record);
		
	}
	if(isset($_GET['getTopList'])) {

			 
			 
		$sql = "select c.Name as Office,DocumentType,PeriodMonth,NumMonth,Transaction,AverageTime from (
				select *,sum(WorkingDays) / count(WorkingDays) as AverageTime, count(WorkingDays) as Transaction  from(
				SELECT Office,TrackingNumber,DocumentType,PeriodMonth, DateEncoded,DateModified,
                
                  if(substring(DateModified,1,4) = substring(DateEncoded,1,4),
						 TIMESTAMPDIFF(DAY, substring(DateEncoded,1,10),substring(DateModified,1,10)) + 1 - 
						 (WEEK(substring(DateModified,1,10)) - WEEK(substring(DateEncoded,1,10))) * 2 - 
						 (CASE WHEN WEEKDAY(substring(DateEncoded,1,10)) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateEncoded,1,10)) = 5 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateModified,1,10)) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateModified,1,10)) = 5 THEN 1 ELSE 0 END)
					,
						TIMESTAMPDIFF(DAY, concat(substring(DateModified,1,4) ,'-01-01'),substring(DateModified,1,10)) + 1 -
						(WEEK(substring(DateModified,1,10)) - WEEK( concat(substring(DateModified,1,4) ,'-01-01') )) * 2 -
						 (CASE WHEN WEEKDAY(concat(substring(DateModified,1,4) ,'-01-01')) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(concat(substring(DateModified,1,4) ,'-01-01')) = 5 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateModified,1,10)) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateModified,1,10)) = 5 THEN 1 ELSE 0 END) 
						 +
						 TIMESTAMPDIFF(DAY, substring(DateEncoded,1,10), concat(substring(DateEncoded,1,4),'-12-31')) + 1 -
						 (WEEK(concat(substring(DateEncoded,1,4),'-12-31')) - WEEK(substring(DateEncoded,1,10))) * 2 - 
						 (CASE WHEN WEEKDAY(concat(substring(DateEncoded,1,4) ,'-12-31')) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(concat(substring(DateEncoded,1,4) ,'-12-31')) = 5 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateEncoded,1,10)) = 6 THEN 1 ELSE 0 END) -
						 (CASE WHEN WEEKDAY(substring(DateEncoded,1,10)) = 5 THEN 1 ELSE 0 END) 
					)
				 
				 as WorkingDays,
                
				CASE
							When PeriodMonth = 'January' then 1
							When PeriodMonth = 'February' then 2
							When PeriodMonth = 'March' then 3
							When PeriodMonth = 'April' then 4
							When PeriodMonth = 'May' then 5
							When PeriodMonth = 'June' then 6
							When PeriodMonth = 'July' then 7
							When PeriodMonth = 'August' then 8
							When PeriodMonth = 'September' then 9
							When PeriodMonth = 'October' then 10
							When PeriodMonth = 'November' then 11
							When PeriodMonth = 'December' then 12
						end as NumMonth
				  FROM vouchercurrent 
				where  status = 'Check Released'
				group by trackingNumber) as a

				 group by Office,DocumentType,PeriodMonth  ) b left join office c on b.office = c.Code
			 
			 order by DocumentType,NumMonth,AverageTime asc";		 
		
		$record = $database->query($sql);
		$sheet->createTopList($record);
		
	}
	//---------------------------------------------------------------------------------------------------PARTICULARS EDIT PX - START

	if(isset($_GET['editParticularsForThisPX'])) {

		$trackingNumber = $database->charEncoder($_GET['tn']);
		$sheet = "";

		$newRecord = $database->searchTrackingNumber2022($trackingNumber);
		
		$categoryName =  $newRecord['CategoryName'];
		$officeName = $newRecord['OfficeName'];
		$poNumber = $newRecord['PO_Number'];

		$sql = "SELECT * FROM particulars WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);

		$explanation = $data['Particulars'];
		$invoiceNumber = (strlen(trim($data['InvoiceNumber'])) > 0 ? $data['InvoiceNumber'] : '_______');
		$invoiceDate = (strlen(trim($data['InvoiceDate'])) > 0 ? $data['InvoiceDate'] : '_______');
		$poDate = (strlen(trim($data['PoDate'])) > 0 ? $data['PoDate'] : '_______');

		if(strlen(trim($explanation)) == 0) {
			$explanation = "TO PAYMENT FOR ".$categoryName." OF THE ".$officeName." UNDER P.O# ".$poNumber." DATED ".$poDate." WITH INV# ".$invoiceNumber." DATED: ".$invoiceDate." AS PER SUPPORTING DOCUMENTS HERETO ATTACHED.";
		}

		$sheet .= "	<div class='editorContainer'>
						<table border='0' style='padding:20px; border-spacing:0px;'>
							<tr>
								<td class='editorHeader'>Edit Particulars</td>
								<td class='editorHeader'><div onclick='closeAbsolute(this)' id='pxPartCloser' class='closeEditor'></div></td>
							</tr>
							<tr>
								<td colspan='2' style='text-align:left; padding:10px 0px 10px 0px;'>
									<textarea id='updatedPXParticulars' style='font-family:mainFont; font-size:16px; min-width:500px; max-width:540px; min-height:120px; padding:10px 10px;'>".$explanation."</textarea>
								</td>
							</tr>
							<tr>
								<td colspan='2' style='padding-top:10px;'>
									<div id='editor".$trackingNumber."' class='button1 b1' style='width:70px; font-size:18px;' onclick='updatePXParticulars(this)'>Update</div>
								</td>
							</tr>
						</table>
					</table>";
		
		echo $sheet;

	}

	if(isset($_GET['updatePXParticulars'])) {

		$trackingNumber = $database->charEncoder($_GET['tn']);
		$particulars = $database->charEncoder($_GET['particulars']);

		$sql = "UPDATE particulars SET Particulars = '".$particulars."' WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		echo $trackingNumber;
		
	}

	//---------------------------------------------------------------------------------------------------PARTICULARS EDIT PX - END

	if(isset($_GET['editGasAccount'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$curAccount = $database->charEncoder($_GET['curAccount']);

		$sql = "SELECT * FROM gasaccounts ORDER BY Office ASC";
		$record = $database->query($sql);

		$options = "<option></option>";

		while ($data = $database->fetch_array($record)) {

			$acctNum = $data['AccountNumber'];
			$acctNem = $data['Office'];

			$selected = "";
			$oldAcctNum = "";
			if( addslashes($acctNem) == addslashes($curAccount) ) {
				$selected = "selected";
				$oldAcctNum = $acctNum;
			}

			$options .= "<option value='".$acctNum."' ".$selected.">".$acctNem."</option>";
			
		}

		$sheet = "	<div class='editorContainer'>
						<table class='editorTable' style='font-family:Oswald;'>
							<tr>
								<td class='editorHeader' colspan='2'>Editor<div onclick='closeAbsolute(this)' id='editCloser' class='closeEditor'></div></td>
							</tr>
							<tr>
								<td class='editorLabel' >Gas Account</td>
								<td style='padding:40px 40px 20px 0px;'>
									<select class='select2' id='newGasAccount' style='width:300px; font-family:Oswald; font-size:16px;'>".$options."</select>
								</td>
							</tr>
							<tr>
								<td colspan='2' style='padding-bottom:20px; text-align:center;'>
									<input type='hidden' id='hiddens' value='".$oldAcctNum."'>
									<div id='gasAcct".$trackingNumber."' class='button1 b1' onclick='goUpdateGas(this)'>Save</div>
								</td>
							</tr>
						</table>
					</div>";

		echo $sheet;

	}

	if(isset($_GET['goUpdateGas'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$newAccount = $database->charEncoder($_GET['newAccount']);
		$oldAccount = $database->charEncoder($_GET['oldAccount']);

		$sql = "UPDATE particulars SET AccountNumber = '".$newAccount."' WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		$database->EditLogs($trackingNumber,"Gas Account Number",$oldAccount,$newAccount,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);
		
		echo $trackingNumber;

	}
	
	if(isset($_GET['loadEngagement'])){
	    
	    $today = date('Y-m-d');
	  	$sql = "select concat(b.lastName,', ',b.firstname)as Name,sum(Count) as Counter  from
				(            
				SELECT Activity,UpdatedBy as ModifiedBy, count(Id) as Count FROM supplier.logs 
				where substring(dateupdated,1,10) =  '" . $today . "'  group by Activity,Updatedby
				union
				SELECT Status,ModifiedBy, Count(Id) as Count FROM voucherhistory 
				where substring(datemodified,1,10) =  '" . $today . "' and Status != 'Encoded' group by ModifiedBy 
				union
				SELECT 'Check Encoded' as Activity,EncodedBy,count(Id) as Count FROM chequerist.encodedchecks where substring(DateEncoded,1,10) =  '" . $today . "' group by EncodedBy
				
				union
				SELECT Activity,EncodedBy,count(DateUpdated) as Counter FROM chequerist.actionlogs where substring(DateUpdated,1,10) = '" . $today . "' group by EncodedBy
				union
	            SELECT 'Encoded' as Activity,EncodedBy, Count(Id) as Counter FROM citybills.transactions where substr(DateEntry,1,10) = '" . $today . "' group by EncodedBy
				) 
				a left join citydoc.employees b on CAST(a.ModifiedBy AS UNSIGNED)  = b.employeenumber group by Name order by Counter Desc";				
				
				
				
				
				
		$record = $database->query($sql);
		$sheet = '<table style = "color:white;font-size:10px;width:180px;background-image: linear-gradient(to  right,rgb(6, 13, 61),rgba(61, 125, 5,.2));border-spacing:0px;font-family:NOR;">';
		$sheet .= '<tr style = "">
						<td id ="engagementHeader" colspan = "3" style ="height:40px; text-align:center;font-family:oswald;background-color:rgb(22, 49, 62);font-size:14px;">
							<table style ="font-size:10px;border-spacing:0px;line-height:14px;color:white;" border ="0">
								<tr><td style = "font-size:14px;border-bottom:1px solid black;">Daily User Engagement</td></tr>
								<tr><td style = "vertical-align:top;line-height:8px;color:silver;">Transaction Controllers, Receiver, Releaser, Etc.</td></tr>
							</table>
						</td>
						
					</tr>';
		$i =1;
		
		while($data = $database->fetch_array($record)){
			
			$name = $data['Name'];
			$count = $data['Counter'];
			$sheet .= '<tr>
						<td style ="color:grey;width:8px;">' . $i++ . '</td>	
			 			<td style ="color:silver;">' . utf8_encode($name) . '</td>
			 			<td style ="color:silver;width:8px;">' . $count . '</td>
					   </tr>';
					   
		}
		$sheet .= '<tr style = "">
						<td colspan = "3" style ="border-top:1px solid black;border-bottom:1px solid rgb(10, 52, 27);text-align:center;background-color:rgb(14, 24, 46);color:silver;cursor:pointer;" onclick  = "viewEngagement1()" >More Details</td>
					</tr>';
		$sheet .= '<tr style = "">
						<td colspan = "3" style ="border-radius:0px 0px 5px 5px; text-align:center;font-family:oswald;background-color:rgba(52, 78, 34,.4);font-size:12px;"></td>
					</tr>';
		$sheet .= '</table>';
		echo $sheet;
	}

	if(isset($_GET['updateWGSParticulars'])) {

		$trackingNumber = $database->charEncoder($_GET['tn']);
		$particulars = $database->charEncoder($_GET['particulars']);

		$inParticulars = "NULL";
		if(strlen(trim($particulars)) > 0) {
			$inParticulars = "'".$particulars."'";
		}

		$sql = "UPDATE particulars SET Particulars = ".$inParticulars." WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		echo $trackingNumber;
		
	}

	//---------------------------------------------------------------------------------------------------WAGES CHECK DUPLICATES - START

	if(isset($_GET['checkWGSDuplicates'])) {

		$docType = $database->charEncoder($_GET['type']);
		$params = $database->charEncoder($_GET['params']);

		$message = "";

		if($docType == 'WAGES - SALARY J.O (1st half)' || 	$docType == 'WAGES - SALARY J.O (2nd half)' || 	$docType == 'WAGES - SALARY J.O (Whole month)' || 	$docType == 'WAGES - SALARY PLANTILLA') {

			$temp = explode("*j*", $params);

			$period = intval($temp[0]);
			$periodName = date('F', mktime(0, 0, 0, $period, 10));

			$claimant = $temp[1];

			$sql = "SELECT DISTINCT TrackingNumber FROM vouchercurrent WHERE Claimant = '".addslashes($claimant)."' AND DocumentType = '".$docType."' AND PeriodMonth = '".$periodName."'";
			$record = $database->query($sql);

			$message = "";
			$emps = "";

			if($database->num_rows($record) > 0) {
				while ($data = $database->fetch_array($record)) {

					$dupTN = $data['TrackingNumber'];
					$emps .= ",".$dupTN;
	
				}

				$label = "Duplicate TN";
				if($database->num_rows($record) > 0) {
					$label = "Duplicate TNs";
				}
			}

			if(strlen(trim($emps)) > 0) {

				$message = $label." : ".substr($emps, 1);
			}


		}

		echo $message;

	}
	

	//---------------------------------------------------------------------------------------------------WAGES CHECK DUPLICATES - END


	if(isset($_GET['editorComplianceOfficer'])) {

		$office = $database->charEncoder($_GET['office']);
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$oldValue = $database->charEncoder($_GET['oldValue']);
		
		$sql = "SELECT * FROM inframanpower WHERE Office = '".$office."' AND Type = 'OTHRS' ORDER BY LastName ASC";
		$record = $database->query($sql);

		$options = "<option></option>";

		while ($data = $database->fetch_array($record)) {

			$empno = $data['EmployeeNumber'];
			$fullName = $data['LastName'].', '.$data['FirstName'].' '.substr($data['MiddleName'], 0, 1).'.';

			$selected = "";
			if($empno == $oldValue) {
				$selected = "selected";
			}

			$options .= "<option value='".$empno."' ".$selected.">".utf8_encode($fullName)."</option>";
			
		}

		$label = "";
		$officer = "";
		if($office == '1081') {
			$label = 'Accounting Evaluator';
			$officer = "CAOOfficer";
		}


		$sheet = "	<div class='editorContainer'>
						<table class='editorTable' style='font-family:Oswald;'>
							<tr>
								<td class='editorHeader' colspan='2'>Editor<div onclick='closeAbsolute(this)' id='editCloser' class='closeEditor'></div></td>
							</tr>
							<tr>
								<td class='editorLabel' >".$label."</td>
								<td style='padding:40px 40px 20px 0px;'>
									<select class='select2' id='newOfficer' style='width:300px; font-family:Oswald; font-size:16px;'>".$options."</select>
								</td>
							</tr>
							<tr>
								<td colspan='2' style='padding-bottom:20px; text-align:center;'>
									<input type='hidden' id='hiddens' value='".$oldValue."'>
									<input type='hidden' id='hiddensOfficer' value='".$officer."'>
									<div id='mpower".$trackingNumber."' class='button1 b1' onclick='goUpdateThisOfficer(this)'>Save</div>
								</td>
							</tr>
						</table>
					</div>";

		echo $sheet;

	}

	if(isset($_GET['goUpdateThisOfficer'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$oldOfficer = $database->charEncoder($_GET['oldValue']);
		$newOfficer = $database->charEncoder($_GET['newValue']);
		$type = $database->charEncoder($_GET['type']);

		if($type == 'CAOOfficer') {

			$sql = "UPDATE vouchercurrent SET CAOOfficer = '".$newOfficer."' WHERE TrackingNumber = '".$trackingNumber."'";
			$database->query($sql);

			$database->EditLogs($trackingNumber,$type,$oldOfficer,$newOfficer,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);

			$completion = '';
			$status = 'Assigned Evaluator';
			$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);

		}

		echo $trackingNumber;

	}

	if (isset($_GET['updateDateTagTaxifier'])) {

		$trackingNumber = $database->charEncoder($_GET['tn']);


		$sql = 'UPDATE supplier.vouchers SET DateTag = "'.$dateEncoded.'" WHERE Year = "'.$defaultYear.'" AND TrackingNumber = "'.$trackingNumber.'"';
		$database->query($sql);

		$sql = 'INSERT INTO supplier.logs (Year, TrackingNumber, Activity, Action, UpdatedBy, DateUpdated) VALUES ("'.$defaultYear.'","'.$trackingNumber.'","Taxifier","Tagged","'.$employeeNumber.'","'.$dateEncoded.'")';
		$database->query($sql);

		echo 1;
	}

	
	//---------------------------------------------------------------------------------------------------MIXED FUND INFRAS - START

	if (isset($_GET['getMXInfras'])) {

		$sql = "SELECT TrackingNumber, BatchNumber, count(Id) as tnCnt FROM infra WHERE LENGTH(BatchNumber) > 8 GROUP BY BatchNumber";
		$record = $database->query($sql);

		$batchNumbers = '';
		while($data = $database->fetch_array($record)) {
			if($data['tnCnt'] > 1) {
				$batchNumbers .= ",'".$data['BatchNumber']."'";
			}
		}

		$sql = "SELECT TrackingNumber FROM infra WHERE BatchNumber IN (".substr($batchNumbers, 1).") ORDER BY BatchNumber ASC";
		$record = $database->query($sql);

		$infraTNs = '';
		while($data = $database->fetch_array($record)) {
			$infraTNs .= ",'".$data['TrackingNumber']."'";
		}

		$sql = "SELECT * FROM vouchercurrent WHERE TrackingNumber IN (".substr($infraTNs, 1).") AND Status = 'NTP Forwarded to Construction Division' ORDER BY Claimant ASC";
		$record = $database->query($sql);

		echo $sheet->CreateSelectInfraFinal($record);

	}

	//---------------------------------------------------------------------------------------------------MIXED FUND INFRAS - END


	//---------------------------------------------------------------------------------------------------NEW RETENTION - START

	// if(isset($_GET['getPOListForRetention'])) {

	// 	$supplier = $database->charEncoder($_GET['supplier']);
	// 	$sheet = "";

	// 	// $sql = "SELECT * FROM vouchercurrent WHERE Claimant = '".$supplier."' AND TrackingType = 'PX' AND Office = '".$office."' AND checkdate IS NOT NULL GROUP BY TrackingNumber ORDER BY DateReleased ASC";
	// 	// $sql = "SELECT a.TrackingNumber, a.PO_Number, a.checkdate, a.TrackingPartner, a.Fund, b.InvoiceNumber, b.InvoiceDate
	// 	// 		FROM vouchercurrent a
	// 	// 		LEFT JOIN particulars b ON a.TrackingPartner = b.TrackingNumber
	// 	// 		WHERE a.Claimant = '".$supplier."' AND a.TrackingType = 'PX' AND a.Office = '".$office."' AND a.checkdate IS NOT NULL
	// 	// 		GROUP BY a.TrackingNumber ORDER BY a.DateReleased ASC;";

	// 	$sql = "SELECT a.TrackingNumber, a.PO_Number, a.checkdate, a.TrackingPartner, a.Fund, b.InvoiceNumber, b.InvoiceDate
	// 	FROM vouchercurrent a
	// 	LEFT JOIN particulars b ON a.TrackingPartner = b.TrackingNumber
	// 	LEFT JOIN vouchercurrent c ON a.TrackingPartner = c.TrackingNumber
	// 	WHERE a.Claimant = '".$supplier."' AND a.TrackingType = 'PX' AND a.Office = '".$office."' AND a.checkdate IS NOT NULL AND (c.TrackingPartner IS NULL OR c.TrackingPartner = '')
	// 	GROUP BY a.TrackingNumber ORDER BY a.DateReleased ASC;";

	// 	$record = $database->query($sql);

	// 	$newRecord = [];
	// 	$forPXRet = "";
	// 	while($data = $database->fetch_array($record)) {

	// 		$checkDt = new DateTime($data['checkdate']);
	// 		$todayDt = new DateTime('now');
	// 		$diff = $todayDt->diff($checkDt);
	// 		$diffInDays = $diff->days;

	// 		if($diffInDays >= 90) {
	// 			$pxTN = $data['TrackingNumber'];
	// 			$poNumber = $data['PO_Number'];
	// 			$invNumber = $data['InvoiceNumber'];
	// 			$invDate = $data['InvoiceDate'];
	// 			$forPXRet .= ",'".$pxTN."'";
	// 			$newRecord[$pxTN] = $data['TrackingPartner'].'*j*'.$poNumber.'*j*'.$invNumber.'*j*'.$invDate;
	// 		}

	// 	}

	// 	if(strlen($forPXRet) > 0) {
	// 		$sql = "SELECT * FROM pxvouchertax WHERE TrackingNumber IN (".substr($forPXRet, 1).") GROUP BY TrackingNumber";
	// 		$record = $database->query($sql);

	// 		while($data = $database->fetch_array($record)) {
	// 			$pxTN = $data['TrackingNumber'];
	// 			$retention = $data['Retention'];
	// 			$newRecord[$pxTN] .= "*j*".$retention;
	// 		}

	// 		$curPONumber = "";
	// 		$curRetention = 0;
	// 		$totalRetention = 0;
	// 		$sheet .= "<table id='newRETTable' border='0' cellpadding='0' style='margin:0px auto; border-spacing:0px; font-family:NOR; border-collapse:collapse; border:1px solid silver;'>
	// 						<tr style='font-weight:bold; background-color:rgb(200, 212, 213);'>
	// 							<td style='padding:2px 5px; background-color:rgb(211, 221, 226);'></td>
	// 							<td style='padding:2px 5px;'>TN</td>
	// 							<td style='padding:2px 5px;'>PO NO.</td>
	// 							<td style='padding:2px 5px;'>INV#</td>
	// 							<td style='padding:2px 5px;'>INV DATE</td>
	// 							<td style='padding:2px 5px; text-align:right;'>RETENTION</td>
	// 						</tr>";
	// 		foreach ($newRecord as $pxTN => $details) {
	// 			$temp = explode('*j*', $details);

	// 			$pxTN = $temp[0];
	// 			$poNumber = $temp[1];
	// 			$invNumber = $temp[2];
	// 			$invDate = $temp[3];
	// 			$retention = floatval($temp[4]);

	// 			$curRetention += $retention;

	// 			if($poNumber != $curPONumber) {
	// 				$sheet .= "	<tr>
	// 								<td style='padding:2px 5px; text-align:center;'><input type='checkbox' onclick='newRETChangeTotal()' checked></td>
	// 								<td style='padding:2px 5px;'>".$pxTN."</td>
	// 								<td style='padding:2px 5px;'>".$poNumber."</td>
	// 								<td style='padding:0px 5px;'><input style='border:0px; font-size:16px; padding:2px 5px; font-family:NOR; border-bottom:1px solid black;' value='".$invNumber."'></td>
	// 								<td style='padding:0px 5px;'><input style='border:0px; font-size:16px; padding:2px 5px; font-family:NOR; border-bottom:1px solid black;' value='".$invDate."'></td>
	// 								<td style='padding:2px 5px; text-align:right; font-weight:bold;'>".number_format($curRetention, 2)."</td>
	// 							</tr>";

	// 				$curPONumber = $poNumber;
	// 				$totalRetention += $curRetention;
	// 				$curRetention = 0;
	// 			}

	// 		}

			
	// 		$sheet .= "	<tr>
	// 						<td colspan='6' style='padding:5px 0px;'></td>
	// 					</tr>
	// 					<tr>
	// 						<td colspan='6' style='padding:5px 5px; text-align:right; color:red; font-weight:bold; border-top:1px solid silver; font-size:18px;'>
	// 							<span style='color:gray; font-size:14px; font-weight:normal; margin-right:5px;'>Total</span><span id='newRETTotal'>".number_format($totalRetention, 2)."</span>
	// 						</td>
	// 					</tr>";

	// 		$sheet .= "</table>";

	// 	}

	// 	unset($newRecord);
	// 	echo $sheet;
	// }

	if(isset($_GET['getPOListForRetention'])) {

		$supplier = $database->charEncoder($_GET['supplier']);
		$sheet = "";

		$sql = "SELECT a.TrackingNumber as pxTN, a.PO_Number, a.checkdate, a.TrackingPartner as poTN, a.Fund, b.InvoiceNumber, b.InvoiceDate, d.Retention, c.TrackingPartner as retTN
				FROM vouchercurrent a
				LEFT JOIN particulars b ON a.TrackingPartner = b.TrackingNumber
				LEFT JOIN vouchercurrent c ON a.TrackingPartner = c.TrackingNumber
				LEFT JOIN pxvouchertax d ON a.TrackingNumber = d.TrackingNumber
				WHERE a.Claimant = '".$supplier."' AND a.TrackingType = 'PX' AND a.Office = '".$office."' AND a.checkdate IS NOT NULL
				GROUP BY a.TrackingNumber ORDER BY a.DateReleased ASC;";
		$record = $database->query($sql);

		if($database->num_rows($record) > 0) {

			$curPONumber = "";
			$curRetention = 0;
			$totalRetention = 0;
			$rows = "";
			$sheet .= "<table id='newRETTable' border='0' cellpadding='0' style='margin:0px auto; border-spacing:0px; font-family:NOR; border-collapse:collapse; border:1px solid silver; font-size:18px;'>
							<tr style='font-weight:bold; background-color:rgb(200, 212, 213);'>
								<td style='padding:2px 8px; background-color:rgb(211, 221, 226);'></td>
								<td style='padding:2px 8px;'>TN</td>
								<td style='padding:2px 8px;'>PO NO.</td>
								<td style='padding:2px 8px;'>INV#</td>
								<td style='padding:2px 8px;'>INV DATE</td>
								<td style='padding:2px 8px; text-align:right;'>RETENTION</td>
							</tr>";

			$forPXRet = "";
			while($data = $database->fetch_array($record)) {

				$checkDt = new DateTime($data['checkdate']);
				$todayDt = new DateTime('now');
				$diff = $todayDt->diff($checkDt);
				$diffInDays = $diff->days;

				$pxTN = $data['pxTN'];
				$poTN = $data['poTN'];
				$poNumber = $data['PO_Number'];
				$invNumber = $data['InvoiceNumber'];
				$invDate = $data['InvoiceDate'];
				$retention = $data['Retention'];
				$retTN = $data['retTN'];

				// $noAdd = 0;
				// if($diffInDays < 90) {
				// 	$noAdd = 1;
				// }
				if(strlen(trim($retTN)) > 0) {
					$noAdd = 1;
				}

				if(strlen(trim($curPONumber)) == 0) {
					$curRetention = 0;
				}

				$curRetention += $retention;

				if($poNumber != $curPONumber && $retention > 0 && $noAdd == 0) {
					$rows .= "	<tr>
									<td style='padding:2px 8px; text-align:center;'><input type='checkbox' onclick='newRETChangeTotal()' checked></td>
									<td style='padding:2px 8px;'>".$poTN."</td>
									<td style='padding:2px 8px;'>".$poNumber."</td>
									<td style='padding:2px 8px;'>".$invNumber."</td>
									<td style='padding:2px 8px;'>".$invDate."</td>
									<td style='padding:2px 8px; text-align:right; font-weight:bold;'>".number_format($curRetention, 2)."</td>
								</tr>";

					$curPONumber = $poNumber;
					if($noAdd == 0) {
						$totalRetention += $curRetention;
					}
					$curRetention = 0;
				}

					

			}
			$sheet .= $rows;

			$sheet .= "	<tr>
							<td colspan='6' style='padding:5px 0px;'></td>
						</tr>
						<tr>
							<td colspan='6' style='padding:5px 8px; text-align:right; color:red; font-weight:bold; border-top:1px solid silver; font-size:18px;'>
								<span style='color:gray; font-size:14px; font-weight:normal; margin-right:5px;'>Total</span><span id='newRETTotal'>".number_format($totalRetention, 2)."</span>
							</td>
						</tr>";

			$sheet .= "</table>";

			if(strlen(trim($rows)) == 0) {
				$sheet = "";
			}

		}

		echo $sheet;
	}

	if(isset($_POST['saveNewRETENTION'])) {

		$details = $database->charEncoder($_POST['details']);
		$totalRetention = $database->charEncoder($_POST['total']);
		$fund = "General Fund";
		$period = date('F');
		$claimant = urldecode($database->charEncoder($_POST['supplier']));

		$temp1 = explode('*j*', $details);
		$poTNs = "";
		for ($i=0; $i < sizeof($temp1); $i++) { 

			$temp2 = explode('~j~', $temp1[$i]);
			$poTN = $temp2[0];
			$poNumber = $temp2[1];
			$invNumber = $temp2[2];
			$invDate =  urldecode($temp2[3]);
			$retention = $temp2[4];

			$poTNs .= ",'".$poTN."'";

		}

		$office = $_SESSION['cbo'];
		$employeeNumber = $_SESSION['employeeNumber'];
		$status = "Encoded";
		$docType = "BOND - RETENTION MONEY";

		$updateCase = "Doctrack = Doctrack + 1";
		$database->IncrementTrackingSeries($updateCase,$office);
		
		//pagkuha sa new seq
		$condition = "where code = '" . $office . "' limit 1";
		$record = $database->FetchDoctrackID("Doctrack",$condition);
		$data = $database->fetch_array($record);
		$trackingNumber = $office . '-' . $data['Doctrack'];
		$newTrackingNumber = $office . '-' . ($data['Doctrack']+1); 

		$sql = "INSERT INTO vouchercurrent 
				(Year,Office,TrackingType,TrackingNumber,Fund,ClaimType,DocumentType,PeriodMonth,PeriodType,Claimant,Amount,EncodedBy,DateEncoded,Status,SubCode,NetAmount) 
				VALUES 
				('".$defaultYear."','".$office."','PY','".$trackingNumber."','".$fund."','Check','".$docType."','".$period."','Monthly','".$claimant."','".$totalRetention."','".$employeeNumber."','".$dateEncoded."','".$status."','0','".$totalRetention."');
				";
		$database->query($sql);

		$particulars = "To payment of refund of RETENTION MONEY of ".$claimant." in the amount of. . .";
		$sql = "INSERT INTO particulars (TrackingNumber, Particulars) VALUES ('".$trackingNumber."','".$particulars."')";
		$database->query($sql);

		$sql = "UPDATE vouchercurrent SET TrackingPartner = '".$trackingNumber."' WHERE TrackingNumber IN (".substr($poTNs, 1).")";
		$database->query($sql);

		$completion = '';
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);
		echo $newTrackingNumber . '~'. $trackingNumber;

	}

	// if(isset($_GET['editRetention'])){
	// 	$trackingNumber = $database->charEncoder($_GET['tn']);

	// 	$sql = "SELECT TrackingNumber FROM vouchercurrent WHERE TrackingPartner = '".$trackingNumber."' GROUP BY TrackingNumber";
	// 	$record = $database->query($sql);
	
	// 	$poTNs = "";
	// 	while ($data = $database->fetch_array($record)) {
	// 		$poTNs .= ",'".$data['TrackingNumber']."'";
	// 	}
	
	// 	$sql = "SELECT a.TrackingNumber as pxTN, a.PO_Number, a.checkdate, a.TrackingPartner as poTN, a.Fund, b.InvoiceNumber, b.InvoiceDate, c.Retention
	// 			FROM vouchercurrent a 
	// 			LEFT JOIN particulars b ON a.TrackingPartner = b.TrackingNumber 
	// 			LEFT JOIN pxvouchertax c ON a.TrackingNumber = c.TrackingNumber
	// 			WHERE TrackingPartner IN (".substr($poTNs, 1).") GROUP BY a.TrackingNumber ORDER BY a.DateReleased ASC;";
	// 	$record = $database->query($sql);

	// 	$sheet = "";
	// 	$sheet .= "	<div class='editorContainer'>
	// 				<table border='0' cellpadding='0' style='padding:20px; border-spacing:0px;'>
	// 					<tr>
	// 						<td class='editorHeader'>Editor</td>
	// 						<td class='editorHeader'><div onclick='closeAbsolute(this)' class='closeEditor'></div></td>
	// 					</tr>
	// 					<tr>
	// 						<td colspan='2'>";

	// 	$curPONumber = "";
	// 	$curRetention = 0;
	// 	$totalRetention = 0;
	// 	$sheet .= "<table id='updateRETTable' border='0' cellpadding='0' style='margin:0px auto; border-spacing:0px; font-family:NOR; border-collapse:collapse; border:1px solid silver;'>
	// 					<tr style='font-weight:bold; background-color:rgb(200, 212, 213);'>
	// 						<td style='padding:2px 5px; background-color:rgb(211, 221, 226);'></td>
	// 						<td style='padding:2px 5px;'>TN</td>
	// 						<td style='padding:2px 5px;'>PO NO.</td>
	// 						<td style='padding:2px 5px;'>INV#</td>
	// 						<td style='padding:2px 5px;'>INV DATE</td>
	// 						<td style='padding:2px 5px; text-align:right;'>RETENTION</td>
	// 					</tr>";


	// 	while ($data = $database->fetch_array($record)) {
	// 		$pxTN = $data['pxTN'];
	// 		$poNumber = $data['PO_Number'];
	// 		$checkdate = $data['checkdate'];
	// 		$poTN = $data['poTN'];
	// 		$fund = $data['Fund'];
	// 		$invNumber = $data['InvoiceNumber'];
	// 		$invDate = $data['InvoiceDate'];
	// 		$retention = $data['Retention'];
	
	// 		$curRetention += $retention;

	// 		if($poNumber != $curPONumber) {
	// 			$sheet .= "	<tr>
	// 							<td style='padding:2px 5px; text-align:center;'><input type='checkbox' onclick='newRETChangeTotalInEdit()' checked></td>
	// 							<td style='padding:2px 5px;'>".$poTN."</td>
	// 							<td style='padding:2px 5px;'>".$poNumber."</td>
	// 							<td style='padding:0px 5px;'><input style='border:0px; font-size:16px; padding:2px 5px; font-family:NOR; border-bottom:1px solid black;' value='".$invNumber."'></td>
	// 							<td style='padding:0px 5px;'><input style='border:0px; font-size:16px; padding:2px 5px; font-family:NOR; border-bottom:1px solid black;' value='".$invDate."'></td>
	// 							<td style='padding:2px 5px; text-align:right; font-weight:bold;'>".number_format($curRetention, 2)."</td>
	// 						</tr>";

	// 			$curPONumber = $poNumber;
	// 			$totalRetention += $curRetention;
	// 			$curRetention = 0;
	// 		}
	// 	}
		
	// 	$sheet .= "	<tr>
	// 					<td colspan='6' style='padding:5px 0px;'></td>
	// 				</tr>
	// 				<tr>
	// 					<td colspan='6' style='padding:5px 5px; text-align:right; color:red; font-weight:bold; border-top:1px solid silver; font-size:18px;'>
	// 						<span style='color:gray; font-size:14px; font-weight:normal; margin-right:5px;'>Total</span><span id='updateRETTotal'>".number_format($totalRetention, 2)."</span>
	// 					</td>
	// 				</tr>
	// 				";

	// 	$sheet .= "</table>";

	// 	$sheet .= "	<div style='padding-top:20px;'>
	// 					<div style='' class='button1' id='updateRET".$trackingNumber."' onclick='updateNewRETENTION(this)'>Update</div>
	// 				</div>";

	// 	$sheet .= "	</td>
	// 				</tr>
	// 				</table>
	// 				</div>";


	// 	echo $sheet;

	// }

	if(isset($_GET['editRetention'])){
		$trackingNumber = $database->charEncoder($_GET['tn']);

		$sql = "SELECT TrackingNumber, Claimant FROM vouchercurrent WHERE TrackingPartner = '".$trackingNumber."' GROUP BY TrackingNumber";
		$record = $database->query($sql);
	
		$poTNs = "";
		$supplier = "";
		while ($data = $database->fetch_array($record)) {
			$poTNs .= ",'".$data['TrackingNumber']."'";
			$supplier = $data['Claimant'];
		}
	
		$sql = "SELECT a.TrackingNumber as pxTN, a.PO_Number, a.checkdate, a.TrackingPartner as poTN, a.Fund, b.InvoiceNumber, b.InvoiceDate, c.Retention, d.TrackingPartner as retTN
				FROM vouchercurrent a
				LEFT JOIN particulars b ON a.TrackingPartner = b.TrackingNumber
				LEFT JOIN pxvouchertax c ON a.TrackingNumber = c.TrackingNumber
				LEFT JOIN vouchercurrent d ON a.TrackingPartner = d.TrackingNumber
				WHERE a.Claimant = '".$supplier."' AND a.TrackingType = 'PX' AND a.Office = '".$office."' AND a.checkdate IS NOT NULL 
				GROUP BY a.TrackingNumber ORDER BY a.DateReleased ASC;";
		$record = $database->query($sql);

		$sheet = "";
		$sheet .= "	<div class='editorContainer'>
					<table border='0' cellpadding='0' style='padding:20px; border-spacing:0px;'>
						<tr>
							<td class='editorHeader'>Editor</td>
							<td class='editorHeader'><div onclick='closeAbsolute(this)' class='closeEditor'></div></td>
						</tr>
						<tr>
							<td colspan='2'>";

		$curPONumber = "";
		$curRetention = 0;
		$totalRetention = 0;
		$sheet .= "<table id='updateRETTable' border='0' cellpadding='0' style='margin:0px auto; border-spacing:0px; font-family:NOR; border-collapse:collapse; border:1px solid silver;'>
						<tr style='font-weight:bold; background-color:rgb(200, 212, 213);'>
							<td style='padding:2px 5px; background-color:rgb(211, 221, 226);'></td>
							<td style='padding:2px 5px;'>TN</td>
							<td style='padding:2px 5px;'>PO NO.</td>
							<td style='padding:2px 5px;'>INV#</td>
							<td style='padding:2px 5px;'>INV DATE</td>
							<td style='padding:2px 5px; text-align:right;'>RETENTION</td>
						</tr>";

		while ($data = $database->fetch_array($record)) {
			$pxTN = $data['pxTN'];
			$poNumber = $data['PO_Number'];
			$checkdate = $data['checkdate'];
			$poTN = $data['poTN'];
			$fund = $data['Fund'];
			$invNumber = $data['InvoiceNumber'];
			$invDate = $data['InvoiceDate'];
			$retention = $data['Retention'];
			$retTN = $data['retTN'];

			if($retTN == $trackingNumber || $retTN == "") {
				$checkDt = new DateTime($checkdate);
				$todayDt = new DateTime('now');
				$diff = $todayDt->diff($checkDt);
				$diffInDays = $diff->days;

				$disabled = "";
				$checked = "checked";
				$bgClr = "";
				$noAdd = 0;
				if($diffInDays < 90) {
					$noAdd = 1;
				}

				if(strlen(trim($curPONumber)) == 0) {
					$curRetention = 0;
				}

				if($poNumber != $curPONumber) {
					$curRetention = 0;
				}
	
				$curRetention += $retention;
				
				if($poNumber != $curPONumber && $retention > 0 && $noAdd == 0) {

					$chkd = "";
					if(strpos($poTNs, "'".$poTN."'") > 0) {
						$chkd = "checked";
					}

					$sheet .= "	<tr>
									<td style='padding:2px 5px; text-align:center;'><input type='checkbox' onclick='newRETChangeTotalInEdit()' ".$chkd."></td>
									<td style='padding:2px 5px;'>".$poTN."</td>
									<td style='padding:2px 5px;'>".$poNumber."</td>
									<td style='padding:0px 5px;'>".$invNumber."</td>
									<td style='padding:0px 5px;'>".$invDate."</td>
									<td style='padding:2px 5px; text-align:right; font-weight:bold;'>".number_format($curRetention, 2)."</td>
								</tr>";

					$curPONumber = $poNumber;
					if($chkd == "checked") {
						$totalRetention += $curRetention;
					}
					$curRetention = 0;

				}


			}
		}
		
		$sheet .= "	<tr>
						<td colspan='6' style='padding:5px 0px;'></td>
					</tr>
					<tr>
						<td colspan='6' style='padding:5px 5px; text-align:right; color:red; font-weight:bold; border-top:1px solid silver; font-size:18px;'>
							<span style='color:gray; font-size:14px; font-weight:normal; margin-right:5px;'>Total</span><span id='updateRETTotal'>".number_format($totalRetention, 2)."</span>
						</td>
					</tr>
					";

		$sheet .= "</table>";

		$sheet .= "	<div style='padding-top:20px;'>
						<div style='' class='button1' id='updateRET".$trackingNumber."' onclick='updateNewRETENTION(this)'>Update</div>
					</div>";

		$sheet .= "	</td>
					</tr>
					</table>
					</div>";


		echo $sheet;

	}

	if (isset($_POST['updateNewRETENTION'])) {
		$details = $database->charEncoder($_POST['details']);
		$totalRetention = $database->charEncoder($_POST['total']);
		$trackingNumber = $database->charEncoder($_POST['trackingNumber']);

		$temp1 = explode('*j*', $details);
		$poTNs = "";
		for ($i=0; $i < sizeof($temp1); $i++) { 

			$temp2 = explode('~j~', $temp1[$i]);
			$poTN = $temp2[0];
			$poNumber = $temp2[1];
			$invNumber = $temp2[2];
			$invDate =  urldecode($temp2[3]);
			$retention = floatval($temp2[4]);

			$poTNs .= ",'".$poTN."'";

		}

		$sql = "UPDATE vouchercurrent SET Amount = '".$totalRetention."', NetAmount = '".$totalRetention."' WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE vouchercurrent SET TrackingPartner = NULL WHERE TrackingPartner = '".$trackingNumber."'";
		$database->query($sql);

		$sql = "UPDATE vouchercurrent SET TrackingPartner = '".$trackingNumber."' WHERE TrackingNumber IN (".substr($poTNs, 1).")";
		$database->query($sql);

		$database->EditLogs($trackingNumber, 'Amount', "Undetermined", $totalRetention, $_SESSION['officeCode'], $_SESSION['fullName'], $today);

		echo $trackingNumber;

	}

	//---------------------------------------------------------------------------------------------------NEW RETENTION - END


	if(isset($_GET['updateItemSequence'])) {
		$trackingNumber = $_GET['tn'];
		$newSeq = $_GET['newSeq'];

		$seq = explode('~', $newSeq);
		
		$case = "";
		$ids  = '';
		for ($i=0; $i < sizeof($seq); $i++) { 
			
			$case .= "WHEN Id = '".$seq[$i]."' THEN ".($i+1)." ";
			$ids  .= ','.$seq[$i];

		}

		if(substr($trackingNumber, 0, 3) == 'PR-') {
			$sql = "UPDATE prrecord SET Sequence = CASE ".$case." END WHERE Id IN (".substr($ids, 1).")";
		}else {
			$sql = "UPDATE porecord SET Sequence = CASE ".$case." END WHERE Id IN (".substr($ids, 1).")";
		}
		$database->query($sql);

		echo $trackingNumber;

	}

	if(isset($_GET['updateFundCorrection'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		$completion = '';	
			
		$status = 'Fund Correction';   
		$updateCase = " Status = '" . $status . "', ModifiedBy = '" . $employeeNumber . "', DateModified = '" . $dateEncoded . "' ";
		
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);              
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion);

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}

	if(isset($_GET['updateFundCorrected'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		// $sql = "SELECT * FROM voucherhistory where TrackingNumber = '".$trackingNumber."' order by Id DESC LIMIT 1, 1;";
		$sql = "SELECT * FROM voucherhistory where TrackingNumber = '".$trackingNumber."' AND Status != 'Assigned Evaluator' order by Id DESC LIMIT 1, 1;";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$prevStatus = $data['Status'];
			
		
		$completion = '';	
		$updateCase = " Status = '" . $prevStatus . "', ModifiedBy = '" . $employeeNumber . "', DateModified = '" . $dateEncoded . "' ";
		
		$database->UpdateTrackingStatus($updateCase,$trackingNumber);
		$database->UpdateVoucherHistory($trackingNumber);              
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$prevStatus,$completion);

		$record = $database->searchTrackingNumber2022($trackingNumber);
		if(sizeof($record) > 0) {

			if($record['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($record);
			}else{
				echo $sheet->CreateDoctrackInfoPR($record);
			}

		}else{
			echo "<span class = 'remark1'>No record found.</span>";
		}
	}

	if (isset($_GET['editDRRMO'])) {
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

		// $sql = "SELECT DRRMO FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$sql = "SELECT ProjectId FROM vouchercurrent WHERE TrackingNumber = '".$trackingNumber."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$curDRRMO = $data['ProjectId'];

		// $sql = "SELECT * FROM drrmoprojects ORDER BY Name ASC";
		$sql = "SELECT * FROM disasterprojects ORDER BY Name ASC";
		$record = $database->query($sql);

		$options = "";
		while($data = $database->fetch_array($record)) {
			$project = $data['Id'];
			$name = $data['Name'];
			$options .= "<option value='".$project."'>".$name."</option>";
		}

		echo $options.'*j*'.$curDRRMO.'*j*'.$trackingNumber;
	}

	if(isset($_GET['goUpdateDRRMO'])) {
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$oldValue = $database->charEncoder($_GET['oldValue']);
		$newValue = $database->charEncoder($_GET['newValue']);

		// $sql = "UPDATE vouchercurrent SET DRRMO = '".$newValue."' WHERE TrackingNumber = '".$trackingNumber."'";
		$sql = "UPDATE vouchercurrent SET ProjectId = '".$newValue."' WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);

		
		$database->EditLogs($trackingNumber,"ProjectId",$oldValue,$newValue,$_SESSION['officeCode'], $_SESSION['fullName'],$dateEncoded);

		echo $trackingNumber;
	}

	if(isset($_GET['loadContractorsInEdit'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$oldValue = $database->charEncoder(utf8_decode($_GET['oldValue']));

		$sql = "SELECT * FROM supplier.supplierinfo WHERE LENGTH(Type) > 0 ORDER BY name ASC";
		$record = $database->query($sql);

		$sheet = "";
		$options = "";

		while($data = $database->fetch_array($record)){
			$name = utf8_encode($data['Name']);
			$alias = utf8_encode($data['Alias']);

			$dispName = $name;
			if(strlen(trim($alias)) > 0) {
				$dispName = $alias;
			}

			// $options .= "	<li style='color:rgb(0, 164, 201);font-weight:bold; font-size:12px;'>
			// 					<option class = 'hoverSupplier'  style = 'color:black;padding-left:5px; font-family:NOR;'  onclick = 'clickNFContractorInEdit(this)'>" . $dispName . "</option>
			// 				</li>";

			
			$options .= '	<li style="color:rgb(0, 164, 201);font-weight:bold; font-size:12px;">
								<option class = "hoverSupplier"  style = "color:black;padding-left:5px; font-family:NOR;"  onclick = "clickNFContractorInEdit(this)">'.$dispName.'</option>
							</li>';
		}

		$sheet .= '	<table border="0" cellpadding="0" style="border-spacing:0px; font-family:NOR; font-size:26px; border-collapse:collapse;">
						<tr style="background-color:rgb(227, 239, 242); border-bottom:1px solid grey;">
							<td style="width:0px; white-space:nowrap; padding-left:10px;">Select Contractor</td>
							<td style="font-size:0px; text-align:right; padding:8px 8px;">
								<span style="font-size:14px;">Search Key</span>
								<input style="margin-left:10px; font-size:18px; width:150px; font-family:NOR; text-align:center; padding:2px 8px;" onkeyup="shortSrchContractor(this)">
							</td>
						</tr>
						<tr>
							<td colspan="2" style="padding:0px;">
								<input type="hidden" id="nfConTN" value="'.$trackingNumber.'">
								<input type="hidden" id="nfConOld" value="'.$oldValue.'">
								<div style="height:500px; overflow-x:hidden; overflow-y:auto; font-family:Oswald; width:500px;">
									<ol style="padding:0px; padding-left:35px; margin:0px;" id="nfConSelList">'.$options.'</ol>
								</div>
							</td>
						</tr>
					</table>';

		echo $sheet;
	}


	if(isset($_GET['editNFContractor'])) {

		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$newContractor = $database->charEncoder(utf8_decode($_GET['contractor']));
		$oldContractor = $database->charEncoder(utf8_decode($_GET['oldValue']));

		$sql = "UPDATE vouchercurrent SET Claimant = '".$newContractor."' WHERE TrackingNumber = '".$trackingNumber."'";
		$database->query($sql);
		$database->EditLogs($trackingNumber,"Contractor",$oldContractor,$newContractor,$_SESSION['officeCode'],$_SESSION['fullName'],$dateEncoded);

		echo $trackingNumber;

	}

	//---------------------------------------------------------------------------------------------------NEW DRRMO MODULE - START

	if(isset($_GET['loadDRRMOOffices'])) {
		
		$sql = "SELECT * FROM office WHERE Disaster = '1' ORDER BY Name";
		$record = $database->query($sql);

		$sheet = "";

		$sheet .= "<option></option>";
		while ($data = $database->fetch_array($record)) {
			$office = $data['Code'];
			$name = $data['Name'];

			$sheet .= "<option value='".$office."'>".$name."</option>";
		}

		echo $sheet;

	}

	if(isset($_GET['loadDRRMOExpenseCodes'])) {

		// $sql = "SELECT * FROM fundtitles WHERE LENGTH(Fund) > 0 ORDER BY Code, Title";
		$sql = "SELECT * FROM fundtitles WHERE Fund = 'CO' OR Fund = 'MOOE' ORDER BY Code, Title";
		$record = $database->query($sql);

		$sheet = "";
		$list = "<table border='0' cellpadding='0' id='drrmoExpList' style='border-collapse:collapse;'>";

		while ($data = $database->fetch_array($record)) {
			$fund = $data['Fund'];
			$code = $data['Code'];
			$title = $data['Title'];

			// $list .= "<span class='drrmoExpOption' onclick='drrmoSelectThisExpCode(this)' id='".$fund."*j*".$code."'><span style='display:inline-block; width:70px;'>".$code."</span>&nbsp;<span>".$title."</span></span>";
			$list .= "	<tr id='".$fund."*j*".$code."'>
							<td><input type='checkbox' style='cursor:pointer;' onclick='drrmoHighlightThisCode(this)'></td>
							<td style='white-space:nowrap;'><span style='display:inline-block; width:70px;'>".$code."</span>&nbsp;<span>".$title."</span></td>
						</tr>";
		
		}

		$list .= "</table>";


		echo $list;

	}

	if(isset($_POST['saveDRRMOProject'])) {
		$projectName = $database->charEncoder($_POST['projectName']);
		$agency = $database->charEncoder($_POST['agency']);
		$fundType = $database->charEncoder($_POST['fundType']);
		$totalCost = floatval($database->charEncoder($_POST['totalCost']));
		$accountCodes = $database->charEncoder($_POST['accountCodes']);
		$acctBrkdown = explode('*j*', $accountCodes);

		$sql = "SELECT * FROM disasterprojects WHERE Name = '".$projectName."' LIMIT 1";
		$record = $database->query($sql);
		$numRows = $database->num_rows($record);

		if($numRows == 0) {
			$sql = "INSERT INTO disasterprojects (Office, Name, ProjectCost, DateEncoded, EncodedBy) 
					VALUES
					('".$agency."','".$projectName."','".$totalCost."','".$dateEncoded."','".$employeeNumber."')";
			$record = $database->query($sql);
			$projectId = $record['lastInsertId'];

			$sql = "INSERT INTO disasterbreakdown 
					(Agency, FundType, ProjectId, ProjectTitle, ExpenseType, AccountCode, AllocatedAmount)
					VALUES ";
			$insert = "";
			for ($i=0; $i < sizeof($acctBrkdown); $i++) { 
				$temp = explode('~', $acctBrkdown[$i]);
				$acctFund = $temp[0];
				$acctCode = $temp[1];
				$acctAmnt = floatval($temp[2]);

				$insert .= ",('".$agency."','".$fundType."','".$projectId."','".$projectName."','".$acctFund."','".$acctCode."','".$acctAmnt."')";

			}
			$sql = $sql.substr($insert, 1);
			$record = $database->query($sql);
					
			echo 1;
		}else {
			echo 2;
		}


	}

	if(isset($_GET['loadDRRMOEncodedProjects'])) {

		$sql = "SELECT a.*, b.Title as fundTitle, c.Name as AgencyName, d.ProjectCost
				FROM disasterbreakdown a 
				LEFT JOIN fundtitles b ON a.AccountCode = b.Code
				LEFT JOIN office c ON a.Agency = c.Code
				LEFT JOIN disasterprojects d ON a.ProjectId = d.Id
				ORDER BY a.ProjectId DESC, FIELD(a.ExpenseType, 'CO', 'MOOE'), fundTitle;";
		$record = $database->query($sql);

		$sheet = "";
		$curProjectId = 0;
		$curTotal = 0;
		$curType = "";
		$projectCnt = 0;
		$rowCnt = 0;
		$curProjectCost = 0;
		$projectNumRows = $database->num_rows($record);
		while ($data = $database->fetch_array($record)) {
			$id = $data['Id'];
			$agency = $data['Agency'];
			$agencyName = $data['AgencyName'];
			$fundType = $data['FundType'];
			$projectId = $data['ProjectId'];
			$projectName = $data['ProjectTitle'];
			$type = $data['ExpenseType'];
			$accountCode = $data['AccountCode'];
			$accountTitle = $data['fundTitle'];
			$amount = $data['AllocatedAmount'];
			$projectCost = $data['ProjectCost'];

			if($projectId != $curProjectId) {

				if($curType != "") {
					$sheet .= "	<tr>
									<td colspan='2' style='white-space:nowrap; font-weight:bold; text-align:right; padding:2px 5px; color:red;'>".number_format($curTotal, 2)."</td>
									<td></td>
								</tr>";
				}

				if(strlen($sheet) > 0) {
					$sheet .= "</table>";
					
				}

				if($fundType == '70') {
					$fundType = '70% GF';
				}elseif($fundType == '30') {
					$fundType = '30% Quick';
				}elseif($fundType == 'TF') {
					$fundType = 'Special Trust Fund';
				}elseif($fundType == 'CO') {
					$fundType = 'Continuing Appropriations';
				}
				
				$sheet .= "<table border='0' cellpadding='0' style='width:100%; font-size:12px; border:1px solid rgba(192,192,192,.5); margin:10px 0px 5px 0px;'>";
				$sheet .= "	<tr>
								<td colspan='4' style='background-color:rgba(108,128,143,1); color:white; font-size:14px; padding:2px 5px; position:relative;'>
									".$projectName."
									<div id='prj".$projectId."' style='font-size:20px; line-height:14px; position:absolute; top:4; right:3; cursor:pointer;' onclick='drrmoEditThisProject(this)'>&#9776;</div>
								</td>
							</tr>";
				$sheet .= "	<tr>
								<td rowspan='99' style='vertical-align:top; padding-top:5px;'>
									<table border='0' cellpadding='0' style='border-collapse:collapse; font-size:14px;'>
										<tr>
											<td style='padding:2px 5px; font-size:12px; text-align:right; white-space:nowrap;'>Implementing Agency :</td>
											<td style='padding:2px 5px; font-weight:bold;'>(".$agency.")&nbsp;".$agencyName."</td>
										</tr>
										<tr>
											<td style='padding:2px 5px; font-size:12px; text-align:right; white-space:nowrap;'>Fund Type :</td>
											<td style='padding:2px 5px; font-weight:bold;'>".$fundType."</td>
										</tr>
										<tr>
											<td style='padding:2px 5px; font-size:12px; text-align:right; white-space:nowrap;'>Project Cost :</td>
											<td style='padding:2px 5px; font-weight:bold; color:red;'>".number_format($projectCost, 2)."</td>
										</tr>
									</table>
								</td>
								<td colspan='3' style='width:50%; text-align:right;'>
									<span style='font-weight:bold; color:rgb(35, 116, 157); cursor:pointer;' id='drrmoAddTo".$projectId."' onclick='drrmoAddCodeToProject(this)'>+Add</span>
								</td>
							</tr>";
				$curProjectId = $projectId;
				$curType = "";
			}

			if($curType != $type) {
				$dispType = "CAPITAL OUTLAY";
				if($type == 'MOOE') {
					$dispType = "MOOE";
				}

				if($curType != "") {
					$sheet .= "	<tr>
									<td colspan='2' style='white-space:nowrap; font-weight:bold; text-align:right; padding:2px 5px; color:red;'>".number_format($curTotal, 2)."</td>
									<td></td>
								</tr>";
				}
				$sheet .= "	<tr>
								<td colspan='2' style='white-space:nowrap; font-weight:bold; padding-top:5px; border-bottom:1px dashed gray; padding:2px 5px;'>".$dispType."</td>
								<td></td>
							</tr>";

				$curType = $type;
				$curTotal = 0;
			}

			$sheet .= "	<tr>
							<td style='border-bottom:1px solid rgb(192, 192, 192, .2); white-space:nowrap; padding:2px 5px;'>
								<div style='font-weight:bold;'>".$accountCode."</div>
								<div>".$accountTitle."</div>
							</td>
							<td style='border-bottom:1px solid rgb(192, 192, 192, .2); width:0px; white-space:nowrap; width:100px; text-align:right; padding:2px 5px;'>".number_format($amount, 2)."</td>
							<td style='width:0px; white-space:nowrap; padding:3px 2px 3px 5px; font-size:0px; text-align:center; line-height:14px;'>
								<span class='drrmoRemoveBtn' onclick='drrmoRemoveThisCode(".$projectId.", this)'>&times;</span>
							</td>
						</tr>";

			++$rowCnt;

			$curTotal += $amount;
			$curProjectCost += $amount;
			
			if($rowCnt == $projectNumRows) {
				$sheet .= "		<tr>
									<td colspan='2' style='white-space:nowrap; font-weight:bold; text-align:right; padding:2px 5px; color:red;'>".number_format($curTotal, 2)."</td>
									<td></td>
								</tr>
							</table>";
			}

		}

		echo $sheet;

	}

	if(isset($_GET['drrmoEditThisProject'])) {

		$projectId = $database->charEncoder($_GET['project']);
		$sheet = "";

		$sql = "SELECT * FROM disasterprojects WHERE Id = '".$projectId."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$projectName = $data['Name'];
		$projectOffice = $data['Office'];
		$projectCost = $data['ProjectCost'];

		unset($data);

		$sql = "SELECT * FROM office WHERE Disaster = '1' ORDER BY Name";
		$record = $database->query($sql);

		$officeList = "";
		$officeList .= "<option></option>";
		while ($data = $database->fetch_array($record)) {
			$office = $data['Code'];
			$name = $data['Name'];

			$selected = "";
			if($office == $projectOffice) {
				$selected = "selected";
			}

			$officeList .= "<option value='".$office."' ".$selected.">".$name."</option>";
		}

		unset($data);

		$sql = "SELECT * FROM disasterbreakdown WHERE ProjectId = '".$projectId."' ORDER BY Id";
		$record = $database->query($sql);

		$projectFundType = "";
		while ($data = $database->fetch_array($record)) {
			$agency = $data['Agency'];
			$projectFundType = $data['FundType'];
			$prjId = $data['ProjectId'];
			$prjName = $data['ProjectTitle'];
			$expenseType = $data['ExpenseType'];
			$accountCode = $data['AccountCode'];
			$amount = $data['AllocatedAmount'];
		}

		$selected70 = '';
		$selected30 = '';
		$selectedTF = '';
		$selectedCO = '';

		if($projectFundType == '70') {
			$selected70 = 'selected';
		}elseif($projectFundType == '30'){
			$selected30 = 'selected';
		}elseif($projectFundType == 'TF'){
			$selectedTF = 'selected';
		}elseif($projectFundType == 'CO'){
			$selectedCO = 'selected';
		}

		$sheet .= '	<div id="expListModalContainer" class="editorContainer">
						<table border="0" cellpadding="0" class="editorTable" style="font-family:NOR; background-color:white;">
							<tr>
								<td colspan="2" class="editorHeader" style="background-color:rgb(227, 239, 242); color:black; text-shadow:none; font-weight:bold;">
									EDIT PROJECT<div onclick="closeAbsolute(this)" class="closeEditor"></div>
								</td>
							</tr>
							<tr>
								<td colspan="2" style="padding-bottom:5px;"></td>
							</tr>
							<tr>
								<td style="padding:0px; width:0px; white-space:nowrap; text-align:right; padding-left:8px; padding-top:2px; vertical-align:top;">Project<span class="drrmEncNum">1</span></td>
								<td style="padding:0px; padding-bottom:5px;">
									<textarea id="drrmoEditProjectName" class="inputDrrmo" style="padding:2px 5px; width:400px; max-width:400px; min-width:400px;">'.$projectName.'</textarea>
								</td>
							</tr>
							<tr>
								<td style="padding:0px; width:0px; white-space:nowrap; text-align:right; padding-left:8px;">Office<span class="drrmEncNum">2</span></td>
								<td style="padding:0px; padding-bottom:5px;">
									<select id="drrmoEditOffice" class="inputDrrmo" style=" width:400px;">'.$officeList.'</select>
								</td>
							</tr>
							<tr>
								<td style="padding:0px; width:0px; white-space:nowrap; text-align:right; padding-left:8px;">Fund Type<span class="drrmEncNum">3</span></td>
								<td colspan="2" style="padding:0px; padding-bottom:5px;">
									<select id="drrmoEditFundType" class="inputDrrmo" style="width:400px;">
										<option></option>
										<option value="70" '.$selected70.'>70% GF</option>
										<option value="30" '.$selected30.'>30% Quick</option>
										<option value="TF" '.$selectedTF.'>Special Trust Fund</option>
										<option value="CO" '.$selectedCO.'>Continuing Appropriations</option>
									</select>
								</td>
							</tr>
							<tr>
								<td colspan="2" style="padding:20px 0px; text-align:center; background-color:rgb(245, 248, 248);">
									<input type="hidden" id="drrmoUpGenProjId" value="'.$projectId.'">
									<div class="button1 b1" onclick="drrmoUpdateGenDetails()">Update</div>
								</td>
							</tr>
						</table>
					</div>';

		echo $sheet;

	}

	if(isset($_GET['drrmoUpdateGenDetails'])) {

		$projectId = $database->charEncoder($_GET['pId']);
		$projectName = $database->charEncoder($_GET['pName']);
		$projectOffice = $database->charEncoder($_GET['pOffice']);
		$projectFund = $database->charEncoder($_GET['pFund']);

		$sql = "UPDATE disasterprojects SET Office = '".$projectOffice."', Name = '".$projectName."' WHERE Id = '".$projectId."'";
		$record = $database->query($sql);

		$sql = "UPDATE disasterbreakdown SET Agency = '".$projectOffice."', FundType = '".$projectFund."', ProjectTitle = '".$projectName."' WHERE ProjectId = '".$projectId."'";
		$record = $database->query($sql);

		echo 1;
	}

	if(isset($_GET['drrmoAddCodeToProject'])) {

		$projectId = $database->charEncoder($_GET['project']);
		$sheet = "";

		$sql = "SELECT * FROM disasterprojects WHERE Id = '".$projectId."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$projectName = $data['Name'];
		$projectOffice = $data['Office'];
		$projectCost = $data['ProjectCost'];

		unset($data);

		$sql = "SELECT FundType FROM disasterbreakdown WHERE ProjectId = '".$projectId."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$projectFund = $data['FundType'];

		unset($data);

		$sql = "SELECT * FROM fundtitles WHERE Fund = 'CO' OR Fund = 'MOOE' ORDER BY Code, Title";
		$record = $database->query($sql);

		$options = "<option></option>";

		while ($data = $database->fetch_array($record)) {
			$fund = $data['Fund'];
			$code = $data['Code'];
			$title = $data['Title'];

			$options .= '<option value="'.$fund.'*j*'.$code.'">'.$code.'&nbsp;&nbsp;'.$title.'</option>';
		
		}

		unset($data);

		$sheet .= '	<div id="expListModalContainer" class="editorContainer">
						<table border="0" cellpadding="0" class="editorTable" style="font-family:NOR; background-color:white;">
							<tr>
								<td colspan="3" class="editorHeader" style="background-color:rgb(227, 239, 242); color:black; text-shadow:none; font-weight:bold;">
									ADD EXPENSE ACCOUNT<div onclick="closeAbsolute(this)" class="closeEditor"></div>
								</td>
							</tr>
							<tr>
								<td colspan="3" style="padding-bottom:5px;"></td>
							</tr>
							<tr>
								<td style="text-align:right; white-space:nowrap;">Expense Account</td>
								<td class="drrmEncNum">1</td>
								<td>
									<select id="drrmoAddFundCode" class="inputDrrmo">'.$options.'</select>
								</td>
							</tr>
							<tr>
								<td style="text-align:right; white-space:nowrap;">Amount</td>
								<td class="drrmEncNum">2</td>
								<td>
									<input id="drrmoAddCost" class="inputDrrmo" style="padding:2px 5px;" onclick="this.select()" onkeydown="return isAmount(this,event)" onkeyup="return withCommasDrrmo(this)">
								</td>
							</tr>
							<tr>
								<td colspan="3" style="padding-bottom:5px;"></td>
							</tr>
							<tr>
								<td colspan="3" style="padding:20px 0px; text-align:center; background-color:rgb(245, 248, 248);">
									<input type="hidden" id="drrmoUpExpPId" value="'.$projectId.'">
									<input type="hidden" id="drrmoUpExpPName" value="'.$projectName.'">
									<input type="hidden" id="drrmoUpExpPOffice" value="'.$projectOffice.'">
									<input type="hidden" id="drrmoUpExpPCost" value="'.$projectCost.'">
									<input type="hidden" id="drrmoUpExpPFund" value="'.$projectFund.'">
									<div class="button1 b1" onclick="drrmoAddNewExpCode()">Update</div>
								</td>
							</tr>
						</table>
					</div>';

		echo $sheet;

	}

	if(isset($_GET['drrmoAddNewExpCode'])) {
		$projectId = $database->charEncoder($_GET['pId']);
		$projectName = $database->charEncoder($_GET['pName']);
		$projectOffice = $database->charEncoder($_GET['pOffice']);
		$projectFund = $database->charEncoder($_GET['pFund']);
		$projectCostCurrent = $database->charEncoder($_GET['pCost']);

		$addedType = $database->charEncoder($_GET['aType']);
		$addedCode = $database->charEncoder($_GET['aCode']);
		$addedCost = $database->charEncoder($_GET['aCost']);

		$projectCostNew = round( floatval($projectCostCurrent) + floatval($addedCost), 2);

		$sql = "SELECT * FROM disasterbreakdown WHERE ProjectId = '".$projectId."' AND AccountCode = '".$addedCode."' LIMIT 1";
		$record = $database->query($sql);

		if($database->num_rows($record) == 0) {
			$sql = "INSERT INTO disasterbreakdown (Agency, FundType, ProjectId, ProjectTitle, ExpenseType, AccountCode, AllocatedAmount)
					VALUES
					('".$projectOffice."','".$projectFund."','".$projectId."','".$projectName."','".$addedType."','".$addedCode."','".$addedCost."')";
			$record = $database->query($sql);

			$sql = "UPDATE disasterprojects SET ProjectCost = '".$projectCostNew."' WHERE Id = '".$projectId."'";
			$record = $database->query($sql);

			echo 1;
		}else {
			echo 2;
		}


	}

	if(isset($_GET['drrmoRemoveThisCode'])) {
		
		$projectId = $database->charEncoder($_GET['project']);
		$expenseCode = $database->charEncoder($_GET['expCode']);
		$amount = floatval($database->charEncoder($_GET['amount']));

		$sql = "SELECT * FROM disasterprojects WHERE Id = '".$projectId."' LIMIT 1";
		$record = $database->query($sql);
		$data = $database->fetch_array($record);
		$projectCost = floatval($data['ProjectCost']);
		
		$newProjectCost =  round($projectCost - $amount, 2);

		$sql = "UPDATE disasterprojects SET ProjectCost = '".$newProjectCost."' WHERE Id = '".$projectId."'";
		$record = $database->query($sql);

		$sql = "DELETE FROM disasterbreakdown WHERE ProjectId = '".$projectId."' AND AccountCode = '".$expenseCode."'";
		$record = $database->query($sql);

		echo 1;
	}

	//---------------------------------------------------------------------------------------------------NEW DRRMO MODULE - END


	// if (isset($_GET['cancelFundReverted'])) {

	// 	$trackingNumber = $database->charEncoder($_GET['trackingNumber']);

	// 	$completion = '';
	// 	$status = 'Cancelled - Fund Reverted';
	// 	$updateCase = " Status = '" . $status . "',ModifiedBy = '" . $employeeNumber . "',DateModified = '" . $dateEncoded . "' ";
	// 	$database->UpdateTrackingStatus($updateCase,$trackingNumber);
	// 	$database->UpdateVoucherHistory($trackingNumber);               //update para sa completion
	// 	$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,$completion); //insert sa new status	

	// 	echo $trackingNumber;

	// }

	if(isset($_GET['saveAllTNsRemark'])){
		$tn = $database->charEncoder($_GET['tn']);
		$office = addslashes($_SESSION['officeName']);
		$trackType = $database->charEncoder($_GET['type']);
		
		$note = strip_tags($database->charEncoder($_GET['value']));
		
		$value = '<div class = "remarkMessage">' . $note . '</div>';
		$value .= '<div class ="remarkOffice">' .  $office .  '</div>';
		$value .= '<div class ="remarkCreated">' . $dateEncoded .  '</div>';
		
		$sql = "UPDATE vouchercurrent SET Remarks1 = concat('"  . $value . "', ifnull(Remarks1,'')) WHERE TrackingNumber = '" . $tn . "'";
		$database->query($sql);

		$database->EditLogs($tn,"Remarks","Add Remark","Add Remark",$_SESSION['officeCode'],$_SESSION['fullName'],$today);	

		$newRecord = $database->searchTrackingNumber2022($tn);
		if(sizeof($newRecord) > 0) {

			if($newRecord['TrackingType'] == "PO"){
				echo $sheet->NewCreateDoctrackInfoPO($newRecord);
			}elseif($newRecord['TrackingType'] == "PX") {
				echo $sheet->NewCreateDoctrackInfoPX($newRecord);
			}else{
				echo $sheet->CreateDoctrackInfoPR($newRecord);
			}

		}else {
			echo "<div class = 'norecord' > No record found.</div>" . "*v*";
		}

	}

	if(isset($_GET['saveAPFundRevertedTN'])){
		$trackingNumber = $database->charEncoder($_GET['trackingNumber']);
		$remarks =  $database->charEncoder($_GET['remarks']);
		
		$office = $_SESSION['cbo'];
		$accountType = $_SESSION['accountType'];
		$employeeNumber = $_SESSION['employeeNumber'];
		$fullName = $_SESSION['fullName'];

		$status = 'Cancelled - Fund Reverted';
	
		$sql = "UPDATE vouchercurrent SET Status = '".$status."', Remarks = CONCAT('Cancel Note : " . $remarks . "<br/>',if (Remarks is null,'',Remarks)), DateModified = '" . $dateEncoded . "'  where trackingnumber = '" .  $trackingNumber . "'";
		$database->query($sql);
		$database->EditLogs($trackingNumber,'Status','',$status,$office,$fullName ,$dateEncoded);	
		
		$database->InsertToVoucherHistory($trackingNumber,$employeeNumber,$dateEncoded,$status,''); 
		
		echo $trackingNumber;			
	}

?>

































